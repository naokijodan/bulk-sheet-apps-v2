<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      margin: 0;
    }
    
    .header {
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #4285f4;
    }
    
    .header h2 {
      margin: 0 0 10px 0;
      color: #202124;
      font-size: 20px;
    }
    
    .header p {
      margin: 0;
      color: #5f6368;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    label {
      display: block;
      font-weight: bold;
      margin-bottom: 8px;
      color: #202124;
      font-size: 14px;
    }
    
    select, input {
      width: 100%;
      padding: 10px;
      font-size: 14px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      box-sizing: border-box;
    }
    
    select {
      background-color: white;
      cursor: pointer;
    }
    
    input[type="number"] {
      -moz-appearance: textfield;
    }
    
    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    
    select:focus, input:focus {
      outline: none;
      border-color: #4285f4;
      box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }
    
    .info-box {
      background-color: #e8f0fe;
      border-left: 4px solid #4285f4;
      padding: 12px;
      margin-bottom: 20px;
      border-radius: 4px;
      font-size: 13px;
      color: #202124;
    }
    
    .result-box {
      background-color: #f8f9fa;
      border: 1px solid #dadce0;
      border-radius: 4px;
      padding: 15px;
      margin-top: 20px;
      display: none;
    }
    
    .result-box.success {
      background-color: #e6f4ea;
      border-color: #34a853;
    }
    
    .result-box.error {
      background-color: #fce8e6;
      border-color: #ea4335;
    }
    
    .result-box h3 {
      margin: 0 0 10px 0;
      font-size: 16px;
    }
    
    .result-item {
      margin: 8px 0;
      font-size: 14px;
    }
    
    .result-item strong {
      color: #1967d2;
    }
    
    .buttons {
      text-align: center;
      margin-top: 25px;
    }
    
    .btn {
      padding: 10px 24px;
      font-size: 14px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 0 5px;
      font-weight: 500;
    }
    
    .btn-primary {
      background-color: #4285f4;
      color: white;
    }
    
    .btn-primary:hover {
      background-color: #3367d6;
    }
    
    .btn-secondary {
      background-color: #f1f3f4;
      color: #202124;
    }
    
    .btn-secondary:hover {
      background-color: #e8eaed;
    }
    
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .loading {
      display: none;
      text-align: center;
      color: #5f6368;
      font-size: 14px;
      margin-top: 15px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2>ğŸ” ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ‰‹å‹•æ¤œç´¢</h2>
    <p>æ¡ä»¶ã‚’å…¥åŠ›ã—ã¦è©²å½“ã™ã‚‹ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢ã—ã¾ã™</p>
  </div>
  
  <div class="info-box">
    æ¡ä»¶ã«åˆã†ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼IDã‚’æ¤œç´¢ã—ã¾ã™ã€‚<br>
    ã‚¨ãƒ©ãƒ¼ã§è‡ªå‹•è¨­å®šã§ããªã‹ã£ãŸå ´åˆã®ç¢ºèªç”¨ã§ã™ã€‚
  </div>
  
  <div class="form-group">
    <label for="categorySelect">ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼š</label>
    <select id="categorySelect">
      <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
    </select>
  </div>
  
  <div class="form-group">
    <label for="conditionSelect">å•†å“çŠ¶æ…‹ï¼š</label>
    <select id="conditionSelect">
      <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
      <option value="æ–°å“">æ–°å“</option>
      <option value="ä¸­å¤">ä¸­å¤</option>
    </select>
  </div>
  
  <div class="form-group">
    <label for="shippingTypeSelect">é…é€æ–¹æ³•ï¼š</label>
    <select id="shippingTypeSelect">
      <option value="">-- é¸æŠã—ã¦ãã ã•ã„ --</option>
      <option value="ã‚¨ã‚³ãƒãƒŸãƒ¼">ã‚¨ã‚³ãƒãƒŸãƒ¼ï¼ˆeãƒ‘ã‚±ãƒƒãƒˆ / Cpass-Economyï¼‰</option>
      <option value="EX">EXï¼ˆCpass-FedEx / Cpass-DHL / eLogisticsï¼‰</option>
    </select>
  </div>
  
  <div class="form-group">
    <label for="priceInput">è²©å£²ä¾¡æ ¼ï¼ˆUSDï¼‰ï¼š</label>
    <input type="number" id="priceInput" placeholder="ä¾‹: 85.50" step="0.01" min="0">
  </div>
  
  <div class="buttons">
    <button class="btn btn-primary" id="searchBtn" onclick="searchPolicy()">æ¤œç´¢</button>
    <button class="btn btn-secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
  </div>
  
  <div class="loading" id="loading">æ¤œç´¢ä¸­...</div>
  
  <div class="result-box" id="resultBox">
    <h3 id="resultTitle">æ¤œç´¢çµæœ</h3>
    <div id="resultContent"></div>
  </div>
  
  <script>
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿
    google.script.run
      .withSuccessHandler(function(categories) {
        var select = document.getElementById('categorySelect');
        
        categories.forEach(function(cat) {
          var option = document.createElement('option');
          option.value = cat.value;
          option.textContent = cat.display;
          select.appendChild(option);
        });
      })
      .withFailureHandler(function(error) {
        alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      })
      .getShippingPolicyCategories();
    
    // æ¤œç´¢å®Ÿè¡Œ
    function searchPolicy() {
      var category = document.getElementById('categorySelect').value;
      var condition = document.getElementById('conditionSelect').value;
      var shippingType = document.getElementById('shippingTypeSelect').value;
      var price = parseFloat(document.getElementById('priceInput').value);
      
      // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
      if (!category) {
        alert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!condition) {
        alert('å•†å“çŠ¶æ…‹ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (!shippingType) {
        alert('é…é€æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
      }
      if (isNaN(price) || price < 0) {
        alert('ä¾¡æ ¼ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // UIçŠ¶æ…‹å¤‰æ›´
      document.getElementById('searchBtn').disabled = true;
      document.getElementById('loading').style.display = 'block';
      document.getElementById('resultBox').style.display = 'none';
      
      // æ¤œç´¢å®Ÿè¡Œ
      google.script.run
        .withSuccessHandler(function(result) {
          document.getElementById('searchBtn').disabled = false;
          document.getElementById('loading').style.display = 'none';
          displayResult(result);
        })
        .withFailureHandler(function(error) {
          document.getElementById('searchBtn').disabled = false;
          document.getElementById('loading').style.display = 'none';
          alert('æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .searchShippingPolicyManually({
          category: category,
          condition: condition,
          shippingType: shippingType,
          price: price
        });
    }
    
    // çµæœè¡¨ç¤º
    function displayResult(result) {
      var resultBox = document.getElementById('resultBox');
      var resultTitle = document.getElementById('resultTitle');
      var resultContent = document.getElementById('resultContent');
      
      if (result.success && result.policyId !== null) {
  html += '<div class="result-success">';
  html += '<h3>âœ… æ¤œç´¢æˆåŠŸ</h3>';
  html += '<p><strong>ãƒãƒªã‚·ãƒ¼ID:</strong> ' + result.policyId + '</p>';
  html += '<p><strong>ãƒãƒªã‚·ãƒ¼å:</strong> ' + (result.policyName || 'ä¸æ˜') + '</p>';
  
  // ã€è¿½åŠ ã€‘ä¾¡æ ¼æƒ…å ±ã®è¡¨ç¤º
  if (result.originalPrice !== undefined && result.adjustedPrice !== undefined) {
    html += '<hr style="margin: 15px 0; border: none; border-top: 1px solid #ddd;">';
    html += '<h4 style="margin-top: 15px; color: #666;">ä¾¡æ ¼æƒ…å ±ï¼ˆé–¢ç¨ç‡è€ƒæ…®ï¼‰</h4>';
    html += '<p><strong>å…¥åŠ›ä¾¡æ ¼ï¼ˆDDUï¼‰:</strong> $' + result.originalPrice.toFixed(2) + '</p>';
    html += '<p><strong>èª¿æ•´å¾Œä¾¡æ ¼:</strong> $' + result.adjustedPrice.toFixed(2) + '</p>';
    
    if (result.adjustment > 0) {
      html += '<p><strong>èª¿æ•´é¡:</strong> <span style="color: #d32f2f;">+$' + result.adjustment.toFixed(2) + '</span></p>';
      html += '<p style="font-size: 13px; color: #666; background: #fff3cd; padding: 8px; border-radius: 4px;">';
      html += 'ğŸ’¡ ç¾åœ¨ã®é–¢ç¨ç‡ï¼ˆAD2ã‚»ãƒ«ï¼‰ã«ã‚ˆã‚Šã€ä¾¡æ ¼å¸¯ãŒä¸Šæ–¹èª¿æ•´ã•ã‚Œã¾ã—ãŸã€‚';
      html += '</p>';
    } else {
      html += '<p><strong>èª¿æ•´é¡:</strong> $0.00ï¼ˆèª¿æ•´ãªã—ï¼‰</p>';
      html += '<p style="font-size: 13px; color: #666;">ğŸ’¡ åŸºæº–é–¢ç¨ç‡ï¼ˆ15%ï¼‰ã¨åŒã˜ãŸã‚ã€èª¿æ•´ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>';
    }
  }
  
  // é€æ–™ä¸Šé™ã®è¡¨ç¤ºï¼ˆæ—¢å­˜ï¼‰
  if (result.shippingLimit !== null && result.shippingLimit !== undefined) {
    html += '<p><strong>é€æ–™ä¸Šé™:</strong> $' + result.shippingLimit + '</p>';
  } else {
    html += '<p><strong>é€æ–™ä¸Šé™:</strong> ãªã—</p>';
  }
  
  html += '</div>';
}
      
      if (result.policyId === null) {
        resultBox.className = 'result-box error';
        resultTitle.textContent = 'âš ï¸ è©²å½“ãªã—';
        
        var html = '<div class="result-item">è©²å½“ã™ã‚‹ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚</div>';
        html += '<div class="result-item"><strong>æ¤œç´¢æ¡ä»¶ï¼š</strong></div>';
        html += '<div class="result-item">ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + result.searchConditions.category + '</div>';
        html += '<div class="result-item">ãƒ»å•†å“çŠ¶æ…‹: ' + result.searchConditions.condition + '</div>';
        html += '<div class="result-item">ãƒ»é…é€æ–¹æ³•: ' + result.searchConditions.shippingType + '</div>';
        html += '<div class="result-item">ãƒ»ä¾¡æ ¼: $' + result.searchConditions.price.toFixed(2) + '</div>';
        
        if (result.shippingLimit !== null) {
          html += '<div class="result-item" style="color: #d93025; margin-top: 10px;">ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®é€æ–™ä¸Šé™: $' + result.shippingLimit + '</div>';
        }
        
        resultContent.innerHTML = html;
        resultBox.style.display = 'block';
        return;
      }
      
      resultBox.className = 'result-box success';
      resultTitle.textContent = 'âœ… æ¤œç´¢æˆåŠŸ';
      
      var html = '<div class="result-item"><strong>ãƒãƒªã‚·ãƒ¼ID:</strong> ' + result.policyId + '</div>';
      if (result.policyName) {
        html += '<div class="result-item"><strong>ãƒãƒªã‚·ãƒ¼åç§°:</strong> ' + result.policyName + '</div>';
      }
      html += '<div class="result-item" style="margin-top: 10px;"><strong>æ¤œç´¢æ¡ä»¶ï¼š</strong></div>';
      html += '<div class="result-item">ãƒ»ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + result.searchConditions.category + '</div>';
      html += '<div class="result-item">ãƒ»å•†å“çŠ¶æ…‹: ' + result.searchConditions.condition + '</div>';
      html += '<div class="result-item">ãƒ»é…é€æ–¹æ³•: ' + result.searchConditions.shippingType + '</div>';
      html += '<div class="result-item">ãƒ»ä¾¡æ ¼: $' + result.searchConditions.price.toFixed(2) + '</div>';
      
      if (result.shippingLimit !== null) {
        html += '<div class="result-item" style="color: #1967d2; margin-top: 10px;">ã“ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®é€æ–™ä¸Šé™: $' + result.shippingLimit + '</div>';
      }
      
      resultContent.innerHTML = html;
      resultBox.style.display = 'block';
    }
  </script>
</body>
</html>