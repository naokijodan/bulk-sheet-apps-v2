<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
      font-size: 13px;
    }

    /* ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ */
    .tab-nav {
      display: flex;
      background: #fff;
      border-bottom: 1px solid #dadce0;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .tab-btn {
      flex: 1;
      padding: 12px 8px;
      border: none;
      background: transparent;
      cursor: pointer;
      font-size: 13px;
      font-weight: 500;
      color: #5f6368;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
    }
    .tab-btn:hover {
      background: #f1f3f4;
    }
    .tab-btn.active {
      color: #1a73e8;
      border-bottom-color: #1a73e8;
    }

    /* ã‚¿ãƒ–ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ */
    .tab-content {
      display: none;
      padding: 12px;
    }
    .tab-content.active {
      display: block;
    }

    /* å…±é€šã‚¹ã‚¿ã‚¤ãƒ« */
    h3 {
      color: #1a73e8;
      margin: 0 0 12px 0;
      font-size: 15px;
    }
    label {
      display: block;
      margin-bottom: 4px;
      font-weight: 500;
      color: #3c4043;
    }
    textarea {
      width: 100%;
      height: 200px;
      margin-bottom: 12px;
      padding: 10px;
      font-size: 13px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      resize: vertical;
    }
    select {
      width: 100%;
      margin-bottom: 12px;
      padding: 8px;
      font-size: 13px;
      border: 1px solid #dadce0;
      border-radius: 4px;
      background-color: #fff;
    }
    button {
      padding: 8px 16px;
      font-size: 13px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 8px;
      margin-bottom: 8px;
      transition: all 0.2s;
    }
    button.primary {
      background-color: #1a73e8;
      color: white;
    }
    button.primary:hover {
      background-color: #1557b0;
    }
    button.secondary {
      background-color: #e8eaed;
      color: #3c4043;
    }
    button.secondary:hover {
      background-color: #dadce0;
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒœãƒƒã‚¯ã‚¹ */
    .message {
      margin-top: 12px;
      padding: 10px;
      border-radius: 4px;
      font-weight: 500;
      display: none;
    }
    .message.success {
      background-color: #e6ffe6;
      color: #188038;
      border: 1px solid #188038;
    }
    .message.error {
      background-color: #ffe6e6;
      color: #d93025;
      border: 1px solid #d93025;
    }
    .message.info {
      background-color: #e8f0fe;
      color: #1a73e8;
      border: 1px solid #1a73e8;
    }

    /* ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ: ã‚»ãƒ«æƒ…å ±ã‚«ãƒ¼ãƒ‰ */
    .cell-info-card {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
    }
    .cell-info-card h4 {
      margin: 0 0 8px 0;
      font-size: 13px;
      color: #5f6368;
    }
    .cell-info-row {
      display: flex;
      justify-content: space-between;
      padding: 4px 0;
      border-bottom: 1px solid #f1f3f4;
    }
    .cell-info-row:last-child {
      border-bottom: none;
    }
    .cell-info-label {
      color: #5f6368;
    }
    .cell-info-value {
      font-weight: 500;
      color: #202124;
      max-width: 60%;
      word-break: break-all;
    }
    .cell-info-value.error {
      color: #d93025;
    }

    /* ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ: ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ */
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 12px;
    }
    .action-btn {
      flex: 1;
      min-width: 100px;
      padding: 10px;
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      cursor: pointer;
      text-align: center;
      transition: all 0.2s;
    }
    .action-btn:hover {
      background: #f1f3f4;
      border-color: #1a73e8;
    }
    .action-btn-icon {
      font-size: 20px;
      margin-bottom: 4px;
    }
    .action-btn-label {
      font-size: 12px;
      color: #3c4043;
    }

    /* ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ: çµæœè¡¨ç¤º */
    .result-box {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 12px;
      white-space: pre-wrap;
      line-height: 1.5;
    }
    .result-box.loading {
      color: #5f6368;
      text-align: center;
    }

    /* ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ: FAQ */
    .faq-item {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      margin-bottom: 8px;
      overflow: hidden;
    }
    .faq-question {
      padding: 10px 12px;
      cursor: pointer;
      font-weight: 500;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .faq-question:hover {
      background: #f1f3f4;
    }
    .faq-answer {
      padding: 0 12px;
      max-height: 0;
      overflow: hidden;
      transition: all 0.2s;
      border-top: 1px solid #dadce0;
      background: #f8f9fa;
    }
    .faq-answer.open {
      padding: 10px 12px;
      max-height: 200px;
    }

    /* ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ: ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ */
    .feedback-form {
      background: #fff;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
    }
  </style>
</head>
<body>

  <!-- ã‚¿ãƒ–ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
  <div class="tab-nav">
    <button class="tab-btn active" onclick="switchTab('prompt')">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ</button>
    <button class="tab-btn" onclick="switchTab('assistant')">ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</button>
  </div>

  <!-- ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚¿ãƒ– -->
  <div id="tab-prompt" class="tab-content active">
    <h3>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</h3>
    <label for="promptSelect">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆID:</label>
    <select id="promptSelect" onchange="loadPrompt()">
    </select>
    <label for="promptContent">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹:</label>
    <textarea id="promptContent"></textarea>
    <button class="primary" onclick="savePrompt()">ä¿å­˜</button>
    <button class="secondary" onclick="google.script.host.close()">é–‰ã˜ã‚‹</button>
    <div id="promptMessageBox" class="message"></div>
  </div>

  <!-- ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚¿ãƒ– -->
  <div id="tab-assistant" class="tab-content">
    <h3>ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆ</h3>

    <!-- ã‚»ãƒ«æƒ…å ±ã‚«ãƒ¼ãƒ‰ -->
    <div class="cell-info-card" id="cellInfoCard">
      <h4>é¸æŠä¸­ã®ã‚»ãƒ«</h4>
      <div id="cellInfoContent">
        <p style="color: #5f6368; text-align: center;">ã‚»ãƒ«ã‚’é¸æŠã—ã¦ã€Œæ›´æ–°ã€ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
      </div>
      <button class="secondary" onclick="refreshCellInfo()" style="width: 100%; margin-top: 8px;">
        ã‚»ãƒ«æƒ…å ±ã‚’æ›´æ–°
      </button>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="action-buttons">
      <div class="action-btn" onclick="analyzeCell()">
        <div class="action-btn-icon">ğŸ”</div>
        <div class="action-btn-label">è¨ºæ–­ã™ã‚‹</div>
      </div>
      <div class="action-btn" onclick="getColumnInfo()">
        <div class="action-btn-icon">ğŸ“–</div>
        <div class="action-btn-label">è©³ç´°ã‚’è¡¨ç¤º</div>
      </div>
    </div>

    <!-- çµæœè¡¨ç¤º -->
    <div class="result-box" id="resultBox" style="display: none;"></div>

    <!-- FAQ -->
    <h4 style="margin: 16px 0 8px 0; color: #5f6368;">ã‚ˆãã‚ã‚‹è³ªå•</h4>
    <div id="faqList"></div>

    <!-- ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ -->
    <h4 style="margin: 16px 0 8px 0; color: #5f6368;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯</h4>
    <div class="feedback-form" style="text-align: center;">
      <p style="color: #5f6368; margin-bottom: 12px;">ãƒã‚°å ±å‘Šãƒ»æ©Ÿèƒ½è¦æœ›ãƒ»ã”è³ªå•ã¯ã“ã¡ã‚‰ã‹ã‚‰</p>
      <a href="https://docs.google.com/forms/d/e/1FAIpQLSdhsa_rx3HXRSkSgkp0IVLpcVSqjCa1ksYy2_TT_B6tuJMO2A/viewform" target="_blank" class="primary" style="display: inline-block; text-decoration: none; padding: 10px 20px;">ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’é€ã‚‹</a>
      <p style="color: #9aa0a6; font-size: 11px; margin-top: 8px;">â€»ã€Œä¸€æ‹¬ã‚·ãƒ¼ãƒˆV3ã€ã‚’é¸æŠã—ã¦ãã ã•ã„</p>
    </div>
    <div id="assistantMessageBox" class="message"></div>
  </div>

  <script>
    // ç¾åœ¨ã®ã‚¿ãƒ–
    let currentTab = 'prompt';
    // ç¾åœ¨ã®ã‚»ãƒ«æƒ…å ±
    let currentCellInfo = null;

    // ========== ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ ==========
    function switchTab(tabName) {
      currentTab = tabName;

      // ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      event.target.classList.add('active');

      // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
      document.getElementById('tab-' + tabName).classList.add('active');

      // ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆã‚¿ãƒ–ã«åˆ‡ã‚Šæ›¿ãˆãŸæ™‚ã€ã‚»ãƒ«æƒ…å ±ã‚’å–å¾—
      if (tabName === 'assistant' && !currentCellInfo) {
        refreshCellInfo();
        loadFaqList();
      }
    }

    // ========== ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†æ©Ÿèƒ½ ==========
    function showPromptMessage(msg, type) {
      const msgBox = document.getElementById('promptMessageBox');
      msgBox.textContent = msg;
      msgBox.className = 'message ' + type;
      msgBox.style.display = 'block';
      setTimeout(() => { msgBox.style.display = 'none'; }, 3000);
    }

    function populatePromptSelect(promptIds) {
      const select = document.getElementById('promptSelect');
      select.innerHTML = '<option value="">--é¸æŠã—ã¦ãã ã•ã„--</option>';
      promptIds.forEach(id => {
        const option = document.createElement('option');
        option.value = id;
        option.textContent = id;
        select.appendChild(option);
      });
    }

    function loadPrompt() {
      const promptId = document.getElementById('promptSelect').value;
      if (promptId) {
        google.script.run
          .withSuccessHandler(function(content) {
            document.getElementById('promptContent').value = content;
          })
          .withFailureHandler(function(error) {
            showPromptMessage('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
            document.getElementById('promptContent').value = '';
          })
          .getPromptContent(promptId);
      } else {
        document.getElementById('promptContent').value = '';
      }
    }

    function savePrompt() {
      const promptId = document.getElementById('promptSelect').value;
      const promptContent = document.getElementById('promptContent').value;
      if (!promptId) {
        showPromptMessage('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆIDã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      if (!promptContent.trim()) {
        showPromptMessage('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå†…å®¹ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }

      google.script.run
        .withSuccessHandler(function() {
          showPromptMessage('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼', 'success');
        })
        .withFailureHandler(function(error) {
          showPromptMessage('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .savePromptContent(promptId, promptContent);
    }

    // ========== ã‚¢ã‚·ã‚¹ã‚¿ãƒ³ãƒˆæ©Ÿèƒ½ ==========
    function showAssistantMessage(msg, type) {
      const msgBox = document.getElementById('assistantMessageBox');
      msgBox.textContent = msg;
      msgBox.className = 'message ' + type;
      msgBox.style.display = 'block';
      setTimeout(() => { msgBox.style.display = 'none'; }, 3000);
    }

    function callAssistant(action, data, callback) {
      const request = JSON.stringify({ action: action, data: data || {} });
      google.script.run
        .withSuccessHandler(function(response) {
          if (typeof response === 'string') {
            try { response = JSON.parse(response); } catch (e) {}
          }
          callback(response);
        })
        .withFailureHandler(function(error) {
          callback({ success: false, error: error.message });
        })
        .savePromptContent('__ASSISTANT__', request);
    }

    function refreshCellInfo() {
      const contentDiv = document.getElementById('cellInfoContent');
      contentDiv.innerHTML = '<p style="color: #5f6368; text-align: center;">èª­ã¿è¾¼ã¿ä¸­...</p>';

      callAssistant('GET_SELECTED_CELL_INFO', {}, function(response) {
        if (response.success) {
          currentCellInfo = response.data;
          renderCellInfo(response.data);
        } else {
          contentDiv.innerHTML = '<p style="color: #d93025;">ã‚¨ãƒ©ãƒ¼: ' + response.error + '</p>';
        }
      });
    }

    function renderCellInfo(info) {
      const contentDiv = document.getElementById('cellInfoContent');
      let html = '';
      html += '<div class="cell-info-row"><span class="cell-info-label">ä½ç½®</span><span class="cell-info-value">' + info.colLetter + info.row + '</span></div>';
      html += '<div class="cell-info-row"><span class="cell-info-label">ã‚·ãƒ¼ãƒˆ</span><span class="cell-info-value">' + info.sheetName + '</span></div>';
      html += '<div class="cell-info-row"><span class="cell-info-label">åˆ—å</span><span class="cell-info-value">' + (info.headerName || '(ãªã—)') + '</span></div>';
      html += '<div class="cell-info-row"><span class="cell-info-label">å€¤</span><span class="cell-info-value">' + (info.displayValue || '(ç©º)') + '</span></div>';
      if (info.hasError) {
        html += '<div class="cell-info-row"><span class="cell-info-label">ã‚¨ãƒ©ãƒ¼</span><span class="cell-info-value error">' + info.errorType + '</span></div>';
      }
      contentDiv.innerHTML = html;
    }

    function analyzeCell() {
      const resultBox = document.getElementById('resultBox');
      resultBox.style.display = 'block';
      resultBox.className = 'result-box loading';
      resultBox.textContent = 'è¨ºæ–­ä¸­...';

      callAssistant('ANALYZE_CELL', {}, function(response) {
        resultBox.className = 'result-box';
        if (response.success) {
          resultBox.textContent = response.data.diagnosis;
        } else {
          resultBox.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + response.error;
        }
      });
    }

    function getColumnInfo() {
      const resultBox = document.getElementById('resultBox');
      resultBox.style.display = 'block';
      resultBox.className = 'result-box loading';
      resultBox.textContent = 'å–å¾—ä¸­...';

      callAssistant('GET_COLUMN_INFO', {}, function(response) {
        resultBox.className = 'result-box';
        if (response.success) {
          const data = response.data;
          let sections = [];

          // 1. å›ºå®šã‚»ãƒ«èª¬æ˜ï¼ˆ1è¡Œç›®ï¼šèª¬æ˜ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
          if (data.cell1Description) {
            sections.push('ğŸ“ ã‚»ãƒ«ã€Œ' + data.cell1Address + 'ã€\n' + data.cell1Description);
          }

          // 2. å›ºå®šã‚»ãƒ«èª¬æ˜ï¼ˆ2è¡Œç›®ï¼šèª¬æ˜ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
          if (data.cell2Description) {
            sections.push('ğŸ“ ã‚»ãƒ«ã€Œ' + data.cell2Address + 'ã€\n' + data.cell2Description);
          }

          // 3. åˆ—èª¬æ˜ï¼ˆå¸¸ã«è¡¨ç¤ºï¼‰
          if (data.columnDescription) {
            sections.push('ğŸ“Š åˆ—ã€Œ' + (data.headerName || 'åç§°æœªè¨­å®š') + 'ã€ï¼ˆ' + data.colLetter + 'åˆ—ï¼‰\n' + data.columnDescription);
          } else {
            sections.push('ğŸ“Š åˆ—ã€Œ' + (data.headerName || 'åç§°æœªè¨­å®š') + 'ã€ï¼ˆ' + data.colLetter + 'åˆ—ï¼‰\nèª¬æ˜ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚');
          }

          // 4. ã‚·ãƒ¼ãƒˆèª¬æ˜ï¼ˆèª¬æ˜ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤ºï¼‰
          if (data.sheetDescription) {
            sections.push('ğŸ“‹ ã‚·ãƒ¼ãƒˆã€Œ' + data.sheetName + 'ã€\n' + data.sheetDescription);
          }

          // åŒºåˆ‡ã‚Šç·šã§çµåˆã—ã¦è¡¨ç¤º
          resultBox.textContent = sections.join('\n\n----------------\n');

        } else {
          resultBox.textContent = 'ã‚¨ãƒ©ãƒ¼: ' + response.error;
        }
      });
    }

    function loadFaqList() {
      callAssistant('GET_FAQ_LIST', {}, function(response) {
        if (response.success) {
          renderFaqList(response.data);
        }
      });
    }

    function renderFaqList(faqList) {
      const container = document.getElementById('faqList');
      let html = '';
      faqList.forEach((faq, index) => {
        html += '<div class="faq-item">';
        html += '<div class="faq-question" onclick="toggleFaq(' + index + ')">' + faq.question + ' <span id="faq-icon-' + index + '">+</span></div>';
        html += '<div class="faq-answer" id="faq-answer-' + index + '">' + faq.answer + '</div>';
        html += '</div>';
      });
      container.innerHTML = html;
    }

    function toggleFaq(index) {
      const answer = document.getElementById('faq-answer-' + index);
      const icon = document.getElementById('faq-icon-' + index);
      if (answer.classList.contains('open')) {
        answer.classList.remove('open');
        icon.textContent = '+';
      } else {
        answer.classList.add('open');
        icon.textContent = '-';
      }
    }

    // ========== åˆæœŸåŒ– ==========
    google.script.run.withSuccessHandler(populatePromptSelect).getAllPromptIds();
  </script>
</body>
</html>
