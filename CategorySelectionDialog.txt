<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      padding: 20px;
      margin: 0;
      background-color: #f9f9f9;
    }
    .container {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.1);
      max-width: 400px;
      margin: 0 auto;
    }
    h3 {
      color: #1a73e8;
      margin-bottom: 16px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .description {
      color: #5f6368;
      font-size: 14px;
      margin-bottom: 20px;
      line-height: 1.5;
    }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #2b2f33;
    }
    select {
      width: 100%;
      padding: 12px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      background: white;
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }
    select:focus {
      outline: none;
      border-color: #1a73e8;
      box-shadow: 0 0 0 3px rgba(26,115,232,0.18);
    }
    .info-box {
      background-color: #e8f0fe;
      border: 1px solid #dadce0;
      border-radius: 8px;
      padding: 12px;
      margin-top: 16px;
    }
    .info-title {
      font-weight: 700;
      color: #1a73e8;
      margin-bottom: 6px;
      font-size: 13px;
    }
    .info-content {
      font-size: 12px;
      color: #5f6368;
      line-height: 1.4;
    }
    .error-box {
      background-color: #ffebee;
      color: #c62828;
      padding: 12px;
      border-radius: 8px;
      margin-bottom: 16px;
      border-left: 4px solid #c62828;
      display: none;
    }
    .button-group {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 24px;
    }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 24px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.15s ease;
    }
    .btn-primary {
      background-color: #1a73e8;
      color: white;
      box-shadow: 0 2px 8px rgba(26,115,232,0.3);
    }
    .btn-primary:hover {
      background-color: #1557b0;
    }
    .btn-secondary {
      background-color: #f1f3f4;
      color: #3c4043;
    }
    .btn-secondary:hover {
      background-color: #e8eaed;
    }
    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .spinner {
      width: 16px;
      height: 16px;
      border: 2px solid rgba(255,255,255,0.3);
      border-top: 2px solid white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-right: 8px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .loading .btn-text { display: none; }
  </style>
</head>
<body>
  <div class="container">
    <div id="errorBox" class="error-box"></div>
    
    <h3>ğŸ“‚ ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ</h3>
    <div class="description">
      ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã§ä½¿ç”¨ã™ã‚‹å•†å“ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚<br>
      é¸æŠå¾Œã€å„è¡Œã®Qåˆ—ï¼ˆä¾¡æ ¼ï¼‰ã€ABåˆ—ï¼ˆå•†å“çŠ¶æ…‹ï¼‰ã€Wåˆ—ï¼ˆé…é€æ–¹æ³•ï¼‰ã‹ã‚‰è‡ªå‹•çš„ã«æ¡ä»¶ã‚’èª­ã¿å–ã‚Šã€4æ¬¡å…ƒæ¤œç´¢ã‚’å®Ÿè¡Œã—ã¾ã™ã€‚
    </div>
    
    <form id="categoryForm">
      <label for="categorySelect">å•†å“ã‚«ãƒ†ã‚´ãƒªãƒ¼ *</label>
      <select id="categorySelect" name="categorySelect" required>
        <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
      </select>
      
      <div class="info-box">
        <div class="info-title">ğŸ’¡ 4æ¬¡å…ƒæ¤œç´¢ã«ã¤ã„ã¦</div>
        <div class="info-content">
          <strong>æ¤œç´¢æ¡ä»¶ï¼š</strong><br>
          1. ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆã“ã“ã§é¸æŠï¼‰<br>
          2. å•†å“çŠ¶æ…‹ï¼ˆABåˆ—ã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰<br>
          3. é…é€æ–¹æ³•ï¼ˆWåˆ—ã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰<br>
          4. è²©å£²ä¾¡æ ¼ï¼ˆQåˆ—ã‹ã‚‰è‡ªå‹•å–å¾—ï¼‰<br><br>
          å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‹ã‚‰è©²å½“ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œç´¢ã—ã€Eåˆ—ã«è¨­å®šã—ã¾ã™ã€‚
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn btn-secondary" onclick="cancelSelection()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="btn btn-primary" id="selectBtn">
          <span class="btn-text">é¸æŠã—ã¦æ›´æ–°é–‹å§‹</span>
          <span class="spinner" style="display: none;"></span>
        </button>
      </div>
    </form>
  </div>

  <script>
    var categories = [];
    var isProcessing = false;
    
    // åˆæœŸåŒ–
    window.onload = function() {
      loadCategories();
    };
    
    function loadCategories() {
      showMessage('ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã¿ä¸­...', 'info');
      
      google.script.run
        .withSuccessHandler(function(categoryList) {
          categories = categoryList || [];
          populateCategoryDropdown();
          hideMessage();
        })
        .withFailureHandler(function(error) {
          console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          showMessage('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
          
          // ã‚¨ãƒ©ãƒ¼æ™‚ã¯æ‰‹å‹•å…¥åŠ›ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’æä¾›
          setTimeout(function() {
            if (confirm('ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã®è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§ã‚«ãƒ†ã‚´ãƒªãƒ¼åã‚’å…¥åŠ›ã—ã¾ã™ã‹ï¼Ÿ')) {
              var manual = prompt('ã‚«ãƒ†ã‚´ãƒªãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:', 'ãã®ä»–');
              if (manual && manual.trim()) {
                categories = [manual.trim()];
                populateCategoryDropdown();
                hideMessage();
              }
            }
          }, 1000);
        })
        .getCategoryListFromReferenceData();
    }
    
    function populateCategoryDropdown() {
      var select = document.getElementById('categorySelect');
      
      if (categories.length === 0) {
        select.innerHTML = '<option value="">åˆ©ç”¨å¯èƒ½ãªã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“</option>';
        document.getElementById('selectBtn').disabled = true;
        showMessage('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'error');
        return;
      }
      
      select.innerHTML = '<option value="">ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      
      categories.forEach(function(category) {
        var option = document.createElement('option');
        option.value = category;
        option.textContent = category;
        select.appendChild(option);
      });
      
      document.getElementById('selectBtn').disabled = false;
    }
    
    function showMessage(message, type) {
      var errorBox = document.getElementById('errorBox');
      errorBox.textContent = message;
      errorBox.style.display = 'block';
      
      if (type === 'error') {
        errorBox.style.backgroundColor = '#ffebee';
        errorBox.style.color = '#c62828';
        errorBox.style.borderLeftColor = '#c62828';
      } else if (type === 'info') {
        errorBox.style.backgroundColor = '#e3f2fd';
        errorBox.style.color = '#1565c0';
        errorBox.style.borderLeftColor = '#2196f3';
      }
    }
    
    function hideMessage() {
      document.getElementById('errorBox').style.display = 'none';
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
    document.getElementById('categoryForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      if (isProcessing) return; // é‡è¤‡å®Ÿè¡Œé˜²æ­¢
      
      var selectedCategory = document.getElementById('categorySelect').value;
      if (!selectedCategory) {
        showMessage('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      
      isProcessing = true;
      setLoading(true);
      hideMessage();
      
      // é¸æŠçµæœã‚’é€ä¿¡ã—ã¦å‡¦ç†é–‹å§‹
      google.script.run
        .withSuccessHandler(function() {
          // æˆåŠŸæ™‚ã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‰ã˜ã‚‹
          // ï¼ˆå®Ÿéš›ã®å‡¦ç†ã¯ãƒãƒƒã‚¯ã‚°ãƒ©ã‚¦ãƒ³ãƒ‰ã§ç¶šè¡Œã•ã‚Œã‚‹ï¼‰
          google.script.host.close();
        })
        .withFailureHandler(function(error) {
          isProcessing = false;
          setLoading(false);
          console.error('å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          showMessage('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã®é–‹å§‹ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message, 'error');
        })
        .handleCategorySelection(selectedCategory);
    });
    
    function cancelSelection() {
      if (isProcessing) {
        if (!confirm('å‡¦ç†ã‚’ä¸­æ–­ã—ã¾ã™ã‹ï¼Ÿ')) {
          return;
        }
      }
      
      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã®å‡¦ç†
      google.script.run
        .withSuccessHandler(function() {
          google.script.host.close();
        })
        .withFailureHandler(function(error) {
          console.error('ã‚­ãƒ£ãƒ³ã‚»ãƒ«å‡¦ç†ã‚¨ãƒ©ãƒ¼:', error);
          // ã‚¨ãƒ©ãƒ¼ã§ã‚‚å¼·åˆ¶çš„ã«é–‰ã˜ã‚‹
          google.script.host.close();
        })
        .handleCategorySelection(null);
    }
    
    function setLoading(loading) {
      var btn = document.getElementById('selectBtn');
      var btnText = btn.querySelector('.btn-text');
      var spinner = btn.querySelector('.spinner');
      
      if (loading) {
        btn.disabled = true;
        btnText.style.display = 'none';
        spinner.style.display = 'inline-block';
      } else {
        btn.disabled = false;
        btnText.style.display = 'inline';
        spinner.style.display = 'none';
      }
    }
    
    // ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹å‰ã®ç¢ºèªï¼ˆå‡¦ç†ä¸­ã®å ´åˆï¼‰
    window.addEventListener('beforeunload', function(e) {
      if (isProcessing) {
        e.preventDefault();
        e.returnValue = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°å‡¦ç†ãŒå®Ÿè¡Œä¸­ã§ã™ã€‚ãƒšãƒ¼ã‚¸ã‚’é–‰ã˜ã‚‹ã¨å‡¦ç†ãŒä¸­æ–­ã•ã‚Œã¾ã™ã€‚';
        return e.returnValue;
      }
    });
  </script>
</body>
</html>