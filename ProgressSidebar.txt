<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 16px;
      background-color: #f5f5f5;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 16px;
      margin: -16px -16px 16px -16px;
      border-radius: 0 0 8px 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .header h2 {
      margin: 0;
      font-size: 18px;
      font-weight: 600;
    }

    .status-card {
      background: white;
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .status-label {
      font-size: 12px;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      font-weight: 600;
    }

    .status-value {
      font-size: 24px;
      font-weight: bold;
      color: #333;
    }

    .status-value.success {
      color: #10b981;
    }

    .status-value.error {
      color: #ef4444;
    }

    .status-value.batch {
      color: #3b82f6;
    }

    .progress-bar {
      width: 100%;
      height: 8px;
      background-color: #e5e7eb;
      border-radius: 4px;
      overflow: hidden;
      margin-top: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
      transition: width 0.3s ease;
      border-radius: 4px;
    }

    .log-container {
      background: white;
      border-radius: 8px;
      padding: 12px;
      max-height: 300px;
      overflow-y: auto;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .log-title {
      font-size: 14px;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
    }

    .log-entry {
      font-size: 12px;
      padding: 6px 8px;
      margin-bottom: 4px;
      border-radius: 4px;
      border-left: 3px solid #e5e7eb;
      background-color: #f9fafb;
    }

    .log-entry.success {
      border-left-color: #10b981;
      background-color: #f0fdf4;
    }

    .log-entry.error {
      border-left-color: #ef4444;
      background-color: #fef2f2;
    }

    .log-entry.info {
      border-left-color: #3b82f6;
      background-color: #eff6ff;
    }

    .log-entry.warning {
      border-left-color: #f59e0b;
      background-color: #fffbeb;
    }

    .timestamp {
      color: #9ca3af;
      font-size: 10px;
      margin-right: 6px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 12px;
    }

    .stat-mini {
      background: white;
      border-radius: 6px;
      padding: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    .stat-mini-label {
      font-size: 11px;
      color: #666;
      margin-bottom: 4px;
    }

    .stat-mini-value {
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .completion-banner {
      display: none;
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
      padding: 20px;
      margin-bottom: 16px;
      border-radius: 8px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      text-align: center;
    }

    .completion-banner.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .completion-title {
      font-size: 20px;
      font-weight: bold;
      margin-bottom: 8px;
    }

    .completion-message {
      font-size: 14px;
      margin-bottom: 16px;
      opacity: 0.95;
    }

    .close-button {
      background: white;
      color: #10b981;
      border: none;
      padding: 12px 24px;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      transition: all 0.2s ease;
    }

    .close-button:hover {
      background: #f0fdf4;
      transform: translateY(-1px);
      box-shadow: 0 4px 6px rgba(0,0,0,0.15);
    }

    .close-button:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    /* æ›´æ–°é€šçŸ¥ãƒãƒŠãƒ¼ */
    .update-banner {
      display: none;
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
      padding: 12px 16px;
      margin: -16px -16px 16px -16px;
      font-size: 13px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .update-banner:hover {
      background: linear-gradient(135deg, #d97706 0%, #b45309 100%);
    }

    .update-banner.show {
      display: block;
    }

    .update-banner-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .update-banner-note {
      font-size: 11px;
      opacity: 0.9;
    }

    .update-banner-close {
      float: right;
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      padding: 0;
      line-height: 1;
      opacity: 0.8;
    }

    .update-banner-close:hover {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="header">
    <h2 id="headerTitle">ğŸ”„ ç¿»è¨³å‡¦ç†ã®é€²æ—</h2>
  </div>

  <!-- æ›´æ–°é€šçŸ¥ãƒãƒŠãƒ¼ -->
  <div class="update-banner" id="updateBanner">
    <button class="update-banner-close" onclick="closeUpdateBanner(event)">Ã—</button>
    <div class="update-banner-title">ğŸ“¢ ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ã‚ã‚Š: <span id="updateVersion"></span></div>
    <div class="update-banner-note" id="updateNote"></div>
  </div>

  <div class="completion-banner" id="completionBanner">
    <div class="completion-title">âœ… å‡¦ç†å®Œäº†ï¼</div>
    <div class="completion-message">ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸã€‚<br>ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã¦ãã ã•ã„ã€‚</div>
    <button class="close-button" onclick="closeSidebar()">ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹</button>
  </div>

  <div class="status-card">
    <div class="status-label">ç¾åœ¨ã®ãƒãƒƒãƒ</div>
    <div class="status-value batch" id="currentBatch">-</div>
    <div class="progress-bar">
      <div class="progress-fill" id="progressBar" style="width: 0%"></div>
    </div>
  </div>

  <div class="stats-grid">
    <div class="stat-mini">
      <div class="stat-mini-label">âœ… æˆåŠŸ</div>
      <div class="stat-mini-value" style="color: #10b981;" id="successCount">0</div>
    </div>
    <div class="stat-mini">
      <div class="stat-mini-label">âŒ ã‚¨ãƒ©ãƒ¼</div>
      <div class="stat-mini-value" style="color: #ef4444;" id="errorCount">0</div>
    </div>
  </div>

  <div class="log-container">
    <div class="log-title">ğŸ“‹ å‡¦ç†ãƒ­ã‚°</div>
    <div id="logEntries"></div>
  </div>

  <script>
    var pollingInterval = null;
    var isCompleted = false;

    function updateProgress(data) {
      // ãƒãƒƒãƒé€²æ—
      if (data.currentBatch !== undefined && data.totalBatches !== undefined) {
        document.getElementById('currentBatch').textContent =
          data.currentBatch + ' / ' + data.totalBatches;

        var progress = (data.currentBatch / data.totalBatches) * 100;
        document.getElementById('progressBar').style.width = progress + '%';
      }

      // å®Œäº†æ¤œçŸ¥ï¼ˆæ˜ç¤ºçš„ãªãƒ•ãƒ©ã‚°ã§åˆ¤å®šï¼‰
      if (!isCompleted && data.isCompleted === true) {
        showCompletionBanner();
      }

      // æˆåŠŸãƒ»ã‚¨ãƒ©ãƒ¼ã‚«ã‚¦ãƒ³ãƒˆ
      if (data.successCount !== undefined) {
        document.getElementById('successCount').textContent = data.successCount;
      }
      if (data.errorCount !== undefined) {
        document.getElementById('errorCount').textContent = data.errorCount;
      }

      // ãƒ­ã‚°ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (data.message) {
        addLogEntry(data.message, data.logType || 'info');
      }
    }

    function showCompletionBanner() {
      isCompleted = true;

      // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å¤‰æ›´
      document.getElementById('headerTitle').textContent = 'âœ… ç¿»è¨³å‡¦ç†ã®é€²æ—';

      // å®Œäº†ãƒãƒŠãƒ¼ã‚’è¡¨ç¤º
      var banner = document.getElementById('completionBanner');
      banner.classList.add('show');

      // ãƒãƒ¼ãƒªãƒ³ã‚°ã‚’åœæ­¢
      if (pollingInterval) {
        clearInterval(pollingInterval);
        pollingInterval = null;
        console.log('âœ… ãƒãƒ¼ãƒªãƒ³ã‚°åœæ­¢ï¼ˆå‡¦ç†å®Œäº†ï¼‰');
      }

      // å®Œäº†ãƒ­ã‚°ã‚’è¿½åŠ 
      addLogEntry('âœ… ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼', 'success');
    }

    function closeSidebar() {
      // Google Apps Scriptã®ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’é–‰ã˜ã‚‹
      google.script.host.close();
    }

    var lastMessage = '';  // æœ€å¾Œã«è¿½åŠ ã—ãŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¨˜éŒ²

    function addLogEntry(message, type) {
      // åŒã˜ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒé€£ç¶šã™ã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (message === lastMessage) {
        return;
      }

      lastMessage = message;

      var logContainer = document.getElementById('logEntries');
      var entry = document.createElement('div');
      entry.className = 'log-entry ' + type;

      var timestamp = new Date().toLocaleTimeString('ja-JP');
      entry.innerHTML = '<span class="timestamp">' + timestamp + '</span>' + message;

      logContainer.insertBefore(entry, logContainer.firstChild);

      // æœ€å¤§50ä»¶ã¾ã§ã®ãƒ­ã‚°ã‚’ä¿æŒ
      while (logContainer.children.length > 50) {
        logContainer.removeChild(logContainer.lastChild);
      }
    }

    // åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    addLogEntry('ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’åˆæœŸåŒ–ã—ã¾ã—ãŸ', 'info');

    // å®šæœŸçš„ã«ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    function pollProgress() {
      google.script.run
        .withSuccessHandler(function(data) {
          if (data) {
            updateProgress(data);
          }
        })
        .withFailureHandler(function(error) {
          console.error('é€²æ—å–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getProgressData();
    }

    // 5ç§’ã”ã¨ã«ãƒãƒ¼ãƒªãƒ³ã‚°
    pollingInterval = setInterval(pollProgress, 5000);

    // åˆå›å®Ÿè¡Œ
    pollProgress();

    // =============================================
    // ãƒ©ã‚¤ãƒ–ãƒ©ãƒªæ›´æ–°ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã‚µã‚¤ãƒ‰ï¼‰
    // =============================================
    var VERSION_JSON_URL = 'https://raw.githubusercontent.com/naokijodan/bulk-sheet-apps-v2/main/version.json';
    var UPDATE_CHECK_KEY = 'libUpdateLastCheck';
    var UPDATE_DISMISSED_KEY = 'libUpdateDismissed';

    // ç¾åœ¨ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ï¼ˆGASå´ã‹ã‚‰åŸ‹ã‚è¾¼ã¿ï¼‰
    var CURRENT_VERSION = {{CURRENT_VERSION}};

    function checkLibraryUpdate() {
      try {
        // ä»Šæ—¥ã®æ—¥ä»˜
        var today = new Date().toISOString().split('T')[0];

        // ä»Šæ—¥ã™ã§ã«ãƒã‚§ãƒƒã‚¯æ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—
        var lastCheck = localStorage.getItem(UPDATE_CHECK_KEY);
        if (lastCheck === today) {
          console.log('æ›´æ–°ãƒã‚§ãƒƒã‚¯: ä»Šæ—¥ã¯ãƒã‚§ãƒƒã‚¯æ¸ˆã¿');
          return;
        }

        // æ—¢ã«é–‰ã˜ãŸé€šçŸ¥ã¯ä»Šæ—¥ã¯è¡¨ç¤ºã—ãªã„
        var dismissed = localStorage.getItem(UPDATE_DISMISSED_KEY);
        if (dismissed === today) {
          console.log('æ›´æ–°ãƒã‚§ãƒƒã‚¯: ä»Šæ—¥ã¯é€šçŸ¥ã‚’é–‰ã˜æ¸ˆã¿');
          return;
        }

        // ãƒãƒ¼ã‚¸ãƒ§ãƒ³æ¯”è¼ƒã‚’å®Ÿè¡Œ
        fetchAndCompareVersion(CURRENT_VERSION, today);

      } catch (e) {
        console.warn('æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚¨ãƒ©ãƒ¼:', e);
        // å¤±æ•—ã—ã¦ã‚‚é™ã‹ã«ã‚¹ã‚­ãƒƒãƒ—
      }
    }

    function fetchAndCompareVersion(currentVersion, today) {
      // ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒã‚¹ã‚¿ãƒ¼ä»˜ãURLã§fetch
      var url = VERSION_JSON_URL + '?t=' + Date.now();

      fetch(url)
        .then(function(response) {
          if (!response.ok) throw new Error('HTTP ' + response.status);
          return response.json();
        })
        .then(function(data) {
          // ãƒã‚§ãƒƒã‚¯å®Œäº†ã‚’è¨˜éŒ²
          localStorage.setItem(UPDATE_CHECK_KEY, today);

          var latestVersion = parseInt(data.version, 10);
          console.log('æ›´æ–°ãƒã‚§ãƒƒã‚¯: ç¾åœ¨=' + currentVersion + ', æœ€æ–°=' + latestVersion);

          // æ–°ãƒãƒ¼ã‚¸ãƒ§ãƒ³ãŒã‚ã‚Œã°é€šçŸ¥
          if (latestVersion > currentVersion) {
            showUpdateBanner(data);
          }
        })
        .catch(function(error) {
          console.warn('GitHubã‹ã‚‰ã®fetchã‚¨ãƒ©ãƒ¼:', error);
          // å¤±æ•—ã—ã¦ã‚‚é™ã‹ã«ã‚¹ã‚­ãƒƒãƒ—
        });
    }

    function showUpdateBanner(data) {
      document.getElementById('updateVersion').textContent = 'v' + data.version + ' (' + data.date + ')';
      document.getElementById('updateNote').textContent = data.note || '';
      document.getElementById('updateBanner').classList.add('show');
    }

    function closeUpdateBanner(event) {
      event.stopPropagation();
      document.getElementById('updateBanner').classList.remove('show');
      // ä»Šæ—¥ã¯è¡¨ç¤ºã—ãªã„ã‚ˆã†ã«ã™ã‚‹
      var today = new Date().toISOString().split('T')[0];
      localStorage.setItem(UPDATE_DISMISSED_KEY, today);
    }

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤ºæ™‚ã«æ›´æ–°ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
    checkLibraryUpdate();
  </script>
</body>
</html>
