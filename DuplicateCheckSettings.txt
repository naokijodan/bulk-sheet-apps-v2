<!DOCTYPE html>
<html>
<head>
  <style>
    body { 
      font-family: Arial, sans-serif; 
      padding: 20px; 
      line-height: 1.6;
    }
    .form-group { 
      margin-bottom: 20px; 
    }
    label { 
      display: block; 
      font-weight: bold; 
      margin-bottom: 5px; 
    }
    select, input { 
      width: 100%; 
      padding: 8px; 
      border: 1px solid #ddd; 
      border-radius: 4px; 
      font-size: 14px;
    }
    .error-message {
      background: #ffebee;
      color: #c62828;
      padding: 10px;
      border-radius: 4px;
      margin-bottom: 15px;
      border-left: 4px solid #c62828;
    }
    .manual-input {
      background: #fff3e0;
      padding: 10px;
      border-radius: 4px;
      margin-top: 10px;
    }
    .target-sheets-container {
      border: 1px solid #ddd;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      min-height: 100px;
    }
    .target-sheet-item {
      display: grid;
      grid-template-columns: 1fr 100px 80px;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }
    
    /* ğŸ†• æ–°ã—ã„å‡ºåŠ›è¨­å®šç”¨ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .section {
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 1px solid #ddd;
    }
    .checkbox-group {
      margin: 10px 0;
    }
    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
    }
    .checkbox-label input[type="checkbox"] {
      margin-right: 8px;
      width: auto;
    }
    .output-settings {
      margin-top: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      background: #f9f9f9;
    }
    .input-row {
      display: flex;
      gap: 15px;
      margin-top: 10px;
    }
    .input-group {
      flex: 1;
    }
    
    .buttons { 
      text-align: center; 
      margin-top: 30px;
    }
    .btn { 
      padding: 10px 20px; 
      margin: 0 10px; 
      border: none; 
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 14px;
    }
    .btn-primary { background: #4CAF50; color: white; }
    .btn-secondary { background: #6c757d; color: white; }
    .btn-danger { background: #dc3545; color: white; }
    .help-text { font-size: 12px; color: #666; margin-top: 5px; }
  </style>
</head>
<body>
  <div id="error-container"></div>
  
  <h3>é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š</h3>
  
  <div class="form-group">
    <label for="sourceSheet">ä½œæ¥­ã‚·ãƒ¼ãƒˆï¼ˆé‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹å´ï¼‰:</label>
    <select id="sourceSheet">
      <option value="">èª­ã¿è¾¼ã¿ä¸­...</option>
    </select>
    <div id="manualSheetInput" class="manual-input" style="display: none;">
      <label for="manualSheet">æ‰‹å‹•å…¥åŠ›:</label>
      <input type="text" id="manualSheet" placeholder="ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
      <button onclick="useManualSheet()">ã“ã®åå‰ã‚’ä½¿ç”¨</button>
    </div>
    <div class="help-text">ãƒ‡ãƒ¼ã‚¿å…¥åŠ›æ™‚ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’è¡Œã†ã‚·ãƒ¼ãƒˆã§ã™</div>
  </div>
  
  <div class="form-group">
    <label for="sourceColumn">ä½œæ¥­ã‚·ãƒ¼ãƒˆã®åˆ—:</label>
    <select id="sourceColumn">
      <option value="">åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
      <option value="A">Aåˆ—</option>
      <option value="B">Båˆ—</option>
      <option value="C">Cåˆ—</option>
      <option value="D">Dåˆ—</option>
      <option value="E">Eåˆ—</option>
      <option value="F">Fåˆ—</option>
      <option value="G">Gåˆ—</option>
      <option value="H">Håˆ—</option>
      <option value="I">Iåˆ—</option>
      <option value="J">Jåˆ—</option>
    </select>
  </div>
  
  <div class="form-group">
    <label>ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã‚·ãƒ¼ãƒˆï¼ˆé‡è¤‡å…ƒï¼‰:</label>
    <div id="targetSheetsContainer" class="target-sheets-container">
      <div id="noTargetSheetsMsg">å‚ç…§ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
    </div>
    <button onclick="addTargetSheetDropdown()">å‚ç…§ã‚·ãƒ¼ãƒˆè¿½åŠ </button>
  </div>

  <!-- ğŸ†• å‡ºåŠ›è¨­å®šã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
  <div class="section">
    <h4>ğŸ“¤ å‡ºåŠ›è¨­å®š</h4>
    
    <div class="checkbox-group">
      <label class="checkbox-label">
        <input type="checkbox" id="applyToSheet" name="applyToSheet">
        ç”Ÿæˆã—ãŸå¼ã‚’ã‚·ãƒ¼ãƒˆã«ç›´æ¥é©ç”¨ã™ã‚‹
      </label>
    </div>
    
    <div id="outputSettings" class="output-settings" style="display: none;">
      <div class="form-group">
        <label for="outputSheet">å‡ºåŠ›å…ˆã‚·ãƒ¼ãƒˆ:</label>
        <select id="outputSheet" name="outputSheet">
          <option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>
        </select>
      </div>
      
      <div class="input-row">
        <div class="input-group">
          <label for="outputColumn">å‡ºåŠ›å…ˆåˆ—:</label>
          <select id="outputColumn" name="outputColumn">
            <option value="">åˆ—ã‚’é¸æŠ...</option>
          </select>
        </div>
        
        <div class="input-group">
          <label for="outputStartRow">é–‹å§‹è¡Œ:</label>
          <input type="number" id="outputStartRow" name="outputStartRow" value="1" min="1">
        </div>
      </div>
      
      <div class="form-group">
        <label for="outputRange">é©ç”¨ç¯„å›²:</label>
        <select id="outputRange" name="outputRange">
          <option value="DATA">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ç¯„å›²ã¾ã§</option>
          <option value="CUSTOM">ã‚«ã‚¹ã‚¿ãƒ ç¯„å›²ï¼ˆ100è¡Œï¼‰</option>
          <option value="ALL">ã‚·ãƒ¼ãƒˆå…¨ä½“ï¼ˆ1000è¡Œï¼‰</option>
        </select>
      </div>
      
      <div class="help-text">
        é¸æŠã—ãŸç¯„å›²ã«é‡è¤‡ãƒã‚§ãƒƒã‚¯æ•°å¼ãŒé©ç”¨ã•ã‚Œã¾ã™ã€‚æ—¢å­˜ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã®ã§ã”æ³¨æ„ãã ã•ã„ã€‚
      </div>
    </div>
  </div>
  
  <div class="buttons">
    <button class="btn btn-primary" onclick="saveSettings()">è¨­å®šã‚’ä¿å­˜ãƒ»é©ç”¨</button>
    <button class="btn btn-danger" onclick="disableCheck()">é‡è¤‡ãƒã‚§ãƒƒã‚¯ã‚’ç„¡åŠ¹åŒ–</button>
    <button class="btn btn-secondary" onclick="google.script.host.close()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
  </div>

  <script>
    var allSheetNames = [];
    var targetSheetCounter = 0;
    var loadAttempts = 0;
    var maxLoadAttempts = 3;

    window.onload = function() {
      loadSheetNamesWithRetry();
      setupEventListeners(); // ğŸ†• ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®åˆæœŸè¨­å®š
    };

    // ğŸ†• ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
    function setupEventListeners() {
      var applyCheckbox = document.getElementById('applyToSheet');
      if (applyCheckbox) {
        applyCheckbox.addEventListener('change', function() {
          var outputSettings = document.getElementById('outputSettings');
          outputSettings.style.display = this.checked ? 'block' : 'none';
          
          if (this.checked) {
            loadOutputOptions();
          }
        });
      }
    }

    function showError(message) {
      var container = document.getElementById('error-container');
      container.innerHTML = '<div class="error-message">' + message + '</div>';
    }

    function loadSheetNamesWithRetry() {
      loadAttempts++;
      
      if (loadAttempts > maxLoadAttempts) {
        showError('ã‚·ãƒ¼ãƒˆåã®è‡ªå‹•å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã™ã€‚');
        enableManualMode();
        return;
      }

      console.log('ã‚·ãƒ¼ãƒˆåå–å¾—è©¦è¡Œ ' + loadAttempts + '/' + maxLoadAttempts);
      
      var timeoutId = setTimeout(function() {
        console.log('ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ: å†è©¦è¡Œã—ã¾ã™');
        loadSheetNamesWithRetry();
      }, 5000);

      google.script.run
        .withSuccessHandler(function(sheetNames) {
          clearTimeout(timeoutId);
          console.log('ã‚·ãƒ¼ãƒˆåå–å¾—æˆåŠŸ:', sheetNames);
          allSheetNames = sheetNames;
          populateSourceSheetDropdown();
          loadCurrentSettings();
        })
        .withFailureHandler(function(error) {
          clearTimeout(timeoutId);
          console.error('ã‚·ãƒ¼ãƒˆåå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
          loadSheetNamesWithRetry();
        })
        .getAllSheetNames();
    }

    // ğŸ†• å‡ºåŠ›ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
function loadOutputOptions() {
  // ã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—ï¼ˆã‚¨ãƒ©ãƒ¼å‡¦ç†ä»˜ãï¼‰
  google.script.run
    .withSuccessHandler(function(sheets) {
      var select = document.getElementById('outputSheet');
      if (select) {
        select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
        if (sheets && sheets.length > 0) {
          sheets.forEach(function(sheet) {
            var option = document.createElement('option');
            option.value = sheet;
            option.textContent = sheet;
            select.appendChild(option);
          });
        } else {
          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: allSheetNames ã‚’ä½¿ç”¨
          allSheetNames.forEach(function(sheet) {
            var option = document.createElement('option');
            option.value = sheet;
            option.textContent = sheet;
            select.appendChild(option);
          });
        }
      }
    })
    .withFailureHandler(function(error) {
      console.error('å‡ºåŠ›å…ˆã‚·ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯å‡¦ç†
      var select = document.getElementById('outputSheet');
      if (select && allSheetNames.length > 0) {
        select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>';
        allSheetNames.forEach(function(sheet) {
          var option = document.createElement('option');
          option.value = sheet;
          option.textContent = sheet;
          select.appendChild(option);
        });
      }
    })
    .getOutputAvailableSheets();
    
  // åˆ—ä¸€è¦§ã‚’æ‰‹å‹•ã§è¨­å®šï¼ˆAEåˆ—ã¾ã§å¯¾å¿œï¼‰
  var columnSelect = document.getElementById('outputColumn');
  if (columnSelect) {
    columnSelect.innerHTML = '<option value="">åˆ—ã‚’é¸æŠ...</option>';
    
    // Aï½Zåˆ—ï¼ˆ1ï½26åˆ—ï¼‰
    for (var i = 0; i < 26; i++) {
      var col = String.fromCharCode(65 + i);
      var option = document.createElement('option');
      option.value = col;
      option.textContent = col + 'åˆ—';
      columnSelect.appendChild(option);
    }
    
    // AAï½AZåˆ—ï¼ˆ27ï½52åˆ—ï¼‰
    for (var i = 0; i < 26; i++) {
      var col = 'A' + String.fromCharCode(65 + i);
      var option = document.createElement('option');
      option.value = col;
      option.textContent = col + 'åˆ—';
      columnSelect.appendChild(option);
    }
  }
} // â† ã“ã®é–‰ã˜æ‹¬å¼§ãŒé‡è¦ï¼

    function enableManualMode() {
      var sourceSelect = document.getElementById('sourceSheet');
      sourceSelect.innerHTML = '<option value="">æ‰‹å‹•å…¥åŠ›ãƒ¢ãƒ¼ãƒ‰ãŒæœ‰åŠ¹ã§ã™</option>';
      document.getElementById('manualSheetInput').style.display = 'block';
      
      addTargetSheetDropdown();
    }

    function useManualSheet() {
      var manualSheet = document.getElementById('manualSheet').value.trim();
      if (!manualSheet) {
        alert('ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      var sourceSelect = document.getElementById('sourceSheet');
      sourceSelect.innerHTML = '';
      var option = document.createElement('option');
      option.value = manualSheet;
      option.textContent = manualSheet + ' (æ‰‹å‹•å…¥åŠ›)';
      option.selected = true;
      sourceSelect.appendChild(option);
      
      document.getElementById('manualSheetInput').style.display = 'none';
    }

    function populateSourceSheetDropdown() {
      var sourceSelect = document.getElementById('sourceSheet');
      sourceSelect.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
      
      allSheetNames.forEach(function(name) {
        var option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        sourceSelect.appendChild(option);
      });
    }

    function addTargetSheetDropdown() {
      var container = document.getElementById('targetSheetsContainer');
      var noMsgDiv = document.getElementById('noTargetSheetsMsg');
      if (noMsgDiv) noMsgDiv.style.display = 'none';
      
      targetSheetCounter++;
      var itemDiv = document.createElement('div');
      itemDiv.className = 'target-sheet-item';
      itemDiv.id = 'targetSheet_' + targetSheetCounter;
      
      var sheetDiv = document.createElement('div');
      if (allSheetNames.length > 0) {
        var sheetSelect = document.createElement('select');
        sheetSelect.className = 'target-sheet-select';
        sheetSelect.innerHTML = '<option value="">å‚ç…§ã‚·ãƒ¼ãƒˆã‚’é¸æŠ</option>';
        
        allSheetNames.forEach(function(name) {
          var option = document.createElement('option');
          option.value = name;
          option.textContent = name;
          sheetSelect.appendChild(option);
        });
        
        var specialOption = document.createElement('option');
        specialOption.value = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿_*';
        specialOption.textContent = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿_* (ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ)';
        sheetSelect.appendChild(specialOption);
        
        sheetDiv.appendChild(sheetSelect);
      } else {
        var sheetInput = document.createElement('input');
        sheetInput.type = 'text';
        sheetInput.className = 'target-sheet-input';
        sheetInput.placeholder = 'ã‚·ãƒ¼ãƒˆåã‚’å…¥åŠ›';
        sheetDiv.appendChild(sheetInput);
      }
      
      var columnDiv = document.createElement('div');
      var columnSelect = document.createElement('select');
      columnSelect.className = 'target-column-select';
      columnSelect.innerHTML = '<option value="">åˆ—é¸æŠ</option>';
      ['A','B','C','D','E','F','G','H','I','J'].forEach(function(col) {
        var option = document.createElement('option');
        option.value = col;
        option.textContent = col + 'åˆ—';
        if (col === 'H') option.selected = true;
        columnSelect.appendChild(option);
      });
      columnDiv.appendChild(columnSelect);
      
      var removeBtn = document.createElement('button');
      removeBtn.textContent = 'å‰Šé™¤';
      removeBtn.onclick = function() {
        itemDiv.remove();
        if (container.querySelectorAll('.target-sheet-item').length === 0) {
          if (noMsgDiv) noMsgDiv.style.display = 'block';
        }
      };
      
      itemDiv.appendChild(sheetDiv);
      itemDiv.appendChild(columnDiv);
      itemDiv.appendChild(removeBtn);
      container.appendChild(itemDiv);
    }

    function loadCurrentSettings() {
      google.script.run
        .withSuccessHandler(function(settings) {
          if (settings && settings.sourceSheet) {
            document.getElementById('sourceSheet').value = settings.sourceSheet;
            document.getElementById('sourceColumn').value = settings.sourceColumn;
          }
        })
        .withFailureHandler(function(error) {
          console.error('è¨­å®šèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getDuplicateCheckSettings();
    }

    function saveSettings() {
      var sourceSheet = document.getElementById('sourceSheet').value;
      var sourceColumn = document.getElementById('sourceColumn').value;
      
      var targetSheets = [];
      var targetItems = document.querySelectorAll('.target-sheet-item');
      
      targetItems.forEach(function(item) {
        var sheetSelect = item.querySelector('.target-sheet-select');
        var columnSelect = item.querySelector('.target-column-select');
        
        if (sheetSelect && sheetSelect.value && columnSelect && columnSelect.value) {
          targetSheets.push({
            sheet: sheetSelect.value,
            column: columnSelect.value
          });
        }
      });
      
      if (!sourceSheet || !sourceColumn || targetSheets.length === 0) {
        alert('ã™ã¹ã¦ã®é …ç›®ã‚’è¨­å®šã—ã¦ãã ã•ã„ã€‚');
        return;
      }
      
      // ğŸ†• å‡ºåŠ›è¨­å®šã‚’å«ã‚ã‚‹ã‚ˆã†ã«ä¿®æ­£
      var formData = {
        sourceSheet: sourceSheet,
        sourceColumn: sourceColumn,
        targetSheets: targetSheets
      };
      
      var applyCheckbox = document.getElementById('applyToSheet');
      if (applyCheckbox && applyCheckbox.checked) {
        formData.outputSheet = document.getElementById('outputSheet').value;
        formData.outputColumn = document.getElementById('outputColumn').value;
        formData.outputStartRow = document.getElementById('outputStartRow').value;
        formData.outputRange = document.getElementById('outputRange').value;
      }
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            if (result.applied) {
              alert('é‡è¤‡ãƒã‚§ãƒƒã‚¯å¼ã‚’ç”Ÿæˆã—ã€' + result.appliedRange + 'ã«é©ç”¨ã—ã¾ã—ãŸï¼ˆ' + result.appliedCount + 'è¡Œï¼‰ã€‚');
              google.script.host.close();
            } else if (result.formula) {
              // å¾“æ¥é€šã‚Šã®è¡¨ç¤º
              document.body.innerHTML += `
                <div style="margin-top: 20px; padding: 15px; border: 2px solid #28a745; background: #f8f9fa;">
                  <h4>ç”Ÿæˆã•ã‚ŒãŸé–¢æ•°</h4>
                  <p>ä»¥ä¸‹ã®é–¢æ•°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ã€${sourceSheet}ã®éš£ã®åˆ—ï¼ˆä¾‹ï¼šIåˆ—ï¼‰ã«è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„ï¼š</p>
                  <textarea id="generatedFormula" style="width: 100%; height: 80px; font-family: monospace; font-size: 14px;" readonly>${result.formula}</textarea>
                  <br><br>
                  <button onclick="copyFormula()" style="padding: 8px 16px; background: #007bff; color: white; border: none; border-radius: 4px;">é–¢æ•°ã‚’ã‚³ãƒ”ãƒ¼</button>
                  <button onclick="google.script.host.close()" style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 4px; margin-left: 10px;">é–‰ã˜ã‚‹</button>
                </div>
              `;
              
              var textarea = document.getElementById('generatedFormula');
              textarea.focus();
              textarea.select();
            } else {
              alert(result.message);
              google.script.host.close();
            }
          } else {
            alert('ã‚¨ãƒ©ãƒ¼: ' + result.error);
          }
        })
        .withFailureHandler(function(error) {
          alert('ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
        })
        .saveDuplicateCheckSettings(formData);
    }

    function copyFormula() {
      var textarea = document.getElementById('generatedFormula');
      textarea.select();
      document.execCommand('copy');
      alert('é–¢æ•°ã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
    }

    function disableCheck() {
      if (confirm('é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã™ã‹ï¼Ÿ')) {
        google.script.run
          .withSuccessHandler(function() {
            alert('é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–ã—ã¾ã—ãŸã€‚');
            google.script.host.close();
          })
          .disableDuplicateCheck();
      }
    }
  </script>
</body>
</html>