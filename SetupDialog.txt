<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>åˆæœŸè¨­å®šï¼ˆçµ±åˆç‰ˆï¼‰</title>
  <style>
    :root {
      --brand: #1a73e8;
      --brand-600: #1557b0;
      --text: #3c4043;
      --muted: #5f6368;
      --line: #e0e0e0;
      --bg: #f9f9f9;
      --card: #fff;
      --required: #dc2626;
      --recommended: #16a34a;
      --optional: #2563eb;
    }

    * { box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: var(--bg);
      color: var(--text);
      max-height: 80vh;
      overflow-y: auto;
    }

    .container {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    h2 {
      color: var(--brand);
      margin-bottom: 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚¹ã‚¿ã‚¤ãƒ« */
    .section {
      margin-bottom: 16px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      overflow: hidden;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: #fafbfc;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
      user-select: none;
    }

    .section-header:hover {
      background: #f1f3f4;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 16px;
    }

    .priority-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      color: white;
    }

    .priority-required { background-color: var(--required); }
    .priority-recommended { background-color: var(--recommended); }
    .priority-optional { background-color: var(--optional); }

    .section-description {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }

    .section-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .edit-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .edit-toggle input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .collapse-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .collapse-btn.collapsed {
      transform: rotate(-90deg);
    }

    .section-content {
      padding: 20px;
      display: none;
    }

    .section-content.expanded {
      display: block;
    }

    /* ãƒ•ã‚©ãƒ¼ãƒ è¦ç´  */
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 6px;
      font-weight: 600;
      color: #2b2f33;
    }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      transition: box-shadow .15s ease, border-color .15s ease;
      background: #fff;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(26,115,232,.18);
    }

    .radio-group {
      margin: 8px 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .radio-group label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      font-weight: 500;
      color: #333;
      cursor: pointer;
    }

    .radio-group input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .checkbox-group {
      margin: 10px 0;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .checkbox-label input[type="checkbox"] {
      margin-right: 8px;
      width: auto;
      transform: scale(1.1);
    }

    /* ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ– */
    .api-platform-section {
      background-color: #fafafa;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-top: 10px;
    }

    .platform-tabs {
      display: flex;
      margin-bottom: 14px;
      border-bottom: 1px solid var(--line);
      gap: 2px;
    }

    .platform-tab {
      padding: 8px 14px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      border-bottom: 2px solid transparent;
      border-radius: 8px 8px 0 0;
      transition: background .15s ease, color .15s ease, border-color .15s ease;
    }

    .platform-tab:hover { background-color: #f1f3f4; }

    .platform-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
      font-weight: 700;
      background: #eef4ff;
    }

    .platform-content { display: none; }
    .platform-content.active { display: block; }

    /* é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š */
    .target-sheets-container {
      border: 1px solid #ddd;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      min-height: 100px;
      margin-top: 10px;
    }

    .target-sheet-item {
      display: grid;
      grid-template-columns: 1fr 100px 80px;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .input-row {
      display: flex;
      gap: 20px;
      margin: 15px 0;
    }

    .input-group {
      flex: 1;
    }

    .input-group label {
      margin-top: 0;
      font-size: 13px;
    }

    /* æƒ…å ±ãƒœãƒƒã‚¯ã‚¹ */
    .info-box, .warning-box {
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
    }

    .info-box {
      background-color: #e8f0fe;
      border: 1px solid #dadce0;
    }

    .warning-box {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
    }

    .info-box .title, .warning-box .title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .info-box .title {
      color: var(--brand);
    }

    .warning-box .title {
      color: #856404;
    }

    .info-box .content, .warning-box .content {
      font-size: 12px;
      line-height: 1.6;
    }

    .info-box .content {
      color: var(--muted);
    }

    .warning-box .content {
      color: #856404;
    }

    .help-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .cost-info {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin-top: 6px;
    }

    /* ãƒœã‚¿ãƒ³ */
    .button-group {
      margin-top: 26px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn {
      position: relative;
      overflow: hidden;
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      transition: transform .06s ease, box-shadow .2s ease, background-color .2s ease;
      user-select: none;
    }

    .btn:active { transform: translateY(0.5px) scale(.99); }

    .btn.primary {
      background-color: var(--brand);
      color: #fff;
      box-shadow: 0 6px 16px rgba(26,115,232,.25);
    }

    .btn.primary:hover { background-color: var(--brand-600); }

    .btn.secondary {
      background-color: #edf2f7;
      color: var(--text);
    }

    .btn.secondary:hover { background: #e2e8f0; }

    .btn:disabled {
      opacity: .65;
      cursor: not-allowed;
      box-shadow: none;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.55);
      border-top-color: #fff;
      animation: spin .8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .disabled-overlay {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>åˆæœŸè¨­å®šï¼ˆçµ±åˆç‰ˆï¼‰</h2>

    <form id="setupForm">
      <!-- 1. AIãƒ»åŸºæœ¬è¨­å®š -->
      <div class="section" data-section="ai-basic">
        <div class="section-header" onclick="toggleSection('ai-basic')">
          <div class="section-title">
            <span class="priority-badge priority-required">å¿…é ˆ</span>
            <div>
              <div>AIãƒ»åŸºæœ¬è¨­å®š</div>
              <div class="section-description">AIã‚µãƒ¼ãƒ“ã‚¹ã¨ä½œæ¥­ã‚·ãƒ¼ãƒˆã®åŸºæœ¬çš„ãªè¨­å®š</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-ai-basic" value="maintain" checked> ç¶­æŒ</label>
              <label><input type="radio" name="edit-ai-basic" value="edit"> ç·¨é›†</label>
            </div>
            <button type="button" class="collapse-btn">â–¼</button>
          </div>
        </div>
        <div class="section-content" id="content-ai-basic">
          <label>AI ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ é¸æŠ *</label>
          <div class="api-platform-section">
            <div class="platform-tabs" id="platformTabs">
              <button type="button" class="platform-tab" data-platform="openai">OpenAI</button>
              <button type="button" class="platform-tab" data-platform="claude">Claude</button>
              <button type="button" class="platform-tab" data-platform="gemini">Gemini</button>
            </div>

            <div class="platform-content" id="openai-content">
              <label for="openaiApiKey">OpenAI APIã‚­ãƒ¼ *</label>
              <input type="text" id="openaiApiKey" name="openaiApiKey" value="<?= currentApiKeys.openai || '' ?>" placeholder="sk-...">
              <div class="help-text">OpenAIã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

              <label for="openaiModel">ãƒ¢ãƒ‡ãƒ«é¸æŠ *</label>
              <select id="openaiModel" name="openaiModel">
                <option value="gpt-5-nano" <?= (currentModel === 'gpt-5-nano' || !currentModel) ? 'selected' : '' ?>>GPT-5-nanoï¼ˆæœ€å®‰ãƒ»æ¨å¥¨ï¼‰</option>
                <option value="gpt-4o-mini" <?= currentModel === 'gpt-4o-mini' ? 'selected' : '' ?>>GPT-4o-miniï¼ˆäº’æ›ãƒ»ä½ã‚³ã‚¹ãƒˆï¼‰</option>
                <option value="gpt-5-mini" <?= currentModel === 'gpt-5-mini' ? 'selected' : '' ?>>GPT-5-miniï¼ˆã‚„ã‚„é«˜å“è³ªï¼‰</option>
              </select>
              <div class="cost-info">ç›®å®‰: GPT-5-nano â‰ˆ ~$0.0003â€“0.0004 / 1K tokens</div>
            </div>

            <div class="platform-content" id="claude-content">
              <label for="claudeApiKey">Claude APIã‚­ãƒ¼ *</label>
              <input type="text" id="claudeApiKey" name="claudeApiKey" value="<?= currentApiKeys.claude || '' ?>" placeholder="sk-ant-...">
              <div class="help-text">Anthropicã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

              <label for="claudeModel">ãƒ¢ãƒ‡ãƒ«é¸æŠ *</label>
              <select id="claudeModel" name="claudeModel">
                <option value="claude-3-haiku-20240307" <?= currentModel === 'claude-3-haiku-20240307' ? 'selected' : '' ?>>Claude 3 Haikuï¼ˆæœ€å®‰ãƒ»æ¨å¥¨ï¼‰</option>
                <option value="claude-3-sonnet-20240229" <?= currentModel === 'claude-3-sonnet-20240229' ? 'selected' : '' ?>>Claude 3 Sonnetï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰</option>
                <option value="claude-3-opus-20240229" <?= currentModel === 'claude-3-opus-20240229' ? 'selected' : '' ?>>Claude 3 Opusï¼ˆé«˜æ€§èƒ½ï¼‰</option>
              </select>
              <div class="cost-info">å‚è€ƒ: Haiku â‰ˆ ~$0.0015 / 1K tokens ã»ã‹</div>
            </div>

            <div class="platform-content" id="gemini-content">
              <label for="geminiApiKey">Gemini APIã‚­ãƒ¼ *</label>
              <input type="text" id="geminiApiKey" name="geminiApiKey" value="<?= currentApiKeys.gemini || '' ?>" placeholder="AIza...">
              <div class="help-text">Google AI Studioã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„</div>

              <label for="geminiModel">ãƒ¢ãƒ‡ãƒ«é¸æŠ *</label>
              <select id="geminiModel" name="geminiModel">
                <option value="gemini-1.5-flash" <?= currentModel === 'gemini-1.5-flash' ? 'selected' : '' ?>>Gemini 1.5 Flashï¼ˆæœ€å®‰ãƒ»æ¨å¥¨ï¼‰</option>
                <option value="gemini-1.5-pro" <?= currentModel === 'gemini-1.5-pro' ? 'selected' : '' ?>>Gemini 1.5 Proï¼ˆãƒãƒ©ãƒ³ã‚¹ï¼‰</option>
                <option value="gemini-pro" <?= currentModel === 'gemini-pro' ? 'selected' : '' ?>>Gemini Proï¼ˆå®‰å®šï¼‰</option>
              </select>
              <div class="cost-info">å‚è€ƒ: Flash â‰ˆ ~$0.0008 / 1K tokens ã»ã‹</div>
            </div>
          </div>

          <label for="sheetName">ä½œæ¥­ã‚·ãƒ¼ãƒˆå *</label>
          <input type="text" id="sheetName" name="sheetName" value="<?= currentSheetName ?>" required>
          <div class="help-text">ãƒ‡ãƒ¼ã‚¿å‡¦ç†ã‚’è¡Œã†ã‚·ãƒ¼ãƒˆã®åå‰</div>

          <div class="info-box">
            <div class="title">ã‚³ã‚¹ãƒˆæ¯”è¼ƒã®ç›®å®‰ï¼ˆ1K tokensï¼‰</div>
            <div class="content">
              æœ€å®‰: GPT-5-nano â‰² GPT-5-mini â‰² Gemini 1.5 Flash â‰² Claude 3 Haiku<br>
              é«˜æ€§èƒ½: Claude 3 Opus / GPT-5-mini / GPT-4ç³» / Gemini 1.5 Proï¼ˆç”¨é€”æ¬¡ç¬¬ï¼‰<br>
              ã¾ãšã¯ GPT-5-nano ã‚’ãŠè©¦ã—ãã ã•ã„ï¼ˆæ¨å¥¨ï¼‰
            </div>
          </div>
        </div>
      </div>

      <!-- 2. ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š -->
      <div class="section" data-section="prompt">
        <div class="section-header" onclick="toggleSection('prompt')">
          <div class="section-title">
            <span class="priority-badge priority-recommended">æ¨å¥¨</span>
            <div>
              <div>ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</div>
              <div class="section-description">AIç”Ÿæˆã®å“è³ªã‚’æ±ºå®šã™ã‚‹ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-prompt" value="maintain" checked> ç¶­æŒ</label>
              <label><input type="radio" name="edit-prompt" value="edit"> ç·¨é›†</label>
            </div>
            <button type="button" class="collapse-btn">â–¼</button>
          </div>
        </div>
        <div class="section-content" id="content-prompt">
          <label for="promptId">ä½¿ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ *</label>
          <select id="promptId" name="promptId" required>
            <? for (var i = 0; i < promptIds.length; i++) { ?>
              <option value="<?= promptIds[i] ?>" <?= promptIds[i] === currentPromptId ? 'selected' : '' ?>>
                <?= promptIds[i] ?>
              </option>
            <? } ?>
          </select>
          <div class="help-text">GPT_Prompts ã‚·ãƒ¼ãƒˆã‹ã‚‰é¸æŠ</div>

          <div class="info-box">
            <div class="title">ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†</div>
            <div class="content">
              ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®å†…å®¹ã¯ã€Œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†ã€ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§å¤‰æ›´ã§ãã¾ã™ã€‚<br>
              ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒAIç¿»è¨³ãƒ»ä¾¡æ ¼è¨ˆç®—ã€â†’ã€Œãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†ã€ã‹ã‚‰é–‹ã‘ã¾ã™ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- 3. åˆ©ç›Šãƒ»ä¾¡æ ¼è¨ˆç®— -->
      <div class="section" data-section="price-calc">
        <div class="section-header" onclick="toggleSection('price-calc')">
          <div class="section-title">
            <span class="priority-badge priority-required">å¿…é ˆ</span>
            <div>
              <div>åˆ©ç›Šãƒ»ä¾¡æ ¼è¨ˆç®—</div>
              <div class="section-description">åˆ©ç›Šè¨ˆç®—ã¨ä¾¡æ ¼è¡¨ç¤ºã®è¨­å®š</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-price-calc" value="maintain" checked> ç¶­æŒ</label>
              <label><input type="radio" name="edit-price-calc" value="edit"> ç·¨é›†</label>
            </div>
            <button type="button" class="collapse-btn">â–¼</button>
          </div>
        </div>
        <div class="section-content" id="content-price-calc">
          <label>åˆ©ç›Šè¨ˆç®—æ–¹æ³• *</label>
          <div class="radio-group">
            <label><input type="radio" name="profitMethod" value="RATE" <?= currentProfitCalculationMethod === 'RATE' ? 'checked' : '' ?>> åˆ©ç›Šç‡ã§è¨ˆç®—</label>
            <label><input type="radio" name="profitMethod" value="AMOUNT" <?= currentProfitCalculationMethod === 'AMOUNT' ? 'checked' : '' ?>> åˆ©ç›Šé¡ã§è¨ˆç®—</label>
          </div>

          <label>ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ *</label>
          <div class="radio-group">
            <label><input type="radio" name="priceDisplayMode" value="NORMAL" <?= (currentPriceDisplayMode === 'NORMAL' || !currentPriceDisplayMode) ? 'checked' : '' ?>> è²©å£²ä¾¡æ ¼ï¼ˆDDUï¼‰</label>
            <label><input type="radio" name="priceDisplayMode" value="TAX_INCLUDED" <?= currentPriceDisplayMode === 'TAX_INCLUDED' ? 'checked' : '' ?>> é–¢ç¨è¾¼ã¿ä¾¡æ ¼ï¼ˆDDPï¼‰</label>
          </div>

          <label>DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
 <input type="checkbox" id="dduAdjustmentEnabled" name="dduAdjustmentEnabled" checked>
  DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹
</label>
          </div>
          

          <div id="dduSettingsGroup">
            <div class="input-row">
              <div class="input-group">
                <label for="dduThreshold">DDUé–¾å€¤ï¼ˆãƒ‰ãƒ«ï¼‰:</label>
                <input type="number" id="dduThreshold" name="dduThreshold" 
                       value="<?= currentDduThreshold ?>" min="1" step="1">
              </div>
              <div class="input-group">
                <label for="dduAdjustment">èª¿æ•´é¡ï¼ˆãƒ‰ãƒ«ï¼‰:</label>
                <input type="number" id="dduAdjustment" name="dduAdjustment" 
                       value="<?= currentDduAdjustment ?>" min="1" step="1">
              </div>
            </div>
            <div class="help-text">
              DDUä¾¡æ ¼ï¼ˆQåˆ—ï¼‰ãŒé–¾å€¤ä»¥ä¸Šã®å•†å“ã§ã€DDPä¾¡æ ¼ï¼ˆRåˆ—ï¼‰ã‹ã‚‰èª¿æ•´é¡ã‚’å¼•ã„ãŸä¾¡æ ¼ã‚’è¨ˆç®—ã—ã¾ã™
            </div>
          </div>

          <div class="info-box">
            <div class="title">ä¾¡æ ¼è¨ˆç®—ã®è¨­å®šç®‡æ‰€</div>
            <div class="content">
              â€¢ æ‰‹æ•°æ–™ç‡: F1 / åºƒå‘Šè²»ç‡: F2<br>
              â€¢ åˆ©ç›Šé¡: H1ï¼ˆåˆ©ç›Šé¡è¨ˆç®—é¸æŠæ™‚ï¼‰<br>
              â€¢ åˆ©ç›Šç‡: H2ï¼ˆåˆ©ç›Šç‡è¨ˆç®—é¸æŠæ™‚ï¼‰
            </div>
          </div>

          <div class="warning-box">
            <div class="title">DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã®æ³¨æ„äº‹é …</div>
            <div class="content">
              ã“ã®æ©Ÿèƒ½ã¯DDUå•†å“å°‚ç”¨ã§ã™ã€‚DDPã§å‡ºå“ã™ã‚‹å ´åˆã§ã‚‚ã€å®Ÿéš›ã®è²©å£²ä¾¡æ ¼ã¯DDUä¾¡æ ¼ã‚’ä½¿ç”¨ã—ã€é–¢ç¨åˆ†ã‚’é€æ–™ã¨ã—ã¦åˆ¥é€”å¾´åã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ¢ãƒ‡ãƒ«å‘ã‘ã§ã™ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- DDUé–¾å€¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼ -->
      <div class="form-section" style="background: #f8f9fa; padding: 15px; border-radius: 4px; margin-top: 15px;">
        <h3 style="margin-top: 0; color: #666;">ğŸ“Š DDUé–¾å€¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆç¢ºèªç”¨ï¼‰</h3>
        <p style="color: #666; font-size: 13px; margin-bottom: 15px;">
          é–¢ç¨ç‡ã«ã‚ˆã‚‹å®ŸåŠ¹é–¾å€¤ã‚’ç¢ºèªã§ãã¾ã™ã€‚<br>
          â€»ã“ã®å€¤ã¯ä¿å­˜ã•ã‚Œã¾ã›ã‚“ã€‚å®Ÿéš›ã®åˆ¤å®šã¯AD2ã‚»ãƒ«ã®é–¢ç¨ç‡ã‚’ä½¿ç”¨ã—ã¾ã™ã€‚
        </p>
        
        <div style="display: flex; gap: 10px; align-items: center; margin-bottom: 10px;">
          <label style="min-width: 150px;">ç¢ºèªã—ãŸã„é–¢ç¨ç‡:</label>
          <input type="number" id="simulateRate" min="0" max="100" step="0.1" 
                 placeholder="ä¾‹: 39" style="width: 100px;">
          <span>%</span>
          <button type="button" onclick="simulateThreshold()" 
                  style="padding: 5px 15px; background: #4285f4; color: white; border: none; border-radius: 3px; cursor: pointer;">
            è¨ˆç®—
          </button>
        </div>
        
        <div id="simulateResult" style="display: none; background: white; padding: 12px; border-radius: 4px; border-left: 4px solid #4285f4;">
          <strong>ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³çµæœ:</strong><br>
          <div style="margin-top: 8px; line-height: 1.8;">
            â€¢ åŸºæº–ï¼ˆ15%ï¼‰: $<span id="baseThresholdDisplay">1500</span><br>
            â€¢ å…¥åŠ›ã—ãŸé–¢ç¨ç‡ï¼ˆ<span id="simRateDisplay"></span>%ï¼‰: ç´„$<span id="simThreshold"></span><br>
            â€¢ å·®: $<span id="simDiff"></span> <span style="color: #666; font-size: 12px;">(é–¢ç¨ç‡ãŒé«˜ã„ã¨æ—©ãç™ºå‹•)</span>
          </div>
        </div>
      </div>

      <!-- 4. é€æ–™ãƒ»é…é€è¨­å®š -->
      <div class="section" data-section="shipping">
        <div class="section-header" onclick="toggleSection('shipping')">
          <div class="section-title">
            <span class="priority-badge priority-required">å¿…é ˆ</span>
            <div>
              <div>é€æ–™ãƒ»é…é€è¨­å®š</div>
              <div class="section-description">é€æ–™è¨ˆç®—ã¨é…é€æ–¹æ³•ã®è¨­å®š</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-shipping" value="maintain" checked> ç¶­æŒ</label>
              <label><input type="radio" name="edit-shipping" value="edit"> ç·¨é›†</label>
            </div>
            <button type="button" class="collapse-btn">â–¼</button>
          </div>
        </div>
        <div class="section-content" id="content-shipping">
          <label>é€æ–™è¨ˆç®—æ–¹æ³• *</label>
          <div class="radio-group">
            <label><input type="radio" name="shippingCalcMethod" value="TABLE" <?= currentShippingCalculationMethod === 'TABLE' ? 'checked' : '' ?>> ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—</label>
            <label><input type="radio" name="shippingCalcMethod" value="FIXED" <?= currentShippingCalculationMethod === 'FIXED' ? 'checked' : '' ?>> å›ºå®šé‡‘é¡</label>
          </div>

          <label for="shippingThreshold">é€æ–™è¨ˆç®—åˆ‡æ›¿åŸºæº–é‡‘é¡ï¼ˆå††ï¼‰ *</label>
          <input type="number" id="shippingThreshold" name="shippingThreshold" value="<?= currentShippingThreshold ?>" min="1" step="1" required>
          <div class="help-text">ã“ã®é‡‘é¡ä»¥ä¸Šã¯é«˜ä¾¡æ ¼é…é€ã€æœªæº€ã®å ´åˆã¯ä½ä¾¡æ ¼é…é€ã‚’ä½¿ç”¨</div>

          <label for="lowPriceMethod">ä½ä¾¡æ ¼å•†å“é…é€æ–¹æ³• *</label>
          <select id="lowPriceMethod" name="lowPriceMethod" required>
            <? Object.keys(lowPriceOptions).forEach(function(key) { ?>
              <option value="<?= key ?>" <?= currentLowPriceMethod === key ? 'selected' : '' ?>>
                <?= lowPriceOptions[key].displayName ?>
              </option>
            <? }); ?>
          </select>

          <label for="highPriceMethod">é«˜ä¾¡æ ¼å•†å“é…é€æ–¹æ³• *</label>
          <select id="highPriceMethod" name="highPriceMethod" required>
            <? Object.keys(highPriceOptions).forEach(function(key) { ?>
              <option value="<?= key ?>" <?= currentHighPriceMethod === key ? 'selected' : '' ?>>
                <?= highPriceOptions[key].displayName ?>
              </option>
            <? }); ?>
          </select>

          <div class="info-box">
            <div class="title">é€æ–™è¨ˆç®—æ–¹æ³•ã®èª¬æ˜</div>
            <div class="content">
              <strong>ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—</strong>: é‡é‡ãƒ»ã‚µã‚¤ã‚ºã«åŸºã¥ã„ã¦è‡ªå‹•è¨ˆç®—ï¼ˆæ¨å¥¨ï¼‰<br>
              <strong>å›ºå®šé‡‘é¡</strong>: J1 ã¾ãŸã¯ Profit_Amounts!D ã‹ã‚‰å–å¾—<br><br>
              <strong>å›ºå®šé‡‘é¡ã®è¨­å®š</strong><br>
              â€¢ å…¨å•†å“å…±é€š: J1 ã‚»ãƒ«ã«é‡‘é¡ã‚’å…¥åŠ›<br>
              â€¢ ä»•å…¥ã‚Œå€¤åˆ¥: Profit_Amounts!Dåˆ—ã«å„é‡‘é¡å¸¯ã®é€æ–™
            </div>
          </div>
        </div>
      </div>

      <!-- 5. é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š -->
      <div class="section" data-section="duplicate-check">
        <div class="section-header" onclick="toggleSection('duplicate-check')">
          <div class="section-title">
            <span class="priority-badge priority-optional">ä»»æ„</span>
            <div>
              <div>é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š</div>
              <div class="section-description">å•†å“ã®é‡è¤‡ã‚’è‡ªå‹•æ¤œå‡ºã™ã‚‹æ©Ÿèƒ½</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-duplicate-check" value="maintain" checked> ç¶­æŒ</label>
              <label><input type="radio" name="edit-duplicate-check" value="edit"> ç·¨é›†</label>
            </div>
            <button type="button" class="collapse-btn">â–¼</button>
          </div>
        </div>
        <div class="section-content" id="content-duplicate-check">
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="duplicateCheckEnabled" name="duplicateCheckEnabled" 
                     <?= currentDuplicateCheckEnabled === 'true' ? 'checked' : '' ?>>
              é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹
            </label>
          </div>

          <div id="duplicateCheckSettings">
            <label for="duplicateSourceSheet">ä½œæ¥­ã‚·ãƒ¼ãƒˆï¼ˆé‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯ã•ã‚Œã‚‹å´ï¼‰:</label>
            <select id="duplicateSourceSheet" name="duplicateSourceSheet">
              <option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>
            </select>

            <label for="duplicateSourceColumn">ä½œæ¥­ã‚·ãƒ¼ãƒˆã®åˆ—:</label>
            <select id="duplicateSourceColumn" name="duplicateSourceColumn">
              <option value="">åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„</option>
              <option value="A">Aåˆ—</option>
              <option value="B">Båˆ—</option>
              <option value="C">Cåˆ—</option>
              <option value="D">Dåˆ—</option>
              <option value="E">Eåˆ—</option>
              <option value="F">Fåˆ—</option>
              <option value="G">Gåˆ—</option>
              <option value="H">Håˆ—</option>
              <option value="I">Iåˆ—</option>
              <option value="J">Jåˆ—</option>
            </select>

            <label>ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã‚·ãƒ¼ãƒˆï¼ˆé‡è¤‡å…ƒï¼‰:</label>
            <div id="targetSheetsContainer" class="target-sheets-container">
              <div id="noTargetSheetsMsg">å‚ç…§ã‚·ãƒ¼ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>
            </div>
            <button type="button" onclick="addTargetSheetDropdown()">å‚ç…§ã‚·ãƒ¼ãƒˆè¿½åŠ </button>

            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="applyToSheet" name="applyToSheet">
                ç”Ÿæˆã—ãŸå¼ã‚’ã‚·ãƒ¼ãƒˆã«ç›´æ¥é©ç”¨ã™ã‚‹
              </label>
            </div>

            <div id="outputSettings" style="display: none;">
              <label for="outputSheet">å‡ºåŠ›å…ˆã‚·ãƒ¼ãƒˆ:</label>
              <select id="outputSheet" name="outputSheet">
                <option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠ...</option>
              </select>

              <div class="input-row">
                <div class="input-group">
                  <label for="outputColumn">å‡ºåŠ›å…ˆåˆ—:</label>
                  <select id="outputColumn" name="outputColumn">
                    <option value="">åˆ—ã‚’é¸æŠ...</option>
                  </select>
                </div>
                <div class="input-group">
                  <label for="outputStartRow">é–‹å§‹è¡Œ:</label>
                  <input type="number" id="outputStartRow" name="outputStartRow" value="1" min="1">
                </div>
              </div>

              <label for="outputRange">é©ç”¨ç¯„å›²:</label>
              <select id="outputRange" name="outputRange">
                <option value="DATA">ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ç¯„å›²ã¾ã§</option>
                <option value="CUSTOM">ã‚«ã‚¹ã‚¿ãƒ ç¯„å›²ï¼ˆ100è¡Œï¼‰</option>
                <option value="ALL">ã‚·ãƒ¼ãƒˆå…¨ä½“ï¼ˆ1000è¡Œï¼‰</option>
              </select>
            </div>
          </div>

          <div class="info-box">
            <div class="title">é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ã«ã¤ã„ã¦</div>
            <div class="content">
              ä½œæ¥­ã‚·ãƒ¼ãƒˆã§ã®å…¥åŠ›æ™‚ã«ã€æ—¢å­˜ã®ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã¨é‡è¤‡ã™ã‚‹å•†å“ã‚’è‡ªå‹•æ¤œå‡ºã—ã¾ã™ã€‚<br>
              ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒï¼ˆä¿å­˜ãƒ‡ãƒ¼ã‚¿_*ï¼‰ã‚‚ä½¿ç”¨å¯èƒ½ã§ã™ã€‚
            </div>
          </div>
        </div>
      </div>

      <!-- 6. è¡¨ç¤ºè¨­å®š -->
      <div class="section" data-section="display">
        <div class="section-header" onclick="toggleSection('display')">
          <div class="section-title">
            <span class="priority-badge priority-optional">ä»»æ„</span>
            <div>
              <div>è¡¨ç¤ºè¨­å®š</div>
              <div class="section-description">ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ã«é–¢ã™ã‚‹è¨­å®š</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-display" value="maintain" checked> ç¶­æŒ</label>
              <label><input type="radio" name="edit-display" value="edit"> ç·¨é›†</label>
            </div>
            <button type="button" class="collapse-btn">â–¼</button>
          </div>
        </div>
        <div class="section-content" id="content-display">
          <label>ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºè¨­å®š *</label>
          <div class="radio-group">
            <label><input type="radio" name="showPopups" value="true" <?= currentShowPopups === 'true' ? 'checked' : '' ?>> ONï¼ˆè¡¨ç¤ºã™ã‚‹ï¼‰</label>
            <label><input type="radio" name="showPopups" value="false" <?= (currentShowPopups === 'false' || !currentShowPopups) ? 'checked' : '' ?>> OFFï¼ˆè¡¨ç¤ºã—ãªã„ï¼‰</label>
          </div>
          <div class="help-text">ä½œæ¥­é–‹å§‹ãƒ»å®Œäº†æ™‚ã®ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºã‚’åˆ¶å¾¡ï¼ˆã‚¨ãƒ©ãƒ¼ã¯å¸¸ã«è¡¨ç¤ºï¼‰</div>

          <div class="info-box">
            <div class="title">ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºã®èª¬æ˜</div>
            <div class="content">
              â€¢ ON: ä½œæ¥­é–‹å§‹æ™‚ã«ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã€å®Œäº†æ™‚ã«çµæœè¡¨ç¤º<br>
              â€¢ OFF: ç¢ºèªãªã—ã§å³åº§ã«å®Ÿè¡Œé–‹å§‹ã€å®Œäº†æ™‚ã‚‚ç„¡é€šçŸ¥<br>
              â€¢ ã‚¨ãƒ©ãƒ¼: è¨­å®šã«é–¢ä¿‚ãªãå¸¸ã«è¡¨ç¤ºï¼ˆå®‰å…¨ã®ãŸã‚ï¼‰<br>
              â€¢ ä½œæ¥­åˆ¶å¾¡: D2ã‚»ãƒ«ï¼ˆGO/STOPï¼‰ã§ã®åœæ­¢ã¯åˆ¥æ©Ÿèƒ½
            </div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn secondary" id="cancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button type="submit" class="btn primary" id="saveBtn">
          <span class="btn-label">ä¿å­˜</span>
        </button>
      </div>
    </form>
  </div>

  <script>
    // åˆæœŸè¨­å®š
    const CURRENT_PLATFORM = "<?= typeof currentPlatform !== 'undefined' ? currentPlatform : 'openai' ?>";
    const DEFAULT_OPENAI_MODEL = "gpt-5-nano";
    
    var allSheetNames = [];
    var targetSheetCounter = 0;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      initializeSections();
      initializePlatformTabs();
      loadSheetNames();
      setupEventListeners();
      updateSectionStates();
    });

    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ç®¡ç†
    function toggleSection(sectionId) {
      const content = document.getElementById('content-' + sectionId);
      const btn = document.querySelector(`[data-section="${sectionId}"] .collapse-btn`);
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        btn.classList.add('collapsed');
      } else {
        content.classList.add('expanded');
        btn.classList.remove('collapsed');
      }
    }

    function initializeSections() {
      // å¿…é ˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯åˆæœŸå±•é–‹
      const requiredSections = ['ai-basic', 'price-calc', 'shipping'];
      requiredSections.forEach(sectionId => {
        const content = document.getElementById('content-' + sectionId);
        content.classList.add('expanded');
      });
    }

    function updateSectionStates() {
      document.querySelectorAll('[name^="edit-"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const sectionId = this.name.replace('edit-', '');
          const content = document.getElementById('content-' + sectionId);
          const isEdit = this.value === 'edit';
          
          if (isEdit) {
            content.classList.remove('disabled-overlay');
          } else {
            content.classList.add('disabled-overlay');
          }
        });
      });
    }

    // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚¿ãƒ–
    function initializePlatformTabs() {
      const tabs = document.querySelectorAll('.platform-tab');
      const contents = {
        openai: document.getElementById('openai-content'),
        claude: document.getElementById('claude-content'),
        gemini: document.getElementById('gemini-content')
      };

      function activatePlatform(platform) {
        tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.platform === platform));
        Object.keys(contents).forEach(key => contents[key].classList.toggle('active', key === platform));
      }

      activatePlatform(CURRENT_PLATFORM || 'openai');

      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          activatePlatform(this.dataset.platform);
        });
      });
    }

    // ã‚·ãƒ¼ãƒˆåå–å¾—
    function loadSheetNames() {
      google.script.run
        .withSuccessHandler(function(sheetNames) {
          allSheetNames = sheetNames;
          populateSheetDropdowns();
        })
        .withFailureHandler(function(error) {
          console.error('ã‚·ãƒ¼ãƒˆåå–å¾—ã‚¨ãƒ©ãƒ¼:', error);
        })
        .getAllSheetNames();
    }

    function populateSheetDropdowns() {
      const duplicateSourceSheet = document.getElementById('duplicateSourceSheet');
      const outputSheet = document.getElementById('outputSheet');
      
      [duplicateSourceSheet, outputSheet].forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„</option>';
          allSheetNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
          });
        }
      });

      // å‡ºåŠ›åˆ—ã®è¨­å®š
      const outputColumn = document.getElementById('outputColumn');
      if (outputColumn) {
        outputColumn.innerHTML = '<option value="">åˆ—ã‚’é¸æŠ...</option>';
        // Aï½Zåˆ—
        for (let i = 0; i < 26; i++) {
          const col = String.fromCharCode(65 + i);
          const option = document.createElement('option');
          option.value = col;
          option.textContent = col + 'åˆ—';
          outputColumn.appendChild(option);
        }
        // AAï½AZåˆ—
        for (let i = 0; i < 26; i++) {
          const col = 'A' + String.fromCharCode(65 + i);
          const option = document.createElement('option');
          option.value = col;
          option.textContent = col + 'åˆ—';
          outputColumn.appendChild(option);
        }
      }
    }

    // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
    function setupEventListeners() {
      // DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½
      const dduCheckbox = document.getElementById('dduAdjustmentEnabled');
      const dduSettings = document.getElementById('dduSettingsGroup');
      
      function toggleDduSettings() {
        const enabled = dduCheckbox.checked;
        dduSettings.style.display = enabled ? 'block' : 'none';
        dduSettings.style.opacity = enabled ? '1' : '0.5';
      }
      
      if (dduCheckbox) {
        dduCheckbox.addEventListener('change', toggleDduSettings);
        toggleDduSettings();
      }

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½
      const duplicateCheckbox = document.getElementById('duplicateCheckEnabled');
      const duplicateSettings = document.getElementById('duplicateCheckSettings');
      
      function toggleDuplicateSettings() {
        const enabled = duplicateCheckbox.checked;
        duplicateSettings.style.display = enabled ? 'block' : 'none';
        duplicateSettings.style.opacity = enabled ? '1' : '0.5';
      }
      
      if (duplicateCheckbox) {
        duplicateCheckbox.addEventListener('change', toggleDuplicateSettings);
        toggleDuplicateSettings();
      }

      // å‡ºåŠ›è¨­å®šè¡¨ç¤ºåˆ¶å¾¡
      const applyCheckbox = document.getElementById('applyToSheet');
      const outputSettings = document.getElementById('outputSettings');
      
      if (applyCheckbox) {
        applyCheckbox.addEventListener('change', function() {
          outputSettings.style.display = this.checked ? 'block' : 'none';
        });
      }

      // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡
      const form = document.getElementById('setupForm');
      const saveBtn = document.getElementById('saveBtn');
      const btnLabel = saveBtn.querySelector('.btn-label');

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit();
      });

      // ã‚­ãƒ£ãƒ³ã‚»ãƒ«
      document.getElementById('cancelBtn').addEventListener('click', function() {
        google.script.host.close();
      });
    }

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯: å‚ç…§ã‚·ãƒ¼ãƒˆè¿½åŠ 
    function addTargetSheetDropdown() {
      const container = document.getElementById('targetSheetsContainer');
      const noMsgDiv = document.getElementById('noTargetSheetsMsg');
      if (noMsgDiv) noMsgDiv.style.display = 'none';
      
      targetSheetCounter++;
      const itemDiv = document.createElement('div');
      itemDiv.className = 'target-sheet-item';
      itemDiv.id = 'targetSheet_' + targetSheetCounter;
      
      // ã‚·ãƒ¼ãƒˆé¸æŠ
      const sheetDiv = document.createElement('div');
      const sheetSelect = document.createElement('select');
      sheetSelect.className = 'target-sheet-select';
      sheetSelect.innerHTML = '<option value="">å‚ç…§ã‚·ãƒ¼ãƒˆã‚’é¸æŠ</option>';
      
      allSheetNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        sheetSelect.appendChild(option);
      });
      
      const specialOption = document.createElement('option');
      specialOption.value = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿_*';
      specialOption.textContent = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿_* (ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ)';
      sheetSelect.appendChild(specialOption);
      
      sheetDiv.appendChild(sheetSelect);
      
      // åˆ—é¸æŠ
      const columnDiv = document.createElement('div');
      const columnSelect = document.createElement('select');
      columnSelect.className = 'target-column-select';
      columnSelect.innerHTML = '<option value="">åˆ—é¸æŠ</option>';
      
      ['A','B','C','D','E','F','G','H','I','J'].forEach(col => {
        const option = document.createElement('option');
        option.value = col;
        option.textContent = col + 'åˆ—';
        if (col === 'H') option.selected = true;
        columnSelect.appendChild(option);
      });
      columnDiv.appendChild(columnSelect);
      
      // å‰Šé™¤ãƒœã‚¿ãƒ³
      const removeBtn = document.createElement('button');
      removeBtn.textContent = 'å‰Šé™¤';
      removeBtn.type = 'button';
      removeBtn.onclick = function() {
        itemDiv.remove();
        if (container.querySelectorAll('.target-sheet-item').length === 0) {
          if (noMsgDiv) noMsgDiv.style.display = 'block';
        }
      };
      
      itemDiv.appendChild(sheetDiv);
      itemDiv.appendChild(columnDiv);
      itemDiv.appendChild(removeBtn);
      container.appendChild(itemDiv);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡å‡¦ç†
    function handleFormSubmit() {
      const saveBtn = document.getElementById('saveBtn');
      const btnLabel = saveBtn.querySelector('.btn-label');

      function setLoading(isLoading) {
        if (isLoading) {
          saveBtn.disabled = true;
          btnLabel.innerHTML = '<span class="spinner"></span>ä¿å­˜ä¸­...';
        } else {
          saveBtn.disabled = false;
          btnLabel.textContent = 'ä¿å­˜';
        }
      }

      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ç‰¹å®š
      const activeTab = document.querySelector('.platform-tab.active');
      const activePlatform = activeTab ? activeTab.getAttribute('data-platform') : 'openai';

      let apiKey = '', model = '';
      if (activePlatform === 'openai') {
        apiKey = document.getElementById('openaiApiKey').value.trim();
        model = document.getElementById('openaiModel').value || DEFAULT_OPENAI_MODEL;
      } else if (activePlatform === 'claude') {
        apiKey = document.getElementById('claudeApiKey').value.trim();
        model = document.getElementById('claudeModel').value;
      } else if (activePlatform === 'gemini') {
        apiKey = document.getElementById('geminiApiKey').value.trim();
        model = document.getElementById('geminiModel').value;
      }

      if (!apiKey) {
        alert('é¸æŠã—ãŸãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      // é‡è¤‡ãƒã‚§ãƒƒã‚¯ã®å¯¾è±¡ã‚·ãƒ¼ãƒˆåé›†
      const targetSheets = [];
      const targetItems = document.querySelectorAll('.target-sheet-item');
      targetItems.forEach(item => {
        const sheetSelect = item.querySelector('.target-sheet-select');
        const columnSelect = item.querySelector('.target-column-select');
        
        if (sheetSelect && sheetSelect.value && columnSelect && columnSelect.value) {
          targetSheets.push({
            sheet: sheetSelect.value,
            column: columnSelect.value
          });
        }
      });

      const formData = {
        // åŸºæœ¬è¨­å®š
        platform: activePlatform,
        apiKey: apiKey,
        model: model,
        sheetName: document.getElementById('sheetName').value,
        
        // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®š
        promptId: document.getElementById('promptId').value,
        
        // åˆ©ç›Šãƒ»ä¾¡æ ¼è¨ˆç®—
        profitMethod: document.querySelector('input[name="profitMethod"]:checked').value,
        priceDisplayMode: document.querySelector('input[name="priceDisplayMode"]:checked').value,
        dduAdjustmentEnabled: document.getElementById('dduAdjustmentEnabled').checked ? 'true' : 'false',
        dduThreshold: document.getElementById('dduThreshold').value,
        dduAdjustment: document.getElementById('dduAdjustment').value,
        
        // é€æ–™ãƒ»é…é€è¨­å®š
        shippingCalcMethod: document.querySelector('input[name="shippingCalcMethod"]:checked').value,
        shippingThreshold: document.getElementById('shippingThreshold').value,
        lowPriceMethod: document.getElementById('lowPriceMethod').value,
        highPriceMethod: document.getElementById('highPriceMethod').value,
        
        // é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š
        duplicateCheckEnabled: document.getElementById('duplicateCheckEnabled').checked,
        duplicateSourceSheet: document.getElementById('duplicateSourceSheet').value,
        duplicateSourceColumn: document.getElementById('duplicateSourceColumn').value,
        duplicateTargetSheets: targetSheets,
        duplicateApplyToSheet: document.getElementById('applyToSheet').checked,
        duplicateOutputSheet: document.getElementById('outputSheet').value,
        duplicateOutputColumn: document.getElementById('outputColumn').value,
        duplicateOutputStartRow: document.getElementById('outputStartRow').value,
        duplicateOutputRange: document.getElementById('outputRange').value,
        
        // è¡¨ç¤ºè¨­å®š
        showPopups: document.querySelector('input[name="showPopups"]:checked').value
      };

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          setLoading(false);
          if (result.success) {
            google.script.host.close();
          } else {
            alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + result.error);
          }
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + (error && error.message ? error.message : error));
        })
        .saveIntegratedSettings(formData);
    }

    // DDUé–¾å€¤ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚¿ãƒ¼
    function simulateThreshold() {
      var rate = parseFloat(document.getElementById('simulateRate').value);
      if (isNaN(rate) || rate < 0) {
        alert('0ä»¥ä¸Šã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }
      
      // DDUé–¾å€¤ã®å…¥åŠ›å€¤ã‚’å–å¾—ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ1500ï¼‰
      var baseThreshold = parseFloat(document.getElementById('dduThreshold').value) || 1500;
      
      // çµæœè¡¨ç¤º
      document.getElementById('simulateResult').style.display = 'block';
      document.getElementById('simThreshold').textContent = 'è¨ˆç®—ä¸­...';
      
      google.script.run
        .withSuccessHandler(function(result) {
          if (result.success) {
            document.getElementById('baseThresholdDisplay').textContent = result.baseThreshold;
            document.getElementById('simRateDisplay').textContent = result.targetRate.toFixed(1);
            document.getElementById('simThreshold').textContent = result.effectiveThreshold;
            document.getElementById('simDiff').textContent = result.difference.toFixed(0);
          } else {
            document.getElementById('simThreshold').textContent = 'ã‚¨ãƒ©ãƒ¼';
            alert('è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + (result.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('simThreshold').textContent = 'ã‚¨ãƒ©ãƒ¼';
          alert('è¨ˆç®—ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
        })
        .calculateEffectiveThresholdForSimulation(baseThreshold, rate);
    }
  </script>
</body>
</html>