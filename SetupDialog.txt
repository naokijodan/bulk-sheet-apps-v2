<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>初期設定（統合版）</title>
  <style>
    :root {
      --brand: #1a73e8;
      --brand-600: #1557b0;
      --text: #3c4043;
      --muted: #5f6368;
      --line: #e0e0e0;
      --bg: #f9f9f9;
      --card: #fff;
      --required: #dc2626;
      --recommended: #16a34a;
      --optional: #2563eb;
    }

    * { box-sizing: border-box; }
    
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      margin: 20px;
      background-color: var(--bg);
      color: var(--text);
      max-height: 80vh;
      overflow-y: auto;
    }

    .container {
      background: var(--card);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 12px rgba(0,0,0,0.08);
    }

    h2 {
      color: var(--brand);
      margin-bottom: 20px;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    /* セクションスタイル */
    .section {
      margin-bottom: 16px;
      border: 1px solid var(--line);
      border-radius: 12px;
      background: var(--card);
      overflow: hidden;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 16px 20px;
      background: #fafbfc;
      border-bottom: 1px solid var(--line);
      cursor: pointer;
      user-select: none;
    }

    .section-header:hover {
      background: #f1f3f4;
    }

    .section-title {
      display: flex;
      align-items: center;
      gap: 12px;
      font-weight: 600;
      font-size: 16px;
    }

    .priority-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 700;
      color: white;
    }

    .priority-required { background-color: var(--required); }
    .priority-recommended { background-color: var(--recommended); }
    .priority-optional { background-color: var(--optional); }

    .section-description {
      font-size: 14px;
      color: var(--muted);
      margin-top: 4px;
    }

    .section-controls {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .edit-toggle {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 14px;
    }

    .edit-toggle input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .collapse-btn {
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      transition: transform 0.2s ease;
    }

    .collapse-btn.collapsed {
      transform: rotate(-90deg);
    }

    .section-content {
      padding: 20px;
      display: none;
    }

    .section-content.expanded {
      display: block;
    }

    /* フォーム要素 */
    label {
      display: block;
      margin-top: 15px;
      margin-bottom: 6px;
      font-weight: 600;
      color: #2b2f33;
    }

    input[type="text"], input[type="number"], select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #dadce0;
      border-radius: 8px;
      font-size: 14px;
      transition: box-shadow .15s ease, border-color .15s ease;
      background: #fff;
    }

    input[type="text"]:focus, input[type="number"]:focus, select:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(26,115,232,.18);
    }

    .radio-group {
      margin: 8px 0 0;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .radio-group label {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      margin: 0;
      font-weight: 500;
      color: #333;
      cursor: pointer;
    }

    .radio-group input[type="radio"] {
      width: auto;
      margin: 0;
    }

    .checkbox-group {
      margin: 10px 0;
    }

    .checkbox-label {
      display: flex;
      align-items: center;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
    }

    .checkbox-label input[type="checkbox"] {
      margin-right: 8px;
      width: auto;
      transform: scale(1.1);
    }

    /* プラットフォームタブ */
    .api-platform-section {
      background-color: #fafafa;
      border: 1px solid var(--line);
      border-radius: 12px;
      padding: 14px;
      margin-top: 10px;
    }

    .platform-tabs {
      display: flex;
      margin-bottom: 14px;
      border-bottom: 1px solid var(--line);
      gap: 2px;
    }

    .platform-tab {
      padding: 8px 14px;
      cursor: pointer;
      border: none;
      background: none;
      font-size: 14px;
      border-bottom: 2px solid transparent;
      border-radius: 8px 8px 0 0;
      transition: background .15s ease, color .15s ease, border-color .15s ease;
    }

    .platform-tab:hover { background-color: #f1f3f4; }

    .platform-tab.active {
      color: var(--brand);
      border-bottom-color: var(--brand);
      font-weight: 700;
      background: #eef4ff;
    }

    .platform-content { display: none; }
    .platform-content.active { display: block; }

    /* 重複チェック設定 */
    .target-sheets-container {
      border: 1px solid #ddd;
      padding: 15px;
      background: #f9f9f9;
      border-radius: 4px;
      min-height: 100px;
      margin-top: 10px;
    }

    .target-sheet-item {
      display: grid;
      grid-template-columns: 1fr 100px 80px;
      gap: 10px;
      margin-bottom: 15px;
      padding: 10px;
      background: white;
      border-radius: 4px;
      border: 1px solid #ddd;
    }

    .input-row {
      display: flex;
      gap: 20px;
      margin: 15px 0;
    }

    .input-group {
      flex: 1;
    }

    .input-group label {
      margin-top: 0;
      font-size: 13px;
    }

    /* 情報ボックス */
    .info-box, .warning-box {
      border-radius: 10px;
      padding: 12px;
      margin-top: 10px;
    }

    .info-box {
      background-color: #e8f0fe;
      border: 1px solid #dadce0;
    }

    .warning-box {
      background-color: #fff3cd;
      border: 1px solid #ffeaa7;
    }

    .info-box .title, .warning-box .title {
      font-weight: 700;
      margin-bottom: 6px;
    }

    .info-box .title {
      color: var(--brand);
    }

    .warning-box .title {
      color: #856404;
    }

    .info-box .content, .warning-box .content {
      font-size: 12px;
      line-height: 1.6;
    }

    .info-box .content {
      color: var(--muted);
    }

    .warning-box .content {
      color: #856404;
    }

    .help-text {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .cost-info {
      font-size: 12px;
      color: #666;
      font-style: italic;
      margin-top: 6px;
    }

    /* ボタン */
    .button-group {
      margin-top: 26px;
      display: flex;
      justify-content: flex-end;
      gap: 12px;
    }

    .btn {
      position: relative;
      overflow: hidden;
      border: none;
      padding: 10px 18px;
      border-radius: 999px;
      cursor: pointer;
      font-size: 14px;
      line-height: 1;
      transition: transform .06s ease, box-shadow .2s ease, background-color .2s ease;
      user-select: none;
    }

    .btn:active { transform: translateY(0.5px) scale(.99); }

    .btn.primary {
      background-color: var(--brand);
      color: #fff;
      box-shadow: 0 6px 16px rgba(26,115,232,.25);
    }

    .btn.primary:hover { background-color: var(--brand-600); }

    .btn.secondary {
      background-color: #edf2f7;
      color: var(--text);
    }

    .btn.secondary:hover { background: #e2e8f0; }

    .btn:disabled {
      opacity: .65;
      cursor: not-allowed;
      box-shadow: none;
    }

    .spinner {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      border: 2px solid rgba(255,255,255,.55);
      border-top-color: #fff;
      animation: spin .8s linear infinite;
      display: inline-block;
      vertical-align: middle;
      margin-right: 8px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    .disabled-overlay {
      opacity: 0.5;
      pointer-events: none;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>初期設定（統合版）</h2>

    <form id="setupForm">
      <!-- 1. AI・基本設定 -->
      <div class="section" data-section="ai-basic">
        <div class="section-header" onclick="toggleSection('ai-basic')">
          <div class="section-title">
            <span class="priority-badge priority-required">必須</span>
            <div>
              <div>AI・基本設定</div>
              <div class="section-description">AIサービスと作業シートの基本的な設定</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-ai-basic" value="maintain" checked> 維持</label>
              <label><input type="radio" name="edit-ai-basic" value="edit"> 編集</label>
            </div>
            <button type="button" class="collapse-btn">▼</button>
          </div>
        </div>
        <div class="section-content" id="content-ai-basic">
          <label>AI プラットフォーム選択 *</label>
          <div class="api-platform-section">
            <div class="platform-tabs" id="platformTabs">
              <button type="button" class="platform-tab" data-platform="openai">OpenAI</button>
              <button type="button" class="platform-tab" data-platform="claude">Claude</button>
              <button type="button" class="platform-tab" data-platform="gemini">Gemini</button>
            </div>

            <div class="platform-content" id="openai-content">
              <label for="openaiApiKey">OpenAI APIキー *</label>
              <input type="text" id="openaiApiKey" name="openaiApiKey" value="<?= currentApiKeys.openai || '' ?>" placeholder="sk-...">
              <div class="help-text">OpenAIのAPIキーを入力してください</div>

              <label for="openaiModel">モデル選択 *</label>
              <select id="openaiModel" name="openaiModel">
                <option value="gpt-5-nano" <?= (currentModel === 'gpt-5-nano' || !currentModel) ? 'selected' : '' ?>>GPT-5-nano（最安・推奨）</option>
                <option value="gpt-4o-mini" <?= currentModel === 'gpt-4o-mini' ? 'selected' : '' ?>>GPT-4o-mini（互換・低コスト）</option>
                <option value="gpt-5-mini" <?= currentModel === 'gpt-5-mini' ? 'selected' : '' ?>>GPT-5-mini（やや高品質）</option>
              </select>
              <div class="cost-info">目安: GPT-5-nano ≈ ~$0.0003–0.0004 / 1K tokens</div>
            </div>

            <div class="platform-content" id="claude-content">
              <label for="claudeApiKey">Claude APIキー *</label>
              <input type="text" id="claudeApiKey" name="claudeApiKey" value="<?= currentApiKeys.claude || '' ?>" placeholder="sk-ant-...">
              <div class="help-text">AnthropicのAPIキーを入力してください</div>

              <label for="claudeModel">モデル選択 *</label>
              <select id="claudeModel" name="claudeModel">
                <option value="claude-3-haiku-20240307" <?= currentModel === 'claude-3-haiku-20240307' ? 'selected' : '' ?>>Claude 3 Haiku（最安・推奨）</option>
                <option value="claude-3-sonnet-20240229" <?= currentModel === 'claude-3-sonnet-20240229' ? 'selected' : '' ?>>Claude 3 Sonnet（バランス）</option>
                <option value="claude-3-opus-20240229" <?= currentModel === 'claude-3-opus-20240229' ? 'selected' : '' ?>>Claude 3 Opus（高性能）</option>
              </select>
              <div class="cost-info">参考: Haiku ≈ ~$0.0015 / 1K tokens ほか</div>
            </div>

            <div class="platform-content" id="gemini-content">
              <label for="geminiApiKey">Gemini APIキー *</label>
              <input type="text" id="geminiApiKey" name="geminiApiKey" value="<?= currentApiKeys.gemini || '' ?>" placeholder="AIza...">
              <div class="help-text">Google AI StudioのAPIキーを入力してください</div>

              <label for="geminiModel">モデル選択 *</label>
              <select id="geminiModel" name="geminiModel">
                <option value="gemini-1.5-flash" <?= currentModel === 'gemini-1.5-flash' ? 'selected' : '' ?>>Gemini 1.5 Flash（最安・推奨）</option>
                <option value="gemini-1.5-pro" <?= currentModel === 'gemini-1.5-pro' ? 'selected' : '' ?>>Gemini 1.5 Pro（バランス）</option>
                <option value="gemini-pro" <?= currentModel === 'gemini-pro' ? 'selected' : '' ?>>Gemini Pro（安定）</option>
              </select>
              <div class="cost-info">参考: Flash ≈ ~$0.0008 / 1K tokens ほか</div>
            </div>
          </div>

          <label for="sheetName">作業シート名 *</label>
          <input type="text" id="sheetName" name="sheetName" value="<?= currentSheetName ?>" required>
          <div class="help-text">データ処理を行うシートの名前</div>

          <div class="info-box">
            <div class="title">コスト比較の目安（1K tokens）</div>
            <div class="content">
              最安: GPT-5-nano ≲ GPT-5-mini ≲ Gemini 1.5 Flash ≲ Claude 3 Haiku<br>
              高性能: Claude 3 Opus / GPT-5-mini / GPT-4系 / Gemini 1.5 Pro（用途次第）<br>
              まずは GPT-5-nano をお試しください（推奨）
            </div>
          </div>
        </div>
      </div>

      <!-- 2. プロンプト設定 -->
      <div class="section" data-section="prompt">
        <div class="section-header" onclick="toggleSection('prompt')">
          <div class="section-title">
            <span class="priority-badge priority-recommended">推奨</span>
            <div>
              <div>プロンプト設定</div>
              <div class="section-description">AI生成の品質を決定するプロンプト設定</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-prompt" value="maintain" checked> 維持</label>
              <label><input type="radio" name="edit-prompt" value="edit"> 編集</label>
            </div>
            <button type="button" class="collapse-btn">▼</button>
          </div>
        </div>
        <div class="section-content" id="content-prompt">
          <label for="promptId">使用プロンプト *</label>
          <select id="promptId" name="promptId" required>
            <? for (var i = 0; i < promptIds.length; i++) { ?>
              <option value="<?= promptIds[i] ?>" <?= promptIds[i] === currentPromptId ? 'selected' : '' ?>>
                <?= promptIds[i] ?>
              </option>
            <? } ?>
          </select>
          <div class="help-text">GPT_Prompts シートから選択</div>

          <div class="info-box">
            <div class="title">プロンプト編集</div>
            <div class="content">
              プロンプトの内容は「プロンプト編集」サイドバーで変更できます。<br>
              メニュー「AI翻訳・価格計算」→「プロンプト編集」から開けます。
            </div>
          </div>
        </div>
      </div>

      <!-- 3. 利益・価格計算 -->
      <div class="section" data-section="price-calc">
        <div class="section-header" onclick="toggleSection('price-calc')">
          <div class="section-title">
            <span class="priority-badge priority-required">必須</span>
            <div>
              <div>利益・価格計算</div>
              <div class="section-description">利益計算と価格表示の設定</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-price-calc" value="maintain" checked> 維持</label>
              <label><input type="radio" name="edit-price-calc" value="edit"> 編集</label>
            </div>
            <button type="button" class="collapse-btn">▼</button>
          </div>
        </div>
        <div class="section-content" id="content-price-calc">
          <label>利益計算方法 *</label>
          <div class="radio-group">
            <label><input type="radio" name="profitMethod" value="RATE" <?= (currentProfitCalculationMethod === 'RATE' || !currentProfitCalculationMethod) ? 'checked' : '' ?>> 利益率で計算</label>
            <label><input type="radio" name="profitMethod" value="AMOUNT" <?= currentProfitCalculationMethod === 'AMOUNT' ? 'checked' : '' ?>> 利益額で計算</label>
          </div>

          <label>価格表示モード *</label>
          <div class="radio-group">
            <label><input type="radio" name="priceDisplayMode" value="NORMAL" <?= (currentPriceDisplayMode === 'NORMAL' || !currentPriceDisplayMode) ? 'checked' : '' ?>> 販売価格（DDU）</label>
            <label><input type="radio" name="priceDisplayMode" value="TAX_INCLUDED" <?= currentPriceDisplayMode === 'TAX_INCLUDED' ? 'checked' : '' ?>> 関税込み価格（DDP）</label>
          </div>

          <label>DDU価格調整機能</label>
          <div class="checkbox-group">
            <label class="checkbox-label">
 <input type="checkbox" id="dduAdjustmentEnabled" name="dduAdjustmentEnabled" checked>
  DDU価格調整機能を有効にする
</label>
          </div>
          

          <div id="dduSettingsGroup">
            <div class="input-row">
              <div class="input-group">
                <label for="dduThreshold">想定関税閾値（ドル）:</label>
                <input type="number" id="dduThreshold" name="dduThreshold"
                       value="<?= currentDduThreshold || '390' ?>" min="1" step="1">
              </div>
            </div>
            <div class="help-text">
              想定関税（AD列）が閾値以上の場合、DDP価格（S列）から想定関税を引いた価格を計算します
            </div>
          </div>

          <div class="info-box">
            <div class="title">価格計算の設定箇所</div>
            <div class="content">
              • 手数料率: F1 / 広告費率: F2<br>
              • 利益額: H1（利益額計算選択時）<br>
              • 利益率: H2（利益率計算選択時）
            </div>
          </div>

          <div class="warning-box">
            <div class="title">DDU価格調整機能の注意事項</div>
            <div class="content">
              この機能はDDU商品専用です。DDPで出品する場合でも、実際の販売価格はDDU価格を使用し、関税分を送料として別途徴収するビジネスモデル向けです。
            </div>
          </div>
        </div>
      </div>

      <!-- 4. 送料・配送設定 -->
      <div class="section" data-section="shipping">
        <div class="section-header" onclick="toggleSection('shipping')">
          <div class="section-title">
            <span class="priority-badge priority-required">必須</span>
            <div>
              <div>送料・配送設定</div>
              <div class="section-description">送料計算と配送方法の設定</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-shipping" value="maintain" checked> 維持</label>
              <label><input type="radio" name="edit-shipping" value="edit"> 編集</label>
            </div>
            <button type="button" class="collapse-btn">▼</button>
          </div>
        </div>
        <div class="section-content" id="content-shipping">
          <label>送料計算方法 *</label>
          <div class="radio-group">
            <label><input type="radio" name="shippingCalcMethod" value="TABLE" <?= (currentShippingCalculationMethod === 'TABLE' || !currentShippingCalculationMethod) ? 'checked' : '' ?>> テーブル計算</label>
            <label><input type="radio" name="shippingCalcMethod" value="FIXED" <?= currentShippingCalculationMethod === 'FIXED' ? 'checked' : '' ?>> 固定金額</label>
          </div>

          <label for="shippingThreshold">送料計算切替基準金額（円） *</label>
          <input type="number" id="shippingThreshold" name="shippingThreshold" value="<?= currentShippingThreshold || '5500' ?>" min="1" step="1" required>
          <div class="help-text">この金額以上は高価格配送、未満の場合は低価格配送を使用</div>

          <label for="lowPriceMethod">低価格商品配送方法 *</label>
          <select id="lowPriceMethod" name="lowPriceMethod" required>
            <? Object.keys(lowPriceOptions).forEach(function(key) { ?>
              <option value="<?= key ?>" <?= currentLowPriceMethod === key ? 'selected' : '' ?>>
                <?= lowPriceOptions[key].displayName ?>
              </option>
            <? }); ?>
          </select>

          <label for="highPriceMethod">高価格商品配送方法 *</label>
          <select id="highPriceMethod" name="highPriceMethod" required>
            <? Object.keys(highPriceOptions).forEach(function(key) { ?>
              <option value="<?= key ?>" <?= currentHighPriceMethod === key ? 'selected' : '' ?>>
                <?= highPriceOptions[key].displayName ?>
              </option>
            <? }); ?>
          </select>

          <div class="info-box">
            <div class="title">送料計算方法の説明</div>
            <div class="content">
              <strong>テーブル計算</strong>: 重量・サイズに基づいて自動計算（推奨）<br>
              <strong>固定金額</strong>: J1 または Profit_Amounts!D から取得<br><br>
              <strong>固定金額の設定</strong><br>
              • 全商品共通: J1 セルに金額を入力<br>
              • 仕入れ値別: Profit_Amounts!D列に各金額帯の送料
            </div>
          </div>
        </div>
      </div>

      <!-- 5. 重複チェック設定 -->
      <div class="section" data-section="duplicate-check">
        <div class="section-header" onclick="toggleSection('duplicate-check')">
          <div class="section-title">
            <span class="priority-badge priority-optional">任意</span>
            <div>
              <div>重複チェック設定</div>
              <div class="section-description">商品の重複を自動検出する機能</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-duplicate-check" value="maintain" checked> 維持</label>
              <label><input type="radio" name="edit-duplicate-check" value="edit"> 編集</label>
            </div>
            <button type="button" class="collapse-btn">▼</button>
          </div>
        </div>
        <div class="section-content" id="content-duplicate-check">
          <div class="checkbox-group">
            <label class="checkbox-label">
              <input type="checkbox" id="duplicateCheckEnabled" name="duplicateCheckEnabled" 
                     <?= currentDuplicateCheckEnabled === 'true' ? 'checked' : '' ?>>
              重複チェック機能を有効にする
            </label>
          </div>

          <div id="duplicateCheckSettings">
            <label for="duplicateSourceSheet">作業シート（重複をチェックされる側）:</label>
            <select id="duplicateSourceSheet" name="duplicateSourceSheet">
              <option value="">シートを選択してください</option>
            </select>

            <label for="duplicateSourceColumn">作業シートの列:</label>
            <select id="duplicateSourceColumn" name="duplicateSourceColumn">
              <option value="">列を選択してください</option>
              <option value="A">A列</option>
              <option value="B">B列</option>
              <option value="C">C列</option>
              <option value="D">D列</option>
              <option value="E">E列</option>
              <option value="F">F列</option>
              <option value="G">G列</option>
              <option value="H">H列</option>
              <option value="I">I列</option>
              <option value="J">J列</option>
            </select>

            <label>チェック対象シート（重複元）:</label>
            <div id="targetSheetsContainer" class="target-sheets-container">
              <div id="noTargetSheetsMsg">参照シートを追加してください。</div>
            </div>
            <button type="button" onclick="addTargetSheetDropdown()">参照シート追加</button>

            <div class="checkbox-group">
              <label class="checkbox-label">
                <input type="checkbox" id="applyToSheet" name="applyToSheet">
                生成した式をシートに直接適用する
              </label>
            </div>

            <div id="outputSettings" style="display: none;">
              <label for="outputSheet">出力先シート:</label>
              <select id="outputSheet" name="outputSheet">
                <option value="">シートを選択...</option>
              </select>

              <div class="input-row">
                <div class="input-group">
                  <label for="outputColumn">出力先列:</label>
                  <select id="outputColumn" name="outputColumn">
                    <option value="">列を選択...</option>
                  </select>
                </div>
                <div class="input-group">
                  <label for="outputStartRow">開始行:</label>
                  <input type="number" id="outputStartRow" name="outputStartRow" value="1" min="1">
                </div>
              </div>

              <label for="outputRange">適用範囲:</label>
              <select id="outputRange" name="outputRange">
                <option value="DATA">データがある範囲まで</option>
                <option value="CUSTOM">カスタム範囲（100行）</option>
                <option value="ALL">シート全体（1000行）</option>
              </select>
            </div>
          </div>

          <div class="info-box">
            <div class="title">重複チェック機能について</div>
            <div class="content">
              作業シートでの入力時に、既存の保存データと重複する商品を自動検出します。<br>
              パターンマッチ（保存データ_*）も使用可能です。
            </div>
          </div>
        </div>
      </div>

      <!-- 6. 表示設定 -->
      <div class="section" data-section="display">
        <div class="section-header" onclick="toggleSection('display')">
          <div class="section-title">
            <span class="priority-badge priority-optional">任意</span>
            <div>
              <div>表示設定</div>
              <div class="section-description">ユーザーインターフェースに関する設定</div>
            </div>
          </div>
          <div class="section-controls">
            <div class="edit-toggle">
              <label><input type="radio" name="edit-display" value="maintain" checked> 維持</label>
              <label><input type="radio" name="edit-display" value="edit"> 編集</label>
            </div>
            <button type="button" class="collapse-btn">▼</button>
          </div>
        </div>
        <div class="section-content" id="content-display">
          <label>ポップアップ表示設定 *</label>
          <div class="radio-group">
            <label><input type="radio" name="showPopups" value="true" <?= currentShowPopups === 'true' ? 'checked' : '' ?>> ON（表示する）</label>
            <label><input type="radio" name="showPopups" value="false" <?= (currentShowPopups === 'false' || !currentShowPopups) ? 'checked' : '' ?>> OFF（表示しない）</label>
          </div>
          <div class="help-text">作業開始・完了時の確認ダイアログ表示を制御（エラーは常に表示）</div>

          <div class="info-box">
            <div class="title">ポップアップ表示の説明</div>
            <div class="content">
              • ON: 作業開始時に確認ダイアログ、完了時に結果表示<br>
              • OFF: 確認なしで即座に実行開始、完了時も無通知<br>
              • エラー: 設定に関係なく常に表示（安全のため）<br>
              • 作業制御: D2セル（GO/STOP）での停止は別機能
            </div>
          </div>
        </div>
      </div>

      <div class="button-group">
        <button type="button" class="btn secondary" id="cancelBtn">キャンセル</button>
        <button type="submit" class="btn primary" id="saveBtn">
          <span class="btn-label">保存</span>
        </button>
      </div>
    </form>
  </div>

  <script>
    // 初期設定
    const CURRENT_PLATFORM = "<?= typeof currentPlatform !== 'undefined' ? currentPlatform : 'openai' ?>";
    const DEFAULT_OPENAI_MODEL = "gpt-5-nano";
    
    var allSheetNames = [];
    var targetSheetCounter = 0;

    // 初期化
    document.addEventListener('DOMContentLoaded', function() {
      initializeSections();
      initializePlatformTabs();
      loadSheetNames();
      setupEventListeners();
      updateSectionStates();
    });

    // セクション管理
    function toggleSection(sectionId) {
      const content = document.getElementById('content-' + sectionId);
      const btn = document.querySelector(`[data-section="${sectionId}"] .collapse-btn`);
      
      if (content.classList.contains('expanded')) {
        content.classList.remove('expanded');
        btn.classList.add('collapsed');
      } else {
        content.classList.add('expanded');
        btn.classList.remove('collapsed');
      }
    }

    function initializeSections() {
      // 必須セクションは初期展開
      const requiredSections = ['ai-basic', 'price-calc', 'shipping'];
      requiredSections.forEach(sectionId => {
        const content = document.getElementById('content-' + sectionId);
        content.classList.add('expanded');
      });
    }

    function updateSectionStates() {
      document.querySelectorAll('[name^="edit-"]').forEach(radio => {
        radio.addEventListener('change', function() {
          const sectionId = this.name.replace('edit-', '');
          const content = document.getElementById('content-' + sectionId);
          const isEdit = this.value === 'edit';
          
          if (isEdit) {
            content.classList.remove('disabled-overlay');
          } else {
            content.classList.add('disabled-overlay');
          }
        });
      });
    }

    // プラットフォームタブ
    function initializePlatformTabs() {
      const tabs = document.querySelectorAll('.platform-tab');
      const contents = {
        openai: document.getElementById('openai-content'),
        claude: document.getElementById('claude-content'),
        gemini: document.getElementById('gemini-content')
      };

      function activatePlatform(platform) {
        tabs.forEach(tab => tab.classList.toggle('active', tab.dataset.platform === platform));
        Object.keys(contents).forEach(key => contents[key].classList.toggle('active', key === platform));
      }

      activatePlatform(CURRENT_PLATFORM || 'openai');

      tabs.forEach(tab => {
        tab.addEventListener('click', function() {
          activatePlatform(this.dataset.platform);
        });
      });
    }

    // シート名取得
    function loadSheetNames() {
      google.script.run
        .withSuccessHandler(function(sheetNames) {
          allSheetNames = sheetNames;
          populateSheetDropdowns();
        })
        .withFailureHandler(function(error) {
          console.error('シート名取得エラー:', error);
        })
        .getAllSheetNames();
    }

    function populateSheetDropdowns() {
      const duplicateSourceSheet = document.getElementById('duplicateSourceSheet');
      const outputSheet = document.getElementById('outputSheet');
      
      [duplicateSourceSheet, outputSheet].forEach(select => {
        if (select) {
          select.innerHTML = '<option value="">シートを選択してください</option>';
          allSheetNames.forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            select.appendChild(option);
          });
        }
      });

      // 出力列の設定
      const outputColumn = document.getElementById('outputColumn');
      if (outputColumn) {
        outputColumn.innerHTML = '<option value="">列を選択...</option>';
        // A～Z列
        for (let i = 0; i < 26; i++) {
          const col = String.fromCharCode(65 + i);
          const option = document.createElement('option');
          option.value = col;
          option.textContent = col + '列';
          outputColumn.appendChild(option);
        }
        // AA～AZ列
        for (let i = 0; i < 26; i++) {
          const col = 'A' + String.fromCharCode(65 + i);
          const option = document.createElement('option');
          option.value = col;
          option.textContent = col + '列';
          outputColumn.appendChild(option);
        }
      }
    }

    // イベントリスナー設定
    function setupEventListeners() {
      // DDU価格調整機能
      const dduCheckbox = document.getElementById('dduAdjustmentEnabled');
      const dduSettings = document.getElementById('dduSettingsGroup');
      
      function toggleDduSettings() {
        const enabled = dduCheckbox.checked;
        dduSettings.style.display = enabled ? 'block' : 'none';
        dduSettings.style.opacity = enabled ? '1' : '0.5';
      }
      
      if (dduCheckbox) {
        dduCheckbox.addEventListener('change', toggleDduSettings);
        toggleDduSettings();
      }

      // 重複チェック機能
      const duplicateCheckbox = document.getElementById('duplicateCheckEnabled');
      const duplicateSettings = document.getElementById('duplicateCheckSettings');
      
      function toggleDuplicateSettings() {
        const enabled = duplicateCheckbox.checked;
        duplicateSettings.style.display = enabled ? 'block' : 'none';
        duplicateSettings.style.opacity = enabled ? '1' : '0.5';
      }
      
      if (duplicateCheckbox) {
        duplicateCheckbox.addEventListener('change', toggleDuplicateSettings);
        toggleDuplicateSettings();
      }

      // 出力設定表示制御
      const applyCheckbox = document.getElementById('applyToSheet');
      const outputSettings = document.getElementById('outputSettings');
      
      if (applyCheckbox) {
        applyCheckbox.addEventListener('change', function() {
          outputSettings.style.display = this.checked ? 'block' : 'none';
        });
      }

      // フォーム送信
      const form = document.getElementById('setupForm');
      const saveBtn = document.getElementById('saveBtn');
      const btnLabel = saveBtn.querySelector('.btn-label');

      form.addEventListener('submit', function(e) {
        e.preventDefault();
        handleFormSubmit();
      });

      // キャンセル
      document.getElementById('cancelBtn').addEventListener('click', function() {
        google.script.host.close();
      });
    }

    // 重複チェック: 参照シート追加
    function addTargetSheetDropdown() {
      const container = document.getElementById('targetSheetsContainer');
      const noMsgDiv = document.getElementById('noTargetSheetsMsg');
      if (noMsgDiv) noMsgDiv.style.display = 'none';
      
      targetSheetCounter++;
      const itemDiv = document.createElement('div');
      itemDiv.className = 'target-sheet-item';
      itemDiv.id = 'targetSheet_' + targetSheetCounter;
      
      // シート選択
      const sheetDiv = document.createElement('div');
      const sheetSelect = document.createElement('select');
      sheetSelect.className = 'target-sheet-select';
      sheetSelect.innerHTML = '<option value="">参照シートを選択</option>';
      
      allSheetNames.forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = name;
        sheetSelect.appendChild(option);
      });
      
      const specialOption = document.createElement('option');
      specialOption.value = '保存データ_*';
      specialOption.textContent = '保存データ_* (パターンマッチ)';
      sheetSelect.appendChild(specialOption);
      
      sheetDiv.appendChild(sheetSelect);
      
      // 列選択
      const columnDiv = document.createElement('div');
      const columnSelect = document.createElement('select');
      columnSelect.className = 'target-column-select';
      columnSelect.innerHTML = '<option value="">列選択</option>';
      
      ['A','B','C','D','E','F','G','H','I','J'].forEach(col => {
        const option = document.createElement('option');
        option.value = col;
        option.textContent = col + '列';
        if (col === 'H') option.selected = true;
        columnSelect.appendChild(option);
      });
      columnDiv.appendChild(columnSelect);
      
      // 削除ボタン
      const removeBtn = document.createElement('button');
      removeBtn.textContent = '削除';
      removeBtn.type = 'button';
      removeBtn.onclick = function() {
        itemDiv.remove();
        if (container.querySelectorAll('.target-sheet-item').length === 0) {
          if (noMsgDiv) noMsgDiv.style.display = 'block';
        }
      };
      
      itemDiv.appendChild(sheetDiv);
      itemDiv.appendChild(columnDiv);
      itemDiv.appendChild(removeBtn);
      container.appendChild(itemDiv);
    }

    // フォーム送信処理
    function handleFormSubmit() {
      const saveBtn = document.getElementById('saveBtn');
      const btnLabel = saveBtn.querySelector('.btn-label');

      function setLoading(isLoading) {
        if (isLoading) {
          saveBtn.disabled = true;
          btnLabel.innerHTML = '<span class="spinner"></span>保存中...';
        } else {
          saveBtn.disabled = false;
          btnLabel.textContent = '保存';
        }
      }

      // アクティブプラットフォーム特定
      const activeTab = document.querySelector('.platform-tab.active');
      const activePlatform = activeTab ? activeTab.getAttribute('data-platform') : 'openai';

      let apiKey = '', model = '';
      if (activePlatform === 'openai') {
        apiKey = document.getElementById('openaiApiKey').value.trim();
        model = document.getElementById('openaiModel').value || DEFAULT_OPENAI_MODEL;
      } else if (activePlatform === 'claude') {
        apiKey = document.getElementById('claudeApiKey').value.trim();
        model = document.getElementById('claudeModel').value;
      } else if (activePlatform === 'gemini') {
        apiKey = document.getElementById('geminiApiKey').value.trim();
        model = document.getElementById('geminiModel').value;
      }

      if (!apiKey) {
        alert('選択したプラットフォームのAPIキーを入力してください。');
        return;
      }

      // 重複チェックの対象シート収集
      const targetSheets = [];
      const targetItems = document.querySelectorAll('.target-sheet-item');
      targetItems.forEach(item => {
        const sheetSelect = item.querySelector('.target-sheet-select');
        const columnSelect = item.querySelector('.target-column-select');
        
        if (sheetSelect && sheetSelect.value && columnSelect && columnSelect.value) {
          targetSheets.push({
            sheet: sheetSelect.value,
            column: columnSelect.value
          });
        }
      });

      const formData = {
        // 基本設定
        platform: activePlatform,
        apiKey: apiKey,
        model: model,
        sheetName: document.getElementById('sheetName').value,
        
        // プロンプト設定
        promptId: document.getElementById('promptId').value,
        
        // 利益・価格計算
        profitMethod: document.querySelector('input[name="profitMethod"]:checked').value,
        priceDisplayMode: document.querySelector('input[name="priceDisplayMode"]:checked').value,
        dduAdjustmentEnabled: document.getElementById('dduAdjustmentEnabled').checked ? 'true' : 'false',
        dduThreshold: document.getElementById('dduThreshold').value,
        
        // 送料・配送設定
        shippingCalcMethod: document.querySelector('input[name="shippingCalcMethod"]:checked').value,
        shippingThreshold: document.getElementById('shippingThreshold').value,
        lowPriceMethod: document.getElementById('lowPriceMethod').value,
        highPriceMethod: document.getElementById('highPriceMethod').value,
        
        // 重複チェック設定
        duplicateCheckEnabled: document.getElementById('duplicateCheckEnabled').checked,
        duplicateSourceSheet: document.getElementById('duplicateSourceSheet').value,
        duplicateSourceColumn: document.getElementById('duplicateSourceColumn').value,
        duplicateTargetSheets: targetSheets,
        duplicateApplyToSheet: document.getElementById('applyToSheet').checked,
        duplicateOutputSheet: document.getElementById('outputSheet').value,
        duplicateOutputColumn: document.getElementById('outputColumn').value,
        duplicateOutputStartRow: document.getElementById('outputStartRow').value,
        duplicateOutputRange: document.getElementById('outputRange').value,
        
        // 表示設定
        showPopups: document.querySelector('input[name="showPopups"]:checked').value
      };

      setLoading(true);
      google.script.run
        .withSuccessHandler(function(result) {
          setLoading(false);
          if (result.success) {
            google.script.host.close();
          } else {
            alert('保存に失敗しました: ' + result.error);
          }
        })
        .withFailureHandler(function(error) {
          setLoading(false);
          alert('エラーが発生しました: ' + (error && error.message ? error.message : error));
        })
        .saveIntegratedSettings(formData);
    }
  </script>
</body>
</html>