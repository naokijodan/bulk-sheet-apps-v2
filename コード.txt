/******************************************************
 * ã‚³ãƒ¼ãƒ‰.js - ãƒ¡ã‚¤ãƒ³å‡¦ç†ï¼ˆæ®‹ã‚Šã®é–¢æ•°ï¼‰
 *
 * åˆ†å‰²æ¸ˆã¿ãƒ•ã‚¡ã‚¤ãƒ«:
 * - Config.gs: CONFIGå®šæ•°ã€è¨­å®šç®¡ç†
 * - Utils.gs: ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
 * - AI.gs: AI APIå‘¼ã³å‡ºã—
 * - Translation.gs: ç¿»è¨³å‡¦ç†
 * - Shipping.gs: é€æ–™è¨ˆç®—
 ******************************************************/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆå‘¨ã‚Š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function getAllPromptIds() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sh = ss.getSheetByName('GPT_Prompts');
    if (!sh) return ['EBAY_FULL_LISTING_PROMPT'];
    var last = sh.getLastRow();
    if (last < 2) return ['EBAY_FULL_LISTING_PROMPT'];
    var vals = sh.getRange(2, 1, last - 1, 1).getValues();
    var ids = vals.map(function(r){ return (r[0] || '').toString().trim(); })
                  .filter(function(v){ return v; });
    return ids.length ? ids : ['EBAY_FULL_LISTING_PROMPT'];
  } catch (e) {
    return ['EBAY_FULL_LISTING_PROMPT'];
  }
}

function getPromptContent(promptId) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var name = "GPT_Prompts";
    var sh = ss.getSheetByName(name);
    if (!sh) return "";
    var last = sh.getLastRow();
    if (last < 2) return "";
    var vals = sh.getRange(2, 1, last - 1, 2).getValues();
    for (var i=0;i<vals.length;i++) {
      var id = (vals[i][0]||'').toString().trim();
      if (id === promptId) return (vals[i][1]||'').toString();
    }
    return "";
  } catch (e) {
    return "";
  }
}

/* ã‚µã‚¤ãƒ‰ãƒãƒ¼ï¼šãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›† */
function showPromptEditorSidebar() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('PromptEditor').setTitle('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†').setWidth(400);
    SpreadsheetApp.getUi().showSidebar(html);
  } catch (e) {
    showAlert('ã€ŒPromptEditor.htmlã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
  }
}

function savePromptContent(promptId, newContent) {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var sh = ss.getSheetByName("GPT_Prompts");
  if (!sh) throw new Error('GPT_Prompts ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
  var last = sh.getLastRow();
  var range = sh.getRange(2, 1, Math.max(0, last-1), 1);
  var ids = range.getValues().map(function(r){return (r[0]||'').toString().trim();});
  var idx = ids.indexOf(promptId);
  if (idx === -1) throw new Error('ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆIDãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚');
  sh.getRange(2+idx, 2).setValue(newContent);
  sh.getRange(2+idx, 4).setValue(new Date());
  SpreadsheetApp.flush();
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  åˆæœŸè¨­å®šUIï¼ˆSetupDialog ãŒç„¡ã„å ´åˆã‚‚ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
// Part 1ã® initialSetup é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„

function initialSetup() {
  var ui = SpreadsheetApp.getUi();
  var props = PropertiesService.getScriptProperties();
  try {
    var tmpl;
    try {
      tmpl = HtmlService.createTemplateFromFile('SetupDialog');
    } catch (_) {
      tmpl = null;
    }
    if (!tmpl) {
      ui.alert('åˆæœŸè¨­å®š', 'SetupDialog.html ãŒç„¡ã„ã®ã§ç°¡æ˜“æ¡ˆå†…ã‚’è¡¨ç¤ºã—ã¾ã™ã€‚', ui.ButtonSet.OK);
      return;
    }
    
    // æ—¢å­˜ã®è¨­å®šå¤‰æ•°
    tmpl.currentApiKeys = {
      openai: props.getProperty('OPENAI_API_KEY') || '',
      claude: props.getProperty('CLAUDE_API_KEY') || '',
      gemini: props.getProperty('GEMINI_API_KEY') || ''
    };
    tmpl.currentModel = props.getProperty('AI_MODEL') || 'gpt-5-nano';
    tmpl.currentSheetName = props.getProperty('SHEET_NAME') || 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ';
    tmpl.currentProfitCalculationMethod = props.getProperty('PROFIT_CALC_METHOD') || 'RATE';
    tmpl.currentPromptId = props.getProperty('PROMPT_ID') || 'EBAY_FULL_LISTING_PROMPT';
    tmpl.currentShippingThreshold = props.getProperty('SHIPPING_THRESHOLD') || '20000';
    tmpl.currentShippingCalculationMethod = props.getProperty('SHIPPING_CALC_METHOD') || 'TABLE';
    tmpl.currentLowPriceMethod = props.getProperty('LOW_PRICE_SHIPPING_METHOD') || 'NONE';
    tmpl.currentHighPriceMethod = props.getProperty('HIGH_PRICE_SHIPPING_METHOD') || 'CF';
    tmpl.currentShowPopups = props.getProperty('SHOW_POPUPS') || 'false';
    
    // DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã®è¨­å®šå¤‰æ•°
    tmpl.currentDduAdjustmentEnabled = props.getProperty('DDU_ADJUSTMENT_ENABLED') || 'false';
    tmpl.currentDduThreshold = props.getProperty('DDU_THRESHOLD') || '1500';
    tmpl.currentDduAdjustment = props.getProperty('DDU_ADJUSTMENT_AMOUNT') || '310';
    
    // ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰è¨­å®š
    tmpl.currentPriceDisplayMode = props.getProperty('PRICE_DISPLAY_MODE') || 'NORMAL';
    
    // ===== âœ… é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®šã®è¦å®šå€¤ã‚’è©³ç´°ã«è¨­å®š =====
    var duplicateSettings = getDuplicateCheckSettings();
    var workSheetName = props.getProperty('SHEET_NAME') || 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ';
    
    // åŸºæœ¬è¨­å®š
    tmpl.currentDuplicateCheckEnabled = props.getProperty('DUPLICATE_CHECK_ENABLED') || 'false';
    tmpl.currentDuplicateSourceSheet = props.getProperty('DUPLICATE_SOURCE_SHEET') || workSheetName;
    tmpl.currentDuplicateSourceColumn = props.getProperty('DUPLICATE_SOURCE_COLUMN') || 'H';
    
    // å¯¾è±¡ã‚·ãƒ¼ãƒˆï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ2ã¤ï¼‰
    var savedTargets = props.getProperty('DUPLICATE_TARGET_SHEETS');
    if (savedTargets) {
      tmpl.currentDuplicateTargetSheets = savedTargets;
    } else {
      // åˆå›ã¯è¦å®šå€¤ã‚’è¨­å®š
      var defaultTargets = [
        { sheet: 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿_*', column: 'H' },
        { sheet: 'EAFGLEå•†å“ä¸€è¦§', column: 'A' }
      ];
      tmpl.currentDuplicateTargetSheets = JSON.stringify(defaultTargets);
    }
    
    // ã‚·ãƒ¼ãƒˆé©ç”¨è¨­å®š
    tmpl.currentDuplicateApplyToSheet = props.getProperty('DUPLICATE_APPLY_TO_SHEET') || 'true';  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§ãƒã‚§ãƒƒã‚¯
    tmpl.currentDuplicateOutputSheet = props.getProperty('DUPLICATE_OUTPUT_SHEET') || workSheetName;
    tmpl.currentDuplicateOutputColumn = props.getProperty('DUPLICATE_OUTPUT_COLUMN') || 'AF';
    tmpl.currentDuplicateOutputStartRow = props.getProperty('DUPLICATE_OUTPUT_START_ROW') || '5';
    tmpl.currentDuplicateOutputRange = props.getProperty('DUPLICATE_OUTPUT_RANGE') || 'DATA';
    
    // æ—¢å­˜ã®é¸æŠè‚¢
    tmpl.lowPriceOptions = CONFIG.SHIPPING_METHOD_OPTIONS.lowPrice;
    tmpl.highPriceOptions = CONFIG.SHIPPING_METHOD_OPTIONS.highPrice;
    tmpl.promptIds = getAllPromptIds();
    
    var html = tmpl.evaluate().setWidth(800).setHeight(900);
    ui.showModalDialog(html, 'åˆæœŸè¨­å®šï¼ˆçµ±åˆç‰ˆï¼‰');
  } catch (e) {
    showAlert('åˆæœŸè¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
  }
}

/**
 * é–¢ç¨ç‡ã«å¿œã˜ãŸå®ŸåŠ¹é–¾å€¤ã‚’è¨ˆç®—ï¼ˆã‚»ãƒ«å€¤ä½¿ç”¨ç‰ˆï¼‰
 * @param {number} baseThreshold - åŸºæº–é–¾å€¤ï¼ˆ15%æƒ³å®šï¼‰
 * @param {Sheet} sheet - ä½œæ¥­ã‚·ãƒ¼ãƒˆ
 * @param {number} targetRate - ç¢ºèªã—ãŸã„é–¢ç¨ç‡ï¼ˆçœç•¥æ™‚ã¯AD2ã‚»ãƒ«ã®å€¤ã‚’ä½¿ç”¨ï¼‰
 * @return {number} å®ŸåŠ¹é–¾å€¤
 */
function calculateEffectiveThreshold(baseThreshold, sheet, targetRate) {
  var BASE_RATE = 0.15;  // åŸºæº–é–¢ç¨ç‡ï¼ˆå›ºå®šï¼‰
  
  // ã‚»ãƒ«ã‹ã‚‰å€¤ã‚’å–å¾—
  var safetyFactor = Number(sheet.getRange('AE2').getValue()) || 1.35;
  var customsFee = Number(sheet.getRange('AC1').getValue()) || 10;
  
  // targetRateãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€AD2ã‚»ãƒ«ã‹ã‚‰å–å¾—
  if (typeof targetRate === 'undefined' || targetRate === null) {
    targetRate = Number(sheet.getRange('AD2').getValue()) || 0.15;
  }
  
  // äºŒåˆ†æ¢ç´¢ã§è§£ã‚’æ±‚ã‚ã‚‹
  var low = 0;
  var high = baseThreshold;
  var epsilon = 0.1;
  
  while (high - low > epsilon) {
    var mid = (low + high) / 2;
    
    var baseEstimatedTax = mid * BASE_RATE * safetyFactor + customsFee;
    var currentEstimatedTax = mid * targetRate * safetyFactor + customsFee;
    var shippingDiff = Math.floor((currentEstimatedTax - baseEstimatedTax) / 5) * 5;
    var priceBandAdjustment = shippingDiff * 5;
    var adjustedPrice = mid + priceBandAdjustment;
    
    if (adjustedPrice < baseThreshold) {
      low = mid;
    } else {
      high = mid;
    }
  }
  
  return Math.round(low);
}

/**
 * é–¢ç¨ç‡ã«å¿œã˜ãŸå®ŸåŠ¹é–¾å€¤ã‚’è¨ˆç®—ï¼ˆã‚»ãƒ«å€¤ä½¿ç”¨ç‰ˆï¼‰
 * @param {number} baseThreshold - åŸºæº–é–¾å€¤ï¼ˆ15%æƒ³å®šï¼‰
 * @param {Sheet} sheet - ä½œæ¥­ã‚·ãƒ¼ãƒˆ
 * @param {number} targetRate - ç¢ºèªã—ãŸã„é–¢ç¨ç‡ï¼ˆçœç•¥æ™‚ã¯AD2ã‚»ãƒ«ã®å€¤ã‚’ä½¿ç”¨ï¼‰
 * @return {number} å®ŸåŠ¹é–¾å€¤
 */
function calculateEffectiveThreshold(baseThreshold, sheet, targetRate) {
  var BASE_RATE = 0.15;  // åŸºæº–é–¢ç¨ç‡ï¼ˆå›ºå®šï¼‰
  
  // ã‚»ãƒ«ã‹ã‚‰å€¤ã‚’å–å¾—
  var safetyFactor = Number(sheet.getRange('AE2').getValue()) || 1.35;
  var customsFee = Number(sheet.getRange('AC1').getValue()) || 10;
  
  // targetRateãŒçœç•¥ã•ã‚ŒãŸå ´åˆã€AD2ã‚»ãƒ«ã‹ã‚‰å–å¾—
  if (typeof targetRate === 'undefined' || targetRate === null) {
    targetRate = Number(sheet.getRange('AD2').getValue()) || 0.15;
  }
  
  // äºŒåˆ†æ¢ç´¢ã§è§£ã‚’æ±‚ã‚ã‚‹
  var low = 0;
  var high = baseThreshold;
  var epsilon = 0.1;
  
  while (high - low > epsilon) {
    var mid = (low + high) / 2;
    
    var baseEstimatedTax = mid * BASE_RATE * safetyFactor + customsFee;
    var currentEstimatedTax = mid * targetRate * safetyFactor + customsFee;
    var shippingDiff = Math.floor((currentEstimatedTax - baseEstimatedTax) / 5) * 5;
    var priceBandAdjustment = shippingDiff * 5;
    var adjustedPrice = mid + priceBandAdjustment;
    
    if (adjustedPrice < baseThreshold) {
      low = mid;
    } else {
      high = mid;
    }
  }
  
  return Math.round(low);
}

/**
 * ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ç”¨ï¼ˆHTMLã‹ã‚‰å‘¼ã³å‡ºã—ï¼‰
 * @param {number} baseThreshold - åŸºæº–é–¾å€¤ï¼ˆä¾‹: 900ï¼‰
 * @param {number} targetRatePercent - ç¢ºèªã—ãŸã„é–¢ç¨ç‡ï¼ˆ%ã€ä¾‹: 39ï¼‰
 * @return {Object} å®ŸåŠ¹é–¾å€¤ã®æƒ…å ±
 */
function calculateEffectiveThresholdForSimulation(baseThreshold, targetRatePercent) {
  try {
    var settings = getSettings();
    if (!settings) {
      return { 
        success: false, 
        error: 'è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
        effectiveThreshold: 0 
      };
    }
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      return { 
        success: false, 
        error: 'ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“',
        effectiveThreshold: 0 
      };
    }
    
    // ãƒ‘ãƒ¼ã‚»ãƒ³ãƒˆã‚’å°æ•°ã«å¤‰æ›
    var targetRate = targetRatePercent / 100;
    
    var effectiveThreshold = calculateEffectiveThreshold(baseThreshold, sheet, targetRate);
    var difference = baseThreshold - effectiveThreshold;
    
    return {
      success: true,
      effectiveThreshold: effectiveThreshold,
      baseThreshold: baseThreshold,
      targetRate: targetRatePercent,
      difference: difference
    };
    
  } catch (e) {
    return { 
      success: false, 
      error: e.message,
      effectiveThreshold: 0 
    };
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  è¨­å®šèª­ã¿è¾¼ã¿ï¼†æ¤œè¨¼ï¼ˆä¸è¶³æ™‚ã¯ null è¿”å´ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function ensureSurchargeCellsOnWorkSheet() {
  var props = PropertiesService.getScriptProperties();
  var sheetName = props.getProperty('SHEET_NAME') || 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ';
  var sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
  if (!sh) return;
  
  function safeSetNote(range, note) {
    if (note && typeof note === 'string' && note.trim()) {
      range.setNote(note);
    }
  }
  
  // é–¢ç¨ç‡ï¼ˆAC2â†’AD2ï¼‰
  if (!sh.getRange('AD2').getNote()) {
    safeSetNote(sh.getRange('AD2'), 'é–¢ç¨ç‡ï¼ˆä¾‹: 0.2 = 20%ï¼‰');
  }
  
  // å®‰å…¨ä¿‚æ•°ï¼ˆAD2â†’AE2ï¼‰
  if (!sh.getRange('AE2').getNote()) {
    safeSetNote(sh.getRange('AE2'), 'é–¢ç¨å®‰å…¨ä¿‚æ•°ï¼ˆä¾‹: 1.1 = 10%ä¸Šä¹—ã›ï¼‰');
  }
  
  // é€šé–¢æ‰‹æ•°æ–™ï¼ˆAB1â†’AC1ï¼‰
  if (!sh.getRange('AC1').getNote()) {
    safeSetNote(sh.getRange('AC1'), 'é€šé–¢æ‰‹æ•°æ–™ï¼ˆUSDï¼‰ï¼ˆä¾‹: 10ï¼‰');
  }
  
  // U1â†’V1, U2â†’V2
  if (!sh.getRange('V1').getNote()) {
    safeSetNote(sh.getRange('V1'), 'FedExç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ç‡ï¼ˆä¾‹: 0.2 = 20%ï¼‰');
  }
  if (!sh.getRange('V2').getNote()) {
    safeSetNote(sh.getRange('V2'), 'DHLç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ç‡ï¼ˆä¾‹: 0.18 = 18%ï¼‰');
  }
  // V2â†’W2
  if (!sh.getRange('W2').getNote()) {
    safeSetNote(sh.getRange('W2'), 'Cpasså‰²å¼•ç‡ï¼ˆä¾‹: 0.03 = 3%ï¼‰');
  }
  // X1â†’Y1, X2â†’Y2
  if (!sh.getRange('Y1').getNote()) {
    safeSetNote(sh.getRange('Y1'), 'FedEx è¿½åŠ æ–™é‡‘ï¼ˆ500gæ¯ï¼‰ã€‚ä¸è¦ãªã‚‰ 0ã€‚');
  }
  if (!sh.getRange('Y2').getNote()) {
    safeSetNote(sh.getRange('Y2'), 'DHL è¿½åŠ æ–™é‡‘ï¼ˆ500gæ¯ï¼‰ã€‚ä¸è¦ãªã‚‰ 0ã€‚');
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  è¨­å®šèª­ã¿è¾¼ã¿ï¼†æ¤œè¨¼ï¼ˆä¸è¶³æ™‚ã¯ null è¿”å´ï¼‰

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  AI ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç”Ÿæˆ & å¿œç­”è§£æ

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ–™é‡‘è¦‹ç©ï¼ˆUSDï¼‰

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  AI å‘¼ã³å‡ºã—ï¼ˆãƒªãƒˆãƒ©ã‚¤åˆ¶å¾¡ï¼‰

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  AI å‘¼ã³å‡ºã—ï¼ˆå„ç¤¾ï¼‰

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ç®¡ç†ï¼ˆè¿½åŠ ï¼‰

/**
 * å‡ºå“ç”¨ã‚·ãƒ¼ãƒˆã«ä¾¡æ ¼å¼ã‚’å‡ºåŠ›
 * @param {number} workSheetRow - ä½œæ¥­ã‚·ãƒ¼ãƒˆã®è¡Œç•ªå·
 */
// Part 1ã® updateListingSheetPrice é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„

function updateListingSheetPrice(workSheetRow) {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!workSheet) return;
    
    var listingSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å‡ºå“ç”¨ã‚·ãƒ¼ãƒˆ');
    if (!listingSheet) return;
    
    var listingRow = workSheetRow - 2; // ä½œæ¥­ã‚·ãƒ¼ãƒˆ5è¡Œç›® â†’ å‡ºå“ç”¨ã‚·ãƒ¼ãƒˆ3è¡Œç›®
    
    if (listingRow < 3) return;
    
    // 3æ¬¡å…ƒä¾¡æ ¼åˆ¤å®šãƒ­ã‚¸ãƒƒã‚¯ï¼ˆDDUèª¿æ•´ â†’ ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ â†’ ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰
    var formula = determineListingPriceFormula(settings, workSheetRow);
    
    listingSheet.getRange(listingRow, 8).setFormula(formula); // Håˆ—ã«å‡ºåŠ›ï¼ˆå¤‰æ›´ãªã—ï¼‰
    
  } catch (e) {
    console.error('å‡ºå“ã‚·ãƒ¼ãƒˆä¾¡æ ¼åæ˜ ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

// determineListingPriceFormulaé–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£

function determineListingPriceFormula(settings, workSheetRow) {
  try {
    var sheetName = settings.sheetName;
    var priceMode = getPriceDisplayMode();
    
    // DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ãŒæœ‰åŠ¹ ã‹ã¤ ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ãŒNORMALï¼ˆDDUï¼‰ã®å ´åˆã®ã¿AEåˆ—ã‚’è€ƒæ…®
    // âš ï¸ ADâ†’AEåˆ—
    if (settings.dduAdjustmentEnabled && priceMode !== 'TAX_INCLUDED') {
      var dduFormula = "=IF(AND(NOT(ISBLANK('" + sheetName + "'!AE" + workSheetRow + ")), " +
                       "ISNUMBER('" + sheetName + "'!AE" + workSheetRow + ")), " +
                       "'" + sheetName + "'!AE" + workSheetRow + ", " +
                       getStandardPriceFormula(settings, workSheetRow) + ")";
      // ADâ†’AEï¼ˆDDUèª¿æ•´ä¾¡æ ¼ï¼‰
      return dduFormula;
    }
    
    // DDUæ©Ÿèƒ½ç„¡åŠ¹æ™‚ ã¾ãŸã¯ DDPï¼ˆé–¢ç¨è¾¼ã¿ï¼‰ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯å¾“æ¥ã®ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
    return getStandardPriceFormula(settings, workSheetRow);
    
  } catch (e) {
    console.error('ä¾¡æ ¼å¼æ±ºå®šã‚¨ãƒ©ãƒ¼: ' + e.message);
    return "'" + settings.sheetName + "'!R" + workSheetRow;  // Qâ†’Råˆ—
  }
}

// ğŸ†• æ¨™æº–ä¾¡æ ¼å¼ã‚’å–å¾—ã™ã‚‹é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
// getStandardPriceFormula é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„

function getStandardPriceFormula(settings, workSheetRow) {
  var sheetName = settings.sheetName;
  var mode = getPriceDisplayMode();
  
  if (mode === 'TAX_INCLUDED') {
    // é–¢ç¨è¾¼ã¿ä¾¡æ ¼ãƒ¢ãƒ¼ãƒ‰ â†’ Såˆ—ã‚’å‚ç…§ï¼ˆRâ†’Sï¼‰
    return "'" + sheetName + "'!S" + workSheetRow;  // Râ†’S
  } else {
    // é€šå¸¸ä¾¡æ ¼ãƒ¢ãƒ¼ãƒ‰ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆï¼‰ â†’ Råˆ—ã‚’å‚ç…§ï¼ˆQâ†’Rï¼‰
    return "'" + sheetName + "'!R" + workSheetRow;  // Qâ†’R
  }
}

// ğŸ†• DDUä¾¡æ ¼èª¿æ•´é©ç”¨çŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
function checkDduAdjustmentStatus(workSheetRow) {
  try {
    var settings = getSettings();
    if (!settings || !settings.dduAdjustmentEnabled) {
      return { applied: false, reason: 'DDUæ©Ÿèƒ½ç„¡åŠ¹' };
    }
    
    var workSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!workSheet) {
      return { applied: false, reason: 'ä½œæ¥­ã‚·ãƒ¼ãƒˆæœªç™ºè¦‹' };
    }
    
    // âš ï¸ åˆ—å‚ç…§ã®ä¿®æ­£
    var dduPrice = Number(workSheet.getRange(workSheetRow, CONFIG.COLUMNS.PRICE).getValue());  // 17â†’18
    var ddpPrice = Number(workSheet.getRange(workSheetRow, CONFIG.COLUMNS.TAX_INCLUDED_PRICE).getValue());  // 18â†’19
    var adjustedPrice = workSheet.getRange(workSheetRow, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE).getValue();  // 30â†’31
    
    if (isNaN(dduPrice) || dduPrice < settings.dduThreshold) {
      return { 
        applied: false, 
        reason: 'DDUä¾¡æ ¼(' + dduPrice + ')ãŒé–¾å€¤(' + settings.dduThreshold + ')æœªæº€',
        dduPrice: dduPrice,
        threshold: settings.dduThreshold
      };
    }
    
    if (!adjustedPrice || adjustedPrice === '' || isNaN(Number(adjustedPrice))) {
      return { 
        applied: false, 
        reason: 'AEåˆ—ã«æœ‰åŠ¹ãªèª¿æ•´ä¾¡æ ¼ãŒãªã„',  // ADâ†’AE
        dduPrice: dduPrice,
        ddpPrice: ddpPrice
      };
    }
    
    return { 
      applied: true, 
      reason: 'DDUä¾¡æ ¼èª¿æ•´é©ç”¨',
      dduPrice: dduPrice,
      ddpPrice: ddpPrice,
      adjustedPrice: Number(adjustedPrice),
      savings: ddpPrice - Number(adjustedPrice)
    };
    
  } catch (e) {
    return { applied: false, reason: 'ãƒã‚§ãƒƒã‚¯å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e.message };
  }
}

// Part 5ã«ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆé–¢æ•°ã‚’è¿½åŠ ã—ã¦ãã ã•ã„

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆé–¢æ•°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * ãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
 */
function setupTestData(sheet, row, settings) {
  try {
    // ãƒ†ã‚¹ãƒˆç”¨ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®š
    sheet.getRange(row, CONFIG.COLUMNS.COST_YEN).setValue(50000);     // 9ï¼ˆå¤‰æ›´ãªã—ï¼‰
    sheet.getRange(row, CONFIG.COLUMNS.JP_TITLE).setValue('DDUãƒ†ã‚¹ãƒˆå•†å“');  // 10ï¼ˆå¤‰æ›´ãªã—ï¼‰
    sheet.getRange(row, CONFIG.COLUMNS.JP_DESC).setValue('DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆç”¨å•†å“ã§ã™');  // 11ï¼ˆå¤‰æ›´ãªã—ï¼‰
    
    // é‡é‡ãƒ»ã‚µã‚¤ã‚ºè¨­å®šï¼ˆé€æ–™è¨ˆç®—ç”¨ï¼‰ï¼ˆå¤‰æ›´ãªã—ï¼‰
    sheet.getRange('J2').setValue(1000);
    sheet.getRange('L2').setValue(30);
    sheet.getRange('M2').setValue(25);
    sheet.getRange('N2').setValue(20);
    
    setFormulas(sheet, row, settings);
    
    console.log('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®šå®Œäº†: è¡Œ' + row);
    
  } catch (e) {
    console.error('ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

/**
 * ãƒ†ã‚¹ãƒˆçµæœã‚’æ¤œè¨¼
 */
function verifyTestResults(sheet, row, settings) {
  try {
    // âš ï¸ åˆ—å‚ç…§ã®ä¿®æ­£
    var dduPrice = Number(sheet.getRange(row, CONFIG.COLUMNS.PRICE).getValue());  // 17â†’18
    var ddpPrice = Number(sheet.getRange(row, CONFIG.COLUMNS.TAX_INCLUDED_PRICE).getValue());  // 18â†’19
    var adjustedPrice = sheet.getRange(row, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE).getValue();  // 30â†’31
    
    var report = '';
    var success = false;
    
    report += 'Råˆ—ï¼ˆDDUä¾¡æ ¼ï¼‰: $' + dduPrice.toFixed(2) + '\n';  // Qâ†’R
    report += 'Såˆ—ï¼ˆDDPä¾¡æ ¼ï¼‰: $' + ddpPrice.toFixed(2) + '\n';  // Râ†’S
    
    if (dduPrice >= settings.dduThreshold) {
      report += 'é–¾å€¤åˆ¤å®š: OK ($' + dduPrice.toFixed(2) + ' >= $' + settings.dduThreshold + ')\n';
      
      if (adjustedPrice && !isNaN(Number(adjustedPrice))) {
        var expectedPrice = ddpPrice - settings.dduAdjustmentAmount;
        var actualPrice = Number(adjustedPrice);
        
        report += 'AEåˆ—ï¼ˆèª¿æ•´ä¾¡æ ¼ï¼‰: $' + actualPrice.toFixed(2) + '\n';  // ADâ†’AE
        report += 'æœŸå¾…å€¤: $' + expectedPrice.toFixed(2) + '\n';
        
        if (Math.abs(actualPrice - expectedPrice) < 0.01) {
          report += 'è¨ˆç®—çµæœ: âœ… æ­£ç¢º\n';
          success = true;
        } else {
          report += 'è¨ˆç®—çµæœ: âŒ ä¸æ­£ç¢ºï¼ˆå·®ç•°: $' + (actualPrice - expectedPrice).toFixed(2) + 'ï¼‰\n';
        }
      } else {
        report += 'AEåˆ—ï¼ˆèª¿æ•´ä¾¡æ ¼ï¼‰: âŒ å€¤ãªã—\n';  // ADâ†’AE
      }
    } else {
      report += 'é–¾å€¤åˆ¤å®š: å¯¾è±¡å¤– ($' + dduPrice.toFixed(2) + ' < $' + settings.dduThreshold + ')\n';
      if (!adjustedPrice || adjustedPrice === '') {
        report += 'AEåˆ—ï¼ˆèª¿æ•´ä¾¡æ ¼ï¼‰: âœ… ç©ºç™½ï¼ˆæ­£å¸¸ï¼‰\n';  // ADâ†’AE
        success = true;
      } else {
        report += 'AEåˆ—ï¼ˆèª¿æ•´ä¾¡æ ¼ï¼‰: âŒ å€¤ã‚ã‚Šï¼ˆç•°å¸¸ï¼‰\n';  // ADâ†’AE
      }
    }
    
    return { report: report, success: success };
    
  } catch (e) {
    return { 
      report: 'ãƒ†ã‚¹ãƒˆçµæœæ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + e.message + '\n', 
      success: false 
    };
  }
}

/**
 * å‡ºå“ã‚·ãƒ¼ãƒˆã¸ã®åæ˜ ã‚’ãƒ†ã‚¹ãƒˆ
 */
function testListingSheetReflection(workSheetRow, settings) {
  try {
    var listingSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('å‡ºå“ç”¨ã‚·ãƒ¼ãƒˆ');
    if (!listingSheet) {
      return 'å‡ºå“ç”¨ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚ãƒ†ã‚¹ãƒˆã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚\n';
    }
    
    updateListingSheetPrice(workSheetRow);
    SpreadsheetApp.flush();
    Utilities.sleep(300);
    
    var listingRow = workSheetRow - 2;
    var listingFormula = listingSheet.getRange(listingRow, 8).getFormula();  // Håˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var listingValue = listingSheet.getRange(listingRow, 8).getValue();
    
    var report = '';
    report += 'å‡ºå“ã‚·ãƒ¼ãƒˆè¡Œ: ' + listingRow + '\n';
    report += 'è¨­å®šã•ã‚ŒãŸæ•°å¼: ' + listingFormula + '\n';
    report += 'è¨ˆç®—çµæœ: $' + (typeof listingValue === 'number' ? listingValue.toFixed(2) : listingValue) + '\n';
    
    // âš ï¸ åˆ—å‚ç…§ã®ä¿®æ­£ï¼šADâ†’AE
    if (settings.dduAdjustmentEnabled && listingFormula.indexOf('AE' + workSheetRow) !== -1) {
      report += 'ä¾¡æ ¼åæ˜ : âœ… DDUèª¿æ•´ä¾¡æ ¼ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã™\n';
    } else if (listingFormula.indexOf('S' + workSheetRow) !== -1) {  // Râ†’S
      report += 'ä¾¡æ ¼åæ˜ : ğŸ“Š é–¢ç¨è¾¼ã¿ä¾¡æ ¼ï¼ˆSåˆ—ï¼‰ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã™\n';
    } else if (listingFormula.indexOf('R' + workSheetRow) !== -1) {  // Qâ†’R
      report += 'ä¾¡æ ¼åæ˜ : ğŸ“Š è²©å£²ä¾¡æ ¼ï¼ˆRåˆ—ï¼‰ãŒé©ç”¨ã•ã‚Œã¦ã„ã¾ã™\n';
    } else {
      report += 'ä¾¡æ ¼åæ˜ : â“ ä¸æ˜ãªæ•°å¼ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã™\n';
    }
    
    return report;
    
  } catch (e) {
    return 'å‡ºå“ã‚·ãƒ¼ãƒˆåæ˜ ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message + '\n';
  }
}

/**
 * DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã®è¨­å®šçŠ¶æ³ç¢ºèª
 */
function checkDduAdjustmentSettings() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var props = PropertiesService.getScriptProperties();
    
    var report = 'DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ è¨­å®šçŠ¶æ³:\n\n';
    
    report += 'ã€åŸºæœ¬è¨­å®šã€‘\n';
    report += 'æ©Ÿèƒ½æœ‰åŠ¹: ' + (settings.dduAdjustmentEnabled ? 'ON' : 'OFF') + '\n';
    report += 'DDUé–¾å€¤: $' + settings.dduThreshold + '\n';
    report += 'èª¿æ•´é¡: $' + settings.dduAdjustmentAmount + '\n\n';
    
    report += 'ã€ä¿å­˜ã•ã‚Œã¦ã„ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã€‘\n';
    report += 'DDU_ADJUSTMENT_ENABLED: ' + (props.getProperty('DDU_ADJUSTMENT_ENABLED') || 'æœªè¨­å®š') + '\n';
    report += 'DDU_THRESHOLD: ' + (props.getProperty('DDU_THRESHOLD') || 'æœªè¨­å®š') + '\n';
    report += 'DDU_ADJUSTMENT_AMOUNT: ' + (props.getProperty('DDU_ADJUSTMENT_AMOUNT') || 'æœªè¨­å®š') + '\n\n';
    
    report += 'ã€CONFIGè¨­å®šã€‘\n';
    report += 'DDU_ADJUSTED_PRICEåˆ—: ' + CONFIG.COLUMNS.DDU_ADJUSTED_PRICE + 'åˆ—ç›®ï¼ˆAEåˆ—ï¼‰\n';  // ADâ†’AE
    report += 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé–¾å€¤: $' + CONFIG.DDU_PRICE_ADJUSTMENT.DEFAULT_THRESHOLD + '\n';
    report += 'ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆèª¿æ•´é¡: $' + CONFIG.DDU_PRICE_ADJUSTMENT.DEFAULT_ADJUSTMENT + '\n';
    report += 'ãƒã‚¤ãƒ©ã‚¤ãƒˆè‰²: ' + (CONFIG.DDU_PRICE_ADJUSTMENT.HIGHLIGHT_COLOR || 'æœªè¨­å®š') + '\n\n';
    
    if (!settings.dduAdjustmentEnabled) {
      report += 'ğŸ’¡ æ©Ÿèƒ½ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã«ã¯:\n';
      report += 'ã€ŒåˆæœŸè¨­å®šã€â†’ã€ŒDDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã€ã‚’ONã«ã—ã¦ãã ã•ã„ã€‚\n';
    } else {
      report += 'âœ… æ©Ÿèƒ½ã¯æœ‰åŠ¹ã§ã™ã€‚ã€ŒDDUãƒ†ã‚¹ãƒˆå®Ÿè¡Œã€ã§å‹•ä½œç¢ºèªã§ãã¾ã™ã€‚\n';
    }
    
    showAlert(report, 'info');
    
  } catch (e) {
    showAlert('è¨­å®šç¢ºèªã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/******************************************************
 * å®Œå…¨ç‰ˆï¼ˆã‚¨ãƒ©ãƒ¼ä¿®æ­£æ¸ˆã¿ï¼‰Part 2/5
 *  - é€æ–™ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆQ1/Q2/R2/T1/T2 ã‚’ä½œæ¥­ã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ï¼‰
 *  - Airmail ã¯ Shipping_Rates ã® I/J åˆ—ã®ã¿ã‚’å‚ç…§
 *  - USå®›ã¦å‰æã®ã¾ã¾ï¼ˆã‚¾ãƒ¼ãƒ³åˆ†å²ãªã—ï¼‰
 *  - UDF: SHIPPING_COSTï¼ˆæ•°å€¤ã®ã¿è¿”ã™ï¼è¶…éæ™‚ 999999ï¼‰
 *  - ã‚»ãƒ«æ›¸ãè¾¼ã¿ãƒ»æ•°å¼ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆ
 ******************************************************/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸/è¿½åŠ 500g/å‰²å¼•ï¼ˆä½œæ¥­ã‚·ãƒ¼ãƒˆã® Q1/Q2/R2/T1/T2ï¼‰


/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é…é€ãƒ¡ã‚½ãƒƒãƒ‰è£œåŠ©

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ–™é‡‘è¡¨å‚ç…§ + ãƒ­ã‚¸ãƒƒã‚¯

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  è‡ªå‹•/æ‰‹å‹•ãƒ¡ã‚½ãƒƒãƒ‰é¸å®šï¼ˆUSå®›ã¦å‰æï¼‰


/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ã€ä¿®æ­£4ã€‘calculateSpecificMethodRateã«eLogisticsè¿½åŠ 



/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  UDFï¼šSHIPPING_COSTï¼ˆæ•°å€¤ã®ã¿è¿”ã™ï¼‰

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  å•†å“çŠ¶æ…‹ã®æ¤œè¨¼ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆå‡¦ç†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function validateAndHighlightCondition(sheet, row, condition) {
  var conditionCell = sheet.getRange(row, CONFIG.COLUMNS.CONDITION);
  var validConditions = CONFIG.CONDITION_OPTIONS;
  
  if (!condition || !validConditions.includes(condition)) {
    conditionCell.setValue("ã‚¨ãƒ©ãƒ¼");
    conditionCell.setBackground("#ffcdd2");
    conditionCell.setNote("å•†å“çŠ¶æ…‹ã‚’åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚");
    return false;
  }
  
  conditionCell.setValue(condition);
  
  if (condition === "ã‚¨ãƒ©ãƒ¼") {
    conditionCell.setBackground("#ffcdd2");
    conditionCell.setNote("å•†å“çŠ¶æ…‹ã®åˆ¤å®šãŒå›°é›£ã§ã™ã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚");
  } else {
    conditionCell.setBackground(null);
    conditionCell.setNote("");
  }
  
  return true;
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  eBayã‚«ãƒ†ã‚´ãƒªãƒ¼ã®æ¤œè¨¼å‡¦ç†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function validateAndSetEbayCategory(sheet, row, ebayCategory) {
  var categoryCell = sheet.getRange(row, CONFIG.COLUMNS.EBAY_CATEGORY);  // 29â†’30
  var validCategories = CONFIG.EBAY_CATEGORIES;
  
  if (!ebayCategory || !validCategories.includes(ebayCategory)) {
    categoryCell.setValue("Other");
    categoryCell.setNote("ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒåˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚Otherã«è¨­å®šã—ã¦ã„ã¾ã™ã€‚");
  } else {
    categoryCell.setValue(ebayCategory);
    categoryCell.setNote("");
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ã‚·ãƒ¼ãƒˆæ›¸ãè¾¼ã¿ãƒ»æ•°å¼ãƒ»ãƒã‚¤ãƒ©ã‚¤ãƒˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function setCellValues(sheet, row, values) {
  var updates = [
    [row, CONFIG.COLUMNS.WEIGHT, values.weight],      // 24â†’25
    [row, CONFIG.COLUMNS.SIZE, values.size],          // 25â†’26
    [row, CONFIG.COLUMNS.METHOD, values.method],      // 23â†’24
    [row, CONFIG.COLUMNS.EN_TITLE, values.title],     // 13ï¼ˆå¤‰æ›´ãªã—ï¼‰
    [row, CONFIG.COLUMNS.EN_DESC, values.description] // 14ï¼ˆå¤‰æ›´ãªã—ï¼‰
  ];
  
  for (var i = 0; i < updates.length; i++) {
    var u = updates[i];
    sheet.getRange(u[0], u[1]).setValue(u[2]);
  }
  
  // å•†å“çŠ¶æ…‹ã®è¨­å®šã¨ãƒã‚¤ãƒ©ã‚¤ãƒˆ
  if (values.condition) {
    validateAndHighlightCondition(sheet, row, values.condition);  // 28â†’29
  }
}

// Part 2ã® setFormulas é–¢æ•°ã‚’ä»¥ä¸‹ã®ã‚ˆã†ã«ä¿®æ­£ã—ã¦ãã ã•ã„

function setFormulas(sheet, row, settings) {
  // ä¾å­˜ã‚»ãƒ«ã‚’å…ˆã«èª­ã¿è¾¼ã‚“ã§è¨ˆç®—ã‚’ãƒˆãƒªã‚¬ãƒ¼
  sheet.getRange("AD2").getValue();  // é–¢ç¨ç‡
  sheet.getRange("AE2").getValue();  // å®‰å…¨ä¿‚æ•°
  sheet.getRange("AC1").getValue();  // é€šé–¢æ‰‹æ•°æ–™
  sheet.getRange("C2").getValue();   // ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ
  SpreadsheetApp.flush();
  var feeRate = sheet.getRange("F1").getValue() || 0;  // å¤‰æ›´ãªã—
  var adRate  = sheet.getRange("F2").getValue() || 0;  // å¤‰æ›´ãªã—
  
  sheet.getRange(row, CONFIG.COLUMNS.FEE).setValue(feeRate);  // 21â†’22
  
  if (settings.profitCalculationMethod === 'RATE') {
    // åˆ©ç›Šç‡ãƒ¢ãƒ¼ãƒ‰
    var profitRate = sheet.getRange("H2").getValue() || 0;  // å¤‰æ›´ãªã—
    sheet.getRange(row, CONFIG.COLUMNS.RATE).setValue(profitRate);  // 22â†’23
    
    // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£
    sheet.getRange(row, CONFIG.COLUMNS.PRICE).setFormula(  // 17â†’18
     '=ROUND(((I' + row + '+T' + row + ')/(1-(V' + row + '+W' + row + '+$F$2+$Z$2))/$C$2)*100)/100'
     // (ä»•å…¥ã‚Œå€¤+é€æ–™) Ã· (1-(æ‰‹æ•°æ–™ç‡+åˆ©ç›Šç‡+åºƒå‘Šç‡+Payoneerç‡)) Ã· ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ
    );
    
    // âœ… åˆ©ç›Šè¨ˆç®—å¼ã‚‚åˆç®—æ–¹å¼ã«ä¿®æ­£
    sheet.getRange(row, CONFIG.COLUMNS.PROFIT).setFormula(  // 20â†’21
      '=ROUND(R' + row + '*$C$2*(1-(V' + row + '+$F$2+$Z$2)) - I' + row + ' - T' + row + ', 0)'
      // è²©å£²ä¾¡æ ¼Ã—ç‚ºæ›¿Ã—(1-(æ‰‹æ•°æ–™ç‡+åºƒå‘Šç‡+Payoneerç‡)) - ä»•å…¥ã‚Œå€¤ - é€æ–™
    );
    
  } else {
    // åˆ©ç›Šé¡ãƒ¢ãƒ¼ãƒ‰
    var costYen = sheet.getRange(row, CONFIG.COLUMNS.COST_YEN).getValue();  // å¤‰æ›´ãªã—
    var profitAmount = sheet.getRange("H1").getValue();  // å¤‰æ›´ãªã—
    if (!profitAmount || isNaN(profitAmount)) profitAmount = getProfitAmountByCost(costYen);
    
    sheet.getRange(row, CONFIG.COLUMNS.RATE).clearContent();  // 22â†’23
    sheet.getRange(row, CONFIG.COLUMNS.PROFIT).setValue(profitAmount);  // 20â†’21
  
    // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£ï¼ˆåˆ©ç›Šç‡ã¯å«ã¾ãªã„ï¼‰
    sheet.getRange(row, CONFIG.COLUMNS.PRICE).setFormula(  // 17â†’18
      '=ROUND(((I' + row + '+T' + row + '+U' + row + ')/(1-(V' + row + '+$F$2+$Z$2))/$C$2)*100)/100'
      // (ä»•å…¥ã‚Œå€¤+é€æ–™+åˆ©ç›Šé¡) Ã· (1-(æ‰‹æ•°æ–™ç‡+åºƒå‘Šç‡+Payoneerç‡)) Ã· ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ
    );
  }
  
  // ğŸ”¹ ä¿®æ­£: é–¢ç¨è¾¼ã¿ä¾¡æ ¼ã‹ã‚‰é€šé–¢æ‰‹æ•°æ–™ã‚’å‰Šé™¤
sheet.getRange(row, CONFIG.COLUMNS.TAX_INCLUDED_PRICE).setFormula(  // 18â†’19ï¼ˆSåˆ—ï¼‰
  '=ROUND(R' + row + '+AB' + row + ',2)'
  // Råˆ—ï¼ˆè²©å£²ä¾¡æ ¼ï¼‰ + ABåˆ—ï¼ˆæƒ³å®šé–¢ç¨+é€šé–¢æ‰‹æ•°æ–™ï¼‰
);
  
 // ğŸ”¹ ä¿®æ­£: æƒ³å®šé–¢ç¨ã«é€šé–¢æ‰‹æ•°æ–™ã‚’å«ã‚ã‚‹
sheet.getRange(row, CONFIG.COLUMNS.ESTIMATED_TAX).setFormula(  // 27â†’28ï¼ˆABåˆ—ï¼‰
  '=ROUND(R' + row + '*$AD$2*$AE$2+$AC$1,2)'
  // Råˆ— Ã— é–¢ç¨ç‡(AD2) Ã— å®‰å…¨ä¿‚æ•°(AE2) + é€šé–¢æ‰‹æ•°æ–™(AC1)
);
  
// DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½
  if (settings.dduAdjustmentEnabled) {
    var priceMode = getPriceDisplayMode();
    
    if (priceMode !== 'TAX_INCLUDED') {
      // DDUä¾¡æ ¼èª¿æ•´ã®è¨ˆç®—å¼ã‚’è¨­å®š
      var dduFormula = '=IF(AND(R' + row + '>=' + settings.dduThreshold + ', NOT(ISBLANK(S' + row + '))), S' + row + '-' + settings.dduAdjustmentAmount + ', "")';
      // Qâ†’Rï¼ˆDDUè²©å£²ä¾¡æ ¼ï¼‰
      // Râ†’Sï¼ˆDDPé–¢ç¨è¾¼ã¿ä¾¡æ ¼ï¼‰
      
      var dduCell = sheet.getRange(row, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE);  // 30â†’31
      
      dduCell.setFormula(dduFormula);
      dduCell.setNumberFormat('0.00');
      setDduAdjustmentHighlight(sheet, row);
    } else {
      // DDPï¼ˆé–¢ç¨è¾¼ã¿ï¼‰ãƒ¢ãƒ¼ãƒ‰ã®å ´åˆã¯ADåˆ—ã‚’ã‚¯ãƒªã‚¢
      // ACâ†’ADåˆ—
      var dduCell = sheet.getRange(row, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE);  // 30â†’31
      dduCell.clearContent();
      dduCell.setBackground(null);
      dduCell.setNumberFormat('General');
    }
  } else {
    // æ©Ÿèƒ½ç„¡åŠ¹æ™‚ã¯ADåˆ—ã‚’ã‚¯ãƒªã‚¢
    // ACâ†’ADåˆ—
    var dduCell = sheet.getRange(row, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE);  // 30â†’31
    dduCell.clearContent();
    dduCell.setBackground(null);
    dduCell.setNumberFormat('General');
  }
  
  // é€æ–™è¨ˆç®—
  if (settings.shippingCalculationMethod === 'FIXED') {
    var fixed = sheet.getRange("J1").getValue();  // å¤‰æ›´ãªã—
    if (!fixed || isNaN(fixed)) fixed = getShippingCostByCost(sheet.getRange(row, CONFIG.COLUMNS.COST_YEN).getValue());
    sheet.getRange(row, CONFIG.COLUMNS.SHIPPING).setValue(fixed);  // 19â†’20
  } else {
    sheet.getRange(row, CONFIG.COLUMNS.SHIPPING)  // 19â†’20
      .setFormula('=SHIPPING_COST(I' + row + ',Y' + row + ',AA' + row + ',X' + row + ',Z' + row + ')');
      // Iåˆ—: å¤‰æ›´ãªã—ï¼ˆä»•å…¥ã‚Œå€¤ï¼‰
      // Xâ†’Yï¼ˆå®Ÿé‡é‡ï¼‰
      // Zâ†’AAï¼ˆå®¹ç©é‡é‡ï¼‰
      // Wâ†’Xï¼ˆé…é€æ–¹æ³•ï¼‰
      // Yâ†’Zï¼ˆã‚µã‚¤ã‚ºï¼‰
  }
  
  sheet.getRange(row, CONFIG.COLUMNS.VOLUME)  // 26â†’27
    .setFormula('=MAX(ROUND((INDEX(SPLIT(Z' + row + ',"x"),1)*INDEX(SPLIT(Z' + row + ',"x"),2)*INDEX(SPLIT(Z' + row + ',"x"),3))/5),200)');
    // Yâ†’Zï¼ˆã‚µã‚¤ã‚ºï¼‰

  setPriceCellHighlight(sheet, row);
  updateListingSheetPrice(row); // ğŸ†• DDUä¾¡æ ¼ã‚‚è€ƒæ…®ã•ã‚Œã‚‹ã‚ˆã†ã«å¾Œã§ä¿®æ­£
 // ç”»é¢è¡¨ç¤ºã‚’å¼·åˆ¶æ›´æ–°
  SpreadsheetApp.flush();
  var currentCell = SpreadsheetApp.getActiveRange();
  sheet.getRange(row, 1).activate();  // è©²å½“è¡Œã®æœ€åˆã®ã‚»ãƒ«ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–åŒ–
  if (currentCell) {
    currentCell.activate();  // å…ƒã®é¸æŠç¯„å›²ã«æˆ»ã™
  }
  
}

// ğŸ†• DDUä¾¡æ ¼èª¿æ•´ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨­å®šé–¢æ•°ï¼ˆæ–°è¦è¿½åŠ ï¼‰
function setDduAdjustmentHighlight(sheet, row) {
  try {
    var dduCell = sheet.getRange(row, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE);  // 30â†’31
    
    var rule = SpreadsheetApp.newConditionalFormatRule()
      .whenFormulaSatisfied('=AND(NOT(ISBLANK(AE' + row + ')), AE' + row + '<>"", ISNUMBER(AE' + row + '))')
      // ADâ†’AEï¼ˆDDUèª¿æ•´ä¾¡æ ¼åˆ—ï¼‰
      .setBackground(CONFIG.DDU_PRICE_ADJUSTMENT.HIGHLIGHT_COLOR || '#ffe0b3')
      .setRanges([dduCell])
      .build();
    
    var existingRules = sheet.getConditionalFormatRules();
    existingRules.push(rule);
    sheet.setConditionalFormatRules(existingRules);
    
  } catch (e) {
    console.error('DDUãƒã‚¤ãƒ©ã‚¤ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message);
    try {
      sheet.getRange(row, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE).setBackground('#ffe0b3');  // 30â†’31
    } catch (e2) {}
  }
}

/** EN_DESCãƒã‚¤ãƒ©ã‚¤ãƒˆï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’å«ã‚€å ´åˆï¼‰ */
function setHighlight(sheet, row, description) {
  // ãƒã‚¤ãƒ©ã‚¤ãƒˆæ©Ÿèƒ½ã‚’ç„¡åŠ¹åŒ–
  return;
}

/** UDFãŒè¿”ã—ãŸã‚¨ãƒ©ãƒ¼ï¼ˆ999999ç›¸å½“ï¼‰ã‚’èµ¤æ–‡å­—ã« */
function formatShippingCellIfError(sheet, row) {
  SpreadsheetApp.flush();
  Utilities.sleep(200);
  var cell = sheet.getRange(row, CONFIG.COLUMNS.SHIPPING);  // 19â†’20
  var val = Number(cell.getValue());
  if (val >= 999000) {
    cell.setFontColor('#d32f2f');
    cell.setNote('é€æ–™è¨ˆç®—ã‚¨ãƒ©ãƒ¼/æœªå®šç¾©ã€‚ãƒ¬ãƒ¼ãƒˆè¡¨ã‚„å…¥åŠ›å€¤ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚');
  } else {
    cell.setFontColor(null);
    cell.setNote('');
  }
}

/** ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆã‚µã‚¤ã‚º/é‡é‡åˆ¶é™ã§Small Packetä¸å¯ â†’ FedExã¸ï¼‰ã‚’èµ¤èƒŒæ™¯ã§è¡¨ç¤º */
function markMethodFallbackIfNeeded(sheet, row, originalMethod, reason) {
  var cell = sheet.getRange(row, CONFIG.COLUMNS.METHOD);  // 23â†’24
  var note = 'ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç†ç”±: ' + reason;
  cell.setBackground('#ffebee');
  cell.setNote(note);
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  åˆ©ç›Šé¡ãƒ¬ãƒ³ã‚¸ï¼ˆProfit_Amountsï¼‰- å¿…è¦ãªé–¢æ•°ã®ã¿å…ˆã«å®šç¾©
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function getProfitAmountByCost(costYen) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var name = "Profit_Amounts";
    var sh = ss.getSheetByName(name);
    if (!sh) return 0;
    var last = sh.getLastRow();
    if (last < 2) return 0;
    var data = sh.getRange(2,1,last-1,3).getValues();
    for (var i=0;i<data.length;i++) {
      var min = data[i][0], max = data[i][1], amt = data[i][2];
      if (typeof min!=='number' || isNaN(min) || typeof amt!=='number' || isNaN(amt)) continue;
      if (costYen >= min) {
        if (max === "" || typeof max!=='number' || isNaN(max) || costYen <= max) return amt;
      }
    }
    return 0;
  } catch (e) {
    return 0;
  }
}

function getShippingCostByCost(costYen) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var name = "Profit_Amounts";
    var sh = ss.getSheetByName(name);
    if (!sh) return 0;
    var last = sh.getLastRow();
    if (last < 2) return 0;
    var data = sh.getRange(2,1,last-1,4).getValues();
    for (var i=0;i<data.length;i++) {
      var min = data[i][0], max = data[i][1], ship = data[i][3];
      if (typeof min!=='number' || isNaN(min)) continue;
      if (costYen >= min) {
        if (max === "" || typeof max!=='number' || isNaN(max) || costYen <= max) {
          return (typeof ship==='number' && !isNaN(ship)) ? ship : 0;
        }
      }
    }
    return 0;
  } catch (e) {
    return 0;
  }
}
/******************************************************
 * å®Œå…¨ç‰ˆï¼ˆã‚¨ãƒ©ãƒ¼ä¿®æ­£æ¸ˆã¿ï¼‰Part 3/5
 *  - å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ï¼ˆrunAllAuto / runSelectedRowsï¼‰
 *  - ãƒˆãƒªã‚¬ãƒ¼/çŠ¶æ…‹ç®¡ç†
 *  - ãƒˆãƒ¼ã‚¯ãƒ³è¦‹ç©ï¼ˆUSDï¼‰ãƒ©ãƒƒãƒ‘ãƒ¼
 *  - ä¸¦åˆ—å‡¦ç†ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼é–¢æ•°ï¼ˆçµ±ä¸€ç‰ˆï¼‰
 ******************************************************/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é…åˆ—ã‚’æŒ‡å®šã‚µã‚¤ã‚ºã”ã¨ã«åˆ†å‰²

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒˆãƒ¼ã‚¯ãƒ³è¦‹ç©ï¼ˆUSDï¼‰â€” å…¥å‡ºåŠ›åˆ¥ã®åˆç®—

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ä¸¦åˆ—AIå‡¦ç†ç”¨ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆçµ±ä¸€ç‰ˆãƒ»å®Œå…¨ç‰ˆï¼‰


/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é€æ–™å›ºå®šãƒ¢ãƒ¼ãƒ‰å¯¾å¿œç‰ˆï¼šapplyAIResultToRow_
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

function applyAIResultToRow_(sheet, row, settings, fields, manualWeight, manualSize, costYen) {
  if (settings.shippingCalculationMethod === 'FIXED') {
    // ğŸ”¹ ä¿®æ­£: é€æ–™å›ºå®šæ™‚ã§ã‚‚é…é€æ–¹æ³•ã¯åˆ¤å®šã™ã‚‹
    var determinedMethod = getSelectedShippingMethod(costYen, 0, 0, '');
    
    setCellValues(sheet, row, {
      weight: '',  // ç©ºæ¬„
      size: '',    // ç©ºæ¬„
      method: determinedMethod,  // é…é€æ–¹æ³•ã¯å‡ºåŠ›
      title: (fields && fields.title) || '',
      description: (fields && fields.description) || '',
      condition: (fields && fields.condition) || '',
      ebayCategory: (fields && fields.ebayCategory) || ''
    });
  } else {
    // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var weight = Number(manualWeight);
    var size = String(manualSize || '');
    if (!weight || !size) throw new Error('é‡é‡/ã‚µã‚¤ã‚ºæœªè¨­å®š');

    var volWeight = weight;
    var method = getSelectedShippingMethod(costYen, weight, volWeight, size);

    setCellValues(sheet, row, {
      weight: weight,
      size: size,
      method: method,
      title: (fields && fields.title) || '',
      description: (fields && fields.description) || '',
      condition: (fields && fields.condition) || '',
      ebayCategory: (fields && fields.ebayCategory) || ''
    });
  }

  setFormulas(sheet, row, settings);
  setHighlight(sheet, row, (fields && fields.description) || '');
  formatShippingCellIfError(sheet, row);
}

/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰ã®çµæœã‚’å‡¦ç†
 */
function handleCategorySelection(selectedCategory) {
  if (selectedCategory) {
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä¿å­˜
    saveSelectedCategory(selectedCategory);
    
    // ç›´æ¥å®Ÿè¡Œï¼ˆsetTimeoutã¯ä½¿ç”¨ä¸å¯ï¼‰
    executeTemplateUpdate();
    
  } else {
    // ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚
    showAlert('ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸã€‚', 'info');
    
    // ä¸€æ™‚ä¿å­˜ã—ãŸç¯„å›²ã‚’ã‚¯ãƒªã‚¢
    var props = PropertiesService.getScriptProperties();
    props.deleteProperty('TEMPLATE_UPDATE_START_ROW');
    props.deleteProperty('TEMPLATE_UPDATE_END_ROW');
  }
}
/**
 * å®Ÿéš›ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°å‡¦ç†ã‚’å®Ÿè¡Œ
 */
function executeTemplateUpdate() {
  try {
    var selectedCategory = getSavedCategory();
    if (!selectedCategory) {
      showAlert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warning');
      return;
    }
    
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;

    // ä¸€æ™‚ä¿å­˜ã—ãŸç¯„å›²ã‚’å–å¾—
    var props = PropertiesService.getScriptProperties();
    var startRow = parseInt(props.getProperty('TEMPLATE_UPDATE_START_ROW'));
    var endRow = parseInt(props.getProperty('TEMPLATE_UPDATE_END_ROW'));
    
    // ä¸€æ™‚ä¿å­˜ã‚’ã‚¯ãƒªã‚¢
    props.deleteProperty('TEMPLATE_UPDATE_START_ROW');
    props.deleteProperty('TEMPLATE_UPDATE_END_ROW');

    var configuredSheetName = settings.sheetName;
    var updatedCount = 0;
    var errorCount = 0;
    var skippedCount = 0;

    for (var row = startRow; row <= endRow; row++) {
      if (row < 5) {
        skippedCount++;
        continue;
      }
      
      try {
        if (setTemplateToWorkSheet(sheet, row)) {
          updatedCount++;
        } else {
          errorCount++;
        }
      } catch (e) {
        console.error('è¡Œ' + row + 'ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + e.message);
        errorCount++;
      }
    }

    // å‡¦ç†å®Œäº†å¾Œã«ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¯ãƒªã‚¢
    clearSavedCategory();

     var report = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°å®Œäº†:\n\n' +
      'å¯¾è±¡ã‚·ãƒ¼ãƒˆ: ã€Œ' + configuredSheetName + 'ã€\n' +
      'é¸æŠã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + selectedCategory + '\n' +
      'å¯¾è±¡ç¯„å›²: ' + startRow + 'ï½' + endRow + 'è¡Œ\n' +
      'æ›´æ–°æˆåŠŸ: ' + updatedCount + 'è¡Œ\n' +
      'æ›´æ–°å¤±æ•—: ' + errorCount + 'è¡Œ\n' +
      'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'è¡Œ\n\n' +
      'å¤±æ•—ã®åŸå› :\n' +
      '- ä¾¡æ ¼ï¼ˆRåˆ—ï¼‰ã€å•†å“çŠ¶æ…‹ï¼ˆACåˆ—ï¼‰ã€é…é€æ–¹æ³•ï¼ˆXåˆ—ï¼‰ãŒæœªå…¥åŠ›\n' +  // âš ï¸ ã“ã“ã ã‘å¤‰æ›´ï¼šQâ†’R, ABâ†’AC, Wâ†’X
      '- é…é€æ–¹æ³•ãŒã€Œè‡ªå‹•é¸æŠã€ã«ãªã£ã¦ã„ã‚‹\n' +
      '- å‚ç…§ãƒ‡ãƒ¼ã‚¿ã§è©²å½“ã™ã‚‹çµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚‰ãªã„';

    showAlert(report, updatedCount > 0 ? 'success' : 'warning');

  } catch (error) {
    clearSavedCategory();
    showAlert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}
/**
 * é¸æŠè¡Œã®4æ¬¡å…ƒæ¤œç´¢ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ‡ãƒãƒƒã‚°ç¢ºèª
 */
function debugSelectedRowsData() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;
    
    var range = sheet.getActiveRange();
    if (!range) {
      showAlert('ãƒ‡ãƒãƒƒã‚°ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'info');
      return;
    }
    
    var startRow = range.getRow();
    var endRow = range.getLastRow();
    var selectedCategory = getSavedCategory() || 'ã‚«ãƒ†ã‚´ãƒªãƒ¼æœªé¸æŠ';
    
    var report = 'é¸æŠè¡Œãƒ‡ãƒ¼ã‚¿ãƒ‡ãƒãƒƒã‚°:\n\n';
    report += 'é¸æŠã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + selectedCategory + '\n';
    report += 'å¯¾è±¡ç¯„å›²: ' + startRow + 'ï½' + endRow + 'è¡Œ\n\n';
    
    for (var row = Math.max(startRow, 5); row <= Math.min(endRow, startRow + 3); row++) {
      var priceUSD = sheet.getRange(row, CONFIG.COLUMNS.PRICE).getValue();  // 17â†’18
      var condition = sheet.getRange(row, CONFIG.COLUMNS.CONDITION).getValue();  // 28â†’29
      var shippingMethod = sheet.getRange(row, CONFIG.COLUMNS.METHOD).getValue();  // 23â†’24
      var shippingType = convertShippingMethodToType(String(shippingMethod || ''));
      
      report += 'ã€è¡Œ' + row + 'ã€‘\n';
      report += 'ä¾¡æ ¼(R): ' + priceUSD + ' (' + typeof priceUSD + ')\n';  // Qâ†’R
      report += 'çŠ¶æ…‹(AC): "' + condition + '" (' + typeof condition + ')\n';  // ABâ†’AC
      report += 'é…é€æ–¹æ³•(X): "' + shippingMethod + '"\n';  // Wâ†’X
      report += 'é…é€ã‚¿ã‚¤ãƒ—å¤‰æ›: "' + shippingType + '"\n';
      
      // 4æ¬¡å…ƒæ¤œç´¢ãƒ†ã‚¹ãƒˆ
      if (selectedCategory && selectedCategory !== 'ã‚«ãƒ†ã‚´ãƒªãƒ¼æœªé¸æŠ') {
        var templateResult = getTemplateFromReferenceData4D(selectedCategory, String(condition), shippingType, Number(priceUSD));
        report += 'æ¤œç´¢çµæœ: ' + (templateResult !== null ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + templateResult : 'è¦‹ã¤ã‹ã‚‰ãš') + '\n';
      }
      report += '\n';
    }
    
    if (endRow - Math.max(startRow, 5) > 3) {
      report += '... (æ®‹ã‚Š' + (endRow - Math.max(startRow, 5) - 3) + 'è¡Œã¯çœç•¥)\n';
    }
    
    showAlert(report, 'info');
    
  } catch (error) {
    showAlert('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä¿æŒã—ãŸã¾ã¾4æ¬¡å…ƒæ¤œç´¢ã‚’ãƒ†ã‚¹ãƒˆ
 */
function testTemplateSearchWithCategory() {
  try {
    // æ‰‹å‹•ã§ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’è¨­å®š
    saveSelectedCategory('ãã®ä»–');
    
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;
    
    var testRow = 5; // è¡Œ5ã§ãƒ†ã‚¹ãƒˆ
    
    // å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ã§4æ¬¡å…ƒæ¤œç´¢ã‚’ãƒ†ã‚¹ãƒˆ
    var priceUSD = sheet.getRange(testRow, CONFIG.COLUMNS.PRICE).getValue();
    var condition = sheet.getRange(testRow, CONFIG.COLUMNS.CONDITION).getValue();
    var shippingMethod = sheet.getRange(testRow, CONFIG.COLUMNS.METHOD).getValue();
    var shippingType = convertShippingMethodToType(String(shippingMethod || ''));
    var selectedCategory = getSavedCategory();
    
    var report = '4æ¬¡å…ƒæ¤œç´¢ãƒ†ã‚¹ãƒˆï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼ä¿æŒï¼‰:\n\n';
    report += 'æ¤œç´¢æ¡ä»¶:\n';
    report += 'ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + selectedCategory + '\n';
    report += 'çŠ¶æ…‹: ' + condition + '\n';
    report += 'é…é€ã‚¿ã‚¤ãƒ—: ' + shippingType + '\n';
    report += 'ä¾¡æ ¼: $' + priceUSD + '\n\n';
    
    // 4æ¬¡å…ƒæ¤œç´¢å®Ÿè¡Œ
    var templateResult = getTemplateFromReferenceData4D(selectedCategory, String(condition), shippingType, Number(priceUSD));
    
    report += 'æ¤œç´¢çµæœ: ' + (templateResult !== null ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID ' + templateResult : 'è©²å½“ãªã—') + '\n\n';
    
    if (templateResult === null) {
      report += 'è©²å½“ãªã—ã®åŸå› ç¢ºèª:\n';
      report += '- å‚ç…§ãƒ‡ãƒ¼ã‚¿ã«ã€Œãã®ä»–, ' + condition + ', ' + shippingType + ', $' + priceUSD + 'ã€ã®çµ„ã¿åˆã‚ã›ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„';
    }
    
    showAlert(report, templateResult !== null ? 'success' : 'warning');
    
    // ãƒ†ã‚¹ãƒˆå¾Œã¯ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ã‚¯ãƒªã‚¢
    clearSavedCategory();
    
  } catch (error) {
    showAlert('æ¤œç´¢ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
    clearSavedCategory();
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  å¯¾è±¡è¡Œã®æŠ½å‡ºãƒ»1è¡Œå‡¦ç†

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  è‡ªå‹•å†è©¦è¡Œæ©Ÿèƒ½ä»˜ãç¿»è¨³å‡¦ç†
  ğŸ”¹ 50è¡Œã¾ã¨ã‚ã¦ä¸¦åˆ—APIã‚³ãƒ¼ãƒ«ã¯ç¶­æŒ
  ğŸ”¹ ã‚¨ãƒ©ãƒ¼è¡Œã®ã¿ã‚’é¸æŠçš„ã«å†è©¦è¡Œ
  ğŸ”¹ ç¿»è¨³çµæœã®è‡ªå‹•æ¤œè¨¼
  ğŸ”¹ æœ€å¤§3å›ã¾ã§å†è©¦è¡Œ
  ğŸ”¹ ã‚·ãƒ¼ãƒˆã¸ã®æ›¸ãè¾¼ã¿ã¯å‘¼ã³å‡ºã—å…ƒã§å®Ÿè¡Œ
  ğŸ”¹ å‡¦ç†çŠ¶æ³ã‚’ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«è¡¨ç¤º

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é€æ–™å›ºå®šãƒ¢ãƒ¼ãƒ‰å¯¾å¿œç‰ˆï¼šprocessRow
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

function processRow(sheet, row, settings, manualWeight, manualSize) {
  try {
    var jpTitle = sheet.getRange(row, CONFIG.COLUMNS.JP_TITLE).getValue();    // 10
    var jpDesc  = sheet.getRange(row, CONFIG.COLUMNS.JP_DESC).getValue();     // 11
    var costYen = Number(sheet.getRange(row, CONFIG.COLUMNS.COST_YEN).getValue());  // 9
    if (!jpTitle || !jpDesc || !costYen) {
      return { success:false, skip:true, error:'å¿…è¦å…¥åŠ›ä¸è¶³' };
    }

    var ai = callAIWithRetry(jpTitle, jpDesc, 1, costYen, settings);
    if (!ai.success) return { success:false, error: ai.error || 'AIå¤±æ•—' };
    var data = ai.data;

    if (settings.shippingCalculationMethod === 'FIXED') {
      // ğŸ”¹ ä¿®æ­£: é€æ–™å›ºå®šæ™‚ã§ã‚‚é…é€æ–¹æ³•ã¯åˆ¤å®šã™ã‚‹
      // é‡é‡ãƒ»ã‚µã‚¤ã‚ºãŒãªã„ã®ã§ã€costYenã®ã¿ã§é…é€æ–¹æ³•ã‚’æ±ºå®š
      var determinedMethod = getSelectedShippingMethod(costYen, 0, 0, '');
      
      setCellValues(sheet, row, {
        weight: '',  // ç©ºæ¬„
        size: '',    // ç©ºæ¬„
        method: determinedMethod,  // é…é€æ–¹æ³•ã¯å‡ºåŠ›
        title: data.title || '',
        description: data.description || '',
        condition: data.condition || '',
        ebayCategory: data.ebayCategory || ''
      });
    } else {
      // æ—¢å­˜ã®ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ï¼ˆå¤‰æ›´ãªã—ï¼‰
      var weight = Number(manualWeight);
      var size = String(manualSize || '');
      if (!weight || !size) return { success: false, error: 'é‡é‡/ã‚µã‚¤ã‚ºæœªè¨­å®š' };

      var volWeight = weight;
      var method = getSelectedShippingMethod(costYen, weight, volWeight, size);

      setCellValues(sheet, row, {
        weight: weight,
        size: size,
        method: method,
        title: data.title || '',
        description: data.description || '',
        condition: data.condition || '',
        ebayCategory: data.ebayCategory || ''
      });
    }

    setFormulas(sheet, row, settings);
    setHighlight(sheet, row, data.description || '');
    formatShippingCellIfError(sheet, row);

    return {
      success: true,
      tokens_prompt: (data.usage && data.usage.prompt_tokens) || 0,
      tokens_completion: (data.usage && data.usage.completion_tokens) || 0,
      model_used: data.model_used || settings.model,
      model_fallback: !!data.model_fallback
    };
  } catch (e) {
    return { success:false, error: e.message || String(e) };
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç‚ºæ›¿æ›´æ–°

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  å®Ÿè¡Œãƒ•ãƒ­ãƒ¼ï¼šä¸€æ‹¬ & é¸æŠè¡Œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ä¿®æ­£ç‰ˆï¼šæ­£ã—ãåˆ†é›¢ã—ãŸåˆ¶å¾¡æ©Ÿèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  1. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤ºåˆ¶å¾¡ï¼ˆåˆæœŸè¨­å®šãƒ™ãƒ¼ã‚¹ï¼‰

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  2. ä½œæ¥­åœæ­¢åˆ¶å¾¡ï¼ˆD2ã‚»ãƒ« GO/STOPï¼‰

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  å…¨ä½“å®Ÿè¡Œï¼šç¿»è¨³+è¨ˆç®—ï¼ˆæœ€é©åŒ–ç‰ˆï¼‰
  ğŸ”¹ ç¿»è¨³50è¡Œä¸¦åˆ— + è¨ˆç®—50è¡Œãƒãƒƒãƒ
  ğŸ”¹ P2ã‚»ãƒ«å¯¾å¿œè¿½åŠ 
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

function runSelectedRows() {
  var SCRIPT_NAME = 'runSelectedRows';
  var props = PropertiesService.getScriptProperties();
  var startTime = new Date();

  var totalPrompt = parseInt(props.getProperty('totalPrompt') || '0');
  var totalCompletion = parseInt(props.getProperty('totalCompletion') || '0');
  var processedCount = parseInt(props.getProperty('processedCount') || '0');
  var errorCount = parseInt(props.getProperty('errorCount') || '0');
  var skippedCount = parseInt(props.getProperty('skippedCount') || '0');
  var validationErrorCount = 0;
  var allRetryDetails = [];

  var selectedRows, manualWeight, manualSize;
  var startRowIndex = parseInt(props.getProperty('lastProcessedRowIndex') || '0');

  try {
    var settings = getSettings(); 
    if (!settings) { 
      clearProcessingState(); 
      clearAllTriggers(); 
      return; 
    }
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) { 
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚','error'); 
      clearProcessingState(); 
      clearAllTriggers(); 
      return; 
    }

    var isContinuing = props.getProperty('isProcessing') === 'true' && props.getProperty('processingMode') === SCRIPT_NAME;

    if (!isContinuing) {
      clearProcessingState();
      clearAllTriggers();
      updateExchangeRate(sheet);

      var active = sheet.getActiveRange();
      if (!active) { 
        conditionalShowAlert("å‡¦ç†ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "info"); 
        return; 
      }
      var startRow = active.getRow(), endRow = active.getLastRow();
      if (endRow < 5) { 
        conditionalShowAlert("5è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚","info"); 
        return; 
      }

      // ä¸€æ‹¬èª­ã¿å–ã‚Šã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
      selectedRows = [];
      var numRows = endRow - startRow + 1;
      var dataRange = sheet.getRange(startRow, 1, numRows, CONFIG.COLUMNS.EN_DESC);
      var values = dataRange.getValues();

      for (var i = 0; i < values.length; i++) {
        var actualRow = startRow + i;
        if (actualRow < 5) { skippedCount++; continue; }

        var jpTitle = values[i][CONFIG.COLUMNS.JP_TITLE - 1];
        var jpDesc = values[i][CONFIG.COLUMNS.JP_DESC - 1];
        var costYen = Number(values[i][CONFIG.COLUMNS.COST_YEN - 1]);
        var enTitle = values[i][CONFIG.COLUMNS.EN_TITLE - 1];
        var enDesc = values[i][CONFIG.COLUMNS.EN_DESC - 1];

        if (jpTitle && jpDesc && costYen && (!enTitle || !enDesc)) {
          selectedRows.push(actualRow);
        } else {
          skippedCount++;
        }
      }
      if (selectedRows.length === 0) { 
        conditionalShowAlert("é¸æŠç¯„å›²ã«å‡¦ç†å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "info"); 
        return; 
      }

      var manualWeight = sheet.getRange("J2").getValue();
      var L = sheet.getRange("L2").getValue();
      var M = sheet.getRange("M2").getValue();
      var N = sheet.getRange("N2").getValue();

      if (settings.shippingCalculationMethod !== 'FIXED') {
        if (![manualWeight, L, M, N].every(function(v){ return typeof v === 'number' && v > 0; })) {
          showAlert('ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã§ã¯J2/L2/M2/N2ã«æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\né€æ–™å›ºå®šãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¸è¦ã§ã™ã€‚', "error"); 
          return;
        }
      } else {
        manualWeight = manualWeight || 0;
        L = L || 0;
        M = M || 0; 
        N = N || 0;
      }

      var manualSize = (L > 0 && M > 0 && N > 0) ? L + 'x' + M + 'x' + N : 'å›ºå®šé€æ–™';

      var platformNames = { openai:'OpenAI', claude:'Claude', gemini:'Gemini' };
      var confirmMessage = 'é¸æŠ ' + selectedRows.length + ' ä»¶ã‚’å‡¦ç†ã—ã¾ã™ã€‚\n\n' +
        'AI: ' + platformNames[settings.platform] + ' / ' + settings.model + '\n' +
        'æ¢±åŒ…é‡é‡: ' + manualWeight + ' g\næ¢±åŒ…ã‚µã‚¤ã‚º: ' + manualSize + '\n\n' +
        'ğŸ’¡ D2ã‚»ãƒ«ã§GO/STOPåˆ‡ã‚Šæ›¿ãˆå¯èƒ½\n' +
        'ğŸ’¡ ç¿»è¨³25è¡Œä¸¦åˆ— + è¨ˆç®—25è¡Œãƒãƒƒãƒ\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
      
      var ok = conditionalStartConfirmation(confirmMessage, 'é¸æŠè¡Œã®å®Ÿè¡Œç¢ºèª');
      if (ok !== SpreadsheetApp.getUi().Button.YES) {
        conditionalShowAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', "info");
        return;
      }

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
      props.setProperty('sidebarProgress', JSON.stringify({
        currentBatch: 0,
        totalBatches: 0,
        successCount: 0,
        errorCount: 0,
        message: 'è¡Œãƒã‚§ãƒƒã‚¯é–‹å§‹...',
        logType: 'info'
      }));

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å…ˆã«è¡¨ç¤ºï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
      showProgressSidebar_();

      props.setProperty('targetRows', JSON.stringify(selectedRows));
      props.setProperty('manualWeight', manualWeight.toString());
      props.setProperty('manualSize', manualSize);
      props.setProperty('isProcessing', 'true');
      props.setProperty('processingMode', SCRIPT_NAME);
      props.setProperty('startTime', startTime.getTime().toString());
      props.setProperty('skippedCount', skippedCount.toString());
      props.setProperty('lastProcessedRowIndex', '0');
      startRowIndex = 0;

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: å‡¦ç†å¯¾è±¡ã‚’æ¤œå‡º
      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: 0,
        successCount: 0,
        errorCount: 0,
        message: 'å‡¦ç†å¯¾è±¡: ' + selectedRows.length + 'ä»¶ã‚’æ¤œå‡º',
        logType: 'info'
      });
    } else {
      selectedRows = JSON.parse(props.getProperty('targetRows'));
      manualWeight = parseInt(props.getProperty('manualWeight'));
      manualSize = props.getProperty('manualSize');
      startTime = new Date(parseInt(props.getProperty('startTime')));
      skippedCount = parseInt(props.getProperty('skippedCount') || '0');
      conditionalShowAlert('å‡¦ç†ã‚’å†é–‹ã—ã¾ã™ã€‚æ®‹ã‚Š ' + (selectedRows.length - startRowIndex) + 'ä»¶ã€‚', "info");
    }

    // ğŸ”¹ P2ã‚»ãƒ«ã®å•†å“çŠ¶æ…‹ãƒ¢ãƒ¼ãƒ‰ã‚’1å›ã ã‘èª­ã¿å–ã‚‹
    var conditionMode = sheet.getRange("P2").getValue();

    // ğŸ”¹ 50è¡Œãšã¤ã®ãƒãƒƒãƒã«åˆ†å‰²
    var BATCH_SIZE = 50;
    var batches = createBatches(selectedRows.slice(startRowIndex), BATCH_SIZE);
    var rowsSeenInThisRun = 0;
    var processedInThisBatch = 0;

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: å‡¦ç†é–‹å§‹
    updateProgressSidebar_({
      currentBatch: 0,
      totalBatches: batches.length,
      successCount: processedCount,
      errorCount: errorCount,
      message: 'ç¿»è¨³ãƒ»è¨ˆç®—å‡¦ç†é–‹å§‹ (å…¨' + batches.length + 'ãƒãƒƒãƒ)',
      logType: 'info'
    });

    for (var bi = 0; bi < batches.length; bi++) {
      var batch = batches[bi];

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒé–‹å§‹
      updateProgressSidebar_({
        currentBatch: bi + 1,
        totalBatches: batches.length,
        successCount: processedCount,
        errorCount: errorCount,
        message: 'ãƒãƒƒãƒ ' + (bi + 1) + '/' + batches.length + ' å‡¦ç†é–‹å§‹',
        logType: 'info'
      });

      // ğŸ”¹ ç¿»è¨³ãƒ•ã‚§ãƒ¼ã‚ºï¼šãƒãƒƒãƒå…¨ä½“ã‚’ä¸€åº¦ã«å‡¦ç†
      // ä¸€æ‹¬èª­ã¿å–ã‚Šã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
      var items = [];
      if (batch.length > 0) {
        var minRow = Math.min.apply(null, batch);
        var maxRow = Math.max.apply(null, batch);
        var batchDataRange = sheet.getRange(minRow, 1, maxRow - minRow + 1, CONFIG.COLUMNS.EN_DESC);
        var batchValues = batchDataRange.getValues();

        for (var k = 0; k < batch.length; k++) {
          var row = batch[k];
          var rowIndex = row - minRow;
          var jpTitle = batchValues[rowIndex][CONFIG.COLUMNS.JP_TITLE - 1];
          var jpDesc = batchValues[rowIndex][CONFIG.COLUMNS.JP_DESC - 1];
          var costYen = Number(batchValues[rowIndex][CONFIG.COLUMNS.COST_YEN - 1]);
          var enTitle = batchValues[rowIndex][CONFIG.COLUMNS.EN_TITLE - 1];
          var enDesc = batchValues[rowIndex][CONFIG.COLUMNS.EN_DESC - 1];

          if (jpTitle && jpDesc && costYen > 0 && (!enTitle || !enDesc)) {
            items.push({ row: row, jpTitle: jpTitle, jpDesc: jpDesc, costYen: costYen });
          } else {
            skippedCount++;
          }
        }
      }
      
      if (items.length > 0) {
        // ğŸ”¹ åˆå›ç¿»è¨³: ãƒãƒƒãƒå…¨ä½“ã‚’ä¸¦åˆ—å‡¦ç†
        var par = executeTranslationWithRetry_(items, settings, sheet, conditionMode, 1);

        var validatedItems = [];
        var failedItems = [];

        // ç¿»è¨³çµæœã‚’æ¤œè¨¼
        for (var idx = 0; idx < par.results.length; idx++) {
          var res = par.results[idx];
          if (res.ok) {
            try {
              // ã¾ãšç¿»è¨³çµæœã‚’ã‚·ãƒ¼ãƒˆã«åæ˜ 
              applyTranslationToRow_(sheet, res.row, res.fields, conditionMode);
              validatedItems.push(res);
              totalPrompt += (res.usage && res.usage.in) || 0;
              totalCompletion += (res.usage && res.usage.out) || 0;
            } catch (eRow) {
              console.error('  âŒ è¡Œ' + res.row + ': ã‚·ãƒ¼ãƒˆåæ˜ ã‚¨ãƒ©ãƒ¼: ' + eRow.message);
              failedItems.push(items[idx]);
            }
          } else {
            console.error('  âŒ è¡Œ' + res.row + ': ç¿»è¨³å¤±æ•—: ' + (res.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
            failedItems.push(items[idx]);
          }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å¼ã‚’å®Œäº†ã•ã›ã‚‹
        SpreadsheetApp.flush();

        // æ›¸ãè¾¼ã¿å¾Œã«æ¤œè¨¼
        var revalidateFailedItems = [];
        for (var vidx = 0; vidx < validatedItems.length; vidx++) {
          var vres = validatedItems[vidx];
          var validation = validateTranslationResult_(sheet, vres.row, vres.fields);
          if (!validation.valid) {
            var errorMsg = 'è¡Œ' + vres.row + ': ' + validation.errors.join(', ');
            console.warn('  âš ï¸ ' + errorMsg);
            // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
            updateProgressSidebar_({
              currentBatch: bi + 1,
              totalBatches: batches.length,
              successCount: processedCount,
              errorCount: errorCount + revalidateFailedItems.length + 1,
              message: 'âŒ ' + errorMsg,
              logType: 'error'
            });
            revalidateFailedItems.push(items[vidx]);
          } else {
            processedCount++;
            processedInThisBatch++;
          }
        }

        // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯å†è©¦è¡Œå¯¾è±¡ã«è¿½åŠ 
        for (var rfidx = 0; rfidx < revalidateFailedItems.length; rfidx++) {
          failedItems.push(revalidateFailedItems[rfidx]);
        }

        // ğŸ”¹ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼è¡Œã®ã¿å†è©¦è¡Œ (æœ€å¤§3å›ã¾ã§)
        var remainingItems = failedItems;
        var maxRetries = 3;
        var retryAttempt = 1;

        while (remainingItems.length > 0 && retryAttempt < maxRetries) {
          console.log('  ğŸ” æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ ' + remainingItems.length + 'ä»¶ã‚’å†è©¦è¡Œã—ã¾ã™ (' + (retryAttempt + 1) + 'å›ç›®)');

          // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: å†è©¦è¡Œé–‹å§‹
          updateProgressSidebar_({
            currentBatch: bi + 1,
            totalBatches: batches.length,
            successCount: processedCount,
            errorCount: errorCount,
            message: 'ğŸ” ' + remainingItems.length + 'ä»¶ã‚’å†è©¦è¡Œä¸­ (' + (retryAttempt + 1) + 'å›ç›®)',
            logType: 'warning'
          });

          Utilities.sleep(2000);

          var retryPar = executeTranslationWithRetry_(remainingItems, settings, sheet, conditionMode, 1);

          var retryValidated = [];
          var retryFailed = [];

          for (var ridx = 0; ridx < retryPar.results.length; ridx++) {
            var rres = retryPar.results[ridx];
            if (rres.ok) {
              try {
                // ã¾ãšç¿»è¨³çµæœã‚’ã‚·ãƒ¼ãƒˆã«åæ˜ 
                applyTranslationToRow_(sheet, rres.row, rres.fields, conditionMode);
                retryValidated.push(rres);
                totalPrompt += (rres.usage && rres.usage.in) || 0;
                totalCompletion += (rres.usage && rres.usage.out) || 0;
              } catch (eRow) {
                console.error('  âŒ è¡Œ' + rres.row + ': ã‚·ãƒ¼ãƒˆåæ˜ ã‚¨ãƒ©ãƒ¼: ' + eRow.message);
                retryFailed.push(remainingItems[ridx]);
              }
            } else {
              console.error('  âŒ è¡Œ' + rres.row + ': ç¿»è¨³å¤±æ•—: ' + (rres.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
              retryFailed.push(remainingItems[ridx]);
            }
          }

          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å¼ã‚’å®Œäº†ã•ã›ã‚‹
          SpreadsheetApp.flush();

          // æ›¸ãè¾¼ã¿å¾Œã«æ¤œè¨¼
          var retryRevalidateFailed = [];
          for (var rvidx = 0; rvidx < retryValidated.length; rvidx++) {
            var rvres = retryValidated[rvidx];
            var rvalidation = validateTranslationResult_(sheet, rvres.row, rvres.fields);
            if (!rvalidation.valid) {
              var errorMsg = 'è¡Œ' + rvres.row + ': ' + rvalidation.errors.join(', ');
              console.warn('  âš ï¸ ' + errorMsg);
              // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«ã‚¨ãƒ©ãƒ¼è©³ç´°ã‚’è¡¨ç¤º
              updateProgressSidebar_({
                currentBatch: bi + 1,
                totalBatches: batches.length,
                successCount: processedCount,
                errorCount: errorCount + retryRevalidateFailed.length + 1,
                message: 'âŒ ' + errorMsg,
                logType: 'error'
              });
              retryRevalidateFailed.push(remainingItems[rvidx]);
              allRetryDetails.push({ row: rvres.row, attempts: retryAttempt + 1, status: 'æ¤œè¨¼ã‚¨ãƒ©ãƒ¼', errors: rvalidation.errors });
            } else {
              console.log('  âœ… è¡Œ' + rvres.row + ': å†è©¦è¡Œ' + (retryAttempt + 1) + 'å›ç›®ã§æˆåŠŸ');
              allRetryDetails.push({ row: rvres.row, attempts: retryAttempt + 1, status: 'æˆåŠŸ' });
              processedCount++;
              processedInThisBatch++;
            }
          }

          // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ 
          for (var rrfidx = 0; rrfidx < retryRevalidateFailed.length; rrfidx++) {
            retryFailed.push(retryRevalidateFailed[rrfidx]);
          }

          remainingItems = retryFailed;
          retryAttempt++;
        }

        // æœ€çµ‚çš„ã«å¤±æ•—ã—ãŸè¡Œã‚’ã‚«ã‚¦ãƒ³ãƒˆ
        for (var f = 0; f < remainingItems.length; f++) {
          errorCount++;
          validationErrorCount++;
          console.error('  ğŸ’€ è¡Œ' + remainingItems[f].row + ': ' + maxRetries + 'å›è©¦è¡Œå¾Œã‚‚å¤±æ•—');
          allRetryDetails.push({ row: remainingItems[f].row, attempts: maxRetries, status: 'å¤±æ•—' });
        }
      }

      // ğŸ”¹ è¨ˆç®—ãƒ•ã‚§ãƒ¼ã‚ºï¼šç¿»è¨³æ¸ˆã¿ã®è¡Œã‚’ãƒãƒƒãƒã§è¨ˆç®—
      var rowsToCalculate = [];
      for (var k = 0; k < batch.length; k++) {
        var row = batch[k];
        var jpTitle = sheet.getRange(row, CONFIG.COLUMNS.JP_TITLE).getValue();
        var jpDesc = sheet.getRange(row, CONFIG.COLUMNS.JP_DESC).getValue();
        var costYen = Number(sheet.getRange(row, CONFIG.COLUMNS.COST_YEN).getValue());
        if (jpTitle && jpDesc && costYen > 0) {
          rowsToCalculate.push(row);
        }
      }
      
      if (rowsToCalculate.length > 0) {
        try {
          // ğŸ”¹ è¨ˆç®—ã‚’ä¸€æ‹¬å®Ÿè¡Œ
          applyCalculationBatch_(sheet, rowsToCalculate, settings, manualWeight, manualSize);
        } catch (eCalc) {
          errorCount += rowsToCalculate.length;
          console.error('è¨ˆç®—ãƒãƒƒãƒã‚¨ãƒ©ãƒ¼: ' + eCalc.message);
        }
      }

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒå®Œäº†
      updateProgressSidebar_({
        currentBatch: bi + 1,
        totalBatches: batches.length,
        successCount: processedCount,
        errorCount: errorCount,
        message: 'ãƒãƒƒãƒ ' + (bi + 1) + '/' + batches.length + ' å®Œäº† (æˆåŠŸ: ' + processedCount + ', ã‚¨ãƒ©ãƒ¼: ' + errorCount + ')',
        logType: 'success'
      });

      // 5è¡Œã”ã¨ã«STOPåˆ¶å¾¡ãƒã‚§ãƒƒã‚¯
      if (processedInThisBatch > 0 && processedInThisBatch % 5 === 0) {
        if (!checkStopControl()) {
          clearProcessingState();
          clearAllTriggers();
          conditionalShowAlert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‡¦ç†ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸï¼ˆD2=STOPï¼‰ã€‚\nå‡¦ç†æ¸ˆã¿: ' + processedCount + 'ä»¶', 'warning');
          return;
        }
      }

      rowsSeenInThisRun += batch.length;
      props.setProperty('lastProcessedRowIndex', (startRowIndex + rowsSeenInThisRun).toString());
      props.setProperty('totalPrompt', totalPrompt.toString());
      props.setProperty('totalCompletion', totalCompletion.toString());
      props.setProperty('processedCount', processedCount.toString());
      props.setProperty('errorCount', errorCount.toString());
      props.setProperty('skippedCount', skippedCount.toString());

      if (bi < batches.length - 1) Utilities.sleep(500);

      var elapsed = (new Date().getTime() - startTime.getTime()) / 1000;
      if (elapsed > (240 - CONFIG.CONTINUATION_INTERVAL_MINUTES * 60)) {
        createSelfContinuationTrigger(SCRIPT_NAME);
        conditionalShowAlert("å‡¦ç†ã‚’ä¸€æ™‚åœæ­¢ã—ã€è‡ªå‹•å†é–‹ã—ã¾ã™ã€‚", "info");
        return;
      }
    }

    // å‡¦ç†å®Œäº†ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«é€šçŸ¥
    updateProgressSidebar_({
      currentBatch: batches.length,
      totalBatches: batches.length,
      successCount: processedCount,
      errorCount: errorCount,
      message: 'âœ… ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ',
      logType: 'success',
      isCompleted: true
    });

    clearProcessingState();
    clearAllTriggers();

    var end = new Date();
    var duration = Math.round((end - startTime) / 1000);
    var usd = calculateTokenCostUSD(settings.platform, settings.model, totalPrompt, totalCompletion);
    var rate = sheet.getRange("C2").getValue() || 145;
    var avgTokens = processedCount > 0 ? Math.round((totalPrompt + totalCompletion) / processedCount) : 0;

    var report = 'âœ… å‡¦ç†å®Œäº†(é¸æŠè¡Œ)\n\n' +
      'å‡¦ç†æ™‚é–“: ' + duration + 'ç§’\n' +
      'å‡¦ç†æ¸ˆã¿: ' + processedCount + 'ä»¶\n' +
      'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'ä»¶\n' +
      'ã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶\n\n' +
      'ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡:\n' +
      'â€¢ å…¥åŠ›: ' + totalPrompt.toLocaleString() + '\n' +
      'â€¢ å‡ºåŠ›: ' + totalCompletion.toLocaleString() + '\n' +
      'â€¢ åˆè¨ˆ: ' + (totalPrompt + totalCompletion).toLocaleString() + '\n' +
      'â€¢ å¹³å‡/ä»¶: ' + avgTokens + '\n' +
      'â€¢ æ¨å®šè²»ç”¨: $' + usd.toFixed(4) + 'ï¼ˆç´„' + Math.round(usd * rate) + 'å††, ' + settings.platform + ' / ' + settings.model + 'ï¼‰';
    
    conditionalShowAlert(report, "success");

  } catch (e) {
    showAlert('å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
    clearProcessingState();
    clearAllTriggers();
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  è¨ˆç®—ã‚¨ãƒ©ãƒ¼æ¤œå‡ºãƒ»ãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
/**
 * è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹è¡Œã‚’æ¤œå‡ºï¼ˆRåˆ—ï½Wåˆ—ã‚’ãƒã‚§ãƒƒã‚¯ï¼‰
 * @param {Sheet} sheet ã‚·ãƒ¼ãƒˆ
 * @param {Array} rows è¡Œç•ªå·ã®é…åˆ—
 * @return {Array} ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚‹è¡Œç•ªå·ã®é…åˆ—
 */
function detectCalculationErrors_(sheet, rows) {
  if (!rows || rows.length === 0) return [];

  var errorRows = [];
  var minRow = Math.min.apply(null, rows);
  var maxRow = Math.max.apply(null, rows);

  // Råˆ—ï½Wåˆ—ï¼ˆPRICE, TAX_INCLUDED_PRICE, SHIPPING, PROFIT, FEE, RATEï¼‰ã‚’ä¸€æ‹¬å–å¾—
  var startCol = CONFIG.COLUMNS.PRICE; // 18 (Råˆ—)
  var numCols = CONFIG.COLUMNS.RATE - CONFIG.COLUMNS.PRICE + 1; // 6åˆ—
  var range = sheet.getRange(minRow, startCol, maxRow - minRow + 1, numCols);
  var values = range.getValues();

  for (var i = 0; i < rows.length; i++) {
    var row = rows[i];
    var rowIndex = row - minRow;
    var rowValues = values[rowIndex];
    var hasError = false;

    for (var j = 0; j < rowValues.length; j++) {
      var val = rowValues[j];

      // ã‚¨ãƒ©ãƒ¼ãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’ãƒã‚§ãƒƒã‚¯
      if (val === null || val === '' || val === undefined) {
        hasError = true;
        break;
      }

      var valStr = String(val);
      if (valStr === 'ã‚¨ãƒ©ãƒ¼' ||
          valStr.indexOf('#N/A') !== -1 ||
          valStr.indexOf('#ERROR') !== -1 ||
          valStr.indexOf('#VALUE') !== -1 ||
          valStr.indexOf('#REF') !== -1) {
        hasError = true;
        break;
      }
    }

    if (hasError) {
      errorRows.push(row);
    }
  }

  return errorRows;
}

/**
 * è¨ˆç®—ã‚¨ãƒ©ãƒ¼è¡Œã‚’å†è¨ˆç®—
 * @param {Sheet} sheet ã‚·ãƒ¼ãƒˆ
 * @param {Array} errorRows ã‚¨ãƒ©ãƒ¼è¡Œã®é…åˆ—
 * @param {number} manualWeight æ¢±åŒ…é‡é‡
 * @param {string} manualSize æ¢±åŒ…ã‚µã‚¤ã‚º
 * @param {Object} settings è¨­å®š
 * @return {Object} { successCount, errorCount }
 */
function retryCalculationForErrors_(sheet, errorRows, manualWeight, manualSize, settings) {
  var successCount = 0;
  var errorCount = 0;

  console.log('ğŸ”„ è¨ˆç®—ã‚¨ãƒ©ãƒ¼è¡Œã®å†è¨ˆç®—: ' + errorRows.length + 'è¡Œ');

  for (var i = 0; i < errorRows.length; i++) {
    var row = errorRows[i];

    try {
      // ä¾¡æ ¼è¨ˆç®—ã‚’å†å®Ÿè¡Œ
      calculatePriceForRow(sheet, row, manualWeight, manualSize, settings);

      // å†è¨ˆç®—å¾Œã€ã‚¨ãƒ©ãƒ¼ãŒè§£æ¶ˆã•ã‚ŒãŸã‹ãƒã‚§ãƒƒã‚¯
      var stillHasError = detectCalculationErrors_(sheet, [row]).length > 0;

      if (!stillHasError) {
        console.log('  âœ… è¡Œ' + row + ': å†è¨ˆç®—æˆåŠŸ');
        successCount++;
      } else {
        console.log('  âš ï¸ è¡Œ' + row + ': å†è¨ˆç®—å¾Œã‚‚ã‚¨ãƒ©ãƒ¼');
        errorCount++;
      }
    } catch (e) {
      console.error('  âŒ è¡Œ' + row + ': å†è¨ˆç®—å¤±æ•— - ' + e.message);
      errorCount++;
    }
  }

  return { successCount: successCount, errorCount: errorCount };
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ†• çµ±åˆå®Ÿè¡Œï¼šç¿»è¨³ãƒ»è¨ˆç®— â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼è‡ªå‹•å‡ºåŠ›
  ğŸ”¹ PHASE1: ç¿»è¨³ï¼‹è¨ˆç®—ï¼ˆ50è¡Œãƒãƒƒãƒï¼‰
  ğŸ”¹ PHASE2: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼è‡ªå‹•å‡ºåŠ›ï¼ˆO1ãƒ»O2ä½¿ç”¨ï¼‰
  ğŸ”¹ P2ã‚»ãƒ«å¯¾å¿œï¼ˆå•†å“çŠ¶æ…‹ãƒ¢ãƒ¼ãƒ‰ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function runSelectedRowsComplete() {
  var SCRIPT_NAME = 'runSelectedRowsComplete';
  var props = PropertiesService.getScriptProperties();
  var startTime = new Date();

  var totalPrompt = parseInt(props.getProperty('totalPrompt_complete') || '0');
  var totalCompletion = parseInt(props.getProperty('totalCompletion_complete') || '0');
  var processedCount = parseInt(props.getProperty('processedCount_complete') || '0');
  var errorCount = parseInt(props.getProperty('errorCount_complete') || '0');
  var skippedCount = parseInt(props.getProperty('skippedCount_complete') || '0');
  var validationErrorCount = 0;
  var allRetryDetails = [];
  var phase = props.getProperty('processing_phase_complete') || 'PHASE1';

  var selectedRows, manualWeight, manualSize, category, templateName;
  var startRowIndex = parseInt(props.getProperty('lastProcessedRowIndex_complete') || '0');

  try {
    var settings = getSettings(); 
    if (!settings) { 
      clearProcessingStateComplete_(); 
      clearAllTriggers(); 
      return; 
    }
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) { 
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚','error'); 
      clearProcessingStateComplete_(); 
      clearAllTriggers(); 
      return; 
    }

    var isContinuing = props.getProperty('isProcessing_complete') === 'true' && props.getProperty('processingMode') === SCRIPT_NAME;

    // ============================================
    // åˆå›èµ·å‹•æ™‚ã®è¨­å®š
    // ============================================
    if (!isContinuing) {
      clearProcessingStateComplete_();
      clearAllTriggers();
      updateExchangeRate(sheet);

      // O1ãƒ»O2ã®å€¤ã‚’å–å¾—
      var categoryDisplay = sheet.getRange('O1').getValue();
      templateName = sheet.getRange('O2').getValue();
      
      if (!categoryDisplay || !templateName) {
        showAlert('O1ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰ã¾ãŸã¯O2ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚\nå…ˆã«è¨­å®šã—ã¦ã‹ã‚‰å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
        return;
      }
      
      category = convertCategoryDisplayToValue(categoryDisplay);

      var active = sheet.getActiveRange();
      if (!active) { 
        conditionalShowAlert("å‡¦ç†ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "info"); 
        return; 
      }
      var startRow = active.getRow(), endRow = active.getLastRow();
      if (endRow < 5) { 
        conditionalShowAlert("5è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚","info"); 
        return; 
      }

      // ä¸€æ‹¬èª­ã¿å–ã‚Šã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
      selectedRows = [];
      var numRows = endRow - startRow + 1;
      var dataRange = sheet.getRange(startRow, 1, numRows, CONFIG.COLUMNS.EN_DESC);
      var values = dataRange.getValues();

      for (var i = 0; i < values.length; i++) {
        var actualRow = startRow + i;
        if (actualRow < 5) { skippedCount++; continue; }

        var jpTitle = values[i][CONFIG.COLUMNS.JP_TITLE - 1];
        var jpDesc = values[i][CONFIG.COLUMNS.JP_DESC - 1];
        var costYen = Number(values[i][CONFIG.COLUMNS.COST_YEN - 1]);
        var enTitle = values[i][CONFIG.COLUMNS.EN_TITLE - 1];
        var enDesc = values[i][CONFIG.COLUMNS.EN_DESC - 1];

        if (jpTitle && jpDesc && costYen && (!enTitle || !enDesc)) {
          selectedRows.push(actualRow);
        } else {
          skippedCount++;
        }
      }
      if (selectedRows.length === 0) { 
        conditionalShowAlert("é¸æŠç¯„å›²ã«å‡¦ç†å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "info"); 
        return; 
      }

      var manualWeight = sheet.getRange("J2").getValue();
      var L = sheet.getRange("L2").getValue();
      var M = sheet.getRange("M2").getValue();
      var N = sheet.getRange("N2").getValue();

      if (settings.shippingCalculationMethod !== 'FIXED') {
        if (![manualWeight, L, M, N].every(function(v){ return typeof v === 'number' && v > 0; })) {
          showAlert('ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã§ã¯J2/L2/M2/N2ã«æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\né€æ–™å›ºå®šãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¸è¦ã§ã™ã€‚', "error"); 
          return;
        }
      } else {
        manualWeight = manualWeight || 0;
        L = L || 0;
        M = M || 0; 
        N = N || 0;
      }

      manualSize = (L > 0 && M > 0 && N > 0) ? L + 'x' + M + 'x' + N : 'å›ºå®šé€æ–™';

      var platformNames = { openai:'OpenAI', claude:'Claude', gemini:'Gemini' };
      var confirmMessage = 'ã€çµ±åˆå®Ÿè¡Œã€‘é¸æŠ ' + selectedRows.length + ' ä»¶ã‚’å‡¦ç†ã—ã¾ã™ã€‚\n\n' +
        'AI: ' + platformNames[settings.platform] + ' / ' + settings.model + '\n' +
        'æ¢±åŒ…é‡é‡: ' + manualWeight + ' g\næ¢±åŒ…ã‚µã‚¤ã‚º: ' + manualSize + '\n\n' +
        'å‡¦ç†å†…å®¹:\n' +
        '1ï¸âƒ£ ç¿»è¨³ï¼ˆMãƒ»Nãƒ»ACåˆ—ï¼‰\n' +
        '2ï¸âƒ£ ä¾¡æ ¼è¨ˆç®—ï¼ˆå…¨åˆ—ï¼‰\n' +
        '3ï¸âƒ£ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè‡ªå‹•å‡ºåŠ›ï¼ˆEåˆ—ï¼‰\n' +
        '4ï¸âƒ£ ãƒãƒªã‚·ãƒ¼è‡ªå‹•å‡ºåŠ›ï¼ˆGåˆ—ï¼‰\n\n' +
        'ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + categoryDisplay + '\n' +
        'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ' + templateName + '\n\n' +
        'ğŸ’¡ D2ã‚»ãƒ«ã§GO/STOPåˆ‡ã‚Šæ›¿ãˆå¯èƒ½\n' +
        'ğŸ’¡ 50è¡Œ/ãƒãƒƒãƒå‡¦ç†\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';
      
      var ok = conditionalStartConfirmation(confirmMessage, 'çµ±åˆå®Ÿè¡Œã®ç¢ºèª');
      if (ok !== SpreadsheetApp.getUi().Button.YES) {
        conditionalShowAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', "info");
        return;
      }

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
      props.setProperty('sidebarProgress', JSON.stringify({
        currentBatch: 0,
        totalBatches: 0,
        successCount: 0,
        errorCount: 0,
        message: 'è¡Œãƒã‚§ãƒƒã‚¯é–‹å§‹...',
        logType: 'info'
      }));

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å…ˆã«è¡¨ç¤ºï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
      showProgressSidebar_();

      // çŠ¶æ…‹ä¿å­˜
      props.setProperty('targetRows_complete', JSON.stringify(selectedRows));
      props.setProperty('manualWeight_complete', manualWeight.toString());
      props.setProperty('manualSize_complete', manualSize);
      props.setProperty('category_complete', category);
      props.setProperty('categoryDisplay_complete', categoryDisplay);
      props.setProperty('templateName_complete', templateName);
      props.setProperty('isProcessing_complete', 'true');
      props.setProperty('processingMode', SCRIPT_NAME);
      props.setProperty('processing_phase_complete', 'PHASE1');
      props.setProperty('startTime_complete', startTime.getTime().toString());
      props.setProperty('skippedCount_complete', skippedCount.toString());
      props.setProperty('lastProcessedRowIndex_complete', '0');
      startRowIndex = 0;
      phase = 'PHASE1';

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: å‡¦ç†å¯¾è±¡ã‚’æ¤œå‡º
      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: 0,
        successCount: 0,
        errorCount: 0,
        message: 'å‡¦ç†å¯¾è±¡: ' + selectedRows.length + 'ä»¶ã‚’æ¤œå‡º',
        logType: 'info'
      });
    } else {
      // ç¶™ç¶šå‡¦ç†
      selectedRows = JSON.parse(props.getProperty('targetRows_complete'));
      manualWeight = parseInt(props.getProperty('manualWeight_complete'));
      manualSize = props.getProperty('manualSize_complete');
      category = props.getProperty('category_complete');
      var categoryDisplay = props.getProperty('categoryDisplay_complete');
      templateName = props.getProperty('templateName_complete');
      startTime = new Date(parseInt(props.getProperty('startTime_complete')));
      skippedCount = parseInt(props.getProperty('skippedCount_complete') || '0');
      
      if (phase === 'PHASE1') {
        conditionalShowAlert('PHASE1ï¼ˆç¿»è¨³ãƒ»è¨ˆç®—ï¼‰ã‚’å†é–‹ã—ã¾ã™ã€‚æ®‹ã‚Š ' + (selectedRows.length - startRowIndex) + 'ä»¶ã€‚', "info");
      } else {
        conditionalShowAlert('PHASE2ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼å‡ºåŠ›ï¼‰ã‚’å†é–‹ã—ã¾ã™ã€‚æ®‹ã‚Š ' + (selectedRows.length - startRowIndex) + 'ä»¶ã€‚', "info");
      }
    }

    // ============================================
    // PHASE1: ç¿»è¨³ï¼‹è¨ˆç®—ï¼ˆæ—¢å­˜ã®runSelectedRowsãƒ­ã‚¸ãƒƒã‚¯ï¼‰
    // ============================================
    if (phase === 'PHASE1') {
      // ğŸ”¹ P2ã‚»ãƒ«ã®å•†å“çŠ¶æ…‹ãƒ¢ãƒ¼ãƒ‰ã‚’1å›ã ã‘èª­ã¿å–ã‚‹
      var conditionMode = sheet.getRange("P2").getValue();
      console.log('å•†å“çŠ¶æ…‹ãƒ¢ãƒ¼ãƒ‰ï¼ˆP2ï¼‰: ' + conditionMode);
      
      var BATCH_SIZE = 50;
      var batches = createBatches(selectedRows.slice(startRowIndex), BATCH_SIZE);
      var rowsSeenInThisRun = 0;
      var processedInThisBatch = 0;

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: PHASE1å‡¦ç†é–‹å§‹
      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: batches.length,
        successCount: processedCount,
        errorCount: errorCount,
        message: '[PHASE1] ç¿»è¨³ãƒ»è¨ˆç®—å‡¦ç†é–‹å§‹ (å…¨' + batches.length + 'ãƒãƒƒãƒ)',
        logType: 'info'
      });

      for (var bi = 0; bi < batches.length; bi++) {
        var batch = batches[bi];

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒé–‹å§‹
        updateProgressSidebar_({
          currentBatch: bi + 1,
          totalBatches: batches.length,
          successCount: processedCount,
          errorCount: errorCount,
          message: '[PHASE1] ãƒãƒƒãƒ ' + (bi + 1) + '/' + batches.length + ' å‡¦ç†é–‹å§‹',
          logType: 'info'
        });

        // ğŸ”¹ ç¿»è¨³ãƒ•ã‚§ãƒ¼ã‚ºï¼šãƒãƒƒãƒå…¨ä½“ã‚’ä¸€åº¦ã«å‡¦ç†
        // ä¸€æ‹¬èª­ã¿å–ã‚Šã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
        var items = [];
        if (batch.length > 0) {
          var minRow = Math.min.apply(null, batch);
          var maxRow = Math.max.apply(null, batch);
          var batchDataRange = sheet.getRange(minRow, 1, maxRow - minRow + 1, CONFIG.COLUMNS.EN_DESC);
          var batchValues = batchDataRange.getValues();

          for (var k = 0; k < batch.length; k++) {
            var row = batch[k];
            var rowIndex = row - minRow;
            var jpTitle = batchValues[rowIndex][CONFIG.COLUMNS.JP_TITLE - 1];
            var jpDesc = batchValues[rowIndex][CONFIG.COLUMNS.JP_DESC - 1];
            var costYen = Number(batchValues[rowIndex][CONFIG.COLUMNS.COST_YEN - 1]);
            var enTitle = batchValues[rowIndex][CONFIG.COLUMNS.EN_TITLE - 1];
            var enDesc = batchValues[rowIndex][CONFIG.COLUMNS.EN_DESC - 1];

            if (jpTitle && jpDesc && costYen > 0 && (!enTitle || !enDesc)) {
              items.push({ row: row, jpTitle: jpTitle, jpDesc: jpDesc, costYen: costYen });
            } else {
              skippedCount++;
            }
          }
        }
        
        if (items.length > 0) {
          // ğŸ”¹ åˆå›ç¿»è¨³: ãƒãƒƒãƒå…¨ä½“ã‚’ä¸¦åˆ—å‡¦ç†
          var par = executeTranslationWithRetry_(items, settings, sheet, conditionMode, 1);

          var validatedItems = [];
          var failedItems = [];

          // ç¿»è¨³çµæœã‚’æ¤œè¨¼
          for (var idx = 0; idx < par.results.length; idx++) {
            var res = par.results[idx];
            if (res.ok) {
              try {
                // ã¾ãšç¿»è¨³çµæœã‚’ã‚·ãƒ¼ãƒˆã«åæ˜ 
                applyTranslationToRow_(sheet, res.row, res.fields, conditionMode);
                validatedItems.push(res);
                totalPrompt += (res.usage && res.usage.in) || 0;
                totalCompletion += (res.usage && res.usage.out) || 0;
              } catch (eRow) {
                console.error('  âŒ è¡Œ' + res.row + ': ã‚·ãƒ¼ãƒˆåæ˜ ã‚¨ãƒ©ãƒ¼: ' + eRow.message);
                failedItems.push(items[idx]);
              }
            } else {
              console.error('  âŒ è¡Œ' + res.row + ': ç¿»è¨³å¤±æ•—: ' + (res.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
              failedItems.push(items[idx]);
            }
          }

          // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å¼ã‚’å®Œäº†ã•ã›ã‚‹
          SpreadsheetApp.flush();

          // æ›¸ãè¾¼ã¿å¾Œã«æ¤œè¨¼
          var revalidateFailedItems = [];
          for (var vidx = 0; vidx < validatedItems.length; vidx++) {
            var vres = validatedItems[vidx];
            var validation = validateTranslationResult_(sheet, vres.row, vres.fields);
            if (!validation.valid) {
              console.warn('  âš ï¸ è¡Œ' + vres.row + ': æ¤œè¨¼ã‚¨ãƒ©ãƒ¼(åˆå›): ' + validation.errors.join(', '));
              revalidateFailedItems.push(items[vidx]);
            } else {
              processedCount++;
              processedInThisBatch++;
            }
          }

          // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯å†è©¦è¡Œå¯¾è±¡ã«è¿½åŠ 
          for (var rfidx = 0; rfidx < revalidateFailedItems.length; rfidx++) {
            failedItems.push(revalidateFailedItems[rfidx]);
          }

          // ğŸ”¹ æ¤œè¨¼ã‚¨ãƒ©ãƒ¼è¡Œã®ã¿å†è©¦è¡Œ (æœ€å¤§3å›ã¾ã§)
          var remainingItems = failedItems;
          var maxRetries = 3;
          var retryAttempt = 1;

          while (remainingItems.length > 0 && retryAttempt < maxRetries) {
            console.log('  ğŸ” æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ ' + remainingItems.length + 'ä»¶ã‚’å†è©¦è¡Œã—ã¾ã™ (' + (retryAttempt + 1) + 'å›ç›®)');
            Utilities.sleep(2000);

            var retryPar = executeTranslationWithRetry_(remainingItems, settings, sheet, conditionMode, 1);

            var retryValidated = [];
            var retryFailed = [];

            for (var ridx = 0; ridx < retryPar.results.length; ridx++) {
              var rres = retryPar.results[ridx];
              if (rres.ok) {
                try {
                  // ã¾ãšç¿»è¨³çµæœã‚’ã‚·ãƒ¼ãƒˆã«åæ˜ 
                  applyTranslationToRow_(sheet, rres.row, rres.fields, conditionMode);
                  retryValidated.push(rres);
                  totalPrompt += (rres.usage && rres.usage.in) || 0;
                  totalCompletion += (rres.usage && rres.usage.out) || 0;
                } catch (eRow) {
                  console.error('  âŒ è¡Œ' + rres.row + ': ã‚·ãƒ¼ãƒˆåæ˜ ã‚¨ãƒ©ãƒ¼: ' + eRow.message);
                  retryFailed.push(remainingItems[ridx]);
                }
              } else {
                console.error('  âŒ è¡Œ' + rres.row + ': ç¿»è¨³å¤±æ•—: ' + (rres.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼'));
                retryFailed.push(remainingItems[ridx]);
              }
            }

            // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å¼ã‚’å®Œäº†ã•ã›ã‚‹
            SpreadsheetApp.flush();

            // æ›¸ãè¾¼ã¿å¾Œã«æ¤œè¨¼
            var retryRevalidateFailed = [];
            for (var rvidx = 0; rvidx < retryValidated.length; rvidx++) {
              var rvres = retryValidated[rvidx];
              var rvalidation = validateTranslationResult_(sheet, rvres.row, rvres.fields);
              if (!rvalidation.valid) {
                console.warn('  âš ï¸ è¡Œ' + rvres.row + ': æ¤œè¨¼ã‚¨ãƒ©ãƒ¼(è©¦è¡Œ' + (retryAttempt + 1) + '): ' + rvalidation.errors.join(', '));
                retryRevalidateFailed.push(remainingItems[rvidx]);
                allRetryDetails.push({ row: rvres.row, attempts: retryAttempt + 1, status: 'æ¤œè¨¼ã‚¨ãƒ©ãƒ¼', errors: rvalidation.errors });
              } else {
                console.log('  âœ… è¡Œ' + rvres.row + ': å†è©¦è¡Œ' + (retryAttempt + 1) + 'å›ç›®ã§æˆåŠŸ');
                allRetryDetails.push({ row: rvres.row, attempts: retryAttempt + 1, status: 'æˆåŠŸ' });
                processedCount++;
                processedInThisBatch++;
              }
            }

            // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ 
            for (var rrfidx = 0; rrfidx < retryRevalidateFailed.length; rrfidx++) {
              retryFailed.push(retryRevalidateFailed[rrfidx]);
            }

            remainingItems = retryFailed;
            retryAttempt++;
          }

          // æœ€çµ‚çš„ã«å¤±æ•—ã—ãŸè¡Œã‚’ã‚«ã‚¦ãƒ³ãƒˆ
          for (var f = 0; f < remainingItems.length; f++) {
            errorCount++;
            validationErrorCount++;
            console.error('  ğŸ’€ è¡Œ' + remainingItems[f].row + ': ' + maxRetries + 'å›è©¦è¡Œå¾Œã‚‚å¤±æ•—');
            allRetryDetails.push({ row: remainingItems[f].row, attempts: maxRetries, status: 'å¤±æ•—' });
          }
        }

        // ğŸ”¹ è¨ˆç®—ãƒ•ã‚§ãƒ¼ã‚ºï¼šç¿»è¨³æ¸ˆã¿ã®è¡Œã‚’ãƒãƒƒãƒã§è¨ˆç®—
        var rowsToCalculate = [];

        // ä¸€æ‹¬èª­ã¿å–ã‚Šã§æ€§èƒ½æ”¹å–„ï¼ˆ150å› â†’ 1å›ï¼‰
        if (batch.length > 0) {
          var minRow = Math.min.apply(null, batch);
          var maxRow = Math.max.apply(null, batch);
          var numRows = maxRow - minRow + 1;

          // Iåˆ—ã€Jåˆ—ã€Kåˆ—ã‚’ä¸€æ‹¬å–å¾—
          var checkRange = sheet.getRange(minRow, CONFIG.COLUMNS.COST_YEN, numRows, 3);
          var checkValues = checkRange.getValues();

          for (var k = 0; k < batch.length; k++) {
            var row = batch[k];
            var rowIndex = row - minRow;
            var costYen = Number(checkValues[rowIndex][0]); // Iåˆ—
            var jpTitle = checkValues[rowIndex][1];         // Jåˆ—
            var jpDesc = checkValues[rowIndex][2];          // Kåˆ—

            if (jpTitle && jpDesc && costYen > 0) {
              rowsToCalculate.push(row);
            }
          }
        }
        
        if (rowsToCalculate.length > 0) {
          try {
            // ğŸ”¹ è¨ˆç®—ã‚’ä¸€æ‹¬å®Ÿè¡Œ
            applyCalculationBatch_(sheet, rowsToCalculate, settings, manualWeight, manualSize);
          } catch (eCalc) {
            errorCount += rowsToCalculate.length;
            console.error('è¨ˆç®—ãƒãƒƒãƒã‚¨ãƒ©ãƒ¼: ' + eCalc.message);
          }
        }

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒå®Œäº†
        updateProgressSidebar_({
          currentBatch: bi + 1,
          totalBatches: batches.length,
          successCount: processedCount,
          errorCount: errorCount,
          message: '[PHASE1] ãƒãƒƒãƒ ' + (bi + 1) + '/' + batches.length + ' å®Œäº† (æˆåŠŸ: ' + processedCount + ', ã‚¨ãƒ©ãƒ¼: ' + errorCount + ')',
          logType: 'success'
        });

        // 5è¡Œã”ã¨ã«STOPåˆ¶å¾¡ãƒã‚§ãƒƒã‚¯
        if (processedInThisBatch > 0 && processedInThisBatch % 5 === 0) {
          if (!checkStopControl()) {
            clearProcessingStateComplete_();
            clearAllTriggers();
            conditionalShowAlert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‡¦ç†ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸï¼ˆD2=STOPï¼‰ã€‚\nå‡¦ç†æ¸ˆã¿: ' + processedCount + 'ä»¶', 'warning');
            return;
          }
        }

        rowsSeenInThisRun += batch.length;
        props.setProperty('lastProcessedRowIndex_complete', (startRowIndex + rowsSeenInThisRun).toString());
        props.setProperty('totalPrompt_complete', totalPrompt.toString());
        props.setProperty('totalCompletion_complete', totalCompletion.toString());
        props.setProperty('processedCount_complete', processedCount.toString());
        props.setProperty('errorCount_complete', errorCount.toString());
        props.setProperty('skippedCount_complete', skippedCount.toString());

        if (bi < batches.length - 1) Utilities.sleep(500);

        var elapsed = (new Date().getTime() - startTime.getTime()) / 1000;
        if (elapsed > (240 - CONFIG.CONTINUATION_INTERVAL_MINUTES * 60)) {
          createSelfContinuationTrigger(SCRIPT_NAME);
          conditionalShowAlert("PHASE1ã‚’ä¸€æ™‚åœæ­¢ã—ã€è‡ªå‹•å†é–‹ã—ã¾ã™ã€‚", "info");
          return;
        }
      }

      // PHASE1å®Œäº† â†’ PHASE2ã¸ç§»è¡Œ
      console.log('=== PHASE1å®Œäº†ã€‚PHASE2ã¸ç§»è¡Œã—ã¾ã™ ===');

      // è¨ˆç®—ã‚¨ãƒ©ãƒ¼ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
      console.log('=== è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ä¸­ ===');
      var errorRows = detectCalculationErrors_(sheet, selectedRows);

      if (errorRows.length > 0) {
        console.log('âš ï¸ è¨ˆç®—ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ' + errorRows.length + 'è¡Œ');

        updateProgressSidebar_({
          currentBatch: 0,
          totalBatches: 0,
          successCount: processedCount,
          errorCount: errorCount,
          message: 'ğŸ”„ è¨ˆç®—ã‚¨ãƒ©ãƒ¼ ' + errorRows.length + 'è¡Œã‚’å†è¨ˆç®—ä¸­...',
          logType: 'warning'
        });

        var retryResult = retryCalculationForErrors_(sheet, errorRows, manualWeight, manualSize, settings);

        console.log('ãƒªãƒˆãƒ©ã‚¤çµæœ: æˆåŠŸ' + retryResult.successCount + 'ä»¶, ã‚¨ãƒ©ãƒ¼' + retryResult.errorCount + 'ä»¶');

        updateProgressSidebar_({
          currentBatch: 0,
          totalBatches: 0,
          successCount: processedCount + retryResult.successCount,
          errorCount: errorCount + retryResult.errorCount,
          message: 'âœ… å†è¨ˆç®—å®Œäº† (æˆåŠŸ: ' + retryResult.successCount + ', æ®‹ã‚¨ãƒ©ãƒ¼: ' + retryResult.errorCount + ')',
          logType: retryResult.errorCount > 0 ? 'warning' : 'success'
        });
      } else {
        console.log('âœ… è¨ˆç®—ã‚¨ãƒ©ãƒ¼ãªã—ã€‚PHASE2ã¸é€²ã¿ã¾ã™ã€‚');
      }

      props.setProperty('processing_phase_complete', 'PHASE2');
      props.setProperty('lastProcessedRowIndex_complete', '0');
      phase = 'PHASE2';
      startRowIndex = 0;
    }

    // ============================================
    // PHASE2: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼è‡ªå‹•å‡ºåŠ›
    // ============================================
    if (phase === 'PHASE2') {
      console.log('=== PHASE2é–‹å§‹ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼è‡ªå‹•å‡ºåŠ› ===');

      var templateSuccessCount = 0;
      var templateErrorCount = 0;
      var policySuccessCount = 0;
      var policyErrorCount = 0;

      var BATCH_SIZE = 50;
      var totalBatches = Math.ceil((selectedRows.length - startRowIndex) / BATCH_SIZE);
      var currentBatch = 0;

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: PHASE2é–‹å§‹
      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: totalBatches,
        successCount: 0,
        errorCount: 0,
        message: '[PHASE2] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼è¨­å®šé–‹å§‹ (å…¨' + totalBatches + 'ãƒãƒƒãƒ)',
        logType: 'info'
      });

      for (var batchStart = startRowIndex; batchStart < selectedRows.length; batchStart += BATCH_SIZE) {
        var batchEnd = Math.min(batchStart + BATCH_SIZE, selectedRows.length);
        var batchRows = selectedRows.slice(batchStart, batchEnd);
        currentBatch++;

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒé–‹å§‹
        updateProgressSidebar_({
          currentBatch: currentBatch,
          totalBatches: totalBatches,
          successCount: templateSuccessCount,
          errorCount: templateErrorCount,
          message: '[PHASE2] ãƒãƒƒãƒ ' + currentBatch + '/' + totalBatches + ' å‡¦ç†ä¸­...',
          logType: 'info'
        });

        try {
          var result = applyUnifiedSettingsBatch_(
            sheet,
            batchRows,
            category,
            templateName,
            'auto',  // templateMode
            'auto',  // policyMode
            null     // manualPolicyId
          );

          templateSuccessCount += result.successCount;
          policySuccessCount += result.successCount;

          // ã‚¨ãƒ©ãƒ¼ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ã¨ãƒãƒªã‚·ãƒ¼ã§å…±é€šã‚«ã‚¦ãƒ³ãƒˆ
          templateErrorCount += result.errorCount;
          policyErrorCount += result.errorCount;

          // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒå®Œäº†
          updateProgressSidebar_({
            currentBatch: currentBatch,
            totalBatches: totalBatches,
            successCount: templateSuccessCount,
            errorCount: templateErrorCount,
            message: '[PHASE2] ãƒãƒƒãƒ ' + currentBatch + '/' + totalBatches + ' å®Œäº† (æˆåŠŸ: ' + templateSuccessCount + ', ã‚¨ãƒ©ãƒ¼: ' + templateErrorCount + ')',
            logType: 'success'
          });

        } catch (e) {
          console.error('PHASE2ãƒãƒƒãƒã‚¨ãƒ©ãƒ¼: ' + e.message);
          templateErrorCount += batchRows.length;
          policyErrorCount += batchRows.length;

          // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ã‚¨ãƒ©ãƒ¼
          updateProgressSidebar_({
            currentBatch: currentBatch,
            totalBatches: totalBatches,
            successCount: templateSuccessCount,
            errorCount: templateErrorCount,
            message: '[PHASE2] ãƒãƒƒãƒ ' + currentBatch + ' ã‚¨ãƒ©ãƒ¼: ' + e.message,
            logType: 'error'
          });
        }

        // STOPåˆ¶å¾¡ãƒã‚§ãƒƒã‚¯
        if ((templateSuccessCount + policySuccessCount) > 0 && (templateSuccessCount + policySuccessCount) % 5 === 0) {
          if (!checkStopControl()) {
            clearProcessingStateComplete_();
            clearAllTriggers();
            conditionalShowAlert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‡¦ç†ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸï¼ˆD2=STOPï¼‰ã€‚\nPHASE2å‡¦ç†æ¸ˆã¿: ' + templateSuccessCount + 'ä»¶', 'warning');
            return;
          }
        }

        props.setProperty('lastProcessedRowIndex_complete', batchEnd.toString());

        if (batchEnd < selectedRows.length) {
          Utilities.sleep(200);
        }

        var elapsed = (new Date().getTime() - startTime.getTime()) / 1000;
        if (elapsed > (240 - CONFIG.CONTINUATION_INTERVAL_MINUTES * 60)) {
          createSelfContinuationTrigger(SCRIPT_NAME);
          conditionalShowAlert("PHASE2ã‚’ä¸€æ™‚åœæ­¢ã—ã€è‡ªå‹•å†é–‹ã—ã¾ã™ã€‚", "info");
          return;
        }
      }
    }

    // ============================================
    // æœ€çµ‚ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ï¼†ãƒªãƒˆãƒ©ã‚¤
    // ============================================
    console.log('=== æœ€çµ‚ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯é–‹å§‹ ===');

    // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å®Œäº†ã‚’å¾…ã¤
    SpreadsheetApp.flush();
    Utilities.sleep(2000);

    updateProgressSidebar_({
      currentBatch: 0,
      totalBatches: 0,
      successCount: processedCount,
      errorCount: errorCount,
      message: 'ğŸ” æœ€çµ‚ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯ä¸­...',
      logType: 'info'
    });

    var finalErrorRows = detectCalculationErrors_(sheet, selectedRows);

    if (finalErrorRows.length > 0) {
      console.log('âš ï¸ æœ€çµ‚ã‚¨ãƒ©ãƒ¼æ¤œå‡º: ' + finalErrorRows.length + 'è¡Œ');

      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: 0,
        successCount: processedCount,
        errorCount: errorCount,
        message: 'ğŸ”„ æœ€çµ‚ãƒªãƒˆãƒ©ã‚¤: è¨ˆç®—ã‚¨ãƒ©ãƒ¼ ' + finalErrorRows.length + 'è¡Œã‚’ä¿®æ­£ä¸­...',
        logType: 'warning'
      });

      // â‘  è¨ˆç®—ã‚’å†å®Ÿè¡Œ
      var finalRetryResult = retryCalculationForErrors_(sheet, finalErrorRows, manualWeight, manualSize, settings);
      console.log('è¨ˆç®—ãƒªãƒˆãƒ©ã‚¤çµæœ: æˆåŠŸ' + finalRetryResult.successCount + 'ä»¶, ã‚¨ãƒ©ãƒ¼' + finalRetryResult.errorCount + 'ä»¶');

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å®Œäº†ã‚’å¾…ã¤
      SpreadsheetApp.flush();
      Utilities.sleep(1500);

      // â‘¡ è¨ˆç®—æˆåŠŸã—ãŸè¡Œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼ã‚’å†è¨­å®š
      if (finalRetryResult.successCount > 0) {
        updateProgressSidebar_({
          currentBatch: 0,
          totalBatches: 0,
          successCount: processedCount,
          errorCount: errorCount,
          message: 'ğŸ“ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼å†è¨­å®šä¸­ (' + finalRetryResult.successCount + 'è¡Œ)...',
          logType: 'info'
        });

        // è¨ˆç®—ãŒæˆåŠŸã—ãŸè¡Œã®ã¿ã‚’å¯¾è±¡
        var successRows = [];
        for (var i = 0; i < finalErrorRows.length; i++) {
          var row = finalErrorRows[i];
          var stillHasError = detectCalculationErrors_(sheet, [row]).length > 0;
          if (!stillHasError) {
            successRows.push(row);
          }
        }

        if (successRows.length > 0) {
          try {
            var result = applyUnifiedSettingsBatch_(
              sheet,
              successRows,
              props.getProperty('category_complete') || '',
              templateName,
              templateMode,
              policyMode,
              manualPolicyId
            );
            console.log('âœ… å†è¨­å®šå®Œäº†: æˆåŠŸ' + result.successCount + 'ä»¶, ã‚¨ãƒ©ãƒ¼' + result.errorCount + 'ä»¶');

            templateSuccessCount += result.successCount;
            policySuccessCount += result.successCount;
            templateErrorCount += result.errorCount;
            policyErrorCount += result.errorCount;
          } catch (eRetry) {
            console.error('âŒ å†è¨­å®šã‚¨ãƒ©ãƒ¼: ' + eRetry.message);
          }
        }
      }

      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: 0,
        successCount: processedCount + finalRetryResult.successCount,
        errorCount: errorCount + finalRetryResult.errorCount,
        message: 'âœ… æœ€çµ‚ãƒªãƒˆãƒ©ã‚¤å®Œäº† (ä¿®æ­£: ' + finalRetryResult.successCount + ', æ®‹ã‚¨ãƒ©ãƒ¼: ' + finalRetryResult.errorCount + ')',
        logType: finalRetryResult.errorCount > 0 ? 'warning' : 'success'
      });
    } else {
      console.log('âœ… æœ€çµ‚ã‚¨ãƒ©ãƒ¼ãªã—');
      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: 0,
        successCount: processedCount,
        errorCount: errorCount,
        message: 'âœ… æœ€çµ‚ã‚¨ãƒ©ãƒ¼ãƒã‚§ãƒƒã‚¯å®Œäº†ï¼ˆã‚¨ãƒ©ãƒ¼ãªã—ï¼‰',
        logType: 'success'
      });
    }

    // å‡¦ç†å®Œäº†ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«é€šçŸ¥
    updateProgressSidebar_({
      currentBatch: totalBatches || 0,
      totalBatches: totalBatches || 0,
      successCount: processedCount,
      errorCount: errorCount,
      message: 'âœ… ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ',
      logType: 'success',
      isCompleted: true
    });

    // ============================================
    // å…¨å‡¦ç†å®Œäº†
    // ============================================
    clearProcessingStateComplete_();
    clearAllTriggers();

    var end = new Date();
    var duration = Math.round((end - startTime) / 1000);
    var usd = calculateTokenCostUSD(settings.platform, settings.model, totalPrompt, totalCompletion);
    var rate = sheet.getRange("C2").getValue() || 145;
    var avgTokens = processedCount > 0 ? Math.round((totalPrompt + totalCompletion) / processedCount) : 0;

    var report = 'âœ… çµ±åˆå‡¦ç†å®Œäº†\n\n' +
      'ã€PHASE1: ç¿»è¨³ãƒ»è¨ˆç®—ã€‘\n' +
      'å‡¦ç†æ™‚é–“: ' + duration + 'ç§’\n' +
      'å‡¦ç†æ¸ˆã¿: ' + processedCount + 'ä»¶\n' +
      'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'ä»¶\n' +
      'ã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶\n\n' +
      'ğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡:\n' +
      'â€¢ å…¥åŠ›: ' + totalPrompt.toLocaleString() + '\n' +
      'â€¢ å‡ºåŠ›: ' + totalCompletion.toLocaleString() + '\n' +
      'â€¢ åˆè¨ˆ: ' + (totalPrompt + totalCompletion).toLocaleString() + '\n' +
      'â€¢ å¹³å‡/ä»¶: ' + avgTokens + '\n' +
      'â€¢ æ¨å®šè²»ç”¨: $' + usd.toFixed(4) + 'ï¼ˆç´„' + Math.round(usd * rate) + 'å††, ' + settings.platform + ' / ' + settings.model + 'ï¼‰\n\n' +
      'ã€PHASE2: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼ã€‘\n' +
      'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæˆåŠŸ: ' + (templateSuccessCount || 0) + 'ä»¶\n' +
      'ãƒãƒªã‚·ãƒ¼æˆåŠŸ: ' + (policySuccessCount || 0) + 'ä»¶\n' +
      'ã‚¨ãƒ©ãƒ¼: ' + (templateErrorCount || 0) + 'ä»¶\n\n' +
      'ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + (props.getProperty('categoryDisplay_complete') || '') + '\n' +
      'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ' + templateName;
    
    conditionalShowAlert(report, "success");

  } catch (e) {
    showAlert('çµ±åˆå‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
    clearProcessingStateComplete_();
    clearAllTriggers();
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  çµ±åˆå‡¦ç†ç”¨ã®çŠ¶æ…‹ã‚¯ãƒªã‚¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function clearProcessingStateComplete_() {
  var props = PropertiesService.getScriptProperties();
  [
    'isProcessing_complete', 'lastProcessedRowIndex_complete',
    'totalPrompt_complete', 'totalCompletion_complete',
    'processedCount_complete', 'errorCount_complete', 'skippedCount_complete',
    'targetRows_complete', 'startTime_complete', 'processing_phase_complete',
    'manualWeight_complete', 'manualSize_complete', 'category_complete',
    'categoryDisplay_complete', 'templateName_complete'
  ].forEach(function(k){ props.deleteProperty(k); });
}
// ========================================
// ãƒãƒƒãƒå‡¦ç†ç”¨ã®å®šæ•°
// ========================================
const BATCH_SIZE = 50; // 1å›ã®å‡¦ç†è¡Œæ•°
const MAX_BATCHES_PER_EXECUTION = 10; // 1å›ã®å®Ÿè¡Œã§æœ€å¤§8ãƒãƒƒãƒï¼ˆ400è¡Œï¼‰
const PROGRESS_KEY = 'BATCH_PROGRESS'; // é€²æ—ä¿å­˜ã‚­ãƒ¼
const MAX_EXECUTION_TIME_MS = 300000; // æœ€å¤§å®Ÿè¡Œæ™‚é–“ï¼ˆ5åˆ† = 300ç§’ï¼‰
const WAIT_BETWEEN_BATCHES_MS = 2000; // ãƒãƒƒãƒé–“ã®å¾…æ©Ÿæ™‚é–“ï¼ˆ2ç§’ï¼‰

// ========================================
// çµ±åˆå®Ÿè¡Œã®ãƒãƒƒãƒå‡¦ç†ç‰ˆï¼ˆé–‹å§‹ï¼‰
// ========================================
function runSelectedRowsCompleteBatch() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const selection = sheet.getActiveRange();
  const startRow = selection.getRow();
  const numRows = selection.getNumRows();
  
  const props = PropertiesService.getScriptProperties();
  
  // æ—¢å­˜ã®é€²æ—ã¨ãƒˆãƒªã‚¬ãƒ¼ã‚’ã‚¯ãƒªã‚¢
  props.deleteProperty(PROGRESS_KEY);
  deleteAllBatchTriggers();
  
  // é€²æ—æƒ…å ±ã‚’åˆæœŸåŒ–
  props.setProperty(PROGRESS_KEY, JSON.stringify({
    startRow: startRow,
    totalRows: numRows,
    processedRows: 0,
    sheetName: sheet.getName(),
    mode: 'complete',
    startTime: new Date().toISOString()
  }));
  
  Logger.log('=== ãƒãƒƒãƒå‡¦ç†é–‹å§‹ ===');
  Logger.log('å¯¾è±¡: ' + startRow + 'è¡Œç›®ã‹ã‚‰' + numRows + 'è¡Œ');
  Logger.log('1å®Ÿè¡Œã‚ãŸã‚Šæœ€å¤§: ' + MAX_BATCHES_PER_EXECUTION + 'ãƒãƒƒãƒï¼ˆ' + (BATCH_SIZE * MAX_BATCHES_PER_EXECUTION) + 'è¡Œï¼‰');
  
  SpreadsheetApp.getUi().alert(
    'ğŸš€ ãƒãƒƒãƒå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™\n\n' +
    'å¯¾è±¡: ' + numRows + 'è¡Œ\n' +
    '1ãƒãƒƒãƒ: ' + BATCH_SIZE + 'è¡Œ\n' +
    '1å®Ÿè¡Œã‚ãŸã‚Š: æœ€å¤§' + MAX_BATCHES_PER_EXECUTION + 'ãƒãƒƒãƒï¼ˆ' + (BATCH_SIZE * MAX_BATCHES_PER_EXECUTION) + 'è¡Œï¼‰\n\n' +
    'â€»å®Œå…¨è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã¾ã™'
  );
  
  // åˆå›å®Ÿè¡Œ
  continueBatchProcessing();
}

// ========================================
// ç¿»è¨³ãƒ»è¨ˆç®—ã®ãƒãƒƒãƒå‡¦ç†ç‰ˆï¼ˆé–‹å§‹ï¼‰
// ========================================
function runSelectedRowsBatch() {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();
  const selection = sheet.getActiveRange();
  const startRow = selection.getRow();
  const numRows = selection.getNumRows();
  
  const props = PropertiesService.getScriptProperties();
  
  // æ—¢å­˜ã®é€²æ—ã¨ãƒˆãƒªã‚¬ãƒ¼ã‚’ã‚¯ãƒªã‚¢
  props.deleteProperty(PROGRESS_KEY);
  deleteAllBatchTriggers();
  
  // é€²æ—æƒ…å ±ã‚’åˆæœŸåŒ–
  props.setProperty(PROGRESS_KEY, JSON.stringify({
    startRow: startRow,
    totalRows: numRows,
    processedRows: 0,
    sheetName: sheet.getName(),
    mode: 'simple',
    startTime: new Date().toISOString()
  }));
  
  Logger.log('=== ãƒãƒƒãƒå‡¦ç†é–‹å§‹ ===');
  Logger.log('å¯¾è±¡: ' + startRow + 'è¡Œç›®ã‹ã‚‰' + numRows + 'è¡Œ');
  Logger.log('1å®Ÿè¡Œã‚ãŸã‚Šæœ€å¤§: ' + MAX_BATCHES_PER_EXECUTION + 'ãƒãƒƒãƒï¼ˆ' + (BATCH_SIZE * MAX_BATCHES_PER_EXECUTION) + 'è¡Œï¼‰');
  
  SpreadsheetApp.getUi().alert(
    'ğŸš€ ãƒãƒƒãƒå‡¦ç†ã‚’é–‹å§‹ã—ã¾ã™\n\n' +
    'å¯¾è±¡: ' + numRows + 'è¡Œ\n' +
    '1ãƒãƒƒãƒ: ' + BATCH_SIZE + 'è¡Œ\n' +
    '1å®Ÿè¡Œã‚ãŸã‚Š: æœ€å¤§' + MAX_BATCHES_PER_EXECUTION + 'ãƒãƒƒãƒï¼ˆ' + (BATCH_SIZE * MAX_BATCHES_PER_EXECUTION) + 'è¡Œï¼‰\n\n' +
    'â€»å®Œå…¨è‡ªå‹•ã§å®Ÿè¡Œã•ã‚Œã¾ã™'
  );
  
  // åˆå›å®Ÿè¡Œ
  continueBatchProcessing();
}

// ========================================
// ãƒãƒƒãƒå‡¦ç†ã®ç¶™ç¶šå®Ÿè¡Œï¼ˆãƒ«ãƒ¼ãƒ—å‡¦ç†ï¼‰
// ========================================
function continueBatchProcessing() {
  const executionStartTime = new Date().getTime();
  const props = PropertiesService.getScriptProperties();
  
  let batchCount = 0;
  
  while (true) {
    // ğŸ”¥ 8ãƒãƒƒãƒé”æˆãƒã‚§ãƒƒã‚¯
    if (batchCount >= MAX_BATCHES_PER_EXECUTION) {
      Logger.log('âœ“ ' + MAX_BATCHES_PER_EXECUTION + 'ãƒãƒƒãƒå®Œäº†ã€‚æ¬¡ã®å®Ÿè¡Œã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ã€‚');
      scheduleNextExecution();
      return;
    }
    
    // å®Ÿè¡Œæ™‚é–“ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆå›é¿ï¼‰
    const elapsedTime = new Date().getTime() - executionStartTime;
    if (elapsedTime > MAX_EXECUTION_TIME_MS) {
      Logger.log('â° å®Ÿè¡Œæ™‚é–“ä¸Šé™ã«é”ã—ã¾ã—ãŸï¼ˆ' + Math.floor(elapsedTime/1000) + 'ç§’ï¼‰ã€‚æ¬¡ã®å®Ÿè¡Œã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã™ã€‚');
      scheduleNextExecution();
      return;
    }
    
    const progressJson = props.getProperty(PROGRESS_KEY);
    
    if (!progressJson) {
      Logger.log('âŒ é€²æ—æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    const progress = JSON.parse(progressJson);
    const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(progress.sheetName);
    
    if (!sheet) {
      props.deleteProperty(PROGRESS_KEY);
      Logger.log('âŒ ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return;
    }
    
    // å‡¦ç†å®Œäº†ãƒã‚§ãƒƒã‚¯
    if (progress.processedRows >= progress.totalRows) {
      Logger.log('=== âœ… å…¨ãƒãƒƒãƒå®Œäº† ===');
      props.deleteProperty(PROGRESS_KEY);
      deleteAllBatchTriggers();
      
      try {
        const elapsed = calculateElapsedTime(progress.startTime);
        SpreadsheetApp.getUi().alert(
          'âœ… å…¨ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸï¼\n\n' +
          'å‡¦ç†è¡Œæ•°: ' + progress.totalRows + 'è¡Œ\n' +
          'å‡¦ç†æ™‚é–“: ' + elapsed
        );
      } catch (e) {
        Logger.log('å®Œäº†é€šçŸ¥: ' + e.toString());
      }
      return;
    }
    
    // ä»Šå›å‡¦ç†ã™ã‚‹ç¯„å›²ã‚’è¨ˆç®—
    const currentStartRow = progress.startRow + progress.processedRows;
    const remainingRows = progress.totalRows - progress.processedRows;
    const currentBatchSize = Math.min(BATCH_SIZE, remainingRows);
    
    const batchNum = Math.floor(progress.processedRows / BATCH_SIZE) + 1;
    const totalBatches = Math.ceil(progress.totalRows / BATCH_SIZE);
    
    Logger.log('=== ãƒãƒƒãƒ ' + batchNum + '/' + totalBatches + ' é–‹å§‹ï¼ˆå®Ÿè¡Œå†…' + (batchCount + 1) + '/' + MAX_BATCHES_PER_EXECUTION + 'ï¼‰===');
    Logger.log('ç¯„å›²: ' + currentStartRow + 'ã€œ' + (currentStartRow + currentBatchSize - 1) + 'è¡Œç›®');
    
    try {
      // ã‚·ãƒ¼ãƒˆã®ç¯„å›²ã‚’é¸æŠ
      const range = sheet.getRange(currentStartRow, 1, currentBatchSize, sheet.getLastColumn());
      sheet.setActiveRange(range);
      
      // ãƒ¢ãƒ¼ãƒ‰ã«å¿œã˜ã¦å‡¦ç†ã‚’å®Ÿè¡Œ
      if (progress.mode === 'complete') {
        runSelectedRowsComplete();
      } else {
        runSelectedRows();
      }
      
      // é€²æ—ã‚’æ›´æ–°
      progress.processedRows += currentBatchSize;
      props.setProperty(PROGRESS_KEY, JSON.stringify(progress));
      
      const percentage = Math.round((progress.processedRows / progress.totalRows) * 100);
      Logger.log('é€²æ—: ' + progress.processedRows + '/' + progress.totalRows + 'è¡Œ (' + percentage + '%)');
      Logger.log('=== ãƒãƒƒãƒ ' + batchNum + '/' + totalBatches + ' å®Œäº† ===');
      
      batchCount++;
      
      // ãƒãƒƒãƒé–“ã§å°‘ã—å¾…æ©Ÿ
      if (progress.processedRows < progress.totalRows) {
        Utilities.sleep(WAIT_BETWEEN_BATCHES_MS);
      }
      
    } catch (e) {
      Logger.log('âš ï¸ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ: ' + e.toString());
      Logger.log('ã‚¨ãƒ©ãƒ¼è©³ç´°: ' + e.stack);
      
      // ã‚¨ãƒ©ãƒ¼æ™‚ã‚‚æ¬¡ã®å®Ÿè¡Œã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
      Logger.log('2åˆ†å¾Œã«è‡ªå‹•å†é–‹ã—ã¾ã™');
      scheduleNextExecution();
      return;
    }
  }
}

// ========================================
// æ¬¡ã®å®Ÿè¡Œã‚’ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«
// ========================================
function scheduleNextExecution() {
  deleteAllBatchTriggers();

  try {
    ScriptApp.newTrigger('continueBatchProcessing')
      .timeBased()
      .after(2 * 60 * 1000) // 2åˆ†å¾Œ
      .create();

    Logger.log('âœ“ æ¬¡ã®å®Ÿè¡Œã‚’2åˆ†å¾Œã«ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã—ã¾ã—ãŸ');

    // é€²æ—æƒ…å ±ã‚’å–å¾—ã—ã¦ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤º
    try {
      var props = PropertiesService.getScriptProperties();
      var progressJson = props.getProperty('BATCH_PROGRESS');

      if (progressJson) {
        var progress = JSON.parse(progressJson);
        var processedRows = progress.processedRows || 0;
        var totalRows = progress.totalRows || 0;
        var currentBatch = Math.floor(processedRows / 50) + 1;
        var totalBatches = Math.ceil(totalRows / 50);
        var percentComplete = totalRows > 0 ? Math.round((processedRows / totalRows) * 100) : 0;

        SpreadsheetApp.getActiveSpreadsheet().toast(
          'ãƒãƒƒãƒ ' + currentBatch + '/' + totalBatches + ' å®Œäº† (' + percentComplete + '%)\n' +
          'ç´„2åˆ†å¾Œã«è‡ªå‹•ç¶™ç¶šã—ã¾ã™\n' +
          'D2ã‚»ãƒ«=STOPã§åœæ­¢å¯èƒ½',
          'â° ãƒãƒƒãƒå‡¦ç†ç¶™ç¶šä¸­',
          10
        );
      } else {
        SpreadsheetApp.getActiveSpreadsheet().toast(
          'ç´„2åˆ†å¾Œã«è‡ªå‹•ç¶™ç¶šã—ã¾ã™\n' +
          'D2ã‚»ãƒ«=STOPã§åœæ­¢å¯èƒ½',
          'â° ãƒãƒƒãƒå‡¦ç†ç¶™ç¶šä¸­',
          10
        );
      }
    } catch (toastError) {
      // ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼ã¯ç„¡è¦–
      Logger.log('ãƒˆãƒ¼ã‚¹ãƒˆè¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + toastError.toString());
    }

  } catch (e) {
    Logger.log('âŒ ãƒˆãƒªã‚¬ãƒ¼ä½œæˆã‚¨ãƒ©ãƒ¼: ' + e.toString());
  }
}

// ========================================
// ã™ã¹ã¦ã®ãƒãƒƒãƒãƒˆãƒªã‚¬ãƒ¼ã‚’å‰Šé™¤
// ========================================
function deleteAllBatchTriggers() {
  const triggers = ScriptApp.getProjectTriggers();
  triggers.forEach(trigger => {
    if (trigger.getHandlerFunction() === 'continueBatchProcessing') {
      try {
        ScriptApp.deleteTrigger(trigger);
      } catch (e) {
        // å‰Šé™¤å¤±æ•—ã¯ç„¡è¦–
      }
    }
  });
}

// ========================================
// æ‰‹å‹•ã§å‡¦ç†ã‚’ç¶™ç¶š
// ========================================
function resumeBatchProcessing() {
  const props = PropertiesService.getScriptProperties();
  const progressJson = props.getProperty(PROGRESS_KEY);
  
  if (!progressJson) {
    SpreadsheetApp.getUi().alert('å†é–‹ã™ã‚‹å‡¦ç†ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const progress = JSON.parse(progressJson);
  const percentage = Math.round((progress.processedRows / progress.totalRows) * 100);
  
  Logger.log('=== ãƒãƒƒãƒå‡¦ç†ã‚’æ‰‹å‹•å†é–‹ ===');
  Logger.log('é€²æ—: ' + progress.processedRows + '/' + progress.totalRows + 'è¡Œ (' + percentage + '%)');
  
  continueBatchProcessing();
}

// ========================================
// ãƒãƒƒãƒå‡¦ç†ã®é€²æ—ç¢ºèª
// ========================================
function checkBatchProgress() {
  const props = PropertiesService.getScriptProperties();
  const progressJson = props.getProperty(PROGRESS_KEY);
  
  if (!progressJson) {
    SpreadsheetApp.getUi().alert('å®Ÿè¡Œä¸­ã®ãƒãƒƒãƒå‡¦ç†ã¯ã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const progress = JSON.parse(progressJson);
  const percentage = Math.round((progress.processedRows / progress.totalRows) * 100);
  const elapsed = calculateElapsedTime(progress.startTime);
  const currentBatch = Math.ceil(progress.processedRows / BATCH_SIZE);
  const totalBatches = Math.ceil(progress.totalRows / BATCH_SIZE);
  
  SpreadsheetApp.getUi().alert(
    'ğŸ“Š ãƒãƒƒãƒå‡¦ç†ã®é€²æ—\n\n' +
    'ã‚·ãƒ¼ãƒˆ: ' + progress.sheetName + '\n' +
    'ãƒ¢ãƒ¼ãƒ‰: ' + (progress.mode === 'complete' ? 'çµ±åˆå®Ÿè¡Œ' : 'ç¿»è¨³ãƒ»è¨ˆç®—') + '\n\n' +
    'é€²æ—: ' + progress.processedRows + '/' + progress.totalRows + 'è¡Œ (' + percentage + '%)\n' +
    'ãƒãƒƒãƒ: ' + currentBatch + '/' + totalBatches + '\n' +
    'çµŒéæ™‚é–“: ' + elapsed
  );
}

// ========================================
// ãƒãƒƒãƒå‡¦ç†ã®ã‚­ãƒ£ãƒ³ã‚»ãƒ«
// ========================================
function cancelBatchProcessing() {
  const props = PropertiesService.getScriptProperties();
  const progressJson = props.getProperty(PROGRESS_KEY);
  
  if (!progressJson) {
    SpreadsheetApp.getUi().alert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã™ã‚‹å‡¦ç†ãŒã‚ã‚Šã¾ã›ã‚“');
    return;
  }
  
  const result = SpreadsheetApp.getUi().alert(
    'ç¢ºèª',
    'ãƒãƒƒãƒå‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã™ã‹ï¼Ÿ',
    SpreadsheetApp.getUi().ButtonSet.YES_NO
  );
  
  if (result === SpreadsheetApp.getUi().Button.YES) {
    props.deleteProperty(PROGRESS_KEY);
    deleteAllBatchTriggers();
    
    Logger.log('=== ãƒãƒƒãƒå‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ« ===');
    SpreadsheetApp.getUi().alert('ãƒãƒƒãƒå‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ');
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é¸æŠè¡Œã®å‡¦ç†ï¼šç¿»è¨³å°‚ç”¨ï¼ˆAIå‘¼ã³å‡ºã—ã®ã¿ï¼‰
  ğŸ”¹ ä¸¦åˆ—å‡¦ç†ã‚’50è¡Œã«æ‹¡å¤§

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç¿»è¨³çµæœã®ã¿ã‚’ã‚·ãƒ¼ãƒˆã«åæ˜ 
  ğŸ”¹ P2ã‚»ãƒ«ã®å€¤ã¯å¤–éƒ¨ã‹ã‚‰å—ã‘å–ã‚‹

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ—¥æœ¬èªæ¤œå‡ºé–¢æ•°
  ğŸ”¹ æ–‡å­—åˆ—ã«æ—¥æœ¬èª(ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—)ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç¿»è¨³çµæœã®æ¤œè¨¼é–¢æ•°
  ğŸ”¹ Måˆ—ãƒ»Nåˆ—ã«æ—¥æœ¬èªãŒæ··å…¥ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
  ğŸ”¹ Påˆ—ãŒ1ã€œ80ã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
  ğŸ”¹ Qåˆ—ãŒ1ã€œ500ã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç¿»è¨³å°‚ç”¨ã®çŠ¶æ…‹ã‚¯ãƒªã‚¢

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é¸æŠè¡Œã®å‡¦ç†ï¼šè¨ˆç®—å°‚ç”¨ï¼ˆç¿»è¨³ä¸è¦ï¼‰
  ğŸ”¹ 50è¡Œã¾ã¨ã‚ã¦ä¸€æ‹¬å‡¦ç†ãƒ»åˆ—ã”ã¨ã«é †ç•ªã«å‡ºåŠ›
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function runSelectedRowsCalculate() {
  var SCRIPT_NAME = 'runSelectedRowsCalculate';
  var startTime = new Date();

  try {
    var settings = getSettings();
    if (!settings) return;

    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }

    updateExchangeRate(sheet);

    var active = sheet.getActiveRange();
    if (!active) {
      conditionalShowAlert("è¨ˆç®—ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "info");
      return;
    }

    var startRow = active.getRow(), endRow = active.getLastRow();
    if (endRow < 5) {
      conditionalShowAlert("5è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "info");
      return;
    }

    var selectedRows = [];
    var skippedCount = 0;
    var untranslatedCount = 0;

    for (var i = startRow; i <= endRow; i++) {
      if (i < 5) {
        skippedCount++;
        continue;
      }

      var jpTitle = sheet.getRange(i, CONFIG.COLUMNS.JP_TITLE).getValue();
      var jpDesc = sheet.getRange(i, CONFIG.COLUMNS.JP_DESC).getValue();
      var costYen = Number(sheet.getRange(i, CONFIG.COLUMNS.COST_YEN).getValue());
      var enTitle = sheet.getRange(i, CONFIG.COLUMNS.EN_TITLE).getValue();

      if (jpTitle && jpDesc && costYen > 0) {
        selectedRows.push(i);
        if (!enTitle) {
          untranslatedCount++;
        }
      } else {
        skippedCount++;
      }
    }

    if (selectedRows.length === 0) {
      conditionalShowAlert('é¸æŠç¯„å›²ã«è¨ˆç®—å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚\n\nå¿…è¦ãªæ¡ä»¶:\nâ€¢ Jåˆ—: æ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«\nâ€¢ Kåˆ—: æ—¥æœ¬èªèª¬æ˜\nâ€¢ Iåˆ—: ä»•å…¥ã‚Œå€¤', "info");
      return;
    }

    var manualWeight, manualSize;
    if (settings.shippingCalculationMethod === 'FIXED') {
      manualWeight = 0;
      manualSize = 'å›ºå®šé€æ–™';
    } else {
      manualWeight = sheet.getRange("J2").getValue();
      var L = sheet.getRange("L2").getValue();
      var M = sheet.getRange("M2").getValue();
      var N = sheet.getRange("N2").getValue();

      if (![manualWeight, L, M, N].every(function(v) { return typeof v === 'number' && v > 0; })) {
        showAlert('ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ã§ã¯J2/L2/M2/N2ã«æ­£ã®æ•°å€¤ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚\né€æ–™å›ºå®šãƒ¢ãƒ¼ãƒ‰ã§ã¯ä¸è¦ã§ã™ã€‚', "error");
        return;
      }

      manualSize = L + 'x' + M + 'x' + N;
    }

    var confirmMessage = 'ã€è¨ˆç®—å°‚ç”¨ã€‘é¸æŠ ' + selectedRows.length + ' ä»¶ã‚’è¨ˆç®—ã—ã¾ã™ã€‚\n\n' +
      'æ¢±åŒ…é‡é‡: ' + manualWeight + ' g\n' +
      'æ¢±åŒ…ã‚µã‚¤ã‚º: ' + manualSize + '\n' +
      'é€æ–™è¨ˆç®—: ' + (settings.shippingCalculationMethod === 'TABLE' ? 'ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—' : 'å›ºå®šé‡‘é¡') + '\n\n' +
      'è¨ˆç®—å†…å®¹:\n' +
      'â€¢ é…é€æ–¹æ³•åˆ¤å®š\n' +
      'â€¢ é€æ–™è¨ˆç®—\n' +
      'â€¢ è²©å£²ä¾¡æ ¼è¨ˆç®—ï¼ˆDDU/DDPï¼‰\n' +
      'â€¢ åˆ©ç›Šè¨ˆç®—\n' +
      'â€¢ DDUä¾¡æ ¼èª¿æ•´ï¼ˆæœ‰åŠ¹æ™‚ï¼‰\n\n';
    
    if (untranslatedCount > 0) {
      confirmMessage += 'âš ï¸ ç¿»è¨³æœªå®Œäº†: ' + untranslatedCount + 'ä»¶\n' +
                       'ï¼ˆè¨ˆç®—ã¯å®Ÿè¡Œå¯èƒ½ã§ã™ãŒã€ç¿»è¨³ã‚‚å¿…è¦ãªå ´åˆã¯ã€Œé¸æŠè¡Œã‚’ç¿»è¨³ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼‰\n\n';
    }
    
    confirmMessage += 'ğŸ’¡ D2ã‚»ãƒ«ã§GO/STOPåˆ‡ã‚Šæ›¿ãˆå¯èƒ½\n' +
                     'ğŸ’¡ ä¸€æ‹¬å‡¦ç†: 50è¡Œ/ãƒãƒƒãƒ\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';

    var ok = conditionalStartConfirmation(confirmMessage, 'è¨ˆç®—å°‚ç”¨å®Ÿè¡Œã®ç¢ºèª');
    if (ok !== SpreadsheetApp.getUi().Button.YES) {
      conditionalShowAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', "info");
      return;
    }

    var processedCount = 0;
    var errorCount = 0;
    var errorDetails = [];

    var CALC_BATCH_SIZE = 50;
    for (var batchStart = 0; batchStart < selectedRows.length; batchStart += CALC_BATCH_SIZE) {
      var batchEnd = Math.min(batchStart + CALC_BATCH_SIZE, selectedRows.length);
      var batchRows = selectedRows.slice(batchStart, batchEnd);
      
      try {
        applyCalculationBatch_(sheet, batchRows, settings, manualWeight, manualSize);
        processedCount += batchRows.length;

        if (processedCount > 0 && processedCount % 5 === 0) {
          if (!checkStopControl()) {
            conditionalShowAlert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‡¦ç†ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸï¼ˆD2=STOPï¼‰ã€‚\nå‡¦ç†æ¸ˆã¿: ' + processedCount + 'ä»¶', 'warning');
            return;
          }
        }

      } catch (e) {
        errorCount += batchRows.length;
        errorDetails.push('ãƒãƒƒãƒ(è¡Œ' + batchRows[0] + 'ï½' + batchRows[batchRows.length-1] + '): ' + e.message);
        console.error('è¨ˆç®—ãƒãƒƒãƒã‚¨ãƒ©ãƒ¼: ' + e.message);
      }

      if (batchEnd < selectedRows.length) {
        Utilities.sleep(200);
      }
    }

    var end = new Date();
    var duration = Math.round((end - startTime) / 1000);

    var report = 'âœ… è¨ˆç®—å‡¦ç†å®Œäº†\n\n' +
      'å‡¦ç†æ™‚é–“: ' + duration + 'ç§’\n' +
      'è¨ˆç®—å®Œäº†: ' + processedCount + 'ä»¶\n' +
      'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'ä»¶\n' +
      'ã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶\n';
    
    if (untranslatedCount > 0) {
      report += 'ç¿»è¨³æœªå®Œäº†: ' + untranslatedCount + 'ä»¶\n';
    }
    report += '\n';

    if (errorDetails.length > 0 && errorDetails.length <= 5) {
      report += 'âš ï¸ ã‚¨ãƒ©ãƒ¼è©³ç´°:\n' + errorDetails.join('\n') + '\n\n';
    } else if (errorDetails.length > 5) {
      report += 'âš ï¸ ã‚¨ãƒ©ãƒ¼è©³ç´°ï¼ˆæœ€åˆã®5ä»¶ï¼‰:\n' + errorDetails.slice(0, 5).join('\n') + '\n... ä»–' + (errorDetails.length - 5) + 'ä»¶\n\n';
    }

    report += 'ğŸ’¡ è¨ˆç®—çµæœ:\n' +
      'â€¢ Råˆ—: è²©å£²ä¾¡æ ¼ï¼ˆDDUï¼‰\n' +
      'â€¢ Såˆ—: é–¢ç¨è¾¼ã¿ä¾¡æ ¼ï¼ˆDDPï¼‰\n' +
      'â€¢ Tåˆ—: é€æ–™\n' +
      'â€¢ Uåˆ—: åˆ©ç›Šé¡\n' +
      'â€¢ Xåˆ—: é…é€æ–¹æ³•\n';

    if (settings.dduAdjustmentEnabled) {
      report += 'â€¢ AEåˆ—: DDUèª¿æ•´ä¾¡æ ¼ï¼ˆé–¾å€¤ä»¥ä¸Šã®å ´åˆï¼‰\n';
    }
    
    if (untranslatedCount > 0) {
      report += '\nğŸ’¡ ç¿»è¨³ãŒå¿…è¦ãªå ´åˆã¯ã€Œé¸æŠè¡Œã‚’ç¿»è¨³ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„';
    }

    conditionalShowAlert(report, processedCount > 0 ? "success" : "warning");

  } catch (e) {
    showAlert('è¨ˆç®—å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ”¹ ãƒãƒƒãƒå˜ä½ã§ä¸€æ‹¬è¨ˆç®—ãƒ»åˆ—ã”ã¨ã«é †ç•ªã«å‡ºåŠ›ï¼ˆä¿®æ­£ç‰ˆï¼‰
  ä¾å­˜é–¢ä¿‚ã‚’è€ƒæ…®ã—ãŸé †åºã§50è¡Œåˆ†ã‚’å‡¦ç†
  
  ã€ä¿®æ­£å†…å®¹ã€‘
  ç©ºæ¬„ã®è¡Œã‚‚å«ã‚ãŸé…åˆ—ã‚’ä½œæˆã—ã¦ä¸€æ‹¬æ›¸ãè¾¼ã¿
  â†’ é«˜é€Ÿ + æ­£ç¢º
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function applyCalculationBatch_(sheet, batchRows, settings, manualWeight, manualSize) {
  if (!batchRows || batchRows.length === 0) return;
  
  try {
    console.log('=== ä¸€æ‹¬è¨ˆç®—é–‹å§‹ï¼ˆè¡Œæ•°: ' + batchRows.length + 'ï¼‰ ===');
    
    // ========================================
    // å‰å‡¦ç†: æœ€å°è¡Œã¨æœ€å¤§è¡Œã‚’å–å¾—
    // ========================================
    var minRow = Math.min.apply(null, batchRows);
    var maxRow = Math.max.apply(null, batchRows);
    var rowCount = maxRow - minRow + 1;
    
    // batchRowsã‚’é«˜é€Ÿæ¤œç´¢ç”¨ã«ã‚»ãƒƒãƒˆåŒ–
    var batchRowsSet = {};
    for (var i = 0; i < batchRows.length; i++) {
      batchRowsSet[batchRows[i]] = true;
    }
    
    // ========================================
    // â‘  Yåˆ—ãƒ»Zåˆ—ãƒ»Xåˆ—è¨­å®š
    // ========================================
    console.log('â‘  Yåˆ—ãƒ»Zåˆ—ãƒ»Xåˆ—è¨­å®šä¸­...');
    
    var weightData = [];
    var sizeData = [];
    var methodData = [];
    
    // Iåˆ—ï¼ˆCOST_YENï¼‰ã‚’ä¸€æ‹¬èª­ã¿å–ã‚Š
    var costYenRange = sheet.getRange(minRow, CONFIG.COLUMNS.COST_YEN, rowCount, 1);
    var costYenValues = costYenRange.getValues();
    
    for (var row = minRow; row <= maxRow; row++) {
      if (batchRowsSet[row]) {
        // ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š
        var costYen = Number(costYenValues[row - minRow][0]);
        
        if (settings.shippingCalculationMethod === 'FIXED') {
          var determinedMethod = getSelectedShippingMethod(costYen, 0, 0, '');
          weightData.push(['']);
          sizeData.push(['']);
          methodData.push([determinedMethod]);
        } else {
          var weight = Number(manualWeight);
          var size = String(manualSize || '');
          var volWeight = weight;
          var method = getSelectedShippingMethod(costYen, weight, volWeight, size);
          
          weightData.push([weight]);
          sizeData.push([size]);
          methodData.push([method]);
        }
      } else {
        // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆç©ºæ¬„ï¼‰
        weightData.push(['']);
        sizeData.push(['']);
        methodData.push(['']);
      }
    }
    
    sheet.getRange(minRow, CONFIG.COLUMNS.WEIGHT, rowCount, 1).setValues(weightData);
    sheet.getRange(minRow, CONFIG.COLUMNS.SIZE, rowCount, 1).setValues(sizeData);
    sheet.getRange(minRow, CONFIG.COLUMNS.METHOD, rowCount, 1).setValues(methodData);
    SpreadsheetApp.flush();
    Utilities.sleep(300);
    
    var feeRate = sheet.getRange("F1").getValue() || 0;
    
    // ========================================
    // â‘¡ Våˆ—ï¼ˆæ‰‹æ•°æ–™ç‡ï¼‰è¨­å®š
    // ========================================
    console.log('â‘¡ Våˆ—è¨­å®šä¸­...');
    var feeData = [];
    for (var row = minRow; row <= maxRow; row++) {
      if (batchRowsSet[row]) {
        feeData.push([feeRate]);
      } else {
        feeData.push(['']);
      }
    }
    sheet.getRange(minRow, CONFIG.COLUMNS.FEE, rowCount, 1).setValues(feeData);
    SpreadsheetApp.flush();
    Utilities.sleep(300);
    
    // ========================================
    // â‘¢ Wåˆ—ï¼ˆåˆ©ç›Šç‡ or åˆ©ç›Šé¡ï¼‰è¨­å®š
    // ========================================
    console.log('â‘¢ Wåˆ—è¨­å®šä¸­...');
    var rateData = [];
    var profitData = [];
    
    if (settings.profitCalculationMethod === 'RATE') {
      var profitRate = sheet.getRange("H2").getValue() || 0;
      for (var row = minRow; row <= maxRow; row++) {
        if (batchRowsSet[row]) {
          rateData.push([profitRate]);
        } else {
          rateData.push(['']);
        }
      }
      sheet.getRange(minRow, CONFIG.COLUMNS.RATE, rowCount, 1).setValues(rateData);
    } else {
      var profitAmount = sheet.getRange("H1").getValue();
      
      for (var row = minRow; row <= maxRow; row++) {
        if (batchRowsSet[row]) {
          var costYen = Number(costYenValues[row - minRow][0]);
          var currentProfitAmount = profitAmount;
          if (!currentProfitAmount || isNaN(currentProfitAmount)) {
            currentProfitAmount = getProfitAmountByCost(costYen);
          }
          profitData.push([currentProfitAmount]);
          rateData.push(['']);
        } else {
          profitData.push(['']);
          rateData.push(['']);
        }
      }
      sheet.getRange(minRow, CONFIG.COLUMNS.RATE, rowCount, 1).setValues(rateData);
      sheet.getRange(minRow, CONFIG.COLUMNS.PROFIT, rowCount, 1).setValues(profitData);
    }
    SpreadsheetApp.flush();
    Utilities.sleep(300);
    
    // ========================================
    // â‘£ AAåˆ—ï¼ˆä½“ç©é‡é‡ï¼‰è¨­å®š
    // ========================================
    console.log('â‘£ AAåˆ—è¨­å®šä¸­...');
    var volumeFormulas = [];
    for (var row = minRow; row <= maxRow; row++) {
      if (batchRowsSet[row]) {
        volumeFormulas.push([
          '=MAX(ROUND((INDEX(SPLIT(Z' + row + ',"x"),1)*INDEX(SPLIT(Z' + row + ',"x"),2)*INDEX(SPLIT(Z' + row + ',"x"),3))/5),200)'
        ]);
      } else {
        volumeFormulas.push(['']);
      }
    }
    sheet.getRange(minRow, CONFIG.COLUMNS.VOLUME, rowCount, 1).setFormulas(volumeFormulas);
    SpreadsheetApp.flush();
    Utilities.sleep(500);
    
    // ========================================
    // â‘¤ Tåˆ—ï¼ˆé€æ–™ï¼‰è¨­å®š
    // ========================================
    console.log('â‘¤ Tåˆ—ï¼ˆé€æ–™ï¼‰è¨­å®šä¸­...');
    
    if (settings.shippingCalculationMethod === 'FIXED') {
      var shippingData = [];
      for (var row = minRow; row <= maxRow; row++) {
        if (batchRowsSet[row]) {
          var fixed = sheet.getRange("J1").getValue();
          if (!fixed || isNaN(fixed)) {
            var costYen = costYenValues[row - minRow][0];
            fixed = getShippingCostByCost(costYen);
          }
          shippingData.push([fixed]);
        } else {
          shippingData.push(['']);
        }
      }
      sheet.getRange(minRow, CONFIG.COLUMNS.SHIPPING, rowCount, 1).setValues(shippingData);
    } else {
      var shippingFormulas = [];
      for (var row = minRow; row <= maxRow; row++) {
        if (batchRowsSet[row]) {
          shippingFormulas.push([
            '=SHIPPING_COST(I' + row + ',Y' + row + ',AA' + row + ',X' + row + ',Z' + row + ')'
          ]);
        } else {
          shippingFormulas.push(['']);
        }
      }
      sheet.getRange(minRow, CONFIG.COLUMNS.SHIPPING, rowCount, 1).setFormulas(shippingFormulas);
    }
    SpreadsheetApp.flush();
    Utilities.sleep(500);
    
    // ========================================
    // â‘¥ Råˆ—ï¼ˆè²©å£²ä¾¡æ ¼DDUï¼‰è¨­å®š
    // ========================================
    console.log('â‘¥ Råˆ—ï¼ˆDDUä¾¡æ ¼ï¼‰è¨­å®šä¸­...');
    var priceFormulas = [];
    
    for (var row = minRow; row <= maxRow; row++) {
      if (batchRowsSet[row]) {
        if (settings.profitCalculationMethod === 'RATE') {
          priceFormulas.push([
            '=ROUND(((I' + row + '+T' + row + ')/(1-(V' + row + '+W' + row + '+$F$2+$Z$2))/$C$2)*100)/100'
          ]);
        } else {
          priceFormulas.push([
            '=ROUND(((I' + row + '+T' + row + '+U' + row + ')/(1-(V' + row + '+$F$2+$Z$2))/$C$2)*100)/100'
          ]);
        }
      } else {
        priceFormulas.push(['']);
      }
    }
    sheet.getRange(minRow, CONFIG.COLUMNS.PRICE, rowCount, 1).setFormulas(priceFormulas);
    SpreadsheetApp.flush();
    Utilities.sleep(500);
    
    // ========================================
    // â‘¦ Uåˆ—ï¼ˆåˆ©ç›Šé¡ï¼‰è¨­å®šï¼ˆåˆ©ç›Šç‡ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
    // ========================================
    if (settings.profitCalculationMethod === 'RATE') {
      console.log('â‘¦ Uåˆ—ï¼ˆåˆ©ç›Šé¡ï¼‰è¨­å®šä¸­...');
      var profitFormulas = [];
      for (var row = minRow; row <= maxRow; row++) {
        if (batchRowsSet[row]) {
          profitFormulas.push([
            '=ROUND(R' + row + '*$C$2*(1-(V' + row + '+$F$2+$Z$2)) - I' + row + ' - T' + row + ', 0)'
          ]);
        } else {
          profitFormulas.push(['']);
        }
      }
      sheet.getRange(minRow, CONFIG.COLUMNS.PROFIT, rowCount, 1).setFormulas(profitFormulas);
      SpreadsheetApp.flush();
      Utilities.sleep(500);
    }
    
    // ========================================
    // â‘§ ABåˆ—ï¼ˆæƒ³å®šé–¢ç¨ï¼‰è¨­å®š
    // ========================================
    console.log('â‘§ ABåˆ—ï¼ˆæƒ³å®šé–¢ç¨ï¼‰è¨­å®šä¸­...');
    var taxFormulas = [];
    for (var row = minRow; row <= maxRow; row++) {
      if (batchRowsSet[row]) {
        taxFormulas.push([
          '=ROUND(R' + row + '*$AD$2*$AE$2+$AC$1,2)'
        ]);
      } else {
        taxFormulas.push(['']);
      }
    }
    sheet.getRange(minRow, CONFIG.COLUMNS.ESTIMATED_TAX, rowCount, 1).setFormulas(taxFormulas);
    SpreadsheetApp.flush();
    Utilities.sleep(500);
    
    // ========================================
    // â‘¨ Såˆ—ï¼ˆé–¢ç¨è¾¼ã¿ä¾¡æ ¼DDPï¼‰è¨­å®š
    // ========================================
    console.log('â‘¨ Såˆ—ï¼ˆDDPä¾¡æ ¼ï¼‰è¨­å®šä¸­...');
    var ddpFormulas = [];
    for (var row = minRow; row <= maxRow; row++) {
      if (batchRowsSet[row]) {
        ddpFormulas.push([
          '=ROUND(R' + row + '+AB' + row + ',2)'
        ]);
      } else {
        ddpFormulas.push(['']);
      }
    }
    sheet.getRange(minRow, CONFIG.COLUMNS.TAX_INCLUDED_PRICE, rowCount, 1).setFormulas(ddpFormulas);
    SpreadsheetApp.flush();
    Utilities.sleep(500);
    
    // ========================================
    // â‘© AEåˆ—ï¼ˆDDUèª¿æ•´ä¾¡æ ¼ï¼‰è¨­å®š
    // ========================================
    if (settings.dduAdjustmentEnabled) {
      var priceMode = getPriceDisplayMode();
      
      if (priceMode !== 'TAX_INCLUDED') {
        console.log('â‘© AEåˆ—ï¼ˆDDUèª¿æ•´ä¾¡æ ¼ï¼‰è¨­å®šä¸­...');
        var dduFormulas = [];
        for (var row = minRow; row <= maxRow; row++) {
          if (batchRowsSet[row]) {
            dduFormulas.push([
              '=IF(AND(R' + row + '>=' + settings.dduThreshold + ', NOT(ISBLANK(S' + row + '))), S' + row + '-' + settings.dduAdjustmentAmount + ', "")'
            ]);
          } else {
            dduFormulas.push(['']);
          }
        }
        sheet.getRange(minRow, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE, rowCount, 1).setFormulas(dduFormulas);
        sheet.getRange(minRow, CONFIG.COLUMNS.DDU_ADJUSTED_PRICE, rowCount, 1).setNumberFormat('0.00');
        SpreadsheetApp.flush();
        Utilities.sleep(500);
      }
    }
    
    // ========================================
    // ä¾¡æ ¼ã‚»ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨­å®šï¼ˆå‡¦ç†å¯¾è±¡ã®è¡Œã®ã¿ï¼‰
    // ========================================
    console.log('ä¾¡æ ¼ã‚»ãƒ«ã®ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨­å®šä¸­...');
    for (var i = 0; i < batchRows.length; i++) {
      try {
        setPriceCellHighlight(sheet, batchRows[i]);
      } catch (e) {
        console.error('ãƒã‚¤ãƒ©ã‚¤ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼ï¼ˆè¡Œ' + batchRows[i] + 'ï¼‰: ' + e.message);
      }
    }
    
    console.log('=== è¨ˆç®—ãƒãƒƒãƒå®Œäº† ===');
    
  } catch (e) {
    console.error('ä¸€æ‹¬è¨ˆç®—é©ç”¨ã‚¨ãƒ©ãƒ¼: ' + e.message);
    throw e;
  }
}




/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒˆãƒªã‚¬ãƒ¼/çŠ¶æ…‹ç®¡ç†
/******************************************************
 * å®Œå…¨ç‰ˆï¼ˆã‚¨ãƒ©ãƒ¼ä¿®æ­£æ¸ˆã¿ï¼‰Part 4/5
 *  - ã€Œé¸æŠè¡Œã‚’ä¿å­˜ã—ã¦ã‚¯ãƒªã‚¢ã€ã€Œé¸æŠè¡Œã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤ã€ã€Œä¿å­˜ã‚·ãƒ¼ãƒˆä¸€è¦§ã€
 *  - åˆ©ç›Šé¡ãƒ¬ãƒ³ã‚¸ç®¡ç†ï¼ˆProfit_Amountsï¼‰
 *  - é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆ/ãƒ‡ãƒãƒƒã‚°ï¼ˆâ€»Airmailè¡¨ã¯ Shipping_Rates ã® I/J åˆ—ã«ä½œæˆï¼‰
 *  - ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ç”Ÿæˆã€ç¾åœ¨ã®è¨­å®šç¢ºèªã€å‡¦ç†çŠ¶æ³ç¢ºèªã€ãƒ†ã‚¹ãƒˆç³»
 *  - æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£
 ******************************************************/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ä¿å­˜ï¼ã‚¯ãƒªã‚¢é–¢é€£
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function saveSelectedRowsAndClear() {
  try {
    var settings = getSettings(); if (!settings) return;
    var sheet = validateAndGetSheet(); if (!sheet) return;

    var range = sheet.getActiveRange();
    if (!range) { 
      conditionalShowAlert("ä¿å­˜ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚","info"); 
      return; 
    }

    var startRow = range.getRow(), endRow = range.getLastRow();
    if (startRow < 5) { 
      conditionalShowAlert("5è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚","info"); 
      return; 
    }

    // ğŸ”¹ ä¿®æ­£ï¼šç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
    var ok = conditionalConfirmDialog(
      'é¸æŠã•ã‚ŒãŸ ' + startRow + ' ï½ ' + endRow + ' è¡Œã‚’ä¿å­˜ã‚·ãƒ¼ãƒˆã¸ã‚³ãƒ”ãƒ¼ã—ã€å…ƒã®å€¤ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã€‚\n' +
      'ãƒ»Oåˆ—ãƒ»Påˆ—ãƒ»AEåˆ—ã®æ•°å¼ã¯ä¿æŒ\nãƒ»ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šã¯ä¿æŒ\nãƒ»å…ƒã«æˆ»ã›ã¾ã›ã‚“\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
      'é¸æŠè¡Œã®ä¿å­˜ã¨ã‚¯ãƒªã‚¢'
    );
    
    if (ok !== SpreadsheetApp.getUi().Button.YES) { 
      conditionalShowAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 'info'); 
      return; 
    }

    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var requiredRows = endRow - startRow + 1;
    var targetSheet = getOrCreateSaveSheet(ss, requiredRows);
    var savedCount = saveRowsToSheet(sheet, targetSheet, startRow, endRow);
    clearSelectedRowsValues(sheet, startRow, endRow);

    var report = 'âœ… ä¿å­˜ãƒ»ã‚¯ãƒªã‚¢å®Œäº†\n\n' +
      'ğŸ“ ä¿å­˜å…ˆ: ã€Œ' + targetSheet.getName() + 'ã€\n' +
      'ğŸ“Š ä¿å­˜ä»¶æ•°: ' + savedCount + '\n' +
      'ğŸ—‘ï¸ ã‚¯ãƒªã‚¢ç¯„å›²: ' + startRow + 'ï½' + endRow + ' è¡Œ\n\n' +
      'âœ… ä¿æŒï¼šOåˆ—ãƒ»Påˆ—ãƒ»AEåˆ—ã®æ•°å¼ï¼å…¨åˆ—ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³\n' +
      'âŒ å‰Šé™¤ï¼šå…¥åŠ›å€¤ï¼ãã®ä»–ã®æ•°å¼ï¼ãƒã‚¤ãƒ©ã‚¤ãƒˆ';
    
    // ğŸ”¹ ä¿®æ­£ï¼šå®Œäº†é€šçŸ¥ã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
    conditionalShowAlert(report,"success");
  
  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼ã¯å¸¸ã«è¡¨ç¤º
    showAlert('ä¿å­˜ãƒ»ã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}

function clearSelectedRowsOnly() {
  try {
    var settings = getSettings(); if (!settings) return;
    var sheet = validateAndGetSheet(); if (!sheet) return;

    var range = sheet.getActiveRange();
    if (!range) { 
      conditionalShowAlert("å‰Šé™¤ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚","info"); 
      return; 
    }
    var startRow = range.getRow(), endRow = range.getLastRow();
    if (startRow < 5) { 
      conditionalShowAlert("5è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚","info"); 
      return; 
    }

    // ğŸ”¹ ä¿®æ­£ï¼šç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
    var ok = conditionalConfirmDialog(
      'é¸æŠ ' + startRow + 'ï½' + endRow + ' è¡Œã®ã‚»ãƒ«å€¤ã‚’å‰Šé™¤ã—ã¾ã™ã€‚\n' +
      'ãƒ»Oåˆ—ãƒ»Påˆ—ãƒ»AEåˆ—ã®æ•°å¼ã¯ä¿æŒ\nãƒ»ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šã¯ä¿æŒ\nãƒ»å…ƒã«æˆ»ã›ã¾ã›ã‚“\n\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
      'é¸æŠè¡Œã®ãƒ‡ãƒ¼ã‚¿å‰Šé™¤'
    );
    
    if (ok !== SpreadsheetApp.getUi().Button.YES) { 
      conditionalShowAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', "info"); 
      return; 
    }

    clearSelectedRowsValues(sheet, startRow, endRow);
    var count = endRow - startRow + 1;
    var msg = 'âœ… ãƒ‡ãƒ¼ã‚¿å‰Šé™¤å®Œäº†\n\n' +
      'ğŸ—‘ï¸ ' + startRow + 'ï½' + endRow + ' è¡Œ (' + count + 'è¡Œ)\n' +
      'âœ… ä¿æŒï¼šOåˆ—ãƒ»Påˆ—ãƒ»AEåˆ—ã®æ•°å¼ï¼å…¨åˆ—ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³\n' +
      'âŒ å‰Šé™¤ï¼šå…¥åŠ›å€¤ï¼Oåˆ—ãƒ»Påˆ—ãƒ»AEåˆ—ä»¥å¤–ã®æ•°å¼ï¼ãƒã‚¤ãƒ©ã‚¤ãƒˆ';
    
    // ğŸ”¹ ä¿®æ­£ï¼šå®Œäº†é€šçŸ¥ã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
    conditionalShowAlert(msg, "success");
    
  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼ã¯å¸¸ã«è¡¨ç¤º
    showAlert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}

function listSavedSheets() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheets = ss.getSheets();
    var MAX_ROWS_PER_SHEET = 5500;
    var saved = sheets.filter(function(sh){ return sh.getName().indexOf('ä¿å­˜ãƒ‡ãƒ¼ã‚¿_')===0; })
                      .sort().reverse();
    if (saved.length===0) { 
      conditionalShowAlert("ä¿å­˜ã•ã‚ŒãŸã‚·ãƒ¼ãƒˆã¯ã‚ã‚Šã¾ã›ã‚“ã€‚","info"); 
      return; 
    }
    
    var report = 'ğŸ“‹ ä¿å­˜ã•ã‚ŒãŸã‚·ãƒ¼ãƒˆä¸€è¦§ (' + saved.length + 'ä»¶)\n\n';
    for (var i=0;i<saved.length;i++) {
      var sh = saved[i];
      var rows = Math.max(0, sh.getLastRow() - 4);
      var cap = Math.round((rows / MAX_ROWS_PER_SHEET) * 100);
      var status = cap >= 100 ? "ğŸ”´ æº€æ¯" : cap >= 80 ? "ğŸŸ¡ æ®‹ã‚Šå°‘" : "ğŸŸ¢ ä½™è£•";
      report += (i+1) + '. ã€Œ' + sh.getName() + 'ã€\n' +
                '    ğŸ“Š ' + rows + '/' + MAX_ROWS_PER_SHEET + 'è¡Œ (' + cap + '%) ' + status + '\n\n';
    }
    report += 'ğŸ’¡ æº€æ¯ã®ã‚·ãƒ¼ãƒˆã«ã¯æ–°è¦ãƒ‡ãƒ¼ã‚¿ã¯è¿½åŠ ã•ã‚Œã¾ã›ã‚“ã€‚';
    
    // ğŸ”¹ ä¿®æ­£ï¼šä¸€è¦§è¡¨ç¤ºã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
    conditionalInfoDialog(report, "ä¿å­˜ã‚·ãƒ¼ãƒˆä¸€è¦§");
    
  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼ã¯å¸¸ã«è¡¨ç¤º
    showAlert('ä¸€è¦§è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}

function getOrCreateSaveSheet(spreadsheet, requiredRows) {
  var MAX_ROWS_PER_SHEET = 5500;
  try {
    var sheets = spreadsheet.getSheets();
    var saveSheets = sheets.filter(function(s){ return s.getName().indexOf('ä¿å­˜ãƒ‡ãƒ¼ã‚¿_')===0; })
                           .sort(function(a,b){ return b.getName().localeCompare(a.getName()); });
    if (saveSheets.length>0) {
      var latest = saveSheets[0];
      var current = Math.max(0, latest.getLastRow() - 4);
      if (current + requiredRows <= MAX_ROWS_PER_SHEET) return latest;
    }
    var now = new Date();
    var ts = Utilities.formatDate(now, Session.getScriptTimeZone(), "yyyy-MM-dd_HH-mm-ss");
    var newName = 'ä¿å­˜ãƒ‡ãƒ¼ã‚¿_' + ts;
    var newSheet = spreadsheet.insertSheet(newName);
    var source = validateAndGetSheet();
    if (source) {
      var header = source.getRange(1,1,4,source.getLastColumn());
      header.copyTo(newSheet.getRange(1,1,4,source.getLastColumn()),
        SpreadsheetApp.CopyPasteType.PASTE_NORMAL,false);
    }
    return newSheet;
  } catch(e) {
    throw new Error('ä¿å­˜å…ˆã‚·ãƒ¼ãƒˆã®æº–å‚™ã«å¤±æ•—: ' + e.message);
  }
}

// ã€ä¿®æ­£ç‰ˆã€‘saveRowsToSheeté–¢æ•°ï¼šå€¤ã®ã¿ä¿å­˜ï¼ˆæ•°å¼ã¯ä¿å­˜ã—ãªã„ï¼‰
function saveRowsToSheet(sourceSheet, targetSheet, startRow, endRow) {
  try {
    var rowCount = endRow - startRow + 1;
    var colCount = sourceSheet.getLastColumn();
    var srcRange = sourceSheet.getRange(startRow,1,rowCount,colCount);
    var vals = srcRange.getValues();
    // var forms = srcRange.getFormulas(); â† å‰Šé™¤ï¼šæ•°å¼ã¯å–å¾—ã—ãªã„

    var dstRow = Math.max(5, targetSheet.getLastRow() + 1);
    for (var i=0;i<rowCount;i++) {
      for (var j=0;j<colCount;j++) {
        var cell = targetSheet.getRange(dstRow+i, 1+j);
        // ã€ä¿®æ­£ã€‘æ•°å¼ãƒã‚§ãƒƒã‚¯ã‚’å‰Šé™¤ã—ã€å¸¸ã«å€¤ã®ã¿ã‚’è¨­å®š
        cell.setValue(vals[i][j]);
      }
    }
    
    // ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®ã‚³ãƒ”ãƒ¼ã¯å¼•ãç¶šãå®Ÿè¡Œ
    srcRange.copyTo(targetSheet.getRange(dstRow,1,rowCount,colCount),
      SpreadsheetApp.CopyPasteType.PASTE_FORMAT,false);

    var saved = 0;
    for (var k=0;k<vals.length;k++) {
      var row = vals[k];
      if (row[CONFIG.COLUMNS.COST_YEN -1] || row[CONFIG.COLUMNS.JP_TITLE -1] || row[CONFIG.COLUMNS.JP_DESC -1]) saved++;
    }
    return saved;
  } catch(e) {
    throw new Error('ãƒ‡ãƒ¼ã‚¿ä¿å­˜ã«å¤±æ•—: ' + e.message);
  }
}

function clearSelectedRowsValues(sheet, startRow, endRow) {   
  try {     
    var rowCount = endRow - startRow + 1;     
    var colCount = sheet.getLastColumn();
    var fullRange = sheet.getRange(startRow, 1, rowCount, colCount);
    
    // ========================================
    // Step 1: ä¿æŒã™ã‚‹åˆ—ç•ªå·ã‚’å®šç¾©
    // ========================================
    var preserveColumns = {
      dropdown: [5, 7, 24, 25, 26, 29],     // E, G, X, Y, Z, ACåˆ—
      formula: [16, 17, 32]                  // P, Q, AFåˆ—
    };
    
    // ========================================
    // Step 2: æ¡ä»¶ä»˜ãæ›¸å¼ã‚’ä¿å­˜ï¼ˆã‚·ãƒ¼ãƒˆå…¨ä½“ï¼‰
    // ========================================
    var conditionalFormatRules = sheet.getConditionalFormatRules();
    
    // ========================================
    // Step 3: ä¿æŒã™ã‚‹æƒ…å ±ã‚’é€€é¿
    // ========================================
    
    // 3-1. å…¨ç¯„å›²ã®é€šå¸¸æ›¸å¼ã‚’ä¿å­˜
    var numberFormats = fullRange.getNumberFormats();
    var fontWeights = fullRange.getFontWeights();
    var fontColors = fullRange.getFontColors();
    var horizontalAlignments = fullRange.getHorizontalAlignments();
    var verticalAlignments = fullRange.getVerticalAlignments();
    var fontFamilies = fullRange.getFontFamilies();
    var fontSizes = fullRange.getFontSizes();
    var wraps = fullRange.getWraps();
    var notes = fullRange.getNotes();
    
    // 3-2. ç‰¹å®šåˆ—ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šã‚’ä¿å­˜
    var preservedValidations = {};
    for (var i = 0; i < preserveColumns.dropdown.length; i++) {
      var col = preserveColumns.dropdown[i];
      var colRange = sheet.getRange(startRow, col, rowCount, 1);
      preservedValidations[col] = colRange.getDataValidations();
    }
    
    // 3-3. ç‰¹å®šåˆ—ã®æ•°å¼ã‚’ä¿å­˜
    var preservedFormulas = {};
    for (var j = 0; j < preserveColumns.formula.length; j++) {
      var col = preserveColumns.formula[j];
      var colRange = sheet.getRange(startRow, col, rowCount, 1);
      preservedFormulas[col] = colRange.getFormulas();
    }
    
    // ========================================
    // Step 4: ã‚¯ãƒªã‚¢å‡¦ç†
    // ========================================
    fullRange.clearContent();      // å€¤ã¨æ•°å¼ã‚’ã‚¯ãƒªã‚¢
    fullRange.setBackground(null); // èƒŒæ™¯è‰²ã‚’ã‚¯ãƒªã‚¢
    
    // ========================================
    // Step 5: å¾©å…ƒå‡¦ç†
    // ========================================
    
    // 5-1. é€šå¸¸æ›¸å¼ã‚’å¾©å…ƒï¼ˆå…¨ç¯„å›²ï¼‰
    fullRange.setNumberFormats(numberFormats);
    fullRange.setFontWeights(fontWeights);
    fullRange.setFontColors(fontColors);
    fullRange.setHorizontalAlignments(horizontalAlignments);
    fullRange.setVerticalAlignments(verticalAlignments);
    fullRange.setFontFamilies(fontFamilies);
    fullRange.setFontSizes(fontSizes);
    fullRange.setWraps(wraps);
    fullRange.setNotes(notes);
    
    // 5-2. ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šã‚’å¾©å…ƒï¼ˆç‰¹å®šåˆ—ã®ã¿ï¼‰
    for (var k = 0; k < preserveColumns.dropdown.length; k++) {
      var col = preserveColumns.dropdown[k];
      var colRange = sheet.getRange(startRow, col, rowCount, 1);
      colRange.setDataValidations(preservedValidations[col]);
    }
    
    // 5-3. æ•°å¼ã‚’å¾©å…ƒï¼ˆç‰¹å®šåˆ—ã®ã¿ï¼‰
    for (var m = 0; m < preserveColumns.formula.length; m++) {
      var col = preserveColumns.formula[m];
      var colRange = sheet.getRange(startRow, col, rowCount, 1);
      colRange.setFormulas(preservedFormulas[col]);
    }
    
    // 5-4. æ¡ä»¶ä»˜ãæ›¸å¼ã‚’å¾©å…ƒï¼ˆã‚·ãƒ¼ãƒˆå…¨ä½“ï¼‰
    sheet.setConditionalFormatRules(conditionalFormatRules);

    // ========================================
  // Step 6: æ•°å¼è¨­å®šåˆ—ã®è¡¨ç¤ºå½¢å¼ã‚’å¼·åˆ¶çš„ã«ã€Œè‡ªå‹•ã€ã«ã™ã‚‹
  // ========================================
  var formulaOutputColumns = [
    CONFIG.COLUMNS.PRICE,              // Råˆ—ï¼ˆè²©å£²ä¾¡æ ¼DDUï¼‰
    CONFIG.COLUMNS.TAX_INCLUDED_PRICE, // Såˆ—ï¼ˆé–¢ç¨è¾¼ã¿ä¾¡æ ¼ï¼‰
    CONFIG.COLUMNS.SHIPPING,           // Tåˆ—ï¼ˆé€æ–™ï¼‰
    CONFIG.COLUMNS.PROFIT,             // Uåˆ—ï¼ˆåˆ©ç›Šé¡ï¼‰
    CONFIG.COLUMNS.VOLUME,             // AAåˆ—ï¼ˆå®¹ç©é‡é‡ï¼‰
    CONFIG.COLUMNS.ESTIMATED_TAX,      // ABåˆ—ï¼ˆæƒ³å®šé–¢ç¨ï¼‰
    CONFIG.COLUMNS.DDU_ADJUSTED_PRICE  // AEåˆ—ï¼ˆDDUèª¿æ•´ä¾¡æ ¼ï¼‰
  ];
  
  for (var n = 0; n < formulaOutputColumns.length; n++) {
    var col = formulaOutputColumns[n];
    var colRange = sheet.getRange(startRow, col, rowCount, 1);
    colRange.setNumberFormat('0.00');  // æ•°å€¤å½¢å¼ã«å¼·åˆ¶
  }
    
  } catch(e) {     
    throw new Error('è¡Œã‚¯ãƒªã‚¢ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message);   
  } 
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  åˆ©ç›Šé¡ãƒ¬ãƒ³ã‚¸ï¼ˆProfit_Amountsï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function setupProfitAmountSheet() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var name = "Profit_Amounts";
  var sh = ss.getSheetByName(name);
  if (!sh) {
    sh = ss.insertSheet(name);
    sh.getRange("A1").setValue("Cost Range (Min)");
    sh.getRange("B1").setValue("Cost Range (Max)");
    sh.getRange("C1").setValue("Profit Amount (JPY)");
    sh.getRange("D1").setValue("Shipping Cost (JPY)");
    sh.getRange("E1").setValue("èª¬æ˜:");
    sh.getRange("F1").setValue("Iåˆ—ã®ä»•å…¥ã‚Œå€¤ã«å¿œã˜ã¦è‡ªå‹•é©ç”¨ã•ã‚Œã‚‹åˆ©ç›Šé¡/é€æ–™ã‚’è¨­å®šã€‚å°â†’å¤§ã§ä¸¦ã¹ã‚‹ã€‚Max ç©ºç™½=ä»¥é™ã™ã¹ã¦ã€‚");
    sh.getRange("A2").setValue(0);     sh.getRange("B2").setValue(1000);  sh.getRange("C2").setValue(200);  sh.getRange("D2").setValue(800);
    sh.getRange("A3").setValue(1001);  sh.getRange("B3").setValue(5000);  sh.getRange("C3").setValue(500);  sh.getRange("D3").setValue(1200);
    sh.getRange("A4").setValue(5001);  sh.getRange("B4").setValue(10000); sh.getRange("C4").setValue(1000); sh.getRange("D4").setValue(1500);
    sh.getRange("A5").setValue(10001); sh.getRange("B5").setValue(20000); sh.getRange("C5").setValue(2000); sh.getRange("D5").setValue(2000);
    sh.getRange("A6").setValue(20001); sh.getRange("B6").setValue("");    sh.getRange("C6").setValue(3000); sh.getRange("D6").setValue(2500);
    sh.getRange("A1:D1").setFontWeight("bold").setBackground("#cfe2f3");
    sh.getRange("A1:F1").setVerticalAlignment("top");
    sh.setColumnWidth(1,150); sh.setColumnWidth(2,150); sh.setColumnWidth(3,150); sh.setColumnWidth(4,150);
    sh.setColumnWidth(5,80);  sh.setColumnWidth(6,400);
    showAlert('ã€Œ' + name + 'ã€ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚å¿…è¦ã«å¿œã˜ã¦ç·¨é›†ã—ã¦ãã ã•ã„ã€‚', "success");
  } else {
    showAlert('ã€Œ' + name + 'ã€ã‚·ãƒ¼ãƒˆã‚’é–‹ãã¾ã—ãŸã€‚', "info");
  }
  ss.setActiveSheet(sh);
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ä½œæˆãƒ»ãƒ‡ãƒãƒƒã‚°ï¼ˆAirmailä¿®æ­£ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function setupShippingTables() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var ui = SpreadsheetApp.getUi();
    var ok = ui.alert('é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š',
      'é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ç®¡ç†ç”¨ã®ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã™ã€‚\n\nãƒ»Shipping_Methodsï¼ˆAï½Iåˆ—ï¼‰\nãƒ»Shipping_Ratesï¼ˆAï½Gåˆ—=å„ãƒ¡ã‚½ãƒƒãƒ‰ã€I/Jåˆ—=Airmailï¼‰\n\næ—¢å­˜å€¤ã¯å¯èƒ½ãªé™ã‚Šä¿æŒã—ã€ç©ºæ¬„ã®ã¿è£œå®Œã—ã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
      ui.ButtonSet.YES_NO);
    if (ok !== ui.Button.YES) { showAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', "info"); return; }
    createOrUpdateShippingMethodsSheet_(ss);
    createOrUpdateShippingRatesSheet_(ss);
    showAlert('âœ… é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ã®è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\nğŸ“‹ ä½œæˆ/æ›´æ–°: Shipping_Methods / Shipping_Rates\nğŸ›« Airmailã®å¸¯ã¯ Shipping_Rates ã® I/J åˆ—ã«é…ç½®ã—ã¾ã—ãŸã€‚', "success");
  } catch (e) {
    showAlert('é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}

function createOrUpdateShippingMethodsSheet_(ss) {
  var name = "Shipping_Methods";
  var sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name);

  // ãƒ˜ãƒƒãƒ€ãƒ¼
  var headers = ["Method_ID","Method_Name","Group","Active","Priority","Weight_Limit","Size_Limit","Calc_Type","Description"];
  for (var i=0;i<headers.length;i++) sh.getRange(1, i+1).setValue(headers[i]);
  sh.getRange("A1:I1").setFontWeight("bold").setBackground("#cfe2f3");
  sh.setColumnWidth(1,80); sh.setColumnWidth(2,120); sh.setColumnWidth(3,80);
  sh.setColumnWidth(4,60); sh.setColumnWidth(5,60);  sh.setColumnWidth(6,100);
  sh.setColumnWidth(7,100); sh.setColumnWidth(8,90);  sh.setColumnWidth(9,220);

  // ãƒ‡ãƒ¼ã‚¿è¡Œï¼ˆ2è¡Œç›®ä»¥é™ï¼‰
  var methods = CONFIG.SHIPPING_METHODS;
  var idToRow = {};
  var lastRow = sh.getLastRow();
  if (lastRow >= 2) {
    var existing = sh.getRange(2,1,lastRow-1,9).getValues();
    for (var r=0;r<existing.length;r++) {
      var id = String(existing[r][0]||'').trim();
      if (id) idToRow[id] = 2+r;
    }
  }
  var order = Object.keys(methods);
  for (var i2=0;i2<order.length;i2++) {
    var id = order[i2];
    var m = methods[id];
    var row = idToRow[id] || (2 + i2);
    sh.getRange(row,1).setValue(id);
    sh.getRange(row,2).setValue(m.name);
    sh.getRange(row,3).setValue(m.group);
    sh.getRange(row,4).setValue(true);
    sh.getRange(row,5).setValue(1);
    sh.getRange(row,6).setValue(m.weightLimit);
    sh.getRange(row,7).setValue(m.sizeLimit);
    sh.getRange(row,8).setValue(m.calcType);
    sh.getRange(row,9).setValue(m.name + ' - ' + m.group + 'ã‚°ãƒ«ãƒ¼ãƒ—');
  }
}


function createOrUpdateShippingRatesSheet_(ss) {
  var name = "Shipping_Rates";
  var sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name);

  // ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆç©ºæ¬„ã®ã¿è¨­å®šï¼‰
  var setIfBlank_ = function(a1, v) {
    var rg = sh.getRange(a1);
    if (rg.getValue() === "") rg.setValue(v);
  };
  
  setIfBlank_("A1","Weight_From");
  setIfBlank_("B1","Weight_To");
  setIfBlank_("C1","SP");
  setIfBlank_("D1","CE");
  setIfBlank_("E1","EMS");
  setIfBlank_("F1","CF");
  setIfBlank_("G1","CD");
  setIfBlank_("H1","EL"); // â† eLogisticsè¿½åŠ 
  setIfBlank_("A2","(g)");
  setIfBlank_("B2","(g)");
  setIfBlank_("C2","å°å‹åŒ…è£…ç‰©");
  setIfBlank_("D2","Cpass-Economy");
  setIfBlank_("E2","EMS");
  setIfBlank_("F2","Cpass-FedEx");
  setIfBlank_("G2","Cpass-DHL");
  setIfBlank_("H2","eLogistics"); // â† eLogisticsè¿½åŠ 

  // Airmail å°‚ç”¨è¦‹å‡ºã—ï¼ˆI/Jåˆ—ï¼‰
  setIfBlank_("I1","Airmail_Weight_Max");
  setIfBlank_("J1","Airmail_Rate");
  setIfBlank_("I2","(g max)");
  setIfBlank_("J2","(JPY)");

  // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›¸å¼è¨­å®šï¼ˆHåˆ—ã¾ã§æ‹¡å¼µï¼‰
  sh.getRange("A1:H2").setFontWeight("bold").setBackground("#cfe2f3");
  sh.getRange("I1:J2").setFontWeight("bold").setBackground("#eaf1ff");
  
  // åˆ—å¹…è¨­å®šï¼ˆHåˆ—ã¾ã§æ‹¡å¼µï¼‰
  sh.setColumnWidth(1,80); sh.setColumnWidth(2,80);
  for (var c=3;c<=8;c++) sh.setColumnWidth(c,100); // â† 8ã¾ã§æ‹¡å¼µ
  sh.setColumnWidth(9,110); sh.setColumnWidth(10,110);

  // é‡é‡å¸¯ï¼ˆA/Båˆ—ï¼‰ã¨ã‚µãƒ³ãƒ—ãƒ«å€¤ã®è¨­å®š
  var last = sh.getLastRow();
  if (last < 3 || (sh.getRange(3,1).getValue()==="" && sh.getRange(3,2).getValue()==="")) {
    var sample = [
      [1,100],[101,200],[201,300],[301,400],[401,500],
      [501,600],[601,700],[701,800],[801,900],[901,1000],
      [1001,1100],[1101,1200],[1201,1300],[1301,1400],[1401,1500],
      [1501,1600],[1601,1700],[1701,1800],[1801,1900],[1901,2000],
      [2001,2500],[2501,3000],[3001,3500],[3501,4000],[4001,4500],
      [4501,5000],[5001,6000],[6001,7000],[7001,8000],[8001,9000],
      [9001,10000],[10001,15000],[15001,20000],[20001,30000]
    ];
    
    for (var i=0;i<sample.length;i++) {
      var r = i+3;
      if (sh.getRange(r,1).getValue()==="") sh.getRange(r,1).setValue(sample[i][0]);
      if (sh.getRange(r,2).getValue()==="") sh.getRange(r,2).setValue(sample[i][1]);
      
      // Cåˆ—ã‹ã‚‰Håˆ—ã¾ã§[å…¥åŠ›]ã‚’è¨­å®šï¼ˆHåˆ—ã‚‚å«ã‚€ï¼‰
      for (var c2=3;c2<=8;c2++) { // â† 8ã¾ã§æ‹¡å¼µ
        var cell = sh.getRange(r,c2);
        if (cell.getValue()==="") cell.setValue('[å…¥åŠ›]');
      }
    }
  }

  // Airmail ã®ã‚µãƒ³ãƒ—ãƒ«å¸¯ï¼ˆI/Jåˆ—ï¼‰- æ—¢å­˜ã®ã¾ã¾
  var amBands = [
    [50,  280],
    [100, 420],
    [250, 720],
    [500, 1260],
    [1000,2860],
    [2000,5000]
  ];
  for (var j=0;j<amBands.length;j++) {
    var rr = 3 + j;
    var cI = sh.getRange(rr, 9);
    var cJ = sh.getRange(rr,10);
    if (cI.getValue() === "") cI.setValue(amBands[j][0]);
    if (cJ.getValue() === "") cJ.setValue(amBands[j][1]);
  }
}


/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ãƒ»è¨­å®šç¢ºèªãƒ»å‡¦ç†çŠ¶æ³
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function generateWeightOptions() {
  try {
    var options=[];
    for (var w=50; w<=2000; w+=50) options.push(w);
    for (var w2=2500; w2<=68000; w2+=500) options.push(w2);
    return options;
  } catch(e) { return [100,200,300,400,500]; }
}

function generateSizeOptions() {
  try {
    return [
      "25x20x5", "25x20x10", "25x20x15", "30x25x20", "30x30x25", 
      "40x30x25", "40x35x30", "40x40x35", "45x35x30"
    ];
  } catch(e) { return ["20x15x10", "25x20x15", "30x25x20"]; }
}

function setupDropdownValidation() {
  try {
    var sheet = validateAndGetSheet(); if (!sheet) return;
    var last = sheet.getLastRow();
    if (last < 5) { showAlert("âš ï¸ ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚5è¡Œç›®ä»¥é™ã«å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚","warning"); return; }

    var weight = generateWeightOptions();
    var size   = generateSizeOptions();
    var shippingOptions = ["è‡ªå‹•é¸æŠ","Small Packet","Cpass-FedEx","Cpass-Economy","Cpass-DHL","EMS"];

    var conditionOptions = CONFIG.CONDITION_OPTIONS;
    var categoryOptions = CONFIG.EBAY_CATEGORIES;

    var rules = [
      { 
        range: sheet.getRange(5, CONFIG.COLUMNS.WEIGHT, last-4, 1),  // 24â†’25
        options: weight,
        helpText: "æ¢±åŒ…é‡é‡ï¼ˆ50-2000g:50gåˆ»ã¿, 2000gä»¥é™:500gåˆ»ã¿ï¼‰" 
      },
      { 
        range: sheet.getRange(5, CONFIG.COLUMNS.SIZE, last-4, 1),  // 25â†’26
        options: size,
        helpText: "ä»£è¡¨ã‚µã‚¤ã‚ºã€‚å¿…è¦ãªã‚‰æ‰‹å…¥åŠ›ï¼ˆä¾‹ï¼š25x20x15ï¼‰" 
      },
      { 
        range: sheet.getRange(5, CONFIG.COLUMNS.METHOD, last-4, 1),  // 23â†’24
        options: shippingOptions,
        helpText: "é…é€æ–¹æ³•ã€‚ã€Œè‡ªå‹•é¸æŠã€= Small Packet or Cpass-DHL ã‚’è‡ªå‹•åˆ¤å®š" 
      },
      { 
        range: sheet.getRange(5, CONFIG.COLUMNS.CONDITION, last-4, 1),  // 28â†’29
        options: conditionOptions,
        helpText: "å•†å“ã®çŠ¶æ…‹ã€‚AIåˆ¤å®šå¾Œã«æ‰‹å‹•å¤‰æ›´å¯èƒ½ã§ã™ã€‚" 
      },
      { 
        range: sheet.getRange(5, CONFIG.COLUMNS.EBAY_CATEGORY, last-4, 1),  // 29â†’30
        options: categoryOptions,
        helpText: "eBayã®ãƒ¡ã‚¤ãƒ³ã‚«ãƒ†ã‚´ãƒªãƒ¼ã€‚é–¢ç¨è¨ˆç®—ã«ä½¿ç”¨ã—ã¾ã™ã€‚" 
      }
    ];
    
    for (var i=0;i<rules.length;i++) {
      var r = rules[i];
      r.range.clearDataValidations();
      var dv = SpreadsheetApp.newDataValidation().requireValueInList(r.options, true)
        .setAllowInvalid(true).setHelpText(r.helpText).build();
      r.range.setDataValidation(dv);
    }

    showAlert("âœ… ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n" +
  "ğŸ’¡ è‡ªå‹•é¸æŠãƒ­ã‚¸ãƒƒã‚¯ï¼š\n" +
  "ãƒ»è¨­å®šé‡‘é¡ä»¥ä¸Š â†’ Cpass-DHL\n" +
  "ãƒ»è¨­å®šé‡‘é¡æœªæº€ & Small Packetå¯ â†’ Small Packet\n" +
  "ãƒ»ä¸Šè¨˜ä»¥å¤– â†’ Cpass-DHL\n" +
  "ãƒ»O2=1 â†’ï¼ˆAirmail æ©Ÿèƒ½ã¯ç„¡åŠ¹åŒ–æ¸ˆã¿ï¼‰\n\n" +
  "ğŸ’¡ æ–°æ©Ÿèƒ½è¿½åŠ :\n" +
  "ãƒ»ABåˆ—: å•†å“çŠ¶æ…‹ï¼ˆæ–°å“/ä¸­å¤/ã‚¨ãƒ©ãƒ¼ï¼‰\n" +
  "ãƒ»ACåˆ—: eBayã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆé–¢ç¨è¨ˆç®—ç”¨ï¼‰\n" +
  "ãƒ»ã‚¨ãƒ©ãƒ¼æ™‚ã¯èµ¤è‰²ã§ãƒã‚¤ãƒ©ã‚¤ãƒˆè¡¨ç¤º", "success");

  } catch(e) {
    showAlert('ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}

function checkCurrentValidation() {
  try {
    var ui = SpreadsheetApp.getUi();
    var props = PropertiesService.getScriptProperties();
    var platform = props.getProperty('AI_PLATFORM') || 'openai';
    var model = props.getProperty('AI_MODEL') || 'gpt-5-nano';
    var apiKeyStatus = '';
    if (platform==='openai') apiKeyStatus = props.getProperty('OPENAI_API_KEY') ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š';
    if (platform==='claude') apiKeyStatus = props.getProperty('CLAUDE_API_KEY') ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š';
    if (platform==='gemini') apiKeyStatus = props.getProperty('GEMINI_API_KEY') ? 'âœ… è¨­å®šæ¸ˆã¿' : 'âŒ æœªè¨­å®š';

    var sheetName = props.getProperty('SHEET_NAME') || 'æœªè¨­å®š';
    var profitCalc = props.getProperty('PROFIT_CALC_METHOD') || 'æœªè¨­å®š';
    var promptId = props.getProperty('PROMPT_ID') || 'EBAY_FULL_LISTING_PROMPT';
    var shippingThreshold = props.getProperty('SHIPPING_THRESHOLD') || '20000';
    var shippingCalc = props.getProperty('SHIPPING_CALC_METHOD') || 'TABLE';
    
    var lowPriceMethod = props.getProperty('LOW_PRICE_SHIPPING_METHOD') || 'SP';
    var highPriceMethod = props.getProperty('HIGH_PRICE_SHIPPING_METHOD') || 'CD';
    
    // eLogisticså¯¾å¿œã®è¡¨ç¤ºåå–å¾—
    var lowPriceName = CONFIG.SHIPPING_METHOD_OPTIONS.lowPrice[lowPriceMethod] ? 
                       CONFIG.SHIPPING_METHOD_OPTIONS.lowPrice[lowPriceMethod].displayName : lowPriceMethod;
    var highPriceName = CONFIG.SHIPPING_METHOD_OPTIONS.highPrice[highPriceMethod] ? 
                        CONFIG.SHIPPING_METHOD_OPTIONS.highPrice[highPriceMethod].displayName : highPriceMethod;

    var sheet = validateAndGetSheet();
    var lastRow = sheet ? sheet.getLastRow() : 0;
    var report = 'ğŸ“‹ ç¾åœ¨ã®è¨­å®š:\n\n' +
      'â€¢ AIãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ' + platform + '\n' +
      'â€¢ AIãƒ¢ãƒ‡ãƒ«: ' + model + '\n' +
      'â€¢ APIã‚­ãƒ¼: ' + apiKeyStatus + '\n' +
      'â€¢ ä½œæ¥­ã‚·ãƒ¼ãƒˆå: ' + sheetName + ' ' + (sheet ? 'âœ… å­˜åœ¨' : 'âš ï¸ è¦‹ã¤ã‹ã‚‰ãªã„') + '\n' +
      'â€¢ åˆ©ç›Šè¨ˆç®—æ–¹æ³•: ' + (profitCalc==='RATE'?'åˆ©ç›Šç‡':(profitCalc==='AMOUNT'?'åˆ©ç›Šé¡':'æœªè¨­å®š')) + '\n' +
      'â€¢ é€æ–™è¨ˆç®—æ–¹æ³•: ' + (shippingCalc==='TABLE'?'ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—':(shippingCalc==='FIXED'?'å›ºå®šé‡‘é¡':'æœªè¨­å®š')) + '\n' +
      'â€¢ é€æ–™è¨ˆç®—åˆ‡æ›¿åŸºæº–é‡‘é¡: ' + shippingThreshold + 'å††\n' +
      'â€¢ åŸºæº–é‡‘é¡æœªæº€ã®é…é€æ–¹æ³•: ' + lowPriceName + '\n' +
      'â€¢ åŸºæº–é‡‘é¡ä»¥ä¸Šã®é…é€æ–¹æ³•: ' + highPriceName + '\n' +
      'â€¢ ä½¿ç”¨ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ: ' + promptId + '\n\n';

    if (sheet) {
      report += 'ğŸ“Š ã‚·ãƒ¼ãƒˆã®è¨­å®šå€¤:\n';
      var fee = sheet.getRange("F1").getValue();  // å¤‰æ›´ãªã—
      var ad  = sheet.getRange("F2").getValue();  // å¤‰æ›´ãªã—
      var rate = sheet.getRange("H2").getValue();  // å¤‰æ›´ãªã—
      var amt  = sheet.getRange("H1").getValue();  // å¤‰æ›´ãªã—
      
      // âš ï¸ ã‚»ãƒ«å‚ç…§ã‚’ã‚¹ãƒ©ã‚¤ãƒ‰å¾Œã®ä½ç½®ã«å¤‰æ›´
      var v1=sheet.getRange("V1").getValue(), v2=sheet.getRange("V2").getValue(), w2=sheet.getRange("W2").getValue();
      var y1=sheet.getRange("Y1").getValue(), y2=sheet.getRange("Y2").getValue();
      // U1â†’V1, U2â†’V2, V2â†’W2, X1â†’Y1, X2â†’Y2

      report += 'â€¢ æ‰‹æ•°æ–™ç‡ (F1): ' + (fee || 'æœªè¨­å®š') + '\n';
      report += 'â€¢ åºƒå‘Šè²»ç‡ (F2): ' + (ad  || 'æœªè¨­å®š') + '\n';
      if (profitCalc==='RATE') report += 'â€¢ åˆ©ç›Šç‡ (H2): ' + (rate || 'æœªè¨­å®š') + '\n';
      if (profitCalc==='AMOUNT') report += 'â€¢ åˆ©ç›Šé¡ (H1): ' + (amt  || 'æœªè¨­å®š') + '\n';
      if (shippingCalc==='FIXED') {
        var fixed = sheet.getRange("J1").getValue();  // å¤‰æ›´ãªã—
        report += 'â€¢ å›ºå®šé€æ–™ (J1): ' + (fixed || 'æœªè¨­å®š') + '\n';
      }
      report += 'â€¢ FedExç‡ƒæ²¹(V1): ' + (v1 || 0) + ' / DHLç‡ƒæ²¹(V2): ' + (v2 || 0) + '\n';  // U1â†’V1, U2â†’V2
      report += 'â€¢ Cpasså‰²(W2): ' + (w2 || 0) + ' / FedExè¿½åŠ (Y1): ' + (y1 || 0) + ' / DHLè¿½åŠ (Y2): ' + (y2 || 0) + '\n\n';  // V2â†’W2, X1â†’Y1, X2â†’Y2
      
      // é…é€æ–¹æ³•ãƒ­ã‚¸ãƒƒã‚¯ã®èª¬æ˜ï¼ˆeLogisticså¯¾å¿œï¼‰
      report += 'ğŸšš é…é€æ–¹æ³•é¸æŠãƒ­ã‚¸ãƒƒã‚¯:\n';
      if (lowPriceMethod === 'NONE') {
        report += 'â€¢ å…¨å•†å“: ' + highPriceName + ' ã®ã¿ä½¿ç”¨\n';
      } else {
        report += 'â€¢ ' + shippingThreshold + 'å††ä»¥ä¸Š: ' + highPriceName + '\n';
        report += 'â€¢ ' + shippingThreshold + 'å††æœªæº€: ' + lowPriceName;
        if (lowPriceMethod === 'SP') {
          report += ' (åˆ¶é™è¶…éæ™‚ã¯' + highPriceName + 'ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯)';
        }
        report += '\n';
      }
      report += '\n';
    }

    if (sheet && lastRow >= 5) {
      var testRow = 5;
      var cells = [
        { name: "é‡é‡", col: CONFIG.COLUMNS.WEIGHT },      // 24â†’25
        { name: "ã‚µã‚¤ã‚º", col: CONFIG.COLUMNS.SIZE },      // 25â†’26
        { name: "ç™ºé€æ–¹æ³•", col: CONFIG.COLUMNS.METHOD }   // 23â†’24
      ];
      for (var i=0;i<cells.length;i++) {
        var c = cells[i];
        var rng = sheet.getRange(testRow, c.col);
        var v = rng.getValue();
        var valid = rng.getDataValidation();
        var status = valid ? "âœ… ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³" : (v ? "âŒ ç›´æ¥å€¤(æ¤œè¨¼ãªã—)" : "N/A");
        report += 'â€¢ ' + c.name + ' (' + rng.getA1Notation() + '): ' + v + ' ' + status + '\n';
      }
    } else {
      report += 'â€¢ ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ5è¡Œç›®ä»¥é™ï¼‰ã€‚\n';
    }

    report += '\nğŸ’¡ ä¸è¶³ãŒã‚ã‚Œã°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒåˆæœŸè¨­å®šã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
    ui.alert('ç¾åœ¨ã®è¨­å®šç¢ºèª', report, ui.ButtonSet.OK);
   // ğŸ”¹ ä¿®æ­£ï¼šè¨­å®šç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
    conditionalInfoDialog(report, 'ç¾åœ¨ã®è¨­å®šç¢ºèª');
    
  } catch(e) {
    showAlert('è¨­å®šç¢ºèªã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}

function checkProcessingStatus() {
  try {
    var sheet = validateAndGetSheet(); if (!sheet) return;
    var last = sheet.getLastRow();
    var total=0, done=0;
    if (last < 5) { showAlert("ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ5è¡Œç›®ä»¥é™ï¼‰ã€‚", "info"); return; }
    
    var range = sheet.getRange(5, CONFIG.COLUMNS.JP_TITLE, last-4,
      CONFIG.COLUMNS.EN_DESC - CONFIG.COLUMNS.JP_TITLE + 1);  // 10åˆ—ã‹ã‚‰14åˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var vals = range.getValues();
    
    for (var i=0;i<vals.length;i++) {
      var r = i+5;
      var cost = Number(sheet.getRange(r, CONFIG.COLUMNS.COST_YEN).getValue());  // 9ï¼ˆå¤‰æ›´ãªã—ï¼‰
      var jpTitle = vals[i][0];
      var jpDesc  = vals[i][CONFIG.COLUMNS.JP_DESC - CONFIG.COLUMNS.JP_TITLE];
      var enTitle = vals[i][CONFIG.COLUMNS.EN_TITLE - CONFIG.COLUMNS.JP_TITLE];
      var enDesc  = vals[i][CONFIG.COLUMNS.EN_DESC - CONFIG.COLUMNS.JP_TITLE];
      
      if (jpTitle && jpDesc && !isNaN(cost) && cost>0) {
        total++;
        if (enTitle && enDesc) done++;
      }
    }
    var pending = total - done;
    var rate = total>0 ? Math.round((done/total)*100) : 0;
    var report = 'ğŸ“Š å‡¦ç†çŠ¶æ³:\n\n' +
      'â€¢ å…¥åŠ›æ¸ˆã¿è¡Œ (J,K,Iåˆ—): ' + total + '\n' +
      'â€¢ ç¿»è¨³æ¸ˆã¿è¡Œ (M,Nåˆ—): ' + done + '\n' +
      'â€¢ æœªç¿»è¨³è¡Œ: ' + pending + '\n' +
      'â€¢ å®Œäº†ç‡: ' + rate + '%\n\n' +
      'ğŸ’¡ é‡é‡/ã‚µã‚¤ã‚º/ç™ºé€æ–¹æ³•ã¯ã€Œä¸€æ‹¬å®Ÿè¡Œã€æ™‚ã«æ‰‹å‹•å…¥åŠ›(J2/L2/M2/N2)ã€‚å¿…è¦ã«å¿œã˜ã¦æ‰‹å‹•èª¿æ•´ã—ã¦ãã ã•ã„ã€‚';
    showAlert(report, "info");
  // ğŸ”¹ ä¿®æ­£ï¼šå‡¦ç†çŠ¶æ³è¡¨ç¤ºã‚’æ¡ä»¶ä»˜ãã«å¤‰æ›´
    conditionalInfoDialog(report, "å‡¦ç†çŠ¶æ³");
    
  } catch(e) {
    showAlert('å‡¦ç†çŠ¶æ³ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
  }
}


/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ±ç”¨ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Policy_Master ã‚·ãƒ¼ãƒˆç®¡ç†
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * Policy_Master ã‚·ãƒ¼ãƒˆã‚’ä½œæˆï¼ˆãƒãƒªã‚·ãƒ¼ï¼‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆçµ±åˆç‰ˆï¼‰
 */
function setupPolicyMasterSheet() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheetName = 'Policy_Master';
    var sheet = ss.getSheetByName(sheetName);
    
    // æ—¢å­˜ã‚·ãƒ¼ãƒˆç¢ºèª
    if (sheet) {
      var ui = SpreadsheetApp.getUi();
      var response = ui.alert(
        'ã‚·ãƒ¼ãƒˆä½œæˆç¢ºèª',
        'ã€ŒPolicy_Masterã€ã‚·ãƒ¼ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\næ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
        ui.ButtonSet.YES_NO
      );
      
      if (response === ui.Button.YES) {
        ss.deleteSheet(sheet);
      } else {
        showAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 'info');
        return;
      }
    }
    
    // æ–°è¦ã‚·ãƒ¼ãƒˆä½œæˆ
    sheet = ss.insertSheet(sheetName);
    
    // ========== ã‚»ã‚¯ã‚·ãƒ§ãƒ³1ï¼šShipping Policies ==========
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    sheet.getRange('A1').setValue('ã€Shipping Policiesã€‘');
    sheet.getRange('A1:C1').mergeAcross();
    sheet.getRange('A1:C1').setFontWeight('bold').setFontSize(12)
      .setBackground('#4285f4').setFontColor('white')
      .setHorizontalAlignment('center');
    
    sheet.getRange('A2').setValue('Policy ID');
    sheet.getRange('B2').setValue('Policy Name');
    sheet.getRange('C2').setValue('é€æ–™ä¸Šä¹—ã›');
    sheet.getRange('A2:C2').setFontWeight('bold').setBackground('#cfe2f3');
    
    // åˆ—å¹…è¨­å®š
    sheet.setColumnWidth(1, 80);   // Aåˆ—: ID
    sheet.setColumnWidth(2, 380);  // Båˆ—: åç§°
    sheet.setColumnWidth(3, 90);   // Cåˆ—: é€æ–™ä¸Šä¹—ã›
    
    // ãƒãƒªã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆåç§°ã¨é€æ–™ä¸Šä¹—ã›ã®ãƒšã‚¢ï¼‰
    var policiesData = [
      // ã‚¨ã‚³ãƒãƒŸãƒ¼ Ã— æ–°å“
      ['Egl_202510_eco_new_0001_0025', 15],
      ['Egl_202510_eco_new_0026_0050', 20],
      ['Egl_202510_eco_new_0051_0075', 25],
      ['Egl_202510_eco_new_0076_0100', 30],
      ['Egl_202510_eco_new_0101_0125', 35],
      ['Egl_202510_eco_new_0126_0150', 40],
      ['Egl_202510_eco_new_0151_0175', 45],
      ['Egl_202510_eco_new_0176_0200', 50],
      ['Egl_202510_eco_new_0201_0225', 55],
      ['Egl_202510_eco_new_0226_0250', 60],
      ['Egl_202510_eco_new_0251_0275', 65],
      ['Egl_202510_eco_new_0276_', 70],
      
      // ã‚¨ã‚³ãƒãƒŸãƒ¼ Ã— ä¸­å¤
      ['Egl_202510_eco_used_0001_0025', 15],
      ['Egl_202510_eco_used_0026_0050', 20],
      ['Egl_202510_eco_used_0051_0075', 25],
      ['Egl_202510_eco_used_0076_0100', 30],
      ['Egl_202510_eco_used_0101_0125', 35],
      ['Egl_202510_eco_used_0126_0150', 40],
      ['Egl_202510_eco_used_0151_0175', 45],
      ['Egl_202510_eco_used_0176_0200', 50],
      ['Egl_202510_eco_used_0201_0225', 55],
      ['Egl_202510_eco_used_0226_0250', 60],
      ['Egl_202510_eco_used_0251_0275', 65],
      ['Egl_202510_eco_used_0276_', 70],
      
      // XP Ã— æ–°å“
      ['Egl_202510_xp_new_0001_0025', 15],
      ['Egl_202510_xp_new_0026_0050', 20],
      ['Egl_202510_xp_new_0051_0075', 25],
      ['Egl_202510_xp_new_0076_0100', 30],
      ['Egl_202510_xp_new_0101_0125', 35],
      ['Egl_202510_xp_new_0126_0150', 40],
      ['Egl_202510_xp_new_0151_0175', 45],
      ['Egl_202510_xp_new_0176_0200', 50],
      ['Egl_202510_xp_new_0201_0225', 55],
      ['Egl_202510_xp_new_0226_0250', 60],
      ['Egl_202510_xp_new_0251_0275', 65],
      ['Egl_202510_xp_new_0276_0300', 70],
      ['Egl_202510_xp_new_0301_0325', 75],
      ['Egl_202510_xp_new_0326_0350', 80],
      ['Egl_202510_xp_new_0351_0375', 85],
      ['Egl_202510_xp_new_0376_0400', 91],
      ['Egl_202510_xp_new_0401_0425', 96],
      ['Egl_202510_xp_new_0426_0450', 101],
      ['Egl_202510_xp_new_0451_0475', 106],
      ['Egl_202510_xp_new_0476_0500', 111],
      ['Egl_202510_xp_new_0501_0525', 116],
      ['Egl_202510_xp_new_0526_0550', 121],
      ['Egl_202510_xp_new_0551_0575', 126],
      ['Egl_202510_xp_new_0576_0600', 131],
      ['Egl_202510_xp_new_0601_0625', 136],
      ['Egl_202510_xp_new_0626_0650', 141],
      ['Egl_202510_xp_new_0651_0675', 146],
      ['Egl_202510_xp_new_0676_0700', 151],
      ['Egl_202510_xp_new_0701_0725', 156],
      ['Egl_202510_xp_new_0726_0750', 161],
      ['Egl_202510_xp_new_0751_0775', 166],
      ['Egl_202510_xp_new_0776_0800', 172],
      ['Egl_202510_xp_new_0801_0850', 182],
      ['Egl_202510_xp_new_0851_0900', 192],
      ['Egl_202510_xp_new_0901_0950', 202],
      ['Egl_202510_xp_new_0951_1000', 212],
      ['Egl_202510_xp_new_1001_1100', 232],
      ['Egl_202510_xp_new_1101_1200', 253],
      ['Egl_202510_xp_new_1201_1300', 273],
      ['Egl_202510_xp_new_1301_1400', 293],
      ['Egl_202510_xp_new_1401_', 313],
      
      // XP Ã— ä¸­å¤
      ['Egl_202510_xp_used_0001_0025', 15],
      ['Egl_202510_xp_used_0026_0050', 20],
      ['Egl_202510_xp_used_0051_0075', 25],
      ['Egl_202510_xp_used_0076_0100', 30],
      ['Egl_202510_xp_used_0101_0125', 35],
      ['Egl_202510_xp_used_0126_0150', 40],
      ['Egl_202510_xp_used_0151_0175', 45],
      ['Egl_202510_xp_used_0176_0200', 50],
      ['Egl_202510_xp_used_0201_0225', 55],
      ['Egl_202510_xp_used_0226_0250', 60],
      ['Egl_202510_xp_used_0251_0275', 65],
      ['Egl_202510_xp_used_0276_0300', 70],
      ['Egl_202510_xp_used_0301_0325', 75],
      ['Egl_202510_xp_used_0326_0350', 80],
      ['Egl_202510_xp_used_0351_0375', 85],
      ['Egl_202510_xp_used_0376_0400', 91],
      ['Egl_202510_xp_used_0401_0425', 96],
      ['Egl_202510_xp_used_0426_0450', 101],
      ['Egl_202510_xp_used_0451_0475', 106],
      ['Egl_202510_xp_used_0476_0500', 111],
      ['Egl_202510_xp_used_0501_0525', 116],
      ['Egl_202510_xp_used_0526_0550', 121],
      ['Egl_202510_xp_used_0551_0575', 126],
      ['Egl_202510_xp_used_0576_0600', 131],
      ['Egl_202510_xp_used_0601_0625', 136],
      ['Egl_202510_xp_used_0626_0650', 141],
      ['Egl_202510_xp_used_0651_0675', 146],
      ['Egl_202510_xp_used_0676_0700', 151],
      ['Egl_202510_xp_used_0701_0725', 156],
      ['Egl_202510_xp_used_0726_0750', 161],
      ['Egl_202510_xp_used_0751_0775', 166],
      ['Egl_202510_xp_used_0776_0800', 172],
      ['Egl_202510_xp_used_0801_0850', 182],
      ['Egl_202510_xp_used_0851_0900', 192],
      ['Egl_202510_xp_used_0901_0950', 202],
      ['Egl_202510_xp_used_0951_1000', 212],
      ['Egl_202510_xp_used_1001_1100', 232],
      ['Egl_202510_xp_used_1101_1200', 253],
      ['Egl_202510_xp_used_1201_1300', 273],
      ['Egl_202510_xp_used_1301_1400', 293],
      ['Egl_202510_xp_used_1401_', 313]
    ];
    
    var policyData = [];
    for (var i = 0; i < policiesData.length; i++) {
      policyData.push([i + 1, policiesData[i][0], policiesData[i][1]]);
    }
    
    sheet.getRange(3, 1, policyData.length, 3).setValues(policyData);
    
    // ãƒãƒªã‚·ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³çµ‚äº†ä½ç½®
    var policyEndRow = 3 + policyData.length;
    
    // ç½«ç·šï¼ˆãƒãƒªã‚·ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    sheet.getRange(2, 1, policyData.length + 1, 3)
      .setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);
    
    // ========== ã‚»ã‚¯ã‚·ãƒ§ãƒ³åŒºåˆ‡ã‚Š ==========
    
    var separatorRow = policyEndRow + 2;
    sheet.getRange(separatorRow, 1).setValue('');
    
    // ========== ã‚»ã‚¯ã‚·ãƒ§ãƒ³2ï¼šTemplates ==========
    
    var templateStartRow = separatorRow + 1;
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼
    sheet.getRange(templateStartRow, 1).setValue('ã€Templatesã€‘');
    sheet.getRange(templateStartRow, 1, 1, 3).mergeAcross();
    sheet.getRange(templateStartRow, 1, 1, 3).setFontWeight('bold').setFontSize(12)
      .setBackground('#34a853').setFontColor('white')
      .setHorizontalAlignment('center');
    
    var templateHeaderRow = templateStartRow + 1;
    sheet.getRange(templateHeaderRow, 1).setValue('Template ID');
    sheet.getRange(templateHeaderRow, 2).setValue('Template Name');
    sheet.getRange(templateHeaderRow, 3).setValue('èª¬æ˜');
    sheet.getRange(templateHeaderRow, 1, 1, 3).setFontWeight('bold').setBackground('#d9ead3');
    
  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆIDã€åç§°ã€æ—¥æœ¬èªèª¬æ˜ï¼‰
var templates = [
  [1, 'Template_general_eco_new', 'æ±ç”¨ - ã‚¨ã‚³ãƒãƒŸãƒ¼ - æ–°å“'],
  [2, 'Template_general_eco_used', 'æ±ç”¨ - ã‚¨ã‚³ãƒãƒŸãƒ¼ - ä¸­å¤'],
  [3, 'Template_general_xp_new', 'æ±ç”¨ - XP - æ–°å“'],
  [4, 'Template_general_xp_used', 'æ±ç”¨ - XP - ä¸­å¤'],
  [5, 'Template_limited_eco_new', 'ã‚²ãƒ¼ãƒ ãƒ»æœ¬ï¼ˆä¸Šé™ã‚ã‚Šï¼‰- ã‚¨ã‚³ãƒãƒŸãƒ¼ - æ–°å“'],
  [6, 'Template_limited_eco_used', 'ã‚²ãƒ¼ãƒ ãƒ»æœ¬ï¼ˆä¸Šé™ã‚ã‚Šï¼‰- ã‚¨ã‚³ãƒãƒŸãƒ¼ - ä¸­å¤'],
  [7, 'Template_limited_xp_new', 'ã‚²ãƒ¼ãƒ ãƒ»æœ¬ï¼ˆä¸Šé™ã‚ã‚Šï¼‰- XP - æ–°å“'],
  [8, 'Template_limited_xp_used', 'ã‚²ãƒ¼ãƒ ãƒ»æœ¬ï¼ˆä¸Šé™ã‚ã‚Šï¼‰- XP - ä¸­å¤'],
  [9, 'Template_card_graded_eco', 'ãƒˆãƒ¬ã‚« - Gradedï¼ˆé‘‘å®šæ¸ˆã¿ï¼‰- ã‚¨ã‚³ãƒãƒŸãƒ¼'],
  [10, 'Template_card_graded_xp', 'ãƒˆãƒ¬ã‚« - Gradedï¼ˆé‘‘å®šæ¸ˆã¿ï¼‰- XP'],
  [11, 'Template_card_raw_eco', 'ãƒˆãƒ¬ã‚« - æœªé‘‘å®š - ã‚¨ã‚³ãƒãƒŸãƒ¼'],
  [12, 'Template_card_raw_xp', 'ãƒˆãƒ¬ã‚« - æœªé‘‘å®š - XP'],
  [13, 'Template_preorder_eco', 'äºˆç´„è²©å£² - ã‚¨ã‚³ãƒãƒŸãƒ¼'],
  [14, 'Template_preorder_xp', 'äºˆç´„è²©å£² - XP']
];
    
    var templateDataRow = templateHeaderRow + 1;
    sheet.getRange(templateDataRow, 1, templates.length, 3).setValues(templates);
    
    // åˆ—å¹…èª¿æ•´
    sheet.setColumnWidth(3, 280); // Cåˆ—: èª¬æ˜
    
    // ç½«ç·šï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼‰
    sheet.getRange(templateHeaderRow, 1, templates.length + 1, 3)
      .setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);
    
    // å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    showAlert(
      'Policy_Master ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\n' +
      'ã€Shipping Policiesã€‘\n' +
      'ç™»éŒ²ä»¶æ•°: ' + policiesData.length + 'ä»¶\n' +
      'Cåˆ—ã«é€æ–™ä¸Šä¹—ã›ä¾¡æ ¼ã‚’è¨­å®š\n\n' +
      'ã€Templatesã€‘\n' +
      'ç™»éŒ²ä»¶æ•°: ' + templates.length + 'ä»¶ï¼ˆ12å€‹ï¼‰\n' +
      'ãƒ»æ±ç”¨: 4å€‹\n' +
      'ãƒ»ã‚²ãƒ¼ãƒ ç­‰ï¼ˆä¸Šé™ã‚ã‚Šï¼‰: 4å€‹\n' +
      'ãƒ»ãƒˆãƒ¬ã‚«: 2å€‹\n' +
      'ãƒ»äºˆç´„è²©å£²: 2å€‹\n\n' +
      'å„ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã¯ç½«ç·šã§åŒºåˆ‡ã‚‰ã‚Œã¦ã„ã¾ã™ã€‚',
      'success'
    );
    
    // ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º
    ss.setActiveSheet(sheet);
    
  } catch (e) {
    showAlert('Policy_Master ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}
/**
 * ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼åç§°ã‹ã‚‰æƒ…å ±ã‚’ãƒ‘ãƒ¼ã‚¹
 * @param {string} policyName - ãƒãƒªã‚·ãƒ¼åç§°ï¼ˆä¾‹ï¼šEgl_202510_eco_new_0076_0100ï¼‰
 * @return {Object|null} ãƒ‘ãƒ¼ã‚¹çµæœ { shippingType, condition, minPrice, maxPrice }
 */
function parseShippingPolicyName(policyName) {
  try {
    if (!policyName || typeof policyName !== 'string') {
      return null;
    }
    
    // ã‚¢ãƒ³ãƒ€ãƒ¼ã‚¹ã‚³ã‚¢ã§åˆ†å‰²
    var parts = policyName.split('_');
    
    // æœ€ä½é™å¿…è¦ãªè¦ç´ æ•°ãƒã‚§ãƒƒã‚¯ï¼ˆ6è¦ç´ ä»¥ä¸Šï¼‰
    // ä¾‹: ['Egl', '202510', 'eco', 'new', '0076', '0100']
    if (parts.length < 6) {
      return null;
    }
    
    // é…é€ã‚¿ã‚¤ãƒ—ï¼ˆeco/xpï¼‰
    var shippingTypeRaw = parts[2].toLowerCase();
    var shippingType = (shippingTypeRaw === 'eco') ? 'ã‚¨ã‚³ãƒãƒŸãƒ¼' : 
                       (shippingTypeRaw === 'xp') ? 'EX' : null;
    
    if (!shippingType) {
      return null;
    }
    
    // çŠ¶æ…‹ï¼ˆnew/usedï¼‰
    var conditionRaw = parts[3].toLowerCase();
    var condition = (conditionRaw === 'new') ? 'æ–°å“' : 
                    (conditionRaw === 'used') ? 'ä¸­å¤' : null;
    
    if (!condition) {
      return null;
    }
    
    // ä¾¡æ ¼ç¯„å›²ï¼ˆæœ€å¾Œã®2è¦ç´ ï¼‰
    var minPriceStr = parts[parts.length - 2];
    var maxPriceStr = parts[parts.length - 1];
    
    var minPrice = parseInt(minPriceStr, 10);
    var maxPrice = maxPriceStr ? parseInt(maxPriceStr, 10) : 999999;
    
    if (isNaN(minPrice)) {
      return null;
    }
    
    // _0001_0050 â†’ 1ï½50ï¼ˆ50.00ä»¥ä¸‹ï¼‰
    // _0051_0075 â†’ 51ï½75ï¼ˆ50.01ä»¥ä¸Šã€ã¤ã¾ã‚Š51.00æœªæº€ã¯æ¬¡ã®ç¯„å›²ã®é–‹å§‹minPriceã‹ã‚‰0.01å¼•ãï¼‰
    var adjustedMin = minPrice === 1 ? minPrice : minPrice - 0.99;
    
    return {
      shippingType: shippingType,
      condition: condition,
      minPrice: adjustedMin,
      maxPrice: isNaN(maxPrice) ? 999999 : maxPrice,
      originalName: policyName
    };
    
  } catch (e) {
    console.error('ãƒãƒªã‚·ãƒ¼åãƒ‘ãƒ¼ã‚¹ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}
/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®é€æ–™ä¸Šé™ã‚’å–å¾—
 * @param {string} category - ã‚«ãƒ†ã‚´ãƒªãƒ¼å
 * @return {number|null} é€æ–™ä¸Šé™ï¼ˆUSDï¼‰ã€nullã¯ä¸Šé™ãªã—
 */
function getShippingLimitForCategory(category) {
  try {
    var categories = CONFIG.SHIPPING_POLICY_CATEGORIES;
    
    if (categories[category] && typeof categories[category].limit !== 'undefined') {
      return categories[category].limit;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ã€Œãã®ä»–ã€æ‰±ã„ï¼ˆä¸Šé™ãªã—ï¼‰
    return null;
    
  } catch (e) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸Šé™å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}
/**
 * ãƒãƒªã‚·ãƒ¼åˆ¤å®šç”¨ã®èª¿æ•´å¾Œä¾¡æ ¼ã‚’è¨ˆç®—ï¼ˆé–¢ç¨ç‡å·®ã‚’è€ƒæ…®ï¼‰
 * @param {Sheet} sheet - ä½œæ¥­ã‚·ãƒ¼ãƒˆ
 * @param {number} dduPrice - DDUä¾¡æ ¼ï¼ˆRåˆ—ã®å€¤ï¼‰
 * @return {number} èª¿æ•´å¾Œä¾¡æ ¼
 */
function calculateAdjustedPriceForPolicy(sheet, dduPrice) {
  try {
    // åŸºæº–é–¢ç¨ç‡ï¼ˆå›ºå®šï¼‰
    var BASE_RATE = 0.15;
    
    // ã‚»ãƒ«ã‹ã‚‰å€¤ã‚’å–å¾—
    var safetyFactor = Number(sheet.getRange('AE2').getValue()) || 1.35;
    var customsFee = Number(sheet.getRange('AC1').getValue()) || 10;
    var currentRate = Number(sheet.getRange('AD2').getValue()) || 0.15;
    
    // DDUä¾¡æ ¼ãŒç„¡åŠ¹ãªå ´åˆã¯ãã®ã¾ã¾è¿”ã™
    if (isNaN(dduPrice) || dduPrice <= 0) {
      console.log('DDUä¾¡æ ¼ãŒç„¡åŠ¹: ' + dduPrice);
      return dduPrice;
    }
    
    // åŸºæº–é–¢ç¨ï¼ˆ15%ï¼‰
    var baseEstimatedTax = dduPrice * BASE_RATE * safetyFactor + customsFee;
    
    // ç¾åœ¨ã®å›½ã®é–¢ç¨
    var currentEstimatedTax = dduPrice * currentRate * safetyFactor + customsFee;
    
    // é€æ–™å·®é¡ï¼ˆ5ãƒ‰ãƒ«åˆ»ã¿ã§åˆ‡ã‚Šæ¨ã¦ï¼‰
    var shippingDiff = Math.floor((currentEstimatedTax - baseEstimatedTax) / 5) * 5;
    
    // ä¾¡æ ¼å¸¯æ›ç®—ï¼ˆé€æ–™$5 â†’ ä¾¡æ ¼å¸¯$25ã®æ¯”ç‡ï¼‰
    var priceBandAdjustment = shippingDiff * 5;
    
    // èª¿æ•´å¾Œä¾¡æ ¼
    var adjustedPrice = dduPrice + priceBandAdjustment;
    
    // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°
    if (priceBandAdjustment !== 0) {
      console.log('ä¾¡æ ¼èª¿æ•´: DDU $' + dduPrice + ' â†’ èª¿æ•´å¾Œ $' + adjustedPrice + 
                  ' (é–¢ç¨ç‡' + (currentRate * 100) + '%, èª¿æ•´é¡+$' + priceBandAdjustment + ')');
    }
    
    return adjustedPrice;
    
  } catch (e) {
    console.error('èª¿æ•´å¾Œä¾¡æ ¼è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return dduPrice;  // ã‚¨ãƒ©ãƒ¼æ™‚ã¯å…ƒã®ä¾¡æ ¼ã‚’è¿”ã™
  }
}
/**
 * æ¡ä»¶ã«åˆã†ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼IDã‚’æ¤œç´¢
 * @param {string} category - ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆä¾‹ï¼šVideo Gamesï¼‰
 * @param {string} condition - å•†å“çŠ¶æ…‹ï¼ˆæ–°å“/ä¸­å¤ï¼‰
 * @param {string} shippingType - é…é€ã‚¿ã‚¤ãƒ—ï¼ˆã‚¨ã‚³ãƒãƒŸãƒ¼/EXï¼‰
 * @param {number} priceUSD - è²©å£²ä¾¡æ ¼ï¼ˆUSDï¼‰
 * @return {number|null} ãƒãƒªã‚·ãƒ¼IDã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯null
 */
function findShippingPolicyId(category, condition, shippingType, priceUSD) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Policy_Master');
    
    if (!sheet) {
      console.error('Policy_Master ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return null;
    }
    
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      console.error('Policy_Master ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return null;
    }
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®é€æ–™ä¸Šé™ã‚’å–å¾—
    var shippingLimit = getShippingLimitForCategory(category);
    
    // å…¨ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆAåˆ—:IDã€Båˆ—:åç§°ã€Cåˆ—:é€æ–™ä¸Šä¹—ã›ï¼‰
    var data = sheet.getRange(2, 1, lastRow - 1, 3).getValues();
    
    var candidates = [];
    
    // æ¡ä»¶ã«åˆã†ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢
    for (var i = 0; i < data.length; i++) {
      var id = data[i][0];
      var name = data[i][1];
      var shippingFee = data[i][2]; // Cåˆ—ï¼šé€æ–™ä¸Šä¹—ã›ä¾¡æ ¼
      
      if (!name) continue;
      
      // åç§°ã‚’ãƒ‘ãƒ¼ã‚¹
      var parsed = parseShippingPolicyName(String(name));
      
      if (!parsed) continue;
      
      // åŸºæœ¬æ¡ä»¶ãƒã‚§ãƒƒã‚¯
      if (parsed.condition !== condition) continue;
      if (parsed.shippingType !== shippingType) continue;
      if (priceUSD < parsed.minPrice || priceUSD > parsed.maxPrice) continue;
      
      // é€æ–™ä¸Šé™ãƒã‚§ãƒƒã‚¯ï¼ˆCåˆ—ã®é€æ–™ä¸Šä¹—ã›ã¨æ¯”è¼ƒï¼‰
      if (shippingLimit !== null && typeof shippingFee === 'number' && shippingFee > shippingLimit) {
        console.log('ãƒãƒªã‚·ãƒ¼ID ' + id + ' ã¯é€æ–™$' + shippingFee + ' > ä¸Šé™$' + shippingLimit + ' ã§ã‚¹ã‚­ãƒƒãƒ—');
        continue;
      }
      
      // æ¡ä»¶ã«åˆè‡´
      candidates.push({
        id: id,
        name: name,
        shippingFee: shippingFee,
        parsed: parsed
      });
    }
    
    if (candidates.length === 0) {
      // ä¸Šé™å†…ã§è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã€æœ€å¤§è¨±å®¹ç¯„å›²ã®ãƒãƒªã‚·ãƒ¼ã‚’æ¢ã™
      if (shippingLimit !== null) {
        console.log('ä¸Šé™å†…ã®ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ã‚’å®Ÿè¡Œ');
        return findFallbackPolicy(sheet, data, condition, shippingType, shippingLimit);
      }
      console.log('è©²å½“ã™ã‚‹ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return null;
    }
    
    // æœ€åˆã«è¦‹ã¤ã‹ã£ãŸã‚‚ã®ã‚’è¿”ã™ï¼ˆä¾¡æ ¼å¸¯ã¯ä¸€æ„ã®ã¯ãšï¼‰
    console.log('ãƒãƒªã‚·ãƒ¼ID ' + candidates[0].id + ' ã‚’é¸æŠï¼ˆé€æ–™$' + candidates[0].shippingFee + 'ï¼‰');
    return candidates[0].id;
    
  } catch (e) {
    console.error('ãƒãƒªã‚·ãƒ¼æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}

/**
 * ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼šä¸Šé™å†…ã®æœ€å¤§é€æ–™ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢
 * @param {Sheet} sheet - Policy_Masterã‚·ãƒ¼ãƒˆ
 * @param {Array} data - ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
 * @param {string} condition - å•†å“çŠ¶æ…‹
 * @param {string} shippingType - é…é€ã‚¿ã‚¤ãƒ—
 * @param {number} shippingLimit - é€æ–™ä¸Šé™
 * @return {number|null} ãƒãƒªã‚·ãƒ¼ID
 */
function findFallbackPolicy(sheet, data, condition, shippingType, shippingLimit) {
  try {
    var maxAllowedPolicy = null;
    var maxAllowedFee = 0;
    
    for (var i = 0; i < data.length; i++) {
      var id = data[i][0];
      var name = data[i][1];
      var shippingFee = data[i][2]; // Cåˆ—ï¼šé€æ–™ä¸Šä¹—ã›ä¾¡æ ¼
      
      if (!name) continue;
      
      var parsed = parseShippingPolicyName(String(name));
      
      if (!parsed) continue;
      if (parsed.condition !== condition) continue;
      if (parsed.shippingType !== shippingType) continue;
      
      // é€æ–™ãŒä¸Šé™ä»¥ä¸‹ã‹ãƒã‚§ãƒƒã‚¯
      if (typeof shippingFee !== 'number') continue;
      if (shippingFee > shippingLimit) continue;
      
      // ä¸Šé™å†…ã§æœ€å¤§ã®é€æ–™ã‚’æ¢ã™
      if (shippingFee > maxAllowedFee) {
        maxAllowedFee = shippingFee;
        maxAllowedPolicy = id;
      }
    }
    
    if (maxAllowedPolicy !== null) {
      console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: ãƒãƒªã‚·ãƒ¼ID ' + maxAllowedPolicy + ' ã‚’é¸æŠï¼ˆé€æ–™$' + maxAllowedFee + ' â‰¤ ä¸Šé™$' + shippingLimit + 'ï¼‰');
    } else {
      console.log('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢ã§ã‚‚è©²å½“ãªã—');
    }
    
    return maxAllowedPolicy;
    
  } catch (e) {
    console.error('ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒãƒªã‚·ãƒ¼æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}


/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠçµæœã‚’å‡¦ç†ã—ã¦ãƒãƒªã‚·ãƒ¼IDã‚’è¨­å®š
 */
function applyShippingPolicyWithCategory(selectedCategory) {
  try {
    if (!selectedCategory) {
      showAlert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warning');
      return;
    }
    
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;

    // ä¿å­˜ã•ã‚ŒãŸç¯„å›²ã‚’å–å¾—
    var props = PropertiesService.getScriptProperties();
    var startRow = parseInt(props.getProperty('SHIPPING_POLICY_START_ROW'));
    var endRow = parseInt(props.getProperty('SHIPPING_POLICY_END_ROW'));
    
    // ä¸€æ™‚ä¿å­˜ã‚’ã‚¯ãƒªã‚¢
    props.deleteProperty('SHIPPING_POLICY_START_ROW');
    props.deleteProperty('SHIPPING_POLICY_END_ROW');

    if (isNaN(startRow) || isNaN(endRow)) {
      showAlert('å¯¾è±¡è¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      return;
    }

    var successCount = 0;
    var errorCount = 0;
    var skippedCount = 0;

    for (var row = startRow; row <= endRow; row++) {
      if (row < 5) {
        skippedCount++;
        continue;
      }
      
      try {
        if (setShippingPolicyToRow(sheet, row, selectedCategory)) {
          successCount++;
        } else {
          errorCount++;
        }
      } catch (e) {
        console.error('è¡Œ' + row + 'ã®ãƒãƒªã‚·ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼: ' + e.message);
        errorCount++;
      }
    }

    var report = 'ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼è¨­å®šå®Œäº†:\n\n' +
      'é¸æŠã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + selectedCategory + '\n' +
      'å¯¾è±¡ç¯„å›²: ' + startRow + 'ï½' + endRow + 'è¡Œ\n' +
      'è¨­å®šæˆåŠŸ: ' + successCount + 'è¡Œ\n' +
      'è¨­å®šå¤±æ•—: ' + errorCount + 'è¡Œ\n' +
      'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'è¡Œ\n\n' +
      'å¤±æ•—ã®åŸå› :\n' +
      '- ä¾¡æ ¼ï¼ˆRåˆ—ï¼‰ã€å•†å“çŠ¶æ…‹ï¼ˆACåˆ—ï¼‰ã€é…é€æ–¹æ³•ï¼ˆXåˆ—ï¼‰ãŒæœªå…¥åŠ›\n' +
      '- é…é€æ–¹æ³•ãŒã€Œè‡ªå‹•é¸æŠã€ã«ãªã£ã¦ã„ã‚‹\n' +
      '- è©²å½“ã™ã‚‹ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„';

    showAlert(report, successCount > 0 ? 'success' : 'warning');

  } catch (error) {
    showAlert('ãƒãƒªã‚·ãƒ¼é©ç”¨ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * 1è¡Œã«ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼IDã‚’è¨­å®š
 */
function setShippingPolicyToRow(sheet, row, category) {
  try {
    // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
    // å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
var priceUSD = Number(sheet.getRange(row, CONFIG.COLUMNS.PRICE).getValue());

// ã€è¿½åŠ ã€‘é–¢ç¨ç‡ã‚’è€ƒæ…®ã—ãŸèª¿æ•´å¾Œä¾¡æ ¼ã‚’è¨ˆç®—
var adjustedPrice = calculateAdjustedPriceForPolicy(sheet, priceUSD);
    var condition = String(sheet.getRange(row, CONFIG.COLUMNS.CONDITION).getValue() || '').trim();
    var shippingMethod = String(sheet.getRange(row, CONFIG.COLUMNS.METHOD).getValue() || '').trim();
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (isNaN(priceUSD) || priceUSD <= 0) {
      console.log('è¡Œ' + row + ': ä¾¡æ ¼ãŒç„¡åŠ¹ (' + priceUSD + ')');
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
      return false;
    }
    
    if (!condition || !['æ–°å“', 'ä¸­å¤'].includes(condition)) {
      console.log('è¡Œ' + row + ': å•†å“çŠ¶æ…‹ãŒç„¡åŠ¹ (' + condition + ')');
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
      return false;
    }
    
    // é…é€æ–¹æ³•ã‚’å¤‰æ›
    var shippingType = convertShippingMethodToType(shippingMethod);
    if (shippingType === 'ã‚¨ãƒ©ãƒ¼') {
      console.log('è¡Œ' + row + ': é…é€æ–¹æ³•ãŒç„¡åŠ¹ (' + shippingMethod + ')');
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
      return false;
    }
    
    // ãƒãƒªã‚·ãƒ¼IDã‚’æ¤œç´¢
    var policyId = findShippingPolicyId(category, condition, shippingType, adjustedPrice);
    
    if (policyId !== null) {
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue(policyId);
      console.log('è¡Œ' + row + ': ãƒãƒªã‚·ãƒ¼ID ' + policyId + ' ã‚’è¨­å®š');
      return true;
    } else {
      console.log('è¡Œ' + row + ': è©²å½“ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„');
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('è©²å½“ãªã—');
      return false;
    }
    
  } catch (error) {
    console.error('è¡Œ' + row + 'ã®ãƒãƒªã‚·ãƒ¼è¨­å®šã‚¨ãƒ©ãƒ¼: ' + error.message);
    sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
    return false;
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showShippingPolicyCategoryDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('ShippingPolicyCategoryDialog')
      .setWidth(480).setHeight(450);
    SpreadsheetApp.getUi().showModalDialog(html, 'ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ - ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ');
  } catch (e) {
    showAlert('ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
  }
}

/**
 * ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’å–å¾—ï¼ˆHTMLç”¨ï¼‰
 */
function getShippingPolicyCategories() {
  try {
    var categories = CONFIG.SHIPPING_POLICY_CATEGORIES;
    var result = [];
    
    for (var key in categories) {
      if (categories.hasOwnProperty(key)) {
        result.push({
          value: key,
          display: categories[key].display,
          limit: categories[key].limit
        });
      }
    }
    
    return result;
    
  } catch (e) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return [{ value: 'Other', display: 'ãã®ä»–ï¼ˆä¸Šé™ãªã—ï¼‰', limit: null }];
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  é–¢ç¨ç‡å¯¾å¿œæ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆé–¢æ•°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * èª¿æ•´å¾Œä¾¡æ ¼è¨ˆç®—ã®ãƒ†ã‚¹ãƒˆ
 */
function testAdjustedPriceCalculation() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }
    
    // ç¾åœ¨ã®è¨­å®šå€¤ã‚’å–å¾—
    var currentRate = Number(sheet.getRange('AD2').getValue()) || 0.15;
    var safetyFactor = Number(sheet.getRange('AE2').getValue()) || 1.35;
    var customsFee = Number(sheet.getRange('AC1').getValue()) || 10;
    
    // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹
    var testCases = [
      { ddu: 100, rate: 0.15 },
      { ddu: 100, rate: 0.39 },
      { ddu: 500, rate: 0.39 },
      { ddu: 900, rate: 0.39 }
    ];
    
    var report = 'ğŸ“Š èª¿æ•´å¾Œä¾¡æ ¼è¨ˆç®—ãƒ†ã‚¹ãƒˆ\n\n';
    report += 'ç¾åœ¨ã®ã‚»ãƒ«è¨­å®š:\n';
    report += 'â€¢ AD2ï¼ˆé–¢ç¨ç‡ï¼‰: ' + (currentRate * 100) + '%\n';
    report += 'â€¢ AE2ï¼ˆå®‰å…¨ä¿‚æ•°ï¼‰: ' + safetyFactor + '\n';
    report += 'â€¢ AC1ï¼ˆé€šé–¢æ‰‹æ•°æ–™ï¼‰: $' + customsFee + '\n\n';
    report += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    
    for (var i = 0; i < testCases.length; i++) {
      var tc = testCases[i];
      
      // ä¸€æ™‚çš„ã«é–¢ç¨ç‡ã‚’å¤‰æ›´
      sheet.getRange('AD2').setValue(tc.rate);
      SpreadsheetApp.flush();
      
      var adjustedPrice = calculateAdjustedPriceForPolicy(sheet, tc.ddu);
      var adjustment = adjustedPrice - tc.ddu;
      
      report += 'ãƒ†ã‚¹ãƒˆ' + (i + 1) + ':\n';
      report += 'â€¢ DDUä¾¡æ ¼: $' + tc.ddu + '\n';
      report += 'â€¢ é–¢ç¨ç‡: ' + (tc.rate * 100) + '%\n';
      report += 'â€¢ èª¿æ•´å¾Œä¾¡æ ¼: $' + adjustedPrice.toFixed(2) + '\n';
      report += 'â€¢ èª¿æ•´é¡: ' + (adjustment > 0 ? '+' : '') + '$' + adjustment.toFixed(2) + '\n\n';
    }
    
    // å…ƒã®é–¢ç¨ç‡ã«æˆ»ã™
    sheet.getRange('AD2').setValue(currentRate);
    SpreadsheetApp.flush();
    
    showAlert(report, 'info');
    
  } catch (e) {
    showAlert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * å®ŸåŠ¹é–¾å€¤è¨ˆç®—ã®ãƒ†ã‚¹ãƒˆ
 */
function testEffectiveThreshold() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }
    
    var baseThreshold = settings.dduThreshold || 900;
    
    var testRates = [0.15, 0.20, 0.25, 0.30, 0.35, 0.39];
    
    var report = 'ğŸ“Š å®ŸåŠ¹é–¾å€¤è¨ˆç®—ãƒ†ã‚¹ãƒˆ\n\n';
    report += 'åŸºæº–é–¾å€¤: $' + baseThreshold + ' (15%åŸºæº–)\n\n';
    report += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    
    for (var i = 0; i < testRates.length; i++) {
      var rate = testRates[i];
      var effectiveThreshold = calculateEffectiveThreshold(baseThreshold, sheet, rate);
      var diff = baseThreshold - effectiveThreshold;
      
      report += 'é–¢ç¨ç‡ ' + (rate * 100) + '%:\n';
      report += 'â€¢ å®ŸåŠ¹é–¾å€¤: $' + effectiveThreshold + '\n';
      report += 'â€¢ å·®é¡: -$' + diff.toFixed(0) + '\n\n';
    }
    
    report += 'ğŸ’¡ é–¢ç¨ç‡ãŒé«˜ã„ã»ã©ã€å®ŸåŠ¹é–¾å€¤ã¯ä½ããªã‚Šã¾ã™ã€‚';
    
    showAlert(report, 'info');
    
  } catch (e) {
    showAlert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * ãƒãƒªã‚·ãƒ¼åˆ¤å®šã®å‹•ä½œç¢ºèª
 */
function testPolicySelection() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }
    
    // ç¾åœ¨ã®é–¢ç¨ç‡ã‚’å–å¾—
    var currentRate = Number(sheet.getRange('AD2').getValue()) || 0.15;
    
    var testCase = {
      category: 'Other',
      condition: 'æ–°å“',
      shippingType: 'EX',
      dduPrice: 100
    };
    
    // 15%ã§ãƒ†ã‚¹ãƒˆ
    sheet.getRange('AD2').setValue(0.15);
    SpreadsheetApp.flush();
    var adjustedPrice15 = calculateAdjustedPriceForPolicy(sheet, testCase.dduPrice);
    var policyId15 = findShippingPolicyId(testCase.category, testCase.condition, testCase.shippingType, adjustedPrice15);
    
    // 39%ã§ãƒ†ã‚¹ãƒˆ
    sheet.getRange('AD2').setValue(0.39);
    SpreadsheetApp.flush();
    var adjustedPrice39 = calculateAdjustedPriceForPolicy(sheet, testCase.dduPrice);
    var policyId39 = findShippingPolicyId(testCase.category, testCase.condition, testCase.shippingType, adjustedPrice39);
    
    // å…ƒã®é–¢ç¨ç‡ã«æˆ»ã™
    sheet.getRange('AD2').setValue(currentRate);
    SpreadsheetApp.flush();
    
    var report = 'ğŸ“Š ãƒãƒªã‚·ãƒ¼åˆ¤å®šãƒ†ã‚¹ãƒˆ\n\n';
    report += 'ãƒ†ã‚¹ãƒˆæ¡ä»¶:\n';
    report += 'â€¢ ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + testCase.category + '\n';
    report += 'â€¢ çŠ¶æ…‹: ' + testCase.condition + '\n';
    report += 'â€¢ é…é€: ' + testCase.shippingType + '\n';
    report += 'â€¢ DDUä¾¡æ ¼: $' + testCase.dduPrice + '\n\n';
    report += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n\n';
    report += 'ã€15%é–¢ç¨ç‡ã€‘\n';
    report += 'â€¢ èª¿æ•´å¾Œä¾¡æ ¼: $' + adjustedPrice15.toFixed(2) + '\n';
    report += 'â€¢ é¸æŠãƒãƒªã‚·ãƒ¼ID: ' + (policyId15 || 'è¦‹ã¤ã‹ã‚‰ãš') + '\n\n';
    report += 'ã€39%é–¢ç¨ç‡ã€‘\n';
    report += 'â€¢ èª¿æ•´å¾Œä¾¡æ ¼: $' + adjustedPrice39.toFixed(2) + '\n';
    report += 'â€¢ é¸æŠãƒãƒªã‚·ãƒ¼ID: ' + (policyId39 || 'è¦‹ã¤ã‹ã‚‰ãš') + '\n\n';
    
    if (policyId15 !== policyId39) {
      report += 'âœ… é–¢ç¨ç‡ã«ã‚ˆã‚Šç•°ãªã‚‹ãƒãƒªã‚·ãƒ¼ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚';
    } else {
      report += 'âš ï¸ åŒã˜ãƒãƒªã‚·ãƒ¼ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ä¾¡æ ¼å¸¯ãŒåŒã˜ç¯„å›²å†…ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚';
    }
    
    showAlert(report, 'info');
    
  } catch (e) {
    showAlert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}
/******************************************************
 * å®Œå…¨ç‰ˆï¼ˆã‚¨ãƒ©ãƒ¼ä¿®æ­£æ¸ˆã¿ï¼‰Part 5/5
 *  - ãƒ¡ãƒ‹ãƒ¥ãƒ¼ onOpenï¼ˆçµ±åˆï¼‰
 *  - README ä½œæˆ/æ›´æ–°ã€PDFæ›¸ãå‡ºã—ã€ç°¡æ˜“å›³è§£
 *  - ä¾¡æ ¼è¨ˆç®—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆA/Bï¼‰
 *  - ç°¡æ˜“ç‰ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼ãƒ»åˆæœŸè¨­å®šãƒ»å®Ÿè¡Œãƒ•ãƒ­ãƒ¼
 ******************************************************/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ onOpenï¼ˆçµ±åˆï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function onOpen() {
  try {
    var ui = SpreadsheetApp.getUi();
    
    // 1. å®Ÿè¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆæ¯å›ä½¿ã†æ©Ÿèƒ½ï¼‰
    ui.createMenu("ğŸ” å®Ÿè¡Œãƒ¡ãƒ‹ãƒ¥ãƒ¼")  
      .addItem("âœ…ã€€é¸æŠè¡Œã‚’å®Ÿè¡Œ(ç¿»è¨³ãƒ»è¨ˆç®—)", "runSelectedRows")
      .addItem("ğŸš€ã€€çµ±åˆå®Ÿè¡Œï¼ˆç¿»è¨³ãƒ»è¨ˆç®—ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼ï¼‰", "runSelectedRowsComplete")
      .addSeparator()
      .addItem("ğŸ”„ ãƒãƒƒãƒå‡¦ç†(ç¿»è¨³ãƒ»è¨ˆç®—) 50è¡Œãšã¤è‡ªå‹•å®Ÿè¡Œ", "runSelectedRowsBatch")
      .addItem("ğŸ”„ ãƒãƒƒãƒå‡¦ç†(çµ±åˆå®Ÿè¡Œ) 50è¡Œãšã¤è‡ªå‹•å®Ÿè¡Œ", "runSelectedRowsCompleteBatch")
      .addItem('â–¶ï¸ å‡¦ç†ã‚’å†é–‹', 'resumeBatchProcessing')
      .addItem('ğŸ“Š é€²æ—ç¢ºèª', 'checkBatchProgress')
      .addItem('âŒ å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«', 'cancelBatchProcessing')
      .addSeparator()
      .addItem("ğŸ“ã€€é¸æŠè¡Œã‚’ç¿»è¨³ã®ã¿", "runSelectedRowsTranslate")
      .addItem("ğŸ”¢ã€€é¸æŠè¡Œã‚’è¨ˆç®—ã®ã¿", "runSelectedRowsCalculate")
      .addSeparator()
      .addItem('âš¡ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼è‡ªå‹•å‡ºåŠ›ï¼ˆO1ãƒ»O2ä½¿ç”¨ï¼‰', 'autoApplyTemplateAndPolicy')
      .addItem('ğŸ–ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ»ãƒãƒªã‚·ãƒ¼æ‰‹å‹•é¸æŠï¼ˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ï¼‰', 'setTemplateAndPolicyForSelectedRows')
      .addItem('ğŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢', 'showTemplateManualSearchDialog')
      .addItem('ğŸ” ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ‰‹å‹•æ¤œç´¢', 'showShippingPolicyManualSearchDialog')
      .addSeparator()
      .addItem("ğŸ“¦ é¸æŠè¡Œã‚’ä¿å­˜ã—ã¦ã‚¯ãƒªã‚¢", "saveSelectedRowsAndClear")
      .addItem("ğŸ—‘ï¸ é¸æŠè¡Œã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤", "clearSelectedRowsOnly")
      .addSeparator()
      .addItem('é¸æŠè¡Œã®é«˜ã•ã‚’150pxã«èª¿æ•´', 'adjustSelectedRowHeights')
      .addItem('é¸æŠè¡Œã®é«˜ã•ã‚’ãƒªã‚»ãƒƒãƒˆ', 'resetSelectedRowHeights')
      .addItem('é¸æŠè¡Œã‚’ã‚¯ãƒªã‚¢', 'clearSelectedRowsSafely')
      .addItem('ä½œæ¥­ã‚·ãƒ¼ãƒˆã«ã‚³ãƒ”ãƒ¼', 'copyToWorkSheet')

      .addToUi();
    
    // 2. è¨ˆç®—ãƒ¡ãƒ‹ãƒ¥ãƒ¼
    addPriceCalcStandaloneMenu_();
    
    // 3. è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆåˆæœŸè¨­å®š + EAGLEæ›´æ–° + ç°¡æ˜“ç‰ˆï¼‰
    ui.createMenu('âš™ï¸ è¨­å®šãƒ¡ãƒ‹ãƒ¥ãƒ¼')
      .addItem("âš™ï¸ åˆæœŸè¨­å®šï¼ˆã„ã¤ã§ã‚‚å¤‰æ›´å¯ï¼‰", "initialSetup")
      .addItem("ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†", "showPromptEditorSidebar")
      .addSeparator()
      .addItem('ğŸ“Š EAGLE ãƒ‡ãƒ¼ã‚¿æ›´æ–°ï¼ˆåˆå›/å®šæœŸæ›´æ–°ï¼‰', 'updateEagleData')
      .addItem('ğŸ› ï¸ EAGLEã‚·ãƒ¼ãƒˆåˆæœŸä½œæˆ', 'setupInitial')
      .addSeparator()
      .addItem('ğŸ”— æ—§ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'showDataImportDialog')
      .addItem('ğŸ“¤ è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'exportSettingsToSheet')
      .addItem('ğŸ“¥ è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'showSettingsImportDialog')
      .addItem('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'showDataImportDialog')
      .addSeparator()
      .addItem('ğŸ”„ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼å†å–å¾—', 'updateTemplatePolicyOnly')
      .addItem('ğŸš€ æ¤œè¨¼â†’ãƒã‚¹ã‚¿ãƒ¼åæ˜ ', 'validateAndApplyImport')
      .addItem('ğŸ”‘ APIãƒˆãƒ¼ã‚¯ãƒ³ç®¡ç†', 'manageApiToken')
      .addItem('ğŸ“‹ ç¾åœ¨ã®è¨­å®šç¢ºèª', 'showCurrentSetupStatus')
      .addSeparator()
      .addSubMenu(ui.createMenu('ğŸ“± ç°¡æ˜“ç‰ˆ')
        .addItem('ğŸ¯ ç°¡æ˜“ç‰ˆã‚’é–‹ã', 'openSimpleMode')
        .addItem('ğŸ”„ ç°¡æ˜“ç‰ˆã‚’æ›´æ–°', 'updateSimpleMode'))
      .addToUi();

  } catch (e) {
    // menuå¤±æ•—æ™‚ã¯é»™æ®º
  }
}

function createOrUpdateReadme_() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var name = 'README';
  var sh = ss.getSheetByName(name);
  if (!sh) sh = ss.insertSheet(name); else sh.clear();

  function h(row, text){ sh.getRange(row,1).setValue(text).setFontWeight('bold').setFontSize(12); }
  function p(row, text){ sh.getRange(row,1).setValue(text).setWrap(true); }
  function kvTable(row, title, obj){
    h(row, 'â–  ' + title);
    var i = row+1, data = [['Key','Value']];
    for (var k in obj){ data.push([k, (typeof obj[k]==='object'? JSON.stringify(obj[k]) : String(obj[k]))]); }
    sh.getRange(i,1,data.length,data[0].length).setValues(data);
    sh.getRange(i,1,1,2).setFontWeight('bold').setBackground('#e6f0ff');
    sh.getRange(i,data[0].length, data.length, 1).setWrap(true);
    return i + data.length;
  }

  var row = 1;
  h(row++, 'ğŸ“– ã“ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ä½¿ã„æ–¹ï¼ˆè‡ªå‹•ç”Ÿæˆï¼‰');
  p(row++, 'æœ€çµ‚æ›´æ–°: ' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyy-MM-dd HH:mm:ss'));
  row++;

  h(row++, '1. æ¦‚è¦');
  p(row++, 'ã“ã®ãƒ–ãƒƒã‚¯ã¯ã€eBayå‡ºå“å‘ã‘ã«ã€Œã‚¿ã‚¤ãƒˆãƒ«/èª¬æ˜ã®è‹±è¨³ç”Ÿæˆã€ã€Œé€æ–™ãƒ»æ‰‹æ•°æ–™ãƒ»åˆ©ç›Šã‚’è€ƒæ…®ã—ãŸè²©å£²ä¾¡æ ¼è¨ˆç®—ã€ã€Œé…é€æ–¹æ³•ã®è‡ªå‹•åˆ¤å®šã€ã‚’è¡Œã†ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚OpenAI/Claude/Gemini ã„ãšã‚Œã‹ã®APIã‚’ä½¿ç”¨ã—ã¾ã™ã€‚');
  row++;

  h(row++, '2. åˆæœŸè¨­å®šï¼ˆæœ€åˆã«ã‚„ã‚‹ã“ã¨ï¼‰');
  p(row++, [
    'â‘  ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã€ŒğŸ” AIç¿»è¨³ãƒ»ä¾¡æ ¼è¨ˆç®—ã€â†’ã€Œâš™ï¸ åˆæœŸè¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰ã€ã§APIã‚­ãƒ¼/ãƒ¢ãƒ‡ãƒ«/ä½œæ¥­ã‚·ãƒ¼ãƒˆåãªã©ã‚’ä¿å­˜ã—ã¾ã™ã€‚',
    'â‘¡ ä½œæ¥­ã‚·ãƒ¼ãƒˆã®ã‚»ãƒ«è¨­å®šï¼šç‚ºæ›¿ C2ã€æ‰‹æ•°æ–™ç‡ F1ã€åºƒå‘Šè²»ç‡ F2ã€åˆ©ç›Šç‡ H2 ã‚‚ã—ãã¯åˆ©ç›Šé¡ H1 ã‚’å…¥åŠ›ã€‚',
    'â‘¢ é…é€é–¢é€£ï¼šQ1/Q2/R2/T1/T2ï¼ˆç‡ƒæ²¹ãƒ»å‰²å¼•ãƒ»è¿½åŠ 500gï¼‰ã‚’å¿…è¦ã«å¿œã˜ã¦è¨­å®šã€‚',
    'â‘£ é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ã‚’ä½¿ã†å ´åˆã¯ã€ŒğŸšš é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®šã€ã§ Shipping_Rates ã‚’ä½œæˆã—ã€å›½ãƒ»ã‚¾ãƒ¼ãƒ³ã”ã¨ã®æ–™é‡‘ã‚’å…¥åŠ›ã€‚',
    '   â€» Airmail ã®å¸¯ã¯ Shipping_Rates ã® I/J åˆ—ã‚’ä½¿ç”¨ã—ã¾ã™ï¼ˆI=é–¾å€¤Max, J=æ–™é‡‘ï¼‰ã€‚'
  ].join('\n'));
  row += 3;

  h(row++, '3. ä¸»è¦ã‚»ãƒ«ãƒ»åˆ—ï¼ˆä½œæ¥­ã‚·ãƒ¼ãƒˆï¼‰');
  var cols = CONFIG && CONFIG.COLUMNS ? CONFIG.COLUMNS : {};
  row = kvTable(row, 'åˆ—ãƒãƒƒãƒ”ãƒ³ã‚°ï¼ˆCONFIG.COLUMNSï¼‰', cols);
  row = kvTable(row+1, 'é€æ–™ãƒ¡ã‚¿ï¼ˆCONFIG.SHIPPING_METHODSï¼‰', CONFIG && CONFIG.SHIPPING_METHODS ? CONFIG.SHIPPING_METHODS : {});
  row++;

  h(row++, '4. åŸºæœ¬çš„ãªä½¿ã„æ–¹ãƒ•ãƒ­ãƒ¼');
  p(row++, [
    '1) ä½œæ¥­ã‚·ãƒ¼ãƒˆã® Jåˆ—ï¼ˆæ—¥æœ¬èªã‚¿ã‚¤ãƒˆãƒ«ï¼‰/Kåˆ—ï¼ˆæ—¥æœ¬èªèª¬æ˜ï¼‰/Iåˆ—ï¼ˆä»•å…¥ã‚Œå€¤ï¼‰ã‚’å…¥åŠ›ã€‚',
    '2) J2: æ¢±åŒ…é‡é‡ã€L2/M2/N2: æ¢±åŒ…ã‚µã‚¤ã‚ºã‚’å…¥åŠ›ã€‚',
    '3) ã€Œä¸€æ‹¬å®Ÿè¡Œã€ã¾ãŸã¯ã€Œé¸æŠè¡Œã‚’å®Ÿè¡Œã€ã‚’æŠ¼ã™ã¨ã€è‹±èªã‚¿ã‚¤ãƒˆãƒ«/èª¬æ˜ï¼ˆM/Nåˆ—ï¼‰ã€é…é€æ–¹æ³•ï¼ˆVåˆ—ï¼‰ã€é€æ–™ï¼ˆRåˆ—ï¼‰ã€è²©å£²ä¾¡æ ¼ï¼ˆQåˆ—ï¼‰ãªã©ãŒåŸ‹ã¾ã‚Šã¾ã™ã€‚',
    '4) Small Packet ä¸å¯ã‚„æ–™é‡‘è¡¨æœªæ•´å‚™ã®å ´åˆã¯ FedEx ã¸ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ã—ã€ã‚»ãƒ«ã«æ³¨è¨˜ã‚„è‰²ã§è­¦å‘Šã—ã¾ã™ã€‚',
    '5) O2=1 ã®å ´åˆã¯ Airmail ã‚’å¼·åˆ¶é¸æŠã—ã¾ã™ï¼ˆUSå®›ã®ã¿é‹ç”¨æƒ³å®šï¼‰ã€‚'
  ].join('\n'));
  row += 2;

  h(row++, '5. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®èª¬æ˜ï¼ˆğŸ” AIç¿»è¨³ãƒ»ä¾¡æ ¼è¨ˆç®—ï¼‰');
  var menu = [
    ['ä¸€æ‹¬å®Ÿè¡Œ', 'æœªç¿»è¨³è¡Œã‚’ä¸€æ°—ã«å‡¦ç†ã€‚J2/L2/M2/N2ã®é‡é‡ãƒ»ã‚µã‚¤ã‚ºã‚’ä½¿ã„ã¾ã™ã€‚'],
    ['é¸æŠè¡Œã‚’å®Ÿè¡Œ', 'é¸æŠç¯„å›²ã®ã¿å‡¦ç†ã€‚'],
    ['ğŸ›‘ å‡¦ç†ã‚’åœæ­¢', 'é•·æ™‚é–“å‡¦ç†ã®ä¸­æ–­ã€‚å†é–‹ã¯è‡ªå‹•ãƒˆãƒªã‚¬ãƒ¼ or æ‰‹å‹•ã§ã€‚'],
    ['ğŸ“¦ é¸æŠè¡Œã‚’ä¿å­˜ã—ã¦ã‚¯ãƒªã‚¢', 'ä¿å­˜ã‚·ãƒ¼ãƒˆã¸ã‚³ãƒ”ãƒ¼ã—ã€å…ƒã®è¡Œã‚’å€¤ã‚¯ãƒªã‚¢ï¼ˆæ•°å¼/æ¤œè¨¼ã¯ä¿æŒï¼‰ã€‚'],
    ['ğŸ—‘ï¸ é¸æŠè¡Œã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤', 'é¸æŠè¡Œã®å…¥åŠ›å€¤ã®ã¿å‰Šé™¤ï¼ˆO/Påˆ—ã®æ•°å¼ã¯ä¿æŒï¼‰ã€‚'],
    ['ğŸ“‹ ä¿å­˜ã‚·ãƒ¼ãƒˆä¸€è¦§', 'ä¿å­˜æ¸ˆã¿ã®ã€Œä¿å­˜ãƒ‡ãƒ¼ã‚¿_*ã€ã‚·ãƒ¼ãƒˆã®å®¹é‡ã‚’ä¸€è¦§è¡¨ç¤ºã€‚'],
    ['âš™ï¸ åˆæœŸè¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰', 'APIã‚­ãƒ¼ã€ãƒ¢ãƒ‡ãƒ«ã€ä½œæ¥­ã‚·ãƒ¼ãƒˆåã€é€æ–™è¨ˆç®—æ–¹æ³•ãªã©ã‚’ä¿å­˜ã€‚'],
    ['ğŸ“Š åˆ©ç›Šé¡è¨­å®šã‚·ãƒ¼ãƒˆã‚’é–‹ã', 'ä»•å…¥ã‚Œå€¤ãƒ¬ãƒ³ã‚¸ã”ã¨ã®åˆ©ç›Šé¡/å›ºå®šé€æ–™ã‚’ç·¨é›†ï¼ˆProfit_Amountsï¼‰ã€‚'],
    ['ğŸšš é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«è¨­å®š', 'Shipping_Methods / Shipping_Rates ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ/æ›´æ–°ï¼ˆAirmail ã¯ I/J åˆ—ï¼‰ã€‚'],
    ['ğŸ” ç¾åœ¨ã®è¨­å®šç¢ºèª', 'ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£/ä¸»è¦ã‚»ãƒ«/æ¤œè¨¼çŠ¶æ…‹ã‚’ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã§è¡¨ç¤ºã€‚'],
    ['ğŸ”§ ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®š', 'é‡é‡/ã‚µã‚¤ã‚º/ç™ºé€æ–¹æ³•ã®æ¤œè¨¼ï¼ˆãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ï¼‰ã‚’ä¸€æ‹¬è¨­å®šã€‚'],
    ['ğŸ“Š å‡¦ç†çŠ¶æ³ç¢ºèª', 'æœªç¿»è¨³è¡Œ/å®Œäº†ç‡ãªã©ã®é€²æ—ã‚’è¡¨ç¤ºã€‚'],
    ['ğŸ“ ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆç·¨é›†', 'GPT_Prompts ã‚·ãƒ¼ãƒˆã®é¸æŠIDã®æœ¬æ–‡ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã§ç·¨é›†ã€‚']
  ];
  sh.getRange(row,1,menu.length+1,2).setValues([['æ©Ÿèƒ½','èª¬æ˜']].concat(menu))
    .setWrap(true);
  sh.getRange(row,1,1,2).setFontWeight('bold').setBackground('#e6f0ff');
  row += menu.length + 2;

  h(row++, '6. ã‚ˆãã‚ã‚‹ã‚¨ãƒ©ãƒ¼ã¨å¯¾å‡¦');
  var tips = [
    ['API_TIMEOUT è¶…é','APIã®å¾…ã¡æ™‚é–“ãŒåˆè¨ˆã§åˆ¶é™ã‚’è¶…éã€‚BATCH_SIZEã‚’ä¸‹ã’ã‚‹/èª¬æ˜æ–‡ã‚’çŸ­ãã™ã‚‹/å†å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚'],
    ['é€æ–™ã‚»ãƒ«ãŒèµ¤æ–‡å­—ï¼ˆ999999ï¼‰','Shipping_Rates æœªå…¥åŠ› or ç¯„å›²å¤–ã€‚ãƒ†ãƒ¼ãƒ–ãƒ«å…¥åŠ›ã‚„ Q1/Q2/R2/T1/T2 ã‚’è¦‹ç›´ã—ã€‚'],
    ['Small Packet ä¸å¯','ã‚µã‚¤ã‚ºä¸‰è¾ºåˆè¨ˆ or é‡é‡ãŒåˆ¶é™è¶…éã€‚FedExã¸è‡ªå‹•ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼ˆVåˆ—ãŒè–„èµ¤&æ³¨è¨˜ï¼‰ã€‚'],
    ['ç‚ºæ›¿ãŒç•°å¸¸å€¤','GOOGLEFINANCE å¤±æ•—æ™‚ã¯æ—¢å®š145å††ã‚’è‡ªå‹•ã‚»ãƒƒãƒˆã€‚C2ã‚’æ‰‹å…¥åŠ›ã§ã‚‚OKã€‚'],
    ['Airmail å¸¯ãŒåŠ¹ã‹ãªã„','Shipping_Rates ã® I/J åˆ—ã« (Max, æ–™é‡‘) ã®è¡Œã‚’è¨­å®šã—ã¦ã„ã‚‹ã‹ç¢ºèªã€‚ä¸Šã‹ã‚‰å°ã•ã„é †ã«ã€‚']
  ];
  sh.getRange(row,1,tips.length+1,2).setValues([['ç—‡çŠ¶','å¯¾å‡¦']].concat(tips)).setWrap(true);
  sh.getRange(row,1,1,2).setFontWeight('bold').setBackground('#fff3cd');
  row += tips.length + 2;

  row = insertAsciiFlowToReadme_(sh, row);

  h(row++, '9. ãƒˆãƒ¼ã‚¯ãƒ³æ–™é‡‘è¦‹ç©ï¼ˆå‚è€ƒãƒ»æš«å®šï¼‰');
  var rateRows = [['Platform/Model','å˜ä¾¡(combined, USD/Ktok)']];
  try {
    var ps = CONFIG.RATES.PLATFORMS;
    Object.keys(ps).forEach(function(pl){
      Object.keys(ps[pl].models).forEach(function(m){
        rateRows.push([pl + ' / ' + m, (ps[pl].models[m].combined || 0)]);
      });
    });
  } catch(_) {}
  sh.getRange(row,1,rateRows.length,2).setValues(rateRows);
  sh.getRange(row,1,1,2).setFontWeight('bold').setBackground('#e6f7e9');
  row += rateRows.length + 2;

  sh.setColumnWidths(1, 1, 900);
  sh.setColumnWidths(2, 1, 320);
  sh.setFrozenRows(1);
  sh.getRange(1,1,Math.max(2,row-1),2).setVerticalAlignment('top');
  sh.activate();
}

function openReadme() {
  createOrUpdateReadme_();
  SpreadsheetApp.getUi().alert('README ã‚’ä½œæˆ/æ›´æ–°ã—ã¾ã—ãŸã€‚');
}

function exportReadmeToPDF_() {
  var ss = SpreadsheetApp.getActive();
  var sh = ss.getSheetByName('README');
  if (!sh) {
    SpreadsheetApp.getUi().alert('README ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€ŒREADMEã‚’ä½œæˆ/æ›´æ–°ã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚');
    return;
  }

  try {
    sh.setPrintGridlines(false);
    sh.setHiddenGridlines(true);
    sh.setFrozenRows(1);
  } catch (e) {}

  var ui = SpreadsheetApp.getUi();
  var defaultName = 'README_' + Utilities.formatDate(new Date(), Session.getScriptTimeZone(), 'yyyyMMdd_HHmm');
  var resp = ui.prompt('PDFãƒ•ã‚¡ã‚¤ãƒ«åã‚’å…¥åŠ›', defaultName, ui.ButtonSet.OK_CANCEL);
  if (resp.getSelectedButton() !== ui.Button.OK) return;
  var fileName = (resp.getResponseText() || defaultName).replace(/\.[Pp][Dd][Ff]$/, '') + '.pdf';

  var url = ss.getUrl().replace(/edit$/, '') + 'export?' + [
    'format=pdf',
    'size=A4',
    'portrait=true',
    'fitw=true',
    'sheetnames=false',
    'printtitle=false',
    'pagenumbers=false',
    'gridlines=false',
    'fzr=false',
    'top_margin=0.5',
    'bottom_margin=0.5',
    'left_margin=0.5',
    'right_margin=0.5',
    'gid=' + sh.getSheetId()
  ].join('&');

  var token = ScriptApp.getOAuthToken();
  var res = UrlFetchApp.fetch(url, { headers: { Authorization: 'Bearer ' + token } , muteHttpExceptions:true });
  if (res.getResponseCode() !== 200) {
    ui.alert('PDFæ›¸ãå‡ºã—ã‚¨ãƒ©ãƒ¼', 'HTTP ' + res.getResponseCode() + '\n' + res.getContentText().slice(0,300), ui.ButtonSet.OK);
    return;
  }

  var blob = res.getBlob().setName(fileName);
  var file = DriveApp.createFile(blob);
  ui.alert('PDFã‚’æ›¸ãå‡ºã—ã¾ã—ãŸ', 'ãƒ•ã‚¡ã‚¤ãƒ«å: ' + file.getName() + '\nURL: ' + file.getUrl(), ui.ButtonSet.OK);
}

function insertAsciiFlowToReadme_(sh, startRow){
  function h(r,t){ sh.getRange(r,1).setValue(t).setFontWeight('bold'); }
  function p(r,t){ sh.getRange(r,1).setValue(t).setFontFamily('Courier New').setWrap(true); }
  var r = startRow;
  h(r++, '8. å›³è§£ï¼ˆå‡¦ç†ãƒ•ãƒ­ãƒ¼ã®ã–ã£ãã‚Šã‚¤ãƒ¡ãƒ¼ã‚¸ï¼‰');
  p(r++, [
    'å…¥åŠ›(J/K/I) â”€â”€â–¶ AIç”Ÿæˆ(M/N) â”€â”€â–¶ é€æ–™åˆ¤å®š(V/R) â”€â”€â–¶ ä¾¡æ ¼è¨ˆç®—(Q) â”€â”€â–¶ ä¿å­˜/ã‚¯ãƒªã‚¢',
    '                 â†‘                                    ',
    '               ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆ(GPT_Prompts) ã¨ è¨­å®š(Properties & å„ã‚»ãƒ«)'
  ].join('\n'));
  return r + 1;
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ä¾¡æ ¼è¨ˆç®—ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆA/Bï¼‰- åˆ©ç›Šé¡å¯¾å¿œç‰ˆ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function _getWorkSheetName_() {
  try {
    var props = PropertiesService.getScriptProperties();
    return props.getProperty('SHEET_NAME') || 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ';
  } catch (e) {
    return 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ';
  }
}

function getExchangeRateForPopup() {
  var name = _getWorkSheetName_();
  var sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(name);
  var v = sh ? Number(sh.getRange('C2').getValue()) : NaN;
  return (isNaN(v) || v <= 0) ? 145 : v;
}

function getPayoneerRateForPopup() {
  var name = _getWorkSheetName_();
  var sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(name);
  var v = sh ? Number(sh.getRange('Z2').getValue()) : NaN;
  return (!isNaN(v) && v >= 0 && v < 1) ? v : 0.02;
}

function getTariffRateForPopup() {
  var name = _getWorkSheetName_();
  var sh = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(name);
  var v = sh ? Number(sh.getRange('AD2').getValue()) : NaN;
  return (!isNaN(v) && v >= 0) ? v : 0;
}

function _volWeightFromDims_(length, width, height, actualWeight) {
  var L = Number(length)||0, W = Number(width)||0, H = Number(height)||0;
  if (L>0 && W>0 && H>0) return Math.max(200, Math.round((L*W*H)/5));
  return Number(actualWeight)||0;
}

function _resolveShippingJPY_(mode, args) {
  if (mode === 'manual') return Number(args.shippingYen)||0;

  var costYen = Number(args.costYen)||0;
  var w   = Number(args.weight)||0;
  var L   = Number(args.length)||0;
  var W   = Number(args.width)||0;
  var H   = Number(args.height)||0;
  var vol = _volWeightFromDims_(L,W,H,w);
  var sizeStr = (L>0&&W>0&&H>0) ? [L,W,H].join('x') : '';
  var method  = String(args.method||'è‡ªå‹•é¸æŠ');

  var yen = SHIPPING_COST(costYen, w, vol, method, sizeStr);
  if (Number(yen) >= 999000) throw new Error('é€æ–™è¨ˆç®—ã‚¨ãƒ©ãƒ¼/ãƒ¬ãƒ¼ãƒˆæœªå®šç¾©ï¼ˆShipping_Ratesã‚„å…¥åŠ›å€¤ã‚’ç¢ºèªï¼‰');
  return Number(yen)||0;
}

function calcPriceFromMargin(payload) {
  var ex   = getExchangeRateForPopup();
  var cost = Number(payload.costYen)||0;
  var ebay = (Number(payload.ebayFeePct)||18)/100;
  var ad   = (Number(payload.adFeePct)||5)/100;
  var payo = getPayoneerRateForPopup();
  var customsFee = Number(payload.customsFeeUSD)||10;
  var tariffRate = (Number(payload.tariffRatePct)||15)/100;
  var safetyFactor = Number(payload.safetyFactor)||1.35;
  
  var profitMode = payload.profitMode || 'rate';

  var shipping = _resolveShippingJPY_(payload.shippingMode, {
    shippingYen: payload.shippingYen,
    costYen: cost,
    weight: payload.weight,
    length: payload.length,
    width:  payload.width,
    height: payload.height,
    method: payload.method
  });

  var priceUSD, profitJPY;

  if (profitMode === 'amount') {
    // â˜…åˆ©ç›Šé¡ãƒ¢ãƒ¼ãƒ‰ï¼šæŒ‡å®šã•ã‚ŒãŸåˆ©ç›Šé¡ã‹ã‚‰è²©å£²ä¾¡æ ¼ã‚’é€†ç®—
    var targetProfitYen = Number(payload.profitAmountYen) || 0;
    
    // å¿…è¦ãªæ‰‹å–ã‚Š = ä»•å…¥ã‚Œ + é€æ–™ + åˆ©ç›Š
    var requiredNetJPY = cost + shipping + targetProfitYen;
    
    // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£
    var feeMultiplier = 1 - (ebay + ad + payo);
    if (feeMultiplier <= 0) throw new Error('æ‰‹æ•°æ–™ã®åˆè¨ˆãŒå¤§ãã™ãã¾ã™ã€‚');
    
    var revenueJPY = requiredNetJPY / feeMultiplier;
    priceUSD = revenueJPY / ex;
    profitJPY = targetProfitYen;
    
  } else {
    // â˜…åˆ©ç›Šç‡ãƒ¢ãƒ¼ãƒ‰ï¼šå¾“æ¥ã®è¨ˆç®—
    var prof = (Number(payload.profitRatePct)||0)/100;
    
    // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£
    var denom = 1 - (ebay + ad + payo + prof);
    if (denom <= 0) throw new Error('ç‡ã®åˆè¨ˆãŒå¤§ãã™ãã¾ã™ï¼ˆåˆ†æ¯<=0ï¼‰ã€‚æ‰‹æ•°æ–™/åˆ©ç›Šç‡ã‚’ä¸‹ã’ã¦ãã ã•ã„ã€‚');

    priceUSD = ((cost + shipping) / denom) / ex;
    
    // åç›Šè¨ˆç®—
    var revenueJPY = priceUSD * ex;
    
    // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£
    var netJPY = revenueJPY * (1 - (ebay + ad + payo));
    profitJPY = Math.round(netJPY - (cost + shipping));
  }

  // é–¢ç¨è¨ˆç®—ï¼šè²©å£²ä¾¡æ ¼ãƒ™ãƒ¼ã‚¹
  var baseAmount = priceUSD + customsFee;
  var tariffUSD = baseAmount * tariffRate * safetyFactor;
  var taxIncludedPriceUSD = priceUSD + tariffUSD;
  
  return {
    ok: true,
    exchange: ex,
    shippingYen: shipping,
    priceUSD: Number(priceUSD.toFixed(2)),
    taxIncludedPriceUSD: Number(taxIncludedPriceUSD.toFixed(2)),
    tariffUSD: Number(tariffUSD.toFixed(2)),
    profitYen: Math.round(profitJPY)
  };
}

function calcBreakEvenFromSelling(payload) {
  var ex   = getExchangeRateForPopup();
  var usd  = Number(payload.targetPriceUSD)||0;
  if (usd <= 0) throw new Error('è²©å£²ä¾¡æ ¼(USD)ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');

  var ebay = (Number(payload.ebayFeePct)||18)/100;
  var ad   = (Number(payload.adFeePct)||5)/100;
  var payo = getPayoneerRateForPopup();
  var customsFee = Number(payload.customsFeeUSD)||10;
  var tariffRate = (Number(payload.tariffRatePct)||15)/100;
  var safetyFactor = Number(payload.safetyFactor)||1.35;
  
  var profitMode = payload.profitMode || 'rate';

  var shipping = _resolveShippingJPY_(payload.shippingMode, {
    shippingYen: payload.shippingYen,
    costYen: 0,
    weight: payload.weight,
    length: payload.length,
    width:  payload.width,
    height: payload.height,
    method: payload.method || 'Small Packet'
  });

  // ç›®æ¨™è²©å£²ä¾¡æ ¼ã‹ã‚‰å•†å“æœ¬ä½“ä¾¡æ ¼ã‚’é€†ç®—
  var basePrice = (usd - customsFee) / (1 + tariffRate * safetyFactor);
  var tariffUSD = basePrice * tariffRate * safetyFactor;
  
  // å•†å“æœ¬ä½“ä¾¡æ ¼ã«å¯¾ã—ã¦æ‰‹æ•°æ–™ã‚’è¨ˆç®—
  var revenueJPY = basePrice * ex;
  
  // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£
  var takeJPY = revenueJPY * (1 - (ebay + ad + payo));
  
  var breakEvenJPY = Math.round(takeJPY - shipping);
  var maxCostForWant, wantDisplay;

  if (profitMode === 'amount') {
    // â˜…åˆ©ç›Šé¡ãƒ¢ãƒ¼ãƒ‰ï¼šæŒ‡å®šã•ã‚ŒãŸåˆ©ç›Šé¡ã‚’ç¢ºä¿ã§ãã‚‹æœ€å¤§ä»•å…¥å€¤
    var targetProfitYen = Number(payload.wantProfitAmountYen) || 0;
    maxCostForWant = Math.round(takeJPY - shipping - targetProfitYen);
    wantDisplay = 'Â¥' + targetProfitYen.toLocaleString() + 'åˆ©ç›Š';
    
  } else {
    // â˜…åˆ©ç›Šç‡ãƒ¢ãƒ¼ãƒ‰ï¼šå¾“æ¥ã®è¨ˆç®—
    var want = (Number(payload.wantProfitRatePct)||0)/100;
    maxCostForWant = Math.round((takeJPY * (1 - want)) - shipping);
    wantDisplay = Number((want*100).toFixed(2)) + '%';
  }

  return {
    ok: true,
    exchange: ex,
    shippingYen: shipping,
    basePriceUSD: Number(basePrice.toFixed(2)),
    tariffUSD: Number(tariffUSD.toFixed(2)),
    customsFeeUSD: customsFee,
    targetPriceUSD: usd,
    breakEvenJPY: breakEvenJPY,
    maxCostForWantJPY: maxCostForWant,
    wantRatePct: wantDisplay  // è¡¨ç¤ºç”¨ï¼ˆç‡ã¾ãŸã¯é¡ï¼‰
  };
}

function showPriceCalcA() {
  var html = HtmlService.createHtmlOutputFromFile('PriceCalcA')
    .setWidth(560).setHeight(780);
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ’² ä¾¡æ ¼è¨ˆç®—Aï¼šåˆ©ç›Šç‡â†’è²©å£²ä¾¡æ ¼');
}

function showPriceCalcB() {
  var html = HtmlService.createHtmlOutputFromFile('PriceCalcB')
    .setWidth(560).setHeight(780);
  SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ’² ä¾¡æ ¼è¨ˆç®—Bï¼šè²©å£²ä¾¡æ ¼â†’æç›Šåˆ†å²');
}

function addPriceCalcStandaloneMenu_() {
  try {
    var ui = SpreadsheetApp.getUi();
    ui.createMenu('ğŸ’² ä¾¡æ ¼è¨ˆç®—')
      .addItem('ä¾¡æ ¼è¨ˆç®—Aï¼ˆåˆ©ç›Šç‡â†’è²©å£²ä¾¡æ ¼ï¼‰', 'showPriceCalcA')
      .addItem('ä¾¡æ ¼è¨ˆç®—Bï¼ˆè²©å£²ä¾¡æ ¼â†’æç›Šåˆ†å²ï¼‰', 'showPriceCalcB')
      .addToUi();
  } catch (e) {
    // UIç„¡ã„ç’°å¢ƒã§ã¯ç„¡è¦–
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç°¡æ˜“ç‰ˆãƒ¡ãƒ‹ãƒ¥ãƒ¼
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function addSimpleModeMenu_() {
  try {
    SpreadsheetApp.getUi()
      .createMenu("âš¡ ç°¡æ˜“ç‰ˆ")
      .addItem("ã€€âœ…ç°¡æ˜“ç‰ˆï¼šé¸æŠè¡Œã‚’å®Ÿè¡Œã€€", "runSimpleSelected")
      .addSeparator()
      .addItem("ç°¡æ˜“ç‰ˆï¼šé¸æŠè¡Œã‚’ä¿å­˜ã—ã¦ã‚¯ãƒªã‚¢", "simpleSaveSelectedRowsAndClear")
      .addItem("ç°¡æ˜“ç‰ˆï¼šé¸æŠè¡Œã®ãƒ‡ãƒ¼ã‚¿ã®ã¿å‰Šé™¤", "simpleClearSelectedRowsOnly")
      .addSeparator()
      .addItem("ç°¡æ˜“ç‰ˆ åˆæœŸè¨­å®šï¼ˆAPIã‚­ãƒ¼ã®ã¿ï¼‰", "openSimpleSetup")
      .addToUi();
  } catch (e) {}
}

function getSimpleExecSettings_() {
  var apiKey = getSimpleApiKey_();
  if (!apiKey) throw new Error('ç°¡æ˜“ç‰ˆAPIã‚­ãƒ¼ãŒæœªè¨­å®šã§ã™ã€‚ã€Œâš¡ ç°¡æ˜“ç‰ˆâ†’ç°¡æ˜“ç‰ˆ åˆæœŸè¨­å®šã€ã§ä¿å­˜ã—ã¦ãã ã•ã„ã€‚');
  var sheetName = (PropertiesService.getScriptProperties().getProperty('SHEET_NAME')) || 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ';
  return {
    platform: 'openai',
    model: 'gpt-5-nano',
    apiKey: apiKey,
    sheetName: sheetName,
    promptId: 'EBAY_FULL_LISTING_PROMPT'
  };
}

function createAIPromptSimple_(fullText) {
  var tmpl = getPromptContent('EBAY_FULL_LISTING_PROMPT');
  if (!tmpl) {
    tmpl = [
      "You are a listing generator. Return ONLY JSON with keys:",
      "Title (string), Description (string), ProductName (string), Category (string).",
      "Input:\n${fullText}"
    ].join("\n");
  }
  
  // æ—¢å­˜ã®ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã«æ–°æ©Ÿèƒ½ã‚’å‹•çš„ã«è¿½åŠ 
  if (tmpl.indexOf('Condition') === -1 || tmpl.indexOf('EbayCategory') === -1) {
    var additionalInstructions = [
      "",
      "Additionally, also return these fields in the same JSON:",
      "- Condition (string): Product condition - MUST be exactly 'æ–°å“', 'ä¸­å¤', or 'ã‚¨ãƒ©ãƒ¼'",
      "  * 'æ–°å“': æ–°å“ã€æœªé–‹å°ã€æœªä½¿ç”¨ã€MINTã€NEWç­‰ã®å®Œå…¨æ–°å“è¡¨ç¾",
      "  * 'ä¸­å¤': ä¸­å¤ã€ä½¿ç”¨æ¸ˆã¿ã€é–‹å°æ¸ˆã¿ã€æ–°å“åŒæ§˜ã€ç¾å“ç­‰ï¼ˆæº–æ–°å“å«ã‚€ï¼‰",
      "  * 'ã‚¨ãƒ©ãƒ¼': å•†å“çŠ¶æ…‹æƒ…å ±ãŒä¸ååˆ†ã§åˆ¤å®šä¸å¯ã®å ´åˆã®ã¿",
      "- EbayCategory (string): Select the most appropriate category from:",
      "  Cell Phones & Smartphones, Video Games, Video Game Consoles, Cameras & Photo, Computer Components, Consumer Electronics, Audio Equipment, Clothing, Shoes, Handbags & Purses, Jewelry, Watches, Fashion Accessories, Home Decor, Kitchen & Dining, Garden & Outdoor, Tools & Hardware, Action Figures, Trading Cards, Model Kits, Other Toys, Sports Equipment, Outdoor Gear, Fitness Equipment, Books, Movies & TV, Music, Video Games Software, Skincare, Makeup, Health Supplements, Office Supplies, Industrial Equipment, Car Parts, Motorcycle Parts, String Instruments, Electronic Instruments, Other Instruments, Collectibles, Antiques, Art, Other"
    ].join("\n");
    
    // ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆã®æœ«å°¾ã«è¿½åŠ 
    tmpl = tmpl + additionalInstructions;
  }
  
  return tmpl.replace('${fullText}', fullText);
}

// ã€ä¿®æ­£ç‰ˆã€‘
function getSimpleProfitAndShipping_(costYen) {
  var profitAmount = 0;
  var fixedShipping = 0;
  
  try {
    // ä½œæ¥­ã‚·ãƒ¼ãƒˆã®H1ã¨J1ã‚’å„ªå…ˆçš„ã«ãƒã‚§ãƒƒã‚¯
    var sheetName = _getWorkSheetName_();
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(sheetName);
    
    if (sheet) {
      // H1ï¼ˆåˆ©ç›Šé¡ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
      var h1Value = sheet.getRange('H1').getValue();
      if (typeof h1Value === 'number' && !isNaN(h1Value) && h1Value > 0) {
        profitAmount = h1Value;
      } else {
        // H1ãŒæœªè¨­å®šã®å ´åˆã¯Profit_Amountsã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—
        profitAmount = getProfitAmountByCost(costYen) || 0;
      }
      
      // J1ï¼ˆé€æ–™ï¼‰ã‚’ãƒã‚§ãƒƒã‚¯
      var j1Value = sheet.getRange('J1').getValue();
      if (typeof j1Value === 'number' && !isNaN(j1Value) && j1Value > 0) {
        fixedShipping = j1Value;
      } else {
        // J1ãŒæœªè¨­å®šã®å ´åˆã¯Profit_Amountsã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—
        fixedShipping = getShippingCostByCost(costYen) || 0;
      }
    } else {
      // ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯Profit_Amountsã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—
      profitAmount = getProfitAmountByCost(costYen) || 0;
      fixedShipping = getShippingCostByCost(costYen) || 0;
    }
    
  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼æ™‚ã¯Profit_Amountsã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    profitAmount = getProfitAmountByCost(costYen) || 0;
    fixedShipping = getShippingCostByCost(costYen) || 0;
  }
  
  return { 
    profitAmount: profitAmount, 
    fixedShipping: fixedShipping 
  };
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ›´æ–°ç‰ˆï¼šç°¡æ˜“ç‰ˆã®ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/** ç°¡æ˜“ç‰ˆç”¨ã®Formulasè¨­å®šï¼ˆä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰ */
function setFormulasSimple_(sheet, row, profitAmount, fixedShipping) {
  var feeRate = sheet.getRange("F1").getValue() || 0;
  var adRate  = sheet.getRange("F2").getValue() || 0;

  sheet.getRange(row, CONFIG.COLUMNS.RATE).clearContent();
  sheet.getRange(row, CONFIG.COLUMNS.PROFIT).setValue(profitAmount);
  sheet.getRange(row, CONFIG.COLUMNS.SHIPPING).setValue(fixedShipping);
  sheet.getRange(row, CONFIG.COLUMNS.FEE).setValue(feeRate);

  // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£
  sheet.getRange(row, CONFIG.COLUMNS.PRICE).setFormula(
    '=ROUND(((I' + row + '+T' + row + '+U' + row + ')/(1-(V' + row + '+$F$2+$Z$2))/$C$2)*100)/100'
  );

  // â˜…â˜…â˜… ã“ã“ã‚’ä¿®æ­£ â˜…â˜…â˜…
  // æƒ³å®šé–¢ç¨ï¼ˆé€šé–¢æ‰‹æ•°æ–™è¾¼ã¿ï¼‰
  sheet.getRange(row, CONFIG.COLUMNS.ESTIMATED_TAX).setFormula(
    '=ROUND(R' + row + '*$AD$2*$AE$2+$AC$1,2)'
  );

  // é–¢ç¨è¾¼ã¿ä¾¡æ ¼ï¼ˆDDU + æƒ³å®šé–¢ç¨ã®ã¿ï¼‰
  sheet.getRange(row, CONFIG.COLUMNS.TAX_INCLUDED_PRICE).setFormula(
    '=ROUND(R' + row + '+AB' + row + ',2)'
  );
  // â˜…â˜…â˜… ä¿®æ­£ã“ã“ã¾ã§ â˜…â˜…â˜…

  setPriceCellHighlight(sheet, row);
  updateListingSheetPrice(row);
}


/** æ›´æ–°ç‰ˆï¼šç°¡æ˜“ç‰ˆ1è¡Œå‡¦ç†ï¼ˆä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰å¯¾å¿œï¼‰ */
function processRowSimple_(sheet, row, simple) {
  var jpTitle = sheet.getRange(row, CONFIG.COLUMNS.JP_TITLE).getValue();  // 10ï¼ˆå¤‰æ›´ãªã—ï¼‰
  var jpDesc  = sheet.getRange(row, CONFIG.COLUMNS.JP_DESC).getValue();   // 11ï¼ˆå¤‰æ›´ãªã—ï¼‰
  var cost    = Number(sheet.getRange(row, CONFIG.COLUMNS.COST_YEN).getValue());  // 9ï¼ˆå¤‰æ›´ãªã—ï¼‰
  if (!jpTitle || !jpDesc || !cost) return { success:false, skip:true, error:'å¿…è¦å…¥åŠ›ä¸è¶³' };

  var fullText = 'Japanese Title: ' + jpTitle + '\nJapanese Description: ' + jpDesc;
  var prompt = createAIPromptSimple_(fullText);
  var ai = callOpenAI(prompt, { apiKey: simple.apiKey, model: simple.model });
  var data = ai;

  var ps = getSimpleProfitAndShipping_(cost);
  var profitAmt = ps.profitAmount;
  var fixedShip = ps.fixedShipping;

  setCellValues(sheet, row, {
    weight: '',
    size: '',
    method: 'ï¼ˆç°¡æ˜“ç‰ˆï¼šå›ºå®šé€æ–™ï¼‰',
    title: data.title || '',
    description: data.description || '',
    condition: data.condition || '',           // 28â†’29
    ebayCategory: data.ebayCategory || ''      // 29â†’30
  });

  setFormulasSimple_(sheet, row, profitAmt, fixedShip);
  setHighlight(sheet, row, data.description || '');

  return {
    success: true,
    tokens_prompt: (data.usage && data.usage.prompt_tokens) || 0,
    tokens_completion: (data.usage && data.usage.completion_tokens) || 0,
    model_used: data.model_used || simple.model
  };
}

/** ç°¡æ˜“ç‰ˆç”¨ï¼šé¸æŠè¡Œå®Ÿè¡Œï¼ˆæ›´æ–°ç‰ˆï¼‰ */
function runSimpleSelected() {
  var start = new Date();
  var totals = { prompt:0, completion:0, ok:0, err:0 };

  try {
    var simple = getSimpleExecSettings_();
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(simple.sheetName);
    if (!sheet) { showAlert('ã‚·ãƒ¼ãƒˆã€Œ' + simple.sheetName + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error'); return; }

    var range = sheet.getActiveRange();
    if (!range) { showAlert('é¸æŠç¯„å›²ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'info'); return; }
    var s = Math.max(5, range.getRow());
    var e = range.getLastRow();
    var rows = [];
    for (var i=s;i<=e;i++) {
    var jpTitle = sheet.getRange(i, CONFIG.COLUMNS.JP_TITLE).getValue();  // 10ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var jpDesc  = sheet.getRange(i, CONFIG.COLUMNS.JP_DESC).getValue();   // 11ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var cost    = Number(sheet.getRange(i, CONFIG.COLUMNS.COST_YEN).getValue());  // 9ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var enTitle = sheet.getRange(i, CONFIG.COLUMNS.EN_TITLE).getValue();  // 13ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var enDesc  = sheet.getRange(i, CONFIG.COLUMNS.EN_DESC).getValue();   // 14ï¼ˆå¤‰æ›´ãªã—ï¼‰
    if (jpTitle && jpDesc && cost>0 && (!enTitle || !enDesc)) rows.push(i);
  }
    if (rows.length === 0) { showAlert('é¸æŠç¯„å›²ã«å‡¦ç†å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚', 'info'); return; }

    // ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’å–å¾—
    var priceMode = getPriceDisplayMode();
    var priceModeText = (priceMode === 'TAX_INCLUDED') ? 'é–¢ç¨è¾¼ã¿ä¾¡æ ¼' : 'è²©å£²ä¾¡æ ¼ï¼ˆé€šå¸¸ï¼‰';

    for (var k=0;k<rows.length;k++) {
      var r = processRowSimple_(sheet, rows[k], simple);
      if (r.success) {
        totals.ok++; totals.prompt += r.tokens_prompt; totals.completion += r.tokens_completion;
      } else {
        totals.err++;
      }
      Utilities.sleep(500);
    }

    var usd = calculateTokenCostUSD('openai', simple.model, totals.prompt, totals.completion);
    var rate = sheet.getRange("C2").getValue() || 145;
    showAlert(
      'âœ… ç°¡æ˜“ç‰ˆï¼ˆé¸æŠè¡Œï¼‰ï¼šå‡¦ç†å®Œäº†\n\n' +
      'å‡¦ç†ä»¶æ•°: ' + totals.ok + ' / ã‚¨ãƒ©ãƒ¼: ' + totals.err + '\n' +
      'ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰: ' + priceModeText + '\n' +
      'å…¥åŠ›tokens: ' + totals.prompt.toLocaleString() + ' / å‡ºåŠ›tokens: ' + totals.completion.toLocaleString() + '\n' +
      'æ¨å®šè²»ç”¨: $' + usd.toFixed(4) + 'ï¼ˆç´„' + Math.round(usd * rate) + 'å††, ' + simple.model + 'ï¼‰',
      'success'
    );
  } catch (e) {
    showAlert('ç°¡æ˜“ç‰ˆ é¸æŠè¡Œã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

function simpleSaveSelectedRowsAndClear() { saveSelectedRowsAndClear(); }
function simpleClearSelectedRowsOnly()    { clearSelectedRowsOnly(); }

function openSimpleSetup() {
  try {
    var tmpl;
    try {
      tmpl = HtmlService.createTemplateFromFile('SimpleSetup');
    } catch (_) {
      tmpl = null;
    }
    if (!tmpl) {
      var ui = SpreadsheetApp.getUi();
      var resp = ui.prompt('ç°¡æ˜“ç‰ˆ åˆæœŸè¨­å®š', 'OpenAI APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆä¿å­˜ã¯ãƒ¦ãƒ¼ã‚¶ãƒ¼ã”ã¨ï¼‰', ui.ButtonSet.OK_CANCEL);
      if (resp.getSelectedButton() !== ui.Button.OK) return;
      var key = (resp.getResponseText() || '').trim();
      if (!key) { showAlert('APIã‚­ãƒ¼ãŒç©ºã§ã™ã€‚', 'error'); return; }
      saveSimpleApiKey_(key);
      showAlert('âœ… ç°¡æ˜“ç‰ˆAPIã‚­ãƒ¼ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚', 'success');
      return;
    }
    tmpl.currentApiKey = getSimpleApiKey_() || '';
    var html = tmpl.evaluate().setWidth(420).setHeight(260);
    SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ”‘ ç°¡æ˜“ç‰ˆ åˆæœŸè¨­å®šï¼ˆAPIã‚­ãƒ¼ã®ã¿ï¼‰');
  } catch (e) {
    showAlert('ç°¡æ˜“ç‰ˆ åˆæœŸè¨­å®šã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
  }
}

function saveSimpleApiKey_(apiKey) {
  var up = PropertiesService.getUserProperties();
  if (!apiKey || !apiKey.trim()) throw new Error('APIã‚­ãƒ¼ãŒç©ºã§ã™ã€‚');
  up.setProperty('SIMPLE_OPENAI_API_KEY', apiKey.trim());
}

function getSimpleApiKey_() {
  return PropertiesService.getUserProperties().getProperty('SIMPLE_OPENAI_API_KEY') || '';
}

function saveSimpleSettings(apiKey) {
  try {
    saveSimpleApiKey_(apiKey);
    return { ok: true };
  } catch (e) {
    return { ok: false, error: e.message };
  }
}

function getSimpleSettings() {
  return {
    apiKey: getSimpleApiKey_(),
    platform: 'openai',
    model: 'gpt-5-nano',
    promptId: 'EBAY_FULL_LISTING_PROMPT'
  };
}

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç”Ÿæˆã®ãƒ‡ãƒãƒƒã‚°ãƒ†ã‚¹ãƒˆ
 */
function debugTemplateNameGeneration() {
  try {
    var testCases = [
      { name: 'ãƒˆãƒ¬ã‚«Graded', condition: 'æ–°å“', shipping: 'ã‚¨ã‚³ãƒãƒŸãƒ¼' },
      { name: 'ãƒˆãƒ¬ã‚«Graded', condition: 'ä¸­å¤', shipping: 'EX' },
      { name: 'ä¸€èˆ¬æ±ç”¨', condition: 'æ–°å“', shipping: 'ã‚¨ã‚³ãƒãƒŸãƒ¼' },
      { name: 'ã‚²ãƒ¼ãƒ ãƒ»æœ¬', condition: 'ä¸­å¤', shipping: 'EX' },
      { name: 'æ™‚è¨ˆ', condition: 'æ–°å“', shipping: 'EX' }
    ];
    
    var report = 'ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç”Ÿæˆãƒ†ã‚¹ãƒˆã€‘\n\n';
    
    for (var i = 0; i < testCases.length; i++) {
      var tc = testCases[i];
      var standardName = generateNewTemplateName(tc.name, tc.condition, tc.shipping);
      
      report += 'å…¥åŠ›: ' + tc.name + ' / ' + tc.condition + ' / ' + tc.shipping + '\n';
      report += 'å‡ºåŠ›: ' + standardName + '\n';
      
      // Policy_Masterã§æ¤œç´¢
      if (standardName) {
        var templateId = findTemplateId(standardName);
        report += 'çµæœ: ' + (templateId !== null ? 'ID=' + templateId : 'è¦‹ã¤ã‹ã‚‰ãªã„') + '\n';
      } else {
        report += 'çµæœ: ç”Ÿæˆå¤±æ•—\n';
      }
      report += '\n';
    }
    
    // Policy_Masterã«å®Ÿéš›ã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚‚è¡¨ç¤º
    report += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
    report += 'ã€Policy_Masterã®ç™»éŒ²å†…å®¹ã€‘\n\n';
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Policy_Master');
    if (sheet) {
      var data = sheet.getRange(1, 1, sheet.getLastRow(), 2).getValues();
      var inTemplateSection = false;
      var count = 0;
      
      for (var j = 0; j < data.length; j++) {
        if (String(data[j][0]).indexOf('ã€Templatesã€‘') !== -1) {
          inTemplateSection = true;
          continue;
        }
        if (String(data[j][0]).indexOf('ã€Shipping') !== -1) {
          break;
        }
        if (inTemplateSection && data[j][1]) {
          count++;
          report += 'ID ' + data[j][0] + ': ' + data[j][1] + '\n';
          if (count >= 10) {
            report += '... (æ®‹ã‚Šçœç•¥)\n';
            break;
          }
        }
      }
    }
    
    showAlert(report, 'info');
    
  } catch (e) {
    showAlert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * ä½œæ¥­ã‚·ãƒ¼ãƒˆã®æŒ‡å®šè¡Œã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤ã‚’è¨­å®šï¼ˆ4æ¬¡å…ƒå¯¾å¿œç‰ˆï¼‰
 * @param {Sheet} sheet - ä½œæ¥­ã‚·ãƒ¼ãƒˆ
 * @param {number} row - è¡Œç•ªå·
 */
function setTemplateToWorkSheet(sheet, row) {
  try {
    var maxRetries = 3;
    var retryDelay = 200;
    
    for (var attempt = 1; attempt <= maxRetries; attempt++) {
      var selectedCategory = getSavedCategory();
      if (!selectedCategory) {
        console.log('è¡Œ' + row + ': ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return false;
      }
      
      // âš ï¸ åˆ—å‚ç…§ã®ä¿®æ­£
      var priceUSD = Number(sheet.getRange(row, CONFIG.COLUMNS.PRICE).getValue());  // 17â†’18
      var condition = String(sheet.getRange(row, CONFIG.COLUMNS.CONDITION).getValue() || '').trim();  // 28â†’29
      var shippingMethod = String(sheet.getRange(row, CONFIG.COLUMNS.METHOD).getValue() || '').trim();  // 23â†’24
      var shippingType = convertShippingMethodToType(shippingMethod);
      
      console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šè©¦è¡Œ ' + attempt + '/3: è¡Œ' + row + ', ã‚«ãƒ†ã‚´ãƒª=' + selectedCategory + ', çŠ¶æ…‹=' + condition + ', é…é€=' + shippingType + ', ä¾¡æ ¼=' + priceUSD);
      
      if (isNaN(priceUSD) || priceUSD <= 0) {
        if (attempt < maxRetries) {
          console.log('è¡Œ' + row + ': ä¾¡æ ¼ãŒã¾ã è¨ˆç®—ä¸­ã§ã™ã€‚' + retryDelay + 'mså¾…æ©Ÿå¾Œã«å†è©¦è¡Œ...');
          Utilities.sleep(retryDelay);
          SpreadsheetApp.flush();
          continue;
        } else {
          console.log('è¡Œ' + row + ': ä¾¡æ ¼ãŒç„¡åŠ¹ã§ã™ (' + priceUSD + ')');
          sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');  // Eåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
          return false;
        }
      }
      
      if (!condition || !['æ–°å“', 'ä¸­å¤'].includes(condition)) {
        console.log('è¡Œ' + row + ': å•†å“çŠ¶æ…‹ãŒç„¡åŠ¹ã§ã™ (' + condition + ')');
        sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');  // Eåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
        return false;
      }
      
      if (shippingType === 'ã‚¨ãƒ©ãƒ¼') {
        console.log('è¡Œ' + row + ': é…é€æ–¹æ³•ãŒç„¡åŠ¹ã§ã™ (' + shippingMethod + ')');
        sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');  // Eåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
        return false;
      }

      var templateValue = getTemplateFromReferenceData4D(selectedCategory, condition, shippingType, priceUSD);
      
      if (templateValue !== null) {
        sheet.getRange(row, 5).setValue(templateValue);  // Eåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
        console.log('è¡Œ' + row + ': ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤ ' + templateValue + ' ã‚’è¨­å®šã—ã¾ã—ãŸï¼ˆè©¦è¡Œ' + attempt + 'å›ç›®ã§æˆåŠŸï¼‰');
        return true;
      } else {
        console.log('è¡Œ' + row + ': è©²å½“ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ');
        sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');  // Eåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
        return false;
      }
    }
    
    console.log('è¡Œ' + row + ': ' + maxRetries + 'å›è©¦è¡Œã—ã¾ã—ãŸãŒã€ä¾¡æ ¼ãŒç¢ºå®šã—ã¾ã›ã‚“ã§ã—ãŸ');
    sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');  // Eåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
    return false;

  } catch (error) {
    console.error('è¡Œ' + row + 'ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šã‚¨ãƒ©ãƒ¼: ' + error.message);
    sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');  // Eåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
    return false;
  }
}

/**
 * å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã®å†…å®¹ã‚’ãƒ‡ãƒãƒƒã‚°ç¢ºèª
 */
function debugReferenceDataSheet() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var refSheet = ss.getSheetByName('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    if (!refSheet) {
      showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    var lastRow = refSheet.getLastRow();
    if (lastRow < 2) {
      showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
      return;
    }

    var report = 'å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆå†…å®¹ç¢ºèª:\n\n';
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
    var headers = [];
    for (var col = 10; col <= 16; col++) { // Jåˆ—ã‹ã‚‰Påˆ—
      headers.push(refSheet.getRange(1, col).getValue());
    }
    report += 'ãƒ˜ãƒƒãƒ€ãƒ¼: ' + headers.join(' | ') + '\n\n';
    
    // ãƒ‡ãƒ¼ã‚¿ç¢ºèªï¼ˆæœ€å¤§10è¡Œã¾ã§è¡¨ç¤ºï¼‰
    var maxDisplay = Math.min(lastRow, 11); // 2-11è¡Œç›®ï¼ˆæœ€å¤§10è¡Œï¼‰
    for (var row = 2; row <= maxDisplay; row++) {
      var rowData = [];
      for (var col = 10; col <= 16; col++) { // Jåˆ—ã‹ã‚‰Påˆ—
        rowData.push(refSheet.getRange(row, col).getValue());
      }
      report += 'è¡Œ' + row + ': ' + rowData.join(' | ') + '\n';
    }
    
    if (lastRow > 11) {
      report += '\n... (æ®‹ã‚Š' + (lastRow - 11) + 'è¡Œ)\n';
    }
    
    // ã€Œãã®ä»–ã€ã€Œæ–°å“ã€ã®çµ„ã¿åˆã‚ã›ã‚’æ¤œç´¢
    report += '\nã€ãã®ä»–ï¼‹æ–°å“ã®çµ„ã¿åˆã‚ã›æ¤œç´¢ã€‘\n';
    var found = false;
    for (var row = 2; row <= lastRow; row++) {
      var category = String(refSheet.getRange(row, 12).getValue() || '').trim(); // Låˆ—
      var condition = String(refSheet.getRange(row, 13).getValue() || '').trim(); // Måˆ—
      var shipping = String(refSheet.getRange(row, 14).getValue() || '').trim();  // Nåˆ—
      
      if (category === 'ãã®ä»–' && condition === 'æ–°å“') {
        var templateId = refSheet.getRange(row, 10).getValue(); // Jåˆ—
        var minPrice = refSheet.getRange(row, 15).getValue();   // Oåˆ—
        var maxPrice = refSheet.getRange(row, 16).getValue();   // Påˆ—
        report += 'è¡Œ' + row + ': ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + templateId + ', é…é€=' + shipping + ', ä¾¡æ ¼=' + minPrice + '-' + maxPrice + '\n';
        found = true;
      }
    }
    
    if (!found) {
      report += 'ã€Œãã®ä»–ã€ã€Œæ–°å“ã€ã®çµ„ã¿åˆã‚ã›ã¯è¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n';
    }
    
    showAlert(report, 'info');
    
  } catch (error) {
    showAlert('ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã®åŸºæœ¬æ§‹é€ ã‚’ä½œæˆï¼ˆã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ä»˜ãï¼‰
 */
function createReferenceDataSample() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var refSheet = ss.getSheetByName('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    
    if (!refSheet) {
      refSheet = ss.insertSheet('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    } else {
      // æ—¢å­˜ã‚·ãƒ¼ãƒˆã‚’ã‚¯ãƒªã‚¢
      refSheet.clear();
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®šï¼ˆAåˆ—ã‹ã‚‰Råˆ—ã¾ã§ï¼‰
    var headers = [
      '', '', '', '', '', '', '', '', '', 
      'æ–°å“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'æ–°å“èª¬æ˜', 'æ–°å“æœ€ä½ä¾¡æ ¼', 'æ–°å“æœ€é«˜ä¾¡æ ¼', 
      '', 'ä¸­å¤ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 'ä¸­å¤èª¬æ˜', 'ä¸­å¤æœ€ä½ä¾¡æ ¼', 'ä¸­å¤æœ€é«˜ä¾¡æ ¼'
    ];
    
    refSheet.getRange(1, 1, 1, headers.length).setValues([headers]);
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ã®æ›¸å¼è¨­å®š
    refSheet.getRange(1, 10, 1, 4).setFontWeight('bold').setBackground('#c6efce'); // æ–°å“éƒ¨åˆ†ï¼ˆç·‘ï¼‰
    refSheet.getRange(1, 15, 1, 4).setFontWeight('bold').setBackground('#fce4d6'); // ä¸­å¤éƒ¨åˆ†ï¼ˆã‚ªãƒ¬ãƒ³ã‚¸ï¼‰
    
    // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ãªãŸã®ä¾‹ã«åˆã‚ã›ã¦è¨­å®šï¼‰
    var sampleData = [
      ['', '', '', '', '', '', '', '', '', 
       1, 'ä½ä¾¡æ ¼æ–°å“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 0, 20, 
       '', 288, 'ä½ä¾¡æ ¼ä¸­å¤ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 40.01, 50],
      ['', '', '', '', '', '', '', '', '', 
       2, 'ä¸­ä¾¡æ ¼æ–°å“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 20.01, 50, 
       '', 289, 'ä¸­ä¾¡æ ¼ä¸­å¤ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 50.01, 80],
      ['', '', '', '', '', '', '', '', '', 
       3, 'é«˜ä¾¡æ ¼æ–°å“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 50.01, 100, 
       '', 290, 'é«˜ä¾¡æ ¼ä¸­å¤ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ', 80.01, 120]
    ];
    
    refSheet.getRange(2, 1, sampleData.length, headers.length).setValues(sampleData);
    
    // åˆ—å¹…èª¿æ•´
    refSheet.setColumnWidth(10, 130); // Jåˆ—ï¼ˆæ–°å“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
    refSheet.setColumnWidth(11, 150); // Kåˆ—ï¼ˆæ–°å“èª¬æ˜ï¼‰
    refSheet.setColumnWidth(12, 100); // Låˆ—ï¼ˆæ–°å“æœ€ä½ä¾¡æ ¼ï¼‰
    refSheet.setColumnWidth(13, 100); // Måˆ—ï¼ˆæ–°å“æœ€é«˜ä¾¡æ ¼ï¼‰
    refSheet.setColumnWidth(15, 130); // Oåˆ—ï¼ˆä¸­å¤ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
    refSheet.setColumnWidth(16, 150); // Påˆ—ï¼ˆä¸­å¤èª¬æ˜ï¼‰
    refSheet.setColumnWidth(17, 100); // Qåˆ—ï¼ˆä¸­å¤æœ€ä½ä¾¡æ ¼ï¼‰
    refSheet.setColumnWidth(18, 100); // Råˆ—ï¼ˆä¸­å¤æœ€é«˜ä¾¡æ ¼ï¼‰
    
    // èª¬æ˜ç”¨ã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
    refSheet.getRange('J1').setNote('æ–°å“å•†å“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›');
    refSheet.getRange('L1').setNote('æ–°å“ä¾¡æ ¼ã®æœ€ä½å€¤ï¼ˆUSDï¼‰');
    refSheet.getRange('M1').setNote('æ–°å“ä¾¡æ ¼ã®æœ€é«˜å€¤ï¼ˆUSDï¼‰');
    refSheet.getRange('O1').setNote('ä¸­å¤å•†å“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç•ªå·ã‚’å…¥åŠ›');
    refSheet.getRange('Q1').setNote('ä¸­å¤ä¾¡æ ¼ã®æœ€ä½å€¤ï¼ˆUSDï¼‰');
    refSheet.getRange('R1').setNote('ä¸­å¤ä¾¡æ ¼ã®æœ€é«˜å€¤ï¼ˆUSDï¼‰');
    
    showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸã€‚\n\nã€æ§‹é€ èª¬æ˜ã€‘\nJåˆ—: æ–°å“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤\nL-Måˆ—: æ–°å“ä¾¡æ ¼ç¯„å›²ï¼ˆUSDï¼‰\nOåˆ—: ä¸­å¤ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤\nQ-Råˆ—: ä¸­å¤ä¾¡æ ¼ç¯„å›²ï¼ˆUSDï¼‰\n\nä½œæˆä¾‹ï¼š\nãƒ»æ–°å“20ãƒ‰ãƒ« â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ1\nãƒ»ä¸­å¤50ãƒ‰ãƒ« â†’ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ288', 'success');
    
    // å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º
    ss.setActiveSheet(refSheet);
    
  } catch (error) {
    showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}


/**
 * ä½œæ¥­ã‚·ãƒ¼ãƒˆå…¨ä½“ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤ã‚’ä¸€æ‹¬æ›´æ–°
 */
function updateAllTemplates() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;

    var lastRow = sheet.getLastRow();
    if (lastRow < 5) {
      showAlert('å‡¦ç†å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ï¼ˆ5è¡Œç›®ä»¥é™ï¼‰ã€‚', 'info');
      return;
    }

    var ui = SpreadsheetApp.getUi();
    var ok = ui.alert('å…¨è¡Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ç¢ºèª',
      'ä½œæ¥­ã‚·ãƒ¼ãƒˆã€Œ' + settings.sheetName + 'ã€ã®5è¡Œç›®ä»¥é™ã®å…¨ãƒ‡ãƒ¼ã‚¿ã«å¯¾ã—ã¦ã€\n' +
      'ä¾¡æ ¼ï¼ˆQåˆ—ï¼‰ã¨å•†å“çŠ¶æ…‹ï¼ˆABåˆ—ï¼‰ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤ï¼ˆEåˆ—ï¼‰ã‚’è¨­å®šã—ã¾ã™ã€‚\n\n' +
      'æ—¢å­˜ã®Eåˆ—ã®å€¤ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚ç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
      ui.ButtonSet.YES_NO);
    
    if (ok !== ui.Button.YES) {
      showAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 'info');
      return;
    }

    var updatedCount = 0;
    var errorCount = 0;
    var skippedCount = 0;

    for (var row = 5; row <= lastRow; row++) {
      try {
        // ä¾¡æ ¼ã¨å•†å“çŠ¶æ…‹ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        var priceUSD = Number(sheet.getRange(row, CONFIG.COLUMNS.PRICE).getValue());
        var condition = String(sheet.getRange(row, CONFIG.COLUMNS.CONDITION).getValue() || '').trim();
        
        if (isNaN(priceUSD) || priceUSD <= 0) {
          skippedCount++;
          continue;
        }
        
        if (!condition || !['æ–°å“', 'ä¸­å¤'].includes(condition)) {
          skippedCount++;
          continue;
        }

        if (setTemplateToWorkSheet(sheet, row)) {
          updatedCount++;
        } else {
          errorCount++;
        }
      } catch (e) {
        console.error('è¡Œ' + row + 'ã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + e.message);
        errorCount++;
      }
    }

    var report = 'å…¨è¡Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°å®Œäº†:\n\n' +
      'å¯¾è±¡ã‚·ãƒ¼ãƒˆ: ã€Œ' + settings.sheetName + 'ã€\n' +
      'å‡¦ç†ç¯„å›²: 5ï½' + lastRow + 'è¡Œ\n' +
      'æ›´æ–°æˆåŠŸ: ' + updatedCount + 'è¡Œ\n' +
      'æ›´æ–°å¤±æ•—: ' + errorCount + 'è¡Œ\n' +
      'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'è¡Œ\n\n' +
      'ã‚¹ã‚­ãƒƒãƒ—ç†ç”±: ä¾¡æ ¼æœªå…¥åŠ›ãƒ»å•†å“çŠ¶æ…‹æœªå…¥åŠ›ãƒ»è©²å½“ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæœªç™ºè¦‹';

    showAlert(report, updatedCount > 0 ? 'success' : 'warning');

  } catch (error) {
    showAlert('å…¨è¡Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * ä¾¡æ ¼è¨ˆç®—å¼ã®ãƒ‡ãƒãƒƒã‚°æ©Ÿèƒ½
 */
function debugPriceCalculation() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;
    
    var testRow = 5;
    
    // âš ï¸ å„ã‚»ãƒ«ã®å€¤ã‚’å–å¾—ï¼ˆåˆ—ç•ªå·å¤‰æ›´ï¼‰
    var costYen = Number(sheet.getRange(testRow, CONFIG.COLUMNS.COST_YEN).getValue()) || 0;  // 9ï¼ˆå¤‰æ›´ãªã—ï¼‰
    var shipping = Number(sheet.getRange(testRow, CONFIG.COLUMNS.SHIPPING).getValue()) || 0;  // 19â†’20
    var feeRate = Number(sheet.getRange("F1").getValue()) || 0;  // å¤‰æ›´ãªã—
    var adRate = Number(sheet.getRange("F2").getValue()) || 0;  // å¤‰æ›´ãªã—
    var profitRate = Number(sheet.getRange(testRow, CONFIG.COLUMNS.RATE).getValue()) || 0;  // 22â†’23
    var payoneerRate = Number(sheet.getRange("V2").getValue()) || 0.02;  // U2â†’V2
    var exchangeRate = Number(sheet.getRange("C2").getValue()) || 145;  // å¤‰æ›´ãªã—
    var currentPrice = Number(sheet.getRange(testRow, CONFIG.COLUMNS.PRICE).getValue()) || 0;  // 17â†’18
    
    // ç¾åœ¨ã®æ•°å¼ã‚’å–å¾—
    var priceFormula = sheet.getRange(testRow, CONFIG.COLUMNS.PRICE).getFormula();  // 17â†’18
    
    // æ‰‹å‹•è¨ˆç®—ï¼ˆVATé™¤å»å¾Œã®è¨ˆç®—å¼ï¼‰
    var numerator = costYen + shipping;
    var denominator = (1 - feeRate) * (1 - profitRate) * (1 - adRate) * (1 - payoneerRate);
    var calculatedPrice = numerator / denominator / exchangeRate;
    
    var report = 'ä¾¡æ ¼è¨ˆç®—ãƒ‡ãƒãƒƒã‚°æƒ…å ±:\n\n' +
      'ã€å…¥åŠ›å€¤ã€‘\n' +
      'ä»•å…¥ã‚Œå€¤(Iåˆ—): Â¥' + costYen.toLocaleString() + '\n' +
      'é€æ–™(Såˆ—): Â¥' + shipping.toLocaleString() + '\n' +
      'æ‰‹æ•°æ–™ç‡(F1): ' + (feeRate * 100).toFixed(1) + '%\n' +
      'åºƒå‘Šè²»ç‡(F2): ' + (adRate * 100).toFixed(1) + '%\n' +
      'åˆ©ç›Šç‡(Våˆ—): ' + (profitRate * 100).toFixed(1) + '%\n' +
      'ãƒšã‚¤ã‚ªãƒ‹ã‚¢ç‡(Y2): ' + (payoneerRate * 100).toFixed(1) + '%\n' +
      'ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ(C2): Â¥' + exchangeRate + '\n\n' +
      
      'ã€è¨ˆç®—éç¨‹ã€‘\n' +
      'åˆ†å­: Â¥' + numerator.toLocaleString() + ' (ä»•å…¥ã‚Œå€¤+é€æ–™)\n' +
      'åˆ†æ¯: ' + denominator.toFixed(4) + ' (æ‰‹æ•°æ–™ãƒ»åˆ©ç›Šç‡ç­‰ã‚’è€ƒæ…®)\n' +
      'è¨ˆç®—çµæœ: $' + calculatedPrice.toFixed(2) + '\n\n' +
      
      'ã€çµæœã€‘\n' +
      'ç¾åœ¨ã®ã‚·ãƒ¼ãƒˆå€¤: $' + currentPrice + '\n' +
      'æ‰‹å‹•è¨ˆç®—å€¤: $' + calculatedPrice.toFixed(2) + '\n' +
      'å·®ç•°: $' + (currentPrice - calculatedPrice).toFixed(2) + '\n\n' +
      
      'ã€ä½¿ç”¨ä¸­ã®æ•°å¼ã€‘\n' + priceFormula;
    
    showAlert(report, 'info');
    
  } catch (error) {
    showAlert('ä¾¡æ ¼è¨ˆç®—ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

function fixPriceFormula() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;
    
    var testRow = 5;
    
    var currentFormula = sheet.getRange(testRow, CONFIG.COLUMNS.PRICE).getFormula();  // 17â†’18
    
    // âœ… åˆç®—æ–¹å¼ã«ä¿®æ­£
    var newFormula = '=ROUND(((I' + testRow + '+T' + testRow + ')/(1-(V' + testRow + '+W' + testRow + '+$F$2+$Z$2))/$C$2)*100)/100';
    // Iåˆ—: å¤‰æ›´ãªã—
    // Sâ†’Tï¼ˆé€æ–™ï¼‰
    // Uâ†’Vï¼ˆæ‰‹æ•°æ–™ç‡ï¼‰
    // Vâ†’Wï¼ˆåˆ©ç›Šç‡ï¼‰
    // Y2â†’Z2ï¼ˆPayoneerç‡ï¼‰
    
    var report = 'ä¾¡æ ¼è¨ˆç®—å¼ã®æ¯”è¼ƒ:\n\n' +
      'ã€ç¾åœ¨ã®å¼ã€‘\n' + currentFormula + '\n\n' +
      'ã€ä¿®æ­£æ¡ˆï¼ˆåˆç®—æ–¹å¼ï¼‰ã€‘\n' + newFormula + '\n\n' +
      'ä¿®æ­£ç‚¹:\n' +
      '- é †æ¬¡æ§é™¤æ–¹å¼ â†’ åˆç®—æ–¹å¼ã«å¤‰æ›´\n' +
      '- ã™ã¹ã¦ã®ç‡ã‚’è²©å£²é¡ã«å¯¾ã™ã‚‹ç‡ã¨ã—ã¦è¨ˆç®—\n' +
      '- è¨ˆç®—å¼: (åŸä¾¡+é€æ–™) Ã· (1-(æ‰‹æ•°æ–™ç‡+åˆ©ç›Šç‡+åºƒå‘Šç‡+Payoneerç‡))\n\n' +
      'ä¿®æ­£ç‰ˆã‚’é©ç”¨ã—ã¾ã™ã‹ï¼Ÿ';
    
    var ui = SpreadsheetApp.getUi();
    var response = ui.alert('ä¾¡æ ¼è¨ˆç®—å¼ã®ä¿®æ­£', report, ui.ButtonSet.YES_NO);
    
    if (response === ui.Button.YES) {
      sheet.getRange(testRow, CONFIG.COLUMNS.PRICE).setFormula(newFormula);  // 17â†’18
      showAlert('ä¿®æ­£ç‰ˆã®æ•°å¼ã‚’é©ç”¨ã—ã¾ã—ãŸã€‚çµæœã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
    }
    
  } catch (error) {
    showAlert('ä¾¡æ ¼è¨ˆç®—å¼ä¿®æ­£ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}


/**
 * è¨­å®šä¿å­˜ã®ãƒ†ã‚¹ãƒˆï¼ˆeLogisticsé¸æŠã‚’ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ãƒˆï¼‰
 */
function testElogisticsSaveSettings() {
  try {
    // ç¾åœ¨ã®è¨­å®šã‚’ä¿å­˜
    var props = PropertiesService.getScriptProperties();
    var backup = {
      highPrice: props.getProperty('HIGH_PRICE_SHIPPING_METHOD'),
      threshold: props.getProperty('SHIPPING_THRESHOLD')
    };

    // ãƒ†ã‚¹ãƒˆç”¨ã®formDataã‚’ä½œæˆ
    var testFormData = {
      platform: 'openai',
      apiKey: 'test-key-' + Math.random(),
      model: 'gpt-4o-mini',
      sheetName: 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ',
      profitMethod: 'RATE',
      promptId: 'EBAY_FULL_LISTING_PROMPT',
      shippingThreshold: '20000',
      shippingCalcMethod: 'TABLE',
      lowPriceMethod: 'SP',
      highPriceMethod: 'EL' // â† eLogisticsã‚’ãƒ†ã‚¹ãƒˆ
    };

    // saveSettingsé–¢æ•°ã‚’å‘¼ã³å‡ºã—
    var result = saveSettings(testFormData);

    // çµæœç¢ºèª
    var savedHighPrice = props.getProperty('HIGH_PRICE_SHIPPING_METHOD');
    
    var report = 'saveSettings ãƒ†ã‚¹ãƒˆçµæœ:\n\n' +
      'å®Ÿè¡Œçµæœ: ' + (result.success ? 'âœ… æˆåŠŸ' : 'âŒ å¤±æ•—') + '\n' +
      'ä¿å­˜ã•ã‚ŒãŸé«˜ä¾¡æ ¼é…é€æ–¹æ³•: ' + savedHighPrice + '\n';

    if (result.success && savedHighPrice === 'EL') {
      report += '\nâœ… eLogisticsã®ä¿å­˜å‡¦ç†ã¯æ­£å¸¸ã§ã™ã€‚';
    } else {
      report += '\nâŒ ä¿å­˜å‡¦ç†ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚';
      if (!result.success) {
        report += '\nã‚¨ãƒ©ãƒ¼: ' + result.error;
      }
    }

    // å…ƒã®è¨­å®šã«å¾©å…ƒ
    if (backup.highPrice) {
      props.setProperty('HIGH_PRICE_SHIPPING_METHOD', backup.highPrice);
    } else {
      props.deleteProperty('HIGH_PRICE_SHIPPING_METHOD');
    }
    if (backup.threshold) {
      props.setProperty('SHIPPING_THRESHOLD', backup.threshold);
    }

    showAlert(report, result.success ? 'success' : 'error');

  } catch (e) {
    showAlert('saveSettingsãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}


// é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ã®é‡é‡å¸¯ã‚’ä¿®æ­£ã™ã‚‹é–¢æ•°
function fixShippingTableWeightRanges() {
  try {
    var ui = SpreadsheetApp.getUi();
    var response = ui.alert(
      'é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«é‡é‡å¸¯ä¿®æ­£',
      'é‡é‡å¸¯ã®ç¯„å›²ã‚’æ­£ã—ã„å€¤ã«ä¿®æ­£ã—ã¾ã™ã€‚\næ—¢å­˜ã®é‡é‡ç¯„å›²ï¼ˆA/Båˆ—ï¼‰ã®ã¿ã‚’ä¿®æ­£ã—ã€æ–™é‡‘ãƒ‡ãƒ¼ã‚¿ã¯ä¿æŒã—ã¾ã™ã€‚\nç¶šè¡Œã—ã¾ã™ã‹ï¼Ÿ',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) return;
    
    var ratesSheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Shipping_Rates');
    if (!ratesSheet) {
      showAlert('Shipping_Ratesã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
    
    // æ­£ã—ã„é‡é‡å¸¯ãƒ‡ãƒ¼ã‚¿
    var correctRanges = [
      [1, 100], [101, 200], [201, 300], [301, 400], [401, 500],
      [501, 600], [601, 700], [701, 800], [801, 900], [901, 1000],
      [1001, 1100], [1101, 1200], [1201, 1300], [1301, 1400], [1401, 1500],
      [1501, 1600], [1601, 1700], [1701, 1800], [1801, 1900], [1901, 2000],
      [2001, 2500], [2501, 3000], [3001, 3500], [3501, 4000], [4001, 4500],
      [4501, 5000], [5001, 6000], [6001, 7000], [7001, 8000], [8001, 9000],
      [9001, 10000], [10001, 15000], [15001, 20000], [20001, 30000]
    ];
    
    // A/Båˆ—ã®ã¿ã‚’ä¿®æ­£
    for (var i = 0; i < correctRanges.length; i++) {
      var row = i + 3; // 3è¡Œç›®ã‹ã‚‰é–‹å§‹
      ratesSheet.getRange(row, 1).setValue(correctRanges[i][0]); // Aåˆ—
      ratesSheet.getRange(row, 2).setValue(correctRanges[i][1]); // Båˆ—
    }
    
    showAlert('é‡é‡å¸¯ã®ä¿®æ­£ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\nã€Œé€æ–™ãƒ†ãƒ¼ãƒ–ãƒ« ãƒ‡ãƒãƒƒã‚°ã€ã§ç¢ºèªã—ã¦ãã ã•ã„ã€‚', 'success');
    
  } catch (error) {
    showAlert('ä¿®æ­£ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Q1/Q2ã‚»ãƒ«ç”¨ é€æ–™è¨ˆç®—æ©Ÿèƒ½
  - Q1: é…é€æ–¹æ³•é¸æŠãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³
  - Q2: é¸æŠã•ã‚ŒãŸæ–¹æ³•ã§ã®é€æ–™è¨ˆç®—çµæœè¡¨ç¤º
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * Q1/Q2ã‚»ãƒ«ã®é€æ–™è¨ˆç®—æ©Ÿèƒ½ã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 */
function setupShippingCalculatorCells() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆã€Œ' + settings.sheetName + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }

    // âš ï¸ Q1â†’R1, Q2â†’R2ã«å¤‰æ›´
    setupShippingMethodDropdown(sheet);
    setupShippingCalculationFormula(sheet);
    formatShippingCalculatorCells(sheet);
    
    showAlert('âœ… é€æ–™è¨ˆç®—æ©Ÿèƒ½ã‚’è¨­å®šã—ã¾ã—ãŸã€‚\n\nR1: é…é€æ–¹æ³•ã‚’é¸æŠ\nR2: é¸æŠæ–¹æ³•ã§ã®é€æ–™ã‚’è‡ªå‹•è¨ˆç®—\n\né‡é‡(J2)ã¨ã‚µã‚¤ã‚º(L2:N2)ã®å…¥åŠ›ã‚‚å¿…è¦ã§ã™ã€‚', 'success');
    
  } catch (e) {
    showAlert('é€æ–™è¨ˆç®—æ©Ÿèƒ½ã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * Q1ã‚»ãƒ«ã«é…é€æ–¹æ³•ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã‚’è¨­å®š
 */
function setupShippingMethodDropdown(sheet) {
  var shippingOptions = [
    'è‡ªå‹•é¸æŠ',
    'Small Packet',
    'Cpass-Economy', 
    'Cpass-FedEx',
    'Cpass-DHL',
    'eLogistics',
    'EMS'
  ];
  
  var r1Cell = sheet.getRange('R1');  // Q1â†’R1
  r1Cell.clearDataValidations();
  
  var validation = SpreadsheetApp.newDataValidation()
    .requireValueInList(shippingOptions, true)
    .setAllowInvalid(false)
    .setHelpText('é€æ–™è¨ˆç®—ã«ä½¿ç”¨ã™ã‚‹é…é€æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„')
    .build();
    
  r1Cell.setDataValidation(validation);
  
  if (!r1Cell.getValue()) {
    r1Cell.setValue('è‡ªå‹•é¸æŠ');
  }
}

/**
 * Q2ã‚»ãƒ«ã«é€æ–™è¨ˆç®—æ•°å¼ã‚’è¨­å®š
 */
function setupShippingCalculationFormula(sheet) {
  var r2Cell = sheet.getRange('R2');  // Q2â†’R2
  var formula = '=IF(OR(ISBLANK(J2),ISBLANK(L2),ISBLANK(M2),ISBLANK(N2)),"é‡é‡ãƒ»ã‚µã‚¤ã‚ºã‚’å…¥åŠ›",SHIPPING_COST_FOR_CALCULATOR(J2,L2,M2,N2,R1,IFERROR(I2,10000)))';
  r2Cell.setFormula(formula);
}

/**
 * Q1/Q2ã‚»ãƒ«ã®è¡¨ç¤ºå½¢å¼ã‚’è¨­å®š
 */
function formatShippingCalculatorCells(sheet) {
  // âš ï¸ Q1â†’R1, Q2â†’R2
  var r1Cell = sheet.getRange('R1');  // Q1â†’R1
  r1Cell.setFontWeight('bold');
  r1Cell.setHorizontalAlignment('center');
  r1Cell.setBackground('#e1f5fe');
  
  var r2Cell = sheet.getRange('R2');  // Q2â†’R2
  r2Cell.setFontWeight('bold');
  r2Cell.setHorizontalAlignment('right');
  r2Cell.setBackground('#f3e5f5');
  
  // âš ï¸ ãƒ©ãƒ™ãƒ«ä½ç½®ã‚‚å¤‰æ›´ï¼šP1â†’Q1, P2â†’Q2
  sheet.getRange('Q1').setValue('é…é€æ–¹æ³•:').setFontWeight('bold').setHorizontalAlignment('right');  // P1â†’Q1
  sheet.getRange('Q2').setValue('é€æ–™(å††):').setFontWeight('bold').setHorizontalAlignment('right');  // P2â†’Q2
}

/**
 * é€æ–™è¨ˆç®—å°‚ç”¨ã®UDFé–¢æ•°ï¼ˆQ2ã‚»ãƒ«ç”¨ï¼‰
 */
function SHIPPING_COST_FOR_CALCULATOR(weight, length, width, height, method, costYen) {
  try {
    var w = Number(weight);
    var l = Number(length);
    var wi = Number(width);  
    var h = Number(height);
    var cost = Number(costYen) || 10000;
    
    if (isNaN(w) || isNaN(l) || isNaN(wi) || isNaN(h) || w <= 0 || l <= 0 || wi <= 0 || h <= 0) {
      return "å…¥åŠ›å€¤ã‚¨ãƒ©ãƒ¼";
    }
    
    var volumetricWeight = Math.max(200, Math.round((l * wi * h) / 5));
    var sizeString = l + 'x' + wi + 'x' + h;
    var selectedMethod = String(method || 'è‡ªå‹•é¸æŠ');
    
    if (selectedMethod === 'è‡ªå‹•é¸æŠ' || selectedMethod === '') {
      return selectCheapestShippingRateWithConstraints(cost, w, volumetricWeight, sizeString);
    } else {
      return calculateSpecificMethodRate(selectedMethod, w, volumetricWeight);
    }
    
  } catch (error) {
    return "è¨ˆç®—ã‚¨ãƒ©ãƒ¼";
  }
}

/**
 * é€æ–™è¨ˆç®—æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
 */
function testShippingCalculator() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }
    
    // ãƒ†ã‚¹ãƒˆç”¨ã®å€¤ã‚’è¨­å®šï¼ˆå¤‰æ›´ãªã—ï¼‰
    sheet.getRange('J2').setValue(1500);
    sheet.getRange('L2').setValue(30);
    sheet.getRange('M2').setValue(25);
    sheet.getRange('N2').setValue(20);
    
    var methods = ['è‡ªå‹•é¸æŠ', 'Small Packet', 'Cpass-FedEx', 'Cpass-DHL', 'eLogistics'];
    var results = [];
    
    for (var i = 0; i < methods.length; i++) {
      sheet.getRange('R1').setValue(methods[i]);  // Q1â†’R1
      SpreadsheetApp.flush();
      Utilities.sleep(100);
      
      var cost = sheet.getRange('R2').getValue();  // Q2â†’R2
      results.push(methods[i] + ': ' + (typeof cost === 'number' ? 'Â¥' + cost.toLocaleString() : cost));
    }
    
    var report = 'é€æ–™è¨ˆç®—æ©Ÿèƒ½ãƒ†ã‚¹ãƒˆçµæœ:\n\n' +
      'ãƒ†ã‚¹ãƒˆæ¡ä»¶: é‡é‡1500gã€ã‚µã‚¤ã‚º30x25x20cm\n\n' +
      'å„æ–¹æ³•ã§ã®é€æ–™:\n' + results.join('\n');
    
    showAlert(report, 'info');
    
  } catch (e) {
    showAlert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * Q2ã‚»ãƒ«ã®é€æ–™ã‚’æ‰‹å‹•æ›´æ–°ï¼ˆå†è¨ˆç®—å¼·åˆ¶ï¼‰
 */
function refreshShippingCalculation() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      return;
    }
    
    var r2Cell = sheet.getRange('R2');  // Q2â†’R2
    var currentFormula = r2Cell.getFormula();
    
    if (currentFormula) {
      r2Cell.clearContent();
      SpreadsheetApp.flush();
      r2Cell.setFormula(currentFormula);
      SpreadsheetApp.flush();
      
      showAlert('é€æ–™ã‚’å†è¨ˆç®—ã—ã¾ã—ãŸã€‚', 'success');
    } else {
      setupShippingCalculationFormula(sheet);
      showAlert('é€æ–™è¨ˆç®—æ•°å¼ã‚’è¨­å®šã—ã¾ã—ãŸã€‚', 'success');
    }
    
  } catch (e) {
    showAlert('å†è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ã‚·ãƒ³ãƒ—ãƒ«é‡è¤‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ï¼ˆæ—¢å­˜HTMLå¯¾å¿œç‰ˆï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
/**
 * é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showDuplicateCheckSettings() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('DuplicateCheckSettings')
      .setWidth(700).setHeight(600);
    SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ” é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š');
  } catch (e) {
    showAlert('è¨­å®šãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
  }
}
/**
 * é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®šã‚’ä¿å­˜ï¼ˆå‡ºåŠ›å…ˆé¸æŠãƒ»è²¼ã‚Šä»˜ã‘æ©Ÿèƒ½ä»˜ãï¼‰
 */
function saveDuplicateCheckSettings(formData) {
  try {
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!formData.sourceSheet || !formData.sourceColumn) {
      return { success: false, error: 'ä½œæ¥­ã‚·ãƒ¼ãƒˆã¨åˆ—ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚' };
    }
    
    if (!formData.targetSheets || formData.targetSheets.length === 0) {
      return { success: false, error: 'ãƒã‚§ãƒƒã‚¯å¯¾è±¡ã‚·ãƒ¼ãƒˆã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚' };
    }
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // COUNTIFå¼ã‚’ä½œæˆ
    var countifFormulas = [];
    for (var i = 0; i < formData.targetSheets.length; i++) {
      var target = formData.targetSheets[i];
      var targetSheet = target.sheet;
      var targetColumn = target.column;
      
      if (targetSheet.endsWith('*')) {
        // ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°å¯¾å¿œ
        var prefix = targetSheet.slice(0, -1);
        var allSheets = ss.getSheets();
        for (var j = 0; j < allSheets.length; j++) {
          var sheetName = allSheets[j].getName();
          if (sheetName.indexOf(prefix) === 0) {
            countifFormulas.push('COUNTIF(\'' + sheetName + '\'!' + targetColumn + ':' + targetColumn + ',' + formData.sourceColumn + '1)>0');
          }
        }
      } else {
        countifFormulas.push('COUNTIF(\'' + targetSheet + '\'!' + targetColumn + ':' + targetColumn + ',' + formData.sourceColumn + '1)>0');
      }
    }
    
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯é–¢æ•°ã‚’ç”Ÿæˆ
    var duplicateFormula = '=IF(AND(NOT(ISBLANK(' + formData.sourceColumn + '1)), OR(' + countifFormulas.join(',') + ')), "é‡è¤‡", "")';
    
    // ğŸ†• å‡ºåŠ›å…ˆãŒæŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å®Ÿéš›ã«è²¼ã‚Šä»˜ã‘
    if (formData.outputSheet && formData.outputColumn && formData.outputStartRow) {
      var outputSheet = ss.getSheetByName(formData.outputSheet);
      if (!outputSheet) {
        return { success: false, error: 'å‡ºåŠ›å…ˆã‚·ãƒ¼ãƒˆã€Œ' + formData.outputSheet + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚' };
      }
      
      // å‡ºåŠ›å…ˆã®ç¯„å›²ã‚’æ±ºå®š
      var startRow = parseInt(formData.outputStartRow);
      if (isNaN(startRow) || startRow < 1) {
        return { success: false, error: 'å‡ºåŠ›é–‹å§‹è¡Œã¯1ä»¥ä¸Šã®æ•°å€¤ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚' };
      }
      
      // ğŸ†• è²¼ã‚Šä»˜ã‘å®Ÿè¡Œ
      var pasteResult = applyDuplicateFormulaToSheet(outputSheet, formData.outputColumn, startRow, duplicateFormula, formData.outputRange);
      
      if (!pasteResult.success) {
        return { success: false, error: pasteResult.error };
      }
      
      return { 
        success: true, 
        message: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯å¼ã‚’ç”Ÿæˆã—ã€ã€Œ' + formData.outputSheet + 'ã€ã®' + formData.outputColumn + 'åˆ—ã«é©ç”¨ã—ã¾ã—ãŸã€‚',
        formula: duplicateFormula,
        applied: true,
        appliedRange: pasteResult.range,
        appliedCount: pasteResult.count
      };
    } else {
      // å¾“æ¥é€šã‚Šå¼ã®ã¿ç”Ÿæˆ
      return { 
        success: true, 
        message: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯é–¢æ•°ã‚’ç”Ÿæˆã—ã¾ã—ãŸã€‚',
        formula: duplicateFormula,
        applied: false
      };
    }
    
  } catch (e) {
    return { success: false, error: e.message };
  }
}

/**
 * ğŸ†• é‡è¤‡ãƒã‚§ãƒƒã‚¯å¼ã‚’ã‚·ãƒ¼ãƒˆã«å®Ÿéš›ã«é©ç”¨
 * @param {Sheet} sheet - å‡ºåŠ›å…ˆã‚·ãƒ¼ãƒˆ
 * @param {string} column - å‡ºåŠ›å…ˆåˆ—ï¼ˆä¾‹: 'A', 'B', 'C'ï¼‰
 * @param {number} startRow - é–‹å§‹è¡Œç•ªå·
 * @param {string} formula - é©ç”¨ã™ã‚‹æ•°å¼
 * @param {string} range - é©ç”¨ç¯„å›²ï¼ˆ'ALL', 'DATA', 'CUSTOM'ï¼‰
 * @return {Object} é©ç”¨çµæœ
 */
function applyDuplicateFormulaToSheet(sheet, column, startRow, formula, range) {
  try {
    var endRow;
    
    // é©ç”¨ç¯„å›²ã®æ±ºå®š
    switch (range) {
      case 'ALL':
        // ã‚·ãƒ¼ãƒˆå…¨ä½“ï¼ˆæœ€å¤§1000è¡Œï¼‰
        endRow = Math.min(1000, sheet.getMaxRows());
        break;
      case 'DATA':
        // ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹ç¯„å›²ã¾ã§
        endRow = Math.max(startRow, sheet.getLastRow());
        break;
      case 'CUSTOM':
        // ã‚«ã‚¹ã‚¿ãƒ ç¯„å›²ï¼ˆç¾åœ¨ã¯100è¡Œå›ºå®šã€å°†æ¥çš„ã«æ‹¡å¼µå¯èƒ½ï¼‰
        endRow = startRow + 99;
        break;
      default:
        endRow = Math.max(startRow + 99, sheet.getLastRow());
    }
    
    if (endRow < startRow) {
      return { success: false, error: 'çµ‚äº†è¡ŒãŒé–‹å§‹è¡Œã‚ˆã‚Šå°ã•ããªã£ã¦ã„ã¾ã™ã€‚' };
    }
    
    var rowCount = endRow - startRow + 1;
    var targetRange = sheet.getRange(startRow, getColumnNumber(column), rowCount, 1);
    
    // å„è¡Œã«å¯¾å¿œã—ãŸæ•°å¼ã‚’ç”Ÿæˆï¼ˆè¡Œç•ªå·ã‚’å‹•çš„ã«å¤‰æ›´ï¼‰
    var formulas = [];
    for (var i = 0; i < rowCount; i++) {
      var currentRow = startRow + i;
      var rowFormula = formula.replace(/([A-Z]+)1/g, '$1' + currentRow);
      formulas.push([rowFormula]);
    }
    
    // æ•°å¼ã‚’ä¸€æ‹¬è¨­å®š
    targetRange.setFormulas(formulas);
    
    return {
      success: true,
      range: targetRange.getA1Notation(),
      count: rowCount
    };
    
  } catch (e) {
    return { success: false, error: 'æ•°å¼é©ç”¨ã‚¨ãƒ©ãƒ¼: ' + e.message };
  }
}

/**
 * ğŸ†• å‡ºåŠ›å¯èƒ½ãªã‚·ãƒ¼ãƒˆä¸€è¦§ã‚’å–å¾—ï¼ˆã‚·ã‚¹ãƒ†ãƒ ã‚·ãƒ¼ãƒˆã‚’é™¤å¤–ï¼‰
 * @return {Array} ã‚·ãƒ¼ãƒˆåã®é…åˆ—
 */
function getOutputAvailableSheets() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var allSheets = ss.getSheets();
    var availableSheets = [];
    
    // ã‚·ã‚¹ãƒ†ãƒ ç³»ã‚·ãƒ¼ãƒˆã‚’é™¤å¤–
    var excludePatterns = ['GPT_Prompts', 'Shipping_', 'Profit_Amounts', 'README'];
    
    allSheets.forEach(function(sheet) {
      var sheetName = sheet.getName();
      var shouldExclude = excludePatterns.some(function(pattern) {
        return sheetName.indexOf(pattern) !== -1;
      });
      
      if (!shouldExclude) {
        availableSheets.push(sheetName);
      }
    });
    
    return availableSheets;
    
  } catch (e) {
    console.error('å‡ºåŠ›å¯èƒ½ã‚·ãƒ¼ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return ['ä½œæ¥­ã‚·ãƒ¼ãƒˆ'];
  }
}

/**
 * ğŸ†• åˆ—é¸æŠè‚¢ã‚’ç”Ÿæˆï¼ˆAï½Z, AAï½AZï¼‰
 * @return {Array} åˆ—æ–‡å­—ã®é…åˆ—
 */
function getColumnOptions() {
  var columns = [];
  
  // Aï½Z
  for (var i = 0; i < 26; i++) {
    columns.push(String.fromCharCode(65 + i));
  }
  
  // AAï½AZï¼ˆå¿…è¦ã«å¿œã˜ã¦æ‹¡å¼µå¯èƒ½ï¼‰
  for (var i = 0; i < 26; i++) {
    columns.push('A' + String.fromCharCode(65 + i));
  }
  
  return columns;
}
/**
 * ã‚·ãƒ³ãƒ—ãƒ«ãªé‡è¤‡ãƒã‚§ãƒƒã‚¯é–¢æ•°
 */
function DUPLICATE_CHECK(value) {
  if (!value || value === '') return false;
  
  try {
    var settings = getDuplicateCheckSettings();
    if (!settings.enabled || !settings.targetSheets || settings.targetSheets.length === 0) {
      return false;
    }
    
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var valueStr = value.toString();
    
    // å„å¯¾è±¡ã‚·ãƒ¼ãƒˆã§ãƒã‚§ãƒƒã‚¯
    for (var i = 0; i < settings.targetSheets.length; i++) {
      var targetConfig = settings.targetSheets[i];
      var targetSheetPattern, columnIndex;
      
      if (typeof targetConfig === 'string') {
        // æ—§å½¢å¼ï¼ˆæ–‡å­—åˆ—ã®ã¿ï¼‰
        targetSheetPattern = targetConfig;
        columnIndex = 8; // Håˆ—
      } else if (targetConfig && targetConfig.sheet) {
        // æ–°å½¢å¼ï¼ˆã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆï¼‰
        targetSheetPattern = targetConfig.sheet;
        columnIndex = getColumnIndex(targetConfig.column || 'H');
      } else {
        continue;
      }
      
      var matchingSheets = findMatchingSheets(targetSheetPattern);
      
      for (var j = 0; j < matchingSheets.length; j++) {
        var sheetName = matchingSheets[j];
        var targetSheet = ss.getSheetByName(sheetName);
        if (!targetSheet) continue;
        
        if (checkInSheet(targetSheet, columnIndex, valueStr)) {
          return true;
        }
      }
    }
    
    return false;
    
  } catch (error) {
    console.error('DUPLICATE_CHECKé–¢æ•°ã‚¨ãƒ©ãƒ¼: ' + error.message);
    return false;
  }
}

/**
 * æŒ‡å®šã‚·ãƒ¼ãƒˆã§é‡è¤‡ã‚’ãƒã‚§ãƒƒã‚¯
 */
function checkInSheet(sheet, columnIndex, value) {
  try {
    var lastRow = sheet.getLastRow();
    if (lastRow < 1) return false;
    
    var data = sheet.getRange(1, columnIndex, lastRow, 1).getValues();
    for (var i = 0; i < data.length; i++) {
      if (data[i][0] && data[i][0].toString() === value) {
        return true;
      }
    }
    return false;
  } catch (e) {
    return false;
  }
}

/**
 * ã‚·ãƒ³ãƒ—ãƒ«ãªæ¡ä»¶ä»˜ãæ›¸å¼ã‚’é©ç”¨
 */
function applyDuplicateCheckConditionalFormatting(settings) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName(settings.sourceSheet);
    if (!sheet) return;
    
    var column = settings.sourceColumn;
    var range = sheet.getRange(column + ':' + column);
    
    // æ—¢å­˜ã®æ¡ä»¶ä»˜ãæ›¸å¼ã‚’ã‚¯ãƒªã‚¢
    var rules = sheet.getConditionalFormatRules();
    var newRules = rules.filter(function(rule) {
      try {
        var condition = rule.getBooleanCondition();
        if (condition) {
          var formula = condition.getCriteriaValues()[0];
          return !formula || formula.indexOf('DUPLICATE_CHECK') === -1;
        }
        return true;
      } catch (e) {
        return true;
      }
    });
    
    // æ–°ã—ã„ãƒ«ãƒ¼ãƒ«ã‚’è¿½åŠ 
    var formula = '=AND(NOT(ISBLANK(' + column + '1)), DUPLICATE_CHECK(' + column + '1))';
    var rule = SpreadsheetApp.newConditionalFormatRule()
      .whenFormulaSatisfied(formula)
      .setBackground('#ffcdd2')
      .setRanges([range])
      .build();
    
    newRules.push(rule);
    sheet.setConditionalFormatRules(newRules);
    
  } catch (e) {
    console.error('æ¡ä»¶ä»˜ãæ›¸å¼é©ç”¨ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

/**
 * é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®šã‚’å–å¾—
 */
function getDuplicateCheckSettings() {
  try {
    var props = PropertiesService.getScriptProperties();
    
    var settings = {
      sourceSheet: props.getProperty('DUPLICATE_CHECK_SOURCE_SHEET') || '',
      sourceColumn: props.getProperty('DUPLICATE_CHECK_SOURCE_COLUMN') || '',
      targetSheets: JSON.parse(props.getProperty('DUPLICATE_CHECK_TARGET_SHEETS') || '[]'),
      enabled: props.getProperty('DUPLICATE_CHECK_ENABLED') === 'true'
    };
    
    return settings;
  } catch (e) {
    return {
      sourceSheet: '',
      sourceColumn: '',
      targetSheets: [],
      enabled: false
    };
  }
}

/**
 * å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã®Låˆ—ã‹ã‚‰ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§ã‚’å–å¾—
 * @return {Array} ã‚«ãƒ†ã‚´ãƒªãƒ¼åã®é…åˆ—
 */
function getCategoryListFromReferenceData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var refSheet = ss.getSheetByName('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    if (!refSheet) {
      console.log('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return ['ãã®ä»–']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    }

    var lastRow = refSheet.getLastRow();
    if (lastRow < 2) {
      console.log('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return ['ãã®ä»–']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    }

    // Låˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ï¼ˆ2è¡Œç›®ä»¥é™ï¼‰
    var data = refSheet.getRange(2, 12, lastRow - 1, 1).getValues(); // 12 = Låˆ—
    var categories = [];
    
    // ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã¿ã‚’æŠ½å‡º
    for (var i = 0; i < data.length; i++) {
      var category = String(data[i][0] || '').trim();
      if (category && categories.indexOf(category) === -1) {
        categories.push(category);
      }
    }
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤
    if (categories.length === 0) {
      return ['ãã®ä»–'];
    }
    
    return categories.sort(); // ã‚¢ãƒ«ãƒ•ã‚¡ãƒ™ãƒƒãƒˆé †ã«ã‚½ãƒ¼ãƒˆ
    
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
    return ['ãã®ä»–']; // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—é–¢æ•°ã®ãƒ†ã‚¹ãƒˆ
 */
function testGetCategoryList() {
  try {
    var categories = getCategoryListFromReferenceData();
    
    var report = 'ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ãƒ†ã‚¹ãƒˆçµæœ:\n\n' +
      'å–å¾—ä»¶æ•°: ' + categories.length + 'ä»¶\n' +
      'ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¸€è¦§:\n' + categories.join('\n');
    
    showAlert(report, 'info');
    
    // ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã«ã‚‚å‡ºåŠ›
    console.log('å–å¾—ã—ãŸã‚«ãƒ†ã‚´ãƒªãƒ¼:', categories);
    
  } catch (error) {
    showAlert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * é…é€æ–¹æ³•ã‚’ã‚¨ã‚³ãƒãƒŸãƒ¼/EXã«å¤‰æ›
 * @param {string} shippingMethod - Wåˆ—ã®é…é€æ–¹æ³•
 * @return {string} "ã‚¨ã‚³ãƒãƒŸãƒ¼", "EX", ã¾ãŸã¯ "ã‚¨ãƒ©ãƒ¼"
 */
function convertShippingMethodToType(shippingMethod) {
  try {
    var method = String(shippingMethod || '').trim();
    
    // è‡ªå‹•é¸æŠã®å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    if (method === 'è‡ªå‹•é¸æŠ' || method === '') {
      return 'ã‚¨ãƒ©ãƒ¼';
    }
    
    // ã‚¨ã‚³ãƒãƒŸãƒ¼ç³»ã®åˆ¤å®š
    var economyMethods = ['Cpass-Economy', 'Small Packet'];
    for (var i = 0; i < economyMethods.length; i++) {
      if (method === economyMethods[i]) {
        return 'ã‚¨ã‚³ãƒãƒŸãƒ¼';
      }
    }
    
    // EXç³»ã®åˆ¤å®š
    var exMethods = ['Cpass-FedEx', 'Cpass-DHL', 'eLogistics'];
    for (var j = 0; j < exMethods.length; j++) {
      if (method === exMethods[j]) {
        return 'EX';
      }
    }
    
    // ã©ã¡ã‚‰ã«ã‚‚è©²å½“ã—ãªã„å ´åˆã¯ã‚¨ãƒ©ãƒ¼
    console.log('æœªå¯¾å¿œã®é…é€æ–¹æ³•: ' + method);
    return 'ã‚¨ãƒ©ãƒ¼';
    
  } catch (error) {
    console.error('é…é€æ–¹æ³•å¤‰æ›ã‚¨ãƒ©ãƒ¼: ' + error.message);
    return 'ã‚¨ãƒ©ãƒ¼';
  }
}

/**
 * é…é€æ–¹æ³•å¤‰æ›ã®ãƒ†ã‚¹ãƒˆ
 */
function testConvertShippingMethod() {
  try {
    var testMethods = [
      'Cpass-Economy',
      'Small Packet', 
      'Cpass-FedEx',
      'Cpass-DHL',
      'eLogistics',
      'è‡ªå‹•é¸æŠ',
      'EMS',
      ''
    ];
    
    var results = [];
    for (var i = 0; i < testMethods.length; i++) {
      var method = testMethods[i];
      var result = convertShippingMethodToType(method);
      results.push('"' + method + '" â†’ "' + result + '"');
    }
    
    var report = 'é…é€æ–¹æ³•å¤‰æ›ãƒ†ã‚¹ãƒˆçµæœ:\n\n' + results.join('\n');
    showAlert(report, 'info');
    
  } catch (error) {
    showAlert('å¤‰æ›ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * ã€éæ¨å¥¨ã€‘2æ¬¡å…ƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œç´¢ï¼ˆå¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹å­˜ï¼‰
 * æ–°ã—ã„ã‚³ãƒ¼ãƒ‰ã§ã¯ getTemplateFromReferenceData4D ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„
 * @deprecated Use getTemplateFromReferenceData4D instead
 * @param {number} priceUSD - è²©å£²ä¾¡æ ¼ï¼ˆUSDï¼‰
 * @param {string} condition - å•†å“çŠ¶æ…‹ï¼ˆ"æ–°å“" ã¾ãŸã¯ "ä¸­å¤"ï¼‰
 * @return {number|null} - è©²å½“ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå€¤ã€è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯null
 */
function getTemplateFromReferenceData(priceUSD, condition) {
  console.warn('ã€è­¦å‘Šã€‘getTemplateFromReferenceData ã¯éæ¨å¥¨ã§ã™ã€‚getTemplateFromReferenceData4D ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚');
  
  try {
    // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã§4æ¬¡å…ƒæ¤œç´¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
    var defaultCategory = 'ãã®ä»–';
    var defaultShipping = 'ã‚¨ã‚³ãƒãƒŸãƒ¼';
    
    console.log('2æ¬¡å…ƒæ¤œç´¢ã‚’4æ¬¡å…ƒæ¤œç´¢ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ: ã‚«ãƒ†ã‚´ãƒª=' + defaultCategory + ', é…é€=' + defaultShipping);
    
    return getTemplateFromReferenceData4D(defaultCategory, condition, defaultShipping, priceUSD);
    
  } catch (error) {
    console.error('2æ¬¡å…ƒâ†’4æ¬¡å…ƒãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message);
    return null;
  }
}



/**
 * é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä¸€æ™‚ä¿å­˜
 * @param {string} category - é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼
 */
function saveSelectedCategory(category) {
  try {
    var props = PropertiesService.getScriptProperties();
    props.setProperty('SELECTED_CATEGORY', category);
    console.log('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ä¿å­˜: ' + category);
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ä¿å­˜ã‚¨ãƒ©ãƒ¼: ' + error.message);
  }
}

/**
 * ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’å–å¾—
 * @return {string|null} ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼
 */
function getSavedCategory() {
  try {
    var props = PropertiesService.getScriptProperties();
    return props.getProperty('SELECTED_CATEGORY');
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message);
    return null;
  }
}

/**
 * ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ã‚¯ãƒªã‚¢
 */
function clearSavedCategory() {
  try {
    var props = PropertiesService.getScriptProperties();
    props.deleteProperty('SELECTED_CATEGORY');
    console.log('ä¿å­˜ã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’ã‚¯ãƒªã‚¢');
  } catch (error) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚¯ãƒªã‚¢ã‚¨ãƒ©ãƒ¼: ' + error.message);
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®ãƒ†ã‚¹ãƒˆ
 */
function testCategorySelectionDialog() {
  try {
    var selectedCategory = showCategorySelectionDialog();
    
    if (selectedCategory) {
      saveSelectedCategory(selectedCategory);
      var savedCategory = getSavedCategory();
      showAlert('ãƒ†ã‚¹ãƒˆæˆåŠŸ:\n\né¸æŠ: ' + selectedCategory + '\nä¿å­˜ç¢ºèª: ' + savedCategory, 'success');
    } else {
      showAlert('ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãŒã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚Œã¾ã—ãŸ', 'info');
    }
    
  } catch (error) {
    showAlert('ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}
/**
 * 4æ¬¡å…ƒæ¡ä»¶ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œç´¢ï¼ˆNaNå¯¾å¿œä¿®æ­£ç‰ˆï¼‰
 */
function getTemplateFromReferenceData4D(category, condition, shippingType, priceUSD) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var refSheet = ss.getSheetByName('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    if (!refSheet) {
      console.log('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return null;
    }

    var lastRow = refSheet.getLastRow();
    if (lastRow < 2) {
      console.log('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
      return null;
    }

    var price = Number(priceUSD);
    if (isNaN(price)) {
      console.log('ä¾¡æ ¼ãŒç„¡åŠ¹ã§ã™: ' + priceUSD);
      return null;
    }

    // æ¡ä»¶ã®æ­£è¦åŒ–
    var searchCategory = String(category || '').trim();
    var searchCondition = String(condition || '').trim();
    var searchShippingType = String(shippingType || '').trim();

    console.log('æ¤œç´¢æ¡ä»¶: ã‚«ãƒ†ã‚´ãƒª=' + searchCategory + ', çŠ¶æ…‹=' + searchCondition + ', é…é€=' + searchShippingType + ', ä¾¡æ ¼=' + price);

    // ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—ï¼ˆ2è¡Œç›®ä»¥é™ï¼‰
    var dataRange = refSheet.getRange(2, 10, lastRow - 1, 7); // Jåˆ—ã‹ã‚‰Påˆ—ã¾ã§
    var data = dataRange.getValues();

    for (var i = 0; i < data.length; i++) {
      var row = data[i];
      var templateId = row[0];        // Jåˆ— - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID
      var rowCategory = String(row[2] || '').trim();     // Låˆ— - ã‚«ãƒ†ã‚´ãƒª
      var rowCondition = String(row[3] || '').trim();    // Måˆ— - çŠ¶æ…‹
      var rowShipping = String(row[4] || '').trim();     // Nåˆ— - é…é€æ–¹æ³•
      
      // â˜…â˜…â˜… ä¿®æ­£: NaNå¯¾å¿œã®ä¾¡æ ¼ç¯„å›²å–å¾— â˜…â˜…â˜…
      var minPriceRaw = row[5];  // Oåˆ— - æœ€ä½ä¾¡æ ¼
      var maxPriceRaw = row[6];  // Påˆ— - æœ€é«˜ä¾¡æ ¼
      
      var minPrice = (minPriceRaw === null || minPriceRaw === '' || isNaN(Number(minPriceRaw))) ? 0 : Number(minPriceRaw);
      var maxPrice = (maxPriceRaw === null || maxPriceRaw === '' || isNaN(Number(maxPriceRaw))) ? 999999 : Number(maxPriceRaw);
      
      console.log('è¡Œ' + (i + 2) + ': ä¾¡æ ¼ç¯„å›² ' + minPriceRaw + 'â†’' + minPrice + ', ' + maxPriceRaw + 'â†’' + maxPrice);
      // â˜…â˜…â˜… ã“ã“ã¾ã§ä¿®æ­£ â˜…â˜…â˜…

      // 4ã¤ã®æ¡ä»¶ã‚’ã™ã¹ã¦ãƒã‚§ãƒƒã‚¯
      if (rowCategory === searchCategory &&
          rowCondition === searchCondition &&
          rowShipping === searchShippingType) {
        
        // ä¾¡æ ¼ç¯„å›²ã®ãƒã‚§ãƒƒã‚¯ï¼ˆä¿®æ­£æ¸ˆã¿ï¼‰
        if (price >= minPrice && price <= maxPrice) {
          console.log('ãƒãƒƒãƒã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ID=' + templateId + ', è¡Œ=' + (i + 2) + ', ä¾¡æ ¼ç¯„å›²=' + minPrice + '-' + maxPrice);
          return typeof templateId === 'number' ? templateId : Number(templateId);
        } else {
          console.log('ä¾¡æ ¼ç¯„å›²å¤–: ' + price + ' not in ' + minPrice + '-' + maxPrice);
        }
      }
    }

    console.log('è©²å½“ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return null;

  } catch (error) {
    console.error('4æ¬¡å…ƒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + error.message);
    return null;
  }
}
/**
 * å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã®ã€Œãã®ä»–ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å†…å®¹ã‚’ç¢ºèª
 */
function checkOtherCategoryData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var refSheet = ss.getSheetByName('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    if (!refSheet) {
      showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }

    var lastRow = refSheet.getLastRow();
    var report = 'ã€Œãã®ä»–ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ç¢ºèª:\n\n';
    
    var found = false;
    for (var row = 2; row <= lastRow; row++) {
      var templateId = refSheet.getRange(row, 10).getValue();  // Jåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
      var category = String(refSheet.getRange(row, 12).getValue() || '').trim(); // Låˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
      var condition = String(refSheet.getRange(row, 13).getValue() || '').trim(); // Måˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
      var shipping = String(refSheet.getRange(row, 14).getValue() || '').trim();  // Nåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
      var minPrice = refSheet.getRange(row, 15).getValue();   // Oåˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
      var maxPrice = refSheet.getRange(row, 16).getValue();   // Påˆ—ï¼ˆå¤‰æ›´ãªã—ï¼‰
      
      if (category === 'ãã®ä»–') {
        found = true;
        report += 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + templateId + ': ' + condition + ' + ' + shipping + ' ($' + minPrice + '-' + maxPrice + ')\n';
      }
    }
    
    if (!found) {
      report += 'ã€Œãã®ä»–ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\n\n';
      report += 'å¯¾å‡¦æ³•:\n';
      report += '1. å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã«ã€Œãã®ä»–ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¿½åŠ \n';
      report += '2. ã¾ãŸã¯æ—¢å­˜ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆã‚²ãƒ¼ãƒ ã€æœ¬ç­‰ï¼‰ã§ãƒ†ã‚¹ãƒˆ';
    } else {
      report += '\nä¸Šè¨˜ã®çµ„ã¿åˆã‚ã›ãŒåˆ©ç”¨å¯èƒ½ã§ã™ã€‚';
    }
    
    showAlert(report, found ? 'info' : 'warning');
    
  } catch (error) {
    showAlert('ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}
/**
 * 4æ¬¡å…ƒæ¤œç´¢ãƒ­ã‚¸ãƒƒã‚¯ã®è©³ç´°ãƒ‡ãƒãƒƒã‚°
 */
function debugDetailedSearch() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var refSheet = ss.getSheetByName('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    if (!refSheet) return;

    var searchCategory = 'ãã®ä»–';
    var searchCondition = 'æ–°å“';
    var searchShippingType = 'EX';
    var searchPrice = 100;

    var report = 'è©³ç´°æ¤œç´¢ãƒ‡ãƒãƒƒã‚°:\n\n';
    report += 'æ¤œç´¢æ¡ä»¶: "' + searchCategory + '", "' + searchCondition + '", "' + searchShippingType + '", $' + searchPrice + '\n\n';

    var lastRow = refSheet.getLastRow();
    var dataRange = refSheet.getRange(2, 10, lastRow - 1, 7);
    var data = dataRange.getValues();

    var matchCount = 0;
    for (var i = 0; i < data.length; i++) {
      var row = data[i];
      var templateId = row[0];        // Jåˆ—
      var rowCategory = String(row[2] || '').trim();     // Låˆ—
      var rowCondition = String(row[3] || '').trim();    // Måˆ—
      var rowShipping = String(row[4] || '').trim();     // Nåˆ—
      var minPrice = Number(row[5]);  // Oåˆ—
      var maxPrice = Number(row[6]);  // Påˆ—

      // ã€Œãã®ä»–ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ã¿ãƒã‚§ãƒƒã‚¯
      if (rowCategory === searchCategory) {
        matchCount++;
        report += 'è¡Œ' + (i + 2) + ': ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + templateId + '\n';
        report += '  ã‚«ãƒ†ã‚´ãƒªãƒ¼: "' + rowCategory + '" (ä¸€è‡´: ' + (rowCategory === searchCategory) + ')\n';
        report += '  çŠ¶æ…‹: "' + rowCondition + '" (ä¸€è‡´: ' + (rowCondition === searchCondition) + ')\n';
        report += '  é…é€: "' + rowShipping + '" (ä¸€è‡´: ' + (rowShipping === searchShippingType) + ')\n';
        report += '  ä¾¡æ ¼ç¯„å›²: ' + minPrice + '-' + maxPrice + ' (å‹: ' + typeof minPrice + ', ' + typeof maxPrice + ')\n';
        report += '  ä¾¡æ ¼åˆ¤å®š: ' + searchPrice + '>=' + minPrice + '? ' + (searchPrice >= minPrice) + ', ' + searchPrice + '<=' + maxPrice + '? ' + (searchPrice <= maxPrice) + '\n';
        
        if (rowCategory === searchCategory && rowCondition === searchCondition && rowShipping === searchShippingType) {
          if (!isNaN(minPrice) && !isNaN(maxPrice) && searchPrice >= minPrice && searchPrice <= maxPrice) {
            report += '  â˜…â˜…â˜… å®Œå…¨ä¸€è‡´ï¼ â˜…â˜…â˜…\n';
          } else {
            report += '  ä¾¡æ ¼ç¯„å›²ä¸ä¸€è‡´\n';
          }
        } else {
          report += '  æ¡ä»¶ä¸ä¸€è‡´\n';
        }
        report += '\n';
      }
    }

    if (matchCount === 0) {
      report += 'ã€Œãã®ä»–ã€ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
    }

    showAlert(report, 'info');

  } catch (error) {
    showAlert('è©³ç´°ãƒ‡ãƒãƒƒã‚°ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢æ©Ÿèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢æ©Ÿèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showTemplateManualSearchDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('TemplateManualSearch')
      .setWidth(600).setHeight(650);
    SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ” ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢');
  } catch (e) {
    showAlert('æ‰‹å‹•æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
  }
}

/**
 * æ‰‹å‹•ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œç´¢ã™ã‚‹
 * @param {Object} searchData - æ¤œç´¢æ¡ä»¶ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Object} æ¤œç´¢çµæœ
 */
function searchTemplateManually(searchData) {
  try {
    console.log('æ‰‹å‹•ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œç´¢é–‹å§‹:', searchData);
    
    // å…¥åŠ›å€¤æ¤œè¨¼
    if (!searchData || typeof searchData !== 'object') {
      return { success: false, error: 'æ¤œç´¢æ¡ä»¶ãŒç„¡åŠ¹ã§ã™' };
    }
    
    var category = String(searchData.category || '').trim();
    var condition = String(searchData.condition || '').trim();
    var shippingType = String(searchData.shippingType || '').trim();
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!category) {
      return { success: false, error: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„' };
    }
    
    // ãƒˆãƒ¬ã‚«ãƒ»äºˆç´„è²©å£²ä»¥å¤–ã¯çŠ¶æ…‹ã¨é…é€ãŒå¿…è¦
    if (!['card_graded', 'card_raw'].includes(category)) {
      if (category !== 'preorder' && (!condition || !['æ–°å“', 'ä¸­å¤'].includes(condition))) {
        return { success: false, error: 'å•†å“çŠ¶æ…‹ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„' };
      }
      
      if (!shippingType || !['ã‚¨ã‚³ãƒãƒŸãƒ¼', 'EX'].includes(shippingType)) {
        return { success: false, error: 'é…é€æ–¹æ³•ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„' };
      }
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’ç”Ÿæˆ
    var templateName = generateTemplateName(category, shippingType, condition);
    
    if (!templateName) {
      return { success: false, error: 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã®ç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ' };
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’æ¤œç´¢
    var templateId = findTemplateId(templateName);
    
    console.log('æ¤œç´¢çµæœ:', templateId, templateName);
    
    return {
      success: true,
      templateId: templateId,
      templateName: templateName,
      searchConditions: {
        category: category,
        condition: condition,
        shippingType: shippingType
      }
    };
    
  } catch (error) {
    console.error('æ‰‹å‹•æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
    return { 
      success: false, 
      error: error.message || 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' 
    };
  }
}
/**
 * Policy_Masterã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã®ãƒªã‚¹ãƒˆã‚’å–å¾—
 */
function getTemplateNameList() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var masterSheet = ss.getSheetByName('Policy_Master');
    
    if (!masterSheet) {
      return ['ä¸€èˆ¬æ±ç”¨']; // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
    }
    
    var lastRow = masterSheet.getLastRow();
    var templateNames = {};  // é‡è¤‡æ’é™¤ç”¨ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
    
    // Templates ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¢ã™
    var data = masterSheet.getRange(1, 1, lastRow, 2).getValues();
    var inTemplateSection = false;
    
    for (var i = 0; i < data.length; i++) {
      var cellValue = String(data[i][0]);
      
      // Templates ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
      if (cellValue.indexOf('ã€Templatesã€‘') !== -1) {
        inTemplateSection = true;
        continue;
      }
      
      // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆShipping Policiesï¼‰ãŒå§‹ã¾ã£ãŸã‚‰çµ‚äº†
      if (cellValue.indexOf('ã€Shipping') !== -1) {
        break;
      }
      
      // Templatesã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’æŠ½å‡º
      if (inTemplateSection && data[i][1]) {
        var templateFullName = String(data[i][1]);
        
        // Template_xxx_new_eco ã®ã‚ˆã†ãªå½¢å¼ã‹ã‚‰ xxx ã‚’æŠ½å‡º
        var match = templateFullName.match(/^Template_(.+?)_(new|used)_(eco|xp)$/);
        if (match) {
          templateNames[match[1]] = true; // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåéƒ¨åˆ†ã‚’è¿½åŠ ï¼ˆé‡è¤‡æ’é™¤ï¼‰
        }
      }
    }
    
    // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ã‚­ãƒ¼ã‚’é…åˆ—ã«å¤‰æ›ã—ã¦ã‚½ãƒ¼ãƒˆ
    var result = Object.keys(templateNames).sort();
    
    // ç©ºã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚’è¿”ã™
    return result.length > 0 ? result : ['ä¸€èˆ¬æ±ç”¨'];
    
  } catch (e) {
    console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåãƒªã‚¹ãƒˆå–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return ['ä¸€èˆ¬æ±ç”¨'];
  }
}
/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢æ©Ÿèƒ½ã®ãƒ†ã‚¹ãƒˆ
 */
function testTemplateManualSearch() {
  try {
    // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1: æ–°å“ã€ã‚¨ã‚³ãƒãƒŸãƒ¼ã€ä½ä¾¡æ ¼
    var testCase1 = {
      category: 'ãã®ä»–',
      condition: 'æ–°å“',
      shipping: 'ã‚¨ã‚³ãƒãƒŸãƒ¼',
      price: 15
    };
    
    var result1 = searchTemplateManually(testCase1);
    
    // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2: ä¸­å¤ã€EXã€ä¸­ä¾¡æ ¼
    var testCase2 = {
      category: 'ãã®ä»–',
      condition: 'ä¸­å¤',
      shipping: 'EX',
      price: 60
    };
    
    var result2 = searchTemplateManually(testCase2);
    
    // ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3: å­˜åœ¨ã—ãªã„æ¡ä»¶
    var testCase3 = {
      category: 'ãã®ä»–',
      condition: 'æ–°å“',
      shipping: 'EX',
      price: 9999
    };
    
    var result3 = searchTemplateManually(testCase3);
    
    var report = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢ãƒ†ã‚¹ãƒˆçµæœ:\n\n' +
      'ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹1ã€‘æ–°å“ãƒ»ã‚¨ã‚³ãƒãƒŸãƒ¼ãƒ»$15\n' +
      'çµæœ: ' + (result1.success ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + result1.templateId : 'ã‚¨ãƒ©ãƒ¼: ' + result1.error) + '\n\n' +
      
      'ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹2ã€‘ä¸­å¤ãƒ»EXãƒ»$60\n' +
      'çµæœ: ' + (result2.success ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + result2.templateId : 'ã‚¨ãƒ©ãƒ¼: ' + result2.error) + '\n\n' +
      
      'ã€ãƒ†ã‚¹ãƒˆã‚±ãƒ¼ã‚¹3ã€‘æ–°å“ãƒ»EXãƒ»$9999ï¼ˆå­˜åœ¨ã—ãªã„æƒ³å®šï¼‰\n' +
      'çµæœ: ' + (result3.success ? (result3.templateId ? 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + result3.templateId : 'è©²å½“ãªã—') : 'ã‚¨ãƒ©ãƒ¼: ' + result3.error) + '\n\n' +
      
      'ğŸ’¡ å®Ÿéš›ã®æ¤œç´¢ã¯ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‹ã‚‰ã€Œãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ‰‹å‹•æ¤œç´¢ã€ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚';
    
    showAlert(report, 'info');
    
  } catch (error) {
    showAlert('æ‰‹å‹•æ¤œç´¢ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * å‚ç…§ãƒ‡ãƒ¼ã‚¿ã®æ§‹é€ ã‚’ç¢ºèªï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
 */
function debugReferenceDataForManualSearch() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var refSheet = ss.getSheetByName('å‚ç…§ãƒ‡ãƒ¼ã‚¿');
    if (!refSheet) {
      showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
    
    var lastRow = refSheet.getLastRow();
    if (lastRow < 2) {
      showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“', 'info');
      return;
    }
    
    var report = 'å‚ç…§ãƒ‡ãƒ¼ã‚¿æ§‹é€ ç¢ºèªï¼ˆæ‰‹å‹•æ¤œç´¢ç”¨ï¼‰:\n\n';
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼ç¢ºèª
    var headers = [];
    for (var col = 10; col <= 16; col++) { // Jåˆ—ã‹ã‚‰Påˆ—
      headers.push(refSheet.getRange(1, col).getValue());
    }
    report += 'åˆ—æ§‹é€ : ' + headers.join(' | ') + '\n\n';
    
    // å„ã‚«ãƒ†ã‚´ãƒªãƒ¼ãƒ»çŠ¶æ…‹ãƒ»é…é€æ–¹æ³•ã®çµ„ã¿åˆã‚ã›ã‚’é›†è¨ˆ
    var combinations = {};
    
    for (var row = 2; row <= lastRow; row++) {
      var templateId = refSheet.getRange(row, 10).getValue();  // Jåˆ—
      var category = String(refSheet.getRange(row, 12).getValue() || '').trim(); // Låˆ—
      var condition = String(refSheet.getRange(row, 13).getValue() || '').trim(); // Måˆ—
      var shipping = String(refSheet.getRange(row, 14).getValue() || '').trim();  // Nåˆ—
      var minPrice = refSheet.getRange(row, 15).getValue();   // Oåˆ—
      var maxPrice = refSheet.getRange(row, 16).getValue();   // Påˆ—
      
      if (category && condition && shipping) {
        var key = category + ' | ' + condition + ' | ' + shipping;
        if (!combinations[key]) {
          combinations[key] = [];
        }
        combinations[key].push({
          template: templateId,
          minPrice: minPrice,
          maxPrice: maxPrice
        });
      }
    }
    
    report += 'åˆ©ç”¨å¯èƒ½ãªçµ„ã¿åˆã‚ã›:\n';
    var keys = Object.keys(combinations).sort();
    for (var i = 0; i < keys.length; i++) {
      var key = keys[i];
      var items = combinations[key];
      report += '\nã€' + key + 'ã€‘\n';
      for (var j = 0; j < items.length; j++) {
        var item = items[j];
        report += '  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + item.template + ': $' + item.minPrice + ' - $' + item.maxPrice + '\n';
      }
    }
    
    if (keys.length === 0) {
      report += 'æœ‰åŠ¹ãªçµ„ã¿åˆã‚ã›ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚\nå‚ç…§ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆã®è¨­å®šã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚';
    }
    
    showAlert(report, 'info');
    
  } catch (error) {
    showAlert('å‚ç…§ãƒ‡ãƒ¼ã‚¿ç¢ºèªã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}
/**
 * ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆä¿å­˜ãƒ»å‰Šé™¤ç³»ï¼‰
 */
function conditionalConfirmDialog(message, title) {
  if (shouldShowPopups()) {
    var ui = SpreadsheetApp.getUi();
    return ui.alert(title || 'ç¢ºèª', message, ui.ButtonSet.YES_NO);
  } else {
    // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ç¢ºèªãªã—ã§å®Ÿè¡Œ
    return SpreadsheetApp.getUi().Button.YES;
  }
}

/**
 * æƒ…å ±ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºåˆ¶å¾¡ï¼ˆä¸€è¦§è¡¨ç¤ºç³»ï¼‰
 */
function conditionalInfoDialog(message, title) {
  if (shouldShowPopups()) {
    var ui = SpreadsheetApp.getUi();
    ui.alert(title || 'æƒ…å ±', message, ui.ButtonSet.OK);
  }
  // ã‚µã‚¤ãƒ¬ãƒ³ãƒˆãƒ¢ãƒ¼ãƒ‰æ™‚ã¯ä½•ã‚‚è¡¨ç¤ºã—ãªã„
}

function saveIntegratedSettings(formData) {
  var ui = SpreadsheetApp.getUi();
  var props = PropertiesService.getScriptProperties();
  try {
    // åŸºæœ¬è¨­å®šã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    var platform = formData.platform;
    var apiKey = formData.apiKey;
    var model = formData.model;
    var sheetName = formData.sheetName;
    var profitCalc = formData.profitMethod;
    var promptId = formData.promptId;
    var shippingThreshold = parseFloat(formData.shippingThreshold);
    var shippingCalcMethod = formData.shippingCalcMethod;
    var lowPriceMethod = formData.lowPriceMethod;
    var highPriceMethod = formData.highPriceMethod;
    var showPopups = formData.showPopups || 'true';
    
    // ä¾¡æ ¼ãƒ»åˆ©ç›Šè¨­å®š
    var priceDisplayMode = formData.priceDisplayMode || 'NORMAL';
    var dduAdjustmentEnabled = formData.dduAdjustmentEnabled || 'false';
    var dduThreshold = parseFloat(formData.dduThreshold) || CONFIG.DDU_PRICE_ADJUSTMENT.DEFAULT_THRESHOLD;
    var dduAdjustment = parseFloat(formData.dduAdjustment) || CONFIG.DDU_PRICE_ADJUSTMENT.DEFAULT_ADJUSTMENT;

    // é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š
    var duplicateCheckEnabled = formData.duplicateCheckEnabled || false;
    var duplicateSettings = null;
    if (duplicateCheckEnabled) {
      duplicateSettings = {
        sourceSheet: formData.duplicateSourceSheet,
        sourceColumn: formData.duplicateSourceColumn,
        targetSheets: formData.duplicateTargetSheets || [],
        applyToSheet: formData.duplicateApplyToSheet || false,
        outputSheet: formData.duplicateOutputSheet,
        outputColumn: formData.duplicateOutputColumn,
        outputStartRow: formData.duplicateOutputStartRow,
        outputRange: formData.duplicateOutputRange
      };
    }

    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!platform || !['openai','claude','gemini'].includes(platform)) {
      throw new Error('æœ‰åŠ¹ãªAIãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }
    if (!apiKey || !apiKey.trim()) {
      throw new Error('APIã‚­ãƒ¼ã¯å¿…é ˆã§ã™ã€‚');
    }
    if (!model || !model.trim()) {
      throw new Error('AIãƒ¢ãƒ‡ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }
    if (!sheetName || !sheetName.trim()) {
      throw new Error('ä½œæ¥­ã‚·ãƒ¼ãƒˆåã¯å¿…é ˆã§ã™ã€‚');
    }
    if (!['RATE','AMOUNT'].includes(profitCalc)) {
      throw new Error('åˆ©ç›Šè¨ˆç®—æ–¹æ³•ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }
    if (!['NORMAL','TAX_INCLUDED'].includes(priceDisplayMode)) {
      throw new Error('ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
    }

    // åŸºæœ¬è¨­å®šã®ä¿å­˜
    props.setProperty('AI_PLATFORM', platform);
    props.setProperty('AI_MODEL', model);
    if (platform === 'openai') props.setProperty('OPENAI_API_KEY', apiKey);
    if (platform === 'claude') props.setProperty('CLAUDE_API_KEY', apiKey);
    if (platform === 'gemini') props.setProperty('GEMINI_API_KEY', apiKey);

    props.setProperty('SHEET_NAME', sheetName);
    props.setProperty('PROFIT_CALC_METHOD', profitCalc);
    props.setProperty('PROMPT_ID', promptId);
    props.setProperty('SHIPPING_THRESHOLD', String(shippingThreshold));
    props.setProperty('SHIPPING_CALC_METHOD', shippingCalcMethod);
    props.setProperty('LOW_PRICE_SHIPPING_METHOD', lowPriceMethod);
    props.setProperty('HIGH_PRICE_SHIPPING_METHOD', highPriceMethod);
    props.setProperty('SHOW_POPUPS', showPopups);
    
    // DDUä¾¡æ ¼èª¿æ•´æ©Ÿèƒ½ã®ä¿å­˜
    props.setProperty('DDU_ADJUSTMENT_ENABLED', dduAdjustmentEnabled);
    props.setProperty('DDU_THRESHOLD', String(dduThreshold));
    props.setProperty('DDU_ADJUSTMENT_AMOUNT', String(dduAdjustment));
    
    // ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰ã®ä¿å­˜
    setPriceDisplayMode(priceDisplayMode);
    
    // é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®šã®ä¿å­˜
    if (duplicateCheckEnabled && duplicateSettings) {
      saveIntegratedDuplicateCheckSettings(duplicateSettings);
    } else {
      // ç„¡åŠ¹åŒ–
      props.setProperty('DUPLICATE_CHECK_ENABLED', 'false');
    }

    // ã‚·ã‚¹ãƒ†ãƒ è¨­å®š
    ensureSurchargeCellsOnWorkSheet();
    setupStopControlCell();

    // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
    var platformNames = { openai:'OpenAI', claude:'Claude (Anthropic)', gemini:'Gemini (Google)' };
    var lowPriceName = CONFIG.SHIPPING_METHOD_OPTIONS.lowPrice[lowPriceMethod].displayName;
    var highPriceName = CONFIG.SHIPPING_METHOD_OPTIONS.highPrice[highPriceMethod].displayName;
    var popupText = (showPopups === 'true') ? 'ON' : 'OFF';
    var dduText = (dduAdjustmentEnabled === 'true') ? 'ONï¼ˆ$' + dduThreshold + 'ä»¥ä¸Šã§$' + dduAdjustment + 'èª¿æ•´ï¼‰' : 'OFF';
    var priceText = (priceDisplayMode === 'TAX_INCLUDED') ? 'é–¢ç¨è¾¼ã¿ä¾¡æ ¼ï¼ˆDDPï¼‰' : 'è²©å£²ä¾¡æ ¼ï¼ˆDDUï¼‰';
    var duplicateText = duplicateCheckEnabled ? 'ON' : 'OFF';
    
    var msg = 'è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼\n\n' +
      'AIãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ : ' + platformNames[platform] + '\n' +
      'AIãƒ¢ãƒ‡ãƒ«: ' + model + '\n' +
      'ä½œæ¥­ã‚·ãƒ¼ãƒˆ: ' + sheetName + '\n' +
      'åˆ©ç›Šè¨ˆç®—: ' + (profitCalc === 'RATE' ? 'åˆ©ç›Šç‡' : 'åˆ©ç›Šé¡') + '\n' +
      'ä¾¡æ ¼è¡¨ç¤º: ' + priceText + '\n' +
      'é€æ–™è¨ˆç®—: ' + (shippingCalcMethod === 'TABLE' ? 'ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—' : 'å›ºå®šé‡‘é¡') + '\n' +
      'é€æ–™åˆ‡æ›¿åŸºæº–: ' + shippingThreshold + 'å††\n' +
      'ä½ä¾¡æ ¼é…é€: ' + lowPriceName + '\n' +
      'é«˜ä¾¡æ ¼é…é€: ' + highPriceName + '\n' +
      'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—: ' + popupText + '\n' +
      'DDUèª¿æ•´æ©Ÿèƒ½: ' + dduText + '\n' +
      'é‡è¤‡ãƒã‚§ãƒƒã‚¯: ' + duplicateText;
      
    if (showPopups === 'true') {
      ui.alert('è¨­å®šä¿å­˜', msg, ui.ButtonSet.OK);
    }
    
    return { success: true };
  } catch (e) {
    ui.alert('è¨­å®šä¿å­˜ã‚¨ãƒ©ãƒ¼', 'ã‚¨ãƒ©ãƒ¼: ' + e.message, ui.ButtonSet.OK);
    return { success: false, error: e.message };
  }
}
function saveIntegratedDuplicateCheckSettings(duplicateData) {
  try {
    var props = PropertiesService.getScriptProperties();
    
    // åŸºæœ¬è¨­å®šã®ä¿å­˜
    props.setProperty('DUPLICATE_CHECK_ENABLED', 'true');
    props.setProperty('DUPLICATE_CHECK_SOURCE_SHEET', duplicateData.sourceSheet);
    props.setProperty('DUPLICATE_CHECK_SOURCE_COLUMN', duplicateData.sourceColumn);
    props.setProperty('DUPLICATE_CHECK_TARGET_SHEETS', JSON.stringify(duplicateData.targetSheets));
    
    // å‡ºåŠ›è¨­å®šï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
    if (duplicateData.applyToSheet) {
      // é‡è¤‡ãƒã‚§ãƒƒã‚¯å¼ã‚’ã‚·ãƒ¼ãƒˆã«ç›´æ¥é©ç”¨
      var formData = {
        sourceSheet: duplicateData.sourceSheet,
        sourceColumn: duplicateData.sourceColumn,
        targetSheets: duplicateData.targetSheets,
        outputSheet: duplicateData.outputSheet,
        outputColumn: duplicateData.outputColumn,
        outputStartRow: duplicateData.outputStartRow,
        outputRange: duplicateData.outputRange
      };
      
      // æ—¢å­˜ã®é‡è¤‡ãƒã‚§ãƒƒã‚¯ä¿å­˜é–¢æ•°ã‚’å‘¼ã³å‡ºã—
      return saveDuplicateCheckSettings(formData);
    }
    
    return { success: true, message: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸ' };
  } catch (e) {
    return { success: false, error: e.message };
  }
}
/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠHTMLãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤ºï¼ˆä¿®æ­£ç‰ˆï¼‰
 * @return {string|null} é¸æŠã•ã‚ŒãŸã‚«ãƒ†ã‚´ãƒªãƒ¼ã€ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã¯null
 */
function showCategorySelectionDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('CategorySelectionDialog')
      .setWidth(480).setHeight(400);
    SpreadsheetApp.getUi().showModalDialog(html, 'ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠ');
    
    // ãƒ€ã‚¤ã‚¢ãƒ­ã‚°çµæœã‚’å¾…ã¤ï¼ˆéåŒæœŸå‡¦ç†ã®ãŸã‚ã€åˆ¥ã®ä»•çµ„ã¿ãŒå¿…è¦ï¼‰
    return null; // ã“ã®æˆ»ã‚Šå€¤ã¯ä½¿ç”¨ã•ã‚Œãªã„
    
  } catch (e) {
    console.error('ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚¨ãƒ©ãƒ¼: ' + e.message);
    showAlert('ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
    return null;
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ‰‹å‹•æ¤œç´¢æ©Ÿèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ‰‹å‹•æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showShippingPolicyManualSearchDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('ShippingPolicyManualSearch')
      .setWidth(600).setHeight(700);
    SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ” ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ‰‹å‹•æ¤œç´¢');
  } catch (e) {
    showAlert('æ‰‹å‹•æ¤œç´¢ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
  }
}

/**
 * æ‰‹å‹•ã§ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢ã™ã‚‹
 * @param {Object} searchData - æ¤œç´¢æ¡ä»¶ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆ
 * @return {Object} æ¤œç´¢çµæœ
 */
function searchShippingPolicyManually(searchData) {
  try {
    console.log('æ‰‹å‹•ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ¤œç´¢é–‹å§‹:', searchData);
    
    // å…¥åŠ›å€¤æ¤œè¨¼
    if (!searchData || typeof searchData !== 'object') {
      return { success: false, error: 'æ¤œç´¢æ¡ä»¶ãŒç„¡åŠ¹ã§ã™' };
    }
    
    var category = String(searchData.category || '').trim();
    var condition = String(searchData.condition || '').trim();
    var shippingType = String(searchData.shippingType || '').trim();
    var price = Number(searchData.price);
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (!category) {
      return { success: false, error: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼ã‚’é¸æŠã—ã¦ãã ã•ã„' };
    }
    
    if (!condition || !['æ–°å“', 'ä¸­å¤'].includes(condition)) {
      return { success: false, error: 'å•†å“çŠ¶æ…‹ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„' };
    }
    
    if (!shippingType || !['ã‚¨ã‚³ãƒãƒŸãƒ¼', 'EX'].includes(shippingType)) {
      return { success: false, error: 'é…é€æ–¹æ³•ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„' };
    }
    
    if (isNaN(price) || price < 0) {
      return { success: false, error: 'ä¾¡æ ¼ã‚’æ­£ã—ãå…¥åŠ›ã—ã¦ãã ã•ã„ï¼ˆ0ä»¥ä¸Šã®æ•°å€¤ï¼‰' };
    }
    
    // ã€è¿½åŠ ã€‘é–¢ç¨ç‡ã‚’è€ƒæ…®ã—ãŸèª¿æ•´å¾Œä¾¡æ ¼ã‚’è¨ˆç®—
    var settings = getSettings();
    if (!settings) {
      return { success: false, error: 'è¨­å®šãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
    }
    
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      return { success: false, error: 'ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
    }
    
    var adjustedPrice = calculateAdjustedPriceForPolicy(sheet, price);
    var adjustment = adjustedPrice - price;
    
    // ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢ï¼ˆèª¿æ•´å¾Œä¾¡æ ¼ã‚’ä½¿ç”¨ï¼‰
    var policyId = findShippingPolicyId(category, condition, shippingType, adjustedPrice);
    
    // ãƒãƒªã‚·ãƒ¼åç§°ã‚‚å–å¾—
    var policyName = null;
    if (policyId !== null) {
      var ss = SpreadsheetApp.getActiveSpreadsheet();
      var sheet = ss.getSheetByName('Policy_Master');
      if (sheet) {
        var data = sheet.getRange(2, 1, sheet.getLastRow() - 1, 2).getValues();
        for (var i = 0; i < data.length; i++) {
          if (data[i][0] === policyId) {
            policyName = data[i][1];
            break;
          }
        }
      }
    }
    
    // é€æ–™ä¸Šé™æƒ…å ±ã‚‚è¿½åŠ 
    var shippingLimit = getShippingLimitForCategory(category);
    
    console.log('æ¤œç´¢çµæœ:', policyId, policyName);
    
    return {
      success: true,
      policyId: policyId,
      policyName: policyName,
      shippingLimit: shippingLimit,
      originalPrice: price,              // ã€è¿½åŠ ã€‘å…ƒã®ä¾¡æ ¼
      adjustedPrice: adjustedPrice,      // ã€è¿½åŠ ã€‘èª¿æ•´å¾Œä¾¡æ ¼
      adjustment: adjustment,            // ã€è¿½åŠ ã€‘èª¿æ•´é¡
      searchConditions: {
        category: category,
        condition: condition,
        shippingType: shippingType,
        price: price
      }
    };
    
  } catch (error) {
    console.error('æ‰‹å‹•æ¤œç´¢ã‚¨ãƒ©ãƒ¼:', error);
    return { 
      success: false, 
      error: error.message || 'ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ¤œç´¢ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ' 
    };
  }
}

/**
 * ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼æ©Ÿèƒ½ã®ãƒ‡ãƒãƒƒã‚°æƒ…å ±ã‚’è¡¨ç¤º
 */
function debugShippingPolicyData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
   var sheet = ss.getSheetByName('Policy_Master');
    
    if (!sheet) {
      showAlert('Policy_Masterã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\nå…ˆã«ã€ŒğŸš¢ Policy_Master ã‚·ãƒ¼ãƒˆä½œæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    
    var lastRow = sheet.getLastRow();
    var report = 'Policy_Master ã‚·ãƒ¼ãƒˆç¢ºèª:\n\n';
    
    report += 'ç·ãƒ‡ãƒ¼ã‚¿æ•°: ' + (lastRow - 1) + 'ä»¶\n\n';
    
    // å„çµ„ã¿åˆã‚ã›ã®ä»¶æ•°ã‚’é›†è¨ˆ
    var counts = {
      'eco_new': 0,
      'eco_used': 0,
      'xp_new': 0,
      'xp_used': 0
    };
    
    var data = sheet.getRange(2, 1, lastRow - 1, 2).getValues();
    
    for (var i = 0; i < data.length; i++) {
      var name = String(data[i][1] || '');
      if (name.indexOf('_eco_new_') !== -1) counts['eco_new']++;
      else if (name.indexOf('_eco_used_') !== -1) counts['eco_used']++;
      else if (name.indexOf('_xp_new_') !== -1) counts['xp_new']++;
      else if (name.indexOf('_xp_used_') !== -1) counts['xp_used']++;
    }
    
    report += 'ã€çµ„ã¿åˆã‚ã›åˆ¥ä»¶æ•°ã€‘\n';
    report += 'ã‚¨ã‚³ãƒãƒŸãƒ¼ Ã— æ–°å“: ' + counts['eco_new'] + 'ä»¶\n';
    report += 'ã‚¨ã‚³ãƒãƒŸãƒ¼ Ã— ä¸­å¤: ' + counts['eco_used'] + 'ä»¶\n';
    report += 'EX Ã— æ–°å“: ' + counts['xp_new'] + 'ä»¶\n';
    report += 'EX Ã— ä¸­å¤: ' + counts['xp_used'] + 'ä»¶\n\n';
    
    report += 'ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆæœ€åˆã®5ä»¶ï¼‰ã€‘\n';
    for (var j = 0; j < Math.min(5, data.length); j++) {
      report += 'ID ' + data[j][0] + ': ' + data[j][1] + '\n';
    }
    
    showAlert(report, 'info');
    
  } catch (error) {
    showAlert('ãƒ‡ãƒãƒƒã‚°æƒ…å ±å–å¾—ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåˆ¤å®šæ©Ÿèƒ½ï¼ˆPolicy_Masterä½¿ç”¨ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠè‚¢ã‚’å–å¾—
 */
function getTemplateCategoryOptions() {
  return [
    { value: 'general', display: 'æ±ç”¨ï¼ˆé€æ–™ä¸Šé™ãªã—ï¼‰' },
    { value: 'videogames', display: 'Video Gamesï¼ˆé€æ–™ä¸Šé™$20ï¼‰' },
    { value: 'books', display: 'Booksï¼ˆé€æ–™ä¸Šé™$20ï¼‰' },
    { value: 'movies', display: 'Movies & TVï¼ˆé€æ–™ä¸Šé™$20ï¼‰' },
    { value: 'music', display: 'Musicï¼ˆé€æ–™ä¸Šé™$25ï¼‰' },
    { value: 'console', display: 'Video Game Consolesï¼ˆé€æ–™ä¸Šé™$50ï¼‰' },
    { value: 'card_graded', display: 'ãƒˆãƒ¬ã‚« - Graded' },
    { value: 'card_raw', display: 'ãƒˆãƒ¬ã‚« - æœªé‘‘å®š' },
    { value: 'preorder', display: 'äºˆç´„è²©å£²' }
  ];
}

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç§°ã‚’ç”Ÿæˆ
 * @param {string} category - ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆgeneral/videogames/books/movies/music/console/card_graded/card_raw/preorderï¼‰
 * @param {string} shippingType - é…é€ã‚¿ã‚¤ãƒ—ï¼ˆã‚¨ã‚³ãƒãƒŸãƒ¼/EXï¼‰
 * @param {string} condition - å•†å“çŠ¶æ…‹ï¼ˆæ–°å“/ä¸­å¤ï¼‰
 * @return {string|null} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç§°
 */
function generateTemplateName(category, shippingType, condition) {
  try {
    // é…é€ã‚¿ã‚¤ãƒ—ã‚’ç•¥ç§°ã«å¤‰æ›ï¼ˆå…¨ã‚«ãƒ†ã‚´ãƒªãƒ¼å…±é€šã§ä½¿ç”¨ï¼‰
    var shipping = (shippingType === 'ã‚¨ã‚³ãƒãƒŸãƒ¼') ? 'eco' : 
                   (shippingType === 'EX') ? 'xp' : null;
    
    if (!shipping) {
      console.error('é…é€ã‚¿ã‚¤ãƒ—ãŒç„¡åŠ¹: ' + shippingType);
      return null;
    }
    
    // ãƒˆãƒ¬ã‚«ã¯é…é€æ–¹æ³•ã§åˆ†ã‘ã‚‹ï¼ˆçŠ¶æ…‹ã¯ä¸ä½¿ç”¨ï¼‰
    if (category === 'card_graded') {
      return 'Template_card_graded_' + shipping;  // _eco or _xp
    }
    if (category === 'card_raw') {
      return 'Template_card_raw_' + shipping;  // _eco or _xp
    }
    
    // äºˆç´„è²©å£²ã‚‚é…é€æ–¹æ³•ã§åˆ†ã‘ã‚‹ï¼ˆçŠ¶æ…‹ã¯ä¸ä½¿ç”¨ï¼‰
    if (category === 'preorder') {
      return 'Template_preorder_' + shipping;
    }
    
    // ã“ã“ã‹ã‚‰çŠ¶æ…‹ãŒå¿…è¦ãªã‚«ãƒ†ã‚´ãƒªãƒ¼
    var cond = (condition === 'æ–°å“') ? 'new' : 
               (condition === 'ä¸­å¤') ? 'used' : null;
    
    if (!cond) {
      console.error('å•†å“çŠ¶æ…‹ãŒç„¡åŠ¹: ' + condition);
      return null;
    }
    
    // ã‚²ãƒ¼ãƒ ãƒ»æœ¬ã¯ limited ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
    if (category === 'videogames' || category === 'books') {
      return 'Template_limited_' + shipping + '_' + cond;
    }
    
    // ãã®ä»–ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆmovies, music, console, generalï¼‰ã¯æ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
    return 'Template_general_' + shipping + '_' + cond;
    
  } catch (e) {
    console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}
/**
 * æ–°å½¢å¼ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‹ã‚‰æ¨™æº–åã‚’ç”Ÿæˆ
 * @param {string} templateName - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåï¼ˆãƒˆãƒ¬ã‚«Graded/ãƒˆãƒ¬ã‚«æœªé‘‘å®š/ã‚²ãƒ¼ãƒ ãƒ»æœ¬/ä¸€èˆ¬æ±ç”¨/äºˆç´„è²©å£²ãªã©ï¼‰
 * @param {string} condition - å•†å“çŠ¶æ…‹ï¼ˆæ–°å“/ä¸­å¤ï¼‰
 * @param {string} shippingType - é…é€ã‚¿ã‚¤ãƒ—ï¼ˆã‚¨ã‚³ãƒãƒŸãƒ¼/EXï¼‰
 * @return {string|null} æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå
 */
function generateNewTemplateName(templateName, condition, shippingType) {
  try {
    // é…é€ã‚¿ã‚¤ãƒ—ã‚’ç•¥ç§°ã«å¤‰æ›
    var shipping = (shippingType === 'ã‚¨ã‚³ãƒãƒŸãƒ¼') ? 'eco' : 
                   (shippingType === 'EX') ? 'xp' : null;
    
    if (!shipping) {
      console.error('é…é€ã‚¿ã‚¤ãƒ—ãŒç„¡åŠ¹: ' + shippingType);
      return null;
    }
    
    // çŠ¶æ…‹ã‚’è‹±èªã«å¤‰æ›
    var cond = (condition === 'æ–°å“') ? 'new' : 
               (condition === 'ä¸­å¤') ? 'used' : null;
    
    if (!cond) {
      console.error('å•†å“çŠ¶æ…‹ãŒç„¡åŠ¹: ' + condition);
      return null;
    }
    
    // ã™ã¹ã¦çµ±ä¸€å½¢å¼ï¼šTemplate_ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå_çŠ¶æ…‹_é…é€æ–¹æ³•
    return 'Template_' + templateName + '_' + cond + '_' + shipping;
    
  } catch (e) {
    console.error('æ–°ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  Policy_Master ã‚­ãƒ£ãƒƒã‚·ãƒ³ã‚°ï¼ˆé«˜é€ŸåŒ–ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
/**
 * Policy_Masterã‚’èª­ã¿è¾¼ã‚“ã§ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½œæˆï¼ˆé«˜é€ŸåŒ–ç”¨ï¼‰
 * @return {Object} { templates: Map, policies: Array }
 */
function loadPolicyMasterCache_() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Policy_Master');

    if (!sheet) {
      console.error('Policy_Master ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return { templates: new Map(), policies: [] };
    }

    var lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      return { templates: new Map(), policies: [] };
    }

    var data = sheet.getRange(1, 1, lastRow, 3).getValues();
    var templateMap = new Map(); // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå â†’ ID
    var policiesArray = [];       // ãƒãƒªã‚·ãƒ¼é…åˆ—

    var inTemplateSection = false;
    var inPolicySection = false;

    for (var i = 0; i < data.length; i++) {
      var cellA = String(data[i][0] || '');

      // ã‚»ã‚¯ã‚·ãƒ§ãƒ³åˆ¤å®š
      if (cellA.indexOf('ã€Templatesã€‘') !== -1) {
        inTemplateSection = true;
        inPolicySection = false;
        i++; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚¹ã‚­ãƒƒãƒ—
        continue;
      }

      if (cellA.indexOf('ã€Shipping Policies') !== -1) {
        inTemplateSection = false;
        inPolicySection = true;
        i++; // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚¹ã‚­ãƒƒãƒ—
        continue;
      }

      // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿
      if (inTemplateSection) {
        var id = data[i][0];
        var name = String(data[i][1] || '');

        if (!name || cellA.indexOf('ã€') !== -1) {
          inTemplateSection = false;
          continue;
        }

        templateMap.set(name, typeof id === 'number' ? id : Number(id));
      }

      // ãƒãƒªã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿
      if (inPolicySection) {
        var policyId = data[i][0];
        var policyName = String(data[i][1] || '');
        var shippingFee = data[i][2];

        if (!policyName || cellA.indexOf('ã€') !== -1) {
          inPolicySection = false;
          continue;
        }

        policiesArray.push({
          id: policyId,
          name: policyName,
          shippingFee: typeof shippingFee === 'number' ? shippingFee : null
        });
      }
    }

    console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½œæˆ: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ' + templateMap.size + 'ä»¶, ãƒãƒªã‚·ãƒ¼' + policiesArray.length + 'ä»¶');
    return { templates: templateMap, policies: policiesArray };

  } catch (e) {
    console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½œæˆã‚¨ãƒ©ãƒ¼: ' + e.message);
    return { templates: new Map(), policies: [] };
  }
}

/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’æ¤œç´¢
 * @param {Map} templateCache ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚­ãƒ£ãƒƒã‚·ãƒ¥
 * @param {string} templateName ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå
 * @return {number|null} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID
 */
function findTemplateIdFromCache_(templateCache, templateName) {
  if (templateCache.has(templateName)) {
    return templateCache.get(templateName);
  }
  return null;
}

/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼IDã‚’æ¤œç´¢
 * @param {Array} policyCache ãƒãƒªã‚·ãƒ¼ã‚­ãƒ£ãƒƒã‚·ãƒ¥
 * @param {string} category ã‚«ãƒ†ã‚´ãƒªãƒ¼
 * @param {string} condition å•†å“çŠ¶æ…‹
 * @param {string} shippingType é…é€ã‚¿ã‚¤ãƒ—
 * @param {number} priceUSD ä¾¡æ ¼ï¼ˆUSDï¼‰
 * @return {number|null} ãƒãƒªã‚·ãƒ¼ID
 */
function findShippingPolicyIdFromCache_(policyCache, category, condition, shippingType, priceUSD) {
  try {
    var shippingLimit = getShippingLimitForCategory(category);
    var candidates = [];

    for (var i = 0; i < policyCache.length; i++) {
      var policy = policyCache[i];
      var parsed = parseShippingPolicyName(policy.name);

      if (!parsed) continue;

      // åŸºæœ¬æ¡ä»¶ãƒã‚§ãƒƒã‚¯
      if (parsed.condition !== condition) continue;
      if (parsed.shippingType !== shippingType) continue;
      if (priceUSD < parsed.minPrice || priceUSD > parsed.maxPrice) continue;

      // é€æ–™ä¸Šé™ãƒã‚§ãƒƒã‚¯
      if (shippingLimit !== null && policy.shippingFee !== null && policy.shippingFee > shippingLimit) {
        continue;
      }

      candidates.push(policy);
    }

    if (candidates.length === 0) {
      // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯æ¤œç´¢
      if (shippingLimit !== null) {
        return findFallbackPolicyFromCache_(policyCache, condition, shippingType, shippingLimit);
      }
      return null;
    }

    return candidates[0].id;

  } catch (e) {
    console.error('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ã®ãƒãƒªã‚·ãƒ¼æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}

/**
 * ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢
 */
function findFallbackPolicyFromCache_(policyCache, condition, shippingType, shippingLimit) {
  var maxAllowedPolicy = null;
  var maxAllowedFee = 0;

  for (var i = 0; i < policyCache.length; i++) {
    var policy = policyCache[i];
    var parsed = parseShippingPolicyName(policy.name);

    if (!parsed) continue;
    if (parsed.condition !== condition) continue;
    if (parsed.shippingType !== shippingType) continue;
    if (policy.shippingFee === null) continue;
    if (policy.shippingFee > shippingLimit) continue;

    if (policy.shippingFee > maxAllowedFee) {
      maxAllowedFee = policy.shippingFee;
      maxAllowedPolicy = policy;
    }
  }

  return maxAllowedPolicy ? maxAllowedPolicy.id : null;
}

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDã‚’æ¤œç´¢ï¼ˆPolicy_Masterã‹ã‚‰ï¼‰
 * @param {string} templateName - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç§°
 * @return {number|null} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID
 */
function findTemplateId(templateName) {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('Policy_Master');
    
    if (!sheet) {
      console.error('Policy_Master ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return null;
    }
    
    var lastRow = sheet.getLastRow();
    if (lastRow < 2) {
      return null;
    }
    
    // Templates ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã‚’æ¤œç´¢
    var data = sheet.getRange(1, 1, lastRow, 3).getValues();
    var templateSectionStart = -1;
    
    for (var i = 0; i < data.length; i++) {
      if (String(data[i][0]).indexOf('ã€Templatesã€‘') !== -1) {
        templateSectionStart = i + 2; // ãƒ˜ãƒƒãƒ€ãƒ¼ã®2è¡Œä¸‹ã‹ã‚‰ãƒ‡ãƒ¼ã‚¿é–‹å§‹
        break;
      }
    }
    
    if (templateSectionStart === -1) {
      console.error('Templates ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      return null;
    }
    
    // ğŸ”¹ ãƒ‡ãƒãƒƒã‚°ï¼šæ¤œç´¢å¯¾è±¡ã®åå‰ã‚’ãƒ­ã‚°å‡ºåŠ›
    console.log('ğŸ” æ¤œç´¢ã™ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå: "' + templateName + '"');
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¤œç´¢
    var foundTemplates = [];
    for (var j = templateSectionStart; j < data.length; j++) {
      var id = data[j][0];
      var name = String(data[j][1] || '');
      
      // ç©ºè¡Œã¾ãŸã¯æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã«åˆ°é”ã—ãŸã‚‰çµ‚äº†
      if (!name || String(data[j][0]).indexOf('ã€') !== -1) {
        break;
      }
      
      foundTemplates.push(name);
      
      if (name === templateName) {
        console.log('âœ… ãƒãƒƒãƒã—ã¾ã—ãŸï¼ ID: ' + id);
        return typeof id === 'number' ? id : Number(id);
      }
    }
    
    // ğŸ”¹ è¦‹ã¤ã‹ã‚‰ãªã‹ã£ãŸå ´åˆã€ãƒã‚¹ã‚¿ãƒ¼ã«ã‚ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä¸€è¦§ã‚’å‡ºåŠ›
    console.error('âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ "' + templateName + '" ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    console.error('ğŸ“‹ Policy_Masterã«ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ:');
    foundTemplates.forEach(function(t) {
      console.error('  - "' + t + '"');
    });
    
    return null;
    
  } catch (e) {
    console.error('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDæ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‹ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼çµ±åˆè¨­å®š
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * é¸æŠè¡Œã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‹ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®šï¼ˆçµ±åˆç‰ˆï¼‰
 */
function setTemplateAndPolicyForSelectedRows() {
  try {
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;

    var range = sheet.getActiveRange();
    if (!range) {
      showAlert('è¨­å®šã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚', 'info');
      return;
    }

    // é¸æŠç¯„å›²ã‚’ä¸€æ™‚ä¿å­˜
    var props = PropertiesService.getScriptProperties();
    props.setProperty('UNIFIED_SETTING_START_ROW', range.getRow().toString());
    props.setProperty('UNIFIED_SETTING_END_ROW', range.getLastRow().toString());
    
    // ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
    showUnifiedCategoryDialog();
    
  } catch (error) {
    showAlert('è¨­å®šã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠçµæœã‚’å‡¦ç†ã—ã¦ä¸¡æ–¹ã‚’è¨­å®š
 */
/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠçµæœã‚’å‡¦ç†ã—ã¦ä¸¡æ–¹ã‚’è¨­å®šï¼ˆ50è¡Œãƒãƒƒãƒå¯¾å¿œï¼‰
 */
function applyUnifiedSettings(selectedCategory, selectedTemplateName, templateMode, policyMode, manualPolicyId) {
  try {
    if (!selectedCategory) {
      showAlert('ã‚«ãƒ†ã‚´ãƒªãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warning');
      return;
    }
    
    if (templateMode === 'auto' && !selectedTemplateName) {
      showAlert('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warning');
      return;
    }
    
    if (policyMode === 'manual' && !manualPolicyId) {
      showAlert('æ‰‹å‹•ãƒãƒªã‚·ãƒ¼ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚', 'warning');
      return;
    }
    
    var settings = getSettings();
    if (!settings) return;
    
    var sheet = validateAndGetSheet();
    if (!sheet) return;

    var props = PropertiesService.getScriptProperties();
    var startRow = parseInt(props.getProperty('UNIFIED_SETTING_START_ROW'));
    var endRow = parseInt(props.getProperty('UNIFIED_SETTING_END_ROW'));
    
    props.deleteProperty('UNIFIED_SETTING_START_ROW');
    props.deleteProperty('UNIFIED_SETTING_END_ROW');

    if (isNaN(startRow) || isNaN(endRow)) {
      showAlert('å¯¾è±¡è¡Œã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', 'error');
      return;
    }

    // å¯¾è±¡è¡Œã‚’é…åˆ—åŒ–
    var targetRows = [];
    for (var row = startRow; row <= endRow; row++) {
      if (row >= 5) targetRows.push(row);
    }

    var successCount = 0;
    var errorCount = 0;
    var skippedCount = (endRow - startRow + 1) - targetRows.length;

    // 50è¡Œãšã¤ãƒãƒƒãƒå‡¦ç†
    var BATCH_SIZE = 50;
    for (var i = 0; i < targetRows.length; i += BATCH_SIZE) {
      var batch = targetRows.slice(i, Math.min(i + BATCH_SIZE, targetRows.length));
      
      var result = applyUnifiedSettingsBatch_(
        sheet, 
        batch, 
        selectedCategory, 
        selectedTemplateName, 
        templateMode, 
        policyMode, 
        manualPolicyId
      );
      
      successCount += result.successCount;
      errorCount += result.errorCount;
      
      Utilities.sleep(200);
    }

    var message = 'âœ… è¨­å®šå®Œäº†\n\n' +
      'æˆåŠŸ: ' + successCount + 'ä»¶\n' +
      'ã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶\n' +
      'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'ä»¶';
    
    showAlert(message, errorCount > 0 ? 'warning' : 'success');

  } catch (error) {
    showAlert('è¨­å®šé©ç”¨ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
  }
}

/**
 * 50è¡Œåˆ†ã®çµ±åˆè¨­å®šã‚’ä¸€æ‹¬å‡¦ç†ï¼ˆä¿®æ­£ç‰ˆ - ç©ºæ¬„è¾¼ã¿é«˜é€Ÿç‰ˆï¼‰
 * 
 * ã€ä¿®æ­£å†…å®¹ã€‘
 * ç©ºæ¬„ã®è¡Œã‚‚å«ã‚ãŸé…åˆ—ã‚’ä½œæˆã—ã¦ä¸€æ‹¬æ›¸ãè¾¼ã¿
 * â†’ ç¿»è¨³ãƒ»è¨ˆç®—å‡¦ç†ã¨åŒã˜ãƒ­ã‚¸ãƒƒã‚¯
 */
function applyUnifiedSettingsBatch_(sheet, batchRows, category, templateName, templateMode, policyMode, manualPolicyId) {
  var successCount = 0;
  var errorCount = 0;

  console.log('=== çµ±åˆè¨­å®šãƒãƒƒãƒé–‹å§‹: ' + batchRows.length + 'è¡Œ ===');

  // ğŸš€ Policy_Masterã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’1å›ã ã‘ä½œæˆï¼ˆé«˜é€ŸåŒ–ï¼‰
  var cache = loadPolicyMasterCache_();
  console.log('âœ… ã‚­ãƒ£ãƒƒã‚·ãƒ¥ä½œæˆå®Œäº†');

  // ========================================
  // å‰å‡¦ç†: æœ€å°è¡Œã¨æœ€å¤§è¡Œã‚’å–å¾—
  // ========================================
  var minRow = Math.min.apply(null, batchRows);
  var maxRow = Math.max.apply(null, batchRows);
  var rowCount = maxRow - minRow + 1;
  
  console.log('å‡¦ç†ç¯„å›²: ' + minRow + 'ã€œ' + maxRow + 'è¡Œï¼ˆ' + rowCount + 'è¡Œåˆ†ï¼‰');
  
  // batchRowsã‚’é«˜é€Ÿæ¤œç´¢ç”¨ã«ã‚»ãƒƒãƒˆåŒ–
  var batchRowsSet = {};
  for (var i = 0; i < batchRows.length; i++) {
    batchRowsSet[batchRows[i]] = true;
  }

  // ========================================
  // â‘  å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—ï¼ˆæœ€å°ã€œæœ€å¤§è¡Œã®ç¯„å›²ï¼‰
  // ========================================
  var priceValues = sheet.getRange(minRow, CONFIG.COLUMNS.PRICE, rowCount, 1).getValues();
  var conditionValues = sheet.getRange(minRow, CONFIG.COLUMNS.CONDITION, rowCount, 1).getValues();
  var methodValues = sheet.getRange(minRow, CONFIG.COLUMNS.METHOD, rowCount, 1).getValues();

  var templateData = [];
  var policyData = [];
  
  // ========================================
  // â‘¡ å„è¡Œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDãƒ»ãƒãƒªã‚·ãƒ¼IDã‚’è¨ˆç®—ï¼ˆç©ºæ¬„å«ã‚€ï¼‰
  // ========================================
  for (var row = minRow; row <= maxRow; row++) {
    var rowIndex = row - minRow;
    
    // ã“ã®è¡ŒãŒå‡¦ç†å¯¾è±¡ã‹ãƒã‚§ãƒƒã‚¯
    if (!batchRowsSet[row]) {
      // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼ˆç©ºæ¬„ï¼‰
      templateData.push(['']);
      policyData.push(['']);
      continue;
    }
    
    // ãƒ‡ãƒ¼ã‚¿ã‚ã‚Š â†’ å‡¦ç†
    var priceUSD = Number(priceValues[rowIndex][0]);
    var condition = String(conditionValues[rowIndex][0] || '').trim();
    var shippingMethod = String(methodValues[rowIndex][0] || '').trim();
    
    console.log('è¡Œ' + row + ': ä¾¡æ ¼=' + priceUSD + ', çŠ¶æ…‹=' + condition + ', é…é€=' + shippingMethod);
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (isNaN(priceUSD) || priceUSD <= 0) {
      console.log('  âŒ ä¾¡æ ¼ãŒç„¡åŠ¹');
      templateData.push(['ã‚¨ãƒ©ãƒ¼']);
      policyData.push(['ã‚¨ãƒ©ãƒ¼']);
      errorCount++;
      continue;
    }
    
    if (!condition || !['æ–°å“', 'ä¸­å¤'].includes(condition)) {
      console.log('  âŒ å•†å“çŠ¶æ…‹ãŒç„¡åŠ¹');
      templateData.push(['ã‚¨ãƒ©ãƒ¼']);
      policyData.push(['ã‚¨ãƒ©ãƒ¼']);
      errorCount++;
      continue;
    }
    
    var shippingType = convertShippingMethodToType(shippingMethod);
    if (shippingType === 'ã‚¨ãƒ©ãƒ¼') {
      console.log('  âŒ é…é€æ–¹æ³•ãŒç„¡åŠ¹');
      templateData.push(['ã‚¨ãƒ©ãƒ¼']);
      policyData.push(['ã‚¨ãƒ©ãƒ¼']);
      errorCount++;
      continue;
    }
    
    var adjustedPrice = calculateAdjustedPriceForPolicy(sheet, priceUSD);
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†
    if (templateMode === 'auto') {
      var standardName = generateNewTemplateName(templateName, condition, shippingType);
      console.log('  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ¨™æº–å: ' + standardName);

      if (!standardName) {
        templateData.push(['ã‚¨ãƒ©ãƒ¼']);
        console.log('  âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç”Ÿæˆå¤±æ•—');
      } else {
        // ğŸš€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æ¤œç´¢ï¼ˆé«˜é€ŸåŒ–ï¼‰
        var templateId = findTemplateIdFromCache_(cache.templates, standardName);
        if (templateId !== null) {
          templateData.push([templateId]);
          console.log('  âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID: ' + templateId);
        } else {
          templateData.push(['è©²å½“ãªã—']);
          console.log('  âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„');
        }
      }
    } else {
      templateData.push(['']); // manualãƒ¢ãƒ¼ãƒ‰ã¯ç©ºç™½
    }

    // ãƒãƒªã‚·ãƒ¼å‡¦ç†
    var policyId;
    if (policyMode === 'manual') {
      // ğŸ”¹ æ‰‹å‹•ãƒãƒªã‚·ãƒ¼é¸æŠ
      policyId = Number(manualPolicyId);
      console.log('  æ‰‹å‹•ãƒãƒªã‚·ãƒ¼ID: ' + policyId);
    } else {
      // è‡ªå‹•åˆ¤å®š
      var policyCategory = getCategoryForShippingPolicy(category);
      // ğŸš€ ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‹ã‚‰æ¤œç´¢ï¼ˆé«˜é€ŸåŒ–ï¼‰
      policyId = findShippingPolicyIdFromCache_(cache.policies, policyCategory, condition, shippingType, adjustedPrice);
      console.log('  è‡ªå‹•ãƒãƒªã‚·ãƒ¼ID: ' + policyId);
    }
    
    if (policyId !== null && !isNaN(policyId)) {
      policyData.push([policyId]);
      successCount++;
      console.log('  âœ… ãƒãƒªã‚·ãƒ¼ID: ' + policyId);
    } else {
      policyData.push(['è©²å½“ãªã—']);
      errorCount++;
      console.log('  âš ï¸ ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„');
    }
  }
  
  // ========================================
  // â‘¢ çµæœã‚’ä¸€æ‹¬æ›¸ãè¾¼ã¿ï¼ˆç©ºæ¬„å«ã‚€å…¨ç¯„å›²ï¼‰
  // ========================================
  if (templateMode === 'auto') {
    sheet.getRange(minRow, 5, rowCount, 1).setValues(templateData);
    console.log('ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDä¸€æ‹¬æ›¸ãè¾¼ã¿å®Œäº†ï¼ˆ' + minRow + 'ã€œ' + maxRow + 'è¡Œï¼‰');
  }
  sheet.getRange(minRow, CONFIG.COLUMNS.SHIPPING_POLICY, rowCount, 1).setValues(policyData);
  console.log('ãƒãƒªã‚·ãƒ¼IDä¸€æ‹¬æ›¸ãè¾¼ã¿å®Œäº†ï¼ˆ' + minRow + 'ã€œ' + maxRow + 'è¡Œï¼‰');
  
  console.log('=== çµ±åˆè¨­å®šãƒãƒƒãƒå®Œäº† ===');
  
  return { successCount: successCount, errorCount: errorCount };
}
/**
 * 1è¡Œã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‹ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã‚’è¨­å®š
 */
function setUnifiedSettingsToRow(sheet, row, category, templateName, templateMode, policyMode, manualPolicyId) {
  var templateSuccess = true;
  var policySuccess = true;
  var templateError = '';
  var policyError = '';
  
  try {
    var priceUSD = Number(sheet.getRange(row, CONFIG.COLUMNS.PRICE).getValue());
    var condition = String(sheet.getRange(row, CONFIG.COLUMNS.CONDITION).getValue() || '').trim();
    var shippingMethod = String(sheet.getRange(row, CONFIG.COLUMNS.METHOD).getValue() || '').trim();
    
    // é–¢ç¨ç‡ã‚’è€ƒæ…®ã—ãŸèª¿æ•´å¾Œä¾¡æ ¼ã‚’è¨ˆç®—
    var adjustedPrice = calculateAdjustedPriceForPolicy(sheet, priceUSD);
    
    // ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
    if (isNaN(priceUSD) || priceUSD <= 0) {
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
      if (templateMode === 'auto') {
        sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');
      }
      return { success: false, error: 'ä¾¡æ ¼ãŒç„¡åŠ¹' };
    }
    
    if (!condition || !['æ–°å“', 'ä¸­å¤'].includes(condition)) {
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
      if (templateMode === 'auto') {
        sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');
      }
      return { success: false, error: 'å•†å“çŠ¶æ…‹ãŒç„¡åŠ¹' };
    }
    
    var shippingType = convertShippingMethodToType(shippingMethod);
    if (shippingType === 'ã‚¨ãƒ©ãƒ¼') {
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
      if (templateMode === 'auto') {
        sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');
      }
      return { success: false, error: 'é…é€æ–¹æ³•ãŒç„¡åŠ¹ï¼ˆè‡ªå‹•é¸æŠã¯ä¸å¯ï¼‰' };
    }
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ï¼ˆautoãƒ¢ãƒ¼ãƒ‰ã®æ™‚ã ã‘ï¼‰
    if (templateMode === 'auto') {
      try {
        console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        console.log('è¡Œ' + row + ': ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†é–‹å§‹');
        console.log('  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå: ' + templateName);
        console.log('  çŠ¶æ…‹: ' + condition);
        console.log('  é…é€: ' + shippingType);
        
        var standardName = generateNewTemplateName(templateName, condition, shippingType);
        console.log('  ç”Ÿæˆã•ã‚ŒãŸæ¨™æº–å: ' + standardName);
        
        if (!standardName) {
          sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');
          templateSuccess = false;
          templateError = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç”Ÿæˆå¤±æ•—';
          console.log('  âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåç”Ÿæˆå¤±æ•—');
        } else {
          var templateId = findTemplateId(standardName);
          if (templateId !== null) {
            sheet.getRange(row, 5).setValue(templateId);
            console.log('  âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDè¨­å®š: ' + templateId);
          } else {
            sheet.getRange(row, 5).setValue('è©²å½“ãªã—');
            templateSuccess = false;
            templateError = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚‰ãªã„: ' + standardName;
            console.log('  âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
          }
        }
      } catch (e) {
        sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');
        templateSuccess = false;
        templateError = 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e.message;
        console.log('  âŒ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e.message);
      }
    }
    // manualãƒ¢ãƒ¼ãƒ‰ãªã‚‰Eåˆ—ã¯ä½•ã‚‚æ›¸ã‹ãªã„
    
    // ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼å‡¦ç†
    console.log('è¡Œ' + row + ': ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼å‡¦ç†é–‹å§‹');
    console.log('  ãƒãƒªã‚·ãƒ¼ãƒ¢ãƒ¼ãƒ‰: ' + policyMode);
    
    try {
      var policyId;
      
      if (policyMode === 'manual') {
        // ğŸ”¹ æ‰‹å‹•ãƒãƒªã‚·ãƒ¼é¸æŠ
        console.log('  æ‰‹å‹•ãƒãƒªã‚·ãƒ¼ID: ' + manualPolicyId);
        policyId = Number(manualPolicyId);
      } else {
        // è‡ªå‹•åˆ¤å®š
        var policyCategory = getCategoryForShippingPolicy(category);
        console.log('  ãƒãƒªã‚·ãƒ¼ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + policyCategory);
        console.log('  èª¿æ•´å¾Œä¾¡æ ¼: ' + adjustedPrice);
        
        policyId = findShippingPolicyId(policyCategory, condition, shippingType, adjustedPrice);
      }
      
      if (policyId !== null && !isNaN(policyId)) {
        sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue(policyId);
        console.log('  âœ… ãƒãƒªã‚·ãƒ¼IDè¨­å®š: ' + policyId);
      } else {
        sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('è©²å½“ãªã—');
        policySuccess = false;
        policyError = 'ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚‰ãªã„';
        console.log('  âŒ ãƒãƒªã‚·ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
      }
    } catch (e) {
      sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
      policySuccess = false;
      policyError = 'ãƒãƒªã‚·ãƒ¼å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e.message;
      console.log('  âŒ ãƒãƒªã‚·ãƒ¼å‡¦ç†ã‚¨ãƒ©ãƒ¼: ' + e.message);
    }
    
    // ä¸¡æ–¹ã®çµæœã‚’ç·åˆåˆ¤å®š
    var success = (templateMode === 'manual' ? true : templateSuccess) && policySuccess;
    var errorMsg = '';
    if (!templateSuccess && templateMode === 'auto') {
      errorMsg += 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ' + templateError;
    }
    if (!policySuccess) {
      if (errorMsg) errorMsg += ' / ';
      errorMsg += 'ãƒãƒªã‚·ãƒ¼: ' + policyError;
    }
    
    console.log('è¡Œ' + row + ': å‡¦ç†å®Œäº† - success=' + success + (errorMsg ? ', error=' + errorMsg : ''));
    console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
    
    return { 
      success: success, 
      error: errorMsg || null 
    };
    
  } catch (error) {
    console.log('âŒ äºˆæœŸã—ãªã„ã‚¨ãƒ©ãƒ¼ (è¡Œ' + row + '): ' + error.message);
    sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).setValue('ã‚¨ãƒ©ãƒ¼');
    if (templateMode === 'auto') {
      sheet.getRange(row, 5).setValue('ã‚¨ãƒ©ãƒ¼');
    }
    return { success: false, error: error.message };
  }
}
/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å¤‰æ›
 * @param {string} category - å…ƒã®ã‚«ãƒ†ã‚´ãƒªãƒ¼å€¤
 * @return {string} ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼
 */
function getCategoryForTemplate(category) {
  // ãƒˆãƒ¬ã‚«ã¯ãã®ã¾ã¾ï¼ˆé…é€æ–¹æ³•ã§åˆ†ã‘ã‚‹ãŸã‚ï¼‰
  if (category === 'card_graded' || category === 'card_raw') {
    return category;
  }
  
  // äºˆç´„è²©å£²ã‚‚ãã®ã¾ã¾ï¼ˆé…é€æ–¹æ³•ã§åˆ†ã‘ã‚‹ãŸã‚ï¼‰
  if (category === 'preorder') {
    return 'preorder';
  }
  
  // ã‚²ãƒ¼ãƒ ãƒ»æœ¬ã¯ limited ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
  if (category === 'videogames' || category === 'books') {
    return 'limited';
  }
  
  // ãã®ä»–ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼ˆmovies, music, console, generalï¼‰ã¯æ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä½¿ç”¨
  return 'general';
}

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚«ãƒ†ã‚´ãƒªãƒ¼ã‹ã‚‰ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ç”¨ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«å¤‰æ›
 */
function getCategoryForShippingPolicy(templateCategory) {
  var mapping = {
    'videogames': 'Video Games',
    'books': 'Books',
    'movies': 'Movies & TV',
    'music': 'Music',
    'console': 'Video Game Consoles',
    'general': 'Other',
    'card_graded': 'Other',
    'card_raw': 'Other',
    'preorder': 'Other'
  };
  
  return mapping[templateCategory] || 'Other';
}


/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼è¡¨ç¤ºåã‚’å–å¾—
 */
function getCategoryDisplayName(categoryValue) {
  var options = getTemplateCategoryOptions();
  for (var i = 0; i < options.length; i++) {
    if (options[i].value === categoryValue) {
      return options[i].display;
    }
  }
  return categoryValue;
}

/**
 * çµ±åˆã‚«ãƒ†ã‚´ãƒªãƒ¼é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showUnifiedCategoryDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('UnifiedCategoryDialog')
      .setWidth(550).setHeight(650);
    SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ“‹ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‹ãƒãƒªã‚·ãƒ¼è¨­å®š');
  } catch (e) {
    showAlert('ãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã®è¡¨ç¤ºã«å¤±æ•—: ' + e.message, 'error');
  }
}
/**
 * è‡ªå‹•å‡ºåŠ›ï¼šO1ã¨O2ã®å€¤ã‚’ä½¿ç”¨ã—ã¦è‡ªå‹•å‡¦ç†
 */
function autoApplyTemplateAndPolicy() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var sheet = ss.getSheetByName('ä½œæ¥­ã‚·ãƒ¼ãƒˆ');
    
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“', 'error');
      return;
    }
    
    // 1. O1ã¨O2ã®å€¤ã‚’å–å¾—
    var categoryDisplay = sheet.getRange('O1').getValue();
    var templateName = sheet.getRange('O2').getValue();
    
    if (!categoryDisplay || !templateName) {
      showAlert('O1ï¼ˆã‚«ãƒ†ã‚´ãƒªãƒ¼ï¼‰ã¾ãŸã¯O2ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåï¼‰ãŒè¨­å®šã•ã‚Œã¦ã„ã¾ã›ã‚“', 'error');
      return;
    }
    
    // æ—¥æœ¬èªè¡¨ç¤ºã‚’å†…éƒ¨å€¤ã«å¤‰æ›
    var category = convertCategoryDisplayToValue(categoryDisplay);
    
    // 2. é¸æŠç¯„å›²ã‚’å–å¾—
    var range = sheet.getActiveRange();
    
    if (!range) {
      showAlert('ã‚»ãƒ«ç¯„å›²ã‚’é¸æŠã—ã¦ãã ã•ã„', 'error');
      return;
    }
    
    var startRow = range.getRow();
    var endRow = range.getLastRow();
    var numRows = endRow - startRow + 1;
    
    // 3. ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨­å®šã‚’ç¢ºèª
    var settings = getSettings();
    var showPopups = settings ? settings.showPopups === 'true' : false;
    
    if (showPopups) {
      // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
      var ui = SpreadsheetApp.getUi();
      var response = ui.alert(
        'è‡ªå‹•å‡ºåŠ›ç¢ºèª',
        'ä»¥ä¸‹ã®è¨­å®šã§å‡¦ç†ã—ã¾ã™ï¼š\n\n' +
        'ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + categoryDisplay + '\n' +
        'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ' + templateName + '\n' +
        'å‡¦ç†ç¯„å›²: ' + numRows + 'è¡Œï¼ˆè¡Œ' + startRow + 'ï½' + endRow + 'ï¼‰\n\n' +
        'ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
        ui.ButtonSet.YES_NO
      );
      
      if (response !== ui.Button.YES) {
        showAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸ', 'info');
        return;
      }
    }
    
    // 4. å¯¾è±¡è¡Œã‚’é…åˆ—åŒ–ï¼ˆ5è¡Œç›®ä»¥é™ï¼‹Rãƒ»Xãƒ»ACåˆ—ã™ã¹ã¦ã«ãƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼‰âœ… ä¿®æ­£ç®‡æ‰€
    var targetRows = [];
    
    // Råˆ—ã€Xåˆ—ã€ACåˆ—ã®ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬å–å¾—ï¼ˆåŠ¹ç‡åŒ–ï¼‰
    var checkStartRow = Math.max(5, startRow);
    var rRange = sheet.getRange('R' + checkStartRow + ':R' + endRow).getValues();
    var xRange = sheet.getRange('X' + checkStartRow + ':X' + endRow).getValues();
    var acRange = sheet.getRange('AC' + checkStartRow + ':AC' + endRow).getValues();
    
    for (var row = startRow; row <= endRow; row++) {
      if (row >= 5) {
        var dataIndex = row - checkStartRow;  // é…åˆ—ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹è¨ˆç®—
        var rValue = rRange[dataIndex][0];
        var xValue = xRange[dataIndex][0];
        var acValue = acRange[dataIndex][0];
        
        // Råˆ—ã€Xåˆ—ã€ACåˆ—ã®3ã¤ã™ã¹ã¦ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚‹å ´åˆã®ã¿å‡¦ç†å¯¾è±¡
        if (rValue !== null && rValue !== '' &&
            xValue !== null && xValue !== '' &&
            acValue !== null && acValue !== '') {
          targetRows.push(row);
        }
      }
    }
    
    // å¯¾è±¡è¡ŒãŒ0ä»¶ã®å ´åˆ
    if (targetRows.length === 0) {
      showAlert('å‡¦ç†å¯¾è±¡ã®ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“\nï¼ˆRåˆ—ãƒ»Xåˆ—ãƒ»ACåˆ—ã®ã„ãšã‚Œã‹ãŒç©ºç™½ï¼‰', 'info');
      return;
    }
    
    var successCount = 0;
    var errorCount = 0;
    var skippedCount = (endRow - startRow + 1) - targetRows.length;
    
    // 5. 50è¡Œãšã¤ãƒãƒƒãƒå‡¦ç†
    var BATCH_SIZE = 50;
    for (var i = 0; i < targetRows.length; i += BATCH_SIZE) {
      var batch = targetRows.slice(i, Math.min(i + BATCH_SIZE, targetRows.length));
      
      var result = applyUnifiedSettingsBatch_(
        sheet,
        batch,
        category,
        templateName,
        'auto',  // templateMode: è‡ªå‹•
        'auto',  // policyMode: è‡ªå‹•
        null     // manualPolicyId: è‡ªå‹•ãƒ¢ãƒ¼ãƒ‰ãªã®ã§null
      );
      
      successCount += result.successCount;
      errorCount += result.errorCount;
      
      Utilities.sleep(200);
    }
    
    // 6. çµæœè¡¨ç¤ºï¼ˆãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¨­å®šã«é–¢ã‚ã‚‰ãšè¡¨ç¤ºï¼‰
    if (showPopups) {
      var message = 'âœ… è‡ªå‹•å‡ºåŠ›å®Œäº†\n\n' +
        'æˆåŠŸ: ' + successCount + 'ä»¶\n' +
        'ã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶\n' +
        'ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'ä»¶ï¼ˆç©ºç™½è¡Œãƒ»ãƒ‡ãƒ¼ã‚¿ä¸è¶³å«ã‚€ï¼‰\n\n' +
        'ã‚«ãƒ†ã‚´ãƒªãƒ¼: ' + categoryDisplay + '\n' +
        'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ' + templateName;
      
      showAlert(message, errorCount > 0 ? 'warning' : 'success');
    }
    
  } catch (e) {
    // ã‚¨ãƒ©ãƒ¼ã¯å¸¸ã«è¡¨ç¤º
    showAlert('ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆ
 */
function createImportSheets() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    
    // Import_Templatesã‚·ãƒ¼ãƒˆä½œæˆ
    var templateSheet = ss.getSheetByName('Import_Templates');
    if (templateSheet) {
      var response = SpreadsheetApp.getUi().alert(
        'ã‚·ãƒ¼ãƒˆä½œæˆç¢ºèª',
        'Import_Templatesã‚·ãƒ¼ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\næ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
        SpreadsheetApp.getUi().ButtonSet.YES_NO
      );
      if (response === SpreadsheetApp.getUi().Button.YES) {
        ss.deleteSheet(templateSheet);
      } else {
        return;
      }
    }
    
    // Import_Policiesã‚·ãƒ¼ãƒˆä½œæˆ
    var policySheet = ss.getSheetByName('Import_Policies');
    if (policySheet) {
      var response2 = SpreadsheetApp.getUi().alert(
        'ã‚·ãƒ¼ãƒˆä½œæˆç¢ºèª',
        'Import_Policiesã‚·ãƒ¼ãƒˆã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚\næ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¦å†ä½œæˆã—ã¾ã™ã‹ï¼Ÿ',
        SpreadsheetApp.getUi().ButtonSet.YES_NO
      );
      if (response2 === SpreadsheetApp.getUi().Button.YES) {
        ss.deleteSheet(policySheet);
      } else {
        return;
      }
    }
    
    // Import_Templatesã‚·ãƒ¼ãƒˆä½œæˆ
    setupImportTemplatesSheet(ss);
    
    // Import_Policiesã‚·ãƒ¼ãƒˆä½œæˆ
    setupImportPoliciesSheet(ss);
    
    // ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰è¡¨ç¤º
    showImportGuide();
    
  } catch (e) {
    showAlert('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆä½œæˆã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * Import_Templatesã‚·ãƒ¼ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 */
function setupImportTemplatesSheet(ss) {
  var sheet = ss.insertSheet('Import_Templates');
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  sheet.getRange('A1').setValue('Template ID');
  sheet.getRange('B1').setValue('æ—¥æœ¬èªå');
  sheet.getRange('C1').setValue('è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸæ¨™æº–åï¼ˆç¢ºèªç”¨ï¼‰');
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼æ›¸å¼
  sheet.getRange('A1:C1').setFontWeight('bold').setBackground('#4285f4').setFontColor('white');
  
  // åˆ—å¹…è¨­å®š
  sheet.setColumnWidth(1, 100); // Aåˆ—
  sheet.setColumnWidth(2, 300); // Båˆ—
  sheet.setColumnWidth(3, 350); // Cåˆ—
  
  // ã‚µãƒ³ãƒ—ãƒ«è¡Œ
  sheet.getRange('A2').setValue('ï¼ˆä¾‹ï¼‰982');
  sheet.getRange('B2').setValue('æ–°å“ã€€ã‚¨ã‚³ãƒãƒŸãƒ¼');
  sheet.getRange('A3').setValue('ï¼ˆä¾‹ï¼‰1002');
  sheet.getRange('B3').setValue('ãƒˆãƒ¬ã‚«ã€€Gradedï¼ˆé‘‘å®šæ¸ˆã¿ï¼‰');
  
  // èª¬æ˜
  sheet.getRange('A5').setValue('ã€å…¥åŠ›æ–¹æ³•ã€‘');
  sheet.getRange('A6').setValue('1. Aåˆ—ã«ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆIDï¼ˆeBayã§ä½¿ã£ã¦ã„ã‚‹ç•ªå·ï¼‰ã‚’å…¥åŠ›');
  sheet.getRange('A7').setValue('2. Båˆ—ã«æ—¥æœ¬èªåã‚’å…¥åŠ›');
  sheet.getRange('A8').setValue('3. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã€ã‚’å®Ÿè¡Œã™ã‚‹ã¨Cåˆ—ã«æ¨™æº–åãŒè‡ªå‹•ç”Ÿæˆã•ã‚Œã¾ã™');
  sheet.getRange('A9').setValue('4. ç¢ºèªå¾Œã€ã€ŒPolicy_Masterã«åæ˜ ã€ã§ç¢ºå®š');
  
  sheet.getRange('A5:A9').setFontWeight('bold');
}

/**
 * Import_Policiesã‚·ãƒ¼ãƒˆã®ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
 */
function setupImportPoliciesSheet(ss) {
  var sheet = ss.insertSheet('Import_Policies');
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼è¨­å®š
  sheet.getRange('A1').setValue('Policy ID');
  sheet.getRange('B1').setValue('ãƒãƒªã‚·ãƒ¼å');
  sheet.getRange('C1').setValue('é€æ–™ï¼ˆUSDï¼‰');
  
  // ãƒ˜ãƒƒãƒ€ãƒ¼æ›¸å¼
  sheet.getRange('A1:C1').setFontWeight('bold').setBackground('#34a853').setFontColor('white');
  
  // åˆ—å¹…è¨­å®š
  sheet.setColumnWidth(1, 100); // Aåˆ—
  sheet.setColumnWidth(2, 350); // Båˆ—
  sheet.setColumnWidth(3, 100); // Cåˆ—
  
  // ã‚µãƒ³ãƒ—ãƒ«è¡Œ
  sheet.getRange('A2').setValue('ï¼ˆä¾‹ï¼‰5001');
  sheet.getRange('B2').setValue('Egl_202510_eco_new_0001_0025');
  
  // èª¬æ˜
  sheet.getRange('A4').setValue('ã€å…¥åŠ›æ–¹æ³•ã€‘');
  sheet.getRange('A5').setValue('1. Aåˆ—ã«ãƒãƒªã‚·ãƒ¼IDï¼ˆeBayã§ä½¿ã£ã¦ã„ã‚‹ç•ªå·ï¼‰ã‚’å…¥åŠ›');
  sheet.getRange('A6').setValue('2. Båˆ—ã«ãƒãƒªã‚·ãƒ¼åï¼ˆeBayã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰ã‚’å…¥åŠ›');
  sheet.getRange('A7').setValue('3. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã€ã‚’å®Ÿè¡Œã™ã‚‹ã¨Cåˆ—ã«é€æ–™ãŒè‡ªå‹•è¨ˆç®—ã•ã‚Œã¾ã™');
  sheet.getRange('A8').setValue('4. é€æ–™ã¯ä¾¡æ ¼å¸¯ã‹ã‚‰è‡ªå‹•è¨ˆç®—ï¼š25ãƒ‰ãƒ«ã”ã¨ã«5ãƒ‰ãƒ«è¿½åŠ ï¼ˆåŸºæœ¬15ãƒ‰ãƒ«ï¼‰');
  
  sheet.getRange('A4:A8').setFontWeight('bold');
}

/**
 * ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¬ã‚¤ãƒ‰ã‚’è¡¨ç¤º
 */
function showImportGuide() {
  var guide = 
    'ğŸ“¥ ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¾ã—ãŸ\n\n' +
    'ã€æ‰‹é †ã€‘\n\n' +
    '1ï¸âƒ£ Import_Templates ã‚·ãƒ¼ãƒˆ\n' +
    '   â€¢ Aåˆ—: ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆID\n' +
    '   â€¢ Båˆ—: æ—¥æœ¬èªåï¼ˆä¾‹: æ–°å“ã€€ã‚¨ã‚³ãƒãƒŸãƒ¼ï¼‰\n\n' +
    '2ï¸âƒ£ Import_Policies ã‚·ãƒ¼ãƒˆ\n' +
    '   â€¢ Aåˆ—: ãƒãƒªã‚·ãƒ¼ID\n' +
    '   â€¢ Båˆ—: ãƒãƒªã‚·ãƒ¼åï¼ˆeBayã‹ã‚‰ã‚³ãƒ”ãƒ¼ï¼‰\n\n' +
    '3ï¸âƒ£ ãƒ‡ãƒ¼ã‚¿å…¥åŠ›å¾Œ\n' +
    '   â€¢ ãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’ã€Œãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ã€ã§ç¢ºèª\n' +
    '   â€¢ ãƒ¡ãƒ‹ãƒ¥ãƒ¼â†’ã€ŒPolicy_Masterã«åæ˜ ã€ã§ç¢ºå®š\n\n' +
    'ğŸ’¡ å„ã‚·ãƒ¼ãƒˆã«è©³ã—ã„èª¬æ˜ãŒã‚ã‚Šã¾ã™';
  
  showAlert(guide, 'success');
}

/**
 * æ—¥æœ¬èªåã‹ã‚‰æ¨™æº–ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã‚’ç”Ÿæˆï¼ˆæ–°å½¢å¼å¯¾å¿œï¼‰
 */
function generateStandardTemplateName(japaneseName) {
  try {
    var name = String(japaneseName || '').trim();
    if (!name) return null;
    
    // é…é€ã‚¿ã‚¤ãƒ—åˆ¤å®šã¨å‰Šé™¤
    var shipping = null;
    var nameWithoutShipping = name;
    
    if (name.match(/ã‚¨ã‚³ãƒãƒŸãƒ¼|[Ee]conomy|å°å½¢åŒ…è£…ç‰©|[Ss]mall.*[Pp]acket/)) {
      shipping = 'eco';
      nameWithoutShipping = name.replace(/ã‚¨ã‚³ãƒãƒŸãƒ¼|[Ee]conomy|å°å½¢åŒ…è£…ç‰©|[Ss]mall.*[Pp]acket/g, '').trim();
    } else if (name.match(/ã‚¯ãƒ¼ãƒªã‚¨|ã‚¯ãƒªã‚¨|XP|é€Ÿé”|[Ee]xpress/)) {
      shipping = 'xp';
      nameWithoutShipping = name.replace(/ã‚¯ãƒ¼ãƒªã‚¨|ã‚¯ãƒªã‚¨|XP|é€Ÿé”|[Ee]xpress/g, '').trim();
    }
    
    if (!shipping) {
      console.error('é…é€ã‚¿ã‚¤ãƒ—ãŒåˆ¤å®šã§ãã¾ã›ã‚“: ' + name);
      return null;
    }
    
    // çŠ¶æ…‹åˆ¤å®šã¨å‰Šé™¤
    var condition = null;
    var templateName = nameWithoutShipping;
    
    if (nameWithoutShipping.match(/æ–°å“|[Nn]ew/)) {
      condition = 'new';
      templateName = nameWithoutShipping.replace(/æ–°å“|[Nn]ew/g, '').trim();
    } else if (nameWithoutShipping.match(/ä¸­å¤|[Uu]sed/)) {
      condition = 'used';
      templateName = nameWithoutShipping.replace(/ä¸­å¤|[Uu]sed/g, '').trim();
    } else {
      console.error('å•†å“çŠ¶æ…‹ãŒåˆ¤å®šã§ãã¾ã›ã‚“: ' + name);
      return null;
    }
    
    // æ®‹ã£ãŸéƒ¨åˆ†ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå
    // ç©ºã®å ´åˆã®ã¿ã€Œä¸€èˆ¬æ±ç”¨ã€
    if (!templateName || templateName === '') {
      templateName = 'ä¸€èˆ¬æ±ç”¨';
    }
    
    // æ–°å½¢å¼ã§ç”Ÿæˆï¼šTemplate_ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå_çŠ¶æ…‹_é…é€æ–¹æ³•
    return 'Template_' + templateName + '_' + condition + '_' + shipping;
    
  } catch (e) {
    console.error('æ¨™æº–åç”Ÿæˆã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}
/**
 * ãƒãƒªã‚·ãƒ¼åã‹ã‚‰é€æ–™ã‚’è¨ˆç®—ï¼ˆæ”¹è‰¯ç‰ˆï¼šä¸Šé™ãªã—å¯¾å¿œï¼‰
 */
/**
 * ãƒãƒªã‚·ãƒ¼åã‹ã‚‰é€æ–™ã‚’è¨ˆç®—ï¼ˆæ”¹è‰¯ç‰ˆï¼šä¸Šæ˜‡é¡åæ˜ ï¼‰
 */
function calculateShippingFeeFromPolicyName(policyName, allPolicies) {
  try {
    var name = String(policyName || '').trim();
    if (!name) return null;
    
    // é€šå¸¸ã®ä¾¡æ ¼ç¯„å›²ï¼ˆä¾‹: _0026_0050ï¼‰
    var normalMatch = name.match(/_(\d{4})$/);
    if (normalMatch) {
      var maxPrice = parseInt(normalMatch[1], 10);
      if (isNaN(maxPrice)) return null;
      var shippingFee = 15 + Math.floor((maxPrice / 25 - 1)) * 5;
      return Math.max(15, shippingFee);
    }
    
    // ä¸Šé™ãªã—ï¼ˆä¾‹: _1401_ï¼‰
    var openEndMatch = name.match(/_(\d{4})_$/);
    if (openEndMatch) {
      var minPrice = parseInt(openEndMatch[1], 10);
      if (isNaN(minPrice)) return null;
      
      // åŒã˜ã‚¿ã‚¤ãƒ—ã®ãƒãƒªã‚·ãƒ¼ã‹ã‚‰ç›´å‰ã®é€æ–™ã¨ä¸Šæ˜‡é¡ã‚’æ¢ã™
      var prefix = name.replace(/_\d{4}_$/, '');
      var previousData = findPreviousFeeAndIncrement(prefix, minPrice, allPolicies);
      
      if (previousData !== null) {
        return previousData.lastFee + previousData.increment;
      } else {
        // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ¨™æº–è¨ˆç®—
        var estimatedMaxPrice = minPrice + 25;
        var shippingFee = 15 + Math.floor((estimatedMaxPrice / 25 - 1)) * 5;
        return Math.max(15, shippingFee);
      }
    }
    
    return null;
    
  } catch (e) {
    console.error('é€æ–™è¨ˆç®—ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}

/**
 * åŒã˜ã‚¿ã‚¤ãƒ—ã®ãƒãƒªã‚·ãƒ¼ã‹ã‚‰ç›´å‰ã®é€æ–™ã¨ä¸Šæ˜‡é¡ã‚’æ¢ã™
 */
function findPreviousFeeAndIncrement(prefix, minPrice, allPolicies) {
  try {
    if (!allPolicies || !Array.isArray(allPolicies)) return null;
    
    var candidates = [];
    
    // åŒã˜prefixã®ãƒãƒªã‚·ãƒ¼ã‚’æŠ½å‡º
    for (var i = 0; i < allPolicies.length; i++) {
      var policy = allPolicies[i];
      if (!policy.name || policy.name.indexOf(prefix) !== 0) continue;
      
      // ä¾¡æ ¼ç¯„å›²ã‚’æŠ½å‡ºï¼ˆé€šå¸¸å½¢å¼ã®ã¿ï¼‰
      var match = policy.name.match(/_(\d{4})_(\d{4})$/);
      if (!match) continue;
      
      var policyMin = parseInt(match[1], 10);
      var policyMax = parseInt(match[2], 10);
      
      if (isNaN(policyMin) || isNaN(policyMax)) continue;
      if (typeof policy.calculatedFee !== 'number') continue;
      
      candidates.push({
        min: policyMin,
        max: policyMax,
        fee: policy.calculatedFee
      });
    }
    
    if (candidates.length < 2) return null; // ä¸Šæ˜‡é¡è¨ˆç®—ã«ã¯2ã¤å¿…è¦
    
    // ä¾¡æ ¼é †ã«ã‚½ãƒ¼ãƒˆ
    candidates.sort(function(a, b) { return a.min - b.min; });
    
    // minPriceã®ç›´å‰ã‚’æ¢ã™
    var lastIndex = -1;
    for (var j = candidates.length - 1; j >= 0; j--) {
      if (candidates[j].max < minPrice) {
        lastIndex = j;
        break;
      }
    }
    
    if (lastIndex < 1) return null; // ã•ã‚‰ã«ç›´å‰ãŒå¿…è¦
    
    var lastFee = candidates[lastIndex].fee;
    var secondLastFee = candidates[lastIndex - 1].fee;
    var increment = lastFee - secondLastFee;
    
    return {
      lastFee: lastFee,
      increment: increment
    };
    
  } catch (e) {
    console.error('é€æ–™ä¸Šæ˜‡é¡æ¤œç´¢ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return null;
  }
}

/**
 * ã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’æ¤œè¨¼ï¼ˆæ‰‹å‹•ãƒãƒªã‚·ãƒ¼å¯¾å¿œç‰ˆï¼‰
 */
function validateImportData() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var templateSheet = ss.getSheetByName('Import_Templates');
    var policySheet = ss.getSheetByName('Import_Policies');
    
    if (!templateSheet || !policySheet) {
      showAlert('å…ˆã«ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    
    var report = 'ğŸ” ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼çµæœ:\n\n';
    var hasError = false;
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¤œè¨¼ï¼ˆæ—¢å­˜ã®ã¾ã¾ï¼‰
    report += 'ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘\n';
    var templateCount = 0;
    var templateErrors = 0;
    
    var templateLastRow = templateSheet.getLastRow();
    for (var i = 2; i <= templateLastRow; i++) {
      var id = templateSheet.getRange(i, 1).getValue();
      var jaName = templateSheet.getRange(i, 2).getValue();
      
      if (!id && !jaName) continue;
      if (String(id).indexOf('ï¼ˆä¾‹ï¼‰') !== -1) continue;
      
      if (!id || !jaName) {
        templateErrors++;
        continue;
      }
      
      var standardName = generateStandardTemplateName(jaName);
      if (standardName) {
        templateSheet.getRange(i, 3).setValue(standardName);
        templateCount++;
      } else {
        templateSheet.getRange(i, 3).setValue('âš ï¸ å¤‰æ›å¤±æ•—');
        templateErrors++;
        hasError = true;
      }
    }
    
    report += 'æ¤œå‡º: ' + templateCount + 'ä»¶\n';
    if (templateErrors > 0) {
      report += 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + templateErrors + 'ä»¶\n';
    }
    
    // ãƒãƒªã‚·ãƒ¼ã®æ¤œè¨¼ï¼ˆ2ãƒ‘ã‚¹å‡¦ç† + æ‰‹å‹•ç”¨å¯¾å¿œï¼‰
    report += '\nã€ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã€‘\n';
    
    // ãƒ‘ã‚¹1: å…¨ãƒãƒªã‚·ãƒ¼ã‚’èª­ã¿è¾¼ã¿
    var policyLastRow = policySheet.getLastRow();
    var allPolicies = [];
    
    for (var j = 2; j <= policyLastRow; j++) {
      var policyId = policySheet.getRange(j, 1).getValue();
      var policyName = policySheet.getRange(j, 2).getValue();
      
      if (!policyId || !policyName) continue;
      if (String(policyId).indexOf('ï¼ˆä¾‹ï¼‰') !== -1) continue;
      
      allPolicies.push({
        row: j,
        id: policyId,
        name: policyName,
        calculatedFee: null
      });
    }
    
    // ãƒ‘ã‚¹2: é€šå¸¸ã®ä¾¡æ ¼ç¯„å›²ã‚’å…ˆã«è¨ˆç®—
    for (var k = 0; k < allPolicies.length; k++) {
      var policy = allPolicies[k];
      if (policy.name.match(/_(\d{4})$/)) {
        policy.calculatedFee = calculateShippingFeeFromPolicyName(policy.name, null);
      }
    }
    
    // ãƒ‘ã‚¹3: ä¸Šé™ãªã—ã‚’è¨ˆç®— + æ‰‹å‹•ç”¨ã‚’æ¤œå‡º
    var policyCount = 0;
    var manualPolicyCount = 0;
    var policyErrors = 0;
    
    for (var m = 0; m < allPolicies.length; m++) {
      var pol = allPolicies[m];
      var fee;
      
      if (pol.calculatedFee !== null) {
        fee = pol.calculatedFee;
      } else {
        fee = calculateShippingFeeFromPolicyName(pol.name, allPolicies);
      }
      
      if (fee !== null) {
        // é€šå¸¸ãƒãƒªã‚·ãƒ¼
        policySheet.getRange(pol.row, 3).setValue(fee);
        policyCount++;
      } else {
        // ğŸ”¹ æ–°æ©Ÿèƒ½ï¼šè¨ˆç®—å¤±æ•— = æ‰‹å‹•ç”¨ãƒãƒªã‚·ãƒ¼
        policySheet.getRange(pol.row, 3).setValue('æ‰‹å‹•ç”¨');
        manualPolicyCount++;
      }
    }
    
    report += 'è‡ªå‹•åˆ¤å®šç”¨: ' + policyCount + 'ä»¶\n';
    report += 'æ‰‹å‹•é¸æŠç”¨: ' + manualPolicyCount + 'ä»¶\n';
    
    report += '\n';
    if (hasError) {
      report += 'âš ï¸ ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ã€‚Båˆ—ã®å…¥åŠ›ã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚\n\n';
    }
    if (policyCount > 0 || manualPolicyCount > 0 || templateCount > 0) {
      report += 'âœ… ã€ŒPolicy_Masterã«åæ˜ ã€ã§ç¢ºå®šã§ãã¾ã™ã€‚\n';
      report += 'ğŸ’¡ æ‰‹å‹•ç”¨ãƒãƒªã‚·ãƒ¼ã¯ã€æ‰‹å‹•é¸æŠæ™‚ã«ä½¿ç”¨ã§ãã¾ã™ã€‚';
    } else {
      report += 'ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
    }
    
    showAlert(report, hasError ? 'warning' : 'success');
    
  } catch (e) {
    showAlert('æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}
/**
 * Policy_Masterã«åæ˜ 
 */
function applyImportToPolicyMaster() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var templateSheet = ss.getSheetByName('Import_Templates');
    var policySheet = ss.getSheetByName('Import_Policies');
    
    if (!templateSheet || !policySheet) {
      showAlert('å…ˆã«ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    
    // ç¢ºèªãƒ€ã‚¤ã‚¢ãƒ­ã‚°
    var ui = SpreadsheetApp.getUi();
    var response = ui.alert(
      'Policy_Masteråæ˜ ç¢ºèª',
      'Policy_Masterã‚·ãƒ¼ãƒˆã‚’æ–°è¦ä½œæˆã—ã¾ã™ã€‚\næ—¢å­˜ã®Policy_Masterã¯å‰Šé™¤ã•ã‚Œã¾ã™ã€‚\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ',
      ui.ButtonSet.YES_NO
    );
    
    if (response !== ui.Button.YES) {
      showAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', 'info');
      return;
    }
    
    // æ—¢å­˜ã®Policy_Masterã‚’å‰Šé™¤
    var existingSheet = ss.getSheetByName('Policy_Master');
    if (existingSheet) {
      ss.deleteSheet(existingSheet);
    }
    
    // æ–°ã—ã„Policy_Masterã‚’ä½œæˆ
    var masterSheet = ss.insertSheet('Policy_Master');
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚»ã‚¯ã‚·ãƒ§ãƒ³
    var currentRow = 1;
    currentRow = writeTemplatesToMaster(masterSheet, templateSheet, currentRow);
    
    // ãƒãƒªã‚·ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
    currentRow += 2; // ç©ºè¡Œ
    currentRow = writePoliciesToMaster(masterSheet, policySheet, currentRow);
    
    showAlert('âœ… Policy_Masterã«åæ˜ ã—ã¾ã—ãŸï¼\n\nä»Šå¾Œã®ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼åˆ¤å®šã«ã“ã®ãƒ‡ãƒ¼ã‚¿ãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚', 'success');
    
    // Policy_Masterã‚·ãƒ¼ãƒˆã‚’è¡¨ç¤º
    ss.setActiveSheet(masterSheet);
    
  } catch (e) {
    showAlert('åæ˜ ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’Policy_Masterã«æ›¸ãè¾¼ã¿
 */
function writeTemplatesToMaster(masterSheet, sourceSheet, startRow) {
  // ãƒ˜ãƒƒãƒ€ãƒ¼
  masterSheet.getRange(startRow, 1, 1, 3).mergeAcross();
  masterSheet.getRange(startRow, 1).setValue('ã€Templatesã€‘');
  masterSheet.getRange(startRow, 1).setFontWeight('bold').setFontSize(12)
    .setBackground('#34a853').setFontColor('white').setHorizontalAlignment('center');
  
  startRow++;
  
  // åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼
  masterSheet.getRange(startRow, 1).setValue('Template ID');
  masterSheet.getRange(startRow, 2).setValue('Template Name');
  masterSheet.getRange(startRow, 3).setValue('èª¬æ˜');
  masterSheet.getRange(startRow, 1, 1, 3).setFontWeight('bold').setBackground('#d9ead3');
  
  startRow++;
  
  // ãƒ‡ãƒ¼ã‚¿æ›¸ãè¾¼ã¿ + æ—¥æœ¬èªåã‚’åé›†
  var lastRow = sourceSheet.getLastRow();
  var dataRow = startRow;
  var templateJapaneseNames = []; // æ—¥æœ¬èªåã‚’åé›†ã™ã‚‹é…åˆ—
  
  for (var i = 2; i <= lastRow; i++) {
    var id = sourceSheet.getRange(i, 1).getValue();
    var jaName = sourceSheet.getRange(i, 2).getValue();
    var standardName = sourceSheet.getRange(i, 3).getValue();
    
    if (!id || !standardName || String(id).indexOf('ï¼ˆä¾‹ï¼‰') !== -1) continue;
    if (String(standardName).indexOf('âš ï¸') !== -1) continue; // ã‚¨ãƒ©ãƒ¼è¡Œã‚¹ã‚­ãƒƒãƒ—
    
    masterSheet.getRange(dataRow, 1).setValue(id);
    masterSheet.getRange(dataRow, 2).setValue(standardName);
    masterSheet.getRange(dataRow, 3).setValue(jaName);
    dataRow++;
    
    // ğŸ”¹ æ—¥æœ¬èªåã‚’æŠ½å‡ºï¼ˆTemplate_{ã“ã“}_{çŠ¶æ…‹}_{é…é€}ï¼‰
    var match = String(standardName).match(/^Template_(.+?)_(?:new|used)_(?:eco|xp)$/);
    if (match && match[1]) {
      templateJapaneseNames.push(match[1]);
    }
  }
  
  // ç½«ç·š
  if (dataRow > startRow) {
    masterSheet.getRange(startRow - 1, 1, dataRow - startRow + 1, 3)
      .setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);
  }
  
  // åˆ—å¹…
  masterSheet.setColumnWidth(1, 130);
  masterSheet.setColumnWidth(2, 350);
  masterSheet.setColumnWidth(3, 280);
  
  // ä½œæ¥­ã‚·ãƒ¼ãƒˆã®å–å¾—
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var workSheet = ss.getSheetByName('ä½œæ¥­ã‚·ãƒ¼ãƒˆ');
  
  if (!workSheet) {
    console.warn('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
    return dataRow;
  }
  
  // ğŸ”¹ O2ã‚»ãƒ«ï¼šãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆåã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®š
  if (templateJapaneseNames.length > 0) {
    // é‡è¤‡é™¤å¤–
    var uniqueNames = [];
    for (var j = 0; j < templateJapaneseNames.length; j++) {
      if (uniqueNames.indexOf(templateJapaneseNames[j]) === -1) {
        uniqueNames.push(templateJapaneseNames[j]);
      }
    }
    
    var templateRule = SpreadsheetApp.newDataValidation()
      .requireValueInList(uniqueNames, true)
      .setAllowInvalid(false)
      .build();
    
    workSheet.getRange('O2').setDataValidation(templateRule);
    workSheet.getRange('O2').setValue(uniqueNames[0]); // å¸¸ã«ä¸Šæ›¸ã
  }
  
  // ğŸ”¹ O1ã‚»ãƒ«ï¼šé€æ–™ä¸Šé™ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®ãƒ‰ãƒ­ãƒƒãƒ—ãƒ€ã‚¦ãƒ³è¨­å®š
  var categories = [
  'æ±ç”¨ï¼ˆä¸Šé™ãªã—ï¼‰',
  'Video Gamesï¼ˆ$20ï¼‰',
  'Booksï¼ˆ$20ï¼‰',
  'Movies & TVï¼ˆ$20ï¼‰',
  'Musicï¼ˆ$25ï¼‰',
  'Game Consolesï¼ˆ$50ï¼‰'
];

var categoryRule = SpreadsheetApp.newDataValidation()
  .requireValueInList(categories, true)
  .setAllowInvalid(false)
  .build();

workSheet.getRange('O1').setDataValidation(categoryRule);
workSheet.getRange('O1').setValue('æ±ç”¨ï¼ˆä¸Šé™ãªã—ï¼‰'); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã¯æ±ç”¨
  
  return dataRow;
}
/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®æ—¥æœ¬èªè¡¨ç¤ºã‚’å†…éƒ¨å€¤ã«å¤‰æ›
 * @param {string} displayValue - æ—¥æœ¬èªè¡¨ç¤ºï¼ˆä¾‹ï¼š'æ±ç”¨ï¼ˆä¸Šé™ãªã—ï¼‰'ï¼‰
 * @return {string} å†…éƒ¨å€¤ï¼ˆä¾‹ï¼š'general'ï¼‰
 */
function convertCategoryDisplayToValue(displayValue) {
  var mapping = {
    'æ±ç”¨ï¼ˆä¸Šé™ãªã—ï¼‰': 'general',
    'Video Gamesï¼ˆ$20ï¼‰': 'videogames',
    'Booksï¼ˆ$20ï¼‰': 'books',
    'Movies & TVï¼ˆ$20ï¼‰': 'movies',
    'Musicï¼ˆ$25ï¼‰': 'music',
    'Game Consolesï¼ˆ$50ï¼‰': 'console'
  };
  
  return mapping[displayValue] || 'general'; // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯general
}

/**
 * ã‚«ãƒ†ã‚´ãƒªãƒ¼ã®å†…éƒ¨å€¤ã‚’æ—¥æœ¬èªè¡¨ç¤ºã«å¤‰æ›
 * @param {string} value - å†…éƒ¨å€¤ï¼ˆä¾‹ï¼š'general'ï¼‰
 * @return {string} æ—¥æœ¬èªè¡¨ç¤ºï¼ˆä¾‹ï¼š'æ±ç”¨ï¼ˆä¸Šé™ãªã—ï¼‰'ï¼‰
 */
function convertCategoryValueToDisplay(value) {
  var mapping = {
    'general': 'æ±ç”¨ï¼ˆä¸Šé™ãªã—ï¼‰',
    'videogames': 'Video Gamesï¼ˆ$20ï¼‰',
    'books': 'Booksï¼ˆ$20ï¼‰',
    'movies': 'Movies & TVï¼ˆ$20ï¼‰',
    'music': 'Musicï¼ˆ$25ï¼‰',
    'console': 'Game Consolesï¼ˆ$50ï¼‰'
  };
  
  return mapping[value] || 'æ±ç”¨ï¼ˆä¸Šé™ãªã—ï¼‰'; // è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆã¯æ±ç”¨
}
/**
 * ãƒãƒªã‚·ãƒ¼ã‚’Policy_Masterã«æ›¸ãè¾¼ã¿ï¼ˆæ‰‹å‹•ç”¨å¯¾å¿œï¼‰
 */
function writePoliciesToMaster(masterSheet, sourceSheet, startRow) {
  // è‡ªå‹•åˆ¤å®šç”¨ãƒãƒªã‚·ãƒ¼ã®ãƒ˜ãƒƒãƒ€ãƒ¼
  masterSheet.getRange(startRow, 1, 1, 3).mergeAcross();
  masterSheet.getRange(startRow, 1).setValue('ã€Shipping Policies - è‡ªå‹•åˆ¤å®šç”¨ã€‘');
  masterSheet.getRange(startRow, 1).setFontWeight('bold').setFontSize(12)
    .setBackground('#4285f4').setFontColor('white').setHorizontalAlignment('center');
  
  startRow++;
  
  // åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼
  masterSheet.getRange(startRow, 1).setValue('Policy ID');
  masterSheet.getRange(startRow, 2).setValue('Policy Name');
  masterSheet.getRange(startRow, 3).setValue('é€æ–™ä¸Šä¹—ã›ï¼ˆUSDï¼‰');
  masterSheet.getRange(startRow, 1, 1, 3).setFontWeight('bold').setBackground('#cfe2f3');
  
  startRow++;
  
  // è‡ªå‹•åˆ¤å®šç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
  var lastRow = sourceSheet.getLastRow();
  var dataRow = startRow;
  var manualPolicies = []; // æ‰‹å‹•ç”¨ã‚’ä¸€æ™‚ä¿å­˜
  
  for (var i = 2; i <= lastRow; i++) {
    var id = sourceSheet.getRange(i, 1).getValue();
    var name = sourceSheet.getRange(i, 2).getValue();
    var fee = sourceSheet.getRange(i, 3).getValue();
    
    if (!id || !name || String(id).indexOf('ï¼ˆä¾‹ï¼‰') !== -1) continue;
    
    if (typeof fee === 'number' && !isNaN(fee)) {
      // è‡ªå‹•åˆ¤å®šç”¨
      masterSheet.getRange(dataRow, 1).setValue(id);
      masterSheet.getRange(dataRow, 2).setValue(name);
      masterSheet.getRange(dataRow, 3).setValue(fee);
      dataRow++;
    } else if (String(fee) === 'æ‰‹å‹•ç”¨') {
      // æ‰‹å‹•ç”¨ã‚’ä¿å­˜
      manualPolicies.push({ id: id, name: name });
    }
  }
  
  // ç½«ç·š
  if (dataRow > startRow) {
    masterSheet.getRange(startRow - 1, 1, dataRow - startRow + 1, 3)
      .setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);
  }
  
  // ğŸ”¹ æ‰‹å‹•é¸æŠç”¨ãƒãƒªã‚·ãƒ¼ã‚»ã‚¯ã‚·ãƒ§ãƒ³
  if (manualPolicies.length > 0) {
    dataRow += 2; // ç©ºè¡Œ
    
    masterSheet.getRange(dataRow, 1, 1, 3).mergeAcross();
    masterSheet.getRange(dataRow, 1).setValue('ã€Shipping Policies - æ‰‹å‹•é¸æŠç”¨ã€‘');
    masterSheet.getRange(dataRow, 1).setFontWeight('bold').setFontSize(12)
      .setBackground('#ff9800').setFontColor('white').setHorizontalAlignment('center');
    
    dataRow++;
    
    // åˆ—ãƒ˜ãƒƒãƒ€ãƒ¼
    masterSheet.getRange(dataRow, 1).setValue('Policy ID');
    masterSheet.getRange(dataRow, 2).setValue('Policy Name');
    masterSheet.getRange(dataRow, 3).setValue('å‚™è€ƒ');
    masterSheet.getRange(dataRow, 1, 1, 3).setFontWeight('bold').setBackground('#ffe0b2');
    
    dataRow++;
    
    // æ‰‹å‹•ç”¨ãƒ‡ãƒ¼ã‚¿ã‚’æ›¸ãè¾¼ã¿
    for (var j = 0; j < manualPolicies.length; j++) {
      var manual = manualPolicies[j];
      masterSheet.getRange(dataRow, 1).setValue(manual.id);
      masterSheet.getRange(dataRow, 2).setValue(manual.name);
      masterSheet.getRange(dataRow, 3).setValue('ä¾¡æ ¼ç¯„å›²ä¸æ˜ãƒ»æ‰‹å‹•é¸æŠç”¨');
      dataRow++;
    }
    
    // ç½«ç·š
    masterSheet.getRange(dataRow - manualPolicies.length - 2, 1, manualPolicies.length + 2, 3)
      .setBorder(true, true, true, true, true, true, '#000000', SpreadsheetApp.BorderStyle.SOLID);
  }
  
  return dataRow;
}
/**
 * æ‰‹å‹•é¸æŠç”¨ãƒãƒªã‚·ãƒ¼ã®ãƒªã‚¹ãƒˆã‚’å–å¾—
 * @return {Array} [{id: xxx, name: xxx}]
 */
function getManualPolicies() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var masterSheet = ss.getSheetByName('Policy_Master');
    
    if (!masterSheet) {
      return [];
    }
    
    var lastRow = masterSheet.getLastRow();
    var data = masterSheet.getRange(1, 1, lastRow, 3).getValues();
    var manualPolicies = [];
    var inManualSection = false;
    
    for (var i = 0; i < data.length; i++) {
      var cellValue = String(data[i][0]);
      
      // æ‰‹å‹•é¸æŠç”¨ã‚»ã‚¯ã‚·ãƒ§ãƒ³é–‹å§‹
      if (cellValue.indexOf('ã€Shipping Policies - æ‰‹å‹•é¸æŠç”¨ã€‘') !== -1) {
        inManualSection = true;
        continue;
      }
      
      // æ¬¡ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³ãŒå§‹ã¾ã£ãŸã‚‰çµ‚äº†
      if (inManualSection && cellValue.indexOf('ã€') !== -1) {
        break;
      }
      
      // æ‰‹å‹•ã‚»ã‚¯ã‚·ãƒ§ãƒ³å†…ã§ãƒãƒªã‚·ãƒ¼ã‚’æŠ½å‡º
      if (inManualSection && data[i][0] && data[i][1]) {
        if (cellValue !== 'Policy ID') { // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—
          manualPolicies.push({
            id: data[i][0],
            name: data[i][1]
          });
        }
      }
    }
    
    return manualPolicies;
    
  } catch (e) {
    console.error('æ‰‹å‹•ãƒãƒªã‚·ãƒ¼å–å¾—ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return [];
  }
}
// ============================================
// ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸€æ‹¬å‡¦ç†é–¢æ•°
// ============================================

/**
 * ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼â†’ãƒã‚¹ã‚¿ãƒ¼åæ˜ ã‚’ä¸€æ‹¬ã§å®Ÿè¡Œã™ã‚‹é–¢æ•°
 * 1. ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼
 * 2. Policy_Masterã«åæ˜ 
 */
// ============================================
// ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸€æ‹¬å‡¦ç†é–¢æ•°
// ============================================

/**
 * ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼â†’ãƒã‚¹ã‚¿ãƒ¼åæ˜ ã‚’ä¸€æ‹¬ã§å®Ÿè¡Œã™ã‚‹é–¢æ•°
 */
function validateAndApplyImport() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var ui = SpreadsheetApp.getUi();
    var templateSheet = ss.getSheetByName('Import_Templates');
    var policySheet = ss.getSheetByName('Import_Policies');
    
    // ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ç¢ºèª
    if (!templateSheet || !policySheet) {
      showAlert('å…ˆã«ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚', 'error');
      return;
    }
    
    // ============================================
    // ã‚¹ãƒ†ãƒƒãƒ—1: ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼(ã‚¨ãƒ©ãƒ¼ã¯è¨˜éŒ²ã™ã‚‹ãŒå‡¦ç†ç¶™ç¶š)
    // ============================================
    
    var report = 'ğŸ” ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼çµæœ:\n\n';
    var templateErrorRows = []; // ã‚¨ãƒ©ãƒ¼è¡Œã‚’è¨˜éŒ²
    
    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¤œè¨¼
    report += 'ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã€‘\n';
    var templateCount = 0;
    
    var templateLastRow = templateSheet.getLastRow();
    for (var i = 2; i <= templateLastRow; i++) {
      var id = templateSheet.getRange(i, 1).getValue();
      var jaName = templateSheet.getRange(i, 2).getValue();
      
      if (!id && !jaName) continue;
      if (String(id).indexOf('(ä¾‹)') !== -1) continue;
      
      if (!id || !jaName) {
        templateErrorRows.push(i);
        templateSheet.getRange(i, 3).setValue('âš ï¸ ID/åå‰ãŒç©º');
        continue;
      }
      
      var standardName = generateStandardTemplateName(jaName);
      if (standardName) {
        templateSheet.getRange(i, 3).setValue(standardName);
        templateCount++;
      } else {
        templateSheet.getRange(i, 3).setValue('âš ï¸ å¤‰æ›å¤±æ•—');
        templateErrorRows.push(i);
      }
    }
    
    report += 'æ­£å¸¸: ' + templateCount + 'ä»¶\n';
    if (templateErrorRows.length > 0) {
      report += 'âš ï¸ ã‚¨ãƒ©ãƒ¼: ' + templateErrorRows.length + 'ä»¶ (è¡Œ: ' + templateErrorRows.join(', ') + ')\n';
      report += 'â†’ ã‚¨ãƒ©ãƒ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ã—ã¦åæ˜ ã•ã‚Œã¾ã™\n';
    }
    
    // ãƒãƒªã‚·ãƒ¼ã®æ¤œè¨¼(2ãƒ‘ã‚¹å‡¦ç† + æ‰‹å‹•ç”¨å¯¾å¿œ)
    report += '\nã€ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã€‘\n';
    
    // ãƒ‘ã‚¹1: å…¨ãƒãƒªã‚·ãƒ¼ã‚’èª­ã¿è¾¼ã¿
    var policyLastRow = policySheet.getLastRow();
    var allPolicies = [];
    
    for (var j = 2; j <= policyLastRow; j++) {
      var policyId = policySheet.getRange(j, 1).getValue();
      var policyName = policySheet.getRange(j, 2).getValue();
      
      if (!policyId || !policyName) continue;
      if (String(policyId).indexOf('(ä¾‹)') !== -1) continue;
      
      allPolicies.push({
        row: j,
        id: policyId,
        name: policyName,
        calculatedFee: null
      });
    }
    
    // ãƒ‘ã‚¹2: é€šå¸¸ã®ä¾¡æ ¼ç¯„å›²ã‚’å…ˆã«è¨ˆç®—
    for (var k = 0; k < allPolicies.length; k++) {
      var policy = allPolicies[k];
      if (policy.name.match(/_(\d{4})$/)) {
        policy.calculatedFee = calculateShippingFeeFromPolicyName(policy.name, null);
      }
    }
    
    // ãƒ‘ã‚¹3: ä¸Šé™ãªã—ã‚’è¨ˆç®— + æ‰‹å‹•ç”¨ã‚’æ¤œå‡º
    var policyCount = 0;
    var manualPolicyCount = 0;
    
    for (var m = 0; m < allPolicies.length; m++) {
      var pol = allPolicies[m];
      var fee;
      
      if (pol.calculatedFee !== null) {
        fee = pol.calculatedFee;
      } else {
        fee = calculateShippingFeeFromPolicyName(pol.name, allPolicies);
      }
      
      if (fee !== null) {
        // é€šå¸¸ãƒãƒªã‚·ãƒ¼
        policySheet.getRange(pol.row, 3).setValue(fee);
        policyCount++;
      } else {
        // æ‰‹å‹•ç”¨ãƒãƒªã‚·ãƒ¼
        policySheet.getRange(pol.row, 3).setValue('æ‰‹å‹•ç”¨');
        manualPolicyCount++;
      }
    }
    
    report += 'è‡ªå‹•åˆ¤å®šç”¨: ' + policyCount + 'ä»¶\n';
    report += 'æ‰‹å‹•é¸æŠç”¨: ' + manualPolicyCount + 'ä»¶\n';
    
    report += '\n';
    
    // ãƒ‡ãƒ¼ã‚¿ãŒå…¨ããªã„å ´åˆã®ã¿åœæ­¢
    if (policyCount === 0 && manualPolicyCount === 0 && templateCount === 0) {
      report += 'åæ˜ å¯èƒ½ãªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚';
      showAlert(report, 'info');
      return;
    }
    
    // ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ã¦ã‚‚æ­£å¸¸ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Œã°ç¶™ç¶š
    if (templateErrorRows.length > 0) {
      report += 'âš ï¸ ä¸€éƒ¨ã‚¨ãƒ©ãƒ¼ãŒã‚ã‚Šã¾ã™ãŒã€æ­£å¸¸ãªãƒ‡ãƒ¼ã‚¿ã®ã¿åæ˜ å¯èƒ½ã§ã™ã€‚\n';
    }
    report += 'âœ… æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸ!';
    
    // æ¤œè¨¼çµæœã‚’è¡¨ç¤º
    showAlert(report, templateErrorRows.length > 0 ? 'warning' : 'success');
    
    // ============================================
    // ã‚¹ãƒ†ãƒƒãƒ—2: åæ˜ ç¢ºèª
    // ============================================
    
    var confirmMessage = 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n\n';
    confirmMessage += 'åæ˜ ä»¶æ•°:\n';
    confirmMessage += 'ãƒ»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ: ' + templateCount + 'ä»¶\n';
    confirmMessage += 'ãƒ»ãƒãƒªã‚·ãƒ¼: ' + (policyCount + manualPolicyCount) + 'ä»¶\n';
    if (templateErrorRows.length > 0) {
      confirmMessage += '\nâš ï¸ ã‚¨ãƒ©ãƒ¼è¡Œã¯ã‚¹ã‚­ãƒƒãƒ—ã•ã‚Œã¾ã™\n';
    }
    confirmMessage += '\nPolicy_Masterã«åæ˜ ã—ã¾ã™ã‹?';
    
    var confirmResponse = ui.alert(
      'Policy_Masteråæ˜ ç¢ºèª',
      confirmMessage,
      ui.ButtonSet.YES_NO
    );
    
    if (confirmResponse !== ui.Button.YES) {
      showAlert('å‡¦ç†ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚ãƒ‡ãƒ¼ã‚¿ã¯æ¤œè¨¼æ¸ˆã¿ã§ã™ã€‚', 'info');
      return;
    }
    
    // ============================================
    // ã‚¹ãƒ†ãƒƒãƒ—3: ãƒã‚¹ã‚¿ãƒ¼ã«åæ˜ (ã‚¨ãƒ©ãƒ¼è¡Œã‚’ã‚¹ã‚­ãƒƒãƒ—)
    // ============================================
    
    applyImportToPolicyMaster();
    
  } catch (e) {
    showAlert('æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}


/**
 * æ”¹è‰¯ç‰ˆvalidateImportData - çµæœã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’è¿”ã™
 */
function validateImportData() {
  var ss = SpreadsheetApp.getActiveSpreadsheet();
  var shippingSheet = ss.getSheetByName('Shipping_Policy_Import');
  var returnSheet = ss.getSheetByName('Return_Policy_Import');
  var errors = [];
  
  // ã‚·ãƒ¼ãƒˆã®å­˜åœ¨ç¢ºèª
  if (!shippingSheet || !returnSheet) {
    return {
      success: false,
      errors: ['ã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚å…ˆã«ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆç”¨ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã€ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚']
    };
  }
  
  // Shipping Policyæ¤œè¨¼
  var shippingData = shippingSheet.getDataRange().getValues();
  if (shippingData.length <= 1) {
    errors.push('Shipping_Policy_Importã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
  } else {
    // å¿…é ˆåˆ—ã®ãƒã‚§ãƒƒã‚¯
    var requiredColumns = ['Country', 'Shipping_Days_Min', 'Shipping_Days_Max', 'Shipping_Cost'];
    for (var i = 1; i < shippingData.length; i++) {
      var row = shippingData[i];
      if (!row[0]) continue; // ç©ºè¡Œã‚¹ã‚­ãƒƒãƒ—
      
      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
      if (!row[0] || row[1] === '' || row[2] === '' || row[3] === '') {
        errors.push('Shipping_Policy: è¡Œ' + (i + 1) + 'ã«å¿…é ˆé …ç›®ã®å…¥åŠ›æ¼ã‚ŒãŒã‚ã‚Šã¾ã™ã€‚');
      }
      
      // æ•°å€¤ãƒã‚§ãƒƒã‚¯
      if (isNaN(row[1]) || isNaN(row[2]) || isNaN(row[3])) {
        errors.push('Shipping_Policy: è¡Œ' + (i + 1) + 'ã®æ•°å€¤ãŒä¸æ­£ã§ã™ã€‚');
      }
    }
  }
  
  // Return Policyæ¤œè¨¼
  var returnData = returnSheet.getDataRange().getValues();
  if (returnData.length <= 1) {
    errors.push('Return_Policy_Importã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
  } else {
    for (var i = 1; i < returnData.length; i++) {
      var row = returnData[i];
      if (!row[0]) continue; // ç©ºè¡Œã‚¹ã‚­ãƒƒãƒ—
      
      // å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
      if (!row[0] || row[1] === '' || row[2] === '') {
        errors.push('Return_Policy: è¡Œ' + (i + 1) + 'ã«å¿…é ˆé …ç›®ã®å…¥åŠ›æ¼ã‚ŒãŒã‚ã‚Šã¾ã™ã€‚');
      }
      
      // æ•°å€¤ãƒã‚§ãƒƒã‚¯
      if (isNaN(row[1])) {
        errors.push('Return_Policy: è¡Œ' + (i + 1) + 'ã®è¿”å“æœŸé™æ—¥æ•°ãŒä¸æ­£ã§ã™ã€‚');
      }
    }
  }
  
  if (errors.length > 0) {
    return {
      success: false,
      errors: errors
    };
  }
  
  return {
    success: true,
    message: 'ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãŒå®Œäº†ã—ã¾ã—ãŸã€‚\n' +
             'Shipping Policy: ' + (shippingData.length - 1) + 'ä»¶\n' +
             'Return Policy: ' + (returnData.length - 1) + 'ä»¶'
  };
}
/**
 * ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’è¿½åŠ ï¼ˆæ—¢å­˜ã®onOpenã«è¿½åŠ ï¼‰
 */
function addImportMenuItems(ui) {
  // æ—¢å­˜ã® onOpen() é–¢æ•°å†…ã§å‘¼ã³å‡ºã™æƒ³å®š
  // ã¾ãŸã¯ç›´æ¥ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½åŠ 
}
function addReadmeMenu_() {
  try {
    SpreadsheetApp.getUi()
      .createMenu('ğŸ“– README')
      .addItem('READMEã‚’ä½œæˆ/æ›´æ–°', 'openReadme')
      .addItem('PDFã‚’æ›¸ãå‡ºã™', 'exportReadmeToPDF_')
      .addToUi();
  } catch (e) {}
}

// å‰å›ã®è¨­å®šã‚’å–å¾—
function getPreviousSettings() {
  var userProperties = PropertiesService.getUserProperties();
  var settingsJson = userProperties.getProperty('templatePolicySettings');
  
  if (settingsJson) {
    return JSON.parse(settingsJson);
  }
  return null;
}

// è¨­å®šã‚’é©ç”¨ã—ã¦ä¿å­˜
function applyUnifiedSettingsWithSave(category, templateName, templateMode, policyMode, manualPolicyId, settings) {
  // è¨­å®šã‚’ä¿å­˜
  var userProperties = PropertiesService.getUserProperties();
  userProperties.setProperty('templatePolicySettings', JSON.stringify(settings));
  
  // æ—¢å­˜ã®é©ç”¨å‡¦ç†ã‚’å®Ÿè¡Œ
  return applyUnifiedSettings(category, templateName, templateMode, policyMode, manualPolicyId);
}
/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ†• çµ±åˆç‰ˆï¼šãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆåˆæœŸè¨­å®šå¯¾å¿œç‰ˆv3ï¼‰
  - ã‚·ãƒ¼ãƒˆãƒ‡ãƒ¼ã‚¿ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
  - åˆæœŸè¨­å®šå€¤ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆAPIã‚­ãƒ¼é™¤ãï¼‰
  - è²¼ã‚Šä»˜ã‘ä½ç½®ã®è‡ªå‹•èª¿æ•´
  - ã‚·ãƒ¼ãƒˆä½ç½®ã®ä¿æŒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

function showDataImportDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('UnifiedDataImportDialog')
      .setWidth(900).setHeight(780);
    SpreadsheetApp.getUi().showModalDialog(html, 'ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
  } catch (e) {
    showAlert('ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ†• åˆæœŸè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * åˆæœŸè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showSettingsImportDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('SettingsImportDialog')
      .setWidth(700).setHeight(650);
    SpreadsheetApp.getUi().showModalDialog(html, 'âš™ï¸ åˆæœŸè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
  } catch (e) {
    showAlert('ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/**
 * ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã«è¿½åŠ ã™ã‚‹ä¾‹
 * æ—¢å­˜ã®onOpen()é–¢æ•°ã«ä»¥ä¸‹ã‚’è¿½åŠ ã—ã¦ãã ã•ã„ï¼š
 * 
 * function onOpen() {
 *   var ui = SpreadsheetApp.getUi();
 *   ui.createMenu('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ç®¡ç†')
 *     .addItem('ğŸ“¤ è¨­å®šã‚’ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ', 'exportSettingsToSheet')
 *     .addItem('âš™ï¸ åˆæœŸè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'showSettingsImportDialog')
 *     .addItem('ğŸ“¥ ãƒ‡ãƒ¼ã‚¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ', 'showDataImportDialog')
 *     .addToUi();
 * }
 */

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ†• åˆæœŸè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * åˆæœŸè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’è¡¨ç¤º
 */
function showSettingsImportDialog() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('SettingsImportDialog')
      .setWidth(700).setHeight(650);
    SpreadsheetApp.getUi().showModalDialog(html, 'âš™ï¸ åˆæœŸè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆ');
  } catch (e) {
    showAlert('ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + e.message, 'error');
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ†• åˆæœŸè¨­å®šæƒ…å ±ã®å–å¾—
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã®åˆæœŸè¨­å®šæƒ…å ±ã‚’å–å¾—ï¼ˆå€¤ä»˜ãï¼‰
 */
function getSourceSettings(sourceUrl) {
  try {
    var result = getSettingsFromSource(sourceUrl);
    
    if (!result.success) {
      return result;
    }
    
    var sourceSettings = result.settings;
    
    // è¨­å®šé …ç›®ã®å®šç¾©ï¼ˆå€¤ä»˜ãï¼‰
    var settingGroups = {
      basic: {
        title: 'ğŸ“‹ åŸºæœ¬è¨­å®š',
        settings: [
          { key: 'AI_MODEL', label: 'AIãƒ¢ãƒ‡ãƒ«', type: 'text', value: sourceSettings['AI_MODEL'] || '' },
          { key: 'SHEET_NAME', label: 'ä½œæ¥­ã‚·ãƒ¼ãƒˆå', type: 'text', value: sourceSettings['SHEET_NAME'] || '' },
          { key: 'PROMPT_ID', label: 'ãƒ—ãƒ­ãƒ³ãƒ—ãƒˆID', type: 'text', value: sourceSettings['PROMPT_ID'] || '' },
          { key: 'SHOW_POPUPS', label: 'ãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—è¡¨ç¤º', type: 'boolean', value: sourceSettings['SHOW_POPUPS'] || 'false' }
        ]
      },
      profit: {
        title: 'ğŸ’° åˆ©ç›Šãƒ»é€æ–™è¨­å®š',
        settings: [
          { key: 'PROFIT_CALC_METHOD', label: 'åˆ©ç›Šè¨ˆç®—æ–¹æ³•', type: 'text', value: sourceSettings['PROFIT_CALC_METHOD'] || '' },
          { key: 'SHIPPING_CALC_METHOD', label: 'é€æ–™è¨ˆç®—æ–¹æ³•', type: 'text', value: sourceSettings['SHIPPING_CALC_METHOD'] || '' },
          { key: 'SHIPPING_THRESHOLD', label: 'é€æ–™åˆ‡æ›¿åŸºæº–é‡‘é¡', type: 'number', value: sourceSettings['SHIPPING_THRESHOLD'] || '' },
          { key: 'LOW_PRICE_SHIPPING_METHOD', label: 'ä½ä¾¡æ ¼å•†å“é…é€æ–¹æ³•', type: 'text', value: sourceSettings['LOW_PRICE_SHIPPING_METHOD'] || '' },
          { key: 'HIGH_PRICE_SHIPPING_METHOD', label: 'é«˜ä¾¡æ ¼å•†å“é…é€æ–¹æ³•', type: 'text', value: sourceSettings['HIGH_PRICE_SHIPPING_METHOD'] || '' }
        ]
      },
      ddu: {
        title: 'ğŸ’µ DDUä¾¡æ ¼èª¿æ•´è¨­å®š',
        settings: [
          { key: 'DDU_ADJUSTMENT_ENABLED', label: 'DDUèª¿æ•´æ©Ÿèƒ½', type: 'boolean', value: sourceSettings['DDU_ADJUSTMENT_ENABLED'] || 'false' },
          { key: 'DDU_THRESHOLD', label: 'DDUé–¾å€¤', type: 'number', value: sourceSettings['DDU_THRESHOLD'] || '' },
          { key: 'DDU_ADJUSTMENT_AMOUNT', label: 'DDUèª¿æ•´é¡', type: 'number', value: sourceSettings['DDU_ADJUSTMENT_AMOUNT'] || '' },
          { key: 'PRICE_DISPLAY_MODE', label: 'ä¾¡æ ¼è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰', type: 'text', value: sourceSettings['PRICE_DISPLAY_MODE'] || '' }
        ]
      },
      duplicate: {
        title: 'ğŸ” é‡è¤‡ãƒã‚§ãƒƒã‚¯è¨­å®š',
        settings: [
          { key: 'DUPLICATE_CHECK_ENABLED', label: 'é‡è¤‡ãƒã‚§ãƒƒã‚¯æœ‰åŠ¹åŒ–', type: 'boolean', value: sourceSettings['DUPLICATE_CHECK_ENABLED'] || 'false' },
          { key: 'DUPLICATE_SOURCE_SHEET', label: 'ã‚½ãƒ¼ã‚¹ã‚·ãƒ¼ãƒˆ', type: 'text', value: sourceSettings['DUPLICATE_SOURCE_SHEET'] || '' },
          { key: 'DUPLICATE_SOURCE_COLUMN', label: 'ã‚½ãƒ¼ã‚¹åˆ—', type: 'text', value: sourceSettings['DUPLICATE_SOURCE_COLUMN'] || '' },
          { key: 'DUPLICATE_TARGET_SHEETS', label: 'ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚·ãƒ¼ãƒˆè¨­å®š', type: 'json', value: sourceSettings['DUPLICATE_TARGET_SHEETS'] || '' },
          { key: 'DUPLICATE_APPLY_TO_SHEET', label: 'ã‚·ãƒ¼ãƒˆé©ç”¨', type: 'boolean', value: sourceSettings['DUPLICATE_APPLY_TO_SHEET'] || 'false' },
          { key: 'DUPLICATE_OUTPUT_SHEET', label: 'å‡ºåŠ›ã‚·ãƒ¼ãƒˆ', type: 'text', value: sourceSettings['DUPLICATE_OUTPUT_SHEET'] || '' },
          { key: 'DUPLICATE_OUTPUT_COLUMN', label: 'å‡ºåŠ›åˆ—', type: 'text', value: sourceSettings['DUPLICATE_OUTPUT_COLUMN'] || '' },
          { key: 'DUPLICATE_OUTPUT_START_ROW', label: 'å‡ºåŠ›é–‹å§‹è¡Œ', type: 'text', value: sourceSettings['DUPLICATE_OUTPUT_START_ROW'] || '' },
          { key: 'DUPLICATE_OUTPUT_RANGE', label: 'å‡ºåŠ›ç¯„å›²', type: 'text', value: sourceSettings['DUPLICATE_OUTPUT_RANGE'] || '' }
        ]
      }
    };
    
    return {
      success: true,
      spreadsheetName: result.sourceSpreadsheet,
      settingGroups: settingGroups
    };
    
  } catch (e) {
    return { success: false, error: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã‘ã¾ã›ã‚“: ' + e.message };
  }
}

/**
 * ç¾åœ¨ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨­å®šå€¤ã‚’å–å¾—ï¼ˆãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”¨ï¼‰
 */
function getCurrentSettings() {
  try {
    var props = PropertiesService.getScriptProperties();
    var allProps = props.getProperties();
    
    // APIã‚­ãƒ¼ã‚’é™¤å¤–
    delete allProps.OPENAI_API_KEY;
    delete allProps.CLAUDE_API_KEY;
    delete allProps.GEMINI_API_KEY;
    delete allProps.AI_PLATFORM;  // ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã‚‚APIã‚­ãƒ¼ã«é–¢é€£ã™ã‚‹ãŸã‚é™¤å¤–
    
    return {
      success: true,
      settings: allProps
    };
    
  } catch (e) {
    return { success: false, error: e.message };
  }
}

/**
 * ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è¨­å®šå€¤ã‚’å–å¾—
 */
function getSettingsFromSource(sourceUrl) {
  try {
    // æ³¨æ„: Google Apps Scriptã®åˆ¶é™ã«ã‚ˆã‚Šã€
    // åˆ¥ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®ScriptPropertiesã‚’ç›´æ¥èª­ã¿å–ã‚‹ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
    // ã“ã®é–¢æ•°ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’
    // ä¸€æ™‚çš„ã«ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«ã—ãŸçŠ¶æ…‹ã§å®Ÿè¡Œã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚
    
    var sourceSS = SpreadsheetApp.openByUrl(sourceUrl);
    var scriptId = sourceSS.getId();
    
    // ä»£æ›¿æ¡ˆ: è¨­å®šå€¤ã‚’ç‰¹å®šã®ã‚·ãƒ¼ãƒˆï¼ˆä¾‹ï¼šã€Œè¨­å®šã€ã‚·ãƒ¼ãƒˆï¼‰ã«ä¿å­˜ã—ã¦ãŠã
    var settingsSheet = sourceSS.getSheetByName('åˆæœŸè¨­å®šå€¤');
    
    if (!settingsSheet) {
      return {
        success: false,
        error: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã«ã€ŒåˆæœŸè¨­å®šå€¤ã€ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚\n\n' +
               'ğŸ’¡ ä»£æ›¿æ–¹æ³•ï¼š\n' +
               '1. ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã\n' +
               '2. ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‹ã‚‰ã€Œè¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã€ã‚’å®Ÿè¡Œ\n' +
               '3. ã“ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã€Œè¨­å®šã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã‚’å®Ÿè¡Œ'
      };
    }
    
    var settings = {};
    var lastRow = settingsSheet.getLastRow();
    
    for (var i = 2; i <= lastRow; i++) {
      var key = settingsSheet.getRange(i, 1).getValue();
      var value = settingsSheet.getRange(i, 2).getValue();
      
      if (key) {
        settings[key] = value;
      }
    }
    
    return {
      success: true,
      settings: settings,
      sourceSpreadsheet: sourceSS.getName()
    };
    
  } catch (e) {
    return { success: false, error: e.message };
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ†• è¨­å®šå€¤ã®ã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * é¸æŠã•ã‚ŒãŸè¨­å®šé …ç›®ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆãƒ¢ãƒ¼ãƒ‰é¸æŠå¯¾å¿œï¼‰
 */
function importSelectedSettings(sourceUrl, mode, selectedKeys) {
  try {
    // ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‹ã‚‰è¨­å®šã‚’å–å¾—
    var sourceResult = getSettingsFromSource(sourceUrl);
    
    if (!sourceResult.success) {
      return sourceResult;
    }
    
    var sourceSettings = sourceResult.settings;
    var targetProps = PropertiesService.getScriptProperties();
    var imported = [];
    var skipped = [];
    
    // ãƒ¢ãƒ¼ãƒ‰ã«ã‚ˆã£ã¦å‡¦ç†ã‚’åˆ†å²
    if (mode === 'all') {
      // å…¨è¨­å®šã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆAPIã‚­ãƒ¼é™¤ãï¼‰
      for (var key in sourceSettings) {
        if (sourceSettings.hasOwnProperty(key)) {
          // APIã‚­ãƒ¼é–¢é€£ã¯ã‚¹ã‚­ãƒƒãƒ—
          if (key.indexOf('API_KEY') >= 0 || key === 'AI_PLATFORM') {
            skipped.push(key + ' (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚é™¤å¤–)');
            continue;
          }
          
          targetProps.setProperty(key, sourceSettings[key]);
          imported.push(key);
        }
      }
    } else if (mode === 'selected') {
      // é¸æŠã•ã‚ŒãŸè¨­å®šã®ã¿ã‚¤ãƒ³ãƒãƒ¼ãƒˆ
      if (!selectedKeys || selectedKeys.length === 0) {
        return { success: false, error: 'è¨­å®šé …ç›®ãŒé¸æŠã•ã‚Œã¦ã„ã¾ã›ã‚“' };
      }
      
      for (var i = 0; i < selectedKeys.length; i++) {
        var key = selectedKeys[i];
        
        // APIã‚­ãƒ¼é–¢é€£ã¯ã‚¹ã‚­ãƒƒãƒ—
        if (key.indexOf('API_KEY') >= 0 || key === 'AI_PLATFORM') {
          skipped.push(key + ' (ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚é™¤å¤–)');
          continue;
        }
        
        if (sourceSettings.hasOwnProperty(key)) {
          targetProps.setProperty(key, sourceSettings[key]);
          imported.push(key);
        } else {
          skipped.push(key + ' (ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã«å­˜åœ¨ã—ã¾ã›ã‚“)');
        }
      }
    } else {
      return { success: false, error: 'ä¸æ˜ãªãƒ¢ãƒ¼ãƒ‰: ' + mode };
    }
    
    return {
      success: true,
      mode: mode,
      imported: imported,
      skipped: skipped,
      sourceSpreadsheet: sourceResult.sourceSpreadsheet
    };
    
  } catch (e) {
    return { success: false, error: e.message };
  }
}

/**
 * é¸æŠã•ã‚ŒãŸè¨­å®šé …ç›®ã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆå¾Œæ–¹äº’æ›ç”¨ï¼‰
 */
function importSettings(sourceUrl, selectedKeys) {
  return importSelectedSettings(sourceUrl, 'selected', selectedKeys);
}

/**
 * ã™ã¹ã¦ã®è¨­å®šå€¤ã‚’ä¸€æ‹¬ã‚¤ãƒ³ãƒãƒ¼ãƒˆï¼ˆAPIã‚­ãƒ¼é™¤ãï¼‰
 * å¾Œæ–¹äº’æ›æ€§ã®ãŸã‚æ®‹ã—ã¦ã„ã¾ã™ãŒã€å†…éƒ¨çš„ã«ã¯importSelectedSettingsã‚’å‘¼ã³å‡ºã—ã¾ã™
 */
function importAllSettings(sourceUrl) {
  return importSelectedSettings(sourceUrl, 'all', null);
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ†• è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã§å®Ÿè¡Œï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

/**
 * ç¾åœ¨ã®è¨­å®šã‚’ã€ŒåˆæœŸè¨­å®šå€¤ã€ã‚·ãƒ¼ãƒˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
 * ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã§ã“ã®é–¢æ•°ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„
 */
function exportSettingsToSheet() {
  try {
    var ss = SpreadsheetApp.getActiveSpreadsheet();
    var props = PropertiesService.getScriptProperties();
    var allProps = props.getProperties();
    
    // APIã‚­ãƒ¼ã‚’é™¤å¤–
    delete allProps.OPENAI_API_KEY;
    delete allProps.CLAUDE_API_KEY;
    delete allProps.GEMINI_API_KEY;
    delete allProps.AI_PLATFORM;
    
    // ã‚·ãƒ¼ãƒˆã‚’ä½œæˆã¾ãŸã¯å–å¾—
    var sheet = ss.getSheetByName('åˆæœŸè¨­å®šå€¤');
    if (!sheet) {
      sheet = ss.insertSheet('åˆæœŸè¨­å®šå€¤');
    } else {
      sheet.clear();
    }
    
    // ãƒ˜ãƒƒãƒ€ãƒ¼è¡Œ
    sheet.getRange(1, 1, 1, 2).setValues([['è¨­å®šã‚­ãƒ¼', 'è¨­å®šå€¤']]);
    sheet.getRange(1, 1, 1, 2).setFontWeight('bold').setBackground('#4CAF50').setFontColor('#FFFFFF');
    
    // è¨­å®šå€¤ã‚’æ›¸ãè¾¼ã¿
    var row = 2;
    for (var key in allProps) {
      if (allProps.hasOwnProperty(key)) {
        sheet.getRange(row, 1).setValue(key);
        sheet.getRange(row, 2).setValue(allProps[key]);
        row++;
      }
    }
    
    // åˆ—å¹…ã‚’è‡ªå‹•èª¿æ•´
    sheet.autoResizeColumn(1);
    sheet.autoResizeColumn(2);
    
    SpreadsheetApp.getUi().alert(
      'è¨­å®šã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆå®Œäº†',
      'âœ… è¨­å®šå€¤ã‚’ã€ŒåˆæœŸè¨­å®šå€¤ã€ã‚·ãƒ¼ãƒˆã«ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã—ã¾ã—ãŸã€‚\n\n' +
      'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã•ã‚ŒãŸé …ç›®æ•°: ' + (row - 2) + '\n\n' +
      'ğŸ’¡ ã“ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã¨ã—ã¦ã€\n' +
      'ä»–ã®ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‹ã‚‰è¨­å®šã‚’ã‚¤ãƒ³ãƒãƒ¼ãƒˆã§ãã¾ã™ã€‚',
      SpreadsheetApp.getUi().ButtonSet.OK
    );
    
    return { success: true, count: row - 2 };
    
  } catch (e) {
    SpreadsheetApp.getUi().alert('ã‚¨ãƒ©ãƒ¼', 'ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message, SpreadsheetApp.getUi().ButtonSet.OK);
    return { success: false, error: e.message };
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ—¢å­˜ã®ã‚·ãƒ¼ãƒˆã‚¤ãƒ³ãƒãƒ¼ãƒˆæ©Ÿèƒ½ï¼ˆå¤‰æ›´ãªã—ï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

function getSourceSheetsInfo(sourceUrl) {
  try {
    var sourceSS = SpreadsheetApp.openByUrl(sourceUrl);
    var sheets = sourceSS.getSheets();
    var sheetInfo = [];
    
    for (var i = 0; i < sheets.length; i++) {
      var sheet = sheets[i];
      var lastRow = sheet.getLastRow();
      var lastCol = sheet.getLastColumn();
      
      var sheetType = detectSheetType_(sheet.getName());
      
      // é™¤å¤–å¯¾è±¡ã‚·ãƒ¼ãƒˆã¯ã‚¹ã‚­ãƒƒãƒ—
      if (sheetType.excluded) {
        continue;
      }
      
      sheetInfo.push({
        name: sheet.getName(),
        rows: lastRow,
        cols: lastCol,
        type: sheetType.type,
        description: sheetType.description,
        recommended: sheetType.recommended,
        protectedRows: sheetType.protectedRows || 0,
        isDangerous: sheetType.isDangerous || false,
        isRecommended: sheetType.isRecommended || false,
        index: i
      });
    }
    
    return { 
      success: true, 
      spreadsheetName: sourceSS.getName(),
      sheets: sheetInfo 
    };
    
  } catch (e) {
    return { success: false, error: 'ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã‚’é–‹ã‘ã¾ã›ã‚“: ' + e.message };
  }
}

function detectSheetType_(sheetName) {
  // å‡ºå“ç”¨ã‚·ãƒ¼ãƒˆã¯é™¤å¤–ï¼ˆé¸æŠè‚¢ã«è¡¨ç¤ºã—ãªã„ï¼‰
  if (sheetName.indexOf('å‡ºå“ç”¨') >= 0 || sheetName === 'å‡ºå“ç”¨ã‚·ãƒ¼ãƒˆ') {
    return {
      type: 'excluded',
      description: 'ã‚¤ãƒ³ãƒãƒ¼ãƒˆå¯¾è±¡å¤–',
      recommended: null,
      protectedRows: 0,
      excluded: true
    };
  }
  
  var types = {
    // ğŸ”´ å±é™ºãªã‚·ãƒ¼ãƒˆ
    'ä½œæ¥­ã‚·ãƒ¼ãƒˆ': { 
      type: 'dangerous', 
      description: 'âš ï¸ã€è¦æ³¨æ„ã€‘ã“ã®ã‚·ãƒ¼ãƒˆã«ã¯é‡è¦ãªè¨ˆç®—å¼ãŒå«ã¾ã‚Œã¦ã„ã¾ã™ï¼\n' +
                   'ç†ç”±ï¼š\n' +
                   'â€¢ Gåˆ—ã«é‡è¦ãªè¨ˆç®—å¼ãŒã‚ã‚Šã€ã‚³ãƒ”ãƒ¼ã™ã‚‹ã¨å£Šã‚Œã¾ã™\n' +
                   'â€¢ ã‚»ãƒ«å‚ç…§ãŒå£Šã‚Œã¦ã‚·ãƒ¼ãƒˆå…¨ä½“ãŒå‹•ä½œã—ãªããªã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™\n' +
                   'â€¢ æ•°å¼ã‚„ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãŒä¸Šæ›¸ãã•ã‚Œã‚‹ã¨å¾©æ—§ãŒå›°é›£ã§ã™\n\n' +
                   'æ¨å¥¨æ–¹æ³•ï¼šæ‰‹ä½œæ¥­ã§ã®ã‚³ãƒ”ãƒšã€ã¾ãŸã¯ã€Œå€¤ã®ã¿è²¼ã‚Šä»˜ã‘ã€ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„',
      recommended: 'range_values_only',
      protectedRows: 4,
      isDangerous: true
    },
    
    // âœ… æ¨å¥¨ã‚·ãƒ¼ãƒˆ
    'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰': { 
      type: 'recommended', 
      description: 'ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿',
      recommended: 'full_copy',
      protectedRows: 0,
      isRecommended: true
    },
    'å‚ç…§ãƒ‡ãƒ¼ã‚¿': { 
      type: 'recommended', 
      description: 'ã‚«ãƒ†ã‚´ãƒªãƒ¼åˆ¥è¨­å®š',
      recommended: 'full_copy',
      protectedRows: 0,
      isRecommended: true
    },
    'ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ä¾é ¼ã‚·ãƒ¼ãƒˆ': { 
      type: 'recommended', 
      description: 'ãƒ‡ãƒ¼ã‚¿å…¥åŠ›ä¾é ¼ç”¨',
      recommended: 'full_copy',
      protectedRows: 0,
      isRecommended: true
    },
    
    // ãã®ä»–ã®ã‚·ãƒ¼ãƒˆï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰
    'Policy_Master': { 
      type: 'optional', 
      description: 'ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãƒ»ãƒãƒªã‚·ãƒ¼ãƒã‚¹ã‚¿ãƒ¼ï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰',
      recommended: null,
      protectedRows: 0
    },
    'Shipping_Rates': { 
      type: 'optional', 
      description: 'é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰',
      recommended: null,
      protectedRows: 0
    },
    'Shipping_Methods': { 
      type: 'optional', 
      description: 'é…é€æ–¹æ³•ãƒã‚¹ã‚¿ãƒ¼ï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰',
      recommended: null,
      protectedRows: 0
    },
    'Profit_Amounts': { 
      type: 'optional', 
      description: 'åˆ©ç›Šé¡ãƒ†ãƒ¼ãƒ–ãƒ«ï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰',
      recommended: null,
      protectedRows: 0
    },
    'GPT_Prompts': { 
      type: 'optional', 
      description: 'AIãƒ—ãƒ­ãƒ³ãƒ—ãƒˆè¨­å®šï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰',
      recommended: null,
      protectedRows: 0
    }
  };
  
  if (types[sheetName]) {
    return types[sheetName];
  }
  
  // ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã‚·ãƒ¼ãƒˆï¼ˆæ¨å¥¨ï¼‰
  if (sheetName.indexOf('ä¿å­˜ãƒ‡ãƒ¼ã‚¿_') === 0) {
    return {
      type: 'recommended',
      description: 'ä¿å­˜æ¸ˆã¿ãƒ‡ãƒ¼ã‚¿',
      recommended: 'append_values',
      protectedRows: 4,
      isRecommended: true
    };
  }
  
  // ãã®ä»–ï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰
  return {
    type: 'other',
    description: 'ãã®ä»–ã®ã‚·ãƒ¼ãƒˆï¼ˆåŸºæœ¬çš„ã«ä¸è¦ï¼‰',
    recommended: null,
    protectedRows: 0
  };
}

function getSheetPreview(sourceUrl, sheetName, startRow, endRow, condition) {
  try {
    var sourceSS = SpreadsheetApp.openByUrl(sourceUrl);
    var sheet = sourceSS.getSheetByName(sheetName);
    
    if (!sheet) {
      return { success: false, error: 'ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“' };
    }
    
    var actualStartRow = Math.max(1, parseInt(startRow) || 1);
    var actualEndRow = Math.min(sheet.getLastRow(), parseInt(endRow) || sheet.getLastRow());
    
    var matchingRows = [];
    if (condition && condition !== 'none') {
      for (var row = actualStartRow; row <= actualEndRow; row++) {
        if (matchesCondition_(sheet, row, condition)) {
          matchingRows.push(row);
        }
      }
    }
    
    var rowCount = condition && condition !== 'none' ? matchingRows.length : (actualEndRow - actualStartRow + 1);
    
    if (rowCount <= 0) {
      return { 
        success: true,
        preview: [],
        totalRows: 0,
        message: 'æ¡ä»¶ã«ä¸€è‡´ã™ã‚‹è¡ŒãŒã‚ã‚Šã¾ã›ã‚“'
      };
    }
    
    var previewRows = Math.min(10, rowCount);
    var previewData = [];
    
    if (condition && condition !== 'none') {
      for (var i = 0; i < Math.min(previewRows, matchingRows.length); i++) {
        var row = matchingRows[i];
        previewData.push(sheet.getRange(row, 1, 1, Math.min(10, sheet.getLastColumn())).getValues()[0]);
      }
    } else {
      previewData = sheet.getRange(actualStartRow, 1, previewRows, Math.min(10, sheet.getLastColumn())).getValues();
    }
    
    return {
      success: true,
      preview: previewData,
      totalRows: rowCount,
      actualStartRow: actualStartRow,
      actualEndRow: actualEndRow
    };
    
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function matchesCondition_(sheet, row, condition) {
  try {
    switch (condition) {
      case 'untranslated':
        var jpTitle = sheet.getRange(row, CONFIG.COLUMNS.JP_TITLE).getValue();
        var jpDesc = sheet.getRange(row, CONFIG.COLUMNS.JP_DESC).getValue();
        var costYen = Number(sheet.getRange(row, CONFIG.COLUMNS.COST_YEN).getValue());
        var enTitle = sheet.getRange(row, CONFIG.COLUMNS.EN_TITLE).getValue();
        return jpTitle && jpDesc && costYen > 0 && !enTitle;
        
      case 'translated':
        var enTitle = sheet.getRange(row, CONFIG.COLUMNS.EN_TITLE).getValue();
        var enDesc = sheet.getRange(row, CONFIG.COLUMNS.EN_DESC).getValue();
        return enTitle && enDesc;
        
      case 'has_error':
        var condition = sheet.getRange(row, CONFIG.COLUMNS.CONDITION).getValue();
        return condition === 'ã‚¨ãƒ©ãƒ¼';
        
      case 'no_template':
        var template = sheet.getRange(row, 5).getValue();
        return !template || template === 'ã‚¨ãƒ©ãƒ¼' || template === 'è©²å½“ãªã—';
        
      case 'no_policy':
        var policy = sheet.getRange(row, CONFIG.COLUMNS.SHIPPING_POLICY).getValue();
        return !policy || policy === 'ã‚¨ãƒ©ãƒ¼' || policy === 'è©²å½“ãªã—';
        
      case 'all':
        var jpTitle = sheet.getRange(row, CONFIG.COLUMNS.JP_TITLE).getValue();
        return !!jpTitle;
        
      default:
        return true;
    }
  } catch (e) {
    return false;
  }
}

function importWithUnifiedSettings(sourceUrl, importConfigs) {
  try {
    var sourceSS = SpreadsheetApp.openByUrl(sourceUrl);
    var targetSS = SpreadsheetApp.getActiveSpreadsheet();
    var results = [];
    
    for (var i = 0; i < importConfigs.length; i++) {
      var config = importConfigs[i];
      
      try {
        var result = importSheetWithConfig_(sourceSS, targetSS, config);
        results.push({
          sheetName: config.sheetName,
          success: true,
          rowsImported: result.rowsImported,
          mode: config.importMode
        });
      } catch (e) {
        console.error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼ [' + config.sheetName + ']: ' + e.message);
        results.push({
          sheetName: config.sheetName,
          success: false,
          error: e.message
        });
      }
    }
    
    return { success: true, results: results };
    
  } catch (e) {
    return { success: false, error: e.message };
  }
}

function importSheetWithConfig_(sourceSS, targetSS, config) {
  var sourceSheet = sourceSS.getSheetByName(config.sheetName);
  if (!sourceSheet) {
    throw new Error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚·ãƒ¼ãƒˆã€Œ' + config.sheetName + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  var targetSheetName = config.targetSheetName || config.sheetName;
  var sheetType = detectSheetType_(config.sheetName);
  
  switch (config.importMode) {
    case 'full_copy':
      return importFullCopy_(sourceSheet, targetSS, targetSheetName);
      
    case 'range_with_format':
      return importRangeWithFormat_(sourceSheet, targetSS, targetSheetName, config, sheetType);
      
    case 'range_values_only':
      return importRangeValuesOnly_(sourceSheet, targetSS, targetSheetName, config, sheetType);
      
    case 'append_values':
      return appendValuesToSheet_(sourceSheet, targetSS, targetSheetName, config, sheetType);
      
    case 'conditional':
      return importConditionalData_(sourceSheet, targetSS, targetSheetName, config, sheetType);
      
    default:
      throw new Error('ä¸æ˜ãªã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰: ' + config.importMode);
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ğŸ”§ ãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ»ã‚·ãƒ¼ãƒˆä½ç½®ã‚’å®Œå…¨ä¿æŒ
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/

function importFullCopy_(sourceSheet, targetSS, targetSheetName) {
  console.log('=== å®Œå…¨ã‚³ãƒ”ãƒ¼é–‹å§‹: ' + targetSheetName + ' ===');
  
  var lastRow = sourceSheet.getLastRow();
  var lastCol = sourceSheet.getLastColumn();
  
  if (lastRow === 0 || lastCol === 0) {
    throw new Error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ƒã‚·ãƒ¼ãƒˆã€Œ' + sourceSheet.getName() + 'ã€ã«ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
  }
  
  var existingSheet = targetSS.getSheetByName(targetSheetName);
  var originalPosition = null;
  
  if (existingSheet) {
    originalPosition = existingSheet.getIndex();
    console.log('æ—¢å­˜ã‚·ãƒ¼ãƒˆä½ç½®: ' + originalPosition);
    targetSS.deleteSheet(existingSheet);
  }
  
  var newSheet = sourceSheet.copyTo(targetSS);
  newSheet.setName(targetSheetName);
  
  console.log('âœ“ ã‚·ãƒ¼ãƒˆå…¨ä½“ã‚’ã‚³ãƒ”ãƒ¼å®Œäº†ï¼ˆãƒ‡ãƒ¼ã‚¿æ¤œè¨¼ãƒ»ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆå«ã‚€ï¼‰');
  
  if (originalPosition !== null) {
    targetSS.setActiveSheet(newSheet);
    targetSS.moveActiveSheet(originalPosition);
    console.log('âœ“ ã‚·ãƒ¼ãƒˆã‚’å…ƒã®ä½ç½®(' + originalPosition + ')ã«ç§»å‹•å®Œäº†');
  }
  
  console.log('=== å®Œå…¨ã‚³ãƒ”ãƒ¼å®Œäº†: ' + lastRow + 'è¡Œ ===');
  
  return { rowsImported: lastRow };
}

function importRangeWithFormat_(sourceSheet, targetSS, targetSheetName, config, sheetType) {
  console.log('=== ç¯„å›²æŒ‡å®šï¼ˆãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆè¾¼ã¿ï¼‰é–‹å§‹ ===');
  
  var targetSheet = targetSS.getSheetByName(targetSheetName);
  var isNewSheet = !targetSheet;
  
  if (!targetSheet) {
    targetSheet = targetSS.insertSheet(targetSheetName);
  }
  
  var startRow = parseInt(config.startRow) || 1;
  var endRow = parseInt(config.endRow) || sourceSheet.getLastRow();
  var startCol = parseInt(config.startCol) || 1;
  var endCol = parseInt(config.endCol) || sourceSheet.getLastColumn();
  
  var rowCount = endRow - startRow + 1;
  var colCount = endCol - startCol + 1;
  
  var targetStartRow = parseInt(config.targetStartRow) || startRow;
  var targetStartCol = parseInt(config.targetStartCol) || startCol;
  
  console.log('ã‚³ãƒ”ãƒ¼ç¯„å›²: è¡Œ' + startRow + 'ã€œ' + endRow + ', åˆ—' + startCol + 'ã€œ' + endCol);
  console.log('è²¼ã‚Šä»˜ã‘ä½ç½®: è¡Œ' + targetStartRow + ', åˆ—' + targetStartCol);
  
  if (rowCount <= 0 || colCount <= 0) {
    throw new Error('ç„¡åŠ¹ãªç¯„å›²ã§ã™');
  }
  
  var protectedRows = sheetType.protectedRows || 0;
  if (!isNewSheet && targetStartRow <= protectedRows) {
    throw new Error('1ã€œ' + protectedRows + 'è¡Œç›®ã¯ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚' + (protectedRows + 1) + 'è¡Œç›®ä»¥é™ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
  }
  
  var SKIP_COLUMN_G = 7;
  var isWorkSheet = (targetSheetName === 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ');
  
  if (isWorkSheet) {
    console.log('âš ï¸ ä½œæ¥­ã‚·ãƒ¼ãƒˆã®ãŸã‚ã€Gåˆ—ï¼ˆ7åˆ—ç›®ï¼‰ã¯é™¤å¤–ã—ã¾ã™');
  }
  
  try {
    for (var rowOffset = 0; rowOffset < rowCount; rowOffset++) {
      for (var colOffset = 0; colOffset < colCount; colOffset++) {
        var sourceCol = startCol + colOffset;
        var targetCol = targetStartCol + colOffset;
        
        if (isWorkSheet && (sourceCol === SKIP_COLUMN_G || targetCol === SKIP_COLUMN_G)) {
          continue;
        }
        
        var sourceCell = sourceSheet.getRange(startRow + rowOffset, sourceCol);
        var targetCell = targetSheet.getRange(targetStartRow + rowOffset, targetCol);
        
        targetCell.setValue(sourceCell.getValue());
        targetCell.setBackground(sourceCell.getBackground());
        targetCell.setFontColor(sourceCell.getFontColor());
        targetCell.setFontSize(sourceCell.getFontSize());
        targetCell.setFontWeight(sourceCell.getFontWeight());
        targetCell.setNumberFormat(sourceCell.getNumberFormat());
        targetCell.setHorizontalAlignment(sourceCell.getHorizontalAlignment());
      }
    }
    
    console.log('âœ“ å®Œå…¨ã‚³ãƒ”ãƒ¼å®Œäº†');
    
  } catch (e) {
    console.error('âŒ ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼: ' + e.message);
    throw new Error('ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
  
  console.log('=== ç¯„å›²æŒ‡å®šã‚³ãƒ”ãƒ¼å®Œäº† ===');
  return { rowsImported: rowCount };
}

function importRangeValuesOnly_(sourceSheet, targetSS, targetSheetName, config, sheetType) {
  console.log('=== ç¯„å›²æŒ‡å®šï¼ˆå€¤ã®ã¿ï¼‰é–‹å§‹ ===');
  
  var targetSheet = targetSS.getSheetByName(targetSheetName);
  var isNewSheet = !targetSheet;
  
  if (!targetSheet) {
    targetSheet = targetSS.insertSheet(targetSheetName);
  }
  
  var startRow = parseInt(config.startRow) || 1;
  var endRow = parseInt(config.endRow) || sourceSheet.getLastRow();
  var startCol = parseInt(config.startCol) || 1;
  var endCol = parseInt(config.endCol) || sourceSheet.getLastColumn();
  
  var rowCount = endRow - startRow + 1;
  var colCount = endCol - startCol + 1;
  
  var targetStartRow = parseInt(config.targetStartRow) || startRow;
  var targetStartCol = parseInt(config.targetStartCol) || startCol;
  
  console.log('ã‚³ãƒ”ãƒ¼ç¯„å›²: è¡Œ' + startRow + 'ã€œ' + endRow + ', åˆ—' + startCol + 'ã€œ' + endCol);
  console.log('è²¼ã‚Šä»˜ã‘ä½ç½®: è¡Œ' + targetStartRow + ', åˆ—' + targetStartCol);
  
  if (rowCount <= 0 || colCount <= 0) {
    throw new Error('ç„¡åŠ¹ãªç¯„å›²ã§ã™');
  }
  
  var protectedRows = sheetType.protectedRows || 0;
  if (!isNewSheet && targetStartRow <= protectedRows) {
    throw new Error('1ã€œ' + protectedRows + 'è¡Œç›®ã¯ä¿è­·ã•ã‚Œã¦ã„ã¾ã™ã€‚' + (protectedRows + 1) + 'è¡Œç›®ä»¥é™ã‚’æŒ‡å®šã—ã¦ãã ã•ã„ã€‚');
  }
  
  var SKIP_COLUMN_G = 7;
  var isWorkSheet = (targetSheetName === 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ');
  
  if (isWorkSheet) {
    console.log('âš ï¸ ä½œæ¥­ã‚·ãƒ¼ãƒˆã®ãŸã‚ã€Gåˆ—ï¼ˆ7åˆ—ç›®ï¼‰ã¯é™¤å¤–ã—ã¾ã™');
  }
  
  try {
    for (var rowOffset = 0; rowOffset < rowCount; rowOffset++) {
      for (var colOffset = 0; colOffset < colCount; colOffset++) {
        var sourceCol = startCol + colOffset;
        var targetCol = targetStartCol + colOffset;
        
        if (isWorkSheet && (sourceCol === SKIP_COLUMN_G || targetCol === SKIP_COLUMN_G)) {
          continue;
        }
        
        var value = sourceSheet.getRange(startRow + rowOffset, sourceCol).getValue();
        targetSheet.getRange(targetStartRow + rowOffset, targetCol).setValue(value);
      }
    }
    
    console.log('âœ“ å€¤ã®ã‚³ãƒ”ãƒ¼å®Œäº†');
    
  } catch (e) {
    console.error('âŒ ã‚³ãƒ”ãƒ¼ã‚¨ãƒ©ãƒ¼: ' + e.message);
    throw new Error('ãƒ‡ãƒ¼ã‚¿ã‚³ãƒ”ãƒ¼ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
  
  console.log('=== å€¤ã®ã¿ã‚³ãƒ”ãƒ¼å®Œäº† ===');
  return { rowsImported: rowCount };
}

function appendValuesToSheet_(sourceSheet, targetSS, targetSheetName, config, sheetType) {
  console.log('=== è¿½åŠ ãƒ¢ãƒ¼ãƒ‰é–‹å§‹ ===');
  
  var targetSheet = targetSS.getSheetByName(targetSheetName);
  if (!targetSheet) {
    throw new Error('è¿½åŠ å…ˆã‚·ãƒ¼ãƒˆã€Œ' + targetSheetName + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  var startRow = parseInt(config.startRow) || 1;
  var endRow = parseInt(config.endRow) || sourceSheet.getLastRow();
  var startCol = parseInt(config.startCol) || 1;
  var endCol = parseInt(config.endCol) || sourceSheet.getLastColumn();
  
  var rowCount = endRow - startRow + 1;
  var colCount = endCol - startCol + 1;
  
  if (rowCount <= 0 || colCount <= 0) {
    throw new Error('ç„¡åŠ¹ãªç¯„å›²ã§ã™');
  }
  
  var protectedRows = sheetType.protectedRows || 0;
  var targetLastRow = targetSheet.getLastRow();
  var targetRow = Math.max(5, targetLastRow + 1);
  var targetCol = startCol;
  
  console.log('è¿½åŠ ä½ç½®: è¡Œ' + targetRow + ', åˆ—' + targetCol);
  
  var SKIP_COLUMN_G = 7;
  var isWorkSheet = (targetSheetName === 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ');
  
  if (isWorkSheet) {
    console.log('âš ï¸ ä½œæ¥­ã‚·ãƒ¼ãƒˆã®ãŸã‚ã€Gåˆ—ï¼ˆ7åˆ—ç›®ï¼‰ã¯é™¤å¤–ã—ã¾ã™');
  }
  
  try {
    for (var rowOffset = 0; rowOffset < rowCount; rowOffset++) {
      for (var colOffset = 0; colOffset < colCount; colOffset++) {
        var sourceCol = startCol + colOffset;
        var targetColActual = targetCol + colOffset;
        
        if (isWorkSheet && (sourceCol === SKIP_COLUMN_G || targetColActual === SKIP_COLUMN_G)) {
          continue;
        }
        
        var sourceCell = sourceSheet.getRange(startRow + rowOffset, sourceCol);
        var targetCell = targetSheet.getRange(targetRow + rowOffset, targetColActual);
        
        try {
          targetCell.setValue(sourceCell.getValue());
          
          if (config.includeFormat) {
            targetCell.setBackground(sourceCell.getBackground());
            targetCell.setFontColor(sourceCell.getFontColor());
            targetCell.setFontSize(sourceCell.getFontSize());
            targetCell.setNumberFormat(sourceCell.getNumberFormat());
          }
        } catch (cellError) {
          console.warn('âš ï¸ ã‚»ãƒ«ã‚³ãƒ”ãƒ¼è­¦å‘Š: ' + cellError.message);
        }
      }
    }
    
    console.log('âœ“ å€¤ã®ã‚³ãƒ”ãƒ¼å®Œäº†');
    
  } catch (e) {
    console.error('âŒ è¿½åŠ ã‚¨ãƒ©ãƒ¼: ' + e.message);
    throw new Error('ãƒ‡ãƒ¼ã‚¿è¿½åŠ ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
  
  console.log('=== è¿½åŠ ãƒ¢ãƒ¼ãƒ‰å®Œäº†: ' + rowCount + 'è¡Œ ===');
  return { rowsImported: rowCount };
}

function importConditionalData_(sourceSheet, targetSS, targetSheetName, config, sheetType) {
  console.log('=== æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆé–‹å§‹ ===');
  
  var targetSheet = targetSS.getSheetByName(targetSheetName);
  if (!targetSheet) {
    throw new Error('ã‚¤ãƒ³ãƒãƒ¼ãƒˆå…ˆã‚·ãƒ¼ãƒˆã€Œ' + targetSheetName + 'ã€ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
  }
  
  var startRow = parseInt(config.startRow) || 5;
  var endRow = parseInt(config.endRow) || sourceSheet.getLastRow();
  var condition = config.condition || 'untranslated';
  
  var protectedRows = sheetType.protectedRows || 4;
  var targetLastRow = targetSheet.getLastRow();
  var targetRow = Math.max(5, targetLastRow + 1);
  
  console.log('æ¡ä»¶: ' + condition);
  console.log('æ¤œç´¢ç¯„å›²: ' + startRow + 'ã€œ' + endRow + 'è¡Œ');
  console.log('è¿½åŠ é–‹å§‹ä½ç½®: ' + targetRow + 'è¡Œç›®');
  
  var importedCount = 0;
  var lastCol = sourceSheet.getLastColumn();
  
  var SKIP_COLUMN_G = 7;
  var isWorkSheet = (targetSheetName === 'ä½œæ¥­ã‚·ãƒ¼ãƒˆ');
  
  if (isWorkSheet) {
    console.log('âš ï¸ ä½œæ¥­ã‚·ãƒ¼ãƒˆã®ãŸã‚ã€Gåˆ—ï¼ˆ7åˆ—ç›®ï¼‰ã¯é™¤å¤–ã—ã¾ã™');
  }
  
  try {
    for (var row = startRow; row <= endRow; row++) {
      if (matchesCondition_(sourceSheet, row, condition)) {
        
        for (var col = 1; col <= lastCol; col++) {
          if (isWorkSheet && col === SKIP_COLUMN_G) {
            continue;
          }
          
          var sourceCell = sourceSheet.getRange(row, col);
          var targetCell = targetSheet.getRange(targetRow, col);
          
          try {
            targetCell.setValue(sourceCell.getValue());
            
            if (config.includeFormat) {
              targetCell.setBackground(sourceCell.getBackground());
              targetCell.setFontColor(sourceCell.getFontColor());
              targetCell.setFontSize(sourceCell.getFontSize());
              targetCell.setFontWeight(sourceCell.getFontWeight());
              targetCell.setNumberFormat(sourceCell.getNumberFormat());
              targetCell.setHorizontalAlignment(sourceCell.getHorizontalAlignment());
            }
          } catch (cellError) {
            console.warn('âš ï¸ ã‚»ãƒ«ã‚³ãƒ”ãƒ¼è­¦å‘Šï¼ˆè¡Œ' + targetRow + ', åˆ—' + col + 'ï¼‰: ' + cellError.message);
          }
        }
        
        targetRow++;
        importedCount++;
        
        if (importedCount % 50 === 0) {
          console.log('é€²æ—: ' + importedCount + 'è¡Œå‡¦ç†å®Œäº†');
        }
      }
    }
    
  } catch (e) {
    console.error('âŒ æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚¨ãƒ©ãƒ¼: ' + e.message);
    throw new Error('æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
  
  console.log('=== æ¡ä»¶ä»˜ãã‚¤ãƒ³ãƒãƒ¼ãƒˆå®Œäº†: ' + importedCount + 'è¡Œ ===');
  return { rowsImported: importedCount };
}