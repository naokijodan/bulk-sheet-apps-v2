/******************************************************
 * Config.gs - 設定と定数
 * - CONFIG定数
 * - 設定の保存・読み込み
 * - 価格表示モード管理
 ******************************************************/

/*━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  CONFIG / 定数
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━*/
var CONFIG = {
  API_TIMEOUT: 60000,
  BATCH_SIZE: 5,
  SLEEP_BETWEEN_API_CALLS: 1500,
  SLEEP_BETWEEN_BATCHES: 3000,
  MAX_RETRIES: 3,
  CONTINUATION_INTERVAL_MINUTES: 1,
  PARALLEL_REQUESTS: 10,   // 1バッチで同時に投げるAIリクエスト数

  // 列番号（1-based）
  COLUMNS: {
    JP_TITLE: 10, JP_DESC: 11, COST_YEN: 9, EN_TITLE: 13, EN_DESC: 14,
    SHIPPING_POLICY: 15,
    TITLE_LENGTH: 16,  // P列: タイトルの長さ
    DESC_LENGTH: 17,   // Q列: 説明文の長さ
    PRICE: 18,
    TAX_INCLUDED_PRICE: 19,
    SHIPPING: 20,
    PROFIT: 21,
    FEE: 22,
    RATE: 23,
    METHOD: 24,
    WEIGHT: 25,
    LENGTH: 26,        // Z列: 長さ (cm)
    WIDTH: 27,         // AA列: 幅 (cm)
    HEIGHT: 28,        // AB列: 高さ (cm)
    VOLUME: 29,        // AC列: 容積重量
    ESTIMATED_TAX: 30, // AD列
    CONDITION: 31,     // AE列
    EBAY_CATEGORY: 32, // AF列
    DDU_ADJUSTED_PRICE: 33  // AG列
  },

  // 料金・見積
  RATES: {
    PLATFORMS: {
      openai: {
        models: {
          'gpt-5-nano':  { combined: 0.0003 },
          'gpt-5-mini':  { combined: 0.0006 },
          'gpt-4o-mini': { combined: 0.0006 },
          'gpt-4o':      { combined: 0.015  },
          'gpt-4-turbo': { combined: 0.03   }
        }
      },
      claude: {
        models: {
          'claude-3-haiku-20240307':   { combined: 0.0015 },
          'claude-3-sonnet-20240229':  { combined: 0.015  },
          'claude-3-opus-20240229':    { combined: 0.075  }
        }
      },
      gemini: {
        models: {
          'gemini-1.5-flash': { combined: 0.0008 },
          'gemini-1.5-pro':   { combined: 0.0035 },
          'gemini-pro':       { combined: 0.005  }
        }
      }
    }
  },

  PRICE_DISPLAY_MODE: {
    DEFAULT_MODE: 'NORMAL',
    MODES: {
      NORMAL: 'NORMAL',
      TAX_INCLUDED: 'TAX_INCLUDED'
    }
  },

  SHIPPING_METHODS: {
    SP:  { name: 'Small Packet',   group: 'Economy', weightLimit: 2000, sizeLimit: 90,   calcType: 'actual'     },
    CE:  { name: 'Cpass-Economy',  group: 'Economy', weightLimit: 68000, sizeLimit: 0,   calcType: 'volumetric' },
    EMS: { name: 'EMS',            group: 'Express', weightLimit: 30000, sizeLimit: 1500, calcType: 'actual'     },
    CF:  { name: 'Cpass-FedEx',    group: 'Express', weightLimit: 68000, sizeLimit: 0,   calcType: 'volumetric' },
    CD:  { name: 'Cpass-DHL',      group: 'Express', weightLimit: 68000, sizeLimit: 0,   calcType: 'volumetric' },
    EL:  { name: 'eLogistics',     group: 'Express', weightLimit: 68000, sizeLimit: 0,   calcType: 'volumetric' },
    AM:  { name: 'Airmail',        group: 'Economy', weightLimit: 2000, sizeLimit: 0,   calcType: 'actual' }
  },

  SHIPPING_METHOD_OPTIONS: {
    lowPrice: {
      'SP': {
        name: 'Small Packet',
        displayName: 'Small Packet（重量・サイズ制限あり）',
        weightLimit: 2000,
        sizeLimit: 90
      },
      'CE': {
        name: 'Cpass-Economy',
        displayName: 'Cpass Economy（重量制限なし）',
        weightLimit: null,
        sizeLimit: null
      },
      'NONE': {
        name: 'なし',
        displayName: 'なし（高価格配送のみ使用）',
        weightLimit: null,
        sizeLimit: null
      }
    },
    highPrice: {
      'CF': {
        name: 'Cpass-FedEx',
        displayName: 'Cpass FedEx（燃油・割引・追加料金あり）',
        weightLimit: 68000
      },
      'CD': {
        name: 'Cpass-DHL',
        displayName: 'Cpass DHL（燃油・割引・追加料金あり）',
        weightLimit: 68000
      },
      'EL': {
        name: 'eLogistics',
        displayName: 'eLogistics（追加料金なし）',
        weightLimit: 68000
      }
    }
  },

  SHIPPING_RATE_COLUMNS: {
    SP: 3, CE: 4, EMS: 5, CF: 6, CD: 7, EL: 8
  },

  CONDITION_OPTIONS: ["新品", "中古", "エラー"],

  EBAY_CATEGORIES: [
    "Cell Phones & Smartphones", "Video Games", "Video Game Consoles", "Cameras & Photo",
    "Computer Components", "Consumer Electronics", "Audio Equipment", "Clothing", "Shoes",
    "Handbags & Purses", "Jewelry", "Watches", "Fashion Accessories", "Home Decor",
    "Kitchen & Dining", "Garden & Outdoor", "Tools & Hardware", "Action Figures",
    "Trading Cards", "Model Kits", "Other Toys", "Sports Equipment", "Outdoor Gear",
    "Fitness Equipment", "Books", "Movies & TV", "Music", "Video Games Software",
    "Skincare", "Makeup", "Health Supplements", "Office Supplies", "Industrial Equipment",
    "Car Parts", "Motorcycle Parts", "String Instruments", "Electronic Instruments",
    "Other Instruments", "Collectibles", "Antiques", "Art", "Other"
  ],

  SHIPPING_POLICY_CATEGORIES: {
    'Video Games': { limit: 20, display: 'Video Games (上限$20)' },
    'Video Game Consoles': { limit: 50, display: 'Video Game Consoles (上限$50)' },
    'Books': { limit: 20, display: 'Books (上限$20)' },
    'Movies & TV': { limit: 20, display: 'Movies & TV (上限$20)' },
    'Music': { limit: 25, display: 'Music (上限$25)' },
    'Other': { limit: null, display: 'その他（上限なし）' }
  },

  DDU_PRICE_ADJUSTMENT: {
    DEFAULT_ENABLED: false,
    DEFAULT_THRESHOLD: 900,
    DEFAULT_ADJUSTMENT: 200,
    HIGHLIGHT_COLOR: '#ffe0b3'
  }
};

/*━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  設定の取得
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━*/
function getSettings() {
  var props = PropertiesService.getScriptProperties();
  var platform = props.getProperty('AI_PLATFORM') || 'openai';
  var model = props.getProperty('AI_MODEL') || 'gpt-5-nano';
  var apiKey = (platform==='openai') ? props.getProperty('OPENAI_API_KEY') :
               (platform==='claude') ? props.getProperty('CLAUDE_API_KEY') :
               (platform==='gemini') ? props.getProperty('GEMINI_API_KEY') : '';

  var settings = {
    platform: platform,
    model: model,
    apiKey: apiKey,
    sheetName: props.getProperty('SHEET_NAME'),
    profitCalculationMethod: props.getProperty('PROFIT_CALC_METHOD'),
    promptId: props.getProperty('PROMPT_ID') || 'EBAY_FULL_LISTING_PROMPT',
    shippingThreshold: parseFloat(props.getProperty('SHIPPING_THRESHOLD')) || 20000,
    shippingCalculationMethod: props.getProperty('SHIPPING_CALC_METHOD') || 'TABLE',
    lowPriceShippingMethod: props.getProperty('LOW_PRICE_SHIPPING_METHOD') || 'SP',
    highPriceShippingMethod: props.getProperty('HIGH_PRICE_SHIPPING_METHOD') || 'CF',

    dduAdjustmentEnabled: props.getProperty('DDU_ADJUSTMENT_ENABLED') === 'true',
    dduThreshold: parseFloat(props.getProperty('DDU_THRESHOLD')) || CONFIG.DDU_PRICE_ADJUSTMENT.DEFAULT_THRESHOLD,
    dduAdjustmentAmount: parseFloat(props.getProperty('DDU_ADJUSTMENT_AMOUNT')) || CONFIG.DDU_PRICE_ADJUSTMENT.DEFAULT_ADJUSTMENT,

    priceDisplayMode: props.getProperty('PRICE_DISPLAY_MODE') || 'NORMAL',

    duplicateCheckEnabled: props.getProperty('DUPLICATE_CHECK_ENABLED') === 'true'
  };

  var missing = [];
  if (!settings.platform) missing.push('AIプラットフォーム');
  if (!settings.model) missing.push('AIモデル');
  if (!settings.apiKey) missing.push('APIキー');
  if (!settings.sheetName) missing.push('作業シート名');
  if (!settings.profitCalculationMethod) missing.push('利益計算方法');
  if (!settings.promptId) missing.push('プロンプトID');
  if (isNaN(settings.shippingThreshold)) missing.push('送料計算切替基準金額');
  if (!settings.shippingCalculationMethod) missing.push('送料計算方法');
  if (!settings.lowPriceShippingMethod) missing.push('低価格商品配送方法');
  if (!settings.highPriceShippingMethod) missing.push('高価格商品配送方法');

  if (missing.length > 0) {
    showAlert('設定不足:\n\n• ' + missing.join('\n• ') + '\n\n「初期設定」を実行してください。',"error");
    return null;
  }
  return settings;
}

/*━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  価格表示モード管理
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━*/
function getPriceDisplayMode() {
  var props = PropertiesService.getScriptProperties();
  var mode = props.getProperty('PRICE_DISPLAY_MODE');
  return (mode === 'TAX_INCLUDED') ? 'TAX_INCLUDED' : 'NORMAL';
}

function setPriceDisplayMode(mode, showMessage) {
  var props = PropertiesService.getScriptProperties();
  var validMode = (mode === 'TAX_INCLUDED') ? 'TAX_INCLUDED' : 'NORMAL';
  props.setProperty('PRICE_DISPLAY_MODE', validMode);

  if (showMessage === true) {
    var modeNames = {
      'NORMAL': '販売価格（通常）',
      'TAX_INCLUDED': '関税込み価格'
    };

    showAlert('価格表示モードを「' + modeNames[validMode] + '」に設定しました。', 'success');
  }
}

/*━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
  価格セルのハイライト設定
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━*/
function setPriceCellHighlight(sheet, row) {
  // ハイライト機能を無効化
  return;
}
