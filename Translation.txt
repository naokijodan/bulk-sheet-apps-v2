/******************************************************
 * Translation.gs - ç¿»è¨³å‡¦ç†
 * - é¸æŠè¡Œã®ç¿»è¨³å®Ÿè¡Œ (runSelectedRowsTranslate)
 * - ç¿»è¨³çµæœã®ã‚·ãƒ¼ãƒˆåæ˜ 
 * - ç¿»è¨³çµæœã®æ¤œè¨¼ (æ—¥æœ¬èªæ··å…¥ãƒã‚§ãƒƒã‚¯ã€æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯)
 * - é€²æ—ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤º
 ******************************************************/

function runSelectedRowsTranslate() {
  var SCRIPT_NAME = 'runSelectedRowsTranslate';
  var props = PropertiesService.getScriptProperties();
  var startTime = new Date();

  var totalPrompt = parseInt(props.getProperty('totalPrompt_translate') || '0');
  var totalCompletion = parseInt(props.getProperty('totalCompletion_translate') || '0');
  var processedCount = parseInt(props.getProperty('processedCount_translate') || '0');
  var errorCount = parseInt(props.getProperty('errorCount_translate') || '0');
  var skippedCount = parseInt(props.getProperty('skippedCount_translate') || '0');
  var validationErrorCount = 0; // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ä»¶æ•°
  var allRetryDetails = []; // å…¨ãƒãƒƒãƒã®ãƒªãƒˆãƒ©ã‚¤è©³ç´°

  var selectedRows;
  var startRowIndex = parseInt(props.getProperty('lastProcessedRowIndex_translate') || '0');

  try {
    var settings = getSettings();
    if (!settings) {
      clearProcessingState_translate();
      clearAllTriggers();
      return;
    }

    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName(settings.sheetName);
    if (!sheet) {
      showAlert('ä½œæ¥­ã‚·ãƒ¼ãƒˆãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚', 'error');
      clearProcessingState_translate();
      clearAllTriggers();
      return;
    }

    var isContinuing = props.getProperty('isProcessing_translate') === 'true' && props.getProperty('processingMode') === SCRIPT_NAME;

    if (!isContinuing) {
      clearProcessingState_translate();
      clearAllTriggers();
      updateExchangeRate(sheet);

      var active = sheet.getActiveRange();
      if (!active) {
        conditionalShowAlert("å‡¦ç†ã™ã‚‹è¡Œã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "info");
        return;
      }
      var startRow = active.getRow(), endRow = active.getLastRow();
      if (endRow < 5) {
        conditionalShowAlert("5è¡Œç›®ä»¥é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚", "info");
        return;
      }

      // ä¸€æ‹¬èª­ã¿å–ã‚Šã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
      selectedRows = [];
      var numRows = endRow - startRow + 1;
      var dataRange = sheet.getRange(startRow, 1, numRows, CONFIG.COLUMNS.EN_TITLE);
      var values = dataRange.getValues();

      for (var i = 0; i < values.length; i++) {
        var actualRow = startRow + i;
        if (actualRow < 5) { skippedCount++; continue; }

        var jpTitle = values[i][CONFIG.COLUMNS.JP_TITLE - 1];
        var jpDesc = values[i][CONFIG.COLUMNS.JP_DESC - 1];
        var costYen = Number(values[i][CONFIG.COLUMNS.COST_YEN - 1]);
        var enTitle = values[i][CONFIG.COLUMNS.EN_TITLE - 1];

        if (jpTitle && jpDesc && costYen && !enTitle) {
          selectedRows.push(actualRow);
        } else {
          skippedCount++;
        }
      }
      if (selectedRows.length === 0) {
        conditionalShowAlert("é¸æŠç¯„å›²ã«ç¿»è¨³å¯¾è±¡ãŒã‚ã‚Šã¾ã›ã‚“ã€‚", "info");
        return;
      }

      var platformNames = { openai:'OpenAI', claude:'Claude', gemini:'Gemini' };
      var confirmMessage = 'ã€ç¿»è¨³å°‚ç”¨ã€‘é¸æŠ ' + selectedRows.length + ' ä»¶ã‚’ç¿»è¨³ã—ã¾ã™ã€‚\n\n' +
        'AI: ' + platformNames[settings.platform] + ' / ' + settings.model + '\n\n' +
        'å‡ºåŠ›å†…å®¹:\n' +
        'â€¢ Måˆ—: è‹±èªã‚¿ã‚¤ãƒˆãƒ«\n' +
        'â€¢ Nåˆ—: è‹±èªèª¬æ˜\n' +
        'â€¢ ACåˆ—: å•†å“çŠ¶æ…‹(æ–°å“/ä¸­å¤)\n\n' +
        'ğŸ’¡ ä¾¡æ ¼è¨ˆç®—ã¯å®Ÿè¡Œã•ã‚Œã¾ã›ã‚“\n' +
        'ğŸ’¡ D2ã‚»ãƒ«ã§GO/STOPåˆ‡ã‚Šæ›¿ãˆå¯èƒ½\n' +
        'ğŸ’¡ ä¸¦åˆ—å‡¦ç†: 50è¡Œ/ãƒãƒƒãƒ\n\nã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ';

      var ok = conditionalStartConfirmation(confirmMessage, 'ç¿»è¨³å°‚ç”¨å®Ÿè¡Œã®ç¢ºèª');
      if (ok !== SpreadsheetApp.getUi().Button.YES) {
        conditionalShowAlert('ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã—ã¾ã—ãŸã€‚', "info");
        return;
      }

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’åˆæœŸåŒ–
      props.setProperty('sidebarProgress', JSON.stringify({
        currentBatch: 0,
        totalBatches: 0,
        successCount: 0,
        errorCount: 0,
        message: 'è¡Œãƒã‚§ãƒƒã‚¯é–‹å§‹...',
        logType: 'info'
      }));

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’å…ˆã«è¡¨ç¤ºï¼ˆãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ”¹å–„ï¼‰
      showProgressSidebar_();

      props.setProperty('targetRows_translate', JSON.stringify(selectedRows));
      props.setProperty('isProcessing_translate', 'true');
      props.setProperty('processingMode', SCRIPT_NAME);
      props.setProperty('startTime_translate', startTime.getTime().toString());
      props.setProperty('skippedCount_translate', skippedCount.toString());
      props.setProperty('lastProcessedRowIndex_translate', '0');
      startRowIndex = 0;

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: å‡¦ç†å¯¾è±¡ã‚’æ¤œå‡º
      updateProgressSidebar_({
        currentBatch: 0,
        totalBatches: 0,
        successCount: 0,
        errorCount: 0,
        message: 'å‡¦ç†å¯¾è±¡: ' + selectedRows.length + 'ä»¶ã‚’æ¤œå‡º',
        logType: 'info'
      });
    } else {
      selectedRows = JSON.parse(props.getProperty('targetRows_translate'));
      startTime = new Date(parseInt(props.getProperty('startTime_translate')));
      skippedCount = parseInt(props.getProperty('skippedCount_translate') || '0');
      conditionalShowAlert('ç¿»è¨³å‡¦ç†ã‚’å†é–‹ã—ã¾ã™ã€‚æ®‹ã‚Š ' + (selectedRows.length - startRowIndex) + 'ä»¶ã€‚', "info");
    }

    // P2ã‚»ãƒ«ã®å•†å“çŠ¶æ…‹ãƒ¢ãƒ¼ãƒ‰ã‚’1å›ã ã‘èª­ã¿å–ã‚‹
    var conditionMode = sheet.getRange("P2").getValue();

    // 25è¡Œãšã¤ãƒãƒƒãƒå‡¦ç†
    var TRANSLATE_BATCH_SIZE = 50;
    var batches = createBatches(selectedRows.slice(startRowIndex), TRANSLATE_BATCH_SIZE);
    var rowsSeenInThisRun = 0;
    var processedInThisBatch = 0;

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: å‡¦ç†é–‹å§‹
    updateProgressSidebar_({
      currentBatch: 0,
      totalBatches: batches.length,
      successCount: processedCount,
      errorCount: errorCount,
      message: 'ç¿»è¨³å‡¦ç†é–‹å§‹ (å…¨' + batches.length + 'ãƒãƒƒãƒ)',
      logType: 'info'
    });

    for (var bi = 0; bi < batches.length; bi++) {
      var batch = batches[bi];

      console.log('ğŸ“¦ ãƒãƒƒãƒ ' + (bi + 1) + '/' + batches.length + ' å‡¦ç†é–‹å§‹ (è¡Œæ•°: ' + batch.length + ')');

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒé–‹å§‹
      updateProgressSidebar_({
        currentBatch: bi + 1,
        totalBatches: batches.length,
        successCount: processedCount,
        errorCount: errorCount,
        message: 'ãƒãƒƒãƒ ' + (bi + 1) + '/' + batches.length + ' å‡¦ç†é–‹å§‹',
        logType: 'info'
      });

      // ä¸€æ‹¬èª­ã¿å–ã‚Šã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å‘ä¸Š
      var items = [];
      if (batch.length > 0) {
        var minRow = Math.min.apply(null, batch);
        var maxRow = Math.max.apply(null, batch);
        var batchDataRange = sheet.getRange(minRow, 1, maxRow - minRow + 1, CONFIG.COLUMNS.EN_TITLE);
        var batchValues = batchDataRange.getValues();

        for (var k = 0; k < batch.length; k++) {
          var row = batch[k];
          var rowIndex = row - minRow;
          var jpTitle = batchValues[rowIndex][CONFIG.COLUMNS.JP_TITLE - 1];
          var jpDesc = batchValues[rowIndex][CONFIG.COLUMNS.JP_DESC - 1];
          var costYen = Number(batchValues[rowIndex][CONFIG.COLUMNS.COST_YEN - 1]);
          var enTitle = batchValues[rowIndex][CONFIG.COLUMNS.EN_TITLE - 1];

          if (jpTitle && jpDesc && costYen > 0 && !enTitle) {
            items.push({ row: row, jpTitle: jpTitle, jpDesc: jpDesc, costYen: costYen });
          } else {
            skippedCount++;
          }
        }
      }

      if (items.length === 0) {
        console.log('  â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: å‡¦ç†å¯¾è±¡ãªã—');
        rowsSeenInThisRun += batch.length;
        continue;
      }

      // åˆå›ç¿»è¨³: ãƒãƒƒãƒå…¨ä½“ã‚’ä¸¦åˆ—å‡¦ç†
      var par = executeTranslationWithRetry_(items, settings, sheet, conditionMode, 1);

      var validatedItems = [];
      var failedItems = [];

      // ç¿»è¨³æˆåŠŸã—ãŸçµæœã‚’åé›†
      for (var idx = 0; idx < par.results.length; idx++) {
        var res = par.results[idx];

        if (res.ok) {
          validatedItems.push(res);
          totalPrompt += (res.usage && res.usage.in) || 0;
          totalCompletion += (res.usage && res.usage.out) || 0;
        } else {
          var errorMsg = 'è¡Œ' + res.row + ': ç¿»è¨³å¤±æ•—: ' + (res.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
          console.error('  âŒ ' + errorMsg);
          updateProgressSidebar_({
            currentBatch: bi + 1,
            totalBatches: batches.length,
            successCount: processedCount,
            errorCount: errorCount + failedItems.length + 1,
            message: 'âŒ ' + errorMsg,
            logType: 'error'
          });
          failedItems.push(items[idx]);
        }
      }

      // ç¿»è¨³æˆåŠŸã—ãŸçµæœã‚’ä¸€æ‹¬æ›¸ãè¾¼ã¿
      if (validatedItems.length > 0) {
        try {
          applyTranslationBatch_(sheet, validatedItems, conditionMode);
        } catch (eRow) {
          var errorMsg = 'ã‚·ãƒ¼ãƒˆåæ˜ ã‚¨ãƒ©ãƒ¼: ' + eRow.message;
          console.error('  âŒ ' + errorMsg);
          updateProgressSidebar_({
            currentBatch: bi + 1,
            totalBatches: batches.length,
            successCount: processedCount,
            errorCount: errorCount + validatedItems.length,
            message: 'âŒ ' + errorMsg,
            logType: 'error'
          });
          // å…¨è¡Œã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
          for (var errIdx = 0; errIdx < validatedItems.length; errIdx++) {
            failedItems.push(items[errIdx]);
          }
          validatedItems = [];
        }
      }

      // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å¼ã‚’å®Œäº†ã•ã›ã‚‹
      SpreadsheetApp.flush();

      // æ›¸ãè¾¼ã¿å¾Œã«ä¸€æ‹¬æ¤œè¨¼
      var revalidateFailedItems = [];

      if (validatedItems.length > 0) {
        var validationResults = validateTranslationBatch_(sheet, validatedItems);

        for (var vidx = 0; vidx < validationResults.length; vidx++) {
          var validation = validationResults[vidx];
          if (!validation.valid) {
            var errorMsg = 'è¡Œ' + validation.row + ': ' + validation.errors.join(', ');
            console.warn('  âš ï¸ ' + errorMsg);
            updateProgressSidebar_({
              currentBatch: bi + 1,
              totalBatches: batches.length,
              successCount: processedCount,
              errorCount: errorCount + revalidateFailedItems.length + 1,
              message: 'âŒ ' + errorMsg,
              logType: 'error'
            });
            revalidateFailedItems.push(items[vidx]);
          } else {
            processedCount++;
            processedInThisBatch++;
          }
        }
      }

      // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ãŒã‚ã£ãŸå ´åˆã¯å†è©¦è¡Œå¯¾è±¡ã«è¿½åŠ 
      for (var rfidx = 0; rfidx < revalidateFailedItems.length; rfidx++) {
        failedItems.push(revalidateFailedItems[rfidx]);
      }

      // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼è¡Œã®ã¿å†è©¦è¡Œ (æœ€å¤§3å›ã¾ã§)
      var remainingItems = failedItems;
      var maxRetries = 3;
      var retryAttempt = 1;

      while (remainingItems.length > 0 && retryAttempt < maxRetries) {
        console.log('  ğŸ” æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ ' + remainingItems.length + 'ä»¶ã‚’å†è©¦è¡Œã—ã¾ã™ (' + (retryAttempt + 1) + 'å›ç›®)');

        // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: å†è©¦è¡Œé–‹å§‹
        updateProgressSidebar_({
          currentBatch: bi + 1,
          totalBatches: batches.length,
          successCount: processedCount,
          errorCount: errorCount,
          message: 'ğŸ” ' + remainingItems.length + 'ä»¶ã‚’å†è©¦è¡Œä¸­ (' + (retryAttempt + 1) + 'å›ç›®)',
          logType: 'warning'
        });

        Utilities.sleep(2000);

        var retryPar = executeTranslationWithRetry_(remainingItems, settings, sheet, conditionMode, 1);

        var retryValidated = [];
        var retryFailed = [];

        // ç¿»è¨³æˆåŠŸã—ãŸçµæœã‚’åé›†
        for (var ridx = 0; ridx < retryPar.results.length; ridx++) {
          var rres = retryPar.results[ridx];

          if (rres.ok) {
            retryValidated.push(rres);
            totalPrompt += (rres.usage && rres.usage.in) || 0;
            totalCompletion += (rres.usage && rres.usage.out) || 0;
          } else {
            var errorMsg = 'è¡Œ' + rres.row + ': ç¿»è¨³å¤±æ•—(å†è©¦è¡Œ' + (retryAttempt + 1) + '): ' + (rres.error || 'ä¸æ˜ãªã‚¨ãƒ©ãƒ¼');
            console.error('  âŒ ' + errorMsg);
            updateProgressSidebar_({
              currentBatch: bi + 1,
              totalBatches: batches.length,
              successCount: processedCount,
              errorCount: errorCount + retryFailed.length + 1,
              message: 'âŒ ' + errorMsg,
              logType: 'error'
            });
            retryFailed.push(remainingItems[ridx]);
          }
        }

        // ç¿»è¨³æˆåŠŸã—ãŸçµæœã‚’ä¸€æ‹¬æ›¸ãè¾¼ã¿
        if (retryValidated.length > 0) {
          try {
            applyTranslationBatch_(sheet, retryValidated, conditionMode);
          } catch (eRow) {
            var errorMsg = 'ã‚·ãƒ¼ãƒˆåæ˜ ã‚¨ãƒ©ãƒ¼(å†è©¦è¡Œ' + (retryAttempt + 1) + '): ' + eRow.message;
            console.error('  âŒ ' + errorMsg);
            updateProgressSidebar_({
              currentBatch: bi + 1,
              totalBatches: batches.length,
              successCount: processedCount,
              errorCount: errorCount + retryValidated.length,
              message: 'âŒ ' + errorMsg,
              logType: 'error'
            });
            // å…¨è¡Œã‚’ã‚¨ãƒ©ãƒ¼ã¨ã—ã¦æ‰±ã†
            for (var errIdx = 0; errIdx < retryValidated.length; errIdx++) {
              retryFailed.push(remainingItems[errIdx]);
            }
            retryValidated = [];
          }
        }

        // ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆã®è¨ˆç®—å¼ã‚’å®Œäº†ã•ã›ã‚‹
        SpreadsheetApp.flush();

        // æ›¸ãè¾¼ã¿å¾Œã«ä¸€æ‹¬æ¤œè¨¼
        var retryRevalidateFailed = [];
        if (retryValidated.length > 0) {
          var retryValidationResults = validateTranslationBatch_(sheet, retryValidated);

          for (var rvidx = 0; rvidx < retryValidationResults.length; rvidx++) {
            var rvalidation = retryValidationResults[rvidx];
            if (!rvalidation.valid) {
              console.warn('  âš ï¸ è¡Œ' + rvalidation.row + ': æ¤œè¨¼ã‚¨ãƒ©ãƒ¼(è©¦è¡Œ' + (retryAttempt + 1) + '): ' + rvalidation.errors.join(', '));
              retryRevalidateFailed.push(remainingItems[rvidx]);
            } else {
              console.log('  âœ… è¡Œ' + rvalidation.row + ': å†è©¦è¡Œ' + (retryAttempt + 1) + 'å›ç›®ã§æˆåŠŸ');
              processedCount++;
              processedInThisBatch++;
              allRetryDetails.push({
                row: rvalidation.row,
                attempts: retryAttempt + 1,
                status: 'æˆåŠŸ'
              });
            }
          }
        }

        // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã‚’è¿½åŠ 
        for (var rrfidx = 0; rrfidx < retryRevalidateFailed.length; rrfidx++) {
          retryFailed.push(retryRevalidateFailed[rrfidx]);
        }

        remainingItems = retryFailed;
        retryAttempt++;
      }

      // æœ€çµ‚çš„ã«å¤±æ•—ã—ãŸè¡Œ
      for (var f = 0; f < remainingItems.length; f++) {
        errorCount++;
        validationErrorCount++;
        console.error('  ğŸ’€ è¡Œ' + remainingItems[f].row + ': ' + maxRetries + 'å›è©¦è¡Œå¾Œã‚‚å¤±æ•—');
        allRetryDetails.push({
          row: remainingItems[f].row,
          attempts: maxRetries,
          status: 'å¤±æ•—'
        });
      }

      console.log('âœ… ãƒãƒƒãƒ ' + (bi + 1) + ' å®Œäº† - ç¾åœ¨ã¾ã§ã®é€²æ—: æˆåŠŸ' + processedCount + 'ä»¶, ã‚¨ãƒ©ãƒ¼' + errorCount + 'ä»¶');

      // ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°: ãƒãƒƒãƒå®Œäº†
      updateProgressSidebar_({
        currentBatch: bi + 1,
        totalBatches: batches.length,
        successCount: processedCount,
        errorCount: errorCount,
        message: 'ãƒãƒƒãƒ ' + (bi + 1) + '/' + batches.length + ' å®Œäº† (æˆåŠŸ: ' + processedCount + ', ã‚¨ãƒ©ãƒ¼: ' + errorCount + ')',
        logType: 'success'
      });

      if (processedInThisBatch > 0 && processedInThisBatch % 5 === 0) {
        if (!checkStopControl()) {
          clearProcessingState_translate();
          clearAllTriggers();
          conditionalShowAlert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ã‚ˆã‚Šå‡¦ç†ãŒåœæ­¢ã•ã‚Œã¾ã—ãŸ(D2=STOP)ã€‚\nå‡¦ç†æ¸ˆã¿: ' + processedCount + 'ä»¶', 'warning');
          return;
        }
      }

      rowsSeenInThisRun += batch.length;
      props.setProperty('lastProcessedRowIndex_translate', (startRowIndex + rowsSeenInThisRun).toString());
      props.setProperty('totalPrompt_translate', totalPrompt.toString());
      props.setProperty('totalCompletion_translate', totalCompletion.toString());
      props.setProperty('processedCount_translate', processedCount.toString());
      props.setProperty('errorCount_translate', errorCount.toString());
      props.setProperty('skippedCount_translate', skippedCount.toString());

      if (bi < batches.length - 1) Utilities.sleep(500);

      var elapsed = (new Date().getTime() - startTime.getTime()) / 1000;
      if (elapsed > (240 - CONFIG.CONTINUATION_INTERVAL_MINUTES * 60)) {
        createSelfContinuationTrigger(SCRIPT_NAME);
        conditionalShowAlert("å‡¦ç†ã‚’ä¸€æ™‚åœæ­¢ã—ã€è‡ªå‹•å†é–‹ã—ã¾ã™ã€‚", "info");
        return;
      }
    }

    // å‡¦ç†å®Œäº†ã‚’ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«é€šçŸ¥
    updateProgressSidebar_({
      currentBatch: batches.length,
      totalBatches: batches.length,
      successCount: processedCount,
      errorCount: errorCount,
      message: 'âœ… ã™ã¹ã¦ã®å‡¦ç†ãŒå®Œäº†ã—ã¾ã—ãŸ',
      logType: 'success',
      isCompleted: true
    });

    clearProcessingState_translate();
    clearAllTriggers();

    var end = new Date();
    var duration = Math.round((end - startTime) / 1000);
    var usd = calculateTokenCostUSD(settings.platform, settings.model, totalPrompt, totalCompletion);
    var rate = sheet.getRange("C2").getValue() || 145;
    var avgTokens = processedCount > 0 ? Math.round((totalPrompt + totalCompletion) / processedCount) : 0;

    var report = 'âœ… ç¿»è¨³å‡¦ç†å®Œäº†\n\n' +
      'â±ï¸ å‡¦ç†æ™‚é–“: ' + duration + 'ç§’\n' +
      'âœ… æˆåŠŸ: ' + processedCount + 'ä»¶\n' +
      'â­ï¸ ã‚¹ã‚­ãƒƒãƒ—: ' + skippedCount + 'ä»¶\n' +
      'âŒ ã‚¨ãƒ©ãƒ¼: ' + errorCount + 'ä»¶';

    // æ¤œè¨¼ã‚¨ãƒ©ãƒ¼ã®è©³ç´°
    if (validationErrorCount > 0) {
      report += '\n   âš ï¸ ã†ã¡æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + validationErrorCount + 'ä»¶';
    }

    report += '\n\nğŸ“Š ãƒˆãƒ¼ã‚¯ãƒ³ä½¿ç”¨é‡:\n' +
      'â€¢ å…¥åŠ›: ' + totalPrompt.toLocaleString() + '\n' +
      'â€¢ å‡ºåŠ›: ' + totalCompletion.toLocaleString() + '\n' +
      'â€¢ åˆè¨ˆ: ' + (totalPrompt + totalCompletion).toLocaleString() + '\n' +
      'â€¢ å¹³å‡/ä»¶: ' + avgTokens + '\n' +
      'â€¢ æ¨å®šè²»ç”¨: $' + usd.toFixed(4) + '(ç´„' + Math.round(usd * rate) + 'å††, ' + settings.platform + ' / ' + settings.model + ')';

    // ãƒªãƒˆãƒ©ã‚¤è©³ç´°
    if (allRetryDetails.length > 0) {
      report += '\n\nğŸ” å†è©¦è¡Œã®è©³ç´°:\n';
      var retrySuccess = 0;
      var retryFailed = 0;
      var retryRows = [];

      for (var r = 0; r < allRetryDetails.length; r++) {
        var detail = allRetryDetails[r];
        if (detail.status === 'æˆåŠŸ') {
          retrySuccess++;
          retryRows.push('â€¢ è¡Œ' + detail.row + ': ' + detail.attempts + 'å›ç›®ã§æˆåŠŸ');
        } else {
          retryFailed++;
          retryRows.push('â€¢ è¡Œ' + detail.row + ': ' + detail.attempts + 'å›è©¦è¡Œå¾Œã‚‚å¤±æ•—');
        }
      }

      report += 'å†è©¦è¡Œã§æˆåŠŸ: ' + retrySuccess + 'ä»¶\n';
      report += 'å†è©¦è¡Œå¾Œã‚‚å¤±æ•—: ' + retryFailed + 'ä»¶\n';

      if (retryRows.length > 0 && retryRows.length <= 10) {
        report += '\n' + retryRows.join('\n');
      } else if (retryRows.length > 10) {
        report += '\n' + retryRows.slice(0, 10).join('\n');
        report += '\n...ä»–' + (retryRows.length - 10) + 'ä»¶';
      }
    }

    report += '\n\nğŸ’¡ ä¾¡æ ¼è¨ˆç®—ã¯ã€Œé¸æŠè¡Œã‚’è¨ˆç®—ã€ã§å®Ÿè¡Œã—ã¦ãã ã•ã„';

    conditionalShowAlert(report, "success");

  } catch (e) {
    showAlert('ç¿»è¨³å‡¦ç†ä¸­ã«ã‚¨ãƒ©ãƒ¼: ' + e.message, "error");
    clearProcessingState_translate();
    clearAllTriggers();
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç¿»è¨³çµæœã®ã¿ã‚’ã‚·ãƒ¼ãƒˆã«åæ˜ 
  P2ã‚»ãƒ«ã®å€¤ã¯å¤–éƒ¨ã‹ã‚‰å—ã‘å–ã‚‹
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function applyTranslationToRow_(sheet, row, fields, conditionMode) {
  try {
    // Måˆ—ãƒ»Nåˆ—ã®ã¿è¨­å®š
    sheet.getRange(row, CONFIG.COLUMNS.EN_TITLE).setValue(fields.title || '');
    sheet.getRange(row, CONFIG.COLUMNS.EN_DESC).setValue(fields.description || '');

    // å•†å“çŠ¶æ…‹ã®è¨­å®š:P2ã‚»ãƒ«ã®å€¤ã«å¿œã˜ã¦åˆ¤å®š
    var finalCondition;

    if (conditionMode === 'ä¸­å¤') {
      finalCondition = 'ä¸­å¤';
    } else if (conditionMode === 'æ–°å“') {
      finalCondition = 'æ–°å“';
    } else {
      // P2ãŒã€ŒAIã€ã¾ãŸã¯ãã®ä»–ã®å ´åˆ:AIã®åˆ¤å®šçµæœã‚’ä½¿ç”¨
      finalCondition = fields.condition;
    }

    // å•†å“çŠ¶æ…‹ã®å‡ºåŠ›(ãƒã‚¤ãƒ©ã‚¤ãƒˆãªã—ç‰ˆ)
    if (finalCondition) {
      var conditionCell = sheet.getRange(row, CONFIG.COLUMNS.CONDITION);
      var validConditions = CONFIG.CONDITION_OPTIONS;

      if (!validConditions.includes(finalCondition)) {
        conditionCell.setValue("ã‚¨ãƒ©ãƒ¼");
        conditionCell.setNote("å•†å“çŠ¶æ…‹ã‚’åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚");
      } else {
        conditionCell.setValue(finalCondition);
        if (finalCondition === "ã‚¨ãƒ©ãƒ¼") {
          conditionCell.setNote("å•†å“çŠ¶æ…‹ã®åˆ¤å®šãŒå›°é›£ã§ã™ã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚");
        } else {
          conditionCell.setNote("");
        }
      }
    }

  } catch (e) {
    console.error('ç¿»è¨³çµæœã®åæ˜ ã‚¨ãƒ©ãƒ¼(è¡Œ' + row + '): ' + e.message);
    throw e;
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ—¥æœ¬èªæ¤œå‡ºé–¢æ•°
  æ–‡å­—åˆ—ã«æ—¥æœ¬èª(ã²ã‚‰ãŒãªãƒ»ã‚«ã‚¿ã‚«ãƒŠãƒ»æ¼¢å­—)ãŒå«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function containsJapanese_(text) {
  if (!text) return false;
  // ã²ã‚‰ãŒãª: \u3040-\u309F
  // ã‚«ã‚¿ã‚«ãƒŠ: \u30A0-\u30FF
  // æ¼¢å­—: \u4E00-\u9FAF
  var japaneseRegex = /[\u3040-\u309F\u30A0-\u30FF\u4E00-\u9FAF]/;
  return japaneseRegex.test(String(text));
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç¿»è¨³çµæœã®æ¤œè¨¼é–¢æ•°
  Måˆ—ãƒ»Nåˆ—ã«æ—¥æœ¬èªãŒæ··å…¥ã—ã¦ã„ãªã„ã‹ãƒã‚§ãƒƒã‚¯
  Påˆ—ãŒ1ã€œ80ã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
  Qåˆ—ãŒ1ã€œ500ã®ç¯„å›²å†…ã‹ãƒã‚§ãƒƒã‚¯
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function validateTranslationResult_(sheet, row, fields) {
  var errors = [];

  try {
    // Måˆ—(EN_TITLE)ã®æ¤œè¨¼
    var enTitle = fields.title || sheet.getRange(row, CONFIG.COLUMNS.EN_TITLE).getValue();
    if (enTitle && containsJapanese_(enTitle)) {
      errors.push('Måˆ—(è‹±èªã‚¿ã‚¤ãƒˆãƒ«)ã«æ—¥æœ¬èªãŒæ··å…¥ã—ã¦ã„ã¾ã™');
    }

    // Nåˆ—(EN_DESC)ã®æ¤œè¨¼
    var enDesc = fields.description || sheet.getRange(row, CONFIG.COLUMNS.EN_DESC).getValue();
    if (enDesc && containsJapanese_(enDesc)) {
      errors.push('Nåˆ—(è‹±èªèª¬æ˜)ã«æ—¥æœ¬èªãŒæ··å…¥ã—ã¦ã„ã¾ã™');
    }

    // Påˆ—(TITLE_LENGTH)ã®æ¤œè¨¼ - ã‚¿ã‚¤ãƒˆãƒ«ã®é•·ã•
    var titleLength = Number(sheet.getRange(row, CONFIG.COLUMNS.TITLE_LENGTH).getValue());
    if (titleLength === 0) {
      errors.push('Påˆ—(ã‚¿ã‚¤ãƒˆãƒ«é•·ã•)ãŒ0ã§ã™');
    } else if (titleLength >= 81) {
      errors.push('Påˆ—(ã‚¿ã‚¤ãƒˆãƒ«é•·ã•)ãŒ81ä»¥ä¸Šã§ã™: ' + titleLength);
    }

    // Qåˆ—(DESC_LENGTH)ã®æ¤œè¨¼ - èª¬æ˜æ–‡ã®é•·ã•
    var descLength = Number(sheet.getRange(row, CONFIG.COLUMNS.DESC_LENGTH).getValue());
    if (descLength === 0) {
      errors.push('Qåˆ—(èª¬æ˜æ–‡é•·ã•)ãŒ0ã§ã™');
    } else if (descLength >= 799) {
      errors.push('Qåˆ—(èª¬æ˜æ–‡é•·ã•)ãŒ799ä»¥ä¸Šã§ã™: ' + descLength);
    }

    return {
      valid: errors.length === 0,
      errors: errors
    };

  } catch (e) {
    return {
      valid: false,
      errors: ['æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + e.message]
    };
  }
}

/**
 * é€²æ—ã‚µã‚¤ãƒ‰ãƒãƒ¼ã‚’è¡¨ç¤º
 */
function showProgressSidebar_() {
  try {
    var html = HtmlService.createHtmlOutputFromFile('ProgressSidebar')
      .setTitle('ç¿»è¨³å‡¦ç†ã®é€²æ—')
      .setWidth(320);
    SpreadsheetApp.getUi().showSidebar(html);
  } catch (e) {
    console.error('ã‚µã‚¤ãƒ‰ãƒãƒ¼è¡¨ç¤ºã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

/**
 * ã‚µã‚¤ãƒ‰ãƒãƒ¼ã«é€²æ—ã‚’é€ä¿¡
 */
function updateProgressSidebar_(data) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getActiveSheet();

    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
    var props = PropertiesService.getScriptProperties();
    props.setProperty('sidebarProgress', JSON.stringify(data));

    // ã‚µã‚¤ãƒ‰ãƒãƒ¼ãŒé–‹ã„ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã—ã¦æ›´æ–°
    // Note: Apps Scriptã§ã¯ã‚µã‚¤ãƒ‰ãƒãƒ¼ã¸ã®ç›´æ¥ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãƒ³ã‚°æ©Ÿèƒ½ãŒãªã„ãŸã‚ã€
    // ã‚µã‚¤ãƒ‰ãƒãƒ¼å´ã§ãƒãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹ã‹ã€ã‚·ãƒ¼ãƒˆä¸Šã®ã‚»ãƒ«ã‚’ä½¿ã£ã¦é€šä¿¡ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™
  } catch (e) {
    console.error('ã‚µã‚¤ãƒ‰ãƒãƒ¼æ›´æ–°ã‚¨ãƒ©ãƒ¼: ' + e.message);
  }
}

/**
 * ã‚µã‚¤ãƒ‰ãƒãƒ¼ç”¨:ç¾åœ¨ã®é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
 */
function getProgressData() {
  try {
    var props = PropertiesService.getScriptProperties();
    var data = props.getProperty('sidebarProgress');
    return data ? JSON.parse(data) : { currentBatch: 0, totalBatches: 0, successCount: 0, errorCount: 0 };
  } catch (e) {
    return { currentBatch: 0, totalBatches: 0, successCount: 0, errorCount: 0 };
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç¿»è¨³å°‚ç”¨ã®çŠ¶æ…‹ã‚¯ãƒªã‚¢
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function clearProcessingState_translate() {
  var props = PropertiesService.getScriptProperties();
  [
    'isProcessing_translate', 'lastProcessedRowIndex_translate',
    'totalPrompt_translate', 'totalCompletion_translate',
    'processedCount_translate', 'errorCount_translate', 'skippedCount_translate',
    'targetRows_translate', 'startTime_translate'
  ].forEach(function(k) { props.deleteProperty(k); });
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  ç¿»è¨³çµæœã®ä¸€æ‹¬æ›¸ãè¾¼ã¿ï¼ˆä¿®æ­£ç‰ˆ - ç©ºæ¬„è¾¼ã¿é«˜é€Ÿç‰ˆï¼‰
  
  ã€ä¿®æ­£å†…å®¹ã€‘
  ç©ºæ¬„ã®è¡Œã‚‚å«ã‚ãŸé…åˆ—ã‚’ä½œæˆã—ã¦ä¸€æ‹¬æ›¸ãè¾¼ã¿
  â†’ é«˜é€Ÿ + æ­£ç¢º
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function applyTranslationBatch_(sheet, results, conditionMode) {
  if (!results || results.length === 0) return;

  try {
    // ========================================
    // Step 1: æœ€å°è¡Œã¨æœ€å¤§è¡Œã‚’å–å¾—
    // ========================================
    var minRow = Math.min.apply(null, results.map(function(r) { return r.row; }));
    var maxRow = Math.max.apply(null, results.map(function(r) { return r.row; }));
    var rowCount = maxRow - minRow + 1;

    // ========================================
    // Step 2: resultsã‚’è¡Œç•ªå·ã§ãƒãƒƒãƒ—åŒ–ï¼ˆé«˜é€Ÿæ¤œç´¢ç”¨ï¼‰
    // ========================================
    var resultsMap = {};
    for (var i = 0; i < results.length; i++) {
      resultsMap[results[i].row] = results[i];
    }

    // ========================================
    // Step 3: æ—¢å­˜ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬èª­ã¿è¾¼ã¿ï¼ˆMåˆ—ãƒ»Nåˆ—ãƒ»AEåˆ—ï¼‰
    // ========================================
    var existingData = sheet.getRange(minRow, CONFIG.COLUMNS.EN_TITLE, rowCount, 2).getValues();
    var existingConditions = sheet.getRange(minRow, CONFIG.COLUMNS.CONDITION, rowCount, 1).getValues();

    // ========================================
    // Step 4: Måˆ—ãƒ»Nåˆ—ç”¨ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚’ä½œæˆï¼ˆæ—¢å­˜å€¤ä¿æŒï¼‰
    // ========================================
    var titleDescData = [];

    for (var row = minRow; row <= maxRow; row++) {
      var res = resultsMap[row];
      var idx = row - minRow;

      if (res) {
        // ãƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼šæ–°ã—ã„ç¿»è¨³çµæœã§ä¸Šæ›¸ã
        var fields = res.fields;
        titleDescData.push([
          fields.title || '',
          fields.description || ''
        ]);
      } else {
        // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼šæ—¢å­˜ã®å€¤ã‚’ä¿æŒ
        titleDescData.push([
          existingData[idx][0],
          existingData[idx][1]
        ]);
      }
    }

    // ========================================
    // Step 5: Måˆ—ãƒ»Nåˆ—ã‚’ä¸€æ‹¬æ›¸ãè¾¼ã¿
    // ========================================
    sheet.getRange(minRow, CONFIG.COLUMNS.EN_TITLE, rowCount, 2).setValues(titleDescData);

    // ========================================
    // Step 6: AEåˆ—ï¼ˆå•†å“çŠ¶æ…‹ï¼‰ã®ãƒ‡ãƒ¼ã‚¿é…åˆ—ã‚’ä½œæˆï¼ˆæ—¢å­˜å€¤ä¿æŒï¼‰
    // ========================================
    var conditionData = [];
    var conditionNotes = [];

    for (var row = minRow; row <= maxRow; row++) {
      var res = resultsMap[row];
      var idx = row - minRow;

      if (res) {
        // ãƒ‡ãƒ¼ã‚¿ã‚ã‚Šï¼šæ–°ã—ã„å•†å“çŠ¶æ…‹ã§ä¸Šæ›¸ã
        var fields = res.fields;

        // å•†å“çŠ¶æ…‹ã®æ±ºå®š
        var finalCondition;
        if (conditionMode === 'ä¸­å¤') {
          finalCondition = 'ä¸­å¤';
        } else if (conditionMode === 'æ–°å“') {
          finalCondition = 'æ–°å“';
        } else {
          finalCondition = fields.condition;
        }

        // å•†å“çŠ¶æ…‹ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³
        var validConditions = CONFIG.CONDITION_OPTIONS;
        var conditionValue;
        var conditionNote;

        if (!finalCondition || !validConditions.includes(finalCondition)) {
          conditionValue = "ã‚¨ãƒ©ãƒ¼";
          conditionNote = "å•†å“çŠ¶æ…‹ã‚’åˆ¤å®šã§ãã¾ã›ã‚“ã§ã—ãŸã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚";
        } else {
          conditionValue = finalCondition;
          if (finalCondition === "ã‚¨ãƒ©ãƒ¼") {
            conditionNote = "å•†å“çŠ¶æ…‹ã®åˆ¤å®šãŒå›°é›£ã§ã™ã€‚æ‰‹å‹•ã§é¸æŠã—ã¦ãã ã•ã„ã€‚";
          } else {
            conditionNote = "";
          }
        }

        conditionData.push([conditionValue]);
        conditionNotes.push({ row: row, note: conditionNote });
      } else {
        // ãƒ‡ãƒ¼ã‚¿ãªã—ï¼šæ—¢å­˜ã®å€¤ã‚’ä¿æŒ
        conditionData.push([existingConditions[idx][0]]);
        conditionNotes.push({ row: row, note: '' });
      }
    }

    // ========================================
    // Step 7: AEåˆ—ï¼ˆå•†å“çŠ¶æ…‹ï¼‰ã‚’ä¸€æ‹¬æ›¸ãè¾¼ã¿
    // ========================================
    sheet.getRange(minRow, CONFIG.COLUMNS.CONDITION, rowCount, 1).setValues(conditionData);

    // ========================================
    // Step 8: ãƒ¡ãƒ¢ã¯å€‹åˆ¥ã«è¨­å®šï¼ˆä¸€æ‹¬ãƒ¡ã‚½ãƒƒãƒ‰ãŒãªã„ãŸã‚ï¼‰
    // ========================================
    for (var j = 0; j < conditionNotes.length; j++) {
      var noteInfo = conditionNotes[j];
      if (noteInfo.note) {
        sheet.getRange(noteInfo.row, CONFIG.COLUMNS.CONDITION).setNote(noteInfo.note);
      }
      // æ—¢å­˜å€¤ä¿æŒã®å ´åˆã¯ãƒ¡ãƒ¢ã‚‚ãã®ã¾ã¾ï¼ˆclearNoteã—ãªã„ï¼‰
    }

  } catch (e) {
    console.error('ç¿»è¨³çµæœã®æ›¸ãè¾¼ã¿ã‚¨ãƒ©ãƒ¼: ' + e.message);
    throw e;
  }
}

/*â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  æ¤œè¨¼å‡¦ç†ã®ä¸€æ‹¬èª­ã¿å–ã‚Šï¼ˆæ€§èƒ½æ”¹å–„ç‰ˆï¼‰
â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”*/
function validateTranslationBatch_(sheet, results) {
  if (!results || results.length === 0) return [];

  try {
    var validationResults = [];

    // æ¤œè¨¼ã«å¿…è¦ãªåˆ—ã‚’ä¸€æ‹¬èª­ã¿è¾¼ã¿ (M, N, P, Qåˆ—)
    var firstRow = results[0].row;
    var lastRow = results[results.length - 1].row;

    // Måˆ—ï½Qåˆ—ã‚’èª­ã¿è¾¼ã¿ï¼ˆEN_TITLE=13, EN_DESC=14, TITLE_LENGTH=16, DESC_LENGTH=17ï¼‰
    var rangeM = sheet.getRange(firstRow, CONFIG.COLUMNS.EN_TITLE, results.length, 1).getValues();
    var rangeN = sheet.getRange(firstRow, CONFIG.COLUMNS.EN_DESC, results.length, 1).getValues();
    var rangeP = sheet.getRange(firstRow, CONFIG.COLUMNS.TITLE_LENGTH, results.length, 1).getValues();
    var rangeQ = sheet.getRange(firstRow, CONFIG.COLUMNS.DESC_LENGTH, results.length, 1).getValues();

    for (var i = 0; i < results.length; i++) {
      var res = results[i];
      var errors = [];

      var enTitle = rangeM[i][0];
      var enDesc = rangeN[i][0];
      var titleLength = Number(rangeP[i][0]);
      var descLength = Number(rangeQ[i][0]);

      // Måˆ—(EN_TITLE)ã®æ¤œè¨¼
      if (enTitle && containsJapanese_(enTitle)) {
        errors.push('Måˆ—(è‹±èªã‚¿ã‚¤ãƒˆãƒ«)ã«æ—¥æœ¬èªãŒæ··å…¥ã—ã¦ã„ã¾ã™');
      }

      // Nåˆ—(EN_DESC)ã®æ¤œè¨¼
      if (enDesc && containsJapanese_(enDesc)) {
        errors.push('Nåˆ—(è‹±èªèª¬æ˜)ã«æ—¥æœ¬èªãŒæ··å…¥ã—ã¦ã„ã¾ã™');
      }

      // Påˆ—(TITLE_LENGTH)ã®æ¤œè¨¼
      if (titleLength === 0) {
        errors.push('Påˆ—(ã‚¿ã‚¤ãƒˆãƒ«é•·ã•)ãŒ0ã§ã™');
      } else if (titleLength >= 81) {
        errors.push('Påˆ—(ã‚¿ã‚¤ãƒˆãƒ«é•·ã•)ãŒ81ä»¥ä¸Šã§ã™: ' + titleLength);
      }

      // Qåˆ—(DESC_LENGTH)ã®æ¤œè¨¼
      if (descLength === 0) {
        errors.push('Qåˆ—(èª¬æ˜æ–‡é•·ã•)ãŒ0ã§ã™');
      } else if (descLength >= 799) {
        errors.push('Qåˆ—(èª¬æ˜æ–‡é•·ã•)ãŒ799ä»¥ä¸Šã§ã™: ' + descLength);
      }

      validationResults.push({
        row: res.row,
        result: res,
        valid: errors.length === 0,
        errors: errors
      });
    }

    return validationResults;

  } catch (e) {
    console.error('ä¸€æ‹¬æ¤œè¨¼ã‚¨ãƒ©ãƒ¼: ' + e.message);
    return [];
  }
}
