<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ECä¾¡æ ¼è¨ˆç®—ãƒ„ãƒ¼ãƒ«</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1em;
        }

        .settings-section {
            background: #f8f9fa;
            padding: 25px;
            border-bottom: 2px solid #e9ecef;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #495057;
            font-size: 0.9em;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-group input,
        .input-group select {
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            transition: all 0.3s;
        }

        /* é‡è¦ãªé¸æŠé …ç›®ã‚’å¼·èª¿ */
        #shippingMode,
        #lowPriceMethod,
        #highPriceMethod,
        #shippingMethod {
            background-color: #e3f2fd;
        }

        .refresh-rate-btn {
            background: #17a2b8;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .refresh-rate-btn:hover {
            background: #138496;
        }

        .loading {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .save-settings-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
        }

        .save-settings-btn:hover {
            background: #218838;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.3);
        }

        .main-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(600px, 1fr));
            gap: 30px;
            padding: 30px;
        }

        .calculator-card {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: 12px;
            padding: 25px;
            transition: all 0.3s;
        }

        .calculator-card:hover {
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            transform: translateY(-4px);
        }

        .calculator-card.cost-calculation {
            background: #fff8f0;
            border: 2px solid #ffdbbb;
        }

        .calculator-card.cost-calculation:hover {
            box-shadow: 0 8px 24px rgba(255, 152, 0, 0.15);
        }

        .section-divider {
            grid-column: 1 / -1;
            margin: 30px 0;
            text-align: center;
        }

        .section-title {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border-radius: 10px;
            display: inline-block;
            font-size: 1.3em;
            font-weight: 700;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .section-title.cost-section {
            background: linear-gradient(135deg, #ff9800 0%, #ff6f00 100%);
            box-shadow: 0 4px 15px rgba(255, 152, 0, 0.3);
        }

        .calculator-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 3px solid #667eea;
            font-size: 1.5em;
        }

        .calculator-card.cost-calculation h2 {
            color: #ff6f00;
            border-bottom: 3px solid #ff9800;
        }

        .calc-input-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .calc-input-group {
            display: flex;
            flex-direction: column;
        }

        .calc-input-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #495057;
            font-size: 0.9em;
        }

        .calc-input-group input,
        .calc-input-group select {
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.95em;
        }

        .calculate-btn {
            width: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            margin-top: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .calculate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .result-section {
            margin-top: 25px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #667eea;
        }

        .result-section h3 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .result-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .result-item {
            background: white;
            padding: 15px;
            border-radius: 6px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .result-item label {
            display: block;
            font-size: 0.85em;
            color: #6c757d;
            margin-bottom: 5px;
            font-weight: 600;
        }

        .result-item .value {
            font-size: 1.3em;
            font-weight: 700;
            color: #212529;
        }

        .result-item.highlight .value {
            color: #667eea;
            font-size: 1.5em;
        }

        .tariff-table-section {
            grid-column: 1 / -1;
            margin-top: 20px;
        }

        .tariff-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .tariff-table th,
        .tariff-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }

        .tariff-table th {
            background: #667eea;
            color: white;
            font-weight: 600;
        }

        .tariff-table tr:hover {
            background: #f8f9fa;
        }

        @media (max-width: 1200px) {
            .settings-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }

            .settings-grid {
                grid-template-columns: 1fr;
            }

            .calc-input-row {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 1.8em;
            }
        }

        .hidden {
            display: none;
        }

        .note {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            font-size: 0.9em;
            color: #856404;
        }

        .formula {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
            padding: 15px;
            margin-top: 15px;
            border-radius: 6px;
            font-size: 0.85em;
            color: #0d47a1;
            font-family: 'Courier New', monospace;
            line-height: 1.6;
        }

        .formula strong {
            color: #1565c0;
        }

        .tutorial-btn {
            background: #4caf50;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            margin-left: 15px;
        }

        .tutorial-btn:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            animation: fadeIn 0.3s;
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 800px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 50px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s;
        }

        .modal-content h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 2em;
        }

        .modal-content h3 {
            color: #764ba2;
            margin-top: 25px;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .modal-content p {
            line-height: 1.8;
            color: #495057;
            margin-bottom: 15px;
        }

        .modal-content ul {
            margin-left: 20px;
            margin-bottom: 15px;
        }

        .modal-content li {
            margin-bottom: 10px;
            line-height: 1.6;
            color: #495057;
        }

        .close-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 30px;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .close-btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .step {
            background: #f8f9fa;
            padding: 15px;
            border-left: 4px solid #667eea;
            margin-bottom: 15px;
            border-radius: 6px;
        }

        .step strong {
            color: #667eea;
        }

        /* é€æ–™è©¦ç®—è¡¨ã‚¹ã‚¿ã‚¤ãƒ« */
        .shipping-estimate-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        .shipping-estimate-table th,
        .shipping-estimate-table td {
            padding: 8px 12px;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }
        .shipping-estimate-table th {
            font-weight: 600;
            color: #6c757d;
            font-size: 0.85em;
        }
        .shipping-estimate-table td {
            font-size: 0.95em;
        }
        .shipping-estimate-table .cost-cell {
            text-align: right;
            font-weight: 500;
        }
        .shipping-estimate-table .weight-cell {
            text-align: right;
            color: #6c757d;
            font-size: 0.85em;
        }
        .shipping-estimate-table tr.selected {
            background: linear-gradient(90deg, #fff3e0, #ffe0b2);
            border-left: 4px solid #ff9800;
        }
        .shipping-estimate-table tr.selected td {
            font-weight: 700;
            color: #e65100;
        }
        .shipping-estimate-table tr.unavailable td {
            color: #adb5bd;
            text-decoration: line-through;
        }
        .shipping-estimate-table tr:hover:not(.selected) {
            background-color: #f8f9fa;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ECä¾¡æ ¼è¨ˆç®—ãƒ„ãƒ¼ãƒ«</h1>
            <p>ä»•å…¥ã‚Œä¾¡æ ¼ã¨è²©å£²ä¾¡æ ¼ã‚’ç°¡å˜ã«è¨ˆç®—</p>
            <button class="tutorial-btn" onclick="openTutorial()">ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</button>
            <a href="tariff-table.html" class="tutorial-btn" style="text-decoration: none; margin-left: 10px; background: #ff9800;">é–¢ç¨å¯¾å¿œè¡¨</a>
        </div>

        <div class="settings-section">
            <h2 style="margin-bottom: 20px; color: #495057;">å…±é€šè¨­å®š</h2>
            <div class="settings-grid">
                <!-- 1æ®µç›®ï¼šç‚ºæ›¿ã€æ‰‹æ•°æ–™ç‡ã€åºƒå‘Šè²»ç‡ã€ãƒšã‚¤ã‚ªãƒ‹ã‚¢æ‰‹æ•°æ–™ -->
                <div class="input-group">
                    <label>
                        ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ (å††/ãƒ‰ãƒ«)
                        <button class="refresh-rate-btn" onclick="fetchExchangeRate()">æœ€æ–°å–å¾—</button>
                    </label>
                    <input type="number" id="exchangeRate" value="153.435" step="0.001">
                </div>
                <div class="input-group">
                    <label>æ‰‹æ•°æ–™ç‡ (%)</label>
                    <input type="number" id="feeRate" value="18" step="0.1">
                </div>
                <div class="input-group">
                    <label>åºƒå‘Šè²»ç‡ (%)</label>
                    <input type="number" id="adRate" value="10" step="0.1">
                </div>
                <div class="input-group">
                    <label>ãƒšã‚¤ã‚ªãƒ‹ã‚¢æ‰‹æ•°æ–™ (%)</label>
                    <input type="number" id="payoneerRate" value="2" step="0.1">
                </div>
                <div class="input-group">
                    <label>é€æ–™è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰</label>
                    <select id="shippingMode" onchange="toggleShippingMode()">
                        <option value="fixed">å›ºå®šé€æ–™</option>
                        <option value="table">ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—</option>
                    </select>
                </div>
                <!-- 2æ®µç›®ï¼šé–¢ç¨ç‡ã€å®‰å…¨ä¿‚æ•°ã€VATç‡ã€é–¢ç¨å‡¦ç†æ‰‹æ•°æ–™ç‡ã€ç±³å›½é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ã€MPFã€EUé€æ–™å·®é¡ -->
                <div class="input-group">
                    <label>é–¢ç¨ç‡ (%)</label>
                    <input type="number" id="tariffRate" value="15" step="0.1">
                </div>
                <div class="input-group">
                    <label>å®‰å…¨ä¿‚æ•° (%) <span style="font-size: 0.75em; color: #28a745;">â€»V3å¯¾å¿œ</span></label>
                    <input type="number" id="safetyMargin" value="3" step="0.1" title="ç«¯æ•°ãƒ»ç‚ºæ›¿å¤‰å‹•å¯¾ç­–ï¼ˆæ¨å¥¨: 3%ï¼‰">
                </div>
                <div class="input-group">
                    <label>VATç‡ (%)</label>
                    <input type="number" id="vatRate" value="0" step="0.1">
                </div>
                <div class="input-group">
                    <label>é–¢ç¨å‡¦ç†æ‰‹æ•°æ–™ç‡ (%)</label>
                    <input type="number" id="processingFeeRate" value="2.1" step="0.1">
                </div>
                <div class="input-group">
                    <label>CFç”¨é€šé–¢æ‰‹æ•°æ–™ (å††) <span style="font-size: 0.7em; color: #6c757d;">â€»å°†æ¥ç”¨/ç›´å¥‘ç´„ã¯åˆ¥é€”</span></label>
                    <input type="number" id="mpf" value="0" step="1" style="background-color: #f8f9fa;" title="Cpass-FedExç”¨ã€‚ç¾åœ¨ã¯0ã§é‹ç”¨ã€‚ç›´å¥‘ç´„ã®å ´åˆã¯åˆ¥é€”è¨­å®šãŒå¿…è¦ã€‚">
                </div>
                <div class="input-group">
                    <label>CEç”¨é€šé–¢æ‰‹æ•°æ–™ (å††) <span style="font-size: 0.75em; color: #28a745;">â€»CEæ™‚ã®ã¿é©ç”¨</span></label>
                    <input type="number" id="ceMpf" value="296" step="1">
                </div>
                <div class="input-group">
                    <label>MPF ($) <span style="font-size: 0.85em; color: #6c757d;">â€»Cpasså…é™¤</span></label>
                    <input type="number" id="mpfUsd" value="0" step="0.01">
                </div>
                <div class="input-group">
                    <label>EUé€æ–™å·®é¡ (å††)</label>
                    <input type="number" id="euShippingDiff" value="0" step="10">
                </div>
            </div>

            <!-- è‡ªå‹•é¸æŠè¨­å®šï¼ˆå…±é€šï¼‰ -->
            <div style="margin-top: 20px; padding: 20px; background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;">
                <h3 style="margin-bottom: 15px; color: #856404;">âš™ï¸ é…é€æ–¹æ³•è‡ªå‹•é¸æŠè¨­å®š</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>é€æ–™åˆ‡æ›¿åŸºæº–é‡‘é¡ (å††)</label>
                        <input type="number" id="shippingThreshold" value="5500" step="100">
                    </div>
                    <div class="input-group">
                        <label>ä½ä¾¡æ ¼å•†å“é…é€æ–¹æ³•</label>
                        <select id="lowPriceMethod">
                            <option value="EP" selected>eãƒ‘ã‚±ãƒƒãƒˆ</option>
                            <option value="CE">Cpass-Economy</option>
                            <option value="NONE">ãªã—</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label>é«˜ä¾¡æ ¼å•†å“é…é€æ–¹æ³•</label>
                        <select id="highPriceMethod">
                            <option value="CF" selected>Cpass-FedEx</option>
                            <option value="CD">Cpass-DHL</option>
                            <option value="EL">eLogistics</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 0.9em; color: #856404;">
                    <strong>ğŸ’¡ è‡ªå‹•é¸æŠãƒ­ã‚¸ãƒƒã‚¯:</strong><br>
                    â€¢ ä»•å…¥ã‚Œä¾¡æ ¼ â‰¥ åˆ‡æ›¿åŸºæº–é‡‘é¡ â†’ é«˜ä¾¡æ ¼å•†å“é…é€æ–¹æ³•<br>
                    â€¢ ä»•å…¥ã‚Œä¾¡æ ¼ &lt; åˆ‡æ›¿åŸºæº–é‡‘é¡ â†’ ä½ä¾¡æ ¼å•†å“é…é€æ–¹æ³•ï¼ˆeãƒ‘ã‚±ãƒƒãƒˆã¯2000gä»¥ä¸‹ã®ã¿ï¼‰<br>
                    â€¢ ä½ä¾¡æ ¼å•†å“é…é€æ–¹æ³•ãŒã€Œãªã—ã€ã®å ´åˆ â†’ å¸¸ã«é«˜ä¾¡æ ¼å•†å“é…é€æ–¹æ³•
                </div>
            </div>

            <!-- ç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ãƒ»å‰²å¼•è¨­å®š -->
            <div style="margin-top: 20px; padding: 20px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px;">
                <h3 style="margin-bottom: 15px; color: #2e7d32;">â›½ ç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ãƒ»å‰²å¼•è¨­å®š</h3>
                <div class="settings-grid">
                    <div class="input-group">
                        <label>FedExç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ (%)</label>
                        <input type="number" id="fedexFuelRate" value="29.75" step="0.25" oninput="calculateEstimatedShipping()">
                    </div>
                    <div class="input-group">
                        <label>DHLç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ (%)</label>
                        <input type="number" id="dhlFuelRate" value="30" step="0.25" oninput="calculateEstimatedShipping()">
                    </div>
                    <div class="input-group">
                        <label>Cpasså‰²å¼• (%)</label>
                        <input type="number" id="cpassDiscountRate" value="3" step="0.1" oninput="calculateEstimatedShipping()">
                    </div>
                    <div class="input-group">
                        <label>FedExè¶…éæ–™é‡‘ (å††/500g)</label>
                        <input type="number" id="fedexExtraPer500g" value="115" step="1" oninput="calculateEstimatedShipping()">
                    </div>
                    <div class="input-group">
                        <label>DHLè¶…éæ–™é‡‘ (å††/500g)</label>
                        <input type="number" id="dhlExtraPer500g" value="96" step="1" oninput="calculateEstimatedShipping()">
                    </div>
                </div>
                <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 5px; font-size: 0.9em; color: #2e7d32;">
                    <strong>ğŸ’¡ é€æ–™è¨ˆç®—å¼:</strong> åŸºæœ¬æ–™é‡‘ + è¶…éæ–™é‡‘ â†’ å°è¨ˆ Ã— (1 + ç‡ƒæ²¹ç‡) Ã— (1 - Cpasså‰²å¼•ç‡)
                </div>
            </div>

            <!-- é€æ–™è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰åˆ¥ã®è¨­å®š -->
            <div id="shippingSettings" style="margin-top: 20px;">
                <!-- å›ºå®šé€æ–™ãƒ¢ãƒ¼ãƒ‰ -->
                <div id="fixedShippingSettings" style="padding: 20px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: #2e7d32;">ğŸ’° å›ºå®šé€æ–™è¨­å®š</h3>
                    <div class="settings-grid">
                        <div class="input-group">
                            <label>é€æ–™ (å††)</label>
                            <input type="number" id="shippingCost" value="3000" step="100">
                        </div>
                    </div>
                </div>

                <!-- ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰ -->
                <div id="tableShippingSettings" class="hidden" style="padding: 20px; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px;">
                    <h3 style="margin-bottom: 15px; color: #1565c0;">ğŸ“¦ ãƒ†ãƒ¼ãƒ–ãƒ«è¨ˆç®—è¨­å®š</h3>

                    <!-- é‡é‡ãƒ»ã‚µã‚¤ã‚ºè¨­å®š -->
                    <div style="padding: 15px; background: white; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #1565c0; font-size: 1em;">é‡é‡ãƒ»ã‚µã‚¤ã‚º</h4>
                        <div class="settings-grid">
                            <div class="input-group">
                                <label>å®Ÿé‡é‡ (g)</label>
                                <input type="number" id="actualWeight" value="500" step="10" oninput="calculateVolumetricWeight()">
                            </div>
                            <div class="input-group">
                                <label>é•·ã• (cm)</label>
                                <input type="number" id="packageLength" value="20" step="1" oninput="calculateVolumetricWeight()">
                            </div>
                            <div class="input-group">
                                <label>å¹… (cm)</label>
                                <input type="number" id="packageWidth" value="20" step="1" oninput="calculateVolumetricWeight()">
                            </div>
                            <div class="input-group">
                                <label>é«˜ã• (cm)</label>
                                <input type="number" id="packageHeight" value="20" step="1" oninput="calculateVolumetricWeight()">
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                            <div class="input-group">
                                <label>å®¹ç©é‡é‡ (g) <span style="font-size: 0.8em; color: #1976d2;">CF/CD/EL/EMSç”¨ Ã·5</span></label>
                                <input type="number" id="volumetricWeight" value="0" step="10" readonly style="background-color: #e3f2fd; border-color: #1976d2;">
                            </div>
                            <div class="input-group">
                                <label>å®¹ç©é‡é‡ (g) <span style="font-size: 0.8em; color: #7b1fa2;">CEç”¨ Ã·8</span></label>
                                <input type="number" id="volumetricWeightCE" value="0" step="10" readonly style="background-color: #f3e5f5; border-color: #7b1fa2;">
                            </div>
                        </div>
                    </div>

                    <!-- é…é€æ–¹æ³•é¸æŠ -->
                    <div style="padding: 15px; background: white; border-radius: 5px; margin-bottom: 15px;">
                        <h4 style="margin: 0 0 15px 0; color: #1565c0; font-size: 1em;">é…é€æ–¹æ³•é¸æŠ</h4>
                        <div class="settings-grid">
                            <div class="input-group">
                                <label>é…é€æ–¹æ³•</label>
                                <select id="shippingMethod" onchange="calculateVolumetricWeight()">
                                    <option value="è‡ªå‹•é¸æŠ">è‡ªå‹•é¸æŠ</option>
                                    <option value="EP">eãƒ‘ã‚±ãƒƒãƒˆ</option>
                                    <option value="CF">Cpass-FedEx</option>
                                    <option value="CD">Cpass-DHL</option>
                                    <option value="EL">eLogistics</option>
                                    <option value="CE">Cpass-Economy</option>
                                    <option value="EMS">EMS</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- é€æ–™è©¦ç®—çµæœ -->
                    <div id="shippingEstimate" style="padding: 15px; background: #fff9c4; border: 2px solid #fbc02d; border-radius: 5px;">
                        <h4 style="margin: 0 0 10px 0; color: #f57f17;">ğŸ’¡ é€æ–™è©¦ç®—ï¼ˆå…¨é…é€æ–¹æ³•ï¼‰</h4>
                        <table class="shipping-estimate-table">
                            <thead>
                                <tr>
                                    <th>é…é€æ–¹æ³•</th>
                                    <th style="text-align: right;">èª²é‡‘é‡é‡</th>
                                    <th style="text-align: right;">é€æ–™</th>
                                </tr>
                            </thead>
                            <tbody id="shippingEstimateBody">
                                <!-- å‹•çš„ã«ç”Ÿæˆ -->
                            </tbody>
                        </table>
                        <div id="autoSelectNote" style="margin-top: 10px; padding: 8px; background: #fff3e0; border-radius: 4px; font-size: 0.85em; color: #e65100; display: none;">
                            â€» ã‚ªãƒ¬ãƒ³ã‚¸è‰²ã®è¡ŒãŒç¾åœ¨ã®è¨­å®šã§ä½¿ç”¨ã•ã‚Œã‚‹é…é€æ–¹æ³•ã§ã™
                        </div>
                    </div>
                </div>
            </div>

            <button class="save-settings-btn" onclick="saveSettings()" style="margin-top: 20px;">è¨­å®šã‚’ä¿å­˜</button>
        </div>

        <div class="main-content">
            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³: è²©å£²ä¾¡æ ¼ç®—å‡º -->
            <div class="section-divider">
                <div class="section-title">è²©å£²ä¾¡æ ¼ç®—å‡º</div>
            </div>

            <!-- åˆ©ç›Šé¡ãƒ™ãƒ¼ã‚¹: ä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼ -->
            <div class="calculator-card">
                <h2>åˆ©ç›Šé¡ã§è¨ˆç®—ï¼ˆä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼ï¼‰</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                        <input type="number" id="cost1" value="5000" step="1000">
                    </div>
                    <div class="calc-input-group">
                        <label>åˆ©ç›Šé¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="profit1" value="3000" step="100">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculatePriceFromCostProfit()">è¨ˆç®—ã™ã‚‹</button>
                <div id="result1" class="result-section hidden">
                    <h3>è¨ˆç®—çµæœ</h3>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>è²©å£²ä¾¡æ ¼ï¼ˆDDUï¼‰</label>
                            <div class="value" id="sellingPrice1">-</div>
                        </div>
                        <div class="result-item highlight">
                            <label>DDPä¾¡æ ¼</label>
                            <div class="value" id="ddpPrice1">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé€æ–™ï¼ˆå††ï¼‰</label>
                            <div class="value" id="shipping1">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒåˆ©ç›Šï¼ˆå††ï¼‰</label>
                            <div class="value" id="refProfit1">-</div>
                        </div>
                    </div>
                    <!-- é–¢ç¨é¡ã®æ¯”è¼ƒ -->
                    <div class="tariff-comparison-box" style="margin-top: 15px; padding: 15px; background: #fff8e1; border: 2px solid #ffc107; border-radius: 8px;">
                        <h4 style="color: #f57c00; margin-bottom: 10px;">é–¢ç¨é¡ã®æ¯”è¼ƒï¼ˆV3èª¿æ•´é–¢ç¨å¯¾å¿œï¼‰</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div style="background: white; padding: 10px; border-radius: 6px;">
                                <label style="font-size: 0.8em; color: #666;">å®Ÿéš›ã®é–¢ç¨é¡</label>
                                <div class="value" id="actualTariff1" style="color: #e91e63;">-</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px;">
                                <label style="font-size: 0.8em; color: #666;">èª¿æ•´å¾Œã®é–¢ç¨é¡</label>
                                <div class="value" id="adjustedTariff1" style="color: #4caf50;">-</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px;">
                                <label style="font-size: 0.8em; color: #666;">å·®é¡ï¼ˆæ‰‹æ•°æ–™è£œå¡«ï¼‰</label>
                                <div class="value" id="tariffDiff1" style="color: #ff9800;">-</div>
                            </div>
                        </div>
                        <div id="tariffCalcDetail1" class="formula" style="margin-top: 10px; background: #fffde7; font-size: 0.85em;">
                            <!-- è¨ˆç®—éç¨‹ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    <!-- ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼åˆ¤å®š -->
                    <div class="shipping-policy-box" id="policyBox1" style="margin-top: 15px; padding: 15px; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px;">
                        <h4 style="color: #1565c0; margin-bottom: 10px;">ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼åˆ¤å®š</h4>
                        <div id="policyContent1" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <span id="policyBadge1" style="display: inline-block; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.85em;"></span>
                            <code id="policyName1" style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; flex-grow: 1; word-break: break-all;"></code>
                            <button onclick="copyPolicyName('policyName1', this)" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">ã‚³ãƒ”ãƒ¼</button>
                        </div>
                        <div id="policyNotice1" style="display: none; color: #666; font-size: 0.9em;">â€» CEï¼ˆCpass-Economyï¼‰ã¾ãŸã¯CXï¼ˆCpass-FedExï¼‰é¸æŠæ™‚ã®ã¿åˆ¤å®šã•ã‚Œã¾ã™</div>
                    </div>
                    <!-- åˆ©ç›Šè¨ˆç®—ã®è©³ç´° -->
                    <div class="profit-calc-box" style="margin-top: 15px; padding: 15px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">åˆ©ç›Šé¡ã®ç®—å‡ºï¼ˆæ¤œè¨¼ç”¨ï¼‰</h4>
                        <div id="profitCalcDetail1" class="formula" style="background: #f1f8e9; font-size: 0.85em; line-height: 1.8;">
                            <!-- åˆ©ç›Šè¨ˆç®—éç¨‹ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    <div class="formula" style="margin-top: 15px;">
                        <strong>è¨ˆç®—å¼:</strong><br>
                        è²©å£²ä¾¡æ ¼ = (ä»•å…¥ã‚Œä¾¡æ ¼ + é€æ–™ + åˆ©ç›Šé¡) Ã· ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ Ã· (1 - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šè²»ç‡ - ãƒšã‚¤ã‚ªãƒ‹ã‚¢ç‡)<br>
                        èª¿æ•´é–¢ç¨ç‡ = å®Ÿéš›ã®é–¢ç¨ç‡ Ã· (1 - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šç‡) Ã— (1 + å®‰å…¨ä¿‚æ•°)<br>
                        èª¿æ•´å¾Œé–¢ç¨é¡ = è²©å£²ä¾¡æ ¼ Ã— èª¿æ•´é–¢ç¨ç‡ Ã— (1 + é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡) + ...<br>
                        DDPä¾¡æ ¼ = è²©å£²ä¾¡æ ¼ + èª¿æ•´å¾Œé–¢ç¨é¡
                    </div>
                </div>
            </div>

            <!-- åˆ©ç›Šç‡ãƒ™ãƒ¼ã‚¹: ä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼ -->
            <div class="calculator-card">
                <h2>åˆ©ç›Šç‡ã§è¨ˆç®—ï¼ˆä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼ï¼‰</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                        <input type="number" id="cost2" value="5000" step="1000">
                    </div>
                    <div class="calc-input-group">
                        <label>åˆ©ç›Šç‡ (%)</label>
                        <input type="number" id="profitRate2" value="20" step="1">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculatePriceFromCostProfitRate()">è¨ˆç®—ã™ã‚‹</button>
                <div id="result2" class="result-section hidden">
                    <h3>è¨ˆç®—çµæœ</h3>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>è²©å£²ä¾¡æ ¼ï¼ˆDDUï¼‰</label>
                            <div class="value" id="sellingPrice2">-</div>
                        </div>
                        <div class="result-item highlight">
                            <label>DDPä¾¡æ ¼</label>
                            <div class="value" id="ddpPrice2">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé€æ–™ï¼ˆå††ï¼‰</label>
                            <div class="value" id="shipping2">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒåˆ©ç›Šï¼ˆå††ï¼‰</label>
                            <div class="value" id="refProfit2">-</div>
                        </div>
                    </div>
                    <!-- é–¢ç¨é¡ã®æ¯”è¼ƒ -->
                    <div class="tariff-comparison-box" style="margin-top: 15px; padding: 15px; background: #fff8e1; border: 2px solid #ffc107; border-radius: 8px;">
                        <h4 style="color: #f57c00; margin-bottom: 10px;">é–¢ç¨é¡ã®æ¯”è¼ƒï¼ˆV3èª¿æ•´é–¢ç¨å¯¾å¿œï¼‰</h4>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; text-align: center;">
                            <div style="background: white; padding: 10px; border-radius: 6px;">
                                <label style="font-size: 0.8em; color: #666;">å®Ÿéš›ã®é–¢ç¨é¡</label>
                                <div class="value" id="actualTariff2" style="color: #e91e63;">-</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px;">
                                <label style="font-size: 0.8em; color: #666;">èª¿æ•´å¾Œã®é–¢ç¨é¡</label>
                                <div class="value" id="adjustedTariff2" style="color: #4caf50;">-</div>
                            </div>
                            <div style="background: white; padding: 10px; border-radius: 6px;">
                                <label style="font-size: 0.8em; color: #666;">å·®é¡ï¼ˆæ‰‹æ•°æ–™è£œå¡«ï¼‰</label>
                                <div class="value" id="tariffDiff2" style="color: #ff9800;">-</div>
                            </div>
                        </div>
                        <div id="tariffCalcDetail2" class="formula" style="margin-top: 10px; background: #fffde7; font-size: 0.85em;">
                        </div>
                    </div>
                    <!-- ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼åˆ¤å®š -->
                    <div class="shipping-policy-box" id="policyBox2" style="margin-top: 15px; padding: 15px; background: #e3f2fd; border: 2px solid #2196f3; border-radius: 8px;">
                        <h4 style="color: #1565c0; margin-bottom: 10px;">ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼åˆ¤å®š</h4>
                        <div id="policyContent2" style="display: flex; align-items: center; gap: 15px; flex-wrap: wrap;">
                            <span id="policyBadge2" style="display: inline-block; padding: 5px 12px; border-radius: 15px; font-weight: bold; font-size: 0.85em;"></span>
                            <code id="policyName2" style="background: white; padding: 8px 12px; border-radius: 6px; font-size: 0.9em; flex-grow: 1; word-break: break-all;"></code>
                            <button onclick="copyPolicyName('policyName2', this)" style="background: #2196f3; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 0.85em;">ã‚³ãƒ”ãƒ¼</button>
                        </div>
                        <div id="policyNotice2" style="display: none; color: #666; font-size: 0.9em;">â€» CEï¼ˆCpass-Economyï¼‰ã¾ãŸã¯CXï¼ˆCpass-FedExï¼‰é¸æŠæ™‚ã®ã¿åˆ¤å®šã•ã‚Œã¾ã™</div>
                    </div>
                    <!-- åˆ©ç›Šè¨ˆç®—ã®è©³ç´° -->
                    <div class="profit-calc-box" style="margin-top: 15px; padding: 15px; background: #e8f5e9; border: 2px solid #4caf50; border-radius: 8px;">
                        <h4 style="color: #2e7d32; margin-bottom: 10px;">åˆ©ç›Šé¡ã®ç®—å‡ºï¼ˆæ¤œè¨¼ç”¨ï¼‰</h4>
                        <div id="profitCalcDetail2" class="formula" style="background: #f1f8e9; font-size: 0.85em; line-height: 1.8;">
                            <!-- åˆ©ç›Šè¨ˆç®—éç¨‹ãŒå‹•çš„ã«è¡¨ç¤ºã•ã‚Œã‚‹ -->
                        </div>
                    </div>
                    <div class="formula" style="margin-top: 15px;">
                        <strong>è¨ˆç®—å¼:</strong><br>
                        è²©å£²ä¾¡æ ¼ = (ä»•å…¥ã‚Œä¾¡æ ¼ + é€æ–™) Ã· ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ Ã· (1 - åˆ©ç›Šç‡ - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šè²»ç‡ - ãƒšã‚¤ã‚ªãƒ‹ã‚¢ç‡)<br>
                        èª¿æ•´é–¢ç¨ç‡ = å®Ÿéš›ã®é–¢ç¨ç‡ Ã· (1 - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šç‡) Ã— (1 + å®‰å…¨ä¿‚æ•°)<br>
                        DDPä¾¡æ ¼ = è²©å£²ä¾¡æ ¼ + èª¿æ•´å¾Œé–¢ç¨é¡
                    </div>
                </div>
            </div>

            <!-- ã‚»ã‚¯ã‚·ãƒ§ãƒ³: ä»•å…¥ã‚Œä¾¡æ ¼ç®—å‡º -->
            <div class="section-divider">
                <div class="section-title cost-section">ä»•å…¥ã‚Œä¾¡æ ¼ç®—å‡º</div>
            </div>

            <!-- åˆ©ç›Šé¡ãƒ™ãƒ¼ã‚¹: è²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œ -->
            <div class="calculator-card cost-calculation">
                <h2>åˆ©ç›Šé¡ã§è¨ˆç®—ï¼ˆè²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œï¼‰</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>åˆ©ç›Šé¡ï¼ˆå††ï¼‰</label>
                        <input type="number" id="profit3" value="3000" step="100">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculateCostFromPriceProfit()">è¨ˆç®—ã™ã‚‹</button>

                <!-- DDUä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— -->
                <div id="result3-ddu" class="result-section hidden">
                    <h3>DDUä¾¡æ ¼ï¼ˆé–¢ç¨æŠœãï¼‰ã‹ã‚‰ç®—å‡º</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDUè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <input type="number" id="sellingPriceDDU3" value="500" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                            <div class="value" id="costPriceDDU3">-</div>
                        </div>
                        <div class="result-item">
                            <label>æƒ³å®šé–¢ç¨ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <div class="value" id="tariffDDU3">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé€æ–™ï¼ˆå††ï¼‰</label>
                            <div class="value" id="shippingDDU3">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒåˆ©ç›Šï¼ˆå††ï¼‰</label>
                            <div class="value" id="refProfitDDU3">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>è¨ˆç®—å¼:</strong><br>
                        ä»•å…¥ã‚Œä¾¡æ ¼ = (DDUè²©å£²ä¾¡æ ¼ Ã— ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ Ã— (1 - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šè²»ç‡ - ãƒšã‚¤ã‚ªãƒ‹ã‚¢ç‡)) - é€æ–™ - åˆ©ç›Šé¡<br>
                        æƒ³å®šé–¢ç¨ = è²©å£²ä¾¡æ ¼ Ã— é–¢ç¨ç‡ Ã— (1 + é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡) + è²©å£²ä¾¡æ ¼ Ã— VATç‡ Ã— é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡ + (é€šé–¢æ‰‹æ•°æ–™å†† Ã· ç‚ºæ›¿) + MPF($) + (EUé€æ–™å·®é¡å†† Ã· ç‚ºæ›¿)<br>
                        <small style="color: #6c757d;">â€»é€šé–¢æ‰‹æ•°æ–™: CFã¯ç¾çŠ¶0ã€CEã¯296å††ã€ç›´å¥‘ç´„ã¯åˆ¥é€”</small>
                    </div>
                </div>

                <!-- DDPä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— -->
                <div id="result3-ddp" class="result-section hidden" style="margin-top: 20px;">
                    <h3>DDPä¾¡æ ¼ï¼ˆé–¢ç¨è¾¼ã¿ï¼‰ã‹ã‚‰ç®—å‡º</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDPè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <input type="number" id="sellingPriceDDP3" value="610" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                            <div class="value" id="costPriceDDP3">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒDDUè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <div class="value" id="sellingPriceDDU_from_DDP3">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé–¢ç¨ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <div class="value" id="tariffDDP3">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé€æ–™ï¼ˆå††ï¼‰</label>
                            <div class="value" id="shippingDDP3">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒåˆ©ç›Šï¼ˆå††ï¼‰</label>
                            <div class="value" id="refProfitDDP3">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>è¨ˆç®—å¼:</strong><br>
                        â‘  DDUè²©å£²ä¾¡æ ¼ = DDPä¾¡æ ¼ - æƒ³å®šé–¢ç¨ï¼ˆåå¾©è¨ˆç®—ã§æ±‚ã‚ã‚‹ï¼‰<br>
                        â‘¡ ä»•å…¥ã‚Œä¾¡æ ¼ = (DDUè²©å£²ä¾¡æ ¼ Ã— ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ Ã— (1 - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šè²»ç‡ - ãƒšã‚¤ã‚ªãƒ‹ã‚¢ç‡)) - é€æ–™ - åˆ©ç›Š
                    </div>
                </div>
            </div>

            <!-- åˆ©ç›Šç‡ãƒ™ãƒ¼ã‚¹: è²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œ -->
            <div class="calculator-card cost-calculation">
                <h2>åˆ©ç›Šç‡ã§è¨ˆç®—ï¼ˆè²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œï¼‰</h2>
                <div class="calc-input-row">
                    <div class="calc-input-group">
                        <label>åˆ©ç›Šç‡ (%)</label>
                        <input type="number" id="profitRate4" value="20" step="1">
                    </div>
                </div>
                <button class="calculate-btn" onclick="calculateCostFromPriceProfitRate()">è¨ˆç®—ã™ã‚‹</button>

                <!-- DDUä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— -->
                <div id="result4-ddu" class="result-section hidden">
                    <h3>DDUä¾¡æ ¼ï¼ˆé–¢ç¨æŠœãï¼‰ã‹ã‚‰ç®—å‡º</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDUè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <input type="number" id="sellingPriceDDU4" value="500" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                            <div class="value" id="costPriceDDU4">-</div>
                        </div>
                        <div class="result-item">
                            <label>æƒ³å®šé–¢ç¨ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <div class="value" id="tariffDDU4">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé€æ–™ï¼ˆå††ï¼‰</label>
                            <div class="value" id="shippingDDU4">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒåˆ©ç›Šï¼ˆå††ï¼‰</label>
                            <div class="value" id="refProfitDDU4">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>è¨ˆç®—å¼:</strong><br>
                        ä»•å…¥ã‚Œä¾¡æ ¼ = (DDUè²©å£²ä¾¡æ ¼ Ã— ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ Ã— (1 - åˆ©ç›Šç‡ - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šè²»ç‡ - ãƒšã‚¤ã‚ªãƒ‹ã‚¢ç‡)) - é€æ–™<br>
                        æƒ³å®šé–¢ç¨ = è²©å£²ä¾¡æ ¼ Ã— é–¢ç¨ç‡ Ã— (1 + é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡) + è²©å£²ä¾¡æ ¼ Ã— VATç‡ Ã— é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡ + (é€šé–¢æ‰‹æ•°æ–™å†† Ã· ç‚ºæ›¿) + MPF($) + (EUé€æ–™å·®é¡å†† Ã· ç‚ºæ›¿)<br>
                        <small style="color: #6c757d;">â€»é€šé–¢æ‰‹æ•°æ–™: CFã¯ç¾çŠ¶0ã€CEã¯296å††ã€ç›´å¥‘ç´„ã¯åˆ¥é€”</small>
                    </div>
                </div>

                <!-- DDPä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— -->
                <div id="result4-ddp" class="result-section hidden" style="margin-top: 20px;">
                    <h3>DDPä¾¡æ ¼ï¼ˆé–¢ç¨è¾¼ã¿ï¼‰ã‹ã‚‰ç®—å‡º</h3>
                    <div class="calc-input-row" style="margin-bottom: 15px;">
                        <div class="calc-input-group">
                            <label>DDPè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <input type="number" id="sellingPriceDDP4" value="610" step="10">
                        </div>
                    </div>
                    <div class="result-grid">
                        <div class="result-item highlight">
                            <label>ä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰</label>
                            <div class="value" id="costPriceDDP4">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒDDUè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <div class="value" id="sellingPriceDDU_from_DDP4">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé–¢ç¨ï¼ˆãƒ‰ãƒ«ï¼‰</label>
                            <div class="value" id="tariffDDP4">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒé€æ–™ï¼ˆå††ï¼‰</label>
                            <div class="value" id="shippingDDP4">-</div>
                        </div>
                        <div class="result-item">
                            <label>å‚è€ƒåˆ©ç›Šï¼ˆå††ï¼‰</label>
                            <div class="value" id="refProfitDDP4">-</div>
                        </div>
                    </div>
                    <div class="formula">
                        <strong>è¨ˆç®—å¼:</strong><br>
                        â‘  DDUè²©å£²ä¾¡æ ¼ = DDPä¾¡æ ¼ - æƒ³å®šé–¢ç¨ï¼ˆåå¾©è¨ˆç®—ã§æ±‚ã‚ã‚‹ï¼‰<br>
                        â‘¡ ä»•å…¥ã‚Œä¾¡æ ¼ = (DDUè²©å£²ä¾¡æ ¼ Ã— ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ Ã— (1 - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šè²»ç‡ - ãƒšã‚¤ã‚ªãƒ‹ã‚¢ç‡)) - é€æ–™
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div id="tutorialModal" class="modal">
        <div class="modal-content">
            <h2>ä½¿ã„æ–¹ã‚¬ã‚¤ãƒ‰</h2>

            <h3>æ¦‚è¦</h3>
            <p>ã“ã®ãƒ„ãƒ¼ãƒ«ã¯ã€ECï¼ˆé›»å­å•†å–å¼•ï¼‰ã«ãŠã‘ã‚‹ä»•å…¥ã‚Œä¾¡æ ¼ã¨è²©å£²ä¾¡æ ¼ã‚’ç°¡å˜ã«è¨ˆç®—ã™ã‚‹ãŸã‚ã®ã‚‚ã®ã§ã™ã€‚é–¢ç¨ã€æ‰‹æ•°æ–™ã€é€æ–™ãªã©ã‚’è€ƒæ…®ã—ãŸæ­£ç¢ºãªä¾¡æ ¼è¨­å®šãŒå¯èƒ½ã§ã™ã€‚</p>

            <h3>å…±é€šè¨­å®šã«ã¤ã„ã¦</h3>
            <div class="step">
                <strong>ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆ:</strong> USD/JPYã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã€‚ã€Œæœ€æ–°å–å¾—ã€ãƒœã‚¿ãƒ³ã§è‡ªå‹•å–å¾—å¯èƒ½ã§ã™ã€‚<br>
                <strong>æ‰‹æ•°æ–™ç‡:</strong> ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ æ‰‹æ•°æ–™ã®å‰²åˆï¼ˆ%ï¼‰<br>
                <strong>åºƒå‘Šè²»ç‡:</strong> å£²ä¸Šã«å¯¾ã™ã‚‹åºƒå‘Šè²»ã®å‰²åˆï¼ˆ%ï¼‰<br>
                <strong>ãƒšã‚¤ã‚ªãƒ‹ã‚¢æ‰‹æ•°æ–™:</strong> æ±ºæ¸ˆæ‰‹æ•°æ–™ã®å‰²åˆï¼ˆ%ï¼‰<br>
                <strong>é€æ–™:</strong> å•†å“ã®é€æ–™ï¼ˆå††ï¼‰<br>
                <strong>é–¢ç¨ç‡:</strong> é–¢ç¨ã®å‰²åˆï¼ˆ%ï¼‰<br>
                <strong>VATç‡:</strong> ä»˜åŠ ä¾¡å€¤ç¨ã®å‰²åˆï¼ˆ%ï¼‰<br>
                <strong>é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡:</strong> é€šé–¢å‡¦ç†ã«ã‹ã‹ã‚‹æ‰‹æ•°æ–™ã®å‰²åˆï¼ˆ%ï¼‰<br>
                <strong>CFç”¨é€šé–¢æ‰‹æ•°æ–™:</strong> Cpass-FedExç”¨ã®é€šé–¢æ‰‹æ•°æ–™ï¼ˆå††ã€å°†æ¥ç”¨/ç›´å¥‘ç´„ã¯åˆ¥é€”ï¼‰<br>
                <strong>CEç”¨é€šé–¢æ‰‹æ•°æ–™:</strong> Cpass-Economyç”¨ã®é€šé–¢æ‰‹æ•°æ–™ï¼ˆå††ã€CEæ™‚ã®ã¿é©ç”¨ï¼‰<br>
                <strong>MPF($):</strong> Merchandise Processing Feeï¼ˆãƒ‰ãƒ«ã€Cpasså…é™¤ã§é€šå¸¸0ï¼‰<br>
                <strong>EUé€æ–™å·®é¡:</strong> ãƒ¨ãƒ¼ãƒ­ãƒƒãƒ‘å‘ã‘é€æ–™ã®å·®é¡ï¼ˆå††ã€é€šå¸¸ã¯0ï¼‰
            </div>

            <h3>æƒ³å®šé–¢ç¨ã®è¨ˆç®—å¼</h3>
            <div class="step">
                æƒ³å®šé–¢ç¨ã¯ä»¥ä¸‹ã®å¼ã§è¨ˆç®—ã•ã‚Œã¾ã™ï¼š<br>
                <code>æƒ³å®šé–¢ç¨ = è²©å£²ä¾¡æ ¼ Ã— é–¢ç¨ç‡ Ã— (1 + é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡) + è²©å£²ä¾¡æ ¼ Ã— VATç‡ Ã— é€šé–¢å‡¦ç†æ‰‹æ•°æ–™ç‡ + (é€šé–¢æ‰‹æ•°æ–™å†† Ã· ç‚ºæ›¿) + MPF($) + (EUé€æ–™å·®é¡å†† Ã· ç‚ºæ›¿)</code><br>
                <small style="color: #6c757d;">â€»é€šé–¢æ‰‹æ•°æ–™: CFã¯ç¾çŠ¶0ã€CEï¼ˆCpass-Economyï¼‰ã¯296å††ã€ç›´å¥‘ç´„ã¯åˆ¥é€”</small>
            </div>

            <h3>4ã¤ã®è¨ˆç®—ãƒ¢ãƒ¼ãƒ‰</h3>

            <div class="step">
                <strong>1. åˆ©ç›Šé¡ã§è¨ˆç®—ï¼ˆä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼ï¼‰</strong><br>
                ä»•å…¥ã‚Œä¾¡æ ¼ã¨å¸Œæœ›ã™ã‚‹åˆ©ç›Šé¡ï¼ˆå††ï¼‰ã‹ã‚‰ã€å¿…è¦ãªè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰ã‚’è¨ˆç®—ã—ã¾ã™ã€‚<br>
                ä½¿ç”¨ä¾‹: ä»•å…¥ã‚ŒãŒ5,000å††ã§3,000å††ã®åˆ©ç›ŠãŒæ¬²ã—ã„å ´åˆã®è²©å£²ä¾¡æ ¼ã¯ï¼Ÿ
            </div>

            <div class="step">
                <strong>2. åˆ©ç›Šç‡ã§è¨ˆç®—ï¼ˆä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼ï¼‰</strong><br>
                ä»•å…¥ã‚Œä¾¡æ ¼ã¨å¸Œæœ›ã™ã‚‹åˆ©ç›Šç‡ï¼ˆ%ï¼‰ã‹ã‚‰ã€å¿…è¦ãªè²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰ã‚’è¨ˆç®—ã—ã¾ã™ã€‚<br>
                ä½¿ç”¨ä¾‹: ä»•å…¥ã‚ŒãŒ5,000å††ã§20%ã®åˆ©ç›Šç‡ã‚’ç¢ºä¿ã—ãŸã„å ´åˆã®è²©å£²ä¾¡æ ¼ã¯ï¼Ÿ
            </div>

            <div class="step">
                <strong>3. åˆ©ç›Šé¡ã§è¨ˆç®—ï¼ˆè²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œï¼‰</strong><br>
                è²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰ã¨å¸Œæœ›ã™ã‚‹åˆ©ç›Šé¡ï¼ˆå††ï¼‰ã‹ã‚‰ã€é©åˆ‡ãªä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰ã‚’é€†ç®—ã—ã¾ã™ã€‚<br>
                DDUä¾¡æ ¼ï¼ˆé–¢ç¨æŠœãï¼‰ã¨DDPä¾¡æ ¼ï¼ˆé–¢ç¨è¾¼ã¿ï¼‰ã®ä¸¡æ–¹ã‹ã‚‰è¨ˆç®—ã§ãã¾ã™ã€‚<br>
                ä½¿ç”¨ä¾‹: 500ãƒ‰ãƒ«ã§è²©å£²ã—ã€3,000å††ã®åˆ©ç›Šã‚’å¾—ã‚‹ã«ã¯ã€ã„ãã‚‰ã¾ã§ä»•å…¥ã‚Œã‚‰ã‚Œã‚‹ï¼Ÿ
            </div>

            <div class="step">
                <strong>4. åˆ©ç›Šç‡ã§è¨ˆç®—ï¼ˆè²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œï¼‰</strong><br>
                è²©å£²ä¾¡æ ¼ï¼ˆãƒ‰ãƒ«ï¼‰ã¨å¸Œæœ›ã™ã‚‹åˆ©ç›Šç‡ï¼ˆ%ï¼‰ã‹ã‚‰ã€é©åˆ‡ãªä»•å…¥ã‚Œä¾¡æ ¼ï¼ˆå††ï¼‰ã‚’é€†ç®—ã—ã¾ã™ã€‚<br>
                DDUä¾¡æ ¼ï¼ˆé–¢ç¨æŠœãï¼‰ã¨DDPä¾¡æ ¼ï¼ˆé–¢ç¨è¾¼ã¿ï¼‰ã®ä¸¡æ–¹ã‹ã‚‰è¨ˆç®—ã§ãã¾ã™ã€‚<br>
                ä½¿ç”¨ä¾‹: 500ãƒ‰ãƒ«ã§è²©å£²ã—ã€20%ã®åˆ©ç›Šç‡ã‚’ç¢ºä¿ã™ã‚‹ã«ã¯ã€ã„ãã‚‰ã¾ã§ä»•å…¥ã‚Œã‚‰ã‚Œã‚‹ï¼Ÿ
            </div>

            <h3>DDU vs DDP ã«ã¤ã„ã¦</h3>
            <div class="step">
                <strong>DDUï¼ˆDelivered Duty Unpaidï¼‰:</strong> é–¢ç¨æŠœãã®ä¾¡æ ¼ã€‚è³¼å…¥è€…ãŒé–¢ç¨ã‚’è² æ‹…ã—ã¾ã™ã€‚<br>
                <strong>DDPï¼ˆDelivered Duty Paidï¼‰:</strong> é–¢ç¨è¾¼ã¿ã®ä¾¡æ ¼ã€‚è²©å£²è€…ãŒé–¢ç¨ã‚’è² æ‹…ã—ã€ä¾¡æ ¼ã«å«ã‚ã¾ã™ã€‚<br>
                <br>
                ä»•å…¥ã‚Œä¾¡æ ¼ç®—å‡ºã§ã¯ã€DDUä¾¡æ ¼ã¨DDPä¾¡æ ¼ã®ä¸¡æ–¹ã‚’åŒæ™‚ã«å…¥åŠ›ãƒ»è¨ˆç®—ã§ãã‚‹ã®ã§ã€ã©ã¡ã‚‰ã®è²©å£²æ–¹æ³•ã§ã‚‚å¯¾å¿œå¯èƒ½ã§ã™ã€‚
            </div>

            <h3>è¨ˆç®—å¼ã®è¦‹æ–¹</h3>
            <p>å„è¨ˆç®—çµæœã®ä¸‹éƒ¨ã«ã¯ã€é’ã„èƒŒæ™¯ã®è¨ˆç®—å¼ãŒè¡¨ç¤ºã•ã‚Œã¾ã™ã€‚ã“ã‚Œã¯å®Ÿéš›ã®æ•°å€¤ã§ã¯ãªãã€å¤‰æ•°åã§ç¤ºã•ã‚Œã¦ã„ã‚‹ãŸã‚ã€è¨ˆç®—ãƒ­ã‚¸ãƒƒã‚¯ã‚’ç†è§£ã™ã‚‹éš›ã«å‚è€ƒã«ã—ã¦ãã ã•ã„ã€‚</p>

            <h3>è¨­å®šã®ä¿å­˜</h3>
            <p>ã€Œè¨­å®šã‚’ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€å…±é€šè¨­å®šãŒãƒ–ãƒ©ã‚¦ã‚¶ã«ä¿å­˜ã•ã‚Œã€æ¬¡å›ã‚¢ã‚¯ã‚»ã‚¹æ™‚ã‚‚åŒã˜è¨­å®šãŒä½¿ç”¨ã•ã‚Œã¾ã™ã€‚</p>

            <button class="close-btn" onclick="closeTutorial()">é–‰ã˜ã‚‹</button>
        </div>
    </div>

    <script>
        // ECOãƒãƒªã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆDDUä¾¡æ ¼ä¸‹é™-ä¸Šé™ã€é–¢ç¨é¡ï¼‰
        const ecoPolicies = [
            { minDDU: 0, maxDDU: 7, tariff: 3 },
            { minDDU: 7, maxDDU: 13, tariff: 4 },
            { minDDU: 13, maxDDU: 20, tariff: 5 },
            { minDDU: 20, maxDDU: 26, tariff: 6 },
            { minDDU: 26, maxDDU: 33, tariff: 7 },
            { minDDU: 33, maxDDU: 40, tariff: 8 },
            { minDDU: 40, maxDDU: 46, tariff: 9 },
            { minDDU: 46, maxDDU: 52, tariff: 10 },
            { minDDU: 52, maxDDU: 59, tariff: 11 },
            { minDDU: 59, maxDDU: 65, tariff: 12 },
            { minDDU: 65, maxDDU: 72, tariff: 13 },
            { minDDU: 72, maxDDU: 78, tariff: 14 },
            { minDDU: 78, maxDDU: 85, tariff: 15 },
            { minDDU: 85, maxDDU: 91, tariff: 16 },
            { minDDU: 91, maxDDU: 97, tariff: 17 },
            { minDDU: 97, maxDDU: 104, tariff: 18 },
            { minDDU: 104, maxDDU: 110, tariff: 19 },
            { minDDU: 110, maxDDU: 117, tariff: 20 },
            { minDDU: 117, maxDDU: 130, tariff: 22 },
            { minDDU: 130, maxDDU: 143, tariff: 24 },
            { minDDU: 143, maxDDU: 150, tariff: 25 },
            { minDDU: 150, maxDDU: 156, tariff: 26 },
            { minDDU: 156, maxDDU: 169, tariff: 28 },
            { minDDU: 169, maxDDU: 181, tariff: 30 },
            { minDDU: 181, maxDDU: 194, tariff: 32 },
            { minDDU: 194, maxDDU: 207, tariff: 34 },
            { minDDU: 207, maxDDU: 214, tariff: 35 },
            { minDDU: 214, maxDDU: 227, tariff: 37 },
            { minDDU: 227, maxDDU: 246, tariff: 40 },
            { minDDU: 246, maxDDU: 259, tariff: 42 },
            { minDDU: 259, maxDDU: 278, tariff: 45 },
            { minDDU: 278, maxDDU: 291, tariff: 47 },
            { minDDU: 291, maxDDU: 311, tariff: 50 },
            { minDDU: 311, maxDDU: 324, tariff: 52 },
            { minDDU: 324, maxDDU: 343, tariff: 55 },
            { minDDU: 343, maxDDU: 356, tariff: 57 },
            { minDDU: 356, maxDDU: 375, tariff: 60 },
            { minDDU: 375, maxDDU: 407, tariff: 65 },
            { minDDU: 407, maxDDU: 440, tariff: 70 }
        ];

        // XPãƒãƒªã‚·ãƒ¼ãƒ‡ãƒ¼ã‚¿ï¼ˆDDUä¾¡æ ¼ä¸‹é™-ä¸Šé™ã€é–¢ç¨é¡ï¼‰
        const xpPolicies = [
            { minDDU: 0, maxDDU: 45, tariff: 7 },
            { minDDU: 45, maxDDU: 52, tariff: 8 },
            { minDDU: 52, maxDDU: 58, tariff: 9 },
            { minDDU: 58, maxDDU: 65, tariff: 10 },
            { minDDU: 65, maxDDU: 71, tariff: 11 },
            { minDDU: 71, maxDDU: 78, tariff: 12 },
            { minDDU: 78, maxDDU: 84, tariff: 13 },
            { minDDU: 84, maxDDU: 90, tariff: 14 },
            { minDDU: 90, maxDDU: 97, tariff: 15 },
            { minDDU: 97, maxDDU: 103, tariff: 16 },
            { minDDU: 103, maxDDU: 110, tariff: 17 },
            { minDDU: 110, maxDDU: 116, tariff: 18 },
            { minDDU: 116, maxDDU: 123, tariff: 19 },
            { minDDU: 123, maxDDU: 129, tariff: 20 },
            { minDDU: 129, maxDDU: 142, tariff: 22 },
            { minDDU: 142, maxDDU: 155, tariff: 24 },
            { minDDU: 155, maxDDU: 161, tariff: 25 },
            { minDDU: 161, maxDDU: 168, tariff: 26 },
            { minDDU: 168, maxDDU: 181, tariff: 28 },
            { minDDU: 181, maxDDU: 194, tariff: 30 },
            { minDDU: 194, maxDDU: 207, tariff: 32 },
            { minDDU: 207, maxDDU: 220, tariff: 34 },
            { minDDU: 220, maxDDU: 226, tariff: 35 },
            { minDDU: 226, maxDDU: 239, tariff: 37 },
            { minDDU: 239, maxDDU: 258, tariff: 40 },
            { minDDU: 258, maxDDU: 271, tariff: 42 },
            { minDDU: 271, maxDDU: 291, tariff: 45 },
            { minDDU: 291, maxDDU: 304, tariff: 47 },
            { minDDU: 304, maxDDU: 323, tariff: 50 },
            { minDDU: 323, maxDDU: 336, tariff: 52 },
            { minDDU: 336, maxDDU: 355, tariff: 55 },
            { minDDU: 355, maxDDU: 368, tariff: 57 },
            { minDDU: 368, maxDDU: 388, tariff: 60 },
            { minDDU: 388, maxDDU: 420, tariff: 65 },
            { minDDU: 420, maxDDU: 452, tariff: 70 },
            { minDDU: 452, maxDDU: 484, tariff: 75 },
            { minDDU: 484, maxDDU: 517, tariff: 80 },
            { minDDU: 517, maxDDU: 549, tariff: 85 },
            { minDDU: 549, maxDDU: 581, tariff: 90 },
            { minDDU: 581, maxDDU: 614, tariff: 95 },
            { minDDU: 614, maxDDU: 646, tariff: 100 },
            { minDDU: 646, maxDDU: 678, tariff: 105 },
            { minDDU: 678, maxDDU: 710, tariff: 110 },
            { minDDU: 710, maxDDU: 743, tariff: 115 },
            { minDDU: 743, maxDDU: 775, tariff: 120 },
            { minDDU: 775, maxDDU: 807, tariff: 125 },
            { minDDU: 807, maxDDU: 840, tariff: 130 },
            { minDDU: 840, maxDDU: 872, tariff: 135 },
            { minDDU: 872, maxDDU: 904, tariff: 140 },
            { minDDU: 904, maxDDU: 937, tariff: 145 },
            { minDDU: 937, maxDDU: 969, tariff: 150 },
            { minDDU: 969, maxDDU: 1001, tariff: 155 },
            { minDDU: 1001, maxDDU: 1033, tariff: 160 },
            { minDDU: 1033, maxDDU: 1066, tariff: 165 },
            { minDDU: 1066, maxDDU: 1098, tariff: 170 },
            { minDDU: 1098, maxDDU: 1130, tariff: 175 },
            { minDDU: 1130, maxDDU: 1163, tariff: 180 },
            { minDDU: 1163, maxDDU: 1195, tariff: 185 },
            { minDDU: 1195, maxDDU: 1227, tariff: 190 },
            { minDDU: 1227, maxDDU: 1259, tariff: 195 },
            { minDDU: 1259, maxDDU: 1292, tariff: 200 },
            { minDDU: 1292, maxDDU: 1324, tariff: 205 },
            { minDDU: 1324, maxDDU: 1356, tariff: 210 },
            { minDDU: 1356, maxDDU: 1389, tariff: 215 },
            { minDDU: 1389, maxDDU: 1421, tariff: 220 },
            { minDDU: 1421, maxDDU: 1453, tariff: 225 },
            { minDDU: 1453, maxDDU: 1486, tariff: 230 },
            { minDDU: 1486, maxDDU: 1518, tariff: 235 },
            { minDDU: 1518, maxDDU: 1550, tariff: 240 },
            { minDDU: 1550, maxDDU: 1582, tariff: 245 },
            { minDDU: 1582, maxDDU: 1615, tariff: 250 },
            { minDDU: 1615, maxDDU: 1647, tariff: 255 },
            { minDDU: 1647, maxDDU: 1679, tariff: 260 },
            { minDDU: 1679, maxDDU: 1712, tariff: 265 },
            { minDDU: 1712, maxDDU: 1744, tariff: 270 },
            { minDDU: 1744, maxDDU: 1776, tariff: 275 },
            { minDDU: 1776, maxDDU: 1808, tariff: 280 },
            { minDDU: 1808, maxDDU: 1841, tariff: 285 },
            { minDDU: 1841, maxDDU: 1873, tariff: 290 },
            { minDDU: 1873, maxDDU: 1905, tariff: 295 },
            { minDDU: 1905, maxDDU: 1938, tariff: 300 },
            { minDDU: 1938, maxDDU: 1970, tariff: 305 },
            { minDDU: 1970, maxDDU: 2002, tariff: 310 },
            { minDDU: 2002, maxDDU: 2034, tariff: 315 },
            { minDDU: 2034, maxDDU: 2067, tariff: 320 },
            { minDDU: 2067, maxDDU: 2099, tariff: 325 },
            { minDDU: 2099, maxDDU: 2131, tariff: 330 },
            { minDDU: 2131, maxDDU: 2164, tariff: 335 },
            { minDDU: 2164, maxDDU: 2196, tariff: 340 },
            { minDDU: 2196, maxDDU: 2228, tariff: 345 },
            { minDDU: 2228, maxDDU: 2261, tariff: 350 },
            { minDDU: 2261, maxDDU: 2293, tariff: 355 },
            { minDDU: 2293, maxDDU: 2325, tariff: 360 },
            { minDDU: 2325, maxDDU: 2357, tariff: 365 },
            { minDDU: 2357, maxDDU: 2390, tariff: 370 },
            { minDDU: 2390, maxDDU: 2422, tariff: 375 },
            { minDDU: 2422, maxDDU: 2454, tariff: 380 },
            { minDDU: 2454, maxDDU: 2487, tariff: 385 },
            { minDDU: 2487, maxDDU: 2519, tariff: 390 }
        ];

        // é–¢ç¨é¡ã‹ã‚‰ãƒãƒªã‚·ãƒ¼ã‚’æ¤œç´¢
        function findPolicyByTariff(policies, estimatedTariff) {
            for (let i = 0; i < policies.length; i++) {
                const policy = policies[i];
                const actualMin = (i === 0) ? 0 : policies[i - 1].tariff + 1;
                const actualMax = policy.tariff;
                if (estimatedTariff >= actualMin && estimatedTariff <= actualMax) {
                    return policy;
                }
            }
            return null;
        }

        // ãƒãƒªã‚·ãƒ¼åã‚’ç”Ÿæˆ
        function generatePolicyName(policy, shippingMethod, condition) {
            const minStr = String(policy.minDDU).padStart(4, '0');
            const maxStr = String(policy.maxDDU).padStart(4, '0');
            const tariffStr = String(policy.tariff).padStart(4, '0');
            return `Egl_2511-${minStr}-${maxStr}_${shippingMethod}_${condition}_${tariffStr}`;
        }

        // ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼ã‚’åˆ¤å®š
        function getShippingPolicy(sellingPriceUSD, adjustedTariffUSD, shippingMethod) {
            const roundedTariff = Math.round(adjustedTariffUSD);
            let policies, maxTariff, minTariff, methodCode;

            if (shippingMethod === 'CE') {
                policies = ecoPolicies;
                maxTariff = 70;
                minTariff = 3;
                methodCode = 'eco';
            } else if (shippingMethod === 'CX') {
                policies = xpPolicies;
                maxTariff = 390;
                minTariff = 7;
                methodCode = 'xp';
            } else {
                return { name: '-', badge: 'other', found: false };
            }

            const foundPolicy = findPolicyByTariff(policies, roundedTariff);

            if (foundPolicy) {
                return {
                    name: generatePolicyName(foundPolicy, methodCode, 'new'),
                    badge: methodCode,
                    found: true,
                    tariff: foundPolicy.tariff
                };
            } else if (roundedTariff > maxTariff) {
                return { name: `ç¯„å›²å¤–ï¼ˆ$${roundedTariff} > $${maxTariff}ï¼‰`, badge: 'over', found: false };
            } else if (roundedTariff < minTariff) {
                return { name: `ç¯„å›²å¤–ï¼ˆ$${roundedTariff} < $${minTariff}ï¼‰`, badge: 'over', found: false };
            } else {
                return { name: `è©²å½“ãªã—ï¼ˆ$${roundedTariff}ï¼‰`, badge: 'over', found: false };
            }
        }

        // é€æ–™ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿéš›ã®Shipping_Ratesã‚·ãƒ¼ãƒˆã‹ã‚‰å–å¾—ï¼‰
        const SHIPPING_RATE_TABLE = {
            EP: [ // eãƒ‘ã‚±ãƒƒãƒˆ
                { min: 1, max: 100, yen: 1200 }, { min: 101, max: 200, yen: 1410 }, { min: 201, max: 300, yen: 1620 },
                { min: 301, max: 400, yen: 1830 }, { min: 401, max: 500, yen: 2040 }, { min: 501, max: 600, yen: 2250 },
                { min: 601, max: 700, yen: 2460 }, { min: 701, max: 800, yen: 2670 }, { min: 801, max: 900, yen: 2880 },
                { min: 901, max: 1000, yen: 3090 }, { min: 1001, max: 1100, yen: 3300 }, { min: 1101, max: 1200, yen: 3510 },
                { min: 1201, max: 1300, yen: 3720 }, { min: 1301, max: 1400, yen: 3930 }, { min: 1401, max: 1500, yen: 4140 },
                { min: 1501, max: 1600, yen: 4350 }, { min: 1601, max: 1700, yen: 4560 }, { min: 1701, max: 1800, yen: 4770 },
                { min: 1801, max: 1900, yen: 4980 }, { min: 1901, max: 2000, yen: 5190 }
            ],
            CE: [ // Cpass-Economy
                { min: 1, max: 100, yen: 1227 }, { min: 101, max: 200, yen: 1367 }, { min: 201, max: 300, yen: 1581 },
                { min: 301, max: 400, yen: 1778 }, { min: 401, max: 500, yen: 2060 }, { min: 501, max: 600, yen: 2222 },
                { min: 601, max: 700, yen: 2321 }, { min: 701, max: 800, yen: 2703 }, { min: 801, max: 900, yen: 2820 },
                { min: 901, max: 1000, yen: 3020 }, { min: 1001, max: 1100, yen: 3136 }, { min: 1101, max: 1200, yen: 3250 },
                { min: 1201, max: 1250, yen: 3366 }, { min: 1251, max: 1300, yen: 3366 }, { min: 1301, max: 1400, yen: 3704 },
                { min: 1401, max: 1500, yen: 3816 }, { min: 1501, max: 1600, yen: 3935 }, { min: 1601, max: 1700, yen: 4046 },
                { min: 1701, max: 1750, yen: 4165 }, { min: 1751, max: 1800, yen: 4165 }, { min: 1801, max: 1900, yen: 5056 },
                { min: 1901, max: 2000, yen: 5245 }, { min: 2001, max: 2500, yen: 5582 }, { min: 2501, max: 3000, yen: 6333 },
                { min: 3001, max: 3500, yen: 6958 }, { min: 3501, max: 4000, yen: 7704 }, { min: 4001, max: 4500, yen: 9135 },
                { min: 4501, max: 5000, yen: 11733 }, { min: 5001, max: 5500, yen: 12500 }, { min: 5501, max: 6000, yen: 13335 },
                { min: 6001, max: 6500, yen: 14160 }, { min: 6501, max: 7000, yen: 15209 }, { min: 7001, max: 7500, yen: 16058 },
                { min: 7501, max: 8000, yen: 16893 }, { min: 8001, max: 8500, yen: 17562 }, { min: 8501, max: 9000, yen: 18152 },
                { min: 9001, max: 9500, yen: 19106 }, { min: 9501, max: 10000, yen: 19639 }, { min: 10001, max: 10500, yen: 20276 },
                { min: 10501, max: 11000, yen: 20864 }, { min: 11001, max: 11500, yen: 21565 }, { min: 11501, max: 12000, yen: 22199 },
                { min: 12001, max: 12500, yen: 22887 }, { min: 12501, max: 13000, yen: 23466 }, { min: 13001, max: 13500, yen: 24054 },
                { min: 13501, max: 14000, yen: 24869 }, { min: 14001, max: 14500, yen: 25200 }, { min: 14501, max: 15000, yen: 25988 },
                { min: 15001, max: 15500, yen: 26656 }, { min: 15501, max: 16000, yen: 28149 }, { min: 16001, max: 16500, yen: 28775 },
                { min: 16501, max: 17000, yen: 29495 }, { min: 17001, max: 17500, yen: 30196 }, { min: 17501, max: 18000, yen: 30902 },
                { min: 18001, max: 18500, yen: 31478 }, { min: 18501, max: 19000, yen: 32204 }, { min: 19001, max: 19500, yen: 32936 },
                { min: 19501, max: 20000, yen: 33947 }, { min: 20001, max: 20500, yen: 34655 }, { min: 20501, max: 21000, yen: 35426 },
                { min: 21001, max: 21500, yen: 36145 }, { min: 21501, max: 22000, yen: 36859 }, { min: 22001, max: 22500, yen: 37602 },
                { min: 22501, max: 23000, yen: 38516 }, { min: 23001, max: 23500, yen: 39084 }, { min: 23501, max: 24000, yen: 39678 },
                { min: 24001, max: 24500, yen: 40374 }, { min: 24501, max: 25000, yen: 40955 }, { min: 25001, max: 26000, yen: null },
                { min: 26001, max: 27000, yen: null }, { min: 27001, max: 28000, yen: null }, { min: 28001, max: 29000, yen: null },
                { min: 29001, max: 30000, yen: null }
            ],
            EMS: [ // EMS
                { min: 1, max: 100, yen: 3900 }, { min: 101, max: 500, yen: 3900 }, { min: 501, max: 600, yen: 4180 },
                { min: 601, max: 700, yen: 4460 }, { min: 701, max: 800, yen: 4740 }, { min: 801, max: 900, yen: 5020 },
                { min: 901, max: 1000, yen: 5300 }, { min: 1001, max: 1250, yen: 5990 }, { min: 1251, max: 1300, yen: 6600 },
                { min: 1301, max: 1500, yen: 6600 }, { min: 1501, max: 1750, yen: 7290 }, { min: 1751, max: 1800, yen: 7900 },
                { min: 1801, max: 2000, yen: 7900 }, { min: 2001, max: 2500, yen: 9100 }, { min: 2501, max: 3000, yen: 10300 },
                { min: 3001, max: 3500, yen: 11500 }, { min: 3501, max: 4000, yen: 12700 }, { min: 4001, max: 4500, yen: 13900 },
                { min: 4501, max: 5000, yen: 15100 }, { min: 5001, max: 5500, yen: 16300 }, { min: 5501, max: 6500, yen: 17500 },
                { min: 6501, max: 7500, yen: 19900 }, { min: 7501, max: 8500, yen: 22300 }, { min: 8501, max: 9500, yen: 24700 },
                { min: 9501, max: 10500, yen: 27100 }, { min: 10501, max: 11500, yen: 29500 }, { min: 11501, max: 12500, yen: 31900 },
                { min: 12501, max: 13500, yen: 34300 }, { min: 13501, max: 14500, yen: 36700 }, { min: 14501, max: 15500, yen: 39100 },
                { min: 15501, max: 16500, yen: 41500 }, { min: 16501, max: 17500, yen: 43900 }, { min: 17501, max: 18500, yen: 46300 },
                { min: 18501, max: 19500, yen: 48700 }, { min: 19501, max: 20500, yen: 51100 }, { min: 20501, max: 21500, yen: 53500 },
                { min: 21501, max: 22500, yen: 55900 }, { min: 22501, max: 23500, yen: 58300 }, { min: 23501, max: 24500, yen: 60700 },
                { min: 24501, max: 25000, yen: 63100 }, { min: 25001, max: 26000, yen: 65500 }, { min: 26001, max: 27000, yen: 67900 },
                { min: 27001, max: 28000, yen: 70300 }, { min: 28001, max: 29000, yen: 72700 }, { min: 29001, max: 30000, yen: 75100 }
            ],
            CF: [ // Cpass-FedEx 2026å¹´ FICP USWåˆ—
                { min: 1, max: 500, yen: 2115 }, { min: 501, max: 1000, yen: 2599 }, { min: 1001, max: 1500, yen: 2840 },
                { min: 1501, max: 2000, yen: 3108 }, { min: 2001, max: 2500, yen: 3383 }, { min: 2501, max: 3000, yen: 3540 },
                { min: 3001, max: 3500, yen: 3593 }, { min: 3501, max: 4000, yen: 4022 }, { min: 4001, max: 4500, yen: 4451 },
                { min: 4501, max: 5000, yen: 4718 }, { min: 5001, max: 5500, yen: 5043 }, { min: 5501, max: 6000, yen: 5366 },
                { min: 6001, max: 6500, yen: 5735 }, { min: 6501, max: 7000, yen: 6184 }, { min: 7001, max: 7500, yen: 6683 },
                { min: 7501, max: 8000, yen: 6871 }, { min: 8001, max: 8500, yen: 7060 }, { min: 8501, max: 9000, yen: 7249 },
                { min: 9001, max: 9500, yen: 8865 }, { min: 9501, max: 10000, yen: 9089 }, { min: 10001, max: 10500, yen: 9346 },
                { min: 10501, max: 11000, yen: 9602 }, { min: 11001, max: 11500, yen: 9861 }, { min: 11501, max: 12000, yen: 10116 },
                { min: 12001, max: 12500, yen: 11439 }, { min: 12501, max: 13000, yen: 11723 }, { min: 13001, max: 13500, yen: 12006 },
                { min: 13501, max: 14000, yen: 12289 }, { min: 14001, max: 14500, yen: 12573 }, { min: 14501, max: 15000, yen: 12857 },
                { min: 15001, max: 15500, yen: 13140 }, { min: 15501, max: 16000, yen: 14631 }, { min: 16001, max: 16500, yen: 14940 },
                { min: 16501, max: 17000, yen: 15249 }, { min: 17001, max: 17500, yen: 15559 }, { min: 17501, max: 18000, yen: 15867 },
                { min: 18001, max: 18500, yen: 16177 }, { min: 18501, max: 19000, yen: 16485 }, { min: 19001, max: 19500, yen: 16794 },
                { min: 19501, max: 20000, yen: 17104 }, { min: 20001, max: 21000, yen: 20625 }, { min: 21001, max: 22000, yen: 21657 },
                { min: 22001, max: 23000, yen: 22689 }, { min: 23001, max: 24000, yen: 23721 }, { min: 24001, max: 25000, yen: 24754 },
                { min: 25001, max: 26000, yen: 25787 }, { min: 26001, max: 27000, yen: 26819 }, { min: 27001, max: 28000, yen: 27852 },
                { min: 28001, max: 29000, yen: 28885 }, { min: 29001, max: 30000, yen: 29916 }, { min: 30001, max: 31000, yen: 30950 },
                { min: 31001, max: 32000, yen: 31983 }, { min: 32001, max: 33000, yen: 34201 }, { min: 33001, max: 34000, yen: 35237 },
                { min: 34001, max: 35000, yen: 36274 }, { min: 35001, max: 36000, yen: 37310 }, { min: 36001, max: 37000, yen: 38346 },
                { min: 37001, max: 38000, yen: 39383 }, { min: 38001, max: 39000, yen: 40419 }, { min: 39001, max: 40000, yen: 41455 },
                { min: 40001, max: 41000, yen: 42492 }, { min: 41001, max: 42000, yen: 43528 }, { min: 42001, max: 43000, yen: 44565 },
                { min: 43001, max: 44000, yen: 45601 }, { min: 44001, max: 45000, yen: 45624 }, { min: 45001, max: 46000, yen: 45624 },
                { min: 46001, max: 47000, yen: 45624 }, { min: 47001, max: 48000, yen: 45792 }, { min: 48001, max: 49000, yen: 46746 },
                { min: 49001, max: 50000, yen: 47700 }, { min: 50001, max: 51000, yen: 48654 }, { min: 51001, max: 52000, yen: 49608 },
                { min: 52001, max: 53000, yen: 50562 }, { min: 53001, max: 54000, yen: 51516 }, { min: 54001, max: 55000, yen: 52470 },
                { min: 55001, max: 56000, yen: 53424 }, { min: 56001, max: 57000, yen: 54378 }, { min: 57001, max: 58000, yen: 55332 },
                { min: 58001, max: 59000, yen: 56286 }, { min: 59001, max: 60000, yen: 57240 }, { min: 60001, max: 61000, yen: 58194 },
                { min: 61001, max: 62000, yen: 59148 }, { min: 62001, max: 63000, yen: 60102 }, { min: 63001, max: 64000, yen: 61056 },
                { min: 64001, max: 65000, yen: 62010 }, { min: 65001, max: 66000, yen: 62964 }, { min: 66001, max: 67000, yen: 63918 },
                { min: 67001, max: 68000, yen: 64872 }
            ],
            CD: [ // Cpass-DHL 2026å¹´ Zone10(US)åˆ—
                { min: 1, max: 500, yen: 2454 }, { min: 501, max: 1000, yen: 2780 }, { min: 1001, max: 1500, yen: 2898 },
                { min: 1501, max: 2000, yen: 3045 }, { min: 2001, max: 2500, yen: 3404 }, { min: 2501, max: 3000, yen: 3761 },
                { min: 3001, max: 3500, yen: 4203 }, { min: 3501, max: 4000, yen: 4568 }, { min: 4001, max: 4500, yen: 4934 },
                { min: 4501, max: 5000, yen: 5300 }, { min: 5001, max: 5500, yen: 5665 }, { min: 5501, max: 6000, yen: 6029 },
                { min: 6001, max: 6500, yen: 6444 }, { min: 6501, max: 7000, yen: 6948 }, { min: 7001, max: 7500, yen: 7450 },
                { min: 7501, max: 8000, yen: 7954 }, { min: 8001, max: 8500, yen: 8456 }, { min: 8501, max: 9000, yen: 8958 },
                { min: 9001, max: 9500, yen: 9463 }, { min: 9501, max: 10000, yen: 9966 }, { min: 10001, max: 10500, yen: 10469 },
                { min: 10501, max: 11000, yen: 10972 }, { min: 11001, max: 11500, yen: 11475 }, { min: 11501, max: 12000, yen: 11978 },
                { min: 12001, max: 12500, yen: 12481 }, { min: 12501, max: 13000, yen: 12986 }, { min: 13001, max: 13500, yen: 13487 },
                { min: 13501, max: 14000, yen: 13991 }, { min: 14001, max: 14500, yen: 14494 }, { min: 14501, max: 15000, yen: 14998 },
                { min: 15001, max: 15500, yen: 15500 }, { min: 15501, max: 16000, yen: 16004 }, { min: 16001, max: 16500, yen: 16508 },
                { min: 16501, max: 17000, yen: 17011 }, { min: 17001, max: 17500, yen: 17515 }, { min: 17501, max: 18000, yen: 18018 },
                { min: 18001, max: 18500, yen: 18521 }, { min: 18501, max: 19000, yen: 19024 }, { min: 19001, max: 19500, yen: 19528 },
                { min: 19501, max: 20000, yen: 20031 }, { min: 20001, max: 21000, yen: 21039 }, { min: 21001, max: 22000, yen: 22045 },
                { min: 22001, max: 23000, yen: 23052 }, { min: 23001, max: 24000, yen: 24059 }, { min: 24001, max: 25000, yen: 25065 },
                { min: 25001, max: 26000, yen: 26073 }, { min: 26001, max: 27000, yen: 27078 }, { min: 27001, max: 28000, yen: 28085 },
                { min: 28001, max: 29000, yen: 29082 }, { min: 29001, max: 30000, yen: 30089 }, { min: 30001, max: 31000, yen: 31093 },
                { min: 31001, max: 32000, yen: 32096 }, { min: 32001, max: 33000, yen: 33099 }, { min: 33001, max: 34000, yen: 34102 },
                { min: 34001, max: 35000, yen: 35104 }, { min: 35001, max: 36000, yen: 36108 }, { min: 36001, max: 37000, yen: 37111 },
                { min: 37001, max: 38000, yen: 38114 }, { min: 38001, max: 39000, yen: 39117 }, { min: 39001, max: 40000, yen: 40120 },
                { min: 40001, max: 41000, yen: 41123 }, { min: 41001, max: 42000, yen: 42127 }, { min: 42001, max: 43000, yen: 43129 },
                { min: 43001, max: 44000, yen: 44133 }, { min: 44001, max: 45000, yen: 45135 }, { min: 45001, max: 46000, yen: 46139 },
                { min: 46001, max: 47000, yen: 47142 }, { min: 47001, max: 48000, yen: 48145 }, { min: 48001, max: 49000, yen: 49148 },
                { min: 49001, max: 50000, yen: 50151 }, { min: 50001, max: 51000, yen: 51154 }, { min: 51001, max: 52000, yen: 52158 },
                { min: 52001, max: 53000, yen: 53160 }, { min: 53001, max: 54000, yen: 54163 }, { min: 54001, max: 55000, yen: 55166 },
                { min: 55001, max: 56000, yen: 56169 }, { min: 56001, max: 57000, yen: 57173 }, { min: 57001, max: 58000, yen: 58175 },
                { min: 58001, max: 59000, yen: 59179 }, { min: 59001, max: 60000, yen: 60181 }, { min: 60001, max: 61000, yen: 61185 },
                { min: 61001, max: 62000, yen: 62188 }, { min: 62001, max: 63000, yen: 63191 }, { min: 63001, max: 64000, yen: 64194 },
                { min: 64001, max: 65000, yen: 65197 }, { min: 65001, max: 66000, yen: 66200 }, { min: 66001, max: 67000, yen: 67204 },
                { min: 67001, max: 68000, yen: 68206 }
            ],
            EL: [ // eLogistics
                { min: 1, max: 1000, yen: 3700 }, { min: 1001, max: 1500, yen: 3900 }, { min: 1501, max: 2000, yen: 4100 },
                { min: 2001, max: 2500, yen: 4300 }, { min: 2501, max: 3000, yen: 5600 }, { min: 3001, max: 3500, yen: 5900 },
                { min: 3501, max: 4000, yen: 6300 }, { min: 4001, max: 4500, yen: 6600 }, { min: 4501, max: 5000, yen: 7200 },
                { min: 5001, max: 5500, yen: 7900 }, { min: 5501, max: 6000, yen: 8700 }, { min: 6001, max: 6500, yen: 10300 },
                { min: 6501, max: 7000, yen: 12200 }, { min: 7001, max: 7500, yen: 14100 }, { min: 7501, max: 8000, yen: 16000 },
                { min: 8001, max: 8500, yen: 17900 }, { min: 8501, max: 9000, yen: 19800 }, { min: 9001, max: 9500, yen: 21800 },
                { min: 9501, max: 10000, yen: 23700 }, { min: 10001, max: 10500, yen: 25600 }, { min: 10501, max: 11000, yen: 25800 },
                { min: 11001, max: 11500, yen: 26100 }, { min: 11501, max: 12000, yen: 26600 }, { min: 12001, max: 12500, yen: 27100 },
                { min: 12501, max: 13000, yen: 27500 }, { min: 13001, max: 13500, yen: 28000 }, { min: 13501, max: 14000, yen: 28500 },
                { min: 14001, max: 14500, yen: 28900 }, { min: 14501, max: 15000, yen: 29400 }, { min: 15001, max: 15500, yen: 29900 },
                { min: 15501, max: 16000, yen: 30400 }, { min: 16001, max: 16500, yen: 30800 }, { min: 16501, max: 17000, yen: 31300 },
                { min: 17001, max: 17500, yen: 31800 }, { min: 17501, max: 18000, yen: 32300 }, { min: 18001, max: 18500, yen: 32700 },
                { min: 18501, max: 19000, yen: 33200 }, { min: 19001, max: 19500, yen: 33700 }, { min: 19501, max: 20000, yen: 34200 },
                { min: 20001, max: 20500, yen: 34600 }, { min: 20501, max: 21000, yen: 35300 }, { min: 21001, max: 21500, yen: 35900 },
                { min: 21501, max: 22000, yen: 36500 }, { min: 22001, max: 22500, yen: 37100 }, { min: 22501, max: 23000, yen: 37800 },
                { min: 23001, max: 23500, yen: 38400 }, { min: 23501, max: 24000, yen: 39000 }, { min: 24001, max: 24500, yen: 39700 },
                { min: 24501, max: 25000, yen: 40300 }, { min: 25001, max: 26000, yen: 40900 }, { min: 26001, max: 27000, yen: 42200 },
                { min: 27001, max: 28000, yen: 43400 }, { min: 28001, max: 29000, yen: 44700 }, { min: 29001, max: 30000, yen: 45900 },
                { min: 30001, max: Infinity, yen: 47200 }
            ]
        };

        // UIã‹ã‚‰ç‡ƒæ²¹ã‚µãƒ¼ãƒãƒ£ãƒ¼ã‚¸ãƒ»å‰²å¼•è¨­å®šã‚’å–å¾—
        function getShippingConfig() {
            const getVal = (id, defaultVal) => {
                const val = parseFloat(document.getElementById(id).value);
                return isNaN(val) ? defaultVal : val;
            };
            return {
                fedexFuel: getVal('fedexFuelRate', 29.75) / 100,
                dhlFuel: getVal('dhlFuelRate', 30) / 100,
                cpassDiscount: getVal('cpassDiscountRate', 3) / 100,
                fedexExtraPer500g: getVal('fedexExtraPer500g', 115),
                dhlExtraPer500g: getVal('dhlExtraPer500g', 96)
            };
        }

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        function toggleShippingMode() {
            const mode = document.getElementById('shippingMode').value;
            const fixedSettings = document.getElementById('fixedShippingSettings');
            const tableSettings = document.getElementById('tableShippingSettings');

            if (mode === 'fixed') {
                fixedSettings.classList.remove('hidden');
                tableSettings.classList.add('hidden');
            } else {
                fixedSettings.classList.add('hidden');
                tableSettings.classList.remove('hidden');
                calculateVolumetricWeight();
            }
        }

        // å®¹ç©é‡é‡ã‚’è‡ªå‹•è¨ˆç®—ï¼ˆ2ç¨®é¡ï¼‰
        function calculateVolumetricWeight() {
            const length = parseFloat(document.getElementById('packageLength').value) || 0;
            const width = parseFloat(document.getElementById('packageWidth').value) || 0;
            const height = parseFloat(document.getElementById('packageHeight').value) || 0;

            const volume = length * width * height;

            // CF/CD/EL/EMSç”¨ï¼ˆÃ·5ï¼‰
            const volWeight5 = Math.max(Math.round(volume / 5), 100);
            // CEç”¨ï¼ˆÃ·8ï¼‰
            const volWeight8 = Math.max(Math.round(volume / 8), 100);

            document.getElementById('volumetricWeight').value = volWeight5;
            document.getElementById('volumetricWeightCE').value = volWeight8;

            // é€æ–™è©¦ç®—ã‚‚æ›´æ–°
            calculateEstimatedShipping();
        }

        // é€æ–™è©¦ç®—ã‚’è¨ˆç®—ãƒ»è¡¨ç¤ºï¼ˆå…¨é…é€æ–¹æ³•ï¼‰
        function calculateEstimatedShipping() {
            const actualWeight = parseFloat(document.getElementById('actualWeight').value) || 0;
            const volWeight5 = parseFloat(document.getElementById('volumetricWeight').value) || 0;
            const volWeight8 = parseFloat(document.getElementById('volumetricWeightCE').value) || 0;
            const selectedMethod = document.getElementById('shippingMethod').value;

            // å…¨é…é€æ–¹æ³•ã®ãƒªã‚¹ãƒˆ
            const allMethods = [
                { code: 'EP', name: 'eãƒ‘ã‚±ãƒƒãƒˆ', volWeight: 0 }, // å®Ÿé‡é‡ã®ã¿
                { code: 'CE', name: 'Cpass-Economy', volWeight: volWeight8 },
                { code: 'CF', name: 'Cpass-FedEx', volWeight: volWeight5 },
                { code: 'CD', name: 'Cpass-DHL', volWeight: volWeight5 },
                { code: 'EL', name: 'eLogistics', volWeight: volWeight5 },
                { code: 'EMS', name: 'EMS', volWeight: 0 } // å®Ÿé‡é‡ã®ã¿
            ];

            // è‡ªå‹•é¸æŠã®å ´åˆã€å®Ÿéš›ã«ä½¿ã‚ã‚Œã‚‹é…é€æ–¹æ³•ã‚’åˆ¤å®š
            let autoSelectedCode = null;
            if (selectedMethod === 'è‡ªå‹•é¸æŠ') {
                const settings = getSettings();
                const lowMethod = settings.lowPriceMethod || 'EP';
                const highMethod = settings.highPriceMethod || 'CF';
                // åŸºæœ¬ã¯ä½ä¾¡æ ¼é…é€æ–¹æ³•ã€eãƒ‘ã‚±ãƒƒãƒˆã§2000gè¶…éã¯é«˜ä¾¡æ ¼é…é€æ–¹æ³•
                autoSelectedCode = (lowMethod === 'EP' && actualWeight > 2000) ? highMethod : lowMethod;
            }

            // å„é…é€æ–¹æ³•ã®é€æ–™ã‚’è¨ˆç®—
            let tableHtml = '';
            allMethods.forEach(m => {
                // èª²é‡‘é‡é‡ã®è¨ˆç®—
                let chargeableWeight;
                if (m.code === 'EP' || m.code === 'EMS') {
                    chargeableWeight = actualWeight; // eãƒ‘ã‚±ãƒƒãƒˆãƒ»EMSã¯å®Ÿé‡é‡ã®ã¿
                } else {
                    chargeableWeight = Math.max(actualWeight, m.volWeight);
                }

                // é€æ–™è¨ˆç®—
                const cost = calculateSpecificMethodRate(m.code, actualWeight, chargeableWeight);
                const isUnavailable = (cost === null || cost === undefined || cost === 999999);

                // é¸æŠä¸­ã‹ã©ã†ã‹åˆ¤å®š
                let isSelected = false;
                if (selectedMethod === 'è‡ªå‹•é¸æŠ') {
                    isSelected = (m.code === autoSelectedCode);
                } else {
                    isSelected = (m.code === selectedMethod);
                }

                // è¡Œã‚¯ãƒ©ã‚¹
                let rowClass = '';
                if (isSelected) rowClass = 'selected';
                else if (isUnavailable) rowClass = 'unavailable';

                // é€æ–™è¡¨ç¤º
                let costDisplay = isUnavailable ? 'å¯¾å¿œä¸å¯' : `Â¥${cost.toLocaleString()}`;

                tableHtml += `<tr class="${rowClass}">
                    <td>${m.name}</td>
                    <td class="weight-cell">${chargeableWeight.toLocaleString()} g</td>
                    <td class="cost-cell">${costDisplay}</td>
                </tr>`;
            });

            document.getElementById('shippingEstimateBody').innerHTML = tableHtml;
            document.getElementById('autoSelectNote').style.display = (selectedMethod === 'è‡ªå‹•é¸æŠ') ? 'block' : 'none';
        }

        // é…é€æ–¹æ³•ã‚³ãƒ¼ãƒ‰ã‚’æ—¥æœ¬èªåã«å¤‰æ›
        function getMethodName(code) {
            const methodNames = {
                'EP': 'eãƒ‘ã‚±ãƒƒãƒˆ',
                'CF': 'Cpass-FedEx',
                'CD': 'Cpass-DHL',
                'EL': 'eLogistics',
                'CE': 'Cpass-Economy',
                'EMS': 'EMS'
            };
            return methodNames[code] || code;
        }

        // eãƒ‘ã‚±ãƒƒãƒˆ æ–™é‡‘å–å¾—
        function getEpacketRate(weight) {
            // 2000gã‚’è¶…ãˆã‚‹å ´åˆã¯nullã‚’è¿”ã™
            if (weight > 2000) {
                return null;
            }
            for (let i = 0; i < SHIPPING_RATE_TABLE.EP.length; i++) {
                if (weight >= SHIPPING_RATE_TABLE.EP[i].min && weight <= SHIPPING_RATE_TABLE.EP[i].max) {
                    return SHIPPING_RATE_TABLE.EP[i].yen;
                }
            }
            return null;
        }

        // Cpass-FedEx æ–™é‡‘è¨ˆç®—
        function getCpassFedexRate(weight) {
            const config = getShippingConfig();
            const rounded = Math.ceil(weight / 500) * 500;
            let base = null;

            for (let i = 0; i < SHIPPING_RATE_TABLE.CF.length; i++) {
                if (weight >= SHIPPING_RATE_TABLE.CF[i].min && weight <= SHIPPING_RATE_TABLE.CF[i].max) {
                    base = SHIPPING_RATE_TABLE.CF[i].yen;
                    break;
                }
            }

            if (!base) return 999999;

            const overUnits = Math.max(0, (rounded - 500) / 500);
            const extra = overUnits * config.fedexExtraPer500g;
            const subTotal = base + extra;
            const fuel = subTotal * config.fedexFuel;
            const discount = -(subTotal + fuel) * config.cpassDiscount;
            return Math.round(subTotal + fuel + discount);
        }

        // Cpass-DHL æ–™é‡‘è¨ˆç®—
        function getCpassDHLRate(weight) {
            const config = getShippingConfig();
            const rounded = Math.ceil(weight / 500) * 500;
            let base = null;

            for (let i = 0; i < SHIPPING_RATE_TABLE.CD.length; i++) {
                if (weight >= SHIPPING_RATE_TABLE.CD[i].min && weight <= SHIPPING_RATE_TABLE.CD[i].max) {
                    base = SHIPPING_RATE_TABLE.CD[i].yen;
                    break;
                }
            }

            if (!base) return 999999;

            const overUnits = Math.max(0, (rounded - 500) / 500);
            const extra = overUnits * config.dhlExtraPer500g;
            const subTotal = base + extra;
            const fuel = subTotal * config.dhlFuel;
            const discount = -(subTotal + fuel) * config.cpassDiscount;
            return Math.round(subTotal + fuel + discount);
        }

        // eLogistics æ–™é‡‘è¨ˆç®—
        function getElogiRate(weight) {
            for (let i = 0; i < SHIPPING_RATE_TABLE.EL.length; i++) {
                if (weight >= SHIPPING_RATE_TABLE.EL[i].min && weight <= SHIPPING_RATE_TABLE.EL[i].max) {
                    return SHIPPING_RATE_TABLE.EL[i].yen;
                }
            }
            return 999999;
        }

        // Cpass-Economy æ–™é‡‘å–å¾—
        function getCpassEconomyRate(weight) {
            for (let i = 0; i < SHIPPING_RATE_TABLE.CE.length; i++) {
                if (weight >= SHIPPING_RATE_TABLE.CE[i].min && weight <= SHIPPING_RATE_TABLE.CE[i].max) {
                    const rate = SHIPPING_RATE_TABLE.CE[i].yen;
                    return rate !== null ? rate : 999999;
                }
            }
            return 999999;
        }

        // EMS æ–™é‡‘å–å¾—
        function getEMSRate(weight) {
            for (let i = 0; i < SHIPPING_RATE_TABLE.EMS.length; i++) {
                if (weight >= SHIPPING_RATE_TABLE.EMS[i].min && weight <= SHIPPING_RATE_TABLE.EMS[i].max) {
                    return SHIPPING_RATE_TABLE.EMS[i].yen;
                }
            }
            return 999999;
        }

        // é€æ–™è¨ˆç®—ãƒ¡ã‚¤ãƒ³é–¢æ•°
        function calculateShippingCost(costYen, actualWeight, volWeight, method, threshold, lowMethod, highMethod, volume, shippingMode) {
            // å›ºå®šãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
            if (shippingMode === 'fixed') {
                return parseFloat(document.getElementById('shippingCost').value) || 3000;
            }

            // ãƒ†ãƒ¼ãƒ–ãƒ«ãƒ¢ãƒ¼ãƒ‰
            if (method && method !== 'è‡ªå‹•é¸æŠ') {
                // é…é€æ–¹æ³•ã«å¿œã˜ã¦å®¹ç©é‡é‡ã‚’å†è¨ˆç®—
                const recalcVolWeight = calculateVolWeightByMethod(method, volume);
                const chargeableWeight = Math.max(actualWeight || 0, recalcVolWeight || 0);
                return calculateSpecificMethodRate(method, actualWeight, chargeableWeight);
            }

            // è‡ªå‹•é¸æŠï¼šå®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã‚‹é…é€æ–¹æ³•ã‚’åˆ¤å®š
            let actualMethod;
            if (lowMethod === 'NONE' || costYen >= threshold) {
                actualMethod = highMethod;
            } else {
                // ä½ä¾¡æ ¼é…é€æ–¹æ³•ã‚’ä½¿ç”¨
                actualMethod = lowMethod;
                // ãŸã ã—ã€eãƒ‘ã‚±ãƒƒãƒˆã§é‡é‡ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆã¯é«˜ä¾¡æ ¼é…é€æ–¹æ³•
                if (lowMethod === 'EP' && actualWeight > 2000) {
                    actualMethod = highMethod;
                }
            }

            // åˆ¤å®šã•ã‚ŒãŸé…é€æ–¹æ³•ã«å¿œã˜ã¦å®¹ç©é‡é‡ã‚’å†è¨ˆç®—
            const recalcVolWeight = calculateVolWeightByMethod(actualMethod, volume);
            const chargeableWeight = Math.max(actualWeight || 0, recalcVolWeight || 0);

            if (actualMethod === 'EP') {
                return getEpacketRate(actualWeight);
            } else {
                return calculateSpecificMethodRate(actualMethod, actualWeight, chargeableWeight);
            }
        }

        // é…é€æ–¹æ³•ã®è¡¨ç¤ºåã‚’å–å¾—
        function getShippingMethodDisplayName(method) {
            const names = {
                'EP': 'eãƒ‘ã‚±ãƒƒãƒˆ',
                'CE': 'Cpass-Economy',
                'CF': 'Cpass-FedEx',
                'CD': 'Cpass-DHL',
                'EL': 'eLogi',
                'EMS': 'EMS',
                'è‡ªå‹•é¸æŠ': 'è‡ªå‹•é¸æŠ'
            };
            return names[method] || method;
        }

        // å®Ÿéš›ã«ä½¿ç”¨ã•ã‚Œã‚‹é…é€æ–¹æ³•ã‚’åˆ¤å®šï¼ˆé€šé–¢æ‰‹æ•°æ–™åˆ¤å®šç”¨ï¼‰
        function getEffectiveShippingMethod(costYen, actualWeight, method, threshold, lowMethod, highMethod) {
            // é…é€æ–¹æ³•ãŒæ˜ç¤ºçš„ã«æŒ‡å®šã•ã‚Œã¦ã„ã‚‹å ´åˆ
            if (method && method !== 'è‡ªå‹•é¸æŠ') {
                return method;
            }

            // è‡ªå‹•é¸æŠã®å ´åˆ
            if (lowMethod === 'NONE' || costYen >= threshold) {
                return highMethod;
            } else {
                // ä½ä¾¡æ ¼é…é€æ–¹æ³•ã‚’ä½¿ç”¨
                let actualMethod = lowMethod;
                // ãŸã ã—ã€eãƒ‘ã‚±ãƒƒãƒˆã§é‡é‡ã‚ªãƒ¼ãƒãƒ¼ã®å ´åˆã¯é«˜ä¾¡æ ¼é…é€æ–¹æ³•
                if (lowMethod === 'EP' && actualWeight > 2000) {
                    actualMethod = highMethod;
                }
                return actualMethod;
            }
        }

        // é…é€æ–¹æ³•ã«å¿œã˜ãŸå®¹ç©é‡é‡è¨ˆç®—
        function calculateVolWeightByMethod(method, volume) {
            if (!volume) return 0;

            let volumetricWeight;
            if (method === 'CE') {
                volumetricWeight = Math.round(volume / 8);
            } else {
                volumetricWeight = Math.round(volume / 5);
            }
            return Math.max(volumetricWeight, 100);
        }

        // é…é€æ–¹æ³•åˆ¥ã®æ–™é‡‘è¨ˆç®—
        function calculateSpecificMethodRate(method, actualWeight, chargeableWeight) {
            switch(method) {
                case 'EP':
                    // eãƒ‘ã‚±ãƒƒãƒˆã¯å®Ÿé‡é‡ã®ã¿ä½¿ç”¨ã€2000gè¶…éæ™‚ã¯nullã‚’è¿”ã™
                    return getEpacketRate(actualWeight);
                case 'CF':
                    return getCpassFedexRate(chargeableWeight);
                case 'CD':
                    return getCpassDHLRate(chargeableWeight);
                case 'EL':
                    return getElogiRate(chargeableWeight);
                case 'CE':
                    return getCpassEconomyRate(chargeableWeight);
                case 'EMS':
                    // EMSã¯å®Ÿé‡é‡ã®ã¿ä½¿ç”¨
                    return getEMSRate(actualWeight);
                default:
                    return getCpassDHLRate(chargeableWeight);
            }
        }

        // è¨­å®šã‚’å–å¾—
        function getSettings() {
            return {
                exchangeRate: parseFloat(document.getElementById('exchangeRate').value),
                tariffRate: parseFloat(document.getElementById('tariffRate').value) / 100,
                safetyMargin: parseFloat(document.getElementById('safetyMargin').value) / 100,
                vatRate: parseFloat(document.getElementById('vatRate').value) / 100,
                processingFeeRate: parseFloat(document.getElementById('processingFeeRate').value) / 100,
                mpf: parseFloat(document.getElementById('mpf').value),
                ceMpf: parseFloat(document.getElementById('ceMpf').value),
                mpfUsd: parseFloat(document.getElementById('mpfUsd').value),
                euShippingDiff: parseFloat(document.getElementById('euShippingDiff').value),
                adRate: parseFloat(document.getElementById('adRate').value) / 100,
                feeRate: parseFloat(document.getElementById('feeRate').value) / 100,
                payoneerRate: parseFloat(document.getElementById('payoneerRate').value) / 100,
                shippingMode: document.getElementById('shippingMode').value,
                shippingCost: parseFloat(document.getElementById('shippingCost').value),
                shippingThreshold: parseFloat(document.getElementById('shippingThreshold').value),
                lowPriceMethod: document.getElementById('lowPriceMethod').value,
                highPriceMethod: document.getElementById('highPriceMethod').value,
                actualWeight: parseFloat(document.getElementById('actualWeight').value) || 0,
                volumetricWeight: parseFloat(document.getElementById('volumetricWeight').value) || 0,
                packageLength: parseFloat(document.getElementById('packageLength').value) || 0,
                packageWidth: parseFloat(document.getElementById('packageWidth').value) || 0,
                packageHeight: parseFloat(document.getElementById('packageHeight').value) || 0,
                shippingMethod: document.getElementById('shippingMethod').value
            };
        }

        // èª¿æ•´é–¢ç¨ç‡ã‚’è¨ˆç®—
        // èª¿æ•´é–¢ç¨ç‡ = å®Ÿéš›ã®é–¢ç¨ç‡ Ã· (1 - æ‰‹æ•°æ–™ç‡ - åºƒå‘Šç‡) Ã— (1 + å®‰å…¨ä¿‚æ•°)
        function calculateAdjustedTariffRate(settings) {
            const denominator = 1 - settings.feeRate - settings.adRate;
            if (denominator <= 0) return settings.tariffRate;
            return (settings.tariffRate / denominator) * (1 + settings.safetyMargin);
        }

        // é–¢ç¨é¡ã‚’è¨ˆç®—ï¼ˆå®Ÿéš›ã®é–¢ç¨é¡ã¨èª¿æ•´å¾Œã®é–¢ç¨é¡ã‚’ä¸¡æ–¹è¿”ã™ï¼‰
        function calculateTariffAmounts(sellingPriceUSD, settings, effectiveMethod) {
            const customsFeeJPY = (effectiveMethod === 'CE') ? settings.ceMpf : 0;

            // å®Ÿéš›ã®é–¢ç¨é¡ï¼ˆå¾“æ¥ã®è¨ˆç®—ï¼‰
            const actualTariff = sellingPriceUSD * settings.tariffRate * (1 + settings.processingFeeRate)
                               + sellingPriceUSD * settings.vatRate * settings.processingFeeRate
                               + (customsFeeJPY / settings.exchangeRate)
                               + settings.mpfUsd
                               + (settings.euShippingDiff / settings.exchangeRate);

            // èª¿æ•´é–¢ç¨ç‡
            const adjustedTariffRate = calculateAdjustedTariffRate(settings);

            // èª¿æ•´å¾Œã®é–¢ç¨é¡
            const adjustedTariff = sellingPriceUSD * adjustedTariffRate * (1 + settings.processingFeeRate)
                                 + sellingPriceUSD * settings.vatRate * settings.processingFeeRate
                                 + (customsFeeJPY / settings.exchangeRate)
                                 + settings.mpfUsd
                                 + (settings.euShippingDiff / settings.exchangeRate);

            return {
                actualTariff: actualTariff,
                adjustedTariff: adjustedTariff,
                difference: adjustedTariff - actualTariff,
                adjustedTariffRate: adjustedTariffRate
            };
        }

        // è¨­å®šã‚’ä¿å­˜
        function saveSettings() {
            const settings = getSettings();
            localStorage.setItem('ecCalcSettings', JSON.stringify(settings));
            alert('è¨­å®šã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        // è¨­å®šã‚’èª­ã¿è¾¼ã¿
        function loadSettings() {
            const saved = localStorage.getItem('ecCalcSettings');
            if (saved) {
                const settings = JSON.parse(saved);
                document.getElementById('exchangeRate').value = settings.exchangeRate;
                document.getElementById('tariffRate').value = settings.tariffRate * 100;
                if (settings.safetyMargin !== undefined) {
                    document.getElementById('safetyMargin').value = settings.safetyMargin * 100;
                }
                if (settings.vatRate !== undefined) {
                    document.getElementById('vatRate').value = settings.vatRate * 100;
                }
                if (settings.processingFeeRate !== undefined) {
                    document.getElementById('processingFeeRate').value = settings.processingFeeRate * 100;
                }
                if (settings.mpf !== undefined) {
                    document.getElementById('mpf').value = settings.mpf;
                }
                if (settings.ceMpf !== undefined) {
                    document.getElementById('ceMpf').value = settings.ceMpf;
                }
                if (settings.mpfUsd !== undefined) {
                    document.getElementById('mpfUsd').value = settings.mpfUsd;
                }
                if (settings.euShippingDiff !== undefined) {
                    document.getElementById('euShippingDiff').value = settings.euShippingDiff;
                }
                document.getElementById('adRate').value = settings.adRate * 100;
                document.getElementById('feeRate').value = settings.feeRate * 100;
                document.getElementById('payoneerRate').value = settings.payoneerRate * 100;
                document.getElementById('shippingCost').value = settings.shippingCost;

                // é€æ–™é–¢é€£è¨­å®š
                if (settings.shippingMode !== undefined) {
                    document.getElementById('shippingMode').value = settings.shippingMode;
                    toggleShippingMode();
                }
                if (settings.shippingThreshold !== undefined) {
                    document.getElementById('shippingThreshold').value = settings.shippingThreshold;
                }
                if (settings.lowPriceMethod !== undefined) {
                    const lowPriceSelect = document.getElementById('lowPriceMethod');
                    lowPriceSelect.value = settings.lowPriceMethod;
                    // ç„¡åŠ¹ãªå€¤ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                    if (!lowPriceSelect.value) {
                        lowPriceSelect.value = 'EP';
                    }
                }
                if (settings.highPriceMethod !== undefined) {
                    const highPriceSelect = document.getElementById('highPriceMethod');
                    highPriceSelect.value = settings.highPriceMethod;
                    // ç„¡åŠ¹ãªå€¤ã®å ´åˆã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆå€¤ã«æˆ»ã™
                    if (!highPriceSelect.value) {
                        highPriceSelect.value = 'CF';
                    }
                }
                if (settings.actualWeight !== undefined) {
                    document.getElementById('actualWeight').value = settings.actualWeight;
                }
                if (settings.packageLength !== undefined) {
                    document.getElementById('packageLength').value = settings.packageLength;
                }
                if (settings.packageWidth !== undefined) {
                    document.getElementById('packageWidth').value = settings.packageWidth;
                }
                if (settings.packageHeight !== undefined) {
                    document.getElementById('packageHeight').value = settings.packageHeight;
                }
                if (settings.shippingMethod !== undefined) {
                    document.getElementById('shippingMethod').value = settings.shippingMethod;
                }
                // å®¹ç©é‡é‡ã‚’è¨ˆç®—
                calculateVolumetricWeight();
            }
        }

        // è¨ˆç®—1: åˆ©ç›Šé¡ã§ä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼
        function calculatePriceFromCostProfit() {
            const settings = getSettings();
            const costJPY = parseFloat(document.getElementById('cost1').value);
            const targetProfitJPY = parseFloat(document.getElementById('profit1').value);

            // é€æ–™è¨ˆç®—
            const volume = settings.packageLength * settings.packageWidth * settings.packageHeight;
            const shippingCostJPY = calculateShippingCost(
                costJPY,
                settings.actualWeight,
                settings.volumetricWeight,
                settings.shippingMethod,
                settings.shippingThreshold,
                settings.lowPriceMethod,
                settings.highPriceMethod,
                volume,
                settings.shippingMode
            );

            // é…é€æ–¹æ³•åˆ¤å®š
            const effectiveMethod1 = getEffectiveShippingMethod(
                costJPY, settings.actualWeight, settings.shippingMethod,
                settings.shippingThreshold, settings.lowPriceMethod, settings.highPriceMethod
            );

            // åå¾©è¨ˆç®—ã§è²©å£²ä¾¡æ ¼ã‚’æ±‚ã‚ã‚‹ï¼ˆç›®æ¨™åˆ©ç›ŠãŒå¾—ã‚‰ã‚Œã‚‹è²©å£²ä¾¡æ ¼ã‚’æ¢ã™ï¼‰
            // åˆæœŸå€¤ï¼šå¤§ã¾ã‹ãªè¦‹ç©ã‚‚ã‚Š
            let sellingPriceUSD = (costJPY + shippingCostJPY + targetProfitJPY) / settings.exchangeRate / 0.7;

            for (let i = 0; i < 20; i++) {
                // ç¾åœ¨ã®è²©å£²ä¾¡æ ¼ã§ã®é–¢ç¨è¨ˆç®—
                const tariffAmounts = calculateTariffAmounts(sellingPriceUSD, settings, effectiveMethod1);

                // DDPä¾¡æ ¼ = è²©å£²ä¾¡æ ¼ + èª¿æ•´å¾Œé–¢ç¨é¡
                const ddpPrice = sellingPriceUSD + tariffAmounts.adjustedTariff;

                // æ­£ã—ã„è³‡é‡‘ãƒ•ãƒ­ãƒ¼ã§åˆ©ç›Šã‚’è¨ˆç®—
                const ddpPriceJPY = ddpPrice * settings.exchangeRate;
                const ebayFeeJPY = ddpPriceJPY * settings.feeRate;
                const adFeeJPY = ddpPriceJPY * settings.adRate;
                const afterEbayFees = ddpPriceJPY - ebayFeeJPY - adFeeJPY;
                const payoneerFeeJPY = afterEbayFees * settings.payoneerRate;
                const afterPayoneer = afterEbayFees - payoneerFeeJPY;
                const actualTariffJPY = tariffAmounts.actualTariff * settings.exchangeRate;
                const calculatedProfit = afterPayoneer - actualTariffJPY - costJPY - shippingCostJPY;

                // ç›®æ¨™åˆ©ç›Šã¨ã®å·®åˆ†
                const profitDiff = targetProfitJPY - calculatedProfit;

                // åæŸåˆ¤å®š
                if (Math.abs(profitDiff) < 1) break;

                // è²©å£²ä¾¡æ ¼ã‚’èª¿æ•´ï¼ˆå·®åˆ†ã‚’ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼‰
                sellingPriceUSD += profitDiff / settings.exchangeRate / 0.7;
            }

            // æœ€çµ‚çš„ãªé–¢ç¨è¨ˆç®—
            const tariffAmounts = calculateTariffAmounts(sellingPriceUSD, settings, effectiveMethod1);

            // DDPä¾¡æ ¼ = è²©å£²ä¾¡æ ¼ + èª¿æ•´å¾Œé–¢ç¨é¡
            const ddpPrice = sellingPriceUSD + tariffAmounts.adjustedTariff;

            // å‚è€ƒåˆ©ç›Šï¼ˆå®Ÿéš›ã®è³‡é‡‘ãƒ•ãƒ­ãƒ¼ã«åŸºã¥ãè¨ˆç®—ï¼‰
            // 1. DDPä¾¡æ ¼ï¼ˆeBayã§å—ã‘å–ã‚‹é‡‘é¡ï¼‰
            const ddpPriceJPY = ddpPrice * settings.exchangeRate;
            // 2. eBayæ‰‹æ•°æ–™ã‚’å¼•ã
            const ebayFeeJPY = ddpPriceJPY * settings.feeRate;
            // 3. åºƒå‘Šè²»ã‚’å¼•ã
            const adFeeJPY = ddpPriceJPY * settings.adRate;
            // 4. ãƒšã‚¤ã‚ªãƒ‹ã‚¢ã§å—ã‘å–ã‚‹é‡‘é¡
            const afterEbayFees = ddpPriceJPY - ebayFeeJPY - adFeeJPY;
            // 5. ãƒšã‚¤ã‚ªãƒ‹ã‚¢æ‰‹æ•°æ–™ã‚’å¼•ã
            const payoneerFeeJPY = afterEbayFees * settings.payoneerRate;
            const afterPayoneer = afterEbayFees - payoneerFeeJPY;
            // 6. å®Ÿéš›ã®é–¢ç¨é¡ã‚’å¼•ãï¼ˆèª¿æ•´å¾Œã§ã¯ãªãå®Ÿéš›ã«æ”¯æ‰•ã†é–¢ç¨ï¼‰
            const actualTariffJPY = tariffAmounts.actualTariff * settings.exchangeRate;
            const afterTariff = afterPayoneer - actualTariffJPY;
            // 7. ä»•å…¥ã‚Œãƒ»é€æ–™ã‚’å¼•ã
            const refProfit = afterTariff - costJPY - shippingCostJPY;

            // çµæœè¡¨ç¤º
            document.getElementById('result1').classList.remove('hidden');
            document.getElementById('sellingPrice1').textContent = `$${sellingPriceUSD.toFixed(2)}`;
            document.getElementById('ddpPrice1').textContent = `$${ddpPrice.toFixed(2)}`;
            document.getElementById('refProfit1').textContent = `Â¥${refProfit.toFixed(0)}`;
            document.getElementById('shipping1').textContent = `Â¥${shippingCostJPY.toFixed(0)} (${getShippingMethodDisplayName(effectiveMethod1)})`;

            // é–¢ç¨é¡ã®æ¯”è¼ƒè¡¨ç¤º
            document.getElementById('actualTariff1').textContent = `$${tariffAmounts.actualTariff.toFixed(2)}`;
            document.getElementById('adjustedTariff1').textContent = `$${tariffAmounts.adjustedTariff.toFixed(2)}`;
            document.getElementById('tariffDiff1').textContent = `+$${tariffAmounts.difference.toFixed(2)}`;

            // è¨ˆç®—éç¨‹ã®è©³ç´°è¡¨ç¤º
            const tariffRatePercent = (settings.tariffRate * 100).toFixed(1);
            const feeRatePercent = (settings.feeRate * 100).toFixed(1);
            const adRatePercent = (settings.adRate * 100).toFixed(1);
            const safetyMarginPercent = (settings.safetyMargin * 100).toFixed(1);
            const adjustedTariffRatePercent = (tariffAmounts.adjustedTariffRate * 100).toFixed(2);

            document.getElementById('tariffCalcDetail1').innerHTML = `
                <strong>ã€è¨ˆç®—éç¨‹ã€‘</strong><br>
                èª¿æ•´é–¢ç¨ç‡ = ${tariffRatePercent}% Ã· (1 - ${feeRatePercent}% - ${adRatePercent}%) Ã— (1 + ${safetyMarginPercent}%)<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= <strong>${adjustedTariffRatePercent}%</strong><br><br>
                å®Ÿéš›ã®é–¢ç¨é¡ = $${sellingPriceUSD.toFixed(2)} Ã— ${tariffRatePercent}% Ã— ... = <strong>$${tariffAmounts.actualTariff.toFixed(2)}</strong><br>
                èª¿æ•´å¾Œé–¢ç¨é¡ = $${sellingPriceUSD.toFixed(2)} Ã— ${adjustedTariffRatePercent}% Ã— ... = <strong>$${tariffAmounts.adjustedTariff.toFixed(2)}</strong>
            `;

            // åˆ©ç›Šè¨ˆç®—ã®è©³ç´°è¡¨ç¤º
            const payoneerRatePercent = (settings.payoneerRate * 100).toFixed(1);
            const totalFees = ebayFeeJPY + adFeeJPY + payoneerFeeJPY;

            document.getElementById('profitCalcDetail1').innerHTML = `
                <strong>ã€åˆ©ç›Šè¨ˆç®—ã®è©³ç´°ï¼ˆå®Ÿéš›ã®è³‡é‡‘ãƒ•ãƒ­ãƒ¼ï¼‰ã€‘</strong><br><br>
                <strong>â‘  DDPä¾¡æ ¼ï¼ˆeBayã§å—ã‘å–ã‚‹é‡‘é¡ï¼‰</strong><br>
                &nbsp;&nbsp;DDPä¾¡æ ¼ Ã— ç‚ºæ›¿ = $${ddpPrice.toFixed(2)} Ã— Â¥${settings.exchangeRate.toFixed(2)} = <strong>Â¥${ddpPriceJPY.toFixed(0)}</strong><br><br>
                <strong>â‘¡ eBayæ‰‹æ•°æ–™ãƒ»åºƒå‘Šè²»ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;eBayæ‰‹æ•°æ–™ = Â¥${ddpPriceJPY.toFixed(0)} Ã— ${feeRatePercent}% = <strong>Â¥${ebayFeeJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;åºƒå‘Šè²» = Â¥${ddpPriceJPY.toFixed(0)} Ã— ${adRatePercent}% = <strong>Â¥${adFeeJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;eBayæ‰‹æ•°æ–™å¾Œ = Â¥${ddpPriceJPY.toFixed(0)} - Â¥${ebayFeeJPY.toFixed(0)} - Â¥${adFeeJPY.toFixed(0)} = <strong>Â¥${afterEbayFees.toFixed(0)}</strong><br><br>
                <strong>â‘¢ ãƒšã‚¤ã‚ªãƒ‹ã‚¢æ‰‹æ•°æ–™ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;ãƒšã‚¤ã‚ªãƒ‹ã‚¢ = Â¥${afterEbayFees.toFixed(0)} Ã— ${payoneerRatePercent}% = <strong>Â¥${payoneerFeeJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;ãƒšã‚¤ã‚ªãƒ‹ã‚¢å¾Œ = Â¥${afterEbayFees.toFixed(0)} - Â¥${payoneerFeeJPY.toFixed(0)} = <strong>Â¥${afterPayoneer.toFixed(0)}</strong><br><br>
                <strong>â‘£ å®Ÿéš›ã®é–¢ç¨é¡ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;å®Ÿéš›ã®é–¢ç¨é¡ = $${tariffAmounts.actualTariff.toFixed(2)} Ã— Â¥${settings.exchangeRate.toFixed(2)} = <strong>Â¥${actualTariffJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;é–¢ç¨æ”¯æ‰•å¾Œ = Â¥${afterPayoneer.toFixed(0)} - Â¥${actualTariffJPY.toFixed(0)} = <strong>Â¥${afterTariff.toFixed(0)}</strong><br><br>
                <strong>â‘¤ ä»•å…¥ã‚Œãƒ»é€æ–™ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;ä»•å…¥ã‚Œä¾¡æ ¼ = <strong>Â¥${costJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;é€æ–™ = <strong>Â¥${shippingCostJPY.toFixed(0)}</strong><br><br>
                <strong>â‘¥ åˆ©ç›Šé¡</strong><br>
                &nbsp;&nbsp;åˆ©ç›Š = Â¥${afterTariff.toFixed(0)} - Â¥${costJPY.toFixed(0)} - Â¥${shippingCostJPY.toFixed(0)}<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= <strong style="color: #2e7d32; font-size: 1.2em;">Â¥${refProfit.toFixed(0)}</strong>
            `;

            // ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼åˆ¤å®š
            const policy1 = getShippingPolicy(sellingPriceUSD, tariffAmounts.adjustedTariff, effectiveMethod1);
            displayShippingPolicy('policyBox1', 'policyBadge1', 'policyName1', policy1, effectiveMethod1);
        }

        // ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼è¡¨ç¤º
        function displayShippingPolicy(boxId, badgeId, nameId, policy, method) {
            const box = document.getElementById(boxId);
            const badge = document.getElementById(badgeId);
            const name = document.getElementById(nameId);
            const contentId = boxId.replace('policyBox', 'policyContent');
            const noticeId = boxId.replace('policyBox', 'policyNotice');
            const content = document.getElementById(contentId);
            const notice = document.getElementById(noticeId);

            // CE or CX ä»¥å¤–ã¯æ³¨é‡ˆã‚’è¡¨ç¤º
            if (method !== 'CE' && method !== 'CX') {
                content.style.display = 'none';
                notice.style.display = 'block';
                return;
            }

            content.style.display = 'flex';
            notice.style.display = 'none';
            name.textContent = policy.name;

            // ãƒãƒƒã‚¸ã‚¹ã‚¿ã‚¤ãƒ«
            if (policy.badge === 'eco') {
                badge.textContent = 'Cpassã‚¨ã‚³ãƒãƒŸãƒ¼';
                badge.style.background = '#e8f5e9';
                badge.style.color = '#2e7d32';
            } else if (policy.badge === 'xp') {
                badge.textContent = 'CpassFedEx';
                badge.style.background = '#fff3e0';
                badge.style.color = '#e65100';
            } else {
                badge.textContent = 'ç¯„å›²å¤–';
                badge.style.background = '#ffebee';
                badge.style.color = '#c62828';
            }
        }

        // ãƒãƒªã‚·ãƒ¼åã‚³ãƒ”ãƒ¼é–¢æ•°
        function copyPolicyName(elementId, btn) {
            const policyName = document.getElementById(elementId).textContent;
            if (!policyName || policyName.includes('ç¯„å›²å¤–') || policyName.includes('è©²å½“ãªã—')) return;

            navigator.clipboard.writeText(policyName).then(() => {
                const originalText = btn.textContent;
                btn.textContent = 'ã‚³ãƒ”ãƒ¼å®Œäº†';
                btn.style.background = '#4caf50';
                setTimeout(() => {
                    btn.textContent = originalText;
                    btn.style.background = '#2196f3';
                }, 1500);
            });
        }

        // è¨ˆç®—2: åˆ©ç›Šç‡ã§ä»•å…¥ã‚Œâ†’è²©å£²ä¾¡æ ¼
        function calculatePriceFromCostProfitRate() {
            const settings = getSettings();
            const costJPY = parseFloat(document.getElementById('cost2').value);
            const targetProfitRate = parseFloat(document.getElementById('profitRate2').value) / 100;

            // é€æ–™è¨ˆç®—
            const volume = settings.packageLength * settings.packageWidth * settings.packageHeight;
            const shippingCostJPY = calculateShippingCost(
                costJPY,
                settings.actualWeight,
                settings.volumetricWeight,
                settings.shippingMethod,
                settings.shippingThreshold,
                settings.lowPriceMethod,
                settings.highPriceMethod,
                volume,
                settings.shippingMode
            );

            // é…é€æ–¹æ³•åˆ¤å®š
            const effectiveMethod2 = getEffectiveShippingMethod(
                costJPY, settings.actualWeight, settings.shippingMethod,
                settings.shippingThreshold, settings.lowPriceMethod, settings.highPriceMethod
            );

            // V3ã¨åŒã˜è¨ˆç®—å¼: DDUè²©å£²ä¾¡æ ¼ = (ä»•å…¥ã‚Œ + é€æ–™) Ã· (1 - æ‰‹æ•°æ–™ç‡ - åˆ©ç›Šç‡ - åºƒå‘Šç‡ - Payoneerç‡) Ã· ç‚ºæ›¿
            const sellingPriceUSD = (costJPY + shippingCostJPY) / (1 - settings.feeRate - targetProfitRate - settings.adRate - settings.payoneerRate) / settings.exchangeRate;

            // æœ€çµ‚çš„ãªé–¢ç¨è¨ˆç®—
            const tariffAmounts = calculateTariffAmounts(sellingPriceUSD, settings, effectiveMethod2);

            // DDPä¾¡æ ¼ = è²©å£²ä¾¡æ ¼ + èª¿æ•´å¾Œé–¢ç¨é¡
            const ddpPrice = sellingPriceUSD + tariffAmounts.adjustedTariff;

            // V3ã¨åŒã˜å‚è€ƒåˆ©ç›Šè¨ˆç®—: DDUè²©å£²ä¾¡æ ¼(å††) Ã— åˆ©ç›Šç‡
            const sellingPriceJPY = sellingPriceUSD * settings.exchangeRate;
            const refProfit = sellingPriceJPY * targetProfitRate;

            document.getElementById('result2').classList.remove('hidden');
            document.getElementById('sellingPrice2').textContent = `$${sellingPriceUSD.toFixed(2)}`;
            document.getElementById('ddpPrice2').textContent = `$${ddpPrice.toFixed(2)}`;
            document.getElementById('refProfit2').textContent = `Â¥${refProfit.toFixed(0)}`;
            document.getElementById('shipping2').textContent = `Â¥${shippingCostJPY.toFixed(0)} (${getShippingMethodDisplayName(effectiveMethod2)})`;

            // é–¢ç¨é¡ã®æ¯”è¼ƒè¡¨ç¤º
            document.getElementById('actualTariff2').textContent = `$${tariffAmounts.actualTariff.toFixed(2)}`;
            document.getElementById('adjustedTariff2').textContent = `$${tariffAmounts.adjustedTariff.toFixed(2)}`;
            document.getElementById('tariffDiff2').textContent = `+$${tariffAmounts.difference.toFixed(2)}`;

            // è¨ˆç®—éç¨‹ã®è©³ç´°è¡¨ç¤º
            const tariffRatePercent = (settings.tariffRate * 100).toFixed(1);
            const feeRatePercent = (settings.feeRate * 100).toFixed(1);
            const adRatePercent = (settings.adRate * 100).toFixed(1);
            const safetyMarginPercent = (settings.safetyMargin * 100).toFixed(1);
            const adjustedTariffRatePercent = (tariffAmounts.adjustedTariffRate * 100).toFixed(2);

            document.getElementById('tariffCalcDetail2').innerHTML = `
                <strong>ã€è¨ˆç®—éç¨‹ã€‘</strong><br>
                èª¿æ•´é–¢ç¨ç‡ = ${tariffRatePercent}% Ã· (1 - ${feeRatePercent}% - ${adRatePercent}%) Ã— (1 + ${safetyMarginPercent}%)<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= <strong>${adjustedTariffRatePercent}%</strong><br><br>
                å®Ÿéš›ã®é–¢ç¨é¡ = $${sellingPriceUSD.toFixed(2)} Ã— ${tariffRatePercent}% Ã— ... = <strong>$${tariffAmounts.actualTariff.toFixed(2)}</strong><br>
                èª¿æ•´å¾Œé–¢ç¨é¡ = $${sellingPriceUSD.toFixed(2)} Ã— ${adjustedTariffRatePercent}% Ã— ... = <strong>$${tariffAmounts.adjustedTariff.toFixed(2)}</strong>
            `;

            // åˆ©ç›Šè¨ˆç®—ã®è©³ç´°è¡¨ç¤º
            const payoneerRatePercent = (settings.payoneerRate * 100).toFixed(1);
            const profitRatePercent = (targetProfitRate * 100).toFixed(1);
            const totalFees = ebayFeeJPY + adFeeJPY + payoneerFeeJPY;
            const profitRateActual = (refProfit / ddpPriceJPY * 100).toFixed(1);

            document.getElementById('profitCalcDetail2').innerHTML = `
                <strong>ã€åˆ©ç›Šè¨ˆç®—ã®è©³ç´°ï¼ˆå®Ÿéš›ã®è³‡é‡‘ãƒ•ãƒ­ãƒ¼ï¼‰ã€‘</strong><br><br>
                <strong>â‘  DDPä¾¡æ ¼ï¼ˆeBayã§å—ã‘å–ã‚‹é‡‘é¡ï¼‰</strong><br>
                &nbsp;&nbsp;DDPä¾¡æ ¼ Ã— ç‚ºæ›¿ = $${ddpPrice.toFixed(2)} Ã— Â¥${settings.exchangeRate.toFixed(2)} = <strong>Â¥${ddpPriceJPY.toFixed(0)}</strong><br><br>
                <strong>â‘¡ eBayæ‰‹æ•°æ–™ãƒ»åºƒå‘Šè²»ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;eBayæ‰‹æ•°æ–™ = Â¥${ddpPriceJPY.toFixed(0)} Ã— ${feeRatePercent}% = <strong>Â¥${ebayFeeJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;åºƒå‘Šè²» = Â¥${ddpPriceJPY.toFixed(0)} Ã— ${adRatePercent}% = <strong>Â¥${adFeeJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;eBayæ‰‹æ•°æ–™å¾Œ = Â¥${ddpPriceJPY.toFixed(0)} - Â¥${ebayFeeJPY.toFixed(0)} - Â¥${adFeeJPY.toFixed(0)} = <strong>Â¥${afterEbayFees.toFixed(0)}</strong><br><br>
                <strong>â‘¢ ãƒšã‚¤ã‚ªãƒ‹ã‚¢æ‰‹æ•°æ–™ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;ãƒšã‚¤ã‚ªãƒ‹ã‚¢ = Â¥${afterEbayFees.toFixed(0)} Ã— ${payoneerRatePercent}% = <strong>Â¥${payoneerFeeJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;ãƒšã‚¤ã‚ªãƒ‹ã‚¢å¾Œ = Â¥${afterEbayFees.toFixed(0)} - Â¥${payoneerFeeJPY.toFixed(0)} = <strong>Â¥${afterPayoneer.toFixed(0)}</strong><br><br>
                <strong>â‘£ å®Ÿéš›ã®é–¢ç¨é¡ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;å®Ÿéš›ã®é–¢ç¨é¡ = $${tariffAmounts.actualTariff.toFixed(2)} Ã— Â¥${settings.exchangeRate.toFixed(2)} = <strong>Â¥${actualTariffJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;é–¢ç¨æ”¯æ‰•å¾Œ = Â¥${afterPayoneer.toFixed(0)} - Â¥${actualTariffJPY.toFixed(0)} = <strong>Â¥${afterTariff.toFixed(0)}</strong><br><br>
                <strong>â‘¤ ä»•å…¥ã‚Œãƒ»é€æ–™ã‚’å¼•ã</strong><br>
                &nbsp;&nbsp;ä»•å…¥ã‚Œä¾¡æ ¼ = <strong>Â¥${costJPY.toFixed(0)}</strong><br>
                &nbsp;&nbsp;é€æ–™ = <strong>Â¥${shippingCostJPY.toFixed(0)}</strong><br><br>
                <strong>â‘¥ åˆ©ç›Šé¡ãƒ»åˆ©ç›Šç‡</strong><br>
                &nbsp;&nbsp;åˆ©ç›Š = Â¥${afterTariff.toFixed(0)} - Â¥${costJPY.toFixed(0)} - Â¥${shippingCostJPY.toFixed(0)}<br>
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;= <strong style="color: #2e7d32; font-size: 1.2em;">Â¥${refProfit.toFixed(0)}</strong><br>
                &nbsp;&nbsp;åˆ©ç›Šç‡ = åˆ©ç›Š Ã· DDPå£²ä¸Š = Â¥${refProfit.toFixed(0)} Ã· Â¥${ddpPriceJPY.toFixed(0)} = <strong>${profitRateActual}%</strong> ï¼ˆè¨­å®š: ${profitRatePercent}%ï¼‰
            `;

            // ã‚·ãƒƒãƒ”ãƒ³ã‚°ãƒãƒªã‚·ãƒ¼åˆ¤å®š
            const policy2 = getShippingPolicy(sellingPriceUSD, tariffAmounts.adjustedTariff, effectiveMethod2);
            displayShippingPolicy('policyBox2', 'policyBadge2', 'policyName2', policy2, effectiveMethod2);
        }

        // è¨ˆç®—3: åˆ©ç›Šé¡ã§è²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œ
        function calculateCostFromPriceProfit() {
            const settings = getSettings();
            const targetProfitJPY = parseFloat(document.getElementById('profit3').value);
            const volume = settings.packageLength * settings.packageWidth * settings.packageHeight;

            // === DDUä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— ===
            const sellingPriceDDU = parseFloat(document.getElementById('sellingPriceDDU3').value);

            // é…é€æ–¹æ³•åˆ¤å®šï¼ˆåˆæœŸå€¤ã§åˆ¤å®šï¼‰
            let costDDU = 5000; // åˆæœŸæ¨å®š
            const effectiveMethod3DDU = getEffectiveShippingMethod(
                costDDU, settings.actualWeight, settings.shippingMethod,
                settings.shippingThreshold, settings.lowPriceMethod, settings.highPriceMethod
            );

            // é–¢ç¨è¨ˆç®—
            const tariffAmountsDDU = calculateTariffAmounts(sellingPriceDDU, settings, effectiveMethod3DDU);
            const tariffDDU = tariffAmountsDDU.adjustedTariff;

            // DDPä¾¡æ ¼
            const ddpPriceDDU = sellingPriceDDU + tariffDDU;
            const ddpPriceDDU_JPY = ddpPriceDDU * settings.exchangeRate;

            // æ­£ã—ã„è³‡é‡‘ãƒ•ãƒ­ãƒ¼ã§ä»•å…¥ã‚Œä¾¡æ ¼ã‚’é€†ç®—
            // DDPä¾¡æ ¼ â†’ eBayæ‰‹æ•°æ–™ â†’ åºƒå‘Šè²» â†’ ãƒšã‚¤ã‚ªãƒ‹ã‚¢æ‰‹æ•°æ–™ â†’ å®Ÿéš›ã®é–¢ç¨ â†’ ä»•å…¥ã‚Œãƒ»é€æ–™ â†’ åˆ©ç›Š
            const ebayFeeDDU = ddpPriceDDU_JPY * settings.feeRate;
            const adFeeDDU = ddpPriceDDU_JPY * settings.adRate;
            const afterEbayFeesDDU = ddpPriceDDU_JPY - ebayFeeDDU - adFeeDDU;
            const payoneerFeeDDU = afterEbayFeesDDU * settings.payoneerRate;
            const afterPayoneerDDU = afterEbayFeesDDU - payoneerFeeDDU;
            const actualTariffDDU_JPY = tariffAmountsDDU.actualTariff * settings.exchangeRate;
            const afterTariffDDU = afterPayoneerDDU - actualTariffDDU_JPY;

            // åå¾©è¨ˆç®—ã§ä»•å…¥ã‚Œã¨é€æ–™ã‚’æ±‚ã‚ã‚‹
            // afterTariff = cost + shipping + profit
            costDDU = afterTariffDDU - targetProfitJPY;
            let shippingCostDDU = 0;
            let prevCostDDU = 0;

            for (let i = 0; i < 10; i++) {
                shippingCostDDU = calculateShippingCost(
                    costDDU, settings.actualWeight, settings.volumetricWeight,
                    settings.shippingMethod, settings.shippingThreshold,
                    settings.lowPriceMethod, settings.highPriceMethod, volume, settings.shippingMode
                );
                prevCostDDU = costDDU;
                costDDU = afterTariffDDU - shippingCostDDU - targetProfitJPY;
                if (Math.abs(costDDU - prevCostDDU) < 1) break;
            }

            // å‚è€ƒåˆ©ç›Šï¼ˆæ¤œç®—ï¼‰
            const refProfitDDU = afterTariffDDU - costDDU - shippingCostDDU;

            // === DDPä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— ===
            const ddpPriceInput = parseFloat(document.getElementById('sellingPriceDDP3').value);

            // DDUè²©å£²ä¾¡æ ¼ã‚’åå¾©è¨ˆç®—ã§æ±‚ã‚ã‚‹
            let sellingPriceDDU_fromDDP = ddpPriceInput * 0.85;
            let tariffAmountsDDP = null;

            for (let i = 0; i < 10; i++) {
                const effectiveMethod3DDP = getEffectiveShippingMethod(
                    5000, settings.actualWeight, settings.shippingMethod,
                    settings.shippingThreshold, settings.lowPriceMethod, settings.highPriceMethod
                );
                tariffAmountsDDP = calculateTariffAmounts(sellingPriceDDU_fromDDP, settings, effectiveMethod3DDP);
                const newSellingPrice = ddpPriceInput - tariffAmountsDDP.adjustedTariff;
                if (Math.abs(newSellingPrice - sellingPriceDDU_fromDDP) < 0.01) break;
                sellingPriceDDU_fromDDP = newSellingPrice;
            }

            const tariffDDP = tariffAmountsDDP.adjustedTariff;
            const ddpPriceDDP_JPY = ddpPriceInput * settings.exchangeRate;

            // æ­£ã—ã„è³‡é‡‘ãƒ•ãƒ­ãƒ¼ã§ä»•å…¥ã‚Œä¾¡æ ¼ã‚’é€†ç®—
            const ebayFeeDDP = ddpPriceDDP_JPY * settings.feeRate;
            const adFeeDDP = ddpPriceDDP_JPY * settings.adRate;
            const afterEbayFeesDDP = ddpPriceDDP_JPY - ebayFeeDDP - adFeeDDP;
            const payoneerFeeDDP = afterEbayFeesDDP * settings.payoneerRate;
            const afterPayoneerDDP = afterEbayFeesDDP - payoneerFeeDDP;
            const actualTariffDDP_JPY = tariffAmountsDDP.actualTariff * settings.exchangeRate;
            const afterTariffDDP = afterPayoneerDDP - actualTariffDDP_JPY;

            // åå¾©è¨ˆç®—ã§ä»•å…¥ã‚Œã¨é€æ–™ã‚’æ±‚ã‚ã‚‹
            let costDDP = afterTariffDDP - targetProfitJPY;
            let shippingCostDDP = 0;
            let prevCostDDP = 0;

            for (let i = 0; i < 10; i++) {
                shippingCostDDP = calculateShippingCost(
                    costDDP, settings.actualWeight, settings.volumetricWeight,
                    settings.shippingMethod, settings.shippingThreshold,
                    settings.lowPriceMethod, settings.highPriceMethod, volume, settings.shippingMode
                );
                prevCostDDP = costDDP;
                costDDP = afterTariffDDP - shippingCostDDP - targetProfitJPY;
                if (Math.abs(costDDP - prevCostDDP) < 1) break;
            }

            // å‚è€ƒåˆ©ç›Šï¼ˆæ¤œç®—ï¼‰
            const refProfitDDP = afterTariffDDP - costDDP - shippingCostDDP;

            // DDUçµæœè¡¨ç¤º
            document.getElementById('result3-ddu').classList.remove('hidden');
            document.getElementById('costPriceDDU3').textContent = `Â¥${costDDU.toFixed(0)}`;
            document.getElementById('tariffDDU3').textContent = `$${tariffDDU.toFixed(2)}`;
            document.getElementById('refProfitDDU3').textContent = `Â¥${refProfitDDU.toFixed(0)}`;
            document.getElementById('shippingDDU3').textContent = `Â¥${shippingCostDDU.toFixed(0)} (${getShippingMethodDisplayName(effectiveMethod3DDU)})`;

            // DDPçµæœè¡¨ç¤º
            document.getElementById('result3-ddp').classList.remove('hidden');
            document.getElementById('costPriceDDP3').textContent = `Â¥${costDDP.toFixed(0)}`;
            document.getElementById('sellingPriceDDU_from_DDP3').textContent = `$${sellingPriceDDU_fromDDP.toFixed(2)}`;
            document.getElementById('tariffDDP3').textContent = `$${tariffDDP.toFixed(2)}`;
            document.getElementById('refProfitDDP3').textContent = `Â¥${refProfitDDP.toFixed(0)}`;
            document.getElementById('shippingDDP3').textContent = `Â¥${shippingCostDDP.toFixed(0)}`;
        }

        // è¨ˆç®—4: åˆ©ç›Šç‡ã§è²©å£²ä¾¡æ ¼â†’ä»•å…¥ã‚Œ
        function calculateCostFromPriceProfitRate() {
            const settings = getSettings();
            const targetProfitRate = parseFloat(document.getElementById('profitRate4').value) / 100;
            const volume = settings.packageLength * settings.packageWidth * settings.packageHeight;

            // === DDUä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— ===
            const sellingPriceDDU = parseFloat(document.getElementById('sellingPriceDDU4').value);

            // é…é€æ–¹æ³•åˆ¤å®šï¼ˆåˆæœŸå€¤ã§åˆ¤å®šï¼‰
            let costDDU = 5000; // åˆæœŸæ¨å®š
            const effectiveMethod4DDU = getEffectiveShippingMethod(
                costDDU, settings.actualWeight, settings.shippingMethod,
                settings.shippingThreshold, settings.lowPriceMethod, settings.highPriceMethod
            );

            // é–¢ç¨è¨ˆç®—
            const tariffAmounts4DDU = calculateTariffAmounts(sellingPriceDDU, settings, effectiveMethod4DDU);
            const tariffDDU = tariffAmounts4DDU.adjustedTariff;

            // DDPä¾¡æ ¼
            const ddpPriceDDU = sellingPriceDDU + tariffDDU;
            const ddpPriceDDU_JPY = ddpPriceDDU * settings.exchangeRate;

            // æ­£ã—ã„è³‡é‡‘ãƒ•ãƒ­ãƒ¼ã§ä»•å…¥ã‚Œä¾¡æ ¼ã‚’é€†ç®—
            const ebayFeeDDU = ddpPriceDDU_JPY * settings.feeRate;
            const adFeeDDU = ddpPriceDDU_JPY * settings.adRate;
            const afterEbayFeesDDU = ddpPriceDDU_JPY - ebayFeeDDU - adFeeDDU;
            const payoneerFeeDDU = afterEbayFeesDDU * settings.payoneerRate;
            const afterPayoneerDDU = afterEbayFeesDDU - payoneerFeeDDU;
            const actualTariffDDU_JPY = tariffAmounts4DDU.actualTariff * settings.exchangeRate;
            const afterTariffDDU = afterPayoneerDDU - actualTariffDDU_JPY;

            // åˆ©ç›Šé¡ = DDPä¾¡æ ¼(å††) Ã— åˆ©ç›Šç‡
            const targetProfitDDU = ddpPriceDDU_JPY * targetProfitRate;

            // åå¾©è¨ˆç®—ã§ä»•å…¥ã‚Œã¨é€æ–™ã‚’æ±‚ã‚ã‚‹
            costDDU = afterTariffDDU - targetProfitDDU;
            let shippingCostDDU = 0;
            let prevCostDDU = 0;

            for (let i = 0; i < 10; i++) {
                shippingCostDDU = calculateShippingCost(
                    costDDU, settings.actualWeight, settings.volumetricWeight,
                    settings.shippingMethod, settings.shippingThreshold,
                    settings.lowPriceMethod, settings.highPriceMethod, volume, settings.shippingMode
                );
                prevCostDDU = costDDU;
                costDDU = afterTariffDDU - shippingCostDDU - targetProfitDDU;
                if (Math.abs(costDDU - prevCostDDU) < 1) break;
            }

            // å‚è€ƒåˆ©ç›Šï¼ˆæ¤œç®—ï¼‰
            const refProfitDDU = afterTariffDDU - costDDU - shippingCostDDU;

            // === DDPä¾¡æ ¼ã‹ã‚‰ã®è¨ˆç®— ===
            const ddpPriceInput = parseFloat(document.getElementById('sellingPriceDDP4').value);

            // DDUè²©å£²ä¾¡æ ¼ã‚’åå¾©è¨ˆç®—ã§æ±‚ã‚ã‚‹
            let sellingPriceDDU_fromDDP = ddpPriceInput * 0.85;
            let tariffAmounts4DDP = null;

            for (let i = 0; i < 10; i++) {
                const effectiveMethod4DDP = getEffectiveShippingMethod(
                    5000, settings.actualWeight, settings.shippingMethod,
                    settings.shippingThreshold, settings.lowPriceMethod, settings.highPriceMethod
                );
                tariffAmounts4DDP = calculateTariffAmounts(sellingPriceDDU_fromDDP, settings, effectiveMethod4DDP);
                const newSellingPrice = ddpPriceInput - tariffAmounts4DDP.adjustedTariff;
                if (Math.abs(newSellingPrice - sellingPriceDDU_fromDDP) < 0.01) break;
                sellingPriceDDU_fromDDP = newSellingPrice;
            }

            const tariffDDP = tariffAmounts4DDP.adjustedTariff;
            const ddpPriceDDP_JPY = ddpPriceInput * settings.exchangeRate;

            // æ­£ã—ã„è³‡é‡‘ãƒ•ãƒ­ãƒ¼ã§ä»•å…¥ã‚Œä¾¡æ ¼ã‚’é€†ç®—
            const ebayFeeDDP = ddpPriceDDP_JPY * settings.feeRate;
            const adFeeDDP = ddpPriceDDP_JPY * settings.adRate;
            const afterEbayFeesDDP = ddpPriceDDP_JPY - ebayFeeDDP - adFeeDDP;
            const payoneerFeeDDP = afterEbayFeesDDP * settings.payoneerRate;
            const afterPayoneerDDP = afterEbayFeesDDP - payoneerFeeDDP;
            const actualTariffDDP_JPY = tariffAmounts4DDP.actualTariff * settings.exchangeRate;
            const afterTariffDDP = afterPayoneerDDP - actualTariffDDP_JPY;

            // åˆ©ç›Šé¡ = DDPä¾¡æ ¼(å††) Ã— åˆ©ç›Šç‡
            const targetProfitDDP = ddpPriceDDP_JPY * targetProfitRate;

            // åå¾©è¨ˆç®—ã§ä»•å…¥ã‚Œã¨é€æ–™ã‚’æ±‚ã‚ã‚‹
            let costDDP = afterTariffDDP - targetProfitDDP;
            let shippingCostDDP = 0;
            let prevCostDDP = 0;

            for (let i = 0; i < 10; i++) {
                shippingCostDDP = calculateShippingCost(
                    costDDP, settings.actualWeight, settings.volumetricWeight,
                    settings.shippingMethod, settings.shippingThreshold,
                    settings.lowPriceMethod, settings.highPriceMethod, volume, settings.shippingMode
                );
                prevCostDDP = costDDP;
                costDDP = afterTariffDDP - shippingCostDDP - targetProfitDDP;
                if (Math.abs(costDDP - prevCostDDP) < 1) break;
            }

            // å‚è€ƒåˆ©ç›Šï¼ˆæ¤œç®—ï¼‰
            const refProfitDDP = afterTariffDDP - costDDP - shippingCostDDP;

            // DDUçµæœè¡¨ç¤º
            document.getElementById('result4-ddu').classList.remove('hidden');
            document.getElementById('costPriceDDU4').textContent = `Â¥${costDDU.toFixed(0)}`;
            document.getElementById('tariffDDU4').textContent = `$${tariffDDU.toFixed(2)}`;
            document.getElementById('refProfitDDU4').textContent = `Â¥${refProfitDDU.toFixed(0)}`;
            document.getElementById('shippingDDU4').textContent = `Â¥${shippingCostDDU.toFixed(0)} (${getShippingMethodDisplayName(effectiveMethod4DDU)})`;

            // DDPçµæœè¡¨ç¤º
            document.getElementById('result4-ddp').classList.remove('hidden');
            document.getElementById('costPriceDDP4').textContent = `Â¥${costDDP.toFixed(0)}`;
            document.getElementById('sellingPriceDDU_from_DDP4').textContent = `$${sellingPriceDDU_fromDDP.toFixed(2)}`;
            document.getElementById('tariffDDP4').textContent = `$${tariffDDP.toFixed(2)}`;
            document.getElementById('refProfitDDP4').textContent = `Â¥${refProfitDDP.toFixed(0)}`;
            document.getElementById('shippingDDP4').textContent = `Â¥${shippingCostDDP.toFixed(0)}`;
        }

        // ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’è‡ªå‹•å–å¾—
        async function fetchExchangeRate() {
            const btn = event.target;
            btn.classList.add('loading');
            btn.textContent = 'å–å¾—ä¸­...';

            try {
                // ç„¡æ–™ã®APIï¼ˆexchangerate-api.comï¼‰ã‚’ä½¿ç”¨
                const response = await fetch('https://api.exchangerate-api.com/v4/latest/USD');
                const data = await response.json();

                if (data && data.rates && data.rates.JPY) {
                    const rate = data.rates.JPY;
                    document.getElementById('exchangeRate').value = rate.toFixed(3);
                    alert(`æœ€æ–°ã®ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—ã—ã¾ã—ãŸ: $1 = Â¥${rate.toFixed(3)}`);
                } else {
                    throw new Error('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸ');
                }
            } catch (error) {
                console.error('Error fetching exchange rate:', error);
                alert('ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã®å–å¾—ã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ‰‹å‹•ã§å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
            } finally {
                btn.classList.remove('loading');
                btn.textContent = 'æœ€æ–°å–å¾—';
            }
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‹ã
        function openTutorial() {
            window.open('https://naokijodan.github.io/price-calc-guide/', '_blank');
        }

        // ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«ã‚’é–‰ã˜ã‚‹
        function closeTutorial() {
            document.getElementById('tutorialModal').classList.remove('show');
        }

        // ãƒ¢ãƒ¼ãƒ€ãƒ«ã®å¤–å´ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸã‚‰é–‰ã˜ã‚‹
        window.onclick = function(event) {
            const modal = document.getElementById('tutorialModal');
            if (event.target === modal) {
                closeTutorial();
            }
        };

        // åˆæœŸåŒ–
        window.onload = function() {
            loadSettings();
            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã«è‡ªå‹•ã§ç‚ºæ›¿ãƒ¬ãƒ¼ãƒˆã‚’å–å¾—
            fetchExchangeRate();
            // é€æ–™è©¦ç®—ã‚’åˆæœŸè¡¨ç¤º
            calculateEstimatedShipping();
        };
    </script>
</body>
</html>
